<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” containerd-shim-kata-v2 - ğŸ¾Corgi</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="ğŸ¾Corgi"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="ğŸ¾Corgi"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Containerd Shimv2 API çš„å®ç°ä¸ ShimManagementã€EventForwarder ç­‰ç®¡ç†ç›¸å…³æµç¨‹æ¢³ç†"><meta property="og:type" content="blog"><meta property="og:title" content="ã€Œ Kata Containers ã€æºç èµ°è¯» â€” containerd-shim-kata-v2"><meta property="og:url" content="http://shenxianghong.github.io/2023/01/21/2023-01-21%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20containerd-shim-kata-v2/"><meta property="og:site_name" content="ğŸ¾Corgi"><meta property="og:description" content="Containerd Shimv2 API çš„å®ç°ä¸ ShimManagementã€EventForwarder ç­‰ç®¡ç†ç›¸å…³æµç¨‹æ¢³ç†"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://picsum.photos/0?sig=20230121"><meta property="article:published_time" content="2023-01-20T16:00:00.000Z"><meta property="article:modified_time" content="2023-05-31T09:08:58.553Z"><meta property="article:author" content="Shen Xianghong"><meta property="article:tag" content="Kata Containers"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://picsum.photos/0?sig=20230121"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://shenxianghong.github.io/2023/01/21/2023-01-21%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20containerd-shim-kata-v2/"},"headline":"ã€Œ Kata Containers ã€æºç èµ°è¯» â€” containerd-shim-kata-v2","image":[],"datePublished":"2023-01-20T16:00:00.000Z","dateModified":"2023-05-31T09:08:58.553Z","author":{"@type":"Person","name":"Shen Xianghong"},"publisher":{"@type":"Organization","name":"ğŸ¾Corgi","logo":{"@type":"ImageObject","url":"http://shenxianghong.github.io/img/logo.svg"}},"description":"Containerd Shimv2 API çš„å®ç°ä¸ ShimManagementã€EventForwarder ç­‰ç®¡ç†ç›¸å…³æµç¨‹æ¢³ç†"}</script><link rel="canonical" href="http://shenxianghong.github.io/2023/01/21/2023-01-21%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20containerd-shim-kata-v2/"><link rel="alternate" href="/atom.xml" title="ğŸ¾Corgi" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="ğŸ¾Corgi" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://picsum.photos/0?sig=20230121" alt="ã€Œ Kata Containers ã€æºç èµ°è¯» â€” containerd-shim-kata-v2"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="fa fa-calendar"></i>Â <time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2023-01-21</time></span><span class="level-item"><i class="fa fa-calendar-check"></i>Â <time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2023-05-31</time></span><span class="level-item"><i class="far fa-folder-open"></i>Â <a class="link-muted" href="/categories/Container-Runtime/">Container Runtime</a></span><span class="level-item"><i class="far fa-clock"></i>Â an hour read (About 7806 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">ã€Œ Kata Containers ã€æºç èµ°è¯» â€” containerd-shim-kata-v2</h1><div class="content"><div align=center><img width="200" style="border: 0px" src="https://katacontainers.io/static/logo-a1e2d09ad097b3fc8536cb77aa615c42.svg"></div>

<hr>
<blockquote>
<p>based on <strong>3.0.0</strong></p>
</blockquote>
<p>æœ¬è´¨ä¸Šï¼ŒKata agent è´Ÿè´£ VMï¼ˆä¹Ÿç§° sandboxã€guest ç­‰ï¼‰ä¸­çš„å®¹å™¨ç­‰è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ã€‚è€Œ containerd-shim-kata-v2 ä½œä¸º Kata agent å”¯ä¸€çš„æœåŠ¡å…¥å£ï¼ˆæœ¬èº«æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œè¿è¡Œåå³ä¸º shim serverï¼‰ï¼Œä¸€éƒ¨åˆ†å®ç°äº† Containerd shimv2 æ¥å£ï¼Œæš´éœ² shim API ç”¨äºä¸ Containerd çš„ gRPC é€šä¿¡ï¼Œä¸€éƒ¨åˆ†æš´éœ² HTTP endpoints ç”¨äºå‘½ä»¤è¡Œå·¥å…·å’Œ Kata monitor çš„æœåŠ¡è¯·æ±‚å¤„ç†ï¼Œå†…éƒ¨è°ƒç”¨ virtcontainers çš„è¯¸å¤šå­æ¨¡å—ï¼Œæä¾›äº†ç”¨æˆ·å’Œ Containerd å¯¹ VM ä»¥åŠå®¹å™¨è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„èƒ½åŠ›ã€‚</p>
<p><em><u>src&#x2F;runtime&#x2F;vendor&#x2F;github.com&#x2F;containerd&#x2F;containerd&#x2F;runtime&#x2F;v2&#x2F;task&#x2F;shim.pb.go</u></em></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service is the shim implementation of a remote shim over GRPC</span></span><br><span class="line"><span class="keyword">type</span> service <span class="keyword">struct</span> &#123;</span><br><span class="line">	ctx      context.Context</span><br><span class="line">	rootCtx  context.Context <span class="comment">// root context for tracing</span></span><br><span class="line">	rootSpan otelTrace.Span</span><br><span class="line">	sandbox  vc.VCSandbox</span><br><span class="line">	monitor  <span class="keyword">chan</span> <span class="type">error</span></span><br><span class="line">	ec       <span class="keyword">chan</span> exit</span><br><span class="line">    mu       sync.Mutex</span><br><span class="line"></span><br><span class="line">	<span class="comment">// é…ç½®æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">	config *oci.RuntimeConfig</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å½“å‰ shim service ä¸­çš„å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">	containers <span class="keyword">map</span>[<span class="type">string</span>]*container</span><br><span class="line"></span><br><span class="line">	<span class="comment">// äº‹ä»¶æ¶ˆè´¹é˜Ÿåˆ—ï¼ˆTaskCreateã€TaskStartã€TaskDeleteã€TaskPausedã€TaskResumedã€TaskOOMã€TaskExecAdded å’Œ TaskExecStartedï¼‰</span></span><br><span class="line">	events      <span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	eventSendMu sync.Mutex</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ç”± container engine è§¦å‘çš„å…³åœå‡½æ•°</span></span><br><span class="line">	cancel    <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">	<span class="comment">// ç”± container engine ä¼ å…¥çš„ä¿¡æ¯</span></span><br><span class="line">	namespace <span class="type">string</span></span><br><span class="line">	id 	      <span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// åŸè¯­ä¹‰ä¸º VM ä¸­çš„å®¹å™¨ PIDï¼Œä½†æ˜¯åœ¨ kata æ¨¡å‹ä¸­ shimv2 æ— æ³•è·å¾—ï¼Œå› æ­¤è¿™é‡Œä¸º hypervisor çš„ PID</span></span><br><span class="line">	hpid <span class="type">uint32</span></span><br><span class="line">	<span class="comment">// shimv2 çš„ PID</span></span><br><span class="line">	pid  <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>main å‡½æ•°</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/containerd-shim-kata-v2/main.go#L24">source code</a></p>
<ol>
<li>å¦‚æœæŒ‡å®šçš„å‚æ•°ä¸º â€“versionï¼Œåˆ™å±•ç¤ºå…¶ç‰ˆæœ¬ã€commit ç­‰ä¿¡æ¯</li>
<li>é€šè¿‡ shim APIï¼Œåˆå§‹åŒ–å¹¶å¯åŠ¨ shim serverï¼Œæ³¨å†Œåç§°ä¸º containerd-shim-kata-v2ï¼Œå…¶ä¸­ NoReaper å’Œ NoSubreaper å‡ä¸º true<ol>
<li>åˆå§‹åŒ– containerd-kata-shim-v2 æ¨¡å—çš„ loggerï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ debug æ—¥å¿—çº§åˆ«ï¼Œåˆ™é»˜è®¤è®¾ç½®ä¸º warn çº§åˆ«ï¼Œä»¥æ­¤ logger ä¸ºåŸºå‡†ï¼Œè®¾ç½® virtcontainers ä¸ katautils æ¨¡å—çš„ logger</li>
<li>æ ¡éªŒå¯åŠ¨æ—¶æ˜¯å¦æŒ‡å®šäº† â€“namespce å‚æ•°ï¼ˆåœ¨ Kubernetes é›†ç¾¤ä¸­ä¸º k8s.ioï¼ŒDocker ä¸­ä¸º mobyï¼Œé»˜è®¤ä¸º defaultï¼‰</li>
<li>å¯åŠ¨ goroutineï¼ŒæŒç»­å¤„ç† service ä¸­çš„ exit channelï¼Œæ„å»º TaskExit äº‹ä»¶å‘é€è‡³ events channel ä¸­</li>
<li>åˆå§‹åŒ– eventForwarderï¼Œå¹¶å¯åŠ¨ goroutine è°ƒç”¨ eventForwarder çš„ <strong>forward</strong> æŒç»­ä¸ŠæŠ¥äº‹ä»¶</li>
<li>è¿”å› serviceï¼Œäº¤ç»™ Containerd è´Ÿè´£é’ˆå¯¹æ¯ä¸ªå®¹å™¨å¯åŠ¨ shim server</li>
</ol>
</li>
</ol>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>shim server å¯¹å¤–æš´éœ²çš„ gRPC æœåŠ¡ã€‚</p>
<h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><p><strong>è·å–è¿›ç¨‹çš„è¿è¡Œæ—¶çŠ¶æ€</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L628">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StateRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span>   </span><br><span class="line">	ExecID               <span class="type">string</span>      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StateResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span>      </span><br><span class="line">	Bundle               <span class="type">string</span>      </span><br><span class="line">	Pid                  <span class="type">uint32</span>      </span><br><span class="line">	Status               task.Status </span><br><span class="line">	Stdin                <span class="type">string</span>      </span><br><span class="line">	Stdout               <span class="type">string</span>     </span><br><span class="line">	Stderr               <span class="type">string</span>      </span><br><span class="line">	Terminal             <span class="type">bool</span>       </span><br><span class="line">	ExitStatus           <span class="type">uint32</span>      </span><br><span class="line">	ExitedAt             time.Time   </span><br><span class="line">	ExecID               <span class="type">string</span>           </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>æ ¹æ®å®¹å™¨ä¸­çš„å±æ€§æ„å»ºè¿”å›æ¶ˆæ¯ï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec ä¸­çš„å±æ€§ä¸ºå‡†</p>
</li>
</ol>
<h2 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h2><p><strong>ä½¿ç”¨åº•å±‚ OCI è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L381">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CreateTaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span>         </span><br><span class="line">	Bundle               <span class="type">string</span>         </span><br><span class="line">	Rootfs               []*types.Mount </span><br><span class="line">	Terminal             <span class="type">bool</span></span><br><span class="line">	Stdin                <span class="type">string</span></span><br><span class="line">	Stdout               <span class="type">string</span></span><br><span class="line">	Stderr               <span class="type">string</span></span><br><span class="line">	Checkpoint           <span class="type">string</span></span><br><span class="line">	ParentCheckpoint     <span class="type">string</span></span><br><span class="line">	Options              *types1.Any    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CreateTaskResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// shimv2 æ— æ³•ä» VM è·å–å®¹å™¨è¿›ç¨‹ PIDï¼Œå› æ­¤åç»­å¯¹äºéœ€è¦ PID çš„è¿”å›å€¼ï¼Œç›´æ¥è¿”å› hypervisor çš„ PID å³å¯</span></span><br><span class="line">	Pid                  <span class="type">uint32</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ ¡éªŒ r.ID æ˜¯å¦ä¸ä¸ºç©ºï¼Œä¸”æ­£åˆ™åŒ¹é…æ»¡è¶³ ^[a-zA-Z0-9][a-zA-Z0-9_.-]+$</p>
</li>
<li><p>è°ƒç”¨ <strong>create</strong>ï¼Œåˆ›å»ºå®¹å™¨ï¼Œå°†è¿”å›çš„å®¹å™¨çŠ¶æ€è®¾ä¸º createdï¼Œå¹¶ç»´æŠ¤åœ¨ service.containers ä¸­</p>
</li>
<li><p>å‘é€ TaskCreate äº‹ä»¶è‡³ service.events ä¸­</p>
</li>
</ol>
<h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p><strong>åŸºäº service å®ä¾‹å’Œè¯·æ±‚æ¶ˆæ¯åˆ›å»ºå®¹å™¨</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/create.go#L51">source code</a></p>
<ol>
<li><p>åˆå§‹åŒ–ç©ºçš„ rootfs å¯¹è±¡ï¼Œå¦‚æœè¯·æ±‚ä¸­ r.Rootfs å·²ç»æä¾›äº†ä¸€ä¸ªï¼Œåˆ™ä»¥æ­¤ä¸ºå‡†ï¼Œä¸°å¯Œ rootfs å¯¹è±¡</p>
</li>
<li><p>å°† r.Bundle ä¸‹çš„ config.json æ–‡ä»¶ï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;config.jsonï¼Œè¯¥æ–‡ä»¶å³ä¸º <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runtime-spec/blob/main/config.md">OCI spec</a>ï¼Œç”± container manager äº‹å…ˆåˆ›å»ºï¼‰ï¼Œè§£æä¸º OCI spec ç»“æ„</p>
<ol>
<li>æ ¡éªŒ r.ID ä¸ r.Bundle æ˜¯å¦ä¸ä¸ºç©ºï¼Œå¹¶ä¸” r.Bundle å­˜åœ¨ä¸”ä¸ºç›®å½•ç»“æ„ï¼Œè·å– r.Bundle ç¬¦å·é“¾æ¥ï¼ˆå¦‚æœæ˜¯ï¼‰æŒ‡å‘çš„è·¯å¾„å</li>
<li>è·å– r.Bundle ç›®å½•ä¸‹çš„ config.jsonï¼Œè¯»å–å…¶å†…å®¹ï¼Œè§£æ„æˆ compatOCISpec ç»“æ„ï¼ˆä¸ºäº†å…¼å®¹ v1.0.0-rc4 å’Œ v1.0.0-rc5ï¼Œå‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/opencontainers/runtime-spec/commit/37391fb%EF%BC%89">https://github.com/opencontainers/runtime-spec/commit/37391fbï¼‰</a></li>
<li>ä¸åŒç‰ˆæœ¬ä¸‹ spec.Process.Capabilities å­—æ®µå±æ€§ä¸åŒï¼Œé€šè¿‡ç±»å‹æ–­è¨€ï¼Œå°†å…¶ä»¥åŠ compatOCISpec è½¬æ¢æˆå¯¹åº”çš„ OCI specï¼ˆå®é™…ä¸Šï¼Œå®¹å™¨è¿è¡Œåï¼Œspec ä¿¡æ¯å¯ä»¥é€šè¿‡ crictl inspect xxx æˆ–è€… ctr c info xxx æŸ¥çœ‹åˆ°ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹ config.json æ–‡ä»¶ï¼‰ï¼Œå¹¶è¿”å›</li>
</ol>
</li>
<li><p>æ ¹æ® spec ä¸­çš„ annotation ä¿¡æ¯åˆ¤æ–­å…¶å®¹å™¨ç±»å‹ï¼Œå¹¶è½¬æ¢æˆ virtcontainers ä¸­å®šä¹‰çš„å®¹å™¨ç±»å‹</p>
<ol>
<li>åˆ¤æ–­ spec.Annotations ä¸­æ˜¯å¦åŒ…å« io.kubernetes.cri.container-typeã€io.kubernetes.cri-o.ContainerType å’Œ io.kubernetes.docker.type çš„ keyï¼ˆåˆ†åˆ«ä»£è¡¨ Containerdã€CRI-O å’Œ Dockershim ä¸‰ç§ CRIï¼‰</li>
<li>è·å¾— key å¯¹åº”çš„ valueï¼ˆvalue å³ä¸ºå®¹å™¨çš„ç±»å‹ï¼‰ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼Œåˆ†åˆ«æ˜¯ sandbox å’Œ containerï¼ŒåŒºåˆ«äº CRI çš„ä¸åŒï¼Œå…·ä½“çš„åç§°æœ‰æ‰€åŒºåˆ«ï¼ˆContainerd å’Œ CRI-O ä¸­ç§°ä¸º sandbox å’Œ containerï¼Œè€Œ Dockershim ä¸­ç§°ä¸º podsandbox å’Œ containerï¼‰</li>
<li>æ ¹æ®å®¹å™¨ç±»å‹ï¼Œæ˜ å°„å‡º virtcontainers ä¸­çš„å®¹å™¨ç±»åˆ«ï¼Œä¾‹å¦‚ pod_sandbox å’Œ pod_containerï¼Œå½“ spec.Annotations ä¸­æœªè¯†åˆ«åˆ°ä¸Šè¿°ä¸‰ç§ keyï¼Œåˆ™è§†ä¸º single_containerï¼Œå³é Pod å®¹å™¨ï¼ˆå¦‚é€šè¿‡ ctrï¼Œpodman å¯åŠ¨è¿è¡Œï¼‰</li>
<li>æ­¤å¤–ï¼ŒåŒ¹é…åˆ° keyï¼Œä½†æ˜¯ value ä¸ç¬¦åˆ sandbox å’Œ container çš„ï¼Œå‡è§†ä¸º unknown_container_type</li>
</ol>
</li>
<li><p>æ„å»º runtimeConfigï¼ˆruntimeConfig èšåˆäº†è¿è¡Œæ—¶æ‰€æœ‰çš„è®¾ç½®ä¿¡æ¯ï¼Œåç»­çš„æ“ä½œä¸­ä¸å†è§£æé…ç½®æ–‡ä»¶ï¼‰ï¼Œä¼˜å…ˆçº§ä¾æ¬¡ä» spec.Annotationsã€shimv2 è¯·æ±‚ä¼ å‚å’Œç¯å¢ƒå˜é‡ä¸­è·å–</p>
<ol>
<li>è·å– spec.Annotations ä¸­ key ä¸º io.katacontainers.config_path çš„ value ä½œä¸º configPathï¼ˆä¹Ÿå°±æ˜¯ Kata Containers çš„é™æ€é…ç½®æ–‡ä»¶ï¼‰</li>
<li>å½“ configPath ä¸ºç©ºæ—¶ï¼Œå°è¯•ä» r.Options ä¸­è·å–ï¼ˆå…¶ä¸­åœ¨ç±»å‹æ–­è¨€æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ github.com&#x2F;containerd&#x2F;containerd&#x2F;pkg&#x2F;runtimeoptions&#x2F;v1 ä¸­çš„ Options ç±»å‹ï¼Œä¸ºäº†å…¼å®¹ 1.4.3ã€1.4.4 ç‰ˆæœ¬çš„ Containerdï¼Œé€€è€Œä½¿ç”¨ github.com&#x2F;containerd&#x2F;cri-containerd&#x2F;pkg&#x2F;api&#x2F;runtimeoptions&#x2F;v1 ä¸­çš„ Options ç±»å‹ï¼‰</li>
<li>å¦‚æœæ­¤æ—¶ configPath ä»ä¸ºç©ºï¼Œåˆ™ä»ç¯å¢ƒå˜é‡ KATA_CONF_FILE ä¸­è·å–</li>
<li>å¦‚æœ configPath ä¸ºç©ºï¼Œåˆ™æŒ‰åºä¼˜å…ˆè¯»å– &#x2F;etc&#x2F;kata-containers&#x2F;configuration.toml å’Œ &#x2F;usr&#x2F;share&#x2F;defaults&#x2F;kata-containers&#x2F;configuration.toml é…ç½®æ–‡ä»¶å†…å®¹ï¼Œæ„å»º runtimeConfig</li>
</ol>
</li>
<li><p>æ ¡éªŒéƒ¨åˆ†é…ç½®é¡¹</p>
<ol>
<li>[runtime].experimental ç‰¹æ€§æ˜¯å¦æ”¯æŒ</li>
<li>[runtime].sandbox_bind_mounts æŒ‚è½½ç‚¹æ˜¯å¦åµŒå¥—ï¼ˆå³æŒ‚è½½ç‚¹çš„ base ç›®å½•å­˜åœ¨é‡å¤ï¼‰</li>
<li>å½“ [runtime].disable_new_netns å¯ç”¨æ—¶ï¼Œ[runtime].internetworking_model æ˜¯å¦è®¾ç½®ä¸º none</li>
<li>[hypervisor].default_memory æ˜¯å¦ä¸ä¸º 0ã€‚å½“ guest é•œåƒé‡‡ç”¨ initrd æ ¼å¼æ—¶ï¼Œ[hypervisor].default_memory å¿…é¡»å¤§äºé•œåƒå¤§å°ï¼ˆå› ä¸º initrd ä¼šå®Œå…¨è¯»åˆ°å†…å­˜ä¸­ï¼‰ï¼›å½“ guest é•œåƒé‡‡ç”¨ image æ ¼å¼æ—¶ï¼Œé•œåƒå¤§å°å¤§äº [hypervisor].default_memory æ—¶ï¼Œä¼šè¾“å‡ºè­¦å‘Šä¿¡æ¯ï¼ˆè™½ç„¶ image ä¸ä¼šå®Œå…¨è¯»åˆ°å†…å­˜ä¸­ï¼Œä½†æ˜¯æ­¤æƒ…å†µå¹¶éæ­£å¸¸ç°è±¡ï¼‰</li>
<li>å½“ [factory].enable_template å¯ç”¨æ—¶ï¼Œguest é•œåƒç±»å‹å¿…é¡»ä¸º initrd æ ¼å¼ï¼›å½“ [factory].vm_cache_number å¤§äº 0 æ—¶ï¼Œhypervisor ç±»å‹å¿…é¡»ä¸º QEMU</li>
</ol>
</li>
<li><p>æ ¹æ®ä¸åŒçš„å®¹å™¨ç±»å‹ï¼ŒåŸºäºé…ç½®æ–‡ä»¶å†…å®¹åˆ›å»ºå®¹å™¨</p>
<p><em><strong>pod_sandbox æˆ– single_container</strong>ï¼ˆä»¥ä¸‹ç»Ÿç§°ä¸º pod_sandboxï¼‰</em></p>
<ol>
<li><p>å½“ service.sandbox ä¸ä¸ºç©ºæ—¶ï¼Œæ„å‘³ç€å½“å‰å®¹å™¨ç¯å¢ƒå·²ç»å­˜åœ¨ä¸€ä¸ª sandboxï¼ˆåªæœ‰åœ¨å®Œæˆåˆ›å»ºå®¹å™¨åæ‰ä¼šå›å†™è¯¥å­—æ®µï¼‰ï¼Œæ˜¯æ— æ³•åµŒå¥—åˆ›å»º sandbox çš„</p>
</li>
<li><p>åŸºäº [runtime].jaeger_endpointã€[runtime].jaeger_user å’Œ [runtime].jaeger_password åˆ›å»º jaeger tracer</p>
</li>
<li><p>å¦‚æœå®¹å™¨ç±»å‹ä¸º pod_sandboxï¼Œåˆ™åŸºäº spec.Annotations ä¸­çš„ io.kubernetes.cri.sandbox-memoryã€io.kubernetes.cri.sandbox-cpu-period å’Œ io.kubernetes.cri.sandbox-cpu-quotaï¼Œè®¡ç®— VM çš„èµ„æºå¤§å°ï¼›å¦‚æœå®¹å™¨ç±»å‹ä¸º single_containerï¼Œåˆ™åŸºäº spec.Linux.Resources ä¸­çš„ Memory.Limitã€CPU.Quota å’Œ CPU.Periodï¼Œè®¡ç®— VM çš„èµ„æºå¤§å°ã€‚ä¸¤è€…å…¬å¼ä¸€è‡´ï¼š</p>
<blockquote>
<p>CPU &#x3D; (cpu-quota * 1000 &#x2F; cpu-period + 999) &#x2F; 1000</p>
<p>MEM &#x3D; memory &#x2F; 1024 &#x2F;1024</p>
</blockquote>
</li>
<li><p>æ£€æŸ¥å®¹å™¨çš„ rootfs ç›®å½•æ˜¯å¦éœ€è¦æŒ‚è½½</p>
<ol>
<li>å¦‚æœè¯·æ±‚ä¸­ r.Rootfs æŒ‡å®šäº†ä¸€ä¸ªï¼Œåˆ™åˆ¤æ–­å…¶æ˜¯å¦ä¸ºå—è®¾å¤‡ï¼Œå¹¶ä¸” [hypervisor].disable_block_device_use ä¸º falseï¼ˆdisable_block_device_use ç¦æ­¢å—è®¾å¤‡ç”¨äºå®¹å™¨çš„ rootfsã€‚ åœ¨åƒ devicemapper è¿™æ ·çš„å­˜å‚¨é©±åŠ¨ç¨‹åºä¸­ï¼Œå®¹å™¨çš„ rootfs ç”±å—è®¾å¤‡æ”¯æŒï¼Œå‡ºäºæ€§èƒ½åŸå› ï¼Œå—è®¾å¤‡ç›´æ¥ä¼ é€’ç»™ hypervisorã€‚ è¿™ä¸ªæ ‡å¿—é˜»æ­¢å—è®¾å¤‡è¢«ä¼ é€’ç»™ hypervisorï¼Œè€Œä½¿ç”¨ virtio-fs ä¼ é€’ rootfsï¼‰ï¼›æˆ–è€…ï¼Œrootfs çš„ç±»å‹ä¸º fuse.nydus-overlayfsã€‚æ»¡è¶³æ¡ä»¶ä¹‹ä¸€ï¼Œå³ä¸éœ€è¦æŒ‚è½½ï¼Œè€Œæ˜¯èµ°åç»­çš„çƒ­æ’æµç¨‹</li>
<li>åˆ›å»º rootfs ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼Œéå† r.Rootfsï¼ŒæŒ‚è½½è‡³ rootfs ç›®å½•ä¸‹ï¼ˆå³ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼‰</li>
</ol>
</li>
<li><p>åŸºäº factory é…ç½®é¡¹ï¼Œå°è¯•è·å–ç°æœ‰ VM factoryï¼Œå¦‚æœè·å–å¤±è´¥ä¸”æœªå¯ç”¨ VM cache ç‰¹æ€§æ—¶ï¼Œä¼šåˆå§‹åŒ–æ–°çš„ VM factoryï¼Œå¹¶è°ƒç”¨ vircontainers çš„ <strong>SetFactory</strong>ï¼Œé€ä¼  VM factory</p>
</li>
<li><p>åŸºäº [hypervisor].rootless è®¾ç½® rootlessï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼ŒQEMU ä»¥ root èº«ä»½è¿è¡Œã€‚ å½“è®¾ç½®ä¸º true æ—¶ï¼ŒQEMU å°†ä»¥é root çš„éšæœºç”¨æˆ·è¿è¡Œï¼‰ï¼Œå¦‚æœå¯ç”¨ rootlessï¼Œåˆ™é¢å¤–æ‰§è¡Œä»¥ä¸‹æµç¨‹</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªç”¨äºè¿è¡Œ Kata Containers çš„éšæœºç”¨æˆ·</li>
<li>æ ¹æ®ç”¨æˆ·åè·å–å¹¶è®¾ç½® UID å’Œ GID</li>
<li>åˆ›å»ºç”¨æˆ·ç›®å½•ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡ XDG_RUNTIME_DIR</li>
<li>å°† KVM GID æ·»åŠ åˆ° hypervisor é…ç½®é¡¹ä¸­çš„è¡¥å……ç»„ä¸­ï¼Œä½¿ hypervisor è¿›ç¨‹å¯ä»¥è®¿é—® &#x2F;dev&#x2F;kvm è®¾å¤‡</li>
</ol>
</li>
<li><p>åŸºäºä¸Šè¿°æ„å»ºçš„ OCI specã€runtimeConfigã€rootfsã€bundleã€containerID ç­‰ä¿¡æ¯åˆ›å»º sandbox</p>
<ol>
<li>å°† OCI spec å’Œ runtimeConfig è½¬ä¸º virtcontainers æ‰€éœ€çš„é…ç½®ç»“æ„ï¼ˆå³ sandboxConfigï¼‰<br><br>é¢å¤–æ³¨æ˜ï¼ša. éƒ¨åˆ†å‚æ•°å½“ OCI spec annotations ä¸­æœ‰å£°æ˜æ—¶ï¼Œä¼šä»¥ annotations ä¸ºå‡†ï¼Œå‰ææ˜¯ [hypervisor].enable_annotations ä¸­å£°æ˜äº†å…è®¸åŠ¨æ€åŠ è½½çš„é…ç½®é¡¹ä¸”è¯¥é…ç½®é¡¹åˆæ³•ï¼›b. å½“å¯ç”¨ [hypervisor].static_sandbox_resource_mgmtï¼ŒVM è§„æ ¼ä¼šè¢«é™æ€é…ç½®ï¼Œè€Œéå¯åŠ¨åçƒ­æ’æ‹”ï¼Œå› æ­¤ CPU èµ„æºè§„æ ¼ä¸º [hypervisor].default_vcpus + &lt;workloadCPUs&gt;ï¼Œå†…å­˜åŒç†</li>
<li>å½“ host å¯ç”¨ FIPS æ—¶ï¼ˆå³ &#x2F;proc&#x2F;sys&#x2F;crypto&#x2F;fips_enabled ä¸º 1ï¼‰ï¼ŒsandboxConfig ä¸­é¢å¤–è¿½åŠ  kernel å‚æ•°</li>
<li>å¯åŠ¨å®¹å™¨å‰ä¼˜å…ˆåˆ›å»º netnsã€‚å½“ [runtime].disable_new_netns å¯ç”¨æ—¶ï¼ˆè¡¨ç¤º shim å’Œ hypervisor ä¼šè¿è¡Œåœ¨ host netns ä¸­ï¼Œè€Œéåˆ›å»ºæ–°çš„ï¼‰ï¼Œåˆ™ç›´æ¥è·³è¿‡åç»­åˆ›å»ºï¼›å¦åˆ™ï¼Œå½“ networkIDï¼ˆspec.Linux.Namespace ä¸­ type ä¸º network çš„ pathï¼‰ä¸ºç©ºæ—¶ï¼ˆè¡¨ç¤º netns å¹¶éç”± CNI æå‰åˆ›å»ºå¥½ï¼Œè€Œæ˜¯éœ€è¦ç”± Kata Containers åˆ›å»ºï¼Œæ¯”å¦‚è„±ç¦» K8s è¿è¡Œ Kata çš„åœºæ™¯ä¸­ï¼‰ï¼Œåˆ™æ ¹æ®å…·ä½“æ˜¯å¦ä¸º rootlessï¼Œæ‰§è¡Œå¯¹åº”çš„åˆ›å»ºç½‘ç»œå‘½åç©ºé—´æµç¨‹ã€‚å¦‚æœä¸ºæå‰åˆ›å»ºå¥½çš„ netnsï¼Œéœ€è¦åˆ¤æ–­å…¶æ˜¯å¦ä¸å½“å‰è¿›ç¨‹çš„ netns ä¸ä¸€è‡´ï¼ˆå½“å‰è¿›ç¨‹å¯ä»¥ä»£è¡¨ host ç½‘ç»œï¼Œè€Œ Kata Containers æ˜¯ä¸æ”¯æŒé‡‡ç”¨ host ç½‘ç»œä½œä¸ºå®¹å™¨ç½‘ç»œçš„ï¼‰</li>
<li>æ‰§è¡Œ spec.Hooks.Prestartï¼ˆPrestart æ˜¯åœ¨æ‰§è¡Œå®¹å™¨è¿›ç¨‹ä¹‹å‰è¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼Œç°å·²åºŸå¼ƒï¼‰ ä¸­å®šä¹‰çš„åŠ¨ä½œ</li>
<li>æ‰§è¡Œ spec.Hooks.CreateRuntimeï¼ˆCreateRuntime æ˜¯åœ¨åˆ›å»ºå®¹å™¨ä¹‹åä½†åœ¨è°ƒç”¨ pivot_root æˆ–ä»»ä½•ç­‰æ•ˆæ“ä½œä¹‹å‰è¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼‰ ä¸­å®šä¹‰çš„åŠ¨ä½œ</li>
<li>è°ƒç”¨ VC çš„ <strong>CreateSandbox</strong>ï¼Œæ ¹æ® sandboxConfig ä¿¡æ¯åˆ›å»º sandboxï¼Œå¹¶å¯åŠ¨ pod_sandbox å®¹å™¨</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>GetAllContainers</strong>ï¼Œæ ¡éªŒ sandbox ä¸­çš„å®¹å™¨æ€»æ•°é‡æ˜¯å¦ä¸º 1ï¼Œè¿”å› sandbox</li>
</ol>
</li>
<li><p>è®¾ç½® service.sandbox ä¸ºä¸Šé¢è¿”å›çš„ sandboxï¼Œè°ƒç”¨ VCSandbox çš„ <strong>GetHypervisorPid</strong>ï¼Œè·å– hypervisor çš„ PIDï¼Œè®¾ç½®è‡³ service.hpid ä¸­</p>
</li>
<li><p>å¯åŠ¨ç›‘å¬ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock åœ°å€çš„ shim serverï¼Œæ³¨å†ŒæœåŠ¡æœ‰ &#x2F;metricsã€&#x2F;agent-urlã€&#x2F;direct-volume&#x2F;statsã€&#x2F;direct-volume&#x2F;resizeã€&#x2F;iptablesã€&#x2F;ip6tables ä»¥åŠ Pprofï¼Œæ³¨å†Œä¸ŠæŠ¥è‡³ Prometheus çš„ shim ç›¸å…³æŒ‡æ ‡ä»¥åŠ sandbox ç›¸å…³æŒ‡æ ‡</p>
</li>
</ol>
<p><em><strong>pod_container</strong></em></p>
<ol>
<li>æ ¡éªŒ service.sandbox æ˜¯å¦ä¸ä¸ºç©ºï¼ˆå› ä¸º pod_container çš„è¿è¡Œæ˜¯è¦ä¾æ‰˜äº pod_sandboxï¼‰</li>
<li>æ£€æŸ¥å®¹å™¨çš„ rootfs ç›®å½•æ˜¯å¦éœ€è¦æŒ‚è½½<ol>
<li>å¦‚æœè¯·æ±‚ä¸­ r.Rootfs æŒ‡å®šäº†ä¸€ä¸ªï¼Œåˆ™åˆ¤æ–­å…¶æ˜¯å¦ä¸ºå—è®¾å¤‡ï¼Œå¹¶ä¸” [hypervisor].disable_block_device_use ä¸º falseï¼ˆdisable_block_device_use ç¦æ­¢å—è®¾å¤‡ç”¨äºå®¹å™¨çš„ rootfsã€‚ åœ¨åƒ devicemapper è¿™æ ·çš„å­˜å‚¨é©±åŠ¨ç¨‹åºä¸­ï¼Œå®¹å™¨çš„ rootfs ç”±å—è®¾å¤‡æ”¯æŒï¼Œå‡ºäºæ€§èƒ½åŸå› ï¼Œå—è®¾å¤‡ç›´æ¥ä¼ é€’ç»™ hypervisorã€‚ è¿™ä¸ªæ ‡å¿—é˜»æ­¢å—è®¾å¤‡è¢«ä¼ é€’ç»™ hypervisorï¼Œè€Œä½¿ç”¨ virtio-fs ä¼ é€’ rootfsï¼‰ï¼›æˆ–è€…ï¼Œrootfs çš„ç±»å‹ä¸º fuse.nydus-overlayfsã€‚æ»¡è¶³æ¡ä»¶ä¹‹ä¸€ï¼Œå³ä¸éœ€è¦æŒ‚è½½ï¼Œè€Œæ˜¯èµ°åç»­çš„çƒ­æ’æµç¨‹</li>
<li>åˆ›å»º rootfs ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼Œéå† r.Rootfsï¼ŒæŒ‚è½½ rootfs ç›®å½•</li>
</ol>
</li>
<li>åŸºäºä¸Šè¿°æ„å»ºçš„ OCI specã€runtimeConfigã€rootfsã€bundleã€containerID ç­‰ä¿¡æ¯åˆ›å»º container ç±»å‹å®¹å™¨<ol>
<li>éå† spec.Mountsï¼Œå¦‚æœæŒ‚è½½æºè·¯å¾„ç”± K8s ä¸´æ—¶å­˜å‚¨ï¼ˆå³è·¯å¾„ä¸­æœ‰ kubernetes.io~empty-dir æ ‡è¯†ï¼Œä¸”æ–‡ä»¶ç±»å‹ä¸º tmpfsï¼‰ï¼Œåˆ™å°† spec.Mounts ä¸­å¯¹åº”æŒ‚è½½ç‚¹çš„ç±»å‹è®¾ç½®ä¸º ephemeralï¼›å¦‚æœæŒ‚è½½æºè·¯å¾„ç”± K8s emptydirï¼ˆå³è·¯å¾„ä¸­æœ‰ kubernetes.io~empty-dir æ ‡è¯†ï¼Œä¸”æ–‡ä»¶ç±»å‹ä¸ä¸º tmpfsï¼‰ ä¸” runtimeConfig æ²¡æœ‰ç¦ç”¨ disable_guest_empty_dirï¼ˆå¦‚æœå¯ç”¨ï¼Œå°†ä¸ä¼šåœ¨ guest çš„æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»º emptydir æŒ‚è½½ï¼Œè€Œæ˜¯åœ¨ host ä¸Šåˆ›å»ºï¼Œç”± virtiofs å…±äº«ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œä½†æ˜¯å¯ä»¥å®ç° host å’Œ guest å…±äº«æ–‡ä»¶ï¼‰ï¼Œåˆ™å°† spec.Mounts ä¸­å¯¹åº”æŒ‚è½½ç‚¹çš„ç±»å‹è®¾ç½®ä¸º local ï¼ˆå¯¹äºç»™å®šçš„ Podï¼Œä¸´æ—¶å·ä»…åœ¨ VM å†…ç”± tmpfs æ”¯æŒæ—¶åˆ›å»ºä¸€æ¬¡ã€‚ å¯¹äºåŒä¸€ Pod çš„è¿ç»­å®¹å™¨ï¼Œå°†é‡å¤ä½¿ç”¨å·²ç»å­˜åœ¨çš„å·ï¼‰</li>
<li>å°† OCI spec å’Œ runtimeConfig è½¬ä¸º virtcontainers æ‰€éœ€çš„é…ç½®ç»“æ„ï¼ˆå³ containerConfigï¼‰</li>
<li>æ ¹æ® spec.Annotations ä¸­çš„ io.kubernetes.cri.sandbox-idã€io.kubernetes.cri-SandboxID å’Œ io.kubernetes.sandbox.id çš„ keyï¼ˆåˆ†åˆ«ä»£è¡¨ Containerdã€CRI-O å’Œ Dockershim ä¸‰ç§ CRIï¼‰ï¼Œè·å–åˆ° valueï¼ˆvalue å³ä¸º sandboxIDï¼‰</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>CreateContainer</strong>ï¼Œåˆ›å»ºå®¹å™¨</li>
<li>è¿›å…¥åˆ° sandbox çš„ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæ‰§è¡Œ spec.Hooks.Prestartï¼ˆPrestart æ˜¯åœ¨æ‰§è¡Œå®¹å™¨è¿›ç¨‹ä¹‹å‰è¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼Œç°å·²åºŸå¼ƒï¼‰ ä¸­å®šä¹‰çš„åŠ¨ä½œ</li>
</ol>
</li>
</ol>
</li>
<li><p>æ„å»ºå¹¶è¿”å›å®¹å™¨</p>
</li>
</ol>
<h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><p><strong>å¯åŠ¨å®¹å™¨</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L440">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StartRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">	ExecID               <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StartResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	Pid                  <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>å¦‚æœ r.ExecID ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <strong>startContainer</strong>ï¼Œå¯åŠ¨å®¹å™¨ï¼Œå¹¶å‘é€ TaskStart äº‹ä»¶è‡³ service.events ä¸­ï¼›å¦åˆ™ï¼Œè°ƒç”¨ <strong>startExec</strong>ï¼Œå¯åŠ¨ exec è¿›ç¨‹ï¼Œå¹¶å‘é€ TaskExecStart äº‹ä»¶è‡³ service.events ä¸­</p>
</li>
</ol>
<h3 id="startContainer"><a href="#startContainer" class="headerlink" title="startContainer"></a>startContainer</h3><p><strong>å¤„ç†å¯åŠ¨å®¹å™¨è¯·æ±‚</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/start.go#L18">source code</a></p>
<ol>
<li>å¦‚æœå®¹å™¨ç±»å‹ä¸º pod_sandbox<ol>
<li>è°ƒç”¨ VCSandbox çš„ <strong>Start</strong>ï¼Œå¯åŠ¨ sandbox</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>Monitor</strong>ï¼Œå¯åŠ¨ monitorï¼Œå¹¶è®¾ç½®åœ¨ service.monitor ä¸­</li>
<li>å¯åŠ¨ goroutineï¼Œç›‘å¬ service.monitor ä¸­çš„é”™è¯¯å’Œé€€å‡ºä¿¡å·ã€‚å¦‚æœç›‘å¬åˆ°ï¼ˆè§†ä¸ºå¼‚å¸¸ï¼‰ï¼Œåˆ™è°ƒç”¨ VCSandbox çš„ <strong>Stop</strong> å’Œ <strong>Delete</strong>ï¼Œå…³åœä¸é”€æ¯ sandbox å¹¶æ¸…ç†ç›¸å…³èµ„æº</li>
<li>ç§»é™¤ rootfs æŒ‚è½½ç‚¹ï¼ˆæ³¨æ„ï¼šæ­¤å¤„æ¸…ç†çš„ä¸º &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼Œè€Œå…±äº«ç›®å½•ä¸‹çš„ rootfs åœ¨ä¸Šè¿°æ­¥éª¤ 3 ä¸­å·²ç»æ¸…ç†ï¼‰</li>
<li>å¯åŠ¨ goroutineï¼Œè°ƒç”¨ VCSandbox çš„ <strong>GetOOMEvent</strong>ï¼ˆå¦‚æœæ˜¯ç”±äº Kata agent å…³åœï¼Œè¿”å›ç±»ä¼¼ ttrpc: closed æˆ–è€… Dead agent çš„é”™è¯¯æ—¶ï¼Œåˆ™ä¸å†ç›‘å¬ï¼›å…¶ä»–å¼‚å¸¸æƒ…å†µï¼Œä»é‡æ–°å°è¯•è°ƒç”¨æ¥å£ï¼‰ï¼Œç›‘å¬ OOM äº‹ä»¶ã€‚å½“æ”¶åˆ° OOM äº‹ä»¶åï¼Œå¦‚æœ container manager ä¸º CRI-O æ—¶ï¼Œåˆ™åœ¨ä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt; ç›®å½•ä¸‹ï¼Œåˆ›å»ºåä¸º oom çš„æ–‡ä»¶ï¼Œç”¨äºé€šçŸ¥ CRI-Oï¼›å¦‚æœ container manager ä¸º Containerd æ—¶ï¼Œåˆ™å‘é€ TaskOOM äº‹ä»¶è‡³ service.events ä¸­</li>
</ol>
</li>
<li>å¦‚æœå®¹å™¨çš„ç±»å‹ä¸ä¸º pod_sandboxï¼Œåˆ™è°ƒç”¨ VCSandbox çš„ <strong>StartContainer</strong>ï¼Œå¯åŠ¨å®¹å™¨</li>
<li>è¿›å…¥åˆ° sandbox çš„ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæ‰§è¡Œ spec.Hooks.Poststartï¼ˆPoststart æ˜¯åœ¨å®¹å™¨è¿›ç¨‹å¯åŠ¨åè¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼‰ ä¸­å®šä¹‰çš„åŠ¨ä½œ</li>
<li>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º running</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>IOStream</strong>ï¼Œå¯åŠ¨ goroutineï¼Œå®æ—¶å¤„ç†å®¹å™¨ä¸­çš„æ ‡å‡†è¾“å‡ºç­‰ IO æµ</li>
<li>å¯åŠ¨ goroutineï¼Œå¤„ç†å®¹å™¨ä¸­çš„é€€å‡ºé˜Ÿåˆ— ï¼Œå³å…ˆç­‰åˆ°å®¹å™¨ IO é€€å‡ºäº‹ä»¶åï¼Œå†è°ƒç”¨ VCSandbox çš„ <strong>WaitProcess</strong>ï¼Œè¿›ä¸€æ­¥ç­‰å¾…è¿›ç¨‹è¿”å›é€€å‡ºç åæ‰§è¡Œåç»­æ¸…ç†æµç¨‹ï¼šå¦‚æœå®¹å™¨ç±»å‹ä¸º pod_sandboxï¼Œåˆ™å…³åœ monitorï¼Œè°ƒç”¨ VCSandbox çš„ <strong>Stop</strong> å’Œ <strong>Delete</strong>ï¼Œå…³åœä¸é”€æ¯ sandboxï¼Œå¹¶æ¸…ç†ç›¸å…³èµ„æºï¼›å¦åˆ™ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>StopContainer</strong>ï¼Œå…³åœå®¹å™¨ã€‚è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º stoppedï¼Œè®°å½•é€€å‡ºæ—¶é—´ï¼ŒçŠ¶æ€ç ç­‰<br><em>ä¾‹å¦‚ï¼Œå½“ Pod å¯åŠ¨ä¹‹åï¼Œpod_sandbox å®¹å™¨ä¼šé€€å‡ºï¼Œæ­¤æ—¶å¯ä»¥æ”¶åˆ° pod_sandbox å®¹å™¨çš„ IO é€€å‡ºäº‹ä»¶ï¼Œä½†æ˜¯åœ¨ WaitProcess æ—¶ï¼Œä¸ä¼šæœ‰è¿”å›ï¼Œå› æ­¤ä¸ä¼šæ‰§è¡Œ sandbox çš„å…³åœä¸é”€æ¯æµç¨‹ï¼›è€Œå½“ Pod åˆ é™¤æ—¶ï¼Œpod_sandbox çš„ WaitProcess æ”¶åˆ°ç»“æœï¼Œä¼´éšç€å…¶ä½™çš„ä¸šåŠ¡å®¹å™¨ä¸€èµ·å…³åœå¹¶åˆ é™¤</em></li>
<li>å¯åŠ¨ goroutineï¼Œå‘é€é€€å‡ºæ¶ˆæ¯è‡³ service.ec ä¸­</li>
</ol>
<h3 id="startExec"><a href="#startExec" class="headerlink" title="startExec"></a>startExec</h3><p><strong>å¤„ç†è¿›å…¥å®¹å™¨è¯·æ±‚</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/start.go#L100">source code</a></p>
<ol>
<li>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</li>
<li>é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>EnterContainer</strong>ï¼Œè¿›å…¥å®¹å™¨å†…éƒ¨</li>
<li>è®¾ç½® exec çŠ¶æ€ä¸º running</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>WinsizeProcess</strong>ï¼Œè°ƒæ•´ tty å¤§å°</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>IOStream</strong>ï¼Œå¯åŠ¨ goroutineï¼Œå®æ—¶å¤„ç†å®¹å™¨ä¸­çš„æ ‡å‡†è¾“å‡ºç­‰ IO æµ</li>
<li>å¯åŠ¨ goroutineï¼Œå¤„ç† exec ä¸­çš„é€€å‡ºé˜Ÿåˆ— ï¼Œå³å…ˆç­‰åˆ°å®¹å™¨ IO é€€å‡ºäº‹ä»¶åï¼Œå†è°ƒç”¨ VCSandbox çš„ <strong>WaitProcess</strong>ï¼Œè¿›ä¸€æ­¥ç­‰å¾…è¿›ç¨‹è¿”å›é€€å‡ºç åæ‰§è¡Œåç»­æµç¨‹ã€‚è®¾ç½® exec çŠ¶æ€ä¸º stoppedï¼Œè®°å½•é€€å‡ºæ—¶é—´ï¼ŒçŠ¶æ€ç ç­‰</li>
<li>å¯åŠ¨ goroutineï¼Œå‘é€é€€å‡ºæ¶ˆæ¯è‡³ service.ec ä¸­</li>
</ol>
<h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><p><strong>åˆ é™¤å®¹å™¨æˆ–è€… exec è¿›ç¨‹</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L493">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DeleteRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">	ExecID               <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DeleteResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	Pid                  <span class="type">uint32</span></span><br><span class="line">	ExitStatus           <span class="type">uint32</span></span><br><span class="line">	ExitedAt             time.Time </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>å¦‚æœ r.ExecID ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <strong>deleteContainer</strong>ï¼Œåˆ é™¤å®¹å™¨ï¼Œå¹¶å‘é€ TaskDelete äº‹ä»¶è‡³ service.events ä¸­ï¼›å¦åˆ™ï¼Œç›´æ¥åˆ é™¤ container.execs ä¸­ key ä¸º r.ExecID çš„ exec</p>
</li>
</ol>
<h3 id="deleteContainer"><a href="#deleteContainer" class="headerlink" title="deleteContainer"></a>deleteContainer</h3><p><strong>åˆ é™¤æŒ‡å®šå®¹å™¨</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/delete.go#L17">source code</a></p>
<ol>
<li>å¦‚æœå®¹å™¨çš„ç±»å‹ä¸æ˜¯ pod_sandboxï¼Œåˆ™å…ˆè°ƒç”¨ VCSandbox çš„ <strong>StopContainer</strong>ï¼Œå…³åœå®¹å™¨ï¼ˆå¦‚æœå®¹å™¨çŠ¶æ€ä¸ä¸º stoppedï¼‰ï¼Œå¹¶è°ƒç”¨ VCSandbox çš„ <strong>DeleteContainer</strong>ï¼Œåˆ é™¤å®¹å™¨</li>
<li>æ‰§è¡Œ spec.Hooks.Poststopï¼ˆPoststop æ˜¯åœ¨å®¹å™¨è¿›ç¨‹é€€å‡ºåè¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼‰ä¸­å®šä¹‰çš„åŠ¨ä½œ</li>
<li>å¦‚æœå®¹å™¨æ–‡ä»¶ç³»ç»Ÿå·²ç»æŒ‚è½½å®Œæˆï¼Œåˆ™ç§»é™¤ rootfs æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼Œå…¶åœ¨ host ä¸Šä»¥ overlay æŒ‚è½½ç‚¹å½¢å¼å­˜åœ¨ï¼‰</li>
<li>åˆ é™¤ s.containers ä¸­çš„ key ä¸º r.ID çš„å®¹å™¨</li>
</ol>
<h2 id="Pids"><a href="#Pids" class="headerlink" title="Pids"></a>Pids</h2><p><strong>è¿”å›å®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹ IDï¼Œå¯¹äº Kata Containers è€Œè¨€ï¼Œæ— æ³•ä» VM è·å–è¿›ç¨‹ PIDï¼Œå› æ­¤åªè¿”å› hypervisor çš„ PID</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L829">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PidsRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PidsResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// task.ProcessInfo&#123;</span></span><br><span class="line">	<span class="comment">//   Pid: s.hpid,</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">	Processes            []*task.ProcessInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Pause"><a href="#Pause" class="headerlink" title="Pause"></a>Pause</h2><p><strong>æš‚åœå®¹å™¨</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L684">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PauseRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º pausing</p>
</li>
<li><p>è°ƒç”¨ VCSandbox çš„ <strong>PauseContainer</strong>ï¼Œæš‚åœå®¹å™¨</p>
</li>
<li><p>å¦‚æœæš‚åœæˆåŠŸï¼Œåˆ™è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º pausedï¼Œå¹¶å‘é€ TaskPaused äº‹ä»¶è‡³ service.events ä¸­ï¼›å¦åˆ™ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>StatusContainer</strong>ï¼ŒæŸ¥è¯¢å®¹å™¨çŠ¶æ€ï¼ˆåˆ†ä¸º readyã€runningã€paused å’Œ stoppedï¼‰ï¼Œå¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œåˆ™å®é™…çŠ¶æ€è§†ä¸º unknownï¼Œè®¾ç½®å®¹å™¨çŠ¶æ€ä¸ºæŸ¥è¯¢åˆ°çš„å®é™…ç»“æœ</p>
</li>
</ol>
<h2 id="Resume"><a href="#Resume" class="headerlink" title="Resume"></a>Resume</h2><p><strong>æ¢å¤å®¹å™¨</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L725">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResumeRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>è°ƒç”¨ VCSandbox çš„ <strong>ResumeContainer</strong>ï¼Œæ¢å¤å®¹å™¨</p>
</li>
<li><p>å¦‚æœæ¢å¤æˆåŠŸï¼Œåˆ™è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º runningï¼Œå¹¶å‘é€ TaskResumed äº‹ä»¶è‡³ service.events ä¸­ï¼›å¦åˆ™ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>StatusContainer</strong>ï¼ŒæŸ¥è¯¢å®¹å™¨çŠ¶æ€ï¼ˆåˆ†ä¸º readyã€runningã€paused å’Œ stoppedï¼‰ï¼Œå¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œåˆ™å®é™…çŠ¶æ€è§†ä¸º unknownï¼Œè®¾ç½®å®¹å™¨çŠ¶æ€ä¸ºæŸ¥è¯¢åˆ°çš„å®é™…ç»“æœ</p>
</li>
</ol>
<h2 id="Checkpoint"><a href="#Checkpoint" class="headerlink" title="Checkpoint"></a>Checkpoint</h2><p><strong>åˆ›å»ºå®¹å™¨æ£€æŸ¥ç‚¹</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L897">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CheckpointTaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span>      </span><br><span class="line">	Path                 <span class="type">string</span>      </span><br><span class="line">	Options              *types1.Any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æˆªè‡³ Kata 3.0ï¼Œå°šæœªå®ç°è¯¥æ¥å£</p>
</li>
</ol>
<h2 id="Kill"><a href="#Kill" class="headerlink" title="Kill"></a>Kill</h2><p><strong>æ ¹æ®æŒ‡å®šä¿¡å·æ€æ­»è¿›ç¨‹</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L764">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> KillRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span>   </span><br><span class="line">	ExecID               <span class="type">string</span>  </span><br><span class="line">	Signal               <span class="type">uint32</span>  </span><br><span class="line">	All                  <span class="type">bool</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>ä»¥å®¹å™¨çŠ¶æ€ä¸ ID ä½œä¸ºå¾…æ€æ­»è¿›ç¨‹çš„ä¿¡æ¯ï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™ä»¥é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec å±æ€§ä¸ºå‡†</p>
</li>
<li><p>å¦‚æœä¿¡å·ä¸º SIGKILL æˆ–è€… SIGTERMï¼Œå¹¶ä¸”è¿›ç¨‹çŠ¶æ€å·²ç»ä¸º stoppedï¼Œåˆ™ä¸åšå¤„ç†ï¼Œç›´æ¥è¿”å›å³å¯ï¼ˆæ ¹æ® CRI è§„èŒƒï¼ŒKubelet åœ¨è°ƒç”¨ RemovePodSandbox ä¹‹å‰è‡³å°‘ä¼šè°ƒç”¨ä¸€æ¬¡ StopPodSandbox ï¼Œæ­¤è°ƒç”¨æ˜¯å¹‚ç­‰çš„ï¼Œå¹¶ä¸”å¦‚æœæ‰€æœ‰ç›¸å…³èµ„æºéƒ½å·²è¢«å›æ”¶åˆ™ä¸å¾—è¿”å›é”™è¯¯ã€‚ åœ¨è°ƒç”¨ä¸­å®ƒä¼šå…ˆå‘é€ä¸€ä¸ª SIGKILL ä¿¡å·æ¥å°è¯•åœæ­¢å®¹å™¨ï¼Œå› æ­¤ä¸€æ—¦å®¹å™¨ç»ˆæ­¢ï¼Œåº”è¯¥å¿½ç•¥è¿™ä¸ªä¿¡å·å¹¶ç›´æ¥è¿”å›ï¼‰ï¼›å¦åˆ™ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>SignalProcess</strong>ï¼Œæ€æ­»è¿›ç¨‹</p>
</li>
</ol>
<h2 id="Exec"><a href="#Exec" class="headerlink" title="Exec"></a>Exec</h2><p><strong>åœ¨å®¹å™¨ä¸­è¿½åŠ ä¸€ä¸ªé¢å¤–çš„è¿›ç¨‹</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L547">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ExecProcessRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span>  </span><br><span class="line">	ExecID               <span class="type">string</span> </span><br><span class="line">	Terminal             <span class="type">bool</span>        </span><br><span class="line">	Stdin                <span class="type">string</span>      </span><br><span class="line">	Stdout               <span class="type">string</span>      </span><br><span class="line">	Stderr               <span class="type">string</span>   </span><br><span class="line">	Spec                 *types1.Any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>æ ¡éªŒ r.ExecID æ˜¯å¦åœ¨ container.execs ä¸å­˜åœ¨</p>
</li>
<li><p>åŸºäº r.Stdinã€r.Stdoutã€r.Stderrã€r.Terminal å’Œ r.Spec æ„å»º execï¼Œç»´æŠ¤åœ¨ container.execs ä¸­ï¼Œå¹¶å‘é€ TaskExecAdded äº‹ä»¶è‡³ service.events ä¸­</p>
</li>
</ol>
<h2 id="ResizePty"><a href="#ResizePty" class="headerlink" title="ResizePty"></a>ResizePty</h2><p><strong>è°ƒæ•´è¿›ç¨‹çš„ pty å¤§å°</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L587">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResizePtyRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span> </span><br><span class="line">	ExecID               <span class="type">string</span> </span><br><span class="line">	Width                <span class="type">uint32</span>  </span><br><span class="line">	Height               <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>ä»¥ container.ID ä½œä¸ºå¾…å¤„ç†è¿›ç¨‹çš„ IDï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec.ID ä¸ºå‡†ï¼Œå¹¶æ›´æ–° r.Width å’Œ r.Height è‡³ exec ä¸­</p>
</li>
<li><p>è°ƒç”¨ VCSandbox çš„ <strong>WinsizeProcess</strong>ï¼Œè°ƒæ•´å¾…å¤„ç†è¿›ç¨‹çš„ pty å¤§å°</p>
</li>
</ol>
<h2 id="CloseIO"><a href="#CloseIO" class="headerlink" title="CloseIO"></a>CloseIO</h2><p><strong>å…³é—­è¿›ç¨‹çš„ IO æµ</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L854">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CloseIORequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">	ExecID               <span class="type">string</span>   </span><br><span class="line">	Stdin                <span class="type">bool</span>    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>ä»¥ container.stdinPipe å’Œ container.stdinCloser ä½œä¸ºå¾…å¤„ç†è¿›ç¨‹ IO çš„ä¿¡æ¯ï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™ä»¥é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec ä¿¡æ¯ä¸ºå‡†</p>
</li>
<li><p>ç›´è‡³ stdinCloser channel ä¸å†é˜»å¡ï¼Œè°ƒç”¨ stdinPipe çš„ Close æ–¹æ³•å…³é—­ IO æµ</p>
</li>
</ol>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p><strong>æ›´æ–°å®¹å™¨</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L1012">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> UpdateTaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span>            </span><br><span class="line">	Resources            *types1.Any      </span><br><span class="line">	Annotations          <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ VCSandbox çš„ <strong>UpdateContainer</strong>ï¼Œæ›´æ–°å®¹å™¨çš„èµ„æºè§„æ ¼</p>
</li>
</ol>
<h2 id="Wait"><a href="#Wait" class="headerlink" title="Wait"></a>Wait</h2><p><strong>ç­‰å¾…è¿›ç¨‹é€€å‡º</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L1046">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WaitRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">	ExecID               <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WaitResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	ExitStatus           <span class="type">uint32</span>   </span><br><span class="line">	ExitedAt             time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>ä» container.exitCh ä¸­è·å–é€€å‡ºçŠ¶æ€ç ï¼Œå¹¶é‡æ–°å›å¡«è‡³ container.exitChï¼ˆç”¨å®¹å™¨è¿›ç¨‹çš„é€€å‡ºä»£ç é‡æ–°å¡«å…… exitChï¼Œä»¥é˜²æ­¤è¿›ç¨‹æœ‰å…¶ä»–ç­‰å¾…ï¼‰ï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™ä»¥é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec.exitCh ä¸ºå‡†</p>
</li>
</ol>
<h2 id="Stats"><a href="#Stats" class="headerlink" title="Stats"></a>Stats</h2><p><strong>è·å–å®¹å™¨çš„ç»Ÿè®¡ä¿¡æ¯</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L981">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StatsRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StatsResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	Stats                *types1.Any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p>
</li>
<li><p>è°ƒç”¨ VCSandbox çš„ <strong>StatsContainer</strong>ï¼Œè·å–å®¹å™¨çš„ Hugetlbã€Pidsã€CPUã€Memoryã€Blkio å’Œ Network ç»Ÿè®¡ä¿¡æ¯</p>
</li>
</ol>
<h2 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h2><p><strong>è¿”å› shim ç›¸å…³ä¿¡æ¯</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L913">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ConnectRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ConnectResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// å³ service.pid</span></span><br><span class="line">	ShimPid              <span class="type">uint32</span></span><br><span class="line">	<span class="comment">// å³ service.hpid</span></span><br><span class="line">	TaskPid              <span class="type">uint32</span>   </span><br><span class="line">	Version              <span class="type">string</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Shutdown"><a href="#Shutdown" class="headerlink" title="Shutdown"></a>Shutdown</h2><p><strong>å…³é—­ shim server</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L935">source code</a></p>
<ol>
<li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ShutdownRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID                   <span class="type">string</span></span><br><span class="line">	Now                  <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¦‚æœ service.containers ä¸­ä»æœ‰å…ƒç´ ï¼Œä»£è¡¨ shim server ä»ç„¶ç®¡ç†å®¹å™¨ä¸­ï¼Œå› æ­¤ä»…å…³é—­ tracingï¼Œä¸ä½œå…¶ä»–å¤„ç†ï¼Œç›´æ¥è¿”å›</p>
</li>
<li><p>è°ƒç”¨ service.cancel é€€å‡º shim serverï¼ˆcancel ç”± Containerd æœåŠ¡æ³¨å†Œå£°æ˜ï¼‰</p>
</li>
<li><p>å‘ service.hpid å‘é€ SIGKILL ä¿¡å·ï¼ˆç”±äºåªæ˜¯åœ¨æ‰§è¡Œ stopSandbox æ—¶å‘ QEMU å‘é€äº†ä¸€ä¸ª shutdown qmp å‘½ä»¤ï¼Œå¹¶æ²¡æœ‰ç­‰åˆ° QEMU è¿›ç¨‹é€€å‡ºï¼Œè¿™é‡Œæœ€å¥½ç¡®ä¿å®ƒåœ¨ shim server ç»ˆæ­¢æ—¶å·²ç»é€€å‡ºã€‚ å› æ­¤ï¼Œè¿™é‡Œè¦å¯¹ hypervisor è¿›è¡Œæœ€åçš„æ¸…ç†ï¼‰</p>
</li>
<li><p>è°ƒç”¨ os.Exit(0)ï¼Œé€€å‡ºç¨‹åº</p>
</li>
</ol>
<h2 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h2><p><strong>æ¸…ç†å®¹å™¨ç›¸å…³èµ„æº</strong></p>
<p><em>Cleanup å¹¶æœªç”¨äºå®ç° shimv2 APIï¼Œè€Œæ˜¯ Service çš„åŠŸèƒ½æ‰©å±•ï¼Œç”¨äºåœ¨æ‰§è¡Œ containerd-shim-kata-v2 delete æ“ä½œæ—¶è§¦å‘å®¹å™¨æ¸…ç†æµç¨‹</em></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L323">source code</a></p>
<ol>
<li><p>è¿”å›ä½“ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DeleteResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	Pid                  <span class="type">uint32</span></span><br><span class="line">	ExitStatus           <span class="type">uint32</span></span><br><span class="line">	ExitedAt             time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è®¾ç½®æ—¥å¿—è¾“å‡ºè‡³ stderr ä¸­ï¼ˆå› æ­¤ï¼Œæ—¥å¿—ä¿¡æ¯å¹¶ä¸ä¼šå‡ºç°åœ¨ Kata æœåŠ¡ä¸­ï¼‰</p>
</li>
<li><p>è·å–å½“å‰ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt; ç›®å½•ï¼Œæµç¨‹éœ€è¦åœ¨æ­¤è·¯å¾„ä¸‹æ‰§è¡Œ ï¼‰çš„ config.json æ–‡ä»¶ï¼Œè§£ææˆ OCI spec æ ¼å¼ï¼Œåˆ¤æ–­å…¶å®¹å™¨ç±»å‹</p>
</li>
<li><p>å¦‚æœå®¹å™¨ç±»å‹æ˜¯ pod_containerï¼Œåˆ™é€šè¿‡ spec.Annotation ä¸­è·å–åˆ° sandboxIDï¼›å¦‚æœå®¹å™¨ç±»å‹æ˜¯ pod_sandbox æˆ–è€… single_containerï¼ŒsandboxID å³ä¸º service.id</p>
</li>
<li><p>è°ƒç”¨ VC çš„ <strong>CleanupContainer</strong>ï¼Œæ¸…ç†å®¹å™¨</p>
</li>
<li><p>ç§»é™¤ rootfs æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼‰</p>
</li>
</ol>
<h1 id="ShimManagement"><a href="#ShimManagement" class="headerlink" title="ShimManagement"></a>ShimManagement</h1><p>shim server å¯¹å¤–æš´éœ²çš„ HTTP æœåŠ¡ã€‚</p>
<h2 id="agentURL"><a href="#agentURL" class="headerlink" title="agentURL"></a>agentURL</h2><p><strong>å¤„ç† &#x2F;agent-url è¯·æ±‚ï¼Œè¿”å› agent çš„åœ°å€</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L56">source code</a></p>
<ol>
<li>è°ƒç”¨ VCSandbox çš„ <strong>GetAgentURL</strong>ï¼Œè·å– agent åœ°å€å¹¶è¿”å›</li>
</ol>
<h2 id="serveMetrics"><a href="#serveMetrics" class="headerlink" title="serveMetrics"></a>serveMetrics</h2><p><strong>å¤„ç† &#x2F;metrics è¯·æ±‚ï¼Œè¿”å› guestã€shim å’Œ agent ç›¸å…³çš„æŒ‡æ ‡</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L68">source code</a></p>
<ol>
<li>è°ƒç”¨ VCSandbox çš„ <strong>UpdateRuntimeMetrics</strong>ï¼Œæ›´æ–° guest æŒ‡æ ‡ï¼ˆæ›´æ–°å°±æ˜¯é‡æ–°è·å–æŒ‡æ ‡ï¼Œé‡æ–°è®¾ç½®åœ¨ Prometheus ä¸­ï¼‰</li>
<li>æ›´æ–°å½“å‰è¿›ç¨‹ï¼ˆå³ shimPIDï¼‰çš„æŒ‡æ ‡<ol>
<li>è·å– &#x2F;proc&#x2F;&lt;shimPID&gt;&#x2F;fd ç›®å½•ä¸‹çš„æ–‡ä»¶æ•°é‡ï¼Œä¸ŠæŠ¥ kata_shim_fds æŒ‡æ ‡</li>
<li>è§£æ &#x2F;proc&#x2F;&lt;shimPID&gt;&#x2F;stat æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_shim_proc_stat æŒ‡æ ‡</li>
<li>è§£æ &#x2F;proc&#x2F;&lt;shimPID&gt;&#x2F;status æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_shim_proc_status æŒ‡æ ‡</li>
<li>è§£æ &#x2F;proc&#x2F;&lt;shimPID&gt;&#x2F;io æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_shim_io æŒ‡æ ‡</li>
</ol>
</li>
<li>å¦‚æœä½¿ç”¨æ—§ç‰ˆæœ¬çš„ agentï¼ˆç°é˜¶æ®µå‡ä¸ºæ–°ç‰ˆæœ¬ï¼‰ï¼Œåˆ™ä¸æ”¯æŒè·å– agent æŒ‡æ ‡ï¼Œç›´æ¥è¿”å› VM å’Œ shim æŒ‡æ ‡å³å¯</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>GetAgentMetrics</strong>ï¼Œè·å– agent æŒ‡æ ‡ï¼ˆåœ¨è¿™é‡Œï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è§†ä¸ºå½“å‰ä½¿ç”¨æ—§ç‰ˆæœ¬çš„ agentï¼Œåç»­åˆ™ç”±æ­¥éª¤ 3 ç›´æ¥è¿”å›ï¼‰</li>
<li>å¯åŠ¨ goroutineï¼Œä¸ŠæŠ¥ pod_overhead_cpu å’Œ pod_overhead_memory_in_bytes è‡³ Prometheusï¼ˆæ”¶é›† Pod overhead æŒ‡æ ‡éœ€è¦ sleep æ¥è·å– cpu&#x2F;memory èµ„æºä½¿ç”¨çš„å˜åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œåªè§¦å‘ collect æ“ä½œï¼Œä¸‹æ¬¡ä» Prometheus server æ”¶é›†è¯·æ±‚æ—¶æ”¶é›†æ•°æ®ï¼‰<ol>
<li>è°ƒç”¨ VCSandbox çš„ <strong>Stats</strong>ï¼Œè·å– sandbox çš„ cgroup ç›¸å…³ä¿¡æ¯ï¼›è°ƒç”¨ VCSandbox çš„ <strong>GetAllContainers</strong>ï¼Œè·å–æ‰€æœ‰å®¹å™¨ï¼Œå¹¶é€ä¸€è°ƒç”¨ VCSandbox çš„ <strong>StatsContainer</strong>ï¼Œè·å–å®¹å™¨çš„ cgroup ç›¸å…³ä¿¡æ¯</li>
<li>é—´éš” 1 ç§’é’Ÿï¼Œé‡å¤æ­¥éª¤ 1ï¼Œå†æ¬¡è·å– sandbox å’Œå®¹å™¨çš„ cgroup ç›¸å…³ä¿¡æ¯</li>
<li>æ ¹æ®ä¸¤æ¬¡æ•°æ®ä¿¡æ¯ä»¥åŠæ€»è€—æ—¶ï¼Œè®¡ç®— overhead æŒ‡æ ‡</li>
</ol>
</li>
</ol>
<h2 id="serveVolumeStats"><a href="#serveVolumeStats" class="headerlink" title="serveVolumeStats"></a>serveVolumeStats</h2><p><strong>å¤„ç† &#x2F;direct-volume&#x2F;stats è¯·æ±‚ï¼Œè¿”å› guest ä¸­æŒ‡å®šå·çš„ä¿¡æ¯</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L147">source code</a></p>
<ol>
<li>æ ¡éªŒè¯·æ±‚ä¸­ path å‚æ•°æ˜¯å¦ä¸ä¸ºç©º</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>GuestVolumeStats</strong>ï¼Œè·å– guest ä¸­æŒ‡å®šå·çš„ä¿¡æ¯å¹¶è¿”å›</li>
</ol>
<h2 id="serveVolumeResize"><a href="#serveVolumeResize" class="headerlink" title="serveVolumeResize"></a>serveVolumeResize</h2><p><strong>å¤„ç† &#x2F;direct-volume&#x2F;resize è¯·æ±‚ï¼Œæ‰©å®¹ guest ä¸­æŒ‡å®šå·çš„å¤§å°</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L175">source code</a></p>
<ol>
<li>è¯»å–è¯·æ±‚ä½“ï¼Œå¹¶è§£æ„æˆ VCSandbox æ‰€éœ€çš„æ ¼å¼</li>
<li>è°ƒç”¨ VCSandbox çš„ <strong>ResizeGuestVolume</strong>ï¼Œæ‰©å®¹ guest ä¸­æŒ‡å®šå·çš„å¤§å°</li>
</ol>
<h2 id="ipTablesHandlerã€ip6TablesHandler"><a href="#ipTablesHandlerã€ip6TablesHandler" class="headerlink" title="ipTablesHandlerã€ip6TablesHandler"></a>ipTablesHandlerã€ip6TablesHandler</h2><p><strong>å¤„ç† &#x2F;iptables å’Œ &#x2F;ip6tablesè¯·æ±‚ï¼Œæ“ä½œ guest ä¸­çš„ iptables ä¿¡æ¯</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L206">source code (ipTablesHandler)</a><br><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L202">source code (ip6TablesHandler)</a></p>
<ol>
<li>ä¸¤è€…æœ¬è´¨ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äº ip6TablesHandler çš„ isIPv6 å‚æ•°ä¸º trueï¼Œåç»­è°ƒç”¨æ¥å£æ—¶ï¼Œä¼šä¼ é€’è¯¥å‚æ•°</li>
<li>åˆ¤æ–­è¯·æ±‚æ–¹æ³•ï¼Œç›®å‰ä»…æ”¯æŒ PUT å’Œ GET ä¸¤ç§ï¼Œå…¶ä½™è¿”å›çŠ¶æ€ç  501ã€‚å¦‚æœä¸º PUT è¯·æ±‚ï¼Œåˆ™è¯»å–è¯·æ±‚ä½“ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>SetIPTables</strong>ï¼Œè®¾ç½® guest ä¸­çš„ iptables ä¿¡æ¯ï¼›å¦‚æœä¸º GET è¯·æ±‚ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>GetIPTables</strong>ï¼Œè·å– guest ä¸­çš„ iptables ä¿¡æ¯</li>
</ol>
<h1 id="EventForwarder"><a href="#EventForwarder" class="headerlink" title="EventForwarder"></a>EventForwarder</h1><p><em><u>src&#x2F;runtime&#x2F;pkg&#x2F;containerd-shim-v2&#x2F;event_forwarder.go</u></em></p>
<p>EventForwarder ä¸ºäº‹ä»¶ä¸ŠæŠ¥æ¨¡å—ï¼Œå…¶ä¸­äº‹ä»¶æºè‡ªäº forwarder ä¸­çš„ service.eventsã€‚forwarder åŒ…æ‹¬ä¸¤ç±»ï¼šlog ä¸ containerdï¼Œå–å†³äºäº‹ä»¶æœ€ç»ˆä¸ŠæŠ¥çš„åœ°ç‚¹ã€‚æ¯ä¸€ä¸ªäº‹ä»¶é»˜è®¤ä¸ŠæŠ¥è¶…æ—¶æ—¶é—´ä¸º 5 ç§’é’Ÿï¼Œè¶…å‡ºä¼šè¢«å–æ¶ˆä¸ŠæŠ¥ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> logForwarder <span class="keyword">struct</span> &#123;</span><br><span class="line">	s *service</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> containerdForwarder <span class="keyword">struct</span> &#123;</span><br><span class="line">	s         *service</span><br><span class="line">	ctx       context.Context</span><br><span class="line">	publisher events.Publisher</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œpublisher ç”± Containerd è°ƒç”¨æ—¶æä¾›ã€‚</p>
<p><strong>å·¥å‚å‡½æ•°</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L71">source code</a></p>
<ol>
<li>å¦‚æœç¯å¢ƒå˜é‡ä¸­å£°æ˜äº† TTRPC_ADDRESSï¼Œåˆ™åˆå§‹åŒ– containerdForwarderï¼Œå¦åˆ™åˆå§‹åŒ– logForwarder</li>
</ol>
<h2 id="forward"><a href="#forward" class="headerlink" title="forward"></a>forward</h2><p><strong>å¤„ç†äº‹ä»¶ä¸ŠæŠ¥</strong></p>
<h3 id="logForwarder"><a href="#logForwarder" class="headerlink" title="logForwarder"></a>logForwarder</h3><p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L40">source code</a></p>
<ol>
<li>ç›‘å¬ service.events ä¸­çš„äº‹ä»¶ï¼Œæ–­è¨€å…¶çš„ç±»å‹ï¼Œè·å¾—äº‹ä»¶çš„ topic</li>
<li>åœ¨ containerd-kata-shim-v2 æ¨¡å—çš„æ—¥å¿—ä¸­è¾“å‡ºäº‹ä»¶å†…å®¹</li>
</ol>
<h3 id="containerdForwarder"><a href="#containerdForwarder" class="headerlink" title="containerdForwarder"></a>containerdForwarder</h3><p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L56">source code</a></p>
<ol>
<li>ç›‘å¬ service.events ä¸­çš„äº‹ä»¶ï¼Œæ–­è¨€å…¶çš„ç±»å‹ï¼Œè·å¾—äº‹ä»¶çš„ topic</li>
<li>è°ƒç”¨ Containerd çš„ publisher æ¨¡å—çš„ Publishï¼ˆContainerd è´Ÿè´£å®ç°ï¼‰ï¼Œä¸ŠæŠ¥äº‹ä»¶è‡³ Containerd</li>
</ol>
<h2 id="forwarderType"><a href="#forwarderType" class="headerlink" title="forwarderType"></a>forwarderType</h2><p><strong>forwarder çš„å…·ä½“ç±»å‹</strong></p>
<h3 id="logForwarder-1"><a href="#logForwarder-1" class="headerlink" title="logForwarder"></a>logForwarder</h3><p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L46">source code</a></p>
<ol>
<li>ç±»å‹ä¸º log</li>
</ol>
<h3 id="containerdForwarder-1"><a href="#containerdForwarder-1" class="headerlink" title="containerdForwarder"></a>containerdForwarder</h3><p><a target="_blank" rel="noopener" href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L67">source code</a></p>
<ol>
<li>ç±»å‹ä¸º containerd</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” containerd-shim-kata-v2</p><p><a href="http://shenxianghong.github.io/2023/01/21/2023-01-21 Kata Containers æºç èµ°è¯» - containerd-shim-kata-v2/">http://shenxianghong.github.io/2023/01/21/2023-01-21 Kata Containers æºç èµ°è¯» - containerd-shim-kata-v2/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Shen Xianghong</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2023-01-21</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-05-31</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i>Â <a class="link-muted" rel="tag" href="/tags/Kata-Containers/">Kata Containers </a></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/01/29/2023-01-29%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20kata-monitor/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ã€Œ Kata Containers ã€æºç èµ°è¯» â€” kata-monitor</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/11/26/2022-11-26%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20kata-runtime/"><span class="level-item">ã€Œ Kata Containers ã€æºç èµ°è¯» â€” kata-runtime</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/35031258?v=4" alt="ğŸ¾Corgi"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">ğŸ¾Corgi</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">50</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/shenxianghong" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Youtube" href="https://youtube.com"><i class="fab fa-youtube"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Bilibili" href="https://bilibili.com"><i class="fab fa-bilibili"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Reddit" href="https://reddit.com"><i class="fab fa-reddit"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://google.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">google.com</span></span></a></li><li><a class="level is-mobile" href="https://poe.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Poe</span></span><span class="level-right"><span class="level-item tag">poe.com</span></span></a></li></ul></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Service"><span class="level-left"><span class="level-item">1</span><span class="level-item">Service</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#State"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">State</span></span></a></li><li><a class="level is-mobile" href="#Create"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">Create</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#create"><span class="level-left"><span class="level-item">1.2.1</span><span class="level-item">create</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Start"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">Start</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#startContainer"><span class="level-left"><span class="level-item">1.3.1</span><span class="level-item">startContainer</span></span></a></li><li><a class="level is-mobile" href="#startExec"><span class="level-left"><span class="level-item">1.3.2</span><span class="level-item">startExec</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Delete"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">Delete</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#deleteContainer"><span class="level-left"><span class="level-item">1.4.1</span><span class="level-item">deleteContainer</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Pids"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">Pids</span></span></a></li><li><a class="level is-mobile" href="#Pause"><span class="level-left"><span class="level-item">1.6</span><span class="level-item">Pause</span></span></a></li><li><a class="level is-mobile" href="#Resume"><span class="level-left"><span class="level-item">1.7</span><span class="level-item">Resume</span></span></a></li><li><a class="level is-mobile" href="#Checkpoint"><span class="level-left"><span class="level-item">1.8</span><span class="level-item">Checkpoint</span></span></a></li><li><a class="level is-mobile" href="#Kill"><span class="level-left"><span class="level-item">1.9</span><span class="level-item">Kill</span></span></a></li><li><a class="level is-mobile" href="#Exec"><span class="level-left"><span class="level-item">1.10</span><span class="level-item">Exec</span></span></a></li><li><a class="level is-mobile" href="#ResizePty"><span class="level-left"><span class="level-item">1.11</span><span class="level-item">ResizePty</span></span></a></li><li><a class="level is-mobile" href="#CloseIO"><span class="level-left"><span class="level-item">1.12</span><span class="level-item">CloseIO</span></span></a></li><li><a class="level is-mobile" href="#Update"><span class="level-left"><span class="level-item">1.13</span><span class="level-item">Update</span></span></a></li><li><a class="level is-mobile" href="#Wait"><span class="level-left"><span class="level-item">1.14</span><span class="level-item">Wait</span></span></a></li><li><a class="level is-mobile" href="#Stats"><span class="level-left"><span class="level-item">1.15</span><span class="level-item">Stats</span></span></a></li><li><a class="level is-mobile" href="#Connect"><span class="level-left"><span class="level-item">1.16</span><span class="level-item">Connect</span></span></a></li><li><a class="level is-mobile" href="#Shutdown"><span class="level-left"><span class="level-item">1.17</span><span class="level-item">Shutdown</span></span></a></li><li><a class="level is-mobile" href="#Cleanup"><span class="level-left"><span class="level-item">1.18</span><span class="level-item">Cleanup</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ShimManagement"><span class="level-left"><span class="level-item">2</span><span class="level-item">ShimManagement</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#agentURL"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">agentURL</span></span></a></li><li><a class="level is-mobile" href="#serveMetrics"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">serveMetrics</span></span></a></li><li><a class="level is-mobile" href="#serveVolumeStats"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">serveVolumeStats</span></span></a></li><li><a class="level is-mobile" href="#serveVolumeResize"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">serveVolumeResize</span></span></a></li><li><a class="level is-mobile" href="#ipTablesHandlerã€ip6TablesHandler"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">ipTablesHandlerã€ip6TablesHandler</span></span></a></li></ul></li><li><a class="level is-mobile" href="#EventForwarder"><span class="level-left"><span class="level-item">3</span><span class="level-item">EventForwarder</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#forward"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">forward</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#logForwarder"><span class="level-left"><span class="level-item">3.1.1</span><span class="level-item">logForwarder</span></span></a></li><li><a class="level is-mobile" href="#containerdForwarder"><span class="level-left"><span class="level-item">3.1.2</span><span class="level-item">containerdForwarder</span></span></a></li></ul></li><li><a class="level is-mobile" href="#forwarderType"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">forwarderType</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#logForwarder-1"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">logForwarder</span></span></a></li><li><a class="level is-mobile" href="#containerdForwarder-1"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">containerdForwarder</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Container-Runtime/"><span class="level-start"><span class="level-item">Container Runtime</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/Disaster-Recovery/"><span class="level-start"><span class="level-item">Disaster Recovery</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Scheduling-Orchestration/"><span class="level-start"><span class="level-item">Scheduling &amp; Orchestration</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/Scheduling-Orchestration/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Serverless/"><span class="level-start"><span class="level-item">Serverless</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Service-Mesh/"><span class="level-start"><span class="level-item">Service Mesh</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="ğŸ¾Corgi" height="28"></a><p class="is-size-7"><span>&copy; 2023 Shen Xianghong</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p><p class="is-size-7"><br/>And did you get what you wanted from this life, even so?</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>