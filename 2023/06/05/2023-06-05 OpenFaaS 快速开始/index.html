<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>「 OpenFaaS 」快速开始 - 🐾Corgi</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="🐾Corgi"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="🐾Corgi"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="OpenFaaS 在不同服务驱动下（OpenFaaS CE、OpenFaaS Pro 和 faasd）的简单使用示例"><meta property="og:type" content="blog"><meta property="og:title" content="「 OpenFaaS 」快速开始"><meta property="og:url" content="http://shenxianghong.github.io/2023/06/05/2023-06-05%20OpenFaaS%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"><meta property="og:site_name" content="🐾Corgi"><meta property="og:description" content="OpenFaaS 在不同服务驱动下（OpenFaaS CE、OpenFaaS Pro 和 faasd）的简单使用示例"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://picsum.photos/0?sig=20230605"><meta property="article:published_time" content="2023-06-04T16:00:00.000Z"><meta property="article:modified_time" content="2023-06-12T08:59:08.000Z"><meta property="article:author" content="Shen Xianghong"><meta property="article:tag" content="OpenFaaS"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://picsum.photos/0?sig=20230605"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://shenxianghong.github.io/2023/06/05/2023-06-05%20OpenFaaS%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"},"headline":"「 OpenFaaS 」快速开始","image":[],"datePublished":"2023-06-04T16:00:00.000Z","dateModified":"2023-06-12T08:59:08.000Z","author":{"@type":"Person","name":"Shen Xianghong"},"publisher":{"@type":"Organization","name":"🐾Corgi","logo":{"@type":"ImageObject","url":"http://shenxianghong.github.io/img/logo.svg"}},"description":"OpenFaaS 在不同服务驱动下（OpenFaaS CE、OpenFaaS Pro 和 faasd）的简单使用示例"}</script><link rel="canonical" href="http://shenxianghong.github.io/2023/06/05/2023-06-05%20OpenFaaS%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"><link rel="alternate" href="/atom.xml" title="🐾Corgi" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="🐾Corgi" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://picsum.photos/0?sig=20230605" alt="「 OpenFaaS 」快速开始"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="fa fa-calendar"></i> <time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2023-06-05</time></span><span class="level-item"><i class="fa fa-calendar-check"></i> <time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2023-06-12</time></span><span class="level-item"><i class="far fa-folder-open"></i> <a class="link-muted" href="/categories/Serverless/">Serverless</a></span><span class="level-item"><i class="far fa-clock"></i> 34 minutes read (About 5067 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">「 OpenFaaS 」快速开始</h1><div class="content"><div align=center><img width="200" style="border: 0px" src="/gallery/openfaas/openfaas-logo.png"></div>

<hr>
<blockquote>
<p>based on <strong>0.26.3</strong></p>
</blockquote>
<p>OpenFaaS 支持部署至以下环境中：</p>
<ul>
<li>Kubernetes、K3s、OpenShift 等容器编排环境</li>
<li>运行 faasd 服务的单点服务器环境</li>
</ul>
<p>相比之下，与 Kubernetes 等容器编排环境集成能够提供更好的可扩展能力。</p>
<h1 id="OpenFaaS-CE"><a href="#OpenFaaS-CE" class="headerlink" title="OpenFaaS CE"></a>OpenFaaS CE</h1><p><em>OpenFaaS  Community Edition 版本面向内部使用、开发和概念验证。</em></p>
<p>OpenFaaS CE 安装方法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://arkade.dev/">arkade</a><br><em>arkade 本质上为一站式部署工具，支持许多服务部署，其中对于 OpenFaaS 服务支持完善。内部集成了二进制的下载与 Helm chart 的安装，arkade 封装了 helm 的参数赋值与部署，也就是在 helm 中通过 –set 设置的变量，arkade 通过 –flags 的方式处理了</em></li>
<li>Helm chart、Flux 或者 ArgoCD</li>
<li>静态 YAML 配置文件</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="faas-cli"><a href="#faas-cli" class="headerlink" title="faas-cli"></a>faas-cli</h3><p><strong>使用 arkade 安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 arkade</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSL https://get.arkade.dev | sudo -E sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 faas-cli</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arkade get faas-cli</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">mv</span> /root/.arkade/bin/faas-cli /usr/local/bin/</span></span><br></pre></td></tr></table></figure>

<p><strong>使用 bash 安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSL https://cli.openfaas.com | sh</span></span><br><span class="line">New version of faas-cli installed to /usr/local/bin</span><br><span class="line">Creating alias &#x27;faas&#x27; for &#x27;faas-cli&#x27;.</span><br></pre></td></tr></table></figure>

<h3 id="OpenFaaS"><a href="#OpenFaaS" class="headerlink" title="OpenFaaS"></a>OpenFaaS</h3><p><strong>使用 arkade 安装</strong></p>
<p><em>arkade 封装了 helm 的参数赋值与部署，也就是在 helm 中通过 –set 设置的变量，arkade 通过 –flags 的方式处理了</em></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 arkade</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSL https://get.arkade.dev | sudo -E sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认安装</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arkade install openfaas</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装可选参数</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arkade install openfaas --<span class="built_in">help</span></span></span><br></pre></td></tr></table></figure>

<p><strong>使用 helm 安装</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 helm</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSLf https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">推荐创建两个 namespace：openfaas 和 openfaas-fn，前者用于部署 OpenFaaS 服务组件，后者用于部署函数</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">arkade 部署中，默认创建了这两个 namespace</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f https://raw.githubusercontent.com/openfaas/faas-netes/master/namespaces.yml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm repo add openfaas https://openfaas.github.io/faas-netes/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm repo update &amp;&amp; helm upgrade openfaas --install openfaas/openfaas --namespace openfaas</span></span><br></pre></td></tr></table></figure>

<p><strong>安装结果</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deploy -n openfaas</span></span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">alertmanager   1/1     1            1           71s</span><br><span class="line">gateway        1/1     1            1           71s</span><br><span class="line">nats           1/1     1            1           71s</span><br><span class="line">prometheus     1/1     1            1           71s</span><br><span class="line">queue-worker   1/1     1            1           71s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get svc -n openfaas</span></span><br><span class="line">NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">alertmanager       ClusterIP   10.96.76.14     &lt;none&gt;        9093/TCP         74s</span><br><span class="line">gateway            ClusterIP   10.96.4.162     &lt;none&gt;        8080/TCP         74s</span><br><span class="line">gateway-external   NodePort    10.96.10.134    &lt;none&gt;        8080:31112/TCP   74s</span><br><span class="line">nats               ClusterIP   10.96.196.157   &lt;none&gt;        4222/TCP         74s</span><br><span class="line">prometheus         ClusterIP   10.96.166.131   &lt;none&gt;        9090/TCP         74s</span><br></pre></td></tr></table></figure>

<h2 id="网关认证"><a href="#网关认证" class="headerlink" title="网关认证"></a>网关认证</h2><p>这里采用 NodePort 的形式部署 OpenFaaS CE 服务。其中，gateway-external 为对外暴露的网关服务，gateway 为对内暴露的网关服务，其后端均为 gateway Pod。无论哪种方式均采用 HTTP 认证登录方式，认证用户名和密码在 Secret 中保存：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">USER=$(kubectl get secret -n openfaas basic-auth -o jsonpath=<span class="string">&quot;&#123;.data.basic-auth-user&#125;&quot;</span> | <span class="built_in">base64</span> --decode; <span class="built_in">echo</span>)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">PASSWORD=$(kubectl get secret -n openfaas basic-auth -o jsonpath=<span class="string">&quot;&#123;.data.basic-auth-password&#125;&quot;</span> | <span class="built_in">base64</span> --decode; <span class="built_in">echo</span>)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;OpenFaaS user: <span class="variable">$USER</span>&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;OpenFaaS password: <span class="variable">$PASSWORD</span>&quot;</span></span></span><br></pre></td></tr></table></figure>

<p><strong>gateway</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl rollout status -n openfaas deploy/gateway</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl port-forward -n openfaas svc/gateway 8080:8080 &amp;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="variable">$PASSWORD</span> | faas-cli login --username admin --password-stdin</span></span><br><span class="line">Calling the OpenFaaS server to validate the credentials...</span><br><span class="line">Handling connection for 8080</span><br><span class="line">credentials saved for admin http://127.0.0.1:8080</span><br></pre></td></tr></table></figure>

<p>默认 faas-cli 操作的 OpenFaaS 实例为 <code>http://127.0.0.1:8080</code>，也可以通过 –gateway 进一步指定。</p>
<p><strong>gateway-external</strong></p>
<p>HTTP 认证登录 gateway-external 暴露的服务，即 <code>http://178.104.162.69:31112/ui/</code>。认证后，即可进入 OpenFaaS UI：</p>
<div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/home.png"></div>

<h2 id="模板商店"><a href="#模板商店" class="headerlink" title="模板商店"></a>模板商店</h2><p>社区提供的模板商店为 <a target="_blank" rel="noopener" href="https://github.com/openfaas/store/blob/master/templates.json%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%9D%A5%E6%BA%90%E8%87%AA">https://github.com/openfaas/store/blob/master/templates.json，其中来源自</a> OpenFaaS 官方社区与周边社区。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#123;</span><br><span class="line">        &quot;template&quot;: &quot;go&quot;,</span><br><span class="line">        &quot;platform&quot;: &quot;x86_64&quot;,</span><br><span class="line">        &quot;language&quot;: &quot;Go&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;openfaas&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;Legacy Golang template&quot;,</span><br><span class="line">        &quot;repo&quot;: &quot;https://github.com/openfaas/templates&quot;,</span><br><span class="line">        &quot;official&quot;: &quot;true&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;template&quot;: &quot;rust&quot;,</span><br><span class="line">        &quot;platform&quot;: &quot;x86_64&quot;,</span><br><span class="line">        &quot;language&quot;: &quot;Rust&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;openfaas-incubator&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;Community Rust template&quot;,</span><br><span class="line">        &quot;repo&quot;: &quot;https://github.com/openfaas-incubator/openfaas-rust-template&quot;,</span><br><span class="line">        &quot;official&quot;: &quot;false&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看默认支持的模板商店。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli template store list</span></span><br><span class="line">NAME                     RECOMMENDED DESCRIPTION        SOURCE</span><br><span class="line">bash-streaming           [x]         openfaas-incubator Bash Streaming template</span><br><span class="line">dockerfile               [x]         openfaas           Classic Dockerfile template</span><br><span class="line">golang-middleware        [x]         openfaas           HTTP middleware interface in Go</span><br><span class="line">java11-vert-x            [x]         openfaas           Java 11 Vert.x template</span><br><span class="line">node18                   [x]         openfaas           HTTP-based Node 18 template</span><br><span class="line">php8                     [x]         openfaas           Classic PHP 8 template</span><br><span class="line">python3-http             [x]         openfaas           Python 3 with Flask and HTTP</span><br><span class="line">python3-http-debian      [x]         openfaas           Python 3 with Flask and HTTP based on Debian</span><br><span class="line">ruby-http                [x]         openfaas           Ruby 2.4 HTTP template</span><br><span class="line">cobol                    [ ]         devries            COBOL Template</span><br><span class="line">crystal                  [ ]         tpei               Crystal template</span><br><span class="line">crystal-http             [ ]         koffeinfrei        Crystal HTTP template</span><br><span class="line">csharp-httprequest       [ ]         distantcam         C# HTTP template</span><br><span class="line">csharp-kestrel           [ ]         burtonr            C# Kestrel HTTP template</span><br><span class="line">lua53                    [ ]         affix              Lua 5.3 Template</span><br><span class="line">perl-alpine              [ ]         tmiklas            Perl language template based on Alpine image</span><br><span class="line">python3-dlrs             [ ]         intel              Deep Learning Reference Stack v0.4 for ML workloads</span><br><span class="line">quarkus-native           [ ]         pmlopes            Quarkus.io native image template</span><br><span class="line">rust                     [ ]         openfaas-incubator Community Rust template</span><br><span class="line">rust-http                [ ]         openfaas-incubator Community Rust template with HTTP bindings</span><br><span class="line">swift                    [ ]         affix              Swift 4.2 Template</span><br><span class="line">vala                     [ ]         affix              Vala Template</span><br><span class="line">vala-http                [ ]         affix              Non-Forking Vala Template</span><br><span class="line">vertx-native             [ ]         pmlopes            Eclipse Vert.x native image template</span><br><span class="line">csharp                   [ ]         openfaas           Classic C# template</span><br><span class="line">go                       [ ]         openfaas           Legacy Golang template</span><br><span class="line">golang-http              [ ]         openfaas           Request/response style HTTP template</span><br><span class="line">java11                   [ ]         openfaas           Java 11 template</span><br><span class="line">node                     [ ]         openfaas           Legacy Node 12 template</span><br><span class="line">node12                   [ ]         openfaas           HTTP-based Node 12 template</span><br><span class="line">node14                   [ ]         openfaas           HTTP-based Node 14 template</span><br><span class="line">node16                   [ ]         openfaas           HTTP-based Node 16 template</span><br><span class="line">node17                   [ ]         openfaas           HTTP-based Node 17 template</span><br><span class="line">php7                     [ ]         openfaas           Classic PHP 7 template</span><br><span class="line">powershell-http-template [ ]         openfaas-incubator Powershell Core HTTP Ubuntu:16.04 template</span><br><span class="line">powershell-template      [ ]         openfaas-incubator Powershell Core Ubuntu:16.04 template</span><br><span class="line">puppeteer-nodelts        [ ]         alexellis          A puppeteer template for headless Chrome</span><br><span class="line">python                   [ ]         openfaas           Classic Python 2.7 template</span><br><span class="line">python27-flask           [ ]         openfaas           Python 2.7 Flask template</span><br><span class="line">python3                  [ ]         openfaas           Classic Python 3 template</span><br><span class="line">python3-debian           [ ]         openfaas           Python 3 Debian template</span><br><span class="line">python3-flask            [ ]         openfaas           Python 3 Flask template</span><br><span class="line">python3-flask-debian     [ ]         openfaas           Python 3 Flask template based on Debian</span><br><span class="line">ruby                     [ ]         openfaas           Classic Ruby 2.5 template</span><br></pre></td></tr></table></figure>

<p>获取托管在模板商店中的 OpenFaaS 官方经典模板。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli template pull</span></span><br><span class="line">Fetch templates from repository: https://github.com/openfaas/templates.git at </span><br><span class="line">2023/06/05 17:15:07 Attempting to expand templates from https://github.com/openfaas/templates.git</span><br><span class="line">2023/06/05 17:15:09 Fetched 18 template(s) : [csharp dockerfile go java11 java11-vert-x node node12 node12-debian node14 node16 node17 node18 php7 php8 python python3 python3-debian ruby] from https://github.com/openfaas/templates.git</span><br></pre></td></tr></table></figure>

<p>获取托管在模板商店中的指定模板。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli template store pull rust</span></span><br><span class="line">Fetch templates from repository: https://github.com/openfaas-incubator/openfaas-rust-template at </span><br><span class="line">2023/06/05 17:41:58 Attempting to expand templates from https://github.com/openfaas-incubator/openfaas-rust-template</span><br><span class="line">2023/06/05 17:42:02 Fetched 1 template(s) : [rust] from https://github.com/openfaas-incubator/openfaas-rust-template</span><br></pre></td></tr></table></figure>

<p>也可以通过 –url 参数，获取指定来源的模板。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli template store pull --url=https://raw.githubusercontent.com/openfaas/store/master/templates.json</span></span><br></pre></td></tr></table></figure>

<p>获取到的模板文件保存在当前的 template 目录中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> template/</span></span><br><span class="line">csharp  dockerfile  go  java11  java11-vert-x  node  node12  node12-debian  node14  node16  node17  node18  php7  php8  python  python3  python3-debian  ruby</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree template/golang-middleware/</span></span><br><span class="line">template/golang-middleware/</span><br><span class="line">├── Dockerfile		# 函数最终会构建成镜像</span><br><span class="line">├── function		# 业务代码，比如实现 HTTP endpoint 处理请求</span><br><span class="line">│   ├── go.mod</span><br><span class="line">│   └── handler.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.work</span><br><span class="line">├── main.go			# 函数入口，用于启动 HTTP 服务器，注册 endpoint</span><br><span class="line">└── template.yml	# 模板说明</span><br><span class="line"></span><br><span class="line">1 directory, 7 files</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli new --list</span></span><br><span class="line">Languages available as templates:</span><br><span class="line">- csharp</span><br><span class="line">- dockerfile</span><br><span class="line">- go</span><br><span class="line">- java11</span><br><span class="line">- java11-vert-x</span><br><span class="line">- node</span><br><span class="line">- node12</span><br><span class="line">- node12-debian</span><br><span class="line">- node14</span><br><span class="line">- node16</span><br><span class="line">- node17</span><br><span class="line">- node18</span><br><span class="line">- php7</span><br><span class="line">- php8</span><br><span class="line">- python</span><br><span class="line">- python3</span><br><span class="line">- python3-debian</span><br><span class="line">- ruby</span><br></pre></td></tr></table></figure>

<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><h3 id="创建函数"><a href="#创建函数" class="headerlink" title="创建函数"></a>创建函数</h3><p><em>这里以 Golang 的 golang-middleware 函数模板为例，该函数为简单的 HTTP 请求响应。</em></p>
<table>
<thead>
<tr>
<th>可选模板</th>
<th>托管商店</th>
<th>watchdog</th>
<th>Go 版本</th>
<th>基础 OS</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>go</td>
<td><a target="_blank" rel="noopener" href="https://github.com/openfaas/templates">https://github.com/openfaas/templates</a></td>
<td>classic</td>
<td>1.18</td>
<td>Alpine Linux</td>
<td>Legacy Golang template</td>
</tr>
<tr>
<td>golang-middleware</td>
<td><a target="_blank" rel="noopener" href="https://github.com/openfaas/golang-http-template">https://github.com/openfaas/golang-http-template</a></td>
<td>of-watchdog</td>
<td>1.19</td>
<td>Alpine Linux</td>
<td>HTTP middleware interface in Go</td>
</tr>
<tr>
<td>golang-http</td>
<td><a target="_blank" rel="noopener" href="https://github.com/openfaas/golang-http-template">https://github.com/openfaas/golang-http-template</a></td>
<td>of-watchdog</td>
<td>1.19</td>
<td>Alpine Linux</td>
<td>Request&#x2F;response style HTTP template</td>
</tr>
</tbody></table>
<p>使用 golang-middleware 模板创建名为 go-fn 的函数。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli new go-fn --lang golang-middleware</span></span><br><span class="line">Folder: go-fn created.</span><br><span class="line">  ___                   _____           ____</span><br><span class="line"> / _ \ _ __   ___ _ __ |  ___|_ _  __ _/ ___|</span><br><span class="line">| | | | &#x27;_ \ / _ \ &#x27;_ \| |_ / _` |/ _` \___ \</span><br><span class="line">| |_| | |_) |  __/ | | |  _| (_| | (_| |___) |</span><br><span class="line"> \___/| .__/ \___|_| |_|_|  \__,_|\__,_|____/</span><br><span class="line">      |_|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Function created in folder: go-fn</span><br><span class="line">Stack file written: go-fn.yml</span><br><span class="line"></span><br><span class="line">Notes:</span><br><span class="line">You have created a new function which uses Go 1.19 and Alpine</span><br><span class="line">Linux as its base image.</span><br><span class="line"></span><br><span class="line">To disable the go module, for private vendor code, please use</span><br><span class="line">&quot;--build-arg GO111MODULE=off&quot; with faas-cli build or configure this</span><br><span class="line">via your stack.yml file.</span><br><span class="line"></span><br><span class="line">See more: https://docs.openfaas.com/cli/templates/</span><br><span class="line"></span><br><span class="line">For the template&#x27;s repo and more examples:</span><br><span class="line">https://github.com/openfaas/golang-http-template</span><br></pre></td></tr></table></figure>

<p>函数模板创建后，会在当前目录生成 go-fn 目录，其内容源自于 template&#x2F;golang-middleware&#x2F;function 以及 go-fn.yml 文件，用于描述函数构建的具体规格，例如：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">provider:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">openfaas</span></span><br><span class="line">  <span class="attr">gateway:</span> <span class="string">http://127.0.0.1:8080</span></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">go-fn:</span></span><br><span class="line">    <span class="attr">lang:</span> <span class="string">golang-middleware</span></span><br><span class="line">    <span class="attr">handler:</span> <span class="string">./go-fn</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.archeros.cn/dev/ake/openfaas-fn:dev</span></span><br></pre></td></tr></table></figure>

<h3 id="构建函数镜像"><a href="#构建函数镜像" class="headerlink" title="构建函数镜像"></a>构建函数镜像</h3><p><code>faas-cli build</code> 构建函数时，默认读取当前目录下的 stack.yml 文件，也可以通过 -f 指定。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli build -f go-fn.yml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker images</span></span><br><span class="line">harbor.archeros.cn/dev/ake/openfaas-fn     dev     891e42d0a44c     23 minutes ago     21MB</span><br></pre></td></tr></table></figure>

<p>构建时使用的 Dockerfile 位于 build&#x2F;go-fn&#x2F;Dockerfile（源自 template&#x2F;golang-middleware&#x2F;Dockerfile）。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> --platform=$&#123;TARGETPLATFORM:-linux/amd64&#125; ghcr.io/openfaas/of-watchdog:<span class="number">0.9</span>.<span class="number">11</span> as watchdog</span><br><span class="line"><span class="keyword">FROM</span> --platform=$&#123;BUILDPLATFORM:-linux/amd64&#125; golang:<span class="number">1.19</span>-alpine as build</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> TARGETPLATFORM</span><br><span class="line"><span class="keyword">ARG</span> BUILDPLATFORM</span><br><span class="line"><span class="keyword">ARG</span> TARGETOS</span><br><span class="line"><span class="keyword">ARG</span> TARGETARCH</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add git</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=watchdog /fwatchdog /usr/bin/fwatchdog</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /usr/bin/fwatchdog</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /go/src/handler</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /go/src/handler</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> GO111MODULE=<span class="string">&quot;on&quot;</span></span><br><span class="line"><span class="keyword">ARG</span> GOPROXY=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">ARG</span> GOFLAGS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">ARG</span> CGO_ENABLED=<span class="number">0</span></span><br><span class="line"><span class="keyword">ENV</span> CGO_ENABLED=$&#123;CGO_ENABLED&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run a gofmt and exclude all vendored code.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">test</span> -z <span class="string">&quot;<span class="subst">$(gofmt -l $(find . -type f -name &#x27;*.go&#x27; -not -path <span class="string">&quot;./vendor/*&quot;</span> -not -path <span class="string">&quot;./function/vendor/*&quot;</span>)</span>)&quot;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;Run \&quot;gofmt -s -w\&quot; on your Golang code&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /go/src/handler/function</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /go/src/handler/function/static</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> GOOS=<span class="variable">$&#123;TARGETOS&#125;</span> GOARCH=<span class="variable">$&#123;TARGETARCH&#125;</span> go <span class="built_in">test</span> ./... -cover</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /go/src/handler</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> GOOS=<span class="variable">$&#123;TARGETOS&#125;</span> GOARCH=<span class="variable">$&#123;TARGETARCH&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    go build --ldflags <span class="string">&quot;-s -w&quot;</span> -o handler .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> --platform=$&#123;TARGETPLATFORM:-linux/amd64&#125; alpine:<span class="number">3.17</span>.<span class="number">2</span> as ship</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add non root user and certs</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add ca-certificates \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; addgroup -S app &amp;&amp; adduser -S -g app app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Split instructions so that buildkit can run &amp; cache</span></span><br><span class="line"><span class="comment"># the previous command ahead of time.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /home/app \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chown</span> app /home/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build --<span class="built_in">chown</span>=app /go/src/handler/handler           .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build --<span class="built_in">chown</span>=app /usr/bin/fwatchdog                .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build --<span class="built_in">chown</span>=app /go/src/handler/function/static   static</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> fprocess=<span class="string">&quot;./handler&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> mode=<span class="string">&quot;http&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> upstream_url=<span class="string">&quot;http://127.0.0.1:8082&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> prefix_logs=<span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./fwatchdog&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>此外，构建参数可以通过 stack.yml 文件中的 build_args 选项指定，效果等价于 <code>faas-cli build --build-arg key1=value1,key2=value2</code>。最终，build_args 指定的参数会通过 docker build –build-arg 透传给 Dockerfile 中的 ARG。</p>
<p>例如，指定使用本地 vendor 构建 Golang 应用</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">with_go_modules:</span></span><br><span class="line">    <span class="attr">handler:</span> <span class="string">./with_go_modules</span></span><br><span class="line">    <span class="attr">lang:</span> <span class="string">go</span></span><br><span class="line">    <span class="attr">build_args:</span></span><br><span class="line">      <span class="attr">GO111MODULE:</span> <span class="string">off</span></span><br><span class="line">      <span class="attr">GOFLAGS:</span> <span class="string">&quot;-mod=vendor&quot;</span></span><br></pre></td></tr></table></figure>

<p>默认函数应用镜像拉取策略为 Always，需要将镜像推送至远程仓库。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli push -f go-fn.yml</span></span><br></pre></td></tr></table></figure>

<h3 id="发布函数"><a href="#发布函数" class="headerlink" title="发布函数"></a>发布函数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli deploy -f go-fn.yml</span> </span><br><span class="line">Deploying: go-fn.</span><br><span class="line">Handling connection for 8080</span><br><span class="line"></span><br><span class="line">Deployed. 202 Accepted.</span><br><span class="line">URL: http://127.0.0.1:8080/function/go-fn</span><br></pre></td></tr></table></figure>

<p>函数发布后，对应着一个 Deploy 创建。OpenFaaS CE 版本中，副本数最小为 1。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod -n openfaas-fn</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">go-fn-757f844cc5-v5tvn   1/1     Running   0          8s</span><br></pre></td></tr></table></figure>

<p>Pod 的关键参数为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fprocess</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">./handler</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.archeros.cn/dev/ake/openfaas-fn:dev</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/_/health</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">go-fn</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/_/health</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-b7kx5</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">wnx</span></span><br><span class="line">  <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-b7kx5</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">namespace</span></span><br></pre></td></tr></table></figure>

<p>已发布的函数中，Invocations 为调用次数，Replicas 为当前函数应用的副本。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli list</span></span><br><span class="line">Function    	Invocations    	Replicas</span><br><span class="line">go-fn    	    0              	1   </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas describe go-fn</span></span><br><span class="line">Name:               go-fn</span><br><span class="line">Status:             Not Ready</span><br><span class="line">Replicas:           1</span><br><span class="line">Available Replicas: 0</span><br><span class="line">Invocations:        17542</span><br><span class="line">Image:              harbor.archeros.cn/dev/ake/openfaas-fn:dev</span><br><span class="line">Function Process:   ./handler</span><br><span class="line">URL:                http://127.0.0.1:8080/function/go-fn</span><br><span class="line">Async URL:          http://127.0.0.1:8080/async-function/go-fn</span><br><span class="line">Labels:</span><br><span class="line"> faas_function: go-fn</span><br><span class="line">Annotations:</span><br><span class="line"> prometheus.io.scrape: false</span><br></pre></td></tr></table></figure>

<p>也可以通过部署时指定 –label 限制扩容规格等信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli deploy -f go-fn.yml --label com.openfaas.scale.max=2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此时无论多大的请求量，最大</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli describe go-fn</span></span><br><span class="line">Name:               go-fn</span><br><span class="line">Status:             Ready</span><br><span class="line">Replicas:           2</span><br><span class="line">Available Replicas: 2</span><br><span class="line">Invocations:        21517</span><br><span class="line">Image:              harbor.archeros.cn/dev/ake/openfaas-fn:dev</span><br><span class="line">Function Process:   ./handler</span><br><span class="line">URL:                http://127.0.0.1:8080/function/go-fn</span><br><span class="line">Async URL:          http://127.0.0.1:8080/async-function/go-fn</span><br><span class="line">Labels:</span><br><span class="line"> com.openfaas.scale.max: 2</span><br><span class="line"> faas_function: go-fn</span><br><span class="line">Annotations:</span><br><span class="line"> prometheus.io.scrape: false</span><br></pre></td></tr></table></figure>



<p>除了 faas-cli，函数的创建、构建与发布也可以通过 OpenFaaS UI 操作：</p>
<div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/deploy.png"></div>

<h3 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli invoke go-fn</span></span><br><span class="line">Reading from STDIN - hit (Control + D) to stop.</span><br><span class="line">Hello World</span><br><span class="line">Body: Hello World</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">等价于</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> Hello World | faas-cli invoke go-fn</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli invoke go-fn --from-literal=<span class="string">&quot;Hello World&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli invoke go-fn --from-file=~/Downloads/derek.pem</span></span><br></pre></td></tr></table></figure>

<p>UI 调用方式为：</p>
<div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/invoke.png"></div>

<p>此外，根据函数调用的路由，也分为同步调用与异步调用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同步调用 <span class="keyword">function</span> 路由</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -i -d <span class="string">&quot;Hello World&quot;</span> http://127.0.0.1:8080/function/go-fn</span></span><br><span class="line">Handling connection for 8080</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 17</span><br><span class="line">Content-Type: text/plain; charset=utf-8</span><br><span class="line">Date: Fri, 09 Jun 2023 03:43:13 GMT</span><br><span class="line">X-Call-Id: 98630f05-1b39-4fc5-bb89-7c2c66c1cf7f</span><br><span class="line">X-Duration-Seconds: 0.002147</span><br><span class="line">X-Start-Time: 1686282193791968394</span><br><span class="line"></span><br><span class="line">Body: Hello World</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">异步调用 async-function 路由</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -i -d <span class="string">&quot;Hello World&quot;</span> http://127.0.0.1:8080/async-function/go-fn</span></span><br><span class="line">Handling connection for 8080</span><br><span class="line">HTTP/1.1 202 Accepted</span><br><span class="line">X-Call-Id: fea5f39d-e7ad-4454-8283-1a213710f3a7</span><br><span class="line">X-Start-Time: 1686282228379248896</span><br><span class="line">Date: Fri, 09 Jun 2023 03:43:48 GMT</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<h3 id="自动扩缩容"><a href="#自动扩缩容" class="headerlink" title="自动扩缩容"></a>自动扩缩容</h3><p>模拟海量请求，观察 OpenFaaS 函数应用的	自动扩容。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="keyword">while</span> <span class="literal">true</span> ;<span class="keyword">do</span> <span class="built_in">echo</span> Hello World | faas-cli invoke go-fn; <span class="keyword">done</span></span></span><br></pre></td></tr></table></figure>

<p>随着请求调用量的增加，副本数也逐渐增加。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deploy -n openfaas-fn   go-fn -w</span></span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">go-fn   1/1     1            1           7m57s</span><br><span class="line">go-fn   1/2     2            1           8m35s</span><br><span class="line">go-fn   2/2     2            2           8m38s</span><br><span class="line">go-fn   2/3     3            2           9m15s</span><br><span class="line">go-fn   3/3     3            3           9m18s</span><br><span class="line">go-fn   3/4     3            3           9m55s</span><br><span class="line">go-fn   4/4     4            4           9m59s</span><br><span class="line">go-fn   4/5     4            4           10m</span><br><span class="line">go-fn   5/5     5            5           10m</span><br></pre></td></tr></table></figure>

<p>当停止模拟请求时，副本数也逐渐减少。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deploy -n openfaas-fn   go-fn -w</span></span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">go-fn   5/5     5            5           11m</span><br><span class="line">go-fn   5/1     5            5           11m</span><br><span class="line">go-fn   1/1     1            1           11m</span><br></pre></td></tr></table></figure>

<p>也可以通过部署时指定 –label 限制扩容规格等信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli deploy -f go-fn.yml --label com.openfaas.scale.max=2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli describe go-fn</span></span><br><span class="line">Name:               go-fn</span><br><span class="line">Status:             Ready</span><br><span class="line">Replicas:           2</span><br><span class="line">Available Replicas: 2</span><br><span class="line">Invocations:        21517</span><br><span class="line">Image:              harbor.archeros.cn/dev/ake/openfaas-fn:dev</span><br><span class="line">Function Process:   ./handler</span><br><span class="line">URL:                http://127.0.0.1:8080/function/go-fn</span><br><span class="line">Async URL:          http://127.0.0.1:8080/async-function/go-fn</span><br><span class="line">Labels:</span><br><span class="line"> com.openfaas.scale.max: 2</span><br><span class="line"> faas_function: go-fn</span><br><span class="line">Annotations:</span><br><span class="line"> prometheus.io.scrape: false</span><br></pre></td></tr></table></figure>

<h3 id="函数日志"><a href="#函数日志" class="headerlink" title="函数日志"></a>函数日志</h3><p>针对 Kubernetes 的日志 provider 为 faas-netes 组件，其获取日志的方式等价于 <code>kubectl logs -n openfaas-fn deploy/function</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli logs go-fn</span></span><br><span class="line">2023-06-07T16:15:23+08:00 2023/06/07 08:15:23 POST / - 200 OK - ContentLength: 18B (0.0008s)</span><br><span class="line">2023-06-07T16:15:23+08:00 2023/06/07 08:15:23 POST / - 200 OK - ContentLength: 18B (0.0005s)</span><br><span class="line">2023-06-07T16:15:24+08:00 2023/06/07 08:15:24 POST / - 200 OK - ContentLength: 18B (0.0015s)</span><br><span class="line">2023-06-07T16:15:24+08:00 2023/06/07 08:15:24 POST / - 200 OK - ContentLength: 18B (0.0007s)</span><br><span class="line">2023-06-07T16:15:24+08:00 2023/06/07 08:15:24 POST / - 200 OK - ContentLength: 18B (0.0017s)</span><br></pre></td></tr></table></figure>

<h3 id="移除函数"><a href="#移除函数" class="headerlink" title="移除函数"></a>移除函数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli remove go-fn</span></span><br><span class="line">Deleting: go-fn.</span><br><span class="line">Handling connection for 8080</span><br><span class="line">Removing old function.</span><br></pre></td></tr></table></figure>

<h2 id="Secret-管理"><a href="#Secret-管理" class="headerlink" title="Secret 管理"></a>Secret 管理</h2><p>之所以二次封装 API，是为了便于管理函数所用到的 Secret。</p>
<p>默认操作的 Secret 位于 openfaas-fn 命名空间下，可以通过 –namespace 指定；默认操作的 OpenFaaS 实例为 </p>
<p><strong>create</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret create my-secret</span></span><br><span class="line">Reading from STDIN - hit (Control + D) to stop.</span><br><span class="line">my-password</span><br><span class="line">Creating secret: my-secret.</span><br><span class="line">Handling connection for 8080</span><br><span class="line">Created: 202 Accepted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">等价于</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> my-password | faas-cli secret create my-secret</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret create my-secret --from-literal=<span class="string">&quot;my-password&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret create my-secret --from-file=~/Downloads/derek.pem</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">my-secret:</span> <span class="string">bXktcGFzc3dvcmQ=</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-06-07T06:19:14Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">openfaas</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">openfaas-fn</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;11584461&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">dd0803f2-76d8-453a-a770-ec2633cd6b22</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br></pre></td></tr></table></figure>

<p><strong>update</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret update my-secret</span></span><br><span class="line">Reading from STDIN - hit (Control + D) to stop.</span><br><span class="line">my-new-pasword</span><br><span class="line">Updating secret: my-secret</span><br><span class="line">Handling connection for 8080</span><br><span class="line">Updated: 202 Accepted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">等价于</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> my-new-secret | faas-cli secret update my-secret</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret update my-secret --from-literal=<span class="string">&quot;my-password&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret update my-secret --from-file=~/Downloads/derek.pem</span></span><br></pre></td></tr></table></figure>

<p><strong>list</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret list</span></span><br><span class="line">Handling connection for 8080</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">my-secret</span><br></pre></td></tr></table></figure>

<p><strong>delete</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret remove my-secret</span></span><br><span class="line">faas-cli secret remove my-secret</span><br><span class="line">Handling connection for 8080</span><br><span class="line">Removed.. OK.</span><br></pre></td></tr></table></figure>

<h1 id="OpenFaaS-Pro"><a href="#OpenFaaS-Pro" class="headerlink" title="OpenFaaS Pro"></a>OpenFaaS Pro</h1><p><em>OpenFaaS Pro 是 OpenFaaS 的商业许可发行版，具有附加功能、配置和商业支持。</em></p>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><h3 id="faas-cli-pro"><a href="#faas-cli-pro" class="headerlink" title="faas-cli pro"></a>faas-cli pro</h3><p>faas-cli 对于 OpenFaaS Pro 的支持是通过插件的方式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli plugin get pro</span></span><br><span class="line">Fetching plugin: pro</span><br><span class="line">Downloaded in (4s)</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  faas-cli pro</span><br></pre></td></tr></table></figure>

<p>根据 github 账号校验 OpenFaaS Pro 购买认证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli pro <span class="built_in">enable</span></span></span><br><span class="line">Please visit: https://github.com/login/device</span><br><span class="line">and enter the code: 168C-29B2</span><br><span class="line">Waiting for authorization...</span><br><span class="line">Waiting for authorization...</span><br><span class="line">Waiting for authorization...</span><br><span class="line">Waiting for authorization...</span><br><span class="line">GET https://api.github.com/user/memberships/orgs: 401 Bad credentials []</span><br></pre></td></tr></table></figure>

<h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><h3 id="Support"><a href="#Support" class="headerlink" title="Support"></a>Support</h3><table>
<thead>
<tr>
<th align="left">Description</th>
<th align="left">OpenFaaS CE</th>
<th align="left">OpenFaaS Pro</th>
<th align="left">OpenFaaS for Enterprise</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Suitability</td>
<td align="left">Open Source developers and initial exploration</td>
<td align="left">Production, business critical, or PoC</td>
<td align="left">Regulated companies which may have additional legal and compliance requirements</td>
</tr>
<tr>
<td align="left">SLA</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left">Response within 1 business day for P1</td>
</tr>
<tr>
<td align="left">Buying process</td>
<td align="left">N&#x2F;a</td>
<td align="left">Invoice paid by bank transfer</td>
<td align="left">Supplier portals, custom paperwork, negotiation with procurement.</td>
</tr>
<tr>
<td align="left">Legal review of contract</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left">Yes</td>
</tr>
<tr>
<td align="left">Signing of Mutual NDA</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left">Subject to agreement</td>
</tr>
<tr>
<td align="left">Additional compliance needs</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left">Subject to agreement</td>
</tr>
<tr>
<td align="left">Support via email</td>
<td align="left">N&#x2F;a</td>
<td align="left">Pro features only</td>
<td align="left">All certified Open Source and commercial components</td>
</tr>
<tr>
<td align="left">Support via GitHub</td>
<td align="left">N&#x2F;a</td>
<td align="left">Pro features only using the Customer Community</td>
<td align="left">N&#x2F;a</td>
</tr>
<tr>
<td align="left">Support via Slack</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left">Up to 5 developers</td>
</tr>
<tr>
<td align="left">License</td>
<td align="left"><a target="_blank" rel="noopener" href="https://github.com/openfaas/faas/blob/master/LICENSE">MIT</a></td>
<td align="left"><a target="_blank" rel="noopener" href="https://github.com/openfaas/faas/blob/master/pro/EULA">Commercial license EULA</a></td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Architecture review</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left">With our team via Zoom</td>
</tr>
<tr>
<td align="left">Onboarding call</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left">With our team via Zoom</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://github.com/openfaas/customers">Customer Community</a></td>
<td align="left">N&#x2F;a</td>
<td align="left">Private access to <a target="_blank" rel="noopener" href="https://github.com/openfaas/customers">Customer Community</a> - one user per licensed cluster</td>
<td align="left">Custom amount of users</td>
</tr>
</tbody></table>
<h3 id="Autoscaling"><a href="#Autoscaling" class="headerlink" title="Autoscaling"></a>Autoscaling</h3><table>
<thead>
<tr>
<th align="left">Description</th>
<th align="left">OpenFaaS CE</th>
<th align="left">OpenFaaS Pro</th>
<th align="left">OpenFaaS for Enterprise</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Scale to Zero</td>
<td align="left">Not supported</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/openfaas-pro/scale-to-zero">Global default, or custom time per function</a></td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Maximum replicas per function</td>
<td align="left">5 Pods</td>
<td align="left">No limit applied</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Scale to From</td>
<td align="left">Not supported</td>
<td align="left">Supported, with additional checks for Istio</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Autoscaling strategy</td>
<td align="left">RPS-only</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/architecture/autoscaling">CPU utilization, Capacity (inflight requests) or RPS</a></td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Autoscaling granularity</td>
<td align="left">Single rule for all functions</td>
<td align="left">Configurable per function</td>
<td align="left">As per Pro</td>
</tr>
</tbody></table>
<h3 id="Core-Features"><a href="#Core-Features" class="headerlink" title="Core Features"></a>Core Features</h3><table>
<thead>
<tr>
<th align="left">Description</th>
<th align="left">OpenFaaS CE</th>
<th align="left">OpenFaaS Pro</th>
<th align="left">OpenFaaS for Enterprise</th>
</tr>
</thead>
<tbody><tr>
<td align="left">UI Dashboard</td>
<td align="left">Legacy UI (in code-freeze)</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/openfaas-pro/dashboard">New UI dashboard</a> with metrics, logs &amp; CI integration</td>
<td align="left">As per Pro, but with support for multiple namespaces</td>
</tr>
<tr>
<td align="left">Consume secrets in <code>faas-cli build</code> for npm, Go and Pypy</td>
<td align="left">Not available</td>
<td align="left">Via build-time secrets</td>
<td align="left">As Per Pro</td>
</tr>
<tr>
<td align="left">Kubernetes service accounts for functions</td>
<td align="left">N&#x2F;a</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/reference/workloads">Supported per function</a></td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Async &#x2F; queueing</td>
<td align="left">In-memory only, max 10 items in queue, 256KB message size</td>
<td align="left">JetStream with shared queue</td>
<td align="left">JetStream with dedicated queues</td>
</tr>
<tr>
<td align="left">Metrics</td>
<td align="left">Basic function metrics</td>
<td align="left">Function, HTTP, CPU&#x2F;RAM usage, and async&#x2F;queue metrics</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">CPU &amp; RAM utilization</td>
<td align="left">Not available</td>
<td align="left">Integrated with Prometheus metrics, OpenFaaS REST API &amp; CLI</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Grafana Dashboards</td>
<td align="left">N&#x2F;a</td>
<td align="left">4x dashboards supplied in <a target="_blank" rel="noopener" href="https://github.com/openfaas/customers">Customer Community</a> - overview, spotlight for debugging a function, queue-worker and Function Builder API</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">GitOps &amp; CRD support</td>
<td align="left">Not available</td>
<td align="left">ArgoCD, FluxCD and Helm compatibility using the Function CRD</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Deployment options</td>
<td align="left">faas-cli or REST API</td>
<td align="left">As per CE, plus: Function CRD with kubectl, Helm or GitOps</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Custom Resource Definition</td>
<td align="left">Not available</td>
<td align="left">Function and Profile</td>
<td align="left"></td>
</tr>
</tbody></table>
<h3 id="Event-Connectors"><a href="#Event-Connectors" class="headerlink" title="Event Connectors"></a>Event Connectors</h3><table>
<thead>
<tr>
<th align="left">Description</th>
<th align="left">OpenFaaS CE</th>
<th align="left">OpenFaaS Pro</th>
<th align="left">OpenFaaS for Enterprise</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Number of topics per function</td>
<td align="left">One topic per function</td>
<td align="left">Multiple topics per function</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/openfaas-pro/kafka-events">Kafka event trigger</a></td>
<td align="left">Not supported</td>
<td align="left">Supports SASL or TLS auth, Aiven, Confluent and self-hosted</td>
<td align="left">Support with SLA</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/openfaas-pro/postgres-events">Postgres trigger</a></td>
<td align="left">Not supported</td>
<td align="left">Supports insert, update and delete, with table-level filters using WAL or LISTEN&#x2F;NOTIFY.</td>
<td align="left">Support with SLA</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/openfaas-pro/sqs-events">AWS SQS trigger</a></td>
<td align="left">Not supported</td>
<td align="left">Standard support</td>
<td align="left">Support with SLA</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/reference/cron">Cron and scheduled invocations</a></td>
<td align="left">Community support</td>
<td align="left">Standard support</td>
<td align="left">Support with SLA</td>
</tr>
</tbody></table>
<h3 id="Durability-and-Reliability"><a href="#Durability-and-Reliability" class="headerlink" title="Durability and Reliability"></a>Durability and Reliability</h3><table>
<thead>
<tr>
<th align="left">Description</th>
<th align="left">OpenFaaS CE</th>
<th align="left">OpenFaaS Pro</th>
<th align="left">OpenFaaS for Enterprise</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Readiness probes</td>
<td align="left">Not supported</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/reference/workloads">Readiness probes</a> supported with custom HTTP path and intervals per function</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Retries for failed function invocations</td>
<td align="left">Not supported</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/openfaas-pro/retries">Retry invocations</a> for configured HTTP codes with an exponential back-off</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Highly Available messaging</td>
<td align="left">Not available, in-memory only</td>
<td align="left">Available for NATS JetStream, with 3x servers.</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Long executions of async functions</td>
<td align="left">Limited to 5 minutes</td>
<td align="left">Configurable duration</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Callback to custom URL for async functions</td>
<td align="left">Supported</td>
<td align="left">As per CE</td>
<td align="left">As per CE</td>
</tr>
</tbody></table>
<h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><table>
<thead>
<tr>
<th align="left">Description</th>
<th align="left">OpenFaaS CE</th>
<th align="left">OpenFaaS Pro</th>
<th align="left">OpenFaaS for Enterprise</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Authentication for OpenFaaS API, CLI and UI</td>
<td align="left">Shared admin password between everyone who uses OpenFaaS</td>
<td align="left">N&#x2F;a</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/openfaas-pro/sso">Single Sign-On with OIDC</a></td>
</tr>
<tr>
<td align="left">Compatibility with Istio for mTLS</td>
<td align="left">N&#x2F;a</td>
<td align="left">Supported</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">PCI&#x2F;GDPR compliance</td>
<td align="left">Sensitive information such as the request body&#x2F;response body, headers may be printed into the logs for each asynchronous invocation</td>
<td align="left">Sensitive information is not printed to the logs for asynchronous requests</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Secure isolation with Kata containers or gVisor</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left">Supported using an <a target="_blank" rel="noopener" href="https://docs.openfaas.com/reference/profiles">OpenFaaS Pro Profile and runtimeClass</a></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/#accessing-the-service">Service links</a> injected as environment variables</td>
<td align="left">Yes, cannot be disabled</td>
<td align="left">Disabled as a default</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/security/pod-security-standards/#restricted">Pod privilege escalation</a></td>
<td align="left">Default for Kubernetes</td>
<td align="left">Explicitly disabled</td>
<td align="left">As per Pro</td>
</tr>
<tr>
<td align="left">Split installation without ClusterAdmin role</td>
<td align="left">N&#x2F;a</td>
<td align="left">Provided in <a target="_blank" rel="noopener" href="https://github.com/openfaas/customers">Customer Community</a></td>
<td align="left">As per Pro</td>
</tr>
</tbody></table>
<h3 id="Platform-Features"><a href="#Platform-Features" class="headerlink" title="Platform Features"></a>Platform Features</h3><table>
<thead>
<tr>
<th align="left">Description</th>
<th align="left">OpenFaaS CE</th>
<th align="left">OpenFaaS Pro</th>
<th align="left">OpenFaaS for Enterprise</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Deploy functions via REST API</td>
<td align="left">Yes</td>
<td align="left">As per CE</td>
<td align="left">As per CE</td>
</tr>
<tr>
<td align="left">Build containers and functions via REST API</td>
<td align="left">N&#x2F;a</td>
<td align="left">N&#x2F;a</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.openfaas.com/openfaas-pro/builder">Yes via Function Builder API</a></td>
</tr>
<tr>
<td align="left">Multiple namespace support</td>
<td align="left">No support</td>
<td align="left">N&#x2F;a</td>
<td align="left">Supported with Kubernetes namespaces</td>
</tr>
</tbody></table>
<h1 id="faasd"><a href="#faasd" class="headerlink" title="faasd"></a>faasd</h1><blockquote>
<p>based on <strong>0.16.9</strong></p>
</blockquote>
<p>faasd 是 OpenFaaS 的重新构想，但没有 Kubernetes 的成本和复杂性。其本质就是一个 Golang 二进制文件，它可以在要求非常低的单个主机上运行，使其快速且易于管理。在底层，它使用 Containerd 和 CNI 以及来自主项目的相同核心 OpenFaaS 组件，因此在使用层面可以完全参考 OpenFaaS CE 的操作。</p>
<h2 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/openfaas/faasd/releases/download/0.16.9/faasd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x faasd &amp;&amp; <span class="built_in">mv</span> faasd /usr/local/bin</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">basic-auth-user 和 secrets/basic-auth-password 为网关认证的用户名和密码</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faasd install</span></span><br><span class="line">2023/06/08 17:53:15 Writing to: &quot;/var/lib/faasd/secrets/basic-auth-password&quot;</span><br><span class="line">2023/06/08 17:53:15 Writing to: &quot;/var/lib/faasd/secrets/basic-auth-user&quot;</span><br><span class="line">Check status with:</span><br><span class="line">  sudo journalctl -u faasd --lines 100 -f</span><br><span class="line"></span><br><span class="line">Login with:</span><br><span class="line">  sudo cat /var/lib/faasd/secrets/basic-auth-password | faas-cli login -s</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl status faasd</span></span><br><span class="line">● faasd.service - faasd</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/faasd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2023-06-08 17:53:17 CST; 4min 26s ago</span><br><span class="line"> Main PID: 43031 (faasd)</span><br><span class="line">    Tasks: 11</span><br><span class="line">   Memory: 30.9M (limit: 500.0M)</span><br><span class="line">   CGroup: /system.slice/faasd.service</span><br><span class="line">           └─43031 /usr/local/bin/faasd up</span><br><span class="line"></span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Looking up IP for: &quot;prometheus&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;localhost&quot;=&quot;127.0.0.1&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;faasd-provider&quot;=&quot;10.62.0.1&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;nats&quot;=&quot;10.62.0.2&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;prometheus&quot;=&quot;10.62.0.3&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;gateway&quot;=&quot;10.62.0.4&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;queue-worker&quot;=&quot;10.62.0.5&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Proxy from: 127.0.0.1:9090, to: prometheus:9090 (10.62.0.3)</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 faasd: waiting for SIGTERM or SIGINT</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Proxy from: 0.0.0.0:8080, to: gateway:8080 (10.62.0.4)</span><br></pre></td></tr></table></figure>

<p>通过服务状态可以看到，10.62.0.1 ~ 10.62.0.5 用于监听 OpenFaaS 核心服务，位于 Containerd 的 openfaas 命名空间中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ctr -n openfaas c <span class="built_in">ls</span></span></span><br><span class="line">CONTAINER       IMAGE                                      RUNTIME                  </span><br><span class="line">gateway         ghcr.io/openfaas/gateway:0.26.3            io.containerd.runc.v2    </span><br><span class="line">nats            docker.io/library/nats-streaming:0.25.3    io.containerd.runc.v2    </span><br><span class="line">prometheus      docker.io/prom/prometheus:v2.42.0          io.containerd.runc.v2    </span><br><span class="line">queue-worker    ghcr.io/openfaas/queue-worker:0.13.3       io.containerd.runc.v2 </span><br></pre></td></tr></table></figure>

<h2 id="网关认证-1"><a href="#网关认证-1" class="headerlink" title="网关认证"></a>网关认证</h2><p>外部网关为 <code>http://178.104.162.69:8080/ui</code>，认证信息位于 &#x2F;var&#x2F;lib&#x2F;faasd&#x2F;secrets&#x2F;basic-auth-user 和 &#x2F;var&#x2F;lib&#x2F;faasd&#x2F;secrets&#x2F;basic-auth-password。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /var/lib/faasd/secrets/basic-auth-password | faas-cli login -s</span></span><br><span class="line">Calling the OpenFaaS server to validate the credentials...</span><br><span class="line">credentials saved for admin http://127.0.0.1:8080</span><br></pre></td></tr></table></figure>

<p>其余模板商店和使用方式等操作和 OpenFaaS CE 完全一致。其中，OpenFaaS 函数容器托管在 Containerd 的 openfaas-fn 命名空间中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ctr -n openfaas-fn c <span class="built_in">ls</span></span></span><br><span class="line">CONTAINER    IMAGE                                         RUNTIME                  </span><br><span class="line">go-fn        harbor.archeros.cn/dev/ake/openfaas-fn:dev    io.containerd.runc.v2</span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>「 OpenFaaS 」快速开始</p><p><a href="http://shenxianghong.github.io/2023/06/05/2023-06-05 OpenFaaS 快速开始/">http://shenxianghong.github.io/2023/06/05/2023-06-05 OpenFaaS 快速开始/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Shen Xianghong</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2023-06-05</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-06-12</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/OpenFaaS/">OpenFaaS </a></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/05/19/2023-05-19%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20hypervisor/"><span class="level-item">「 Kata Containers 」源码走读 — virtcontainers/hypervisor</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/35031258?v=4" alt="🐾Corgi"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">🐾Corgi</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">51</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/shenxianghong" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Youtube" href="https://youtube.com"><i class="fab fa-youtube"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Bilibili" href="https://bilibili.com"><i class="fab fa-bilibili"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Reddit" href="https://reddit.com"><i class="fab fa-reddit"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://google.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">google.com</span></span></a></li><li><a class="level is-mobile" href="https://poe.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Poe</span></span><span class="level-right"><span class="level-item tag">poe.com</span></span></a></li></ul></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#OpenFaaS-CE"><span class="level-left"><span class="level-item">1</span><span class="level-item">OpenFaaS CE</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">安装</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#faas-cli"><span class="level-left"><span class="level-item">1.1.1</span><span class="level-item">faas-cli</span></span></a></li><li><a class="level is-mobile" href="#OpenFaaS"><span class="level-left"><span class="level-item">1.1.2</span><span class="level-item">OpenFaaS</span></span></a></li></ul></li><li><a class="level is-mobile" href="#网关认证"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">网关认证</span></span></a></li><li><a class="level is-mobile" href="#模板商店"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">模板商店</span></span></a></li><li><a class="level is-mobile" href="#Hello-World"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">Hello World</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#创建函数"><span class="level-left"><span class="level-item">1.4.1</span><span class="level-item">创建函数</span></span></a></li><li><a class="level is-mobile" href="#构建函数镜像"><span class="level-left"><span class="level-item">1.4.2</span><span class="level-item">构建函数镜像</span></span></a></li><li><a class="level is-mobile" href="#发布函数"><span class="level-left"><span class="level-item">1.4.3</span><span class="level-item">发布函数</span></span></a></li><li><a class="level is-mobile" href="#调用函数"><span class="level-left"><span class="level-item">1.4.4</span><span class="level-item">调用函数</span></span></a></li><li><a class="level is-mobile" href="#自动扩缩容"><span class="level-left"><span class="level-item">1.4.5</span><span class="level-item">自动扩缩容</span></span></a></li><li><a class="level is-mobile" href="#函数日志"><span class="level-left"><span class="level-item">1.4.6</span><span class="level-item">函数日志</span></span></a></li><li><a class="level is-mobile" href="#移除函数"><span class="level-left"><span class="level-item">1.4.7</span><span class="level-item">移除函数</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Secret-管理"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">Secret 管理</span></span></a></li></ul></li><li><a class="level is-mobile" href="#OpenFaaS-Pro"><span class="level-left"><span class="level-item">2</span><span class="level-item">OpenFaaS Pro</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装-1"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">安装</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#faas-cli-pro"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">faas-cli pro</span></span></a></li></ul></li><li><a class="level is-mobile" href="#对比"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">对比</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Support"><span class="level-left"><span class="level-item">2.2.1</span><span class="level-item">Support</span></span></a></li><li><a class="level is-mobile" href="#Autoscaling"><span class="level-left"><span class="level-item">2.2.2</span><span class="level-item">Autoscaling</span></span></a></li><li><a class="level is-mobile" href="#Core-Features"><span class="level-left"><span class="level-item">2.2.3</span><span class="level-item">Core Features</span></span></a></li><li><a class="level is-mobile" href="#Event-Connectors"><span class="level-left"><span class="level-item">2.2.4</span><span class="level-item">Event Connectors</span></span></a></li><li><a class="level is-mobile" href="#Durability-and-Reliability"><span class="level-left"><span class="level-item">2.2.5</span><span class="level-item">Durability and Reliability</span></span></a></li><li><a class="level is-mobile" href="#Security"><span class="level-left"><span class="level-item">2.2.6</span><span class="level-item">Security</span></span></a></li><li><a class="level is-mobile" href="#Platform-Features"><span class="level-left"><span class="level-item">2.2.7</span><span class="level-item">Platform Features</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#faasd"><span class="level-left"><span class="level-item">3</span><span class="level-item">faasd</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#安装-2"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">安装</span></span></a></li><li><a class="level is-mobile" href="#网关认证-1"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">网关认证</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Container-Runtime/"><span class="level-start"><span class="level-item">Container Runtime</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/categories/Disaster-Recovery/"><span class="level-start"><span class="level-item">Disaster Recovery</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/Scheduling-Orchestration/"><span class="level-start"><span class="level-item">Scheduling &amp; Orchestration</span></span><span class="level-end"><span class="level-item tag">2</span></span></a><ul><li><a class="level is-mobile" href="/categories/Scheduling-Orchestration/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Serverless/"><span class="level-start"><span class="level-item">Serverless</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Service-Mesh/"><span class="level-start"><span class="level-item">Service Mesh</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="🐾Corgi" height="28"></a><p class="is-size-7"><span>&copy; 2023 Shen Xianghong</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p><p class="is-size-7"><br/>And did you get what you wanted from this life, even so?</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>