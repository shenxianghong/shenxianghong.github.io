---
title: "「 OpenFaaS 」快速开始"
excerpt: "OpenFaaS 架构设计理念与组件功能概述"
cover: https://picsum.photos/0?sig=20230605
thumbnail: https://landscape.cncf.io/logos/open-faa-s.svg
date: 2023-06-05
toc: true
categories:
- Serverless
tag:
- OpenFaaS
---

<div align=center><img width="200" style="border: 0px" src="/gallery/openfaas/openfaas-logo.png"></div>

------

> based on **0.26.3**

OpenFaaS 支持部署至以下环境中：

- Kubernetes、K3s、OpenShift 等容器编排环境
- 运行 faasd 服务的单点服务器环境

相比之下，与 Kubernetes 等容器编排环境集成能够提供更好的可扩展能力。

# OpenFaaS CE

*Community Edition 版本面向内部使用、开发和概念验证*

OpenFaaS CE 安装方法：

- [arkade](https://arkade.dev/)<br>*arkade 本质上为一站式部署工具，支持许多服务部署，其中对于 OpenFaaS 服务支持完善。内部集成了二进制的下载与 Helm chart 的安装，arkade 封装了 helm 的参数赋值与部署，也就是在 helm 中通过 --set 设置的变量，arkade 通过 --flags 的方式处理了*
- Helm chart、Flux 或者 ArgoCD
- 静态 YAML 配置文件

## 安装

### faas-cli

**使用 arkade 安装**

```shell
# 安装 arkade
$ curl -sSL https://get.arkade.dev | sudo -E sh

# 安装 faas-cli
$ arkade get faas-cli
$ sudo mv /root/.arkade/bin/faas-cli /usr/local/bin/
```

**使用 bash 安装**

```shell
$ curl -sSL https://cli.openfaas.com | sh
New version of faas-cli installed to /usr/local/bin
Creating alias 'faas' for 'faas-cli'.
```

### OpenFaaS

**使用 arkade 安装**

*arkade 封装了 helm 的参数赋值与部署，也就是在 helm 中通过 --set 设置的变量，arkade 通过 --flags 的方式处理了*

```shell
# 安装 arkade
$ curl -sSL https://get.arkade.dev | sudo -E sh

# 默认安装
$ arkade install openfaas

# 安装可选参数
$ arkade install openfaas --help
```

**使用 helm 安装**

```shell
# 安装 helm
$ curl -sSLf https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

# 推荐创建两个 namespace：openfaas 和 openfaas-fn，前者用于部署 OpenFaaS 服务组件，后者用于部署函数
# arkade 部署中，默认创建了这两个 namespace
$ kubectl apply -f https://raw.githubusercontent.com/openfaas/faas-netes/master/namespaces.yml

$ helm repo add openfaas https://openfaas.github.io/faas-netes/
$ helm repo update && helm upgrade openfaas --install openfaas/openfaas --namespace openfaas
```

**安装结果**

```shell
$ kubectl get deploy -n openfaas
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
alertmanager   1/1     1            1           71s
gateway        1/1     1            1           71s
nats           1/1     1            1           71s
prometheus     1/1     1            1           71s
queue-worker   1/1     1            1           71s

$ kubectl get svc -n openfaas
NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
alertmanager       ClusterIP   10.96.76.14     <none>        9093/TCP         74s
gateway            ClusterIP   10.96.4.162     <none>        8080/TCP         74s
gateway-external   NodePort    10.96.10.134    <none>        8080:31112/TCP   74s
nats               ClusterIP   10.96.196.157   <none>        4222/TCP         74s
prometheus         ClusterIP   10.96.166.131   <none>        9090/TCP         74s
```

## 网关认证

这里采用 NodePort 的形式部署 OpenFaaS CE 服务。其中，gateway-external 为对外暴露的网关服务，gateway 为对内暴露的网关服务，其后端均为 gateway Pod。无论哪种方式均采用 HTTP 认证登录方式，认证用户名为 admin，密码在 Secret 中保存：

```shell
$ PASSWORD=$(kubectl get secret -n openfaas basic-auth -o jsonpath="{.data.basic-auth-password}" | base64 --decode; echo)
$ echo "OpenFaaS admin password: $PASSWORD"
```

**gateway**

```shell
$ kubectl rollout status -n openfaas deploy/gateway
$ kubectl port-forward -n openfaas svc/gateway 8080:8080 &
$ echo -n $PASSWORD | faas-cli login --username admin --password-stdin
Calling the OpenFaaS server to validate the credentials...
Handling connection for 8080
credentials saved for admin http://127.0.0.1:8080
```

**gateway-external**

HTTP 认证登录 gateway-external 暴露的服务，即 `http://178.104.162.69:31112/ui/`。

## 模板商店

社区提供的模板商店为 https://github.com/openfaas/store/blob/master/templates.json，其中来源自 OpenFaaS 官方社区与周边社区

```shell
{
	{
        "template": "go",
        "platform": "x86_64",
        "language": "Go",
        "source": "openfaas",
        "description": "Legacy Golang template",
        "repo": "https://github.com/openfaas/templates",
        "official": "true"
    },
    {
        "template": "rust",
        "platform": "x86_64",
        "language": "Rust",
        "source": "openfaas-incubator",
        "description": "Community Rust template",
        "repo": "https://github.com/openfaas-incubator/openfaas-rust-template",
        "official": "false"
    },
}
```

查看默认支持的模板商店

```shell
$ faas-cli template store list
NAME                     RECOMMENDED DESCRIPTION        SOURCE
bash-streaming           [x]         openfaas-incubator Bash Streaming template
dockerfile               [x]         openfaas           Classic Dockerfile template
golang-middleware        [x]         openfaas           HTTP middleware interface in Go
java11-vert-x            [x]         openfaas           Java 11 Vert.x template
node18                   [x]         openfaas           HTTP-based Node 18 template
php8                     [x]         openfaas           Classic PHP 8 template
python3-http             [x]         openfaas           Python 3 with Flask and HTTP
python3-http-debian      [x]         openfaas           Python 3 with Flask and HTTP based on Debian
ruby-http                [x]         openfaas           Ruby 2.4 HTTP template
cobol                    [ ]         devries            COBOL Template
crystal                  [ ]         tpei               Crystal template
crystal-http             [ ]         koffeinfrei        Crystal HTTP template
csharp-httprequest       [ ]         distantcam         C# HTTP template
csharp-kestrel           [ ]         burtonr            C# Kestrel HTTP template
lua53                    [ ]         affix              Lua 5.3 Template
perl-alpine              [ ]         tmiklas            Perl language template based on Alpine image
python3-dlrs             [ ]         intel              Deep Learning Reference Stack v0.4 for ML workloads
quarkus-native           [ ]         pmlopes            Quarkus.io native image template
rust                     [ ]         openfaas-incubator Community Rust template
rust-http                [ ]         openfaas-incubator Community Rust template with HTTP bindings
swift                    [ ]         affix              Swift 4.2 Template
vala                     [ ]         affix              Vala Template
vala-http                [ ]         affix              Non-Forking Vala Template
vertx-native             [ ]         pmlopes            Eclipse Vert.x native image template
csharp                   [ ]         openfaas           Classic C# template
go                       [ ]         openfaas           Legacy Golang template
golang-http              [ ]         openfaas           Request/response style HTTP template
java11                   [ ]         openfaas           Java 11 template
node                     [ ]         openfaas           Legacy Node 12 template
node12                   [ ]         openfaas           HTTP-based Node 12 template
node14                   [ ]         openfaas           HTTP-based Node 14 template
node16                   [ ]         openfaas           HTTP-based Node 16 template
node17                   [ ]         openfaas           HTTP-based Node 17 template
php7                     [ ]         openfaas           Classic PHP 7 template
powershell-http-template [ ]         openfaas-incubator Powershell Core HTTP Ubuntu:16.04 template
powershell-template      [ ]         openfaas-incubator Powershell Core Ubuntu:16.04 template
puppeteer-nodelts        [ ]         alexellis          A puppeteer template for headless Chrome
python                   [ ]         openfaas           Classic Python 2.7 template
python27-flask           [ ]         openfaas           Python 2.7 Flask template
python3                  [ ]         openfaas           Classic Python 3 template
python3-debian           [ ]         openfaas           Python 3 Debian template
python3-flask            [ ]         openfaas           Python 3 Flask template
python3-flask-debian     [ ]         openfaas           Python 3 Flask template based on Debian
ruby                     [ ]         openfaas           Classic Ruby 2.5 template
```

获取托管在模板商店中的 OpenFaaS 官方经典模板

```shell
$ faas-cli template pull
Fetch templates from repository: https://github.com/openfaas/templates.git at 
2023/06/05 17:15:07 Attempting to expand templates from https://github.com/openfaas/templates.git
2023/06/05 17:15:09 Fetched 18 template(s) : [csharp dockerfile go java11 java11-vert-x node node12 node12-debian node14 node16 node17 node18 php7 php8 python python3 python3-debian ruby] from https://github.com/openfaas/templates.git
```

获取托管在模板商店中的指定模板

```shell
$ faas-cli template store pull rust
Fetch templates from repository: https://github.com/openfaas-incubator/openfaas-rust-template at 
2023/06/05 17:41:58 Attempting to expand templates from https://github.com/openfaas-incubator/openfaas-rust-template
2023/06/05 17:42:02 Fetched 1 template(s) : [rust] from https://github.com/openfaas-incubator/openfaas-rust-template
```

也可以通过 --url 参数，获取指定来源的模板

```shell
$ faas-cli template store pull --url=https://raw.githubusercontent.com/openfaas/store/master/templates.json
```

获取到的模板文件保存在当前的 template 目录中

```shell
$ ls template/
csharp  dockerfile  go  java11  java11-vert-x  node  node12  node12-debian  node14  node16  node17  node18  php7  php8  python  python3  python3-debian  ruby

$ tree template/golang-middleware/
template/golang-middleware/
├── Dockerfile		# 函数最终会构建成镜像
├── function		# 业务代码，比如实现 HTTP endpoint 处理请求
│   ├── go.mod
│   └── handler.go
├── go.mod
├── go.work
├── main.go			# 函数入口，用于启动 HTTP 服务器，注册 endpoint
└── template.yml	# 模板说明

1 directory, 7 files

$ faas-cli new --list
Languages available as templates:
- csharp
- dockerfile
- go
- java11
- java11-vert-x
- node
- node12
- node12-debian
- node14
- node16
- node17
- node18
- php7
- php8
- python
- python3
- python3-debian
- ruby
```

## 创建函数

### Golang

| 可选模板          | 托管商店                                         | watchdog    | Go 版本 | 基础 OS      | 说明                                 |
| ----------------- | ------------------------------------------------ | ----------- | ------- | ------------ | ------------------------------------ |
| go                | https://github.com/openfaas/templates            | classic     | 1.18    | Alpine Linux | Legacy Golang template               |
| golang-middleware | https://github.com/openfaas/golang-http-template | of-watchdog | 1.19    | Alpine Linux | HTTP middleware interface in Go      |
| golang-http       | https://github.com/openfaas/golang-http-template | of-watchdog | 1.19    | Alpine Linux | Request/response style HTTP template |

使用 golang-middleware 模板创建名为 go-fn 的函数

```shell
$ faas-cli new go-fn --lang golang-middleware
Folder: go-fn created.
  ___                   _____           ____
 / _ \ _ __   ___ _ __ |  ___|_ _  __ _/ ___|
| | | | '_ \ / _ \ '_ \| |_ / _` |/ _` \___ \
| |_| | |_) |  __/ | | |  _| (_| | (_| |___) |
 \___/| .__/ \___|_| |_|_|  \__,_|\__,_|____/
      |_|


Function created in folder: go-fn
Stack file written: go-fn.yml

Notes:
You have created a new function which uses Go 1.19 and Alpine
Linux as its base image.

To disable the go module, for private vendor code, please use
"--build-arg GO111MODULE=off" with faas-cli build or configure this
via your stack.yml file.

See more: https://docs.openfaas.com/cli/templates/

For the template's repo and more examples:
https://github.com/openfaas/golang-http-template
```

函数模板创建后，会在当前目录生成 go-fn 目录，其内容源自于 template/golang-middleware/function 以及 go-fn.yml 文件，用于描述函数构建的具体规格，例如

```yml
version: 1.0
provider:
  name: openfaas
  gateway: http://127.0.0.1:8080
functions:
  go-fn:
    lang: golang-middleware
    handler: ./go-fn
    image: go-fn:latest
```

## 构建函数

`faas-cli build` 构建函数时，默认读取当前目录下的 stack.yml 文件，也可以通过 -f 指定。

```shell
$ faas-cli build -f go-fn.yml

$ docker images | grep go-fn
go-fn     latest     891e42d0a44c     23 minutes ago     21MB
```

构建时使用的 Dockerfile 位于 build/go-fn/Dockerfile（源自 template/golang-middleware/Dockerfile）

```dockerfile
FROM --platform=${TARGETPLATFORM:-linux/amd64} ghcr.io/openfaas/of-watchdog:0.9.11 as watchdog
FROM --platform=${BUILDPLATFORM:-linux/amd64} golang:1.19-alpine as build

ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG TARGETOS
ARG TARGETARCH

RUN apk --no-cache add git

COPY --from=watchdog /fwatchdog /usr/bin/fwatchdog
RUN chmod +x /usr/bin/fwatchdog


RUN mkdir -p /go/src/handler
WORKDIR /go/src/handler
COPY . .

ARG GO111MODULE="on"
ARG GOPROXY=""
ARG GOFLAGS=""
ARG CGO_ENABLED=0
ENV CGO_ENABLED=${CGO_ENABLED}

# Run a gofmt and exclude all vendored code.
RUN test -z "$(gofmt -l $(find . -type f -name '*.go' -not -path "./vendor/*" -not -path "./function/vendor/*"))" || { echo "Run \"gofmt -s -w\" on your Golang code"; exit 1; }

WORKDIR /go/src/handler/function
RUN mkdir -p /go/src/handler/function/static

RUN GOOS=${TARGETOS} GOARCH=${TARGETARCH} go test ./... -cover

WORKDIR /go/src/handler
RUN GOOS=${TARGETOS} GOARCH=${TARGETARCH} \
    go build --ldflags "-s -w" -o handler .

FROM --platform=${TARGETPLATFORM:-linux/amd64} alpine:3.17.2 as ship

# Add non root user and certs
RUN apk --no-cache add ca-certificates \
    && addgroup -S app && adduser -S -g app app

# Split instructions so that buildkit can run & cache
# the previous command ahead of time.
RUN mkdir -p /home/app \
    && chown app /home/app

WORKDIR /home/app

COPY --from=build --chown=app /go/src/handler/handler           .
COPY --from=build --chown=app /usr/bin/fwatchdog                .
COPY --from=build --chown=app /go/src/handler/function/static   static

USER app

ENV fprocess="./handler"
ENV mode="http"
ENV upstream_url="http://127.0.0.1:8082"
ENV prefix_logs="false"

CMD ["./fwatchdog"]
```

此外，构建参数可以通过 stack.yml 文件中的 build_args 选项指定，效果等价于 `faas-cli build --build-arg key1=value1,key2=value2`。最终，build_args 指定的参数会通过 docker build --build-arg 透传给 Dockerfile 中的 ARG。

例如，指定使用本地 vendor 构建 Golang 应用。

```yml
functions:
  with_go_modules:
    handler: ./with_go_modules
    lang: go
    build_args:
      GO111MODULE: off
      GOFLAGS: "-mod=vendor"
```
