<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ğŸ¾Corgi</title>
  
  
  <link href="http://shenxianghong.github.io/atom.xml" rel="self"/>
  
  <link href="http://shenxianghong.github.io/"/>
  <updated>2023-07-10T09:47:30.108Z</updated>
  <id>http://shenxianghong.github.io/</id>
  
  <author>
    <name>Shen Xianghong</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€Œ Kubernetes ã€InPlacePodVerticalScaling ç‰¹æ€§</title>
    <link href="http://shenxianghong.github.io/2023/07/10/2023-07-10%20Kubernetes%20Pod%20%E8%B5%84%E6%BA%90%E7%9A%84%E5%8E%9F%E5%9C%B0%E7%BA%B5%E5%90%91%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E7%89%B9%E6%80%A7/"/>
    <id>http://shenxianghong.github.io/2023/07/10/2023-07-10%20Kubernetes%20Pod%20%E8%B5%84%E6%BA%90%E7%9A%84%E5%8E%9F%E5%9C%B0%E7%BA%B5%E5%90%91%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E7%89%B9%E6%80%A7/</id>
    <published>2023-07-09T16:00:00.000Z</published>
    <updated>2023-07-10T09:47:30.108Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kubernetes/logo.svg"></div><hr><blockquote><p>based on <strong>v1.27.3</strong></p></blockquote><h1 id="InPlacePodVerticalScaling"><a href="#InPlacePodVerticalScaling" class="headerlink" title="InPlacePodVerticalScaling"></a>InPlacePodVerticalScaling</h1><p>åœ¨ Kubernetes v1.27 ä¸­ï¼Œæ·»åŠ äº†ä¸€ä¸ªæ–°çš„ alpha åŠŸèƒ½ â€” InPlacePodVerticalScalingï¼Œå…è®¸ç”¨æˆ·åœ¨ä¸é‡å¯å®¹å™¨çš„æƒ…å†µä¸‹è°ƒæ•´åˆ†é…ç»™ Pod çš„ CPU æˆ–å†…å­˜èµ„æºçš„å¤§å°ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼ŒPod resources å­—æ®µç°åœ¨å…è®¸å¯¹ CPU å’Œå†…å­˜èµ„æºè¿›è¡Œæ›´æ”¹ï¼Œå¯ä»¥é€šè¿‡ patch ä¿®æ”¹æ­£åœ¨è¿è¡Œçš„ Pod spec æ¥å®ç°ã€‚</p><p>è¿™ä¹Ÿæ„å‘³ç€ Pod spec ä¸­ resources å­—æ®µä¸èƒ½å†ä½œä¸º Pod å®é™…èµ„æºçš„æŒ‡æ ‡ã€‚ç›‘æ§å·¥å…·å’Œå…¶ä»–æ­¤ç±»åº”ç”¨ç¨‹åºç°åœ¨å¿…é¡»æŸ¥çœ‹ Pod status ä¸­çš„æ–°å­—æ®µã€‚Kubernetes é€šè¿‡ CRI API è°ƒç”¨è¿è¡Œæ—¶æ¥æŸ¥è¯¢å®é™…çš„ CPU å’Œå†…å­˜çš„ request ä¸ limitï¼Œæ¥è‡ªå®¹å™¨è¿è¡Œæ—¶çš„å“åº”åæ˜ åœ¨ Pod çš„ status ä¸­ã€‚</p><p>å¯¹äºåŸåœ°è°ƒæ•´ Pod èµ„æºè€Œè¨€ï¼š</p><ul><li><p>é’ˆå¯¹ CPU å’Œå†…å­˜èµ„æºçš„å®¹å™¨çš„ requests å’Œ limits æ˜¯å¯å˜æ›´çš„</p></li><li><p>Pod çŠ¶æ€ä¸­ containerStatuses çš„ <code>allocatedResources</code> å­—æ®µåæ˜ äº†åˆ†é…ç»™ Pod å®¹å™¨çš„èµ„æº</p></li><li><p>Pod çŠ¶æ€ä¸­ containerStatuses çš„ resources å­—æ®µåæ˜ äº†å¦‚åŒå®¹å™¨è¿è¡Œæ—¶æ‰€æŠ¥å‘Šçš„ã€é’ˆå¯¹æ­£è¿è¡Œçš„å®¹å™¨é…ç½®çš„å®é™…èµ„æº requests å’Œ limits</p></li><li><p>Pod çŠ¶æ€ä¸­ <code>resize</code> å­—æ®µæ˜¾ç¤ºä¸Šæ¬¡è¯·æ±‚å¾…å¤„ç†çš„è°ƒæ•´çŠ¶æ€ï¼š</p><ul><li><p><code>Proposed</code>ï¼šæ­¤å€¼è¡¨ç¤ºè¯·æ±‚è°ƒæ•´å·²è¢«ç¡®è®¤ï¼Œå¹¶ä¸”è¯·æ±‚å·²è¢«éªŒè¯å’Œè®°å½•</p></li><li><p><code>InProgress</code>ï¼šæ­¤å€¼è¡¨ç¤ºèŠ‚ç‚¹å·²æ¥å—è°ƒæ•´è¯·æ±‚ï¼Œå¹¶æ­£åœ¨å°†å…¶åº”ç”¨äº Pod çš„å®¹å™¨</p></li><li><p><code>Deferred</code>ï¼šæ­¤å€¼æ„å‘³ç€åœ¨æ­¤æ—¶æ— æ³•æ‰¹å‡†è¯·æ±‚çš„è°ƒæ•´ï¼ŒèŠ‚ç‚¹å°†ç»§ç»­é‡è¯•ã€‚ å½“å…¶ä»– Pod é€€å‡ºå¹¶é‡Šæ”¾èŠ‚ç‚¹èµ„æºæ—¶ï¼Œè°ƒæ•´å¯èƒ½ä¼šè¢«çœŸæ­£å®æ–½</p></li><li><p><code>Infeasible</code>ï¼šæ­¤å€¼æ˜¯ä¸€ç§ä¿¡å·ï¼Œè¡¨ç¤ºèŠ‚ç‚¹æ— æ³•æ‰¿æ¥æ‰€è¯·æ±‚çš„è°ƒæ•´å€¼ã€‚ å¦‚æœæ‰€è¯·æ±‚çš„è°ƒæ•´è¶…è¿‡èŠ‚ç‚¹å¯åˆ†é…ç»™ Pod çš„æœ€å¤§èµ„æºï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µ</p></li></ul></li></ul><p><strong>å®¹å™¨è°ƒæ•´ç­–ç•¥</strong></p><p>è°ƒæ•´ç­–ç•¥å…è®¸æ›´ç²¾ç»†åœ°æ§åˆ¶ Pod ä¸­çš„å®¹å™¨å¦‚ä½•é’ˆå¯¹ CPU å’Œå†…å­˜èµ„æºè¿›è¡Œè°ƒæ•´ã€‚ ä¾‹å¦‚ï¼Œå®¹å™¨çš„åº”ç”¨ç¨‹åºå¯ä»¥å¤„ç† CPU èµ„æºçš„è°ƒæ•´è€Œä¸å¿…é‡å¯ï¼Œ ä½†æ˜¯è°ƒæ•´å†…å­˜å¯èƒ½éœ€è¦åº”ç”¨ç¨‹åºé‡å¯ï¼Œå› æ­¤å®¹å™¨ä¹Ÿå¿…é¡»é‡å¯ã€‚</p><p>ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œå®¹å™¨è§„çº¦å…è®¸ç”¨æˆ·æŒ‡å®š <code>resizePolicy</code>ã€‚ é’ˆå¯¹è°ƒæ•´ CPU å’Œå†…å­˜å¯ä»¥è®¾ç½®ä»¥ä¸‹é‡å¯ç­–ç•¥ï¼š</p><ul><li><code>NotRequired</code>ï¼šåœ¨è¿è¡Œæ—¶è°ƒæ•´å®¹å™¨çš„èµ„æºï¼Œé»˜è®¤å€¼<br><em>å¦‚æœ Pod çš„ restartPolicy ä¸º Neverï¼Œåˆ™ Pod ä¸­æ‰€æœ‰å®¹å™¨çš„è°ƒæ•´é‡å¯ç­–ç•¥å¿…é¡»è¢«è®¾ç½®ä¸º NotRequired</em></li><li><code>RestartContainer</code>ï¼šé‡å¯å®¹å™¨å¹¶åœ¨é‡å¯ååº”ç”¨æ–°èµ„æº</li></ul>]]></content>
    
    
    <summary type="html">Kubernetes v1.27 ç‰ˆæœ¬ä¸­çš„ Pod èµ„æºåŸåœ°çºµå‘å¼¹æ€§ä¼¸ç¼©ç‰¹æ€§çš„å®è·µéªŒè¯</summary>
    
    
    
    <category term="Scheduling &amp; Orchestration" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/"/>
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/Kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Containerd ã€NRI æ¥å£è®¾è®¡</title>
    <link href="http://shenxianghong.github.io/2023/07/03/2023-07-03%20Containerd%20NRI%20%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1/"/>
    <id>http://shenxianghong.github.io/2023/07/03/2023-07-03%20Containerd%20NRI%20%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1/</id>
    <published>2023-07-02T16:00:00.000Z</published>
    <updated>2023-07-06T09:32:53.353Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/containerd/logo.svg"></div><hr><blockquote><p>based on <strong>v0.3.0</strong></p></blockquote><h1 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h1><p>NRIï¼ˆNode Resource Interfaceï¼‰æ˜¯ Containerd çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå…è®¸å°†è‡ªå®šä¹‰é€»è¾‘æ’å…¥åˆ° OCI å…¼å®¹çš„è¿è¡Œæ—¶ä¸­ï¼Œä»è€Œå®ç°åœ¨å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„æŸäº›ç‰¹å®šæ—¶é—´ç‚¹å¯¹å®¹å™¨è¿›è¡Œæ›´æ”¹æ“ä½œæˆ–æ‰§è¡Œ OCI è§„èŒƒä¹‹å¤–çš„é¢å¤–æ“ä½œã€‚ä¾‹å¦‚ï¼Œç”¨äºæ”¹è¿›è®¾å¤‡å’Œå…¶ä»–å®¹å™¨èµ„æºçš„åˆ†é…å’Œç®¡ç†ã€‚NRI æœ¬èº«å¯¹ä»»ä½•å®¹å™¨è¿è¡Œæ—¶çš„å†…éƒ¨å®ç°ç»†èŠ‚æ˜¯ä¸æ„ŸçŸ¥çš„ã€‚å®ƒä¸º CRI è¿è¡Œæ—¶æä¾›äº†ä¸€ä¸ªé€‚é…åº“ï¼Œç”¨äºé›†æˆ NRI å’Œæ‰©å±•æ’ä»¶è¿›è¡Œäº¤äº’ã€‚</p><p>NRI æä¾›äº†æ¥å£å®šä¹‰å’ŒåŸºç¡€ç»„ä»¶ï¼Œå¯ä»¥å®ç°å¯æ’æ‹”çš„ CRI è¿è¡Œæ—¶æ’ä»¶ï¼Œè¿™äº›æ’ä»¶å°±æ˜¯ NRI æ’ä»¶ã€‚è¿™äº› NRI æ’ä»¶æ˜¯ä¸è¿è¡Œæ—¶ç±»å‹æ— å…³çš„ï¼Œæ’ä»¶æ—¢å¯ä»¥åº”ç”¨äº Containerdï¼Œä¹Ÿå¯ä»¥åº”ç”¨äº CRI-Oã€‚åŸåˆ™ä¸Šï¼Œä»»ä½• NRI æ’ä»¶éƒ½åº”è¯¥èƒ½å¤Ÿå’Œå¯ç”¨ NRI çš„è¿è¡Œæ—¶æ­£å¸¸åä½œã€‚</p><p>NRI æ’ä»¶æ˜¯ä¸€ä¸ªç±»ä¼¼å®ˆæŠ¤è¿›ç¨‹çš„å®ä¾‹ã€‚æ’ä»¶çš„å•ä¸ªå®ä¾‹ä¼šå¤„ç† NRI æ‰€æœ‰çš„äº‹ä»¶å’Œè¯·æ±‚ï¼Œä½¿ç”¨ socket æ¥è¿›è¡Œæ•°æ®ä¼ è¾“å’Œé€šä¿¡ï¼ŒNRI å®šä¹‰äº†ä¸€å¥—åŸºäº protobuf çš„åè®®ï¼šNRI plugin protocalï¼Œå¹¶é€šè¿‡ ttRPC è¿›è¡Œå®ç°ã€‚è¿™æ ·å¯ä»¥é€šè¿‡é™ä½æ¯æ¡ä¿¡æ¯çš„å¼€é”€æé«˜é€šä¿¡æ•ˆç‡ï¼Œå¹¶ä¸”å¯ä»¥å®ç°æœ‰çŠ¶æ€çš„ NRI æ’ä»¶ã€‚</p><h1 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h1><p>NRI å®ç°åŒ…å«äº†ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š<a href="https://github.com/containerd/nri/tree/main/pkg/api">NRI åè®®</a>å’Œ <a href="https://github.com/containerd/nri/tree/main/pkg/adaptation">NRI è¿è¡Œæ—¶é€‚é…å™¨</a>ã€‚</p><p>è¿™äº›ç»„ä»¶ä¸€èµ·å»ºç«‹äº†è¿è¡Œæ—¶å¦‚ä½•ä¸ NRI äº¤äº’ä»¥åŠæ’ä»¶å¦‚ä½•é€šè¿‡ NRI ä¸è¿è¡Œæ—¶ä¸­çš„å®¹å™¨äº¤äº’çš„æ¨¡å‹ã€‚å®ƒä»¬è¿˜å®šä¹‰äº†æ’ä»¶å¯ä»¥åœ¨å“ªäº›æ¡ä»¶ä¸‹å¯¹å®¹å™¨è¿›è¡Œæ›´æ”¹ä»¥åŠè¿™äº›æ›´æ”¹çš„ç¨‹åº¦ã€‚</p><p>å…¶ä½™çš„ç»„ä»¶æ˜¯ <a href="https://github.com/containerd/nri/tree/main/pkg/stub">NRI æ’ä»¶ stub åº“</a>å’Œä¸€äº› <a href="https://github.com/containerd/nri/tree/main/plugins">NRI ç¤ºä¾‹æ’ä»¶</a>ã€‚å…¶ä¸­ï¼Œä¸€äº›æ’ä»¶åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­å®ç°äº†æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå¦å¤–ä¸€äº›æ’ä»¶åˆ™ç”¨äºè°ƒè¯•ã€‚æ‰€æœ‰ç¤ºä¾‹æ’ä»¶éƒ½å¯ä»¥ä½œä¸ºå¦‚ä½•ä½¿ç”¨ stub åº“å®ç° NRI æ’ä»¶çš„ç¤ºä¾‹ã€‚</p><h2 id="API-åè®®"><a href="#API-åè®®" class="headerlink" title="API åè®®"></a>API åè®®</h2><p>NRI API åè®®ä¸­å®šä¹‰äº†ä¸¤ä¸ªæœåŠ¡ï¼šruntime å’Œ plugin</p><ul><li><p>runtime æœåŠ¡æ˜¯è¿è¡Œæ—¶å‘ NRI æ’ä»¶æš´æ¼çš„æ¥å£ã€‚åœ¨æ­¤æ¥å£ä¸Šçš„æ‰€æœ‰è¯·æ±‚éƒ½ç”±æ’ä»¶å‘èµ·ã€‚è¯¥æ¥å£æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><p>å¯åŠ¨æ’ä»¶æ³¨å†Œ</p></li><li><p>è¯·æ±‚å¯¹å®¹å™¨çš„æ›´æ–°</p></li></ul></li><li><p>plugin æœåŠ¡æ˜¯ NRI ç”¨äºä¸æ’ä»¶äº¤äº’çš„å…¬å…±æ¥å£ã€‚åœ¨æ­¤æ¥å£ä¸Šçš„æ‰€æœ‰è¯·æ±‚éƒ½ç”± NRI æˆ–è¿è¡Œæ—¶å‘èµ·ã€‚è¯¥æ¥å£æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p><ul><li><p>é…ç½®æ’ä»¶</p></li><li><p>è·å–å·²å­˜åœ¨çš„ Pod å’Œå®¹å™¨çš„åˆå§‹åˆ—è¡¨</p></li><li><p>å°†æ’ä»¶ hook åˆ° Pod&#x2F;container çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸­</p></li><li><p>å…³é—­æ’ä»¶</p></li></ul></li></ul><p>æ’ä»¶éœ€è¦å‘ NRI æ³¨å†Œï¼Œç”¨äºæ¥æ”¶å’Œå¤„ç†å®¹å™¨äº‹ä»¶ã€‚åœ¨æ³¨å†Œè¿‡ç¨‹ä¸­ï¼Œæ’ä»¶å’Œ NRI æ‰§è¡Œä»¥ä¸‹æ­¥éª¤çš„é¡ºåºï¼š</p><ul><li>æ’ä»¶æ³¨å†Œè‡³è¿è¡Œæ—¶</li><li>NRI å‘æ’ä»¶ä¸‹å‘ç‰¹å®šçš„é…ç½®æ•°æ®</li><li>æ’ä»¶è®¢é˜… Pod å’Œå®¹å™¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</li><li>NRI å‘æ’ä»¶å‘é€å·²å­˜åœ¨çš„ Pod å’Œå®¹å™¨åˆ—è¡¨</li><li>æ’ä»¶è¯·æ±‚å¯¹ç°æœ‰å®¹å™¨çš„æ›´æ–°</li></ul><p>é€šè¿‡æ’ä»¶åç§°å’Œæ’ä»¶ç´¢å¼•å‘ NRI æ³¨å†Œæ’ä»¶ã€‚NRI é€šè¿‡æ’ä»¶ç´¢å¼•æ¥ç¡®å®šæ‰€æœ‰æ’ä»¶åœ¨ hook Pod å’Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„å¤„ç†é¡ºåºã€‚</p><p>NRI æ’ä»¶åç§°ç”¨äº NRI æœåŠ¡ä»é»˜è®¤æ’ä»¶é…ç½®è·¯å¾„ <code>/etc/nri/conf.d</code> ä¸­é€‰æ‹©å¯¹åº”æ’ä»¶çš„é…ç½®æ–‡ä»¶å‘é€ç»™ NRI æ’ä»¶ã€‚åªæœ‰å½“å¯¹åº”çš„ NRI æ’ä»¶è¢« NRI æœåŠ¡å†…éƒ¨è°ƒç”¨æ—¶ï¼Œæ‰ä¼šè¯»å–å¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚å¦‚æœ NRI æ’ä»¶æ˜¯ä»å¤–éƒ¨å¯åŠ¨çš„ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è·å–é…ç½®ã€‚NRI æ’ä»¶å¯ä»¥æ ¹æ®éœ€è¦è®¢é˜… Pod å’Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶ä¸”è¿”å›ä¿®æ”¹åçš„é…ç½®ã€‚NRI æ’ä»¶å¦‚æœé‡‡ç”¨é¢„æ³¨å†Œçš„æ–¹å¼è¿è¡Œæ—¶ï¼Œéœ€è¦å°†å¯æ‰§è¡Œæ–‡ä»¶çš„å‘½åè§„åˆ™éœ€è¦ç¬¦åˆ <code>xx-plugin_name</code>ï¼Œä¾‹å¦‚ 01-loggerã€‚å…¶ä¸­ xx å¿…é¡»ä¸ºä¸¤ä½æ•°å­—ï¼Œä½œä¸º NRI æ’ä»¶çš„ç´¢å¼•ï¼Œå†³å®šäº†æ’ä»¶çš„çš„æ‰§è¡Œé¡ºåºã€‚</p><p>åœ¨æ³¨å†Œå’Œæ¡æ‰‹çš„æœ€åä¸€æ­¥ï¼ŒNRI å‘é€ CRI è¿è¡Œæ—¶å·²çŸ¥çš„æ‰€æœ‰çš„ Podå’Œå®¹å™¨çš„ä¿¡æ¯ã€‚æ­¤æ—¶æ’ä»¶å¯ä»¥å¯¹ä»»ä½•å·²ç»å­˜åœ¨çš„ Pod å’Œå®¹å™¨è¿›è¡Œæ›´æ–°ã€‚ä¸€æ—¦æ¡æ‰‹ç»“æŸï¼Œå¹¶ä¸” NRI æ’ä»¶æˆåŠŸå‘ NRI æœåŠ¡æ³¨å†Œä¹‹åï¼Œå®ƒå°†å¼€å§‹æ ¹æ®è‡ªå·±çš„è®¢é˜…æ¥æ”¶ Pod å’Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚</p><h2 id="è¿è¡Œæ—¶é€‚é…å™¨"><a href="#è¿è¡Œæ—¶é€‚é…å™¨" class="headerlink" title="è¿è¡Œæ—¶é€‚é…å™¨"></a>è¿è¡Œæ—¶é€‚é…å™¨</h2><p>NRI è¿è¡Œæ—¶é€‚é…åŒ…æ˜¯ç”¨äºé›†æˆåˆ° NRI å¹¶ä¸ NRI æ’ä»¶äº¤äº’çš„æ¥å£è¿è¡Œæ—¶ã€‚å®ƒå®ç°äº†æ’ä»¶å‘ç°ï¼Œå¯åŠ¨å’Œé…ç½®ã€‚å®ƒè¿˜æä¾›äº†å°† NRI æ’ä»¶æ’å…¥åˆ° CRI è¿è¡Œæ—¶çš„ Pod å’Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸­çš„å¿…è¦åŠŸèƒ½ã€‚</p><p>è¿è¡Œæ—¶é€‚é…å™¨å®ç°äº†å¤šä¸ª NRI æ’ä»¶å¯èƒ½åœ¨å¤„ç†åŒä¸€ä¸ª Pod æˆ–è€…å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚å®ƒè´Ÿè´£æŒ‰ç…§ç´¢å¼•é¡ºåºä¾æ¬¡è°ƒç”¨æ’ä»¶ï¼Œå¹¶æŠŠæ’ä»¶çš„ä¿®æ”¹å†…å®¹åˆå¹¶åè¿”å›ã€‚åœ¨åˆå¹¶æ’ä»¶ä¿®æ”¹çš„ OCI spec æ—¶ï¼Œå½“æ£€æµ‹åˆ°åˆ°å¤šä¸ª NRI æ’ä»¶å¯¹åŒä¸€ä¸ªå®¹å™¨äº§ç”Ÿäº†å†²çªçš„ä¿®æ”¹ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p><h2 id="å…¶ä»–ç»„ä»¶"><a href="#å…¶ä»–ç»„ä»¶" class="headerlink" title="å…¶ä»–ç»„ä»¶"></a>å…¶ä»–ç»„ä»¶</h2><p>NRI è¿˜åŒ…å«ä¸€ä¸ª NRI æ’ä»¶ stub åº“ï¼Œä¸º NRI æ’ä»¶çš„å®ç°æä¾›äº†ä¸€ä¸ªç®€æ´æ˜“ç”¨çš„æ¡†æ¶ã€‚stub åº“å±è”½äº† NRI æ’ä»¶çš„åº•å±‚å®ç°ç»†èŠ‚ï¼Œå®ƒè´Ÿè´£è¿æ¥å»ºç«‹ã€æ’ä»¶æ³¨å†Œã€é…ç½®å’Œäº‹ä»¶è®¢é˜…ã€‚</p><p>åŒæ—¶ NRI ä¹Ÿæä¾›äº†ä¸€äº› NRI æ’ä»¶çš„ç¤ºä¾‹ï¼Œè¿™äº›ç¤ºä¾‹éƒ½æ˜¯ç»“åˆå®é™…ä½¿ç”¨åœºæ™¯åˆ›å»ºçš„ï¼Œå…¶ä¸­ä¸€äº›ç¤ºä¾‹éå¸¸é€‚åˆè°ƒè¯•åœºæ™¯ã€‚ç›®å‰ï¼ŒNRI æä¾›çš„æ‰€æœ‰ç¤ºä¾‹æ’ä»¶éƒ½åŸºäº stub åº“å®ç°çš„ã€‚è¿™äº›ç¤ºä¾‹æ’ä»¶çš„å®ç°éƒ½å¯ä»¥ç”¨ä½œå­¦ä¹ ä½¿ç”¨ stub åº“çš„æ•™ç¨‹ã€‚</p><p>å¦å¤–ï¼ŒNRI è¿˜åŒ…å«ä¸€ä¸ª OCI è§„èŒƒç”Ÿæˆå™¨ä¸»è¦ç”¨äº NRI æ’ä»¶ç”¨æ¥è°ƒæ•´å’Œæ›´æ–° OCI specï¼Œç„¶åæ›´æ–°åˆ°å®¹å™¨ã€‚</p><h1 id="å¯è®¢é˜…äº‹ä»¶"><a href="#å¯è®¢é˜…äº‹ä»¶" class="headerlink" title="å¯è®¢é˜…äº‹ä»¶"></a>å¯è®¢é˜…äº‹ä»¶</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handlers for NRI plugin event and request.</span></span><br><span class="line"><span class="keyword">type</span> handlers <span class="keyword">struct</span> &#123;</span><br><span class="line">Configure           <span class="function"><span class="keyword">func</span><span class="params">(context.Context, <span class="type">string</span>, <span class="type">string</span>, <span class="type">string</span>)</span></span> (api.EventMask, <span class="type">error</span>)</span><br><span class="line">Synchronize         <span class="function"><span class="keyword">func</span><span class="params">(context.Context, []*api.PodSandbox, []*api.Container)</span></span> ([]*api.ContainerUpdate, <span class="type">error</span>)</span><br><span class="line">Shutdown            <span class="function"><span class="keyword">func</span><span class="params">(context.Context)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Pod äº‹ä»¶</span></span><br><span class="line">RunPodSandbox       <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox)</span></span> <span class="type">error</span></span><br><span class="line">StopPodSandbox      <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox)</span></span> <span class="type">error</span></span><br><span class="line">RemovePodSandbox    <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox)</span></span> <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨äº‹ä»¶</span></span><br><span class="line">CreateContainer     <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox, *api.Container)</span></span> (*api.ContainerAdjustment, []*api.ContainerUpdate, <span class="type">error</span>)</span><br><span class="line">StartContainer      <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox, *api.Container)</span></span> <span class="type">error</span></span><br><span class="line">UpdateContainer     <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox, *api.Container, *api.LinuxResources)</span></span> ([]*api.ContainerUpdate, <span class="type">error</span>)</span><br><span class="line">StopContainer       <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox, *api.Container)</span></span> ([]*api.ContainerUpdate, <span class="type">error</span>)</span><br><span class="line">RemoveContainer     <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox, *api.Container)</span></span> <span class="type">error</span></span><br><span class="line">PostCreateContainer <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox, *api.Container)</span></span> <span class="type">error</span></span><br><span class="line">PostStartContainer  <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox, *api.Container)</span></span> <span class="type">error</span></span><br><span class="line">PostUpdateContainer <span class="function"><span class="keyword">func</span><span class="params">(context.Context, *api.PodSandbox, *api.Container)</span></span> <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨äº‹ä»¶ä¸­å¯ä»¥è·å¾—çš„ Pod å…ƒä¿¡æ¯ï¼š</p><ul><li>ID</li><li>name</li><li>UID</li><li>namespace</li><li>labels</li><li>annotations</li><li>cgroup parent directory</li><li>runtime handler name</li></ul><p>åœ¨äº‹ä»¶ä¸­å¯ä»¥è·å¾—çš„å®¹å™¨å…ƒæ•°æ®ï¼š</p><ul><li>ID</li><li>pod ID</li><li>name</li><li>state</li><li>labels</li><li>annotations</li><li>command line arguments</li><li>environment variables</li><li>mounts</li><li>OCI hooks</li><li>linux<ul><li>namespace IDs</li><li>devices</li><li>resources<ul><li>memory<ul><li>limit</li><li>reservation</li><li>swap limit</li><li>kernel limit</li><li>kernel TCP limit</li><li>swappiness</li><li>OOM disabled flag</li><li>hierarchical accounting flag</li><li>hugepage limits</li></ul></li><li>CPU<ul><li>shares</li><li>quota</li><li>period</li><li>realtime runtime</li><li>realtime period</li><li>cpuset CPUs</li><li>cpuset memory</li></ul></li><li>Block I&#x2F;O class</li><li>RDT class</li></ul></li></ul></li></ul><p><strong>å®¹å™¨è°ƒæ•´</strong></p><p>åœ¨å®¹å™¨åˆ›å»ºè¿‡ç¨‹ä¸­å¯ä»¥è°ƒæ•´å®¹å™¨çš„å‚æ•°ï¼Œåœ¨å®¹å™¨åˆ›å»ºåï¼Œä»»ä½•ç”Ÿå‘½å‘¨æœŸäº‹ä»¶éƒ½å¯ä»¥æ›´æ–°å®¹å™¨çš„å‚æ•°ï¼Œä½†æ˜¯è°ƒæ•´å‚æ•°å’Œæ›´æ–°å‚æ•°çš„èŒƒå›´æ˜¯ä¸åŒçš„ï¼Œå®¹å™¨åˆ›å»ºæ—¶æ”¯æŒæ›´å¤šçš„å‚æ•°è®¾ç½®ï¼Œå®¹å™¨åˆ›å»ºå®Œæˆåï¼Œåªæœ‰éƒ¨åˆ†å‚æ•°å¯ä»¥ä¿®æ”¹ã€‚å…¶ä¸­ IDã€pod IDã€nameã€stateã€labelsã€command line argumentsã€OCI hooks å’Œ linux.namespace IDs ä¿¡æ¯ä¸å¯ä¿®æ”¹ã€‚</p><p><strong>å®¹å™¨æ›´æ–°</strong></p><p>å®¹å™¨åˆ›å»ºå®Œæˆåï¼ŒNRI æ’ä»¶å¯ä»¥å¯¹å®¹å™¨è¿›è¡Œæ›´æ–°ã€‚è¿™ä¸ªæ›´æ–°æ“ä½œä¹Ÿå¯ä»¥ç”±å…¶ä»–ä»»ä½•å®¹å™¨åˆ›å»ºã€æ›´æ–°æˆ–è€…åœæ­¢çš„äº‹ä»¶è§¦å‘ï¼Œæˆ–è€…å¯ä»¥ä¸»åŠ¨æ›´æ–°å®¹å™¨å‚æ•°ã€‚æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥æ”¹çš„å®¹å™¨çš„å‚æ•°è¦å°‘äºåˆ›å»ºæ—¶å¯ä¿®æ”¹çš„å‚æ•°ï¼Œå…¶ä¸­ä»… linux.resources ä¿¡æ¯å¯ä¿®æ”¹ã€‚</p><h1 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h1><p>ä»å®‰å…¨è§’åº¦æ¥çœ‹ï¼Œåº”è¯¥å°† NRI æ’ä»¶è§†ä¸ºå®¹å™¨è¿è¡Œæ—¶çš„ä¸€éƒ¨åˆ†ã€‚NRI æ²¡æœ‰å®ç°å¯¹å…¶æä¾›çš„åŠŸèƒ½çš„ç»†ç²’åº¦è®¿é—®æ§åˆ¶ã€‚è®¿é—® NRI æ˜¯é€šè¿‡é™åˆ¶å¯¹ç³»ç»ŸèŒƒå›´çš„ NRI socket çš„è®¿é—®æ¥æ§åˆ¶çš„ã€‚å¦‚æœè¿›ç¨‹å¯ä»¥è¿æ¥åˆ° NRI socket å¹¶å‘é€æ•°æ®ï¼Œåˆ™å¯ä»¥è®¿é—®é€šè¿‡ NRI å¯ç”¨çš„å®Œæ•´åŠŸèƒ½èŒƒå›´ã€‚</p><p>ç‰¹åˆ«æ˜¯åŒ…æ‹¬ï¼š</p><ul><li>æ³¨å…¥OCI hookï¼Œå…è®¸ä»¥ä¸å®¹å™¨è¿è¡Œæ—¶ç›¸åŒçš„ç‰¹æƒçº§åˆ«æ‰§è¡Œä»»æ„è¿›ç¨‹</li><li>å¯¹æŒ‚è½½ç‚¹è¿›è¡Œä»»æ„æ›´æ”¹ï¼ŒåŒ…æ‹¬æ–°çš„ç»‘å®šæŒ‚è½½ç‚¹ã€æ›´æ”¹ procã€sysã€mqueueã€shm å’Œ tmpfs æŒ‚è½½ç‚¹</li><li>æ·»åŠ æˆ–åˆ é™¤ä»»æ„è®¾å¤‡</li><li>å¯¹å¯ç”¨å†…å­˜ã€CPUã€block I&#x2F;O å’Œ RDT èµ„æºçš„é™åˆ¶è¿›è¡Œä»»æ„æ›´æ”¹ï¼ŒåŒ…æ‹¬é€šè¿‡è®¾ç½®éå¸¸ä½çš„é™åˆ¶æ¥æ‹’ç»æœåŠ¡</li></ul><p>ä¿æŠ¤ NRI socket çš„æ³¨æ„äº‹é¡¹å’ŒåŸåˆ™ä¸ä¿æŠ¤è¿è¡Œæ—¶æœ¬èº«çš„ socket ç›¸åŒã€‚é™¤éå®ƒå·²ç»å­˜åœ¨ï¼Œå¦åˆ™ NRI æœ¬èº«ä¼šåˆ›å»ºç›®å½•æ¥ä¿å­˜å…¶ socketï¼Œè¯¥ç›®å½•å…·æœ‰ä»…å…è®¸è¿è¡Œæ—¶è¿›ç¨‹çš„ç”¨æˆ· ID è®¿é—®çš„æƒé™ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™é™åˆ¶ NRI è®¿é—®ä»¥ root UID 0 èº«ä»½è¿è¡Œçš„è¿›ç¨‹ã€‚å¼ºçƒˆå»ºè®®ä¸è¦æ›´æ”¹é»˜è®¤ socket æƒé™ã€‚å¦‚æœæ²¡æœ‰å¯¹å®¹å™¨å®‰å…¨çš„å…¨éƒ¨å½±å“å’Œæ½œåœ¨åæœçš„å……åˆ†ç†è§£ï¼Œå°±æ°¸è¿œä¸åº”è¯¥å¯¹ NRI å¯ç”¨æ›´å®½æ¾çš„è®¿é—®æ§åˆ¶ã€‚</p><p>å½“è¿è¡Œæ—¶ç®¡ç† Kubernetes é›†ç¾¤ä¸­çš„ Pod å’Œå®¹å™¨æ—¶ï¼Œä½¿ç”¨ Kubernetes DaemonSets å¯ä»¥æ–¹ä¾¿åœ°éƒ¨ç½²å’Œç®¡ç† NRI æ’ä»¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿™éœ€è¦å°† NRI socket æŒ‚è½½åˆ°è¿è¡Œæ’ä»¶çš„ç‰¹æƒå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚å¯¹äºä¿æŠ¤ NRI socket å’Œ NRI æ’ä»¶ï¼Œåº”é‡‡å–ä¸ Kubelet Device Manager socket å’Œ Kubernetes device-plugin ç±»ä¼¼çš„æ‰‹æ®µã€‚</p><p>é›†ç¾¤é…ç½®åº”ç¡®ä¿æœªç»æˆæƒçš„ç”¨æˆ·æ— æ³•æŒ‚è½½ host ç›®å½•å¹¶åˆ›å»ºç‰¹æƒå®¹å™¨æ¥è®¿é—®è¿™äº› socket å¹¶å……å½“ NRI æˆ– device-pluginã€‚</p><h1 id="ä¸è¿è¡Œæ—¶é›†æˆ"><a href="#ä¸è¿è¡Œæ—¶é›†æˆ" class="headerlink" title="ä¸è¿è¡Œæ—¶é›†æˆ"></a>ä¸è¿è¡Œæ—¶é›†æˆ</h1><h2 id="Containerd"><a href="#Containerd" class="headerlink" title="Containerd"></a>Containerd</h2><div align=center><img width="700" style="border: 0px" src="/gallery/containerd/nri-integration.png"></div><p>Containerd åœ¨ v1.7.0 ç‰ˆæœ¬ä¸­æ–°å¢å¯¹ NRI ç‰¹æ€§çš„æ”¯æŒï¼Œé€šè¿‡åœ¨ Containerd é…ç½®æ–‡ä»¶çš„ <code>[plugins.&quot;io.containerd.nri.v1.nri&quot;]</code> éƒ¨åˆ†ä¸­é…ç½®ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[plugins.&quot;io.containerd.nri.v1.nri&quot;]</span></span><br><span class="line">  <span class="comment"># Enable NRI support in containerd.</span></span><br><span class="line">  <span class="attr">disable</span> = <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Allow connections from externally launched NRI plugins.</span></span><br><span class="line">  <span class="attr">disable_connections</span> = <span class="literal">false</span></span><br><span class="line">  <span class="comment"># plugin_config_path is the directory to search for plugin-specific configuration.</span></span><br><span class="line">  <span class="attr">plugin_config_path</span> = <span class="string">&quot;/etc/nri/conf.d&quot;</span></span><br><span class="line">  <span class="comment"># plugin_path is the directory to search for plugins to launch on startup.</span></span><br><span class="line">  <span class="attr">plugin_path</span> = <span class="string">&quot;/opt/nri/plugins&quot;</span></span><br><span class="line">  <span class="comment"># plugin_registration_timeout is the timeout for a plugin to register after connection.</span></span><br><span class="line">  <span class="attr">plugin_registration_timeout</span> = <span class="string">&quot;5s&quot;</span></span><br><span class="line">  <span class="comment"># plugin_requst_timeout is the timeout for a plugin to handle an event/request.</span></span><br><span class="line">  <span class="attr">plugin_request_timeout</span> = <span class="string">&quot;2s&quot;</span></span><br><span class="line">  <span class="comment"># socket_path is the path of the NRI socket to create for plugins to connect to.</span></span><br><span class="line">  <span class="attr">socket_path</span> = <span class="string">&quot;/var/run/nri/nri.sock&quot;</span></span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å¯åŠ¨ NRI æ’ä»¶ï¼š</p><ul><li><p>é¢„æ³¨å†Œï¼ˆpre-connectedï¼‰ï¼šå½“ NRI é€‚é…å™¨å®ä¾‹åŒ–æ—¶ï¼ŒNRI æ’ä»¶å°±ä¼šè‡ªåŠ¨å¯åŠ¨ã€‚é¢„æ³¨å†Œå°±æ˜¯å°† NRI çš„å¯æ‰§è¡Œæ–‡ä»¶æ”¾ç½®åˆ° NRI æ’ä»¶çš„æŒ‡å®šè·¯å¾„ä¸­ï¼Œé»˜è®¤è·¯å¾„é€šè¿‡ plugin_path æŒ‡å®šï¼Œå½“ Containerd å¯åŠ¨æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨åŠ è½½å¹¶è¿è¡Œåœ¨è¯¥è·¯å¾„ä¸‹æ³¨å†Œçš„ NRI æ’ä»¶</p></li><li><p>å¤–éƒ¨è¿è¡Œï¼ˆexternalï¼‰ï¼šNRI æ’ä»¶è¿›ç¨‹å¯ä»¥ç”± systemd åˆ›å»ºï¼Œæˆ–è€…è¿è¡Œåœ¨ Pod ä¸­ã€‚åªè¦ä¿è¯ NRI æ’ä»¶å¯ä»¥é€šè¿‡ NRI socket å’Œ Containerd è¿›è¡Œé€šä¿¡å³å¯ï¼Œé»˜è®¤çš„ NRI socket å­˜å‚¨è·¯å¾„é€šè¿‡ socket_path æŒ‡å®š</p></li></ul><p>é¢„æ³¨å†Œçš„æ’ä»¶æ˜¯é€šè¿‡ä¸€ä¸ªé¢„å…ˆè¿æ¥åˆ° NRI çš„ socket å¯åŠ¨ï¼Œå¤–éƒ¨è¿è¡Œçš„æ’ä»¶é€šè¿‡ NRI socket å‘ NRI é€‚é…å™¨æ³¨å†Œè‡ªå·±ã€‚é¢„æ³¨å†Œæ’ä»¶å’Œå¤–éƒ¨å¯åŠ¨æ’ä»¶ï¼Œè¿™ä¸¤ç§è¿è¡Œæ–¹å¼å”¯ä¸€çš„ä¸åŒç‚¹å°±æ˜¯å¦‚ä½•å¯åŠ¨ä»¥åŠå¦‚ä½•è¿æ¥åˆ° NRIã€‚ä¸€æ—¦å»ºç«‹äº†è¿æ¥ï¼Œæ‰€æœ‰çš„ NRI æ’ä»¶éƒ½æ˜¯ç›¸åŒçš„ã€‚</p><p>NRI å¯ä»¥é€šè¿‡ disable_connections é€‰é¡¹ç¦ç”¨å¤–éƒ¨è¿è¡Œæ’ä»¶çš„è¿æ¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ NRI socket å°†ä¸ä¼šè¢«åˆ›å»ºã€‚</p><h1 id="ç®€å•ç¤ºä¾‹"><a href="#ç®€å•ç¤ºä¾‹" class="headerlink" title="ç®€å•ç¤ºä¾‹"></a>ç®€å•ç¤ºä¾‹</h1><p><em>ä»¥ <a href="https://github.com/containerd/nri/tree/main/plugins/logger">NRI logger</a> æ’ä»¶ä¸ºä¾‹ã€‚</em></p><p><strong>æ’ä»¶ç¼–è¯‘</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/containerd/nri.git</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> plugins/logger/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‘½åæ ¼å¼å¿…é¡»ä¸ºâ€œç´¢å¼•-åç§°â€ï¼Œå…¶ä¸­ç´¢å¼•å¿…é¡»ä¸º 2 ä½æ•°å­—ï¼Œå¦åˆ™æ— æ³•é€šè¿‡æ ¡éªŒ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">FATAL  [0000] failed to create plugin stub: invalid plugin index <span class="string">&quot;nri&quot;</span>, must be 2 digits</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">go build -o 01-logger nri-logger</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cp</span> 01-logger /opt/nri/plugins/00-logger</span></span><br></pre></td></tr></table></figure><p>logger æ’ä»¶é€»è¾‘å°±æ˜¯åœ¨å„ä¸ª Pod å’Œå®¹å™¨ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹æ ¼å¼åŒ–è¾“å‡ºå…ƒæ•°æ®ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œ CreateContainer é˜¶æ®µä¸­ä¼šè®¾ç½®ç¯å¢ƒå˜é‡å’Œæ³¨è§£ç­‰ä¿¡æ¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *plugin)</span></span> CreateContainer(_ context.Context, pod *api.PodSandbox, container *api.Container) (*api.ContainerAdjustment, []*api.ContainerUpdate, <span class="type">error</span>) &#123;</span><br><span class="line">dump(<span class="string">&quot;CreateContainer&quot;</span>, <span class="string">&quot;pod&quot;</span>, pod, <span class="string">&quot;container&quot;</span>, container)</span><br><span class="line"></span><br><span class="line">adjust := &amp;api.ContainerAdjustment&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> cfg.AddAnnotation != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">adjust.AddAnnotation(cfg.AddAnnotation, fmt.Sprintf(<span class="string">&quot;logger-pid-%d&quot;</span>, os.Getpid()))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> cfg.SetAnnotation != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">adjust.RemoveAnnotation(cfg.SetAnnotation)</span><br><span class="line">adjust.AddAnnotation(cfg.SetAnnotation, fmt.Sprintf(<span class="string">&quot;logger-pid-%d&quot;</span>, os.Getpid()))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> cfg.AddEnv != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">adjust.AddEnv(cfg.AddEnv, fmt.Sprintf(<span class="string">&quot;logger-pid-%d&quot;</span>, os.Getpid()))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> cfg.SetEnv != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">adjust.RemoveEnv(cfg.SetEnv)</span><br><span class="line">adjust.AddEnv(cfg.SetEnv, fmt.Sprintf(<span class="string">&quot;logger-pid-%d&quot;</span>, os.Getpid()))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> adjust, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é…ç½®å¯åŠ¨</strong></p><p>è¿™é‡Œé‡‡ç”¨å¤–éƒ¨å¯åŠ¨ï¼ˆ00-loggerï¼‰å’Œé¢„å…ˆé…ç½®ï¼ˆ01-loggerï¼‰ä¸¤ç§å¯åŠ¨æ–¹å¼</p><ul><li>00-loggerï¼šè®¾ç½®ç¯å¢ƒå˜é‡ logger-env ä¸æ³¨è§£ logger-annotationï¼Œå€¼ä¸º logger-pid-&lt;PID&gt;</li><li>01-loggerï¼šè®¾ç½®ç¯å¢ƒå˜é‡ logger-envï¼Œå€¼ä¸º logger-pid-&lt;PID&gt;</li></ul><p>é‡å¯ Containerd å‘ç°é¢„å…ˆé…ç½®çš„ 01-logger æ’ä»¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xeu containerd</span></span><br><span class="line">Jul 05 17:35:43 wnx containerd[84985]: time=&quot;2023-07-05T17:35:43.730685674+08:00&quot; level=info msg=&quot;using experimental NRI integration - disable nri plugin to prevent this&quot;</span><br><span class="line">...</span><br><span class="line">Jul 05 17:35:44 wnx containerd[84985]: time=&quot;2023-07-05T17:35:44.019786972+08:00&quot; level=info msg=&quot;starting plugins...&quot;</span><br><span class="line">Jul 05 17:35:44 wnx containerd[84985]: time=&quot;2023-07-05T17:35:44.019915270+08:00&quot; level=info msg=&quot;discovered plugin 01-logger&quot;</span><br><span class="line">Jul 05 17:35:44 wnx containerd[84985]: time=&quot;2023-07-05T17:35:44.019929420+08:00&quot; level=info msg=&quot;starting plugin \&quot;logger\&quot;...&quot;</span><br><span class="line">Jul 05 17:35:44 wnx containerd[84985]: time=&quot;2023-07-05T17:35:44.049078817+08:00&quot; level=info msg=&quot;plugin \&quot;pre-connected:01-logger[84985]\&quot; registered as \&quot;01-logger\&quot;&quot;</span><br><span class="line">Jul 05 17:35:44 wnx containerd[84985]: time=&quot;2023-07-05T17:35:44.050249456+08:00&quot; level=info msg=&quot;plugin invocation order&quot;</span><br><span class="line">Jul 05 17:35:44 wnx containerd[84985]: time=&quot;2023-07-05T17:35:44.050284541+08:00&quot; level=info msg=&quot;  #1: \&quot;01-logger\&quot; (pre-connected:01-logger[84985])&quot;</span><br><span class="line">Jul 05 17:35:44 wnx containerd[84985]: time=&quot;2023-07-05T17:35:44.050528623+08:00&quot; level=info msg=&quot;containerd successfully booted in 1.616308s&quot;</span><br></pre></td></tr></table></figure><p>00-logger æ’ä»¶æ³¨å†Œåï¼Œè®¢é˜…äº†æ‰€æœ‰çš„ Pod å’Œå®¹å™¨äº‹ä»¶ï¼›æ’ä»¶å¯åŠ¨åï¼Œå³æ”¶åˆ°äº†è¿è¡Œæ—¶æ‰€æœ‰çš„ Pod å’Œå®¹å™¨ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./00-logger --set-annotation logger-annotation</span></span><br><span class="line">INFO   [0000] Created plugin 00-logger (00-logger, handles RunPodSandbox,StopPodSandbox,RemovePodSandbox,CreateContainer,PostCreateContainer,StartContainer,PostStartContainer,UpdateContainer,PostUpdateContainer,StopContainer,RemoveContainer) </span><br><span class="line">INFO   [0000] Registering plugin 00-logger...              </span><br><span class="line">INFO   [0000] Configuring plugin 00-logger for runtime containerd/v1.7.2... </span><br><span class="line">INFO   [0000] got configuration data: &quot;&quot; from runtime containerd v1.7.2 </span><br><span class="line">INFO   [0000] Subscribing plugin 00-logger (00-logger) for events RunPodSandbox,StopPodSandbox,RemovePodSandbox,CreateContainer,PostCreateContainer,StartContainer,PostStartContainer,UpdateContainer,PostUpdateContainer,StopContainer,RemoveContainer </span><br><span class="line">INFO   [0000] Started plugin 00-logger...                  </span><br><span class="line">INFO   [0000] Synchronize: pods:                           </span><br><span class="line">INFO   [0000] Synchronize:    - annotations:               </span><br><span class="line">INFO   [0000] Synchronize:        io.kubernetes.cri.container-type: sandbox </span><br><span class="line">INFO   [0000] Synchronize:        io.kubernetes.cri.sandbox-cpu-period: &quot;100000&quot; </span><br><span class="line">INFO   [0000] Synchronize:        io.kubernetes.cri.sandbox-cpu-quota: &quot;100000&quot; </span><br><span class="line">INFO   [0000] Synchronize:        io.kubernetes.cri.sandbox-cpu-shares: &quot;1024&quot; </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Containerd æœåŠ¡ä¹Ÿæ”¶åˆ°äº†æ¥è‡ªå¤–éƒ¨å¯åŠ¨çš„ 00-logger æ’ä»¶ä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">journalctl -xeu containerd</span></span><br><span class="line">Jul 05 17:38:49 wnx containerd[84985]: time=&quot;2023-07-05T17:38:49.236103390+08:00&quot; level=info msg=&quot;plugin \&quot;external:00-logger[87525]\&quot; registered as \&quot;00-logger\&quot;&quot;</span><br><span class="line">Jul 05 17:38:49 wnx containerd[84985]: time=&quot;2023-07-05T17:38:49.237601881+08:00&quot; level=info msg=&quot;Synchronizing NRI (plugin) with current runtime state&quot;</span><br><span class="line">Jul 05 17:38:49 wnx containerd[84985]: time=&quot;2023-07-05T17:38:49.328071227+08:00&quot; level=info msg=&quot;synchronizing plugin 00-logger&quot;</span><br><span class="line">Jul 05 17:38:49 wnx containerd[84985]: time=&quot;2023-07-05T17:38:49.797028952+08:00&quot; level=info msg=&quot;plugin invocation order&quot;</span><br><span class="line">Jul 05 17:38:49 wnx containerd[84985]: time=&quot;2023-07-05T17:38:49.797164886+08:00&quot; level=info msg=&quot;  #1: \&quot;00-logger\&quot; (external:00-logger[87525])&quot;</span><br><span class="line">Jul 05 17:38:49 wnx containerd[84985]: time=&quot;2023-07-05T17:38:49.797197017+08:00&quot; level=info msg=&quot;  #2: \&quot;01-logger\&quot; (pre-connected:01-logger[84985])&quot;</span><br><span class="line">Jul 05 17:38:49 wnx containerd[84985]: time=&quot;2023-07-05T17:38:49.797226434+08:00&quot; level=info msg=&quot;plugin \&quot;00-logger\&quot; connected&quot;</span><br></pre></td></tr></table></figure><p>å¤š NRI æ’ä»¶æ˜¯æŒ‰ç…§ç´¢å¼•é¡ºåºæ‰§è¡Œï¼Œå› æ­¤ 01-logger ä¼šé‡æ–°è®¾ç½® 00-logger è®¾ç½®çš„ logger-env ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl inspect 6577fa85ac7e6 | grep logger</span></span><br><span class="line">          &quot;logger-env=logger-pid-85262&quot;</span><br><span class="line">        &quot;logger-annotation&quot;: &quot;logger-pid-87525&quot;</span><br></pre></td></tr></table></figure><h1 id="æ›´å¤šä»·å€¼"><a href="#æ›´å¤šä»·å€¼" class="headerlink" title="æ›´å¤šä»·å€¼"></a>æ›´å¤šä»·å€¼</h1><h2 id="èŠ‚ç‚¹ç»†ç²’åº¦èµ„æºç®¡ç†"><a href="#èŠ‚ç‚¹ç»†ç²’åº¦èµ„æºç®¡ç†" class="headerlink" title="èŠ‚ç‚¹ç»†ç²’åº¦èµ„æºç®¡ç†"></a>èŠ‚ç‚¹ç»†ç²’åº¦èµ„æºç®¡ç†</h2><p>ä¸ºäº†æ»¡è¶³ä¸åŒä¸šåŠ¡åº”ç”¨åœºæ™¯çš„éœ€æ±‚ï¼Œç‰¹åˆ«æ˜¯åœ¨åœ¨çº¿ä»»åŠ¡ä¸ç¦»çº¿ä»»åŠ¡æ··å¸ƒçš„åœºæ™¯ä¸‹ï¼Œåœ¨æé«˜èµ„æºåˆ©ç”¨ç‡çš„åŒæ—¶ï¼Œä¹Ÿè¦ä¿è¯å»¶è¿Ÿæ•æ„ŸæœåŠ¡å¯ä»¥å¾—åˆ°å……åˆ†çš„èµ„æºä¿è¯ï¼Œè¿™å°±éœ€è¦ Kubernetes æä¾›æ›´åŠ ç»†ç²’åº¦çš„èµ„æºç®¡ç†åŠŸèƒ½ï¼Œå¢å¼ºå®¹å™¨çš„éš”ç¦»æ€§ï¼Œå‡å°‘å®¹å™¨ä¹‹é—´çš„äº’ç›¸å¹²æ‰°ã€‚ä¾‹å¦‚ï¼ŒCPU ç¼–æ’ï¼Œå†…å­˜åˆ†å±‚ï¼Œç¼“å­˜ç®¡ç†ï¼ŒIO ç®¡ç†ç­‰ã€‚ç›®å‰æœ‰å¾ˆå¤šæ–¹æ¡ˆï¼Œä½†æ˜¯éƒ½æœ‰å…¶ä¸€å®šçš„å±€é™æ€§ã€‚</p><p>æˆªè‡³ç›®å‰ï¼ŒKubernetes å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªéå¸¸å®Œå–„çš„èµ„æºç®¡ç†æ–¹æ¡ˆï¼Œå¾ˆå¤š Kubernetes å‘¨è¾¹çš„å¼€æºé¡¹ç›®é€šè¿‡ä¸€äº›è‡ªå·±çš„æ–¹å¼ä¿®æ”¹ Pod çš„éƒ¨ç½²å’Œç®¡ç†æµç¨‹ï¼Œå®ç°èµ„æºåˆ†é…çš„ç»†ç²’åº¦ç®¡ç†ã€‚ä¾‹å¦‚ <a href="https://github.com/intel/cri-resource-manager">cri-resource-manager</a>ã€<a href="https://github.com/koordinator-sh/koordinator">Koordinator</a>ã€<a href="https://github.com/gocrane/crane">Crane</a> ç­‰é¡¹ç›®ã€‚</p><p>è¿™äº›é¡¹ç›®å¯¹ Kubernetes åˆ›å»ºå’Œæ›´æ–° Pod çš„æµç¨‹çš„ä¼˜åŒ–å¯ä»¥å¤§è‡´åˆ†ä¸ºä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯ proxy æ¨¡å¼ï¼Œä¸€ç§æ˜¯ standalone æ¨¡å¼ï¼š</p><ul><li><p>proxy</p><div align=center><img width="800" style="border: 0px" src="/gallery/containerd/proxy.png"></div><p>proxy æ¨¡å¼æ˜¯åœ¨å®¢æˆ·ç«¯ Kubelet å’Œ CRI è¿è¡Œæ—¶ä¹‹é—´å¢åŠ ä¸€ä¸ª CRI proxy ä¸­ç»§è¯·æ±‚å’Œå“åº”ï¼Œåœ¨ proxy ä¸­åŠ«æŒ Pod ä»¥åŠå®¹å™¨çš„åˆ›å»º&#x2F;æ›´æ–°&#x2F;åˆ é™¤äº‹ä»¶ï¼Œå¯¹ Pod spec è¿›è¡Œä¿®æ”¹æˆ–è€…å®Œå–„ï¼Œå°†ç¡¬ä»¶æ„ŸçŸ¥çš„èµ„æºåˆ†é…ç­–ç•¥åº”ç”¨äºå®¹å™¨ä¸­ã€‚</p></li><li><p>standalone</p><div align=center><img width="800" style="border: 0px" src="/gallery/containerd/standalone.png"></div><p>standalone æ¨¡å¼æ˜¯åœ¨æ¯ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª agentï¼Œå½“è¿™ä¸ª agent ç›‘å¬åˆ°åœ¨æœ¬èŠ‚ç‚¹çš„ Pod åˆ›å»ºæˆ–è€…ä¿®æ”¹äº‹ä»¶çš„æ—¶å€™ï¼Œå†æ ¹æ® Pod spec ä¸­çš„æ³¨è§£ç­‰æ‰©å±•ä¿¡æ¯ï¼Œè½¬æ¢æˆç»†ç²’åº¦èµ„æºé…ç½®çš„ specï¼Œç„¶åè°ƒç”¨ CRI è¿è¡Œæ—¶å®ç°å¯¹ Pod çš„æ›´æ–°ã€‚</p></li></ul><p>è¿™ä¸¤ç§æ–¹å¼åœ¨æ»¡è¶³ç‰¹å®šä¸šåŠ¡éœ€æ±‚çš„åŒæ—¶ä¹Ÿå­˜åœ¨ä¸€å®šçš„ç¼ºç‚¹, ä¸¤ç§æ–¹å¼éƒ½éœ€è¦ä¾èµ–é¢å¤–çš„ç»„ä»¶ï¼Œæ¥æ•è· Pod çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚proxy æ¨¡å¼å¢åŠ äº† Pod åˆ›å»ºç®¡ç†æµç¨‹çš„é“¾è·¯ä»¥åŠéƒ¨ç½²å’Œç»´æŠ¤æˆæœ¬ï¼Œstandalone æ¨¡å¼æ˜¯åœ¨ä¾¦å¬åˆ° Pod åˆ›å»ºä»¥åŠä¿®æ”¹çš„äº‹ä»¶åï¼Œæ‰ä¼šå¯¹ Pod è¿›è¡Œæ›´æ–°ï¼Œä¼šæœ‰ä¸€å®šçš„å»¶è¿Ÿã€‚</p><div align=center><img width="800" style="border: 0px" src="/gallery/containerd/nri.png"></div><p>ä½¿ç”¨ NRI å¯ä»¥å°† Kubelet çš„ Resource Manager ä¸‹æ²‰åˆ° CRI è¿è¡Œæ—¶å±‚è¿›è¡Œç®¡ç†ã€‚Kubelet å½“å‰ä¸é€‚åˆå¤„ç†å¤šç§éœ€æ±‚çš„æ‰©å±•ï¼Œåœ¨ Kubelet å±‚å¢åŠ ç»†ç²’åº¦çš„èµ„æºåˆ†é…ä¼šå¯¼è‡´ Kubelet å’Œ CRI çš„ç•Œé™è¶Šæ¥è¶Šæ¨¡ç³Šã€‚è€Œ NRIï¼Œåˆ™æ˜¯åœ¨ CRI ç”Ÿå‘½å‘¨æœŸé—´åšè°ƒç”¨ï¼Œæ›´é€‚åˆåšèµ„æºç»‘å®šå’ŒèŠ‚ç‚¹çš„æ‹“æ‰‘æ„ŸçŸ¥ã€‚å¹¶ä¸”åœ¨ CRI å†…éƒ¨åšæ’ä»¶å®šä¹‰å’Œè¿­ä»£ï¼Œå¯ä»¥åšåˆ°ä¸Šå±‚ Kubenetes ä»¥æœ€å°çš„ä»£ä»·æ¥é€‚é…å˜åŒ–ã€‚</p><p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå·²ç»æœ‰è¶Šæ¥è¶Šå¤šçš„èŠ‚ç‚¹èµ„æºç»†ç²’åº¦ç®¡ç†æ–¹æ¡ˆå¼€å§‹æ¢ç´¢ä½¿ç”¨ NRI å®ç°çš„å¯èƒ½æ€§ã€‚å½“ NRI æˆä¸ºèŠ‚ç‚¹ç»†ç²’åº¦èµ„æºåˆ†é…ç®¡ç†æ–¹æ¡ˆåï¼Œå¯ä»¥è¿›ä¸€æ­¥æé«˜èµ„æºç®¡ç†æ–¹æ¡ˆçš„æ ‡å‡†åŒ–ï¼Œæé«˜ç›¸å…³ç»„ä»¶çš„å¯å¤ç”¨æ€§ã€‚å‚è€ƒï¼š<a href="https://github.com/containers/nri-plugins%E3%80%82">https://github.com/containers/nri-pluginsã€‚</a></p>]]></content>
    
    
    <summary type="html">Containerd ä¸­ Node Resource Interface æ’ä»¶è®¾è®¡ç†å¿µä¸ç®€å•ä½¿ç”¨ç¤ºä¾‹</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Containerd" scheme="http://shenxianghong.github.io/tags/Containerd/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kubernetes ã€CPU ç²¾ç»†åŒ–ç®¡ç†</title>
    <link href="http://shenxianghong.github.io/2023/06/25/2023-06-25%20Kubernetes%20CPU%20%E7%B2%BE%E7%BB%86%E5%8C%96%E7%AE%A1%E7%90%86/"/>
    <id>http://shenxianghong.github.io/2023/06/25/2023-06-25%20Kubernetes%20CPU%20%E7%B2%BE%E7%BB%86%E5%8C%96%E7%AE%A1%E7%90%86/</id>
    <published>2023-06-24T16:00:00.000Z</published>
    <updated>2023-07-06T01:22:33.691Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kubernetes/logo.svg"></div><hr><blockquote><p>based on <strong>v1.24.10</strong></p></blockquote><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ç°ä»£å¤šæ ¸æœåŠ¡å™¨å¤§å¤šé‡‡ç”¨éç»Ÿä¸€å†…å­˜è®¿é—®æ¶æ„ï¼ˆNon-uniform memory accessï¼Œç®€ç§° NUMAï¼‰æ¥æé«˜ç¡¬ä»¶çš„å¯ä¼¸ç¼©æ€§ã€‚NUMA æ˜¯ä¸€ç§ä¸ºå¤šå¤„ç†å™¨çš„ç”µè„‘è®¾è®¡çš„å†…å­˜æ¶æ„ï¼Œå†…å­˜è®¿é—®æ—¶é—´å–å†³äºå†…å­˜ç›¸å¯¹äºå¤„ç†å™¨çš„ä½ç½®ã€‚åœ¨ NUMA æ¶æ„ä¸‹ï¼Œå¤„ç†å™¨è®¿é—®å®ƒè‡ªå·±çš„æœ¬åœ°å†…å­˜çš„é€Ÿåº¦æ¯”éæœ¬åœ°å†…å­˜ï¼ˆå†…å­˜ä½äºå¦ä¸€ä¸ªå¤„ç†å™¨ï¼Œæˆ–è€…æ˜¯å¤„ç†å™¨ä¹‹é—´å…±äº«çš„å†…å­˜ï¼‰å¿«ä¸€äº›ã€‚</p><p>åœ¨ Kubernetes ä¸­ï¼Œè°ƒåº¦å™¨çš„è°ƒåº¦ç²’åº¦ä¸ºèŠ‚ç‚¹çº§åˆ«ï¼Œå¹¶ä¸æ„ŸçŸ¥å’Œè€ƒè™‘èŠ‚ç‚¹ç¡¬ä»¶æ‹“æ‰‘çš„å­˜åœ¨ã€‚åœ¨æŸäº›å»¶è¿Ÿæ•æ„Ÿçš„åœºæ™¯ä¸‹ï¼Œå¯èƒ½å¸Œæœ› Kubernetes ä¸º Pod åˆ†é…æ‹“æ‰‘æœ€ä¼˜çš„èŠ‚ç‚¹å’Œç¡¬ä»¶ï¼Œä»¥æå‡ç¡¬ä»¶åˆ©ç”¨ç‡å’Œç¨‹åºæ€§èƒ½ã€‚CPU æ•æ„Ÿå‹åº”ç”¨æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>å¯¹ CPU throttling æ•æ„Ÿ</li><li>å¯¹ä¸Šä¸‹æ–‡åˆ‡æ¢æ•æ„Ÿ</li><li>å¯¹å¤„ç†å™¨ç¼“å­˜æœªå‘½ä¸­æ•æ„Ÿ</li><li>å¯¹è·¨ socket å†…å­˜è®¿é—®æ•æ„Ÿ</li></ul><p>åŒæ—¶ï¼Œåœ¨æŸäº›å¤æ‚åœºæ™¯ä¸‹ï¼Œéƒ¨åˆ†çš„ Pod å±äº CPU å¯†é›†å‹å·¥ä½œè´Ÿè½½ï¼ŒPod ä¹‹é—´ä¼šäº‰æŠ¢èŠ‚ç‚¹çš„ CPU èµ„æºã€‚å½“äº‰æŠ¢å‰§çƒˆçš„æ—¶å€™ï¼ŒPod ä¼šåœ¨ä¸åŒçš„ CPU core ä¹‹é—´è¿›è¡Œé¢‘ç¹çš„åˆ‡æ¢ï¼Œæ›´ç³Ÿç³•çš„æ˜¯åœ¨ NUMA node ä¹‹é—´çš„åˆ‡æ¢ã€‚è¿™ç§å¤§é‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¼šå½±å“ç¨‹åºè¿è¡Œçš„æ€§èƒ½ã€‚Kubernetes çš„ CPU manager ä¸€å®šç¨‹åº¦å¯ä»¥è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œä½†æ˜¯å› ä¸º CPU manager ç‰¹æ€§æ˜¯èŠ‚ç‚¹çº§åˆ«çš„ CPU è°ƒåº¦é€‰æ‹©ï¼Œæ‰€ä»¥æ— æ³•åœ¨é›†ç¾¤ç»´åº¦ä¸­é€‰æ‹©æœ€ä¼˜çš„ CPU core ç»„åˆã€‚åŒæ—¶ CPU manager ç‰¹æ€§è¦æ±‚ Pod QoS ä¸º Guaranteed æ—¶æ‰èƒ½ç”Ÿæ•ˆï¼Œä¸”æ— æ³•é€‚ç”¨äºæ‰€æœ‰ QoS ç±»å‹çš„ Podã€‚</p><p>Kubernetes ä¸­è™½ç„¶æœ‰ Topology Manager æ¥ç®¡ç†èŠ‚ç‚¹èµ„æºçš„æ‹“æ‰‘å¯¹é½ï¼Œä½†æ˜¯æ²¡æœ‰ä¸è°ƒåº¦å™¨è”åŠ¨ï¼Œå¯¼è‡´è°ƒåº¦ç»“æœå’Œè®¾å¤‡èµ„æºåˆ†é…ç»“æœå¯èƒ½ä¸ä¸€è‡´ã€‚æ­¤å¤–ï¼ŒTopology Manager åœ¨è¿›è¡Œèµ„æºå¯¹é½æ—¶ï¼Œä»…ä»…åœç•™åœ¨ NUMA ç»´åº¦ï¼Œå¹¶æœªè€ƒé‡åˆ° CPU socket å’Œ core æ‹“æ‰‘ç­‰ç»†ç²’åº¦æ¦‚å¿µã€‚</p><h1 id="è®¾è®¡æ€è€ƒ"><a href="#è®¾è®¡æ€è€ƒ" class="headerlink" title="è®¾è®¡æ€è€ƒ"></a>è®¾è®¡æ€è€ƒ</h1><h2 id="NUMA-æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦"><a href="#NUMA-æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦" class="headerlink" title="NUMA æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦"></a>NUMA æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦</h2><p><em><a href="https://github.com/kubernetes-sigs/scheduler-plugins/blob/master/kep/119-node-resource-topology-aware-scheduling/README.md">KEP è®®é¢˜</a></em></p><p>å¼•å…¥ Topology Manager åï¼Œæ”¯æŒ Pod åœ¨å­˜åœ¨ä¸åŒçš„ NUMA æ‹“æ‰‘å’Œä¸åŒæ•°é‡çš„æ‹“æ‰‘èµ„æºé›†ç¾¤èŠ‚ç‚¹ä¸­å¯åŠ¨ã€‚ä½†æ˜¯å­˜åœ¨ Pod å¯èƒ½è¢«è°ƒåº¦åˆ°æ€»èµ„æºé‡è¶³å¤Ÿçš„èŠ‚ç‚¹ä¸Šï¼Œä½†èµ„æºåˆ†é…å´æ— æ³•æ»¡è¶³é¢„æœŸçš„æ‹“æ‰‘ç­–ç•¥ï¼Œä»è€Œå¯¼è‡´ Pod å¯åŠ¨å¤±è´¥ï¼ˆTopologyAffinityErrorï¼‰ã€‚å¯¹äº Kube-scheduler æ¥è¯´ï¼Œæ›´å¥½çš„è¡Œä¸ºæ–¹å¼åº”è¯¥æ˜¯é€‰æ‹©é€‚å½“çš„èŠ‚ç‚¹ï¼Œä¸ Kubelet Topology Manager ç­–ç•¥å¯¹é½ï¼Œä»¥ä¾¿ Kubelet å¯ä»¥å…è®¸ Pod è¿è¡Œã€‚</p><p><strong>éœ€è¦åšå‡ºçš„æ”¹åŠ¨æœ‰</strong></p><ul><li>å½“èŠ‚ç‚¹ä¸Šæœ‰ NUMA æ‹“æ‰‘æ—¶ï¼Œé€šè¿‡ä½¿ç”¨ scheduler-plugin ä½¿è°ƒåº¦è¿‡ç¨‹æ›´åŠ ç²¾ç¡®</li><li>è€ƒè™‘ NUMA æ‹“æ‰‘ï¼Œåšå‡ºæ›´ä¼˜åŒ–çš„è°ƒåº¦å†³ç­–</li></ul><p>éœ€è¦ä¸€ä¸ªåœ¨ Kubelet å¤–éƒ¨è¿è¡Œçš„ agentï¼ˆ<a href="https://github.com/k8stopologyawareschedwg/resource-topology-exporter">ç¤¾åŒºå‚è€ƒå®ç°</a>ï¼‰ï¼Œç”¨äºæ”¶é›†æœ‰å…³æ­£åœ¨è¿è¡Œ Pod çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯ï¼Œæ ¹æ®èŠ‚ç‚¹çš„å¯åˆ†é…èµ„æºå’Œ Pod æ¶ˆè€—çš„èµ„æºï¼Œå®ƒå°†åœ¨ CRD ä¸­æä¾›å¯ç”¨èµ„æºï¼Œå…¶ä¸­ä¸€ä¸ª CRD å®ä¾‹ä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹ã€‚ CRD å®ä¾‹çš„åç§°å°±æ˜¯èŠ‚ç‚¹çš„åç§°ã€‚</p><p>Filter æ’ä»¶å®ç°äº†ä¸€ä¸ªä¸åŸ Topology Manager ç®—æ³•ä¸åŒçš„ç®€åŒ–ç‰ˆçš„ Topology Managerã€‚è¯¥æ’ä»¶ä»¥ single-numa-node ç­–ç•¥çš„æ ‡å‡†æ£€æŸ¥å„èŠ‚ç‚¹æ˜¯å¦å…·å¤‡è¿è¡Œ Pod çš„èƒ½åŠ›ã€‚ç”±äºè¿™æ˜¯æœ€ä¸¥æ ¼çš„ Topology Manager ç­–ç•¥ï¼Œå¦‚æœè¯¥ç­–ç•¥æ¡ä»¶é€šè¿‡ï¼Œåˆ™æ„å‘³ç€ä¹Ÿå¿…ç„¶æ»¡è¶³å…¶ä»–ç­–ç•¥æ¡ä»¶ã€‚Filter æ’ä»¶å°†ä½¿ç”¨ CRD æ¥è¯†åˆ«èŠ‚ç‚¹ä¸Šå¯ç”¨çš„æ‹“æ‰‘ç­–ç•¥ä»¥åŠèŠ‚ç‚¹ä¸Šå¯ç”¨èµ„æºçš„æ‹“æ‰‘ä¿¡æ¯ã€‚å¦å¤–ï¼ŒScore æ’ä»¶å°†è¿›ä¸€æ­¥è€ƒè™‘æœ€é€‚åˆè¿è¡Œ Pod çš„èŠ‚ç‚¹ã€‚</p><p><strong>CRD è®¾è®¡</strong></p><p>å…·æœ‰èŠ‚ç‚¹æ‹“æ‰‘çš„å¯ç”¨èµ„æºåº”å­˜å‚¨åœ¨ CRD ä¸­ï¼Œå…¶æ ¼å¼åº”éµå¾ª <a href="https://docs.google.com/document/d/12kj3fK8boNuPNqob6F_pPU9ZTaNEnPGaXEooW1Cilwg/edit?pli=1">Kubernetes Node Resource Topology Custom Resource Definition Standard</a>ã€‚<a href="https://github.com/k8stopologyawareschedwg/noderesourcetopology-api">ç¤¾åŒºå‚è€ƒè®¾è®¡</a>ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NodeResourceTopologyList is a list of NodeResourceTopology resources</span></span><br><span class="line"><span class="keyword">type</span> NodeResourceTopologyList <span class="keyword">struct</span> &#123;</span><br><span class="line">metav1.TypeMeta <span class="string">`json:&quot;,inline&quot;`</span></span><br><span class="line">metav1.ListMeta <span class="string">`json:&quot;metadata&quot;`</span></span><br><span class="line"></span><br><span class="line">Items []NodeResourceTopology <span class="string">`json:&quot;items&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NodeResourceTopology is a specification for a NodeResourceTopology resource</span></span><br><span class="line"><span class="keyword">type</span> NodeResourceTopology <span class="keyword">struct</span> &#123;</span><br><span class="line">metav1.TypeMeta   <span class="string">`json:&quot;,inline&quot;`</span></span><br><span class="line">metav1.ObjectMeta <span class="string">`json:&quot;metadata,omitempty&quot;`</span></span><br><span class="line"></span><br><span class="line">TopologyPolicies []<span class="type">string</span> <span class="string">`json:&quot;topologyPolicies&quot;`</span></span><br><span class="line">Zones            ZoneList <span class="string">`json:&quot;zones&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Zone is the spec for a NodeResourceTopology resource</span></span><br><span class="line"><span class="keyword">type</span> Zone <span class="keyword">struct</span> &#123;</span><br><span class="line">Name       <span class="type">string</span>           <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">Type       <span class="type">string</span>           <span class="string">`json:&quot;type&quot;`</span></span><br><span class="line">Parent     <span class="type">string</span>           <span class="string">`json:&quot;parent,omitempty&quot;`</span></span><br><span class="line">Costs      CostList         <span class="string">`json:&quot;costs,omitempty&quot;`</span></span><br><span class="line">Attributes AttributeList    <span class="string">`json:&quot;attributes,omitempty&quot;`</span></span><br><span class="line">Resources  ResourceInfoList <span class="string">`json:&quot;resources,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ZoneList []Zone</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ResourceInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">Name        <span class="type">string</span>             <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">Allocatable intstr.IntOrString <span class="string">`json:&quot;allocatable&quot;`</span></span><br><span class="line">Capacity    intstr.IntOrString <span class="string">`json:&quot;capacity&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> ResourceInfoList []ResourceInfo</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CostInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="type">string</span> <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">Value <span class="type">int</span>    <span class="string">`json:&quot;value&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> CostList []CostInfo</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AttributeInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="type">string</span> <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">Value <span class="type">string</span> <span class="string">`json:&quot;value&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> AttributeList []AttributeInfo</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">topology.node.k8s.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NodeResourceTopology</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node1</span></span><br><span class="line"><span class="attr">topologyPolicies:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">SingleNUMANodeContainerLevel</span></span><br><span class="line"><span class="attr">zones:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">costs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-0</span></span><br><span class="line">    <span class="attr">value:</span> <span class="number">10</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-1</span></span><br><span class="line">    <span class="attr">value:</span> <span class="number">21</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-0</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">allocatable:</span> <span class="string">&quot;12&quot;</span></span><br><span class="line">    <span class="attr">available:</span> <span class="string">&quot;12&quot;</span></span><br><span class="line">    <span class="attr">capacity:</span> <span class="string">&quot;24&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">allocatable:</span> <span class="string">&quot;68590714880&quot;</span></span><br><span class="line">    <span class="attr">available:</span> <span class="string">&quot;68590714880&quot;</span></span><br><span class="line">    <span class="attr">capacity:</span> <span class="string">&quot;68590714880&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Node</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">costs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-0</span></span><br><span class="line">    <span class="attr">value:</span> <span class="number">21</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-1</span></span><br><span class="line">    <span class="attr">value:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-1</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">allocatable:</span> <span class="string">&quot;24&quot;</span></span><br><span class="line">    <span class="attr">available:</span> <span class="string">&quot;12&quot;</span></span><br><span class="line">    <span class="attr">capacity:</span> <span class="string">&quot;24&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">allocatable:</span> <span class="string">&quot;68719476736&quot;</span></span><br><span class="line">    <span class="attr">available:</span> <span class="string">&quot;68719476736&quot;</span></span><br><span class="line">    <span class="attr">capacity:</span> <span class="string">&quot;68719476736&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">Node</span></span><br></pre></td></tr></table></figure><p><strong>å·²çŸ¥é™åˆ¶</strong></p><p>Kube-scheduler åœ¨ NUMA æ„ŸçŸ¥è°ƒåº¦ Pod æµç¨‹ä¹‹åï¼Œå¹¶ä¸çŸ¥é“èŠ‚ç‚¹ä¸Š Topology Manager å®é™…ä¸º Pod åˆ†é…çš„ NUMA æƒ…å†µï¼ŒèŠ‚ç‚¹ä¸Šçš„ Topology Manager ä¹Ÿæœªå¿…æŒ‰ç…§ scheduler-plugin ä¸­çš„é¢„é€‰ç®—æ³•è¿›è¡Œåˆ†é…ã€‚ </p><p>å› æ­¤ï¼ŒKEP ä¸­å»ºè®® Kube-scheduler å¯ä»¥å°†åˆ†é…çš„ NUMA ID ä½œä¸º Pod æç¤ºé€ä¼ ï¼ŒèŠ‚ç‚¹çš„ Topology Manager ä¹Ÿå¯ä»¥æ ¹æ® Pod ä¸­çš„ç›¸å…³æç¤ºä¿¡æ¯è€ƒè™‘å®é™…çš„åˆ†é…ç­–ç•¥ï¼ˆè¿™éƒ¨åˆ†æ¶‰åŠåˆ° Topology Manager çš„æ”¹åŠ¨ï¼Œæš‚æœªå®ç°ï¼‰ã€‚</p><h2 id="èŠ‚ç‚¹-CPU-ç¼–æ’"><a href="#èŠ‚ç‚¹-CPU-ç¼–æ’" class="headerlink" title="èŠ‚ç‚¹ CPU ç¼–æ’"></a>èŠ‚ç‚¹ CPU ç¼–æ’</h2><div align=center><img width="600" style="border: 0px" src="/gallery/cpu-manage/cpu-assign.png"></div><p><strong>åˆ†é…ä¼˜å…ˆçº§</strong></p><ol><li>ä¸ºäº†å¤šæ ¸å…±äº« L1 å’Œ L2 cacheï¼Œä¼˜å…ˆåˆ†é…ä½äºåŒä¸€ç‰©ç†æ ¸å¿ƒçš„ä¸¤ä¸ªé€»è¾‘æ ¸å¿ƒã€‚å³å›¾ä¸­çš„ 0 å’Œ 16 å· CPU åˆ†é…ä¼˜å…ˆçº§é«˜äº 0 å’Œ 1 å· CPU</li><li>ä¸ºäº†å¤šæ ¸å…±äº« L3 cache ï¼Œä¼˜å…ˆåˆ†é…ä½äºåŒä¸€ NUMA çš„ä¸¤ä¸ªé€»è¾‘æ ¸å¿ƒã€‚å³å›¾ä¸­çš„ 0 å’Œ 1 å· CPU åˆ†é…ä¼˜å…ˆçº§é«˜äº 0 å’Œ 4 å· CPU</li></ol><p><strong>æ‰©å±•æ€è€ƒç‚¹</strong></p><ul><li>è€ƒè™‘åˆ°è¶…çº¿ç¨‹æ€§èƒ½çš„å‘æŒ¥ç“¶é¢ˆï¼Œå¯¹äº CPU æ»¡è½½æœåŠ¡è€Œè¨€ï¼ŒåŒä¸€ç‰©ç†æ ¸å¿ƒçš„ä¸¤ä¸ªé€»è¾‘æ ¸å¿ƒæœªå¿…æ¯”æ¥è‡ªä¸åŒç‰©ç†æ ¸å¿ƒçš„æ€§èƒ½å¼ºï¼Œå› æ­¤å¯ä»¥é’ˆå¯¹åº”ç”¨æœ¬èº«çš„ä¸šåŠ¡æ¨¡å‹ï¼Œæ˜¯å¦åˆ†é…è‡ªåŒä¸€ä¸ªç‰©ç†æ ¸å¿ƒæœ‰å¾…è€ƒé‡</li><li>CPU çš„åˆ†é…ä¼˜å…ˆçº§å¯ä»¥ä¸ä»…ä»…ä»é™æ€æ‹“æ‰‘ç»“æ„è§’åº¦æ€è€ƒè®¾è®¡ï¼Œä¹Ÿå¯ä»¥ç»“åˆ CPU é¢‘ç‡ã€flag ç­‰å±æ€§ä¿¡æ¯ä»¥åŠ CPU çœŸå®ä½¿ç”¨ç‡ç­‰åŠ¨æ€å®æ—¶ä¿¡æ¯ï¼Œå¤šç»´åº¦çš„è€ƒé‡</li><li>è€ƒè™‘åˆ°èŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡ï¼Œå¯¹äºé Guaranteed QoS çš„ Pod è€Œè¨€ï¼Œå¾€å¾€ä¹Ÿéœ€è¦ä¸åŒç¨‹åº¦çš„ CPU ç²¾ç»†åŒ–ç®¡ç†</li><li>ç”±äºé›†ç¾¤èµ„æºåŠ¨æ€å˜åŒ–ï¼Œæœ€åˆæœªæ»¡è¶³æœ€ä½³åˆ†é…ç­–ç•¥çš„æœåŠ¡ï¼Œå¯ä»¥å€ŸåŠ©é€‚æ—¶é‡åˆ†é…æˆ–é‡è°ƒåº¦è°ƒæ•´è‡³æœ€ä¼˜åˆ†é…æ•ˆæœ</li><li>æ‹“æ‰‘èµ„æºå¯¹é½ä¸ä»…ä»…é™åˆ¶äº CPU èµ„æºï¼Œå¾€å¾€ä¸€å¥—å®Œæ•´çš„æ‹“æ‰‘èµ„æºå¯¹é½æ–¹æ¡ˆä¼šå°† CPUã€å†…å­˜ã€GPUã€ç½‘å¡ç­‰ç¡¬ä»¶è®¾å¤‡å‡è€ƒè™‘åœ¨å†…</li><li>ç°é˜¶æ®µï¼Œåœ¨ä¸ä¿®æ”¹ CPU Managerã€Topology Manager ç­‰åŸæœ‰æ¨¡å—é€»è¾‘çš„å‰æä¸‹ï¼Œå¾€å¾€éœ€è¦ä¸€ä¸ªæ—è·¯ agentï¼ˆstandalone æ¨¡å¼ï¼‰æˆ–è€… hook CRIï¼ˆproxy æ¨¡å¼ï¼‰è°ƒç”¨çš„æ¨¡å¼æ¥æ¥ç®¡èµ„æºç®¡ç†çš„èƒ½åŠ›ï¼Œå¹¶ä¸”å¾€å¾€éœ€è¦ç¦ç”¨åŸç”Ÿçš„ç®¡ç†ç­–ç•¥</li><li>éšç€ NRIï¼ˆNode Resource Interfaceï¼‰è§„èŒƒçš„å®Œå–„ï¼Œå¯ä»¥åŸºäº NRI hook æ‰©å±•ï¼Œå®ç°èµ„æºç¼–æ’</li></ul><h1 id="ç¤¾åŒºæˆæœ"><a href="#ç¤¾åŒºæˆæœ" class="headerlink" title="ç¤¾åŒºæˆæœ"></a>ç¤¾åŒºæˆæœ</h1><h2 id="Crane"><a href="#Crane" class="headerlink" title="Crane"></a>Crane</h2><p><em><a href="https://github.com/gocrane/crane">https://github.com/gocrane/crane</a></em></p><div align=center><img width="800" style="border: 0px" src="/gallery/crane/overview.png"></div><p>Crane æ˜¯ä¸€ä¸ªåŸºäº FinOps çš„äº‘èµ„æºåˆ†æä¸æˆæœ¬ä¼˜åŒ–å¹³å°ã€‚å®ƒçš„æ„¿æ™¯æ˜¯åœ¨ä¿è¯å®¢æˆ·åº”ç”¨è¿è¡Œè´¨é‡çš„å‰æä¸‹å®ç°æè‡´çš„é™æœ¬ã€‚</p><p><strong>è®¾è®¡æ¦‚è¿°</strong></p><div align=center><img width="600" style="border: 0px" src="/gallery/crane/topology-awareness-architecture.png"></div><p>Crane-scheduler å’Œ Crane-agent é…åˆå·¥ä½œï¼Œå®Œæˆæ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦ä¸èµ„æºåˆ†é…çš„å·¥ä½œï¼š</p><ol><li>Crane-agent ä»èŠ‚ç‚¹é‡‡é›†èµ„æºæ‹“æ‰‘ï¼ŒåŒ…æ‹¬ NUMAã€socketã€è®¾å¤‡ç­‰ä¿¡æ¯ï¼Œæ±‡æ€»åˆ° NodeResourceTopology CRD ä¸­</li><li>Crane-scheduler åœ¨è°ƒåº¦æ—¶ä¼šå‚è€ƒèŠ‚ç‚¹çš„ NodeResourceTopology å¯¹è±¡è·å–åˆ°èŠ‚ç‚¹è¯¦ç»†çš„èµ„æºæ‹“æ‰‘ç»“æ„ï¼Œåœ¨è°ƒåº¦åˆ°èŠ‚ç‚¹çš„åŒæ—¶è¿˜ä¼šä¸º Pod åˆ†é…æ‹“æ‰‘èµ„æºï¼Œå¹¶å°†ç»“æœå†™åˆ° Pod çš„ annotations ä¸­</li><li>Crane-agent åœ¨èŠ‚ç‚¹ä¸Š watch åˆ° Pod è¢«è°ƒåº¦åï¼Œä» Pod çš„ annotations ä¸­è·å–åˆ°æ‹“æ‰‘åˆ†é…ç»“æœï¼Œå¹¶æŒ‰ç…§ç”¨æˆ·ç»™å®šçš„ CPU ç»‘å®šç­–ç•¥è¿›è¡Œ CPUset çš„ç»†ç²’åº¦åˆ†é…</li></ol><div align=center><img width="1000" style="border: 0px" src="/gallery/crane/topology-awareness-details.png"></div><p><strong>CPU åˆ†é…ç­–ç•¥</strong></p><p>Crane ä¸­æä¾›äº†å››ç§ CPU åˆ†é…ç­–ç•¥ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p><ol><li>noneï¼šè¯¥ç­–ç•¥ä¸è¿›è¡Œç‰¹åˆ«çš„ CPUset åˆ†é…ï¼ŒPod ä¼šä½¿ç”¨èŠ‚ç‚¹ CPU å…±äº«æ± </li><li>exclusiveï¼šè¯¥ç­–ç•¥å¯¹åº” Kubelet çš„ static ç­–ç•¥ï¼ŒPod ä¼šç‹¬å  CPU æ ¸å¿ƒï¼Œå…¶ä»–ä»»ä½• Pod éƒ½æ— æ³•ä½¿ç”¨</li><li>numaï¼šè¯¥ç­–ç•¥ä¼šæŒ‡å®š NUMA Nodeï¼ŒPod ä¼šä½¿ç”¨è¯¥ NUMA Node ä¸Šçš„ CPU å…±äº«æ± </li><li>immovableï¼šè¯¥ç­–ç•¥ä¼šå°† Pod å›ºå®šåœ¨æŸäº› CPU æ ¸å¿ƒä¸Šï¼Œä½†è¿™äº›æ ¸å¿ƒå±äºå…±äº«æ± ï¼Œå…¶ä»– Pod ä»å¯ä½¿ç”¨</li></ol><p><strong>ä¸ºç³»ç»Ÿç»„ä»¶é¢„ç•™ CPU</strong></p><p>åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¸Œæœ›èƒ½å¯¹ Kubelet é¢„ç•™çš„ CPU åšä¸€äº›ä¿æŠ¤ï¼Œä½¿ç”¨åœºæ™¯åŒ…æ‹¬ä½†ä¸é™äºï¼š</p><ul><li>åœ¨æ··éƒ¨åœºæ™¯ä¸‹ï¼Œä¸å¸Œæœ›ç¦»çº¿ä»»åŠ¡ç»‘å®šç³»ç»Ÿé¢„ç•™çš„ CPU æ ¸å¿ƒï¼Œé˜²æ­¢å¯¹ K8s ç³»ç»Ÿç»„ä»¶äº§ç”Ÿå½±å“</li><li>0 å·æ ¸å¿ƒåœ¨ Linux æœ‰ç‹¬ç‰¹ç”¨é€”ï¼Œæ¯”å¦‚å¤„ç†ç½‘ç»œåŒ…ã€å†…æ ¸è°ƒç”¨ã€å¤„ç†ä¸­æ–­ç­‰ï¼Œå› æ­¤ä¸å¸Œæœ›ä»»åŠ¡ç»‘å®š 0 å·æ ¸å¿ƒ</li></ul><p>åœ¨ Crane ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸ºç³»ç»Ÿç»„ä»¶é¢„ç•™ CPUï¼š</p><ol><li>Kubelet è®¾ç½®é¢„ç•™ CPUï¼šæŒ‰ç…§<a href="https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/#explicitly-reserved-cpu-list">å®˜æ–¹æŒ‡å¼•</a>è®¾ç½®é¢„ç•™çš„ CPU åˆ—è¡¨</li><li>æŸ¥çœ‹ NodeResourceTopology å¯¹è±¡ï¼Œspec.attributes ä¸­çš„ <code>go.crane.io/reserved-system-cpus</code> å­˜å‚¨äº†é¢„ç•™çš„ CPU åˆ—è¡¨</li><li>åœ¨ Pod çš„ annotations ä¸­æ·»åŠ  <code>topology.crane.io/exclude-reserved-cpus</code>ï¼Œè¡¨æ˜ Pod ä¸ç»‘å®šé¢„ç•™çš„ CPU æ ¸å¿ƒ</li></ol><h2 id="Koordinator"><a href="#Koordinator" class="headerlink" title="Koordinator"></a>Koordinator</h2><p><u><em><a href="https://github.com/koordinator-sh/koordinator">https://github.com/koordinator-sh/koordinator</a></em></u></p><div align=center><img width="700" style="border: 0px" src="/gallery/koordinator/overview.png"></div><p>Koordinator æ˜¯ä¸€ä¸ªåŸºäº QoS çš„ Kubernetes æ··åˆå·¥ä½œè´Ÿè½½è°ƒåº¦ç³»ç»Ÿï¼Œæ—¨åœ¨æé«˜å¯¹å»¶è¿Ÿæ•æ„Ÿçš„å·¥ä½œè´Ÿè½½å’Œæ‰¹å¤„ç†ä½œä¸šçš„è¿è¡Œæ—¶æ•ˆç‡å’Œå¯é æ€§ï¼Œç®€åŒ–ä¸èµ„æºç›¸å…³çš„é…ç½®è°ƒæ•´çš„å¤æ‚æ€§ï¼Œå¹¶å¢åŠ  Pod éƒ¨ç½²å¯†åº¦ä»¥æé«˜èµ„æºåˆ©ç”¨ç‡ã€‚</p><p><strong>è®¾è®¡æ¦‚è¿°</strong></p><div align=center><img width="1000" style="border: 0px" src="/gallery/koordinator/cpu-orchestration.svg"></div><p>å½“ Koordlet å¯åŠ¨æ—¶ï¼ŒKoordlet ä» Kubelet æ”¶é›† NUMA æ‹“æ‰‘ä¿¡æ¯ï¼ŒåŒ…æ‹¬ NUMA æ‹“æ‰‘ã€CPU æ‹“æ‰‘ã€Kubelet CPU ç®¡ç†ç­–ç•¥ã€Kubelet ä¸º Guaranteed Pod åˆ†é…çš„ CPU ç­‰ï¼Œå¹¶æ›´æ–°åˆ°èŠ‚ç‚¹èµ„æºæ‹“æ‰‘ CRDã€‚å½“å»¶è¿Ÿæ•æ„Ÿçš„åº”ç”¨ç¨‹åºæ‰©å®¹æ—¶ï¼Œå¯ä»¥ä¸ºæ–° Pod è®¾ç½® Koordinator QoS LSE&#x2F;LSRã€CPU ç»‘å®šç­–ç•¥å’Œ CPU ç‹¬å ç­–ç•¥ï¼Œè¦æ±‚ Koord-scheduler åˆ†é…æœ€é€‚åˆçš„ CPU ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚å½“ Koord-scheduler è°ƒåº¦ Pod æ—¶ï¼ŒKoord-scheduler ä¼šè¿‡æ»¤æ»¡è¶³ NUMA æ‹“æ‰‘å¯¹é½ç­–ç•¥çš„èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡è¯„åˆ†é€‰æ‹©æœ€ä½³èŠ‚ç‚¹ï¼Œåœ¨ Reserve é˜¶æ®µåˆ†é… CPUï¼Œå¹¶åœ¨ PreBinding æ—¶å°†ç»“æœè®°å½•åˆ° Pod annotationsã€‚Koordlet é€šè¿‡ hook Kubelet CRI è¯·æ±‚ï¼Œæ›¿æ¢é€šè¿‡ Koord-scheduler è°ƒåº¦çš„ CPU é…ç½®å‚æ•°åˆ°è¿è¡Œæ—¶ï¼Œä¾‹å¦‚é…ç½® cgroupã€‚</p><p><strong>QoS</strong></p><p>Koordinator è°ƒåº¦ç³»ç»Ÿæ”¯æŒçš„ QoS æœ‰äº”ç§ç±»å‹:</p><table><thead><tr><th>QoS</th><th>ç‰¹ç‚¹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SYSTEM</td><td>ç³»ç»Ÿè¿›ç¨‹ï¼Œèµ„æºå—é™</td><td>å¯¹äº DaemonSets ç­‰ç³»ç»ŸæœåŠ¡ï¼Œè™½ç„¶éœ€è¦ä¿è¯ç³»ç»ŸæœåŠ¡çš„å»¶è¿Ÿï¼Œä½†ä¹Ÿéœ€è¦é™åˆ¶èŠ‚ç‚¹ä¸Šè¿™äº›ç³»ç»ŸæœåŠ¡å®¹å™¨çš„èµ„æºä½¿ç”¨ï¼Œä»¥ç¡®ä¿å…¶ä¸å ç”¨è¿‡å¤šçš„èµ„æº</td></tr><tr><td>LSE(Latency Sensitive Exclusive)</td><td>ä¿ç•™èµ„æºå¹¶ç»„ç»‡åŒ QoS çš„ Pod å…±äº«èµ„æº</td><td>å¾ˆå°‘ä½¿ç”¨ï¼Œå¸¸è§äºä¸­é—´ä»¶ç±»åº”ç”¨ï¼Œä¸€èˆ¬åœ¨ç‹¬ç«‹çš„èµ„æºæ± ä¸­ä½¿ç”¨</td></tr><tr><td>LSR(Latency Sensitive Reserved)</td><td>é¢„ç•™èµ„æºä»¥è·å¾—æ›´å¥½çš„ç¡®å®šæ€§</td><td>ç±»ä¼¼äºç¤¾åŒºçš„ Guaranteedï¼ŒCPU æ ¸è¢«ç»‘å®š</td></tr><tr><td>LS(Latency Sensitive)</td><td>å…±äº«èµ„æºï¼Œå¯¹çªå‘æµé‡æœ‰æ›´å¥½çš„å¼¹æ€§</td><td>å¾®æœåŠ¡å·¥ä½œè´Ÿè½½çš„å…¸å‹QoSçº§åˆ«ï¼Œå®ç°æ›´å¥½çš„èµ„æºå¼¹æ€§å’Œæ›´çµæ´»çš„èµ„æºè°ƒæ•´èƒ½åŠ›</td></tr><tr><td>BE(Best Effort)</td><td>å…±äº«ä¸åŒ…æ‹¬ LSE çš„èµ„æºï¼Œèµ„æºè¿è¡Œè´¨é‡æœ‰é™ï¼Œç”šè‡³åœ¨æç«¯æƒ…å†µä¸‹è¢«æ€æ­»</td><td>æ‰¹é‡ä½œä¸šçš„å…¸å‹ QoS æ°´å¹³ï¼Œåœ¨ä¸€å®šæ—¶æœŸå†…ç¨³å®šçš„è®¡ç®—ååé‡ï¼Œä½æˆæœ¬èµ„æº</td></tr></tbody></table><p>Koordinator å’Œ Kubernetes QoS ä¹‹é—´æ˜¯æœ‰å¯¹åº”å…³ç³»çš„:</p><table><thead><tr><th>Koordinator QoS</th><th>Kubernetes QoS</th></tr></thead><tbody><tr><td>SYSTEM</td><td>â€”</td></tr><tr><td>LSE</td><td>Guaranteed</td></tr><tr><td>LSR</td><td>Guaranteed</td></tr><tr><td>LS</td><td>Guaranteed&#x2F;Burstable</td></tr><tr><td>BE</td><td>BestEffort</td></tr></tbody></table><p><strong>CPU ç¼–æ’åŸºæœ¬åŸåˆ™</strong></p><ol><li>ä»…æ”¯æŒ Pod ç»´åº¦çš„ CPU åˆ†é…æœºåˆ¶</li><li>Koordinator å°†æœºå™¨ä¸Šçš„ CPU åˆ†ä¸º CPU Shared Poolï¼Œstatically exclusive CPUs å’Œ BE CPU Shared Poolï¼š<ol><li>CPU Shared Pool æ˜¯ä¸€ç»„å…±äº« CPU æ± ï¼ŒBurstable å’Œ LS Pod ä¸­çš„ä»»ä½•å®¹å™¨éƒ½å¯ä»¥åœ¨å…¶ä¸Šè¿è¡Œã€‚Guaranteed fractional CPU requests çš„ Pod ä¹Ÿå¯ä»¥è¿è¡Œåœ¨ CPU Shared Pool ä¸­ã€‚CPU Shared Pool åŒ…å«èŠ‚ç‚¹ä¸­æ‰€æœ‰æœªåˆ†é…çš„ CPUï¼Œä½†ä¸åŒ…æ‹¬ç”± Guaranteedã€LSE å’Œ LSR Pod åˆ†é…çš„ CPUã€‚å¦‚æœ Kubelet ä¿ç•™ CPUï¼Œåˆ™ CPU Shared Pool åŒ…æ‹¬ä¿ç•™çš„ CPU</li><li>statically exclusive CPUs æ˜¯æŒ‡åˆ†é…ç»™ Guaranteedã€LSE&#x2F;LSR Pods ä½¿ç”¨çš„ä¸€ç»„ç‹¬å  CPUã€‚å½“ Guaranteedã€LSE å’Œ LSR Pod ç”³è¯· CPU æ—¶ï¼ŒKoord-scheduler å°†ä» CPU Shared Pool ä¸­åˆ†é…</li><li>BE CPU Shared Pool æ˜¯ä¸€ç»„ BestEffort å’Œ BE çš„ Pod éƒ½å¯è¿è¡Œçš„ CPU æ± ã€‚BE CPU Shared Pool åŒ…å«èŠ‚ç‚¹ä¸­é™¤ Guaranteed å’Œ LSE Pod åˆ†é…çš„ä¹‹å¤–çš„æ‰€æœ‰ CPU</li></ol></li></ol><p><strong>Koordinator QoS CPU ç¼–æ’åŸåˆ™</strong></p><ol><li>LSE&#x2F;LSR Pod çš„ requests å’Œ limits å¿…é¡»ç›¸ç­‰ï¼ŒCPU å€¼å¿…é¡»æ˜¯ 1000 çš„æ•´æ•°å€</li><li>LSE Pod åˆ†é…çš„ CPU æ˜¯å®Œå…¨ç‹¬å çš„ï¼Œä¸å¾—å…±äº«ã€‚å¦‚æœèŠ‚ç‚¹æ˜¯è¶…çº¿ç¨‹æ¶æ„ï¼Œåªä¿è¯é€»è¾‘æ ¸å¿ƒç»´åº¦æ˜¯éš”ç¦»çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ CPUBindPolicyFullPCPUs ç­–ç•¥è·å¾—æ›´å¥½çš„éš”ç¦»</li><li>LSR Pod åˆ†é…çš„ CPU åªèƒ½ä¸ BE Pod å…±äº«</li><li>LS Pod ç»‘å®šäº†ä¸ LSE&#x2F;LSR Pod ç‹¬å ä¹‹å¤–çš„å…±äº« CPU æ± </li><li>BE Pod ç»‘å®šä½¿ç”¨èŠ‚ç‚¹ä¸­é™¤ LSE Pod ç‹¬å ä¹‹å¤–çš„æ‰€æœ‰ CPU </li><li>å¦‚æœ Kubelet çš„ CPU ç®¡ç†å™¨ç­–ç•¥ä¸º static ç­–ç•¥ï¼Œåˆ™å·²ç»è¿è¡Œçš„ Guaranteed Pods ç­‰ä»·äº LSR</li><li>å¦‚æœ Kubelet çš„ CPU ç®¡ç†å™¨ç­–ç•¥ä¸º none ç­–ç•¥ï¼Œåˆ™å·²ç»è¿è¡Œçš„ Guaranteed Pods ç­‰ä»·äº LS</li><li>æ–°åˆ›å»ºä½†æœªæŒ‡å®š Koordinator QoS çš„ Guaranteed Pod ç­‰ä»·äº LS</li></ol><div align=center><img width="800" style="border: 0px" src="/gallery/koordinator/qos-cpu-orchestration.png"></div><p><strong>Kubelet CPU Manager ç­–ç•¥å…¼å®¹åŸåˆ™</strong></p><ol><li>å¦‚æœ Kubelet è®¾ç½® CPU Manager ç­–ç•¥é€‰é¡¹ <code>full-pcpus-only=true</code> æˆ–è€… <code>distribute-cpus-across-numa=true</code>ï¼Œå¹¶ä¸”èŠ‚ç‚¹ä¸­æ²¡æœ‰ Koordinator å®šä¹‰çš„æ–° CPU ç»‘å®šç­–ç•¥ï¼Œåˆ™éµå¾ª Kubelet å®šä¹‰çš„è¿™äº›å‚æ•°çš„å®šä¹‰</li><li>å¦‚æœ Kubelet è®¾ç½®äº† Topology Manager ç­–ç•¥ï¼Œå¹¶ä¸”èŠ‚ç‚¹ä¸­æ²¡æœ‰ Koordinator å®šä¹‰çš„æ–°çš„ NUMA Topology Alignment ç­–ç•¥ï¼Œåˆ™éµå¾ª Kubelet å®šä¹‰çš„è¿™äº›å‚æ•°çš„å®šä¹‰</li></ol><p><strong>æ¥ç®¡ Kubelet CPU ç®¡ç†ç­–ç•¥</strong></p><p>Kubelet é¢„ç•™çš„ CPU ä¸»è¦æœåŠ¡äº BestEffort å’Œ Burstable Podsã€‚ä½† Koordinator ä¸ä¼šéµå®ˆè¯¥ç­–ç•¥ã€‚Burstable Pod åº”è¯¥ä½¿ç”¨ CPU Shared Poolï¼Œè€Œ BestEffort Pods åº”è¯¥ä½¿ç”¨ BE CPU Shared Poolã€‚LSE å’Œ LSR Pod ä¸ä¼šä»è¢« Kubelet é¢„ç•™çš„ CPU ä¸­åˆ†é…ã€‚</p><ol><li>å¯¹äº Burstable å’Œ LS Pod<ol><li>å½“ Koordlet å¯åŠ¨æ—¶ï¼Œè®¡ç®— CPU Shared Pool å¹¶å°†å…±äº«æ± åº”ç”¨åˆ°èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰ Burstable å’Œ LS Podï¼Œå³æ›´æ–°å®ƒä»¬çš„ CPU cgroups, è®¾ç½® CPUsetã€‚åœ¨åˆ›å»ºæˆ–é”€æ¯ LSE&#x2F;LSR Pod æ—¶æ‰§è¡Œç›¸åŒçš„é€»è¾‘</li><li>Koordlet ä¼šå¿½ç•¥ Kubelet é¢„ç•™çš„ CPUï¼Œå°†å…¶æ›¿æ¢ä¸º Koordinator å®šä¹‰çš„ CPU Shared Pool</li></ol></li><li>å¯¹äº BestEffort å’Œ BE Pod<ol><li>å¦‚æœ Kubelet é¢„ç•™äº† CPUï¼ŒBestEffort Pod ä¼šé¦–å…ˆä½¿ç”¨é¢„ç•™çš„ CPU</li><li>Koordlet å¯ä»¥ä½¿ç”¨èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰ CPUï¼Œä½†ä¸åŒ…æ‹¬ç”±å…·æœ‰æ•´æ•° CPU çš„ Guaranteed å’Œ LSE Pod åˆ†é…çš„ CPUã€‚è¿™æ„å‘³ç€å¦‚æœ Koordlet å¯ç”¨ CPU Suppress åŠŸèƒ½ï¼Œåˆ™åº”éµå¾ªçº¦æŸä»¥ä¿è¯ä¸ä¼šå½±å“ LSE Podã€‚åŒæ ·ï¼Œå¦‚æœ Kubelet å¯ç”¨äº† CPU Manager static ç­–ç•¥ï¼Œåˆ™ä¹Ÿåº”æ’é™¤ Guaranteed Pod</li></ol></li><li>å¯¹äº Guaranteed Pod<ol><li>å¦‚æœ Pod çš„ annotations ä¸­æœ‰ Koord-scheduler æ›´æ–°çš„ <code>scheduling.koordinator.sh/resource-status</code>ï¼Œåœ¨ sandbox&#x2F;container åˆ›å»ºé˜¶æ®µï¼Œåˆ™ä¼šæ›¿æ¢ Kubelet CRI è¯·æ±‚ä¸­çš„ CPUset</li><li>Kubelet æœ‰æ—¶ä¼šè°ƒç”¨ CRI ä¸­å®šä¹‰çš„ Update æ–¹æ³•æ¥æ›´æ–°å®¹å™¨ cgroup ä»¥è®¾ç½®æ–°çš„ CPUï¼Œå› æ­¤ Koordlet å’Œ koord-runtime-proxy éœ€è¦ hook è¯¥æ–¹æ³•</li></ol></li><li>è‡ªåŠ¨è°ƒæ•´ CPU Shared Pool å¤§å°<ol><li>Koordlet ä¼šæ ¹æ® Pod åˆ›å»º&#x2F;é”€æ¯ç­‰å˜åŒ–è‡ªåŠ¨è°ƒæ•´ CPU Shared Pool çš„å¤§å°ã€‚å¦‚æœ CPU Shared Pool å‘ç”Ÿå˜åŒ–ï¼ŒKoordlet åº”è¯¥æ›´æ–°æ‰€æœ‰ä½¿ç”¨å…±äº«æ± çš„ LS æˆ– Burstable Pod çš„ cgroups</li><li>å¦‚æœ Pod çš„ annotations <code>scheduling.koordinator.sh/resource-status</code> ä¸­æŒ‡å®šäº†å¯¹åº”çš„ CPU Shared Poolï¼ŒKoordlet åœ¨é…ç½® cgroup æ—¶åªéœ€è¦ç»‘å®šå¯¹åº”å…±äº«æ± çš„ CPU å³å¯</li></ol></li></ol><p>æ¥ç®¡é€»è¾‘è¦æ±‚ koord-runtime-proxy æ·»åŠ æ–°çš„æ‰©å±•ç‚¹å¹¶ä¸” Koordlet å®ç°æ–°çš„è¿è¡Œæ—¶æ’ä»¶çš„ hook ã€‚å½“æ²¡æœ‰å®‰è£… koord-runtime-proxy æ—¶ï¼Œè¿™äº›æ¥ç®¡é€»è¾‘ä¹Ÿå°†èƒ½å¤Ÿå®ç°ã€‚</p><p><strong>CPU ç»‘å®šç­–ç•¥</strong></p><p>æ ‡ç­¾ <code>node.koordinator.sh/cpu-bind-policy</code> é™åˆ¶äº†è°ƒåº¦æ—¶å¦‚ä½•ç»‘å®š CPUï¼š</p><ul><li>None æˆ–ç©ºå€¼ â€” ä¸æ‰§è¡Œä»»ä½•ç­–ç•¥</li><li>FullPCPUsOnly â€” è¦æ±‚è°ƒåº¦å™¨å¿…é¡»åˆ†é…å®Œæ•´çš„ç‰©ç†æ ¸ã€‚ç­‰æ•ˆäº Kubelet CPU Manager ç­–ç•¥é€‰é¡¹ full-pcpus-only&#x3D;true</li><li>SpreadByPCPUs â€” è¦æ±‚è°ƒåº¦å™¨å¿…é¡»æŒ‰ç…§ç‰©ç†æ ¸ç»´åº¦å‡åŒ€çš„åˆ†é… CPU</li></ul><p><strong>NUMA åˆ†é…ç­–ç•¥</strong></p><p>æ ‡ç­¾ <code>node.koordinator.sh/numa-allocate-strategy</code> è¡¨ç¤ºåœ¨è°ƒåº¦æ—¶å¦‚ä½•é€‰æ‹©æ»¡æ„çš„ NUMA èŠ‚ç‚¹ï¼š</p><ul><li>MostAllocated â€” è¡¨ç¤ºä»å¯ç”¨èµ„æºæœ€å°‘çš„ NUMA èŠ‚ç‚¹åˆ†é…</li><li>LeastAllocated â€” è¡¨ç¤ºä»å¯ç”¨èµ„æºæœ€å¤šçš„ NUMA èŠ‚ç‚¹åˆ†é…</li><li>DistributeEvenly â€” è¡¨ç¤ºåœ¨ NUMA èŠ‚ç‚¹ä¸Šå¹³å‡åˆ†é… CPU</li></ul><p><strong>NUMA æ‹“æ‰‘å¯¹é½ç­–ç•¥</strong></p><p>æ ‡ç­¾ <code>node.koordinator.sh/numa-topology-alignment-policy</code> è¡¨ç¤ºå¦‚ä½•æ ¹æ® NUMA æ‹“æ‰‘å¯¹é½èµ„æºåˆ†é…ã€‚ç­–ç•¥è¯­ä¹‰éµå¾ª K8s ç¤¾åŒºã€‚ç›¸å½“äº NodeResourceTopology ä¸­çš„ TopologyPolicies å­—æ®µï¼Œæ‹“æ‰‘ç­–ç•¥ SingleNUMANodePodLevel å’Œ SingleNUMANodeContainerLevel æ˜ å°„åˆ° SingleNUMANode ç­–ç•¥ï¼š</p><ul><li>None â€” æ˜¯é»˜è®¤ç­–ç•¥ï¼Œä¸æ‰§è¡Œä»»ä½•æ‹“æ‰‘å¯¹é½</li><li>BestEffort â€” è¡¨ç¤ºä¼˜å…ˆé€‰æ‹©æ‹“æ‰‘å¯¹é½çš„ NUMA nodeï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ç»§ç»­ä¸º Pod åˆ†é…èµ„æº</li><li>Restricted â€” è¡¨ç¤ºæ¯ä¸ª Pod åœ¨ NUMA èŠ‚ç‚¹ä¸Šè¯·æ±‚çš„èµ„æºæ˜¯æ‹“æ‰‘å¯¹é½çš„ï¼Œå¦‚æœä¸æ˜¯ï¼ŒKoord-scheduler ä¼šåœ¨è°ƒåº¦æ—¶è·³è¿‡è¯¥èŠ‚ç‚¹</li><li>SingleNUMANode â€” è¡¨ç¤ºä¸€ä¸ª Pod è¯·æ±‚çš„æ‰€æœ‰èµ„æºéƒ½å¿…é¡»åœ¨åŒä¸€ä¸ª NUMA èŠ‚ç‚¹ä¸Šï¼Œå¦‚æœä¸æ˜¯ï¼ŒKoord-scheduler è°ƒåº¦æ—¶ä¼šè·³è¿‡è¯¥èŠ‚ç‚¹</li></ul><p><strong>NodeResourceTopology ç»´æŠ¤</strong></p><p>Koordinator åœ¨ç¤¾åŒºæä¾›çš„ NodeResourceTopology CRD åŸºç¡€ä¹‹ä¸Šé€šè¿‡ annotations å’Œ label æ‰©å±•äº†æ›´å¤šçš„ CPU ç®¡ç†ç­–ç•¥ä¸é™åˆ¶ã€‚</p><ul><li>Koordlet è´Ÿè´£åˆ›å»º&#x2F;æ›´æ–° NodeResourceTopology</li><li>å»ºè®® Koordlet é€šè¿‡è§£æ <code>/var/lib/kubelet/cpu_manager_state</code> æ–‡ä»¶æ¥è·å–ç°æœ‰ Guaranteed Pod çš„ CPU åˆ†é…ä¿¡æ¯ã€‚æˆ–è€…é€šè¿‡ Kubelet æä¾›çš„ CRI æ¥å£å’Œ gRPC è·å–è¿™äº›ä¿¡æ¯</li><li>å½“ Koord-scheduler åˆ†é… Pod çš„ CPU æ—¶ï¼Œæ›¿æ¢ Kubelet çŠ¶æ€æ£€æŸ¥ç‚¹æ–‡ä»¶ä¸­çš„ CPU</li><li>å»ºè®® Koordlet ä» <a href="https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/">kubeletConfiguration</a> è·å– CPU Manager ç­–ç•¥å’Œé€‰é¡¹</li></ul><p><strong>NRI é‡æ„è®¾è®¡</strong></p><p>Koordinator ç¤¾åŒºæœ‰è®¡åˆ’å°† CRI proxy çš„å¢å¼ºæ–¹æ¡ˆä»¥ NRI ç†å¿µé‡æ„ï¼š<a href="https://github.com/koordinator-sh/koordinator/blob/main/docs/proposals/20230608-nri-mode-resource-management.md%E3%80%82">https://github.com/koordinator-sh/koordinator/blob/main/docs/proposals/20230608-nri-mode-resource-management.mdã€‚</a></p><p>ä¸ standalone å’Œ proxy ä¸åŒï¼ŒKoodlet å°†å¯åŠ¨ä¸€ä¸ª NRI æ’ä»¶ä» CRI è¿è¡Œæ—¶è®¢é˜… Pod&#x2F;å®¹å™¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç„¶å Koordlet NRI æ’ä»¶å°†è°ƒç”¨è¿è¡Œæ—¶ hook æ¥è°ƒæ•´ Pod èµ„æºæˆ– OCI è§„èŒƒã€‚æµç¨‹å¤§è‡´ä¸ºï¼š</p><ol><li>ä» CRI è¿è¡Œæ—¶è·å– Pod&#x2F;å®¹å™¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å’Œ OCI æ ¼å¼ä¿¡æ¯</li><li>å°† OCI æ ¼å¼ä¿¡æ¯è½¬æ¢ä¸ºå†…éƒ¨åè®®ï¼Œä»¥é‡ç”¨ç°æœ‰çš„è¿è¡Œæ—¶ hook æ’ä»¶</li><li>å°†è¿è¡Œæ—¶ hook æ’ä»¶çš„å“åº”è½¬æ¢ä¸º OCI è§„èŒƒæ ¼å¼</li><li>å°† OCI è§„èŒƒæ ¼å¼å“åº”è¿”å›åˆ° CRI è¿è¡Œæ—¶</li></ol><div align=center><img width="700" style="border: 0px" src="/gallery/koordinator/nri-proposal.png"></div><h2 id="CRI-Resource-Manager"><a href="#CRI-Resource-Manager" class="headerlink" title="CRI Resource Manager"></a>CRI Resource Manager</h2><p><em><a href="https://github.com/intel/cri-resource-manager">https://github.com/intel/cri-resource-manager</a></em></p><div align=center><img width="400" style="border: 0px" src="/gallery/cri-resource-manager/overview.png"></div><p>CRI Resource Manager æ˜¯ CRI ä»£ç†ï¼Œä½äºå®¢æˆ·ç«¯å’Œå®é™…å®¹å™¨è¿è¡Œæ—¶å®ç°ï¼ˆContainerdã€CRI-Oï¼‰ä¹‹é—´ï¼Œç”¨äºè½¬å‘è¯·æ±‚å’Œå“åº”ã€‚ä»£ç†çš„ä¸»è¦ç›®çš„æ˜¯é€šè¿‡åœ¨è½¬å‘è¯·æ±‚ä¹‹å‰ä¿®æ”¹è¯·æ±‚æˆ–åœ¨å¤„ç†å’Œä»£ç†æœŸé—´æ‰§è¡Œä¸è¯·æ±‚ç›¸å…³çš„é¢å¤–æ“ä½œæ¥åº”ç”¨ç­–ç•¥ä»¥å°†ç¡¬ä»¶æ„ŸçŸ¥çš„èµ„æºåˆ†é…ç­–ç•¥åº”ç”¨äºç³»ç»Ÿä¸­è¿è¡Œçš„å®¹å™¨ã€‚</p><p><strong>æ¶æ„æ¦‚è¿°</strong></p><div align=center><img width="400" style="border: 0px" src="/gallery/cri-resource-manager/cri-resmgr.svg"></div><p>CRI Resource Manager å¯ä»¥é€šè¿‡åŠ è½½èŠ‚ç‚¹é™æ€é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ gRPC è¯·æ±‚ CRI Resource Manager Node Agent ç»„ä»¶åŠ¨æ€é…ç½®ã€‚ Node Agent ç»„ä»¶çš„ä¸»è¦åŠŸèƒ½æ˜¯ç»´æŠ¤èŠ‚ç‚¹çº§åˆ«æˆ–è€…å…¨å±€çº§åˆ«çš„ ConfigMapï¼Œä»¥å“åº” CRI Resource Manager çš„ gRPC è¯·æ±‚ï¼Œè¿”å›ç­–ç•¥é…ç½®ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒCRI Resource Manager æ— æ³•è·å– Pod spec ä¸­æŒ‡å®šçš„åŸå§‹å®¹å™¨èµ„æºéœ€æ±‚ã€‚å®ƒå°è¯•ä½¿ç”¨ CRI å®¹å™¨åˆ›å»ºè¯·æ±‚ä¸­çš„ç›¸å…³å‚æ•°æ¥é¢„ä¼° CPU å’Œå†…å­˜èµ„æºã€‚ä½†æ˜¯ï¼Œæ— æ³•ä½¿ç”¨è¿™äº›å‚æ•°æ¥é¢„ä¼°å…¶ä»–æ‰©å±•èµ„æºã€‚å¦‚æœæƒ³ç¡®ä¿ CRI Resource Manager ä½¿ç”¨åŸå§‹ Pod spec èµ„æºéœ€æ±‚ï¼ŒCRI Resource Manager Webhook ç»„ä»¶è´Ÿè´£å°†è¿™éƒ¨åˆ†å£°æ˜å¤åˆ¶åˆ° Pod annotations ä¸­ï¼Œç”¨äº CRI Resource Manager æ„ŸçŸ¥æ‰©å±•èµ„æºã€‚</p><p>CRI Resource Manager æä¾›äº†æä¸ºä¸°å¯Œçš„ç¡¬ä»¶æ‹“æ‰‘æ„ŸçŸ¥çš„èƒ½åŠ›ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº CPUã€å†…å­˜ã€blockIOã€RDTã€SST ç­‰ï¼›æä¾›äº† topology-awareã€static-poolsã€balloonsã€podpools ç­‰å¤šç§ç­–ç•¥ã€‚</p><p><em>CRI Resource Manager èšç„¦åœ¨èŠ‚ç‚¹çº§åˆ«çš„æ‹“æ‰‘èµ„æºç®¡ç†ï¼Œå¹¶æœªæä¾› NUMA æ‹“æ‰‘æ„ŸçŸ¥è°ƒåº¦å™¨ã€‚</em></p><p><strong>topology-aware ç­–ç•¥</strong></p><p>topology-aware ç­–ç•¥æ ¹æ®æ£€æµ‹åˆ°çš„ç¡¬ä»¶æ‹“æ‰‘è‡ªåŠ¨æ„å»ºæ± æ ‘ã€‚æ¯ä¸ªæ± éƒ½æœ‰ä¸€ç»„åˆ†é…ä¸ºå…¶èµ„æºçš„ CPU å’Œå†…å­˜åŒºåŸŸã€‚å·¥ä½œè´Ÿè½½çš„èµ„æºåˆ†é…é¦–å…ˆé€‰æ‹©æœ€é€‚åˆå·¥ä½œè´Ÿè½½èµ„æºéœ€æ±‚çš„æ± ï¼Œç„¶åä»è¯¥æ± ä¸­åˆ†é… CPU å’Œå†…å­˜ï¼š</p><ul><li>CPU å’Œå†…å­˜æ‹“æ‰‘å¯¹é½åˆ†é…ï¼Œä»¥æœ€ä¸¥æ ¼çš„å¯ç”¨å¯¹é½æ–¹å¼å°† CPU å’Œå†…å­˜åˆ†é…ç»™å·¥ä½œè´Ÿè½½</li><li>è®¾å¤‡çš„å¯¹é½åˆ†é…ï¼Œæ ¹æ®å·²åˆ†é…è®¾å¤‡çš„ä½ç½®é€‰æ‹©å·¥ä½œè´Ÿè½½æ± </li><li>CPU æ ¸å¿ƒå…±äº«åˆ†é…ï¼Œå°†å·¥ä½œè´Ÿè½½åˆ†é…ç»™æ±  CPU çš„å…±äº«å­é›†</li><li>CPU æ ¸å¿ƒç‹¬å åˆ†é…ï¼Œä»å…±äº«å­é›†ä¸­åŠ¨æ€åˆ†å‰² CPU æ ¸å¿ƒå¹¶åˆ†é…ç»™å·¥ä½œè´Ÿè½½</li><li>CPU æ ¸å¿ƒæ··åˆåˆ†é…ï¼Œå°†ç‹¬å å’Œå…±äº« CPU æ ¸å¿ƒåˆ†é…ç»™å·¥ä½œè´Ÿè½½</li><li>å‘ç°å’Œä½¿ç”¨å†…æ ¸éš”ç¦»çš„ CPU æ ¸å¿ƒ ( <a href="https://www.kernel.org/doc/html/latest/admin-guide/kernel-parameters.html#cpu-lists">isolcpus</a> )ï¼Œå°†å†…æ ¸éš”ç¦»çš„ CPU æ ¸å¿ƒç”¨äºä¸“é—¨åˆ†é…çš„ CPU æ ¸å¿ƒ</li><li>å°†åˆ†é…çš„èµ„æºæš´éœ²ç»™å·¥ä½œè´Ÿè½½</li><li>é€šçŸ¥å·¥ä½œè´Ÿè½½æœ‰å…³èµ„æºåˆ†é…çš„æ›´æ”¹</li><li>åŠ¨æ€æ”¾ç¼“å†…å­˜å¯¹é½ä»¥é˜²æ­¢ OOMï¼ŒåŠ¨æ€åŠ å®½å·¥ä½œè´Ÿè½½å†…å­˜é›†ä»¥é¿å…æ± &#x2F;å·¥ä½œè´Ÿè½½ OOM</li><li>å¤šå±‚å†…å­˜åˆ†é…ï¼šå°†å·¥ä½œè´Ÿè½½åˆ†é…åˆ°å…¶é¦–é€‰ç±»å‹çš„å†…å­˜åŒºåŸŸï¼Œè¯¥ç­–ç•¥æ„ŸçŸ¥ä¸‰ç§å†…å­˜ï¼šDRAM æ˜¯å¸¸è§„ç³»ç»Ÿä¸»å­˜å‚¨å™¨ï¼›PMEM æ˜¯å¤§å®¹é‡å†…å­˜ï¼Œä¾‹å¦‚ <a href="https://www.intel.com/content/www/us/en/products/memory-storage/optane-dc-persistent-memory.html">IntelÂ® Optaneâ„¢å†…å­˜</a>ï¼›<a href="https://en.wikipedia.org/wiki/High_Bandwidth_Memory">HBM</a> æ˜¯é«˜é€Ÿå­˜å‚¨å™¨ï¼Œé€šå¸¸å‡ºç°åœ¨ä¸€äº›ä¸“ç”¨è®¡ç®—ç³»ç»Ÿä¸Š</li><li>å†·å¯åŠ¨ï¼Œåœ¨åˆå§‹é¢„çƒ­æœŸé—´å°†å·¥ä½œè´Ÿè½½ä¸“é—¨å›ºå®šåˆ° PMEM</li><li>åŠ¨æ€é¡µé¢é™çº§ï¼Œå¼ºåˆ¶å°†åªè¯»å’Œç©ºé—²å®¹å™¨å†…å­˜é¡µè¿ç§»åˆ° PMEM</li></ul><p><strong>static-pools ç­–ç•¥</strong></p><p>static-pools ç­–ç•¥æ˜¯ <a href="https://github.com/intel/CPU-Manager-for-Kubernetes">Intel CMK </a>é¡¹ç›®çš„åŠŸèƒ½ç§»æ¤ã€‚</p><p><strong>balloons ç­–ç•¥</strong> </p><p>balloons ç­–ç•¥æ˜¯ä¸€ç§ç”¨äºç®¡ç†ç³»ç»Ÿä¸­å®¹å™¨ CPU èµ„æºåˆ†é…çš„æ–¹æ³•ã€‚å®ƒæ¶‰åŠå°†å¯ç”¨çš„ CPU åˆ’åˆ†ä¸ºç›¸äº’ç‹¬ç«‹çš„æ± ï¼Œç§°ä¸º balloonï¼Œæ¯ä¸ª balloon å¯ä»¥æ ¹æ®å®¹å™¨çš„èµ„æºè¯·æ±‚è¿›è¡Œæ‰©å¤§æˆ–ç¼©å°ï¼Œå³å¯ä»¥å¢åŠ æˆ–å‡å°‘å…¶ä¸­çš„ CPU æ•°é‡ã€‚</p><p>balloon å¯ä»¥æ˜¯é™æ€çš„æˆ–åŠ¨æ€çš„ã€‚é™æ€ balloon éœ€è¦æ‰‹åŠ¨åˆ›å»ºå¹¶ä¿æŒå›ºå®šçš„å¤§å°ï¼Œè€ŒåŠ¨æ€ balloon åˆ™å¯ä»¥æ ¹æ®å®¹å™¨çš„èµ„æºéœ€æ±‚è‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯ã€‚è¿™å¯ä»¥å®ç°æ›´é«˜æ•ˆçš„èµ„æºåˆ©ç”¨ï¼Œå› ä¸º balloon å¯ä»¥å®æ—¶è°ƒæ•´ä»¥æ»¡è¶³ä¸æ–­å˜åŒ–çš„éœ€æ±‚ã€‚</p><p>é™¤äº†æ§åˆ¶æ¯ä¸ª balloon ä¸­ CPU æ•°é‡å¤–ï¼Œballoon è¿˜å¯ä»¥é…ç½®ç‰¹å®šçš„è®¾ç½®ï¼Œä¾‹å¦‚ CPU æ ¸å¿ƒå’Œéæ ¸å¿ƒçš„æœ€å°å’Œæœ€å¤§é¢‘ç‡ã€‚è¿™å¯ä»¥å¯¹ CPU èµ„æºçš„åˆ†é…è¿›è¡Œç²¾ç»†æ§åˆ¶ï¼Œç¡®ä¿æ¯ä¸ªå®¹å™¨éƒ½åˆ†é…äº†å…¶è¿è¡Œæ‰€éœ€çš„èµ„æºã€‚</p><p>å¤§è‡´æµç¨‹ä¸ºï¼š</p><ol><li>ç”¨æˆ·å¯ä»¥é…ç½®ä¸åŒç±»å‹çš„ balloonï¼Œç­–ç•¥å¯ä»¥æ ¹æ®è¿™äº›é…ç½®å®ä¾‹åŒ– balloon</li><li>balloon æœ‰ä¸€ç»„ CPU å’Œä¸€ç»„åœ¨ CPU ä¸Šè¿è¡Œçš„å®¹å™¨</li><li>æ¯ä¸ªå®¹å™¨éƒ½è¢«åˆ†é…ç»™ä¸€ä¸ª balloonã€‚å®¹å™¨å¯ä»¥ä½¿ç”¨å…¶ balloon çš„æ‰€æœ‰ CPUï¼Œè€Œä¸èƒ½ä½¿ç”¨å…¶ä»– CPU</li><li>æ¯ä¸ªé€»è¾‘ CPU æœ€å¤šå±äºä¸€ä¸ª balloonï¼Œä¹Ÿå¯èƒ½å­˜åœ¨ä¸å±äºä»»ä½• balloon çš„ CPU</li><li>balloon ä¸­çš„ CPU æ•°é‡åœ¨ balloon çš„ç”Ÿå‘½å‘¨æœŸå†…å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚å¦‚æœ balloon è†¨èƒ€ï¼Œä¹Ÿå°±æ˜¯å¢åŠ äº† CPUï¼Œé‚£ä¹ˆ balloon ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥ä½¿ç”¨æ›´å¤šçš„ CPUï¼Œåä¹‹äº¦ç„¶</li><li>å½“åœ¨ Kubernetes èŠ‚ç‚¹ä¸Šåˆ›å»ºæ–°å®¹å™¨æ—¶ï¼Œç­–ç•¥é¦–å…ˆå†³å®šå°†è¿è¡Œè¯¥å®¹å™¨çš„ balloon çš„ç±»å‹ã€‚è¯¥å†³å®šåŸºäº Pod annotationsï¼Œæˆ–è€…å¦‚æœæœªç»™å‡º annotations åˆ™åŸºäºå‘½åç©ºé—´</li><li>æ¥ä¸‹æ¥ï¼Œç­–ç•¥å†³å®šå“ªä¸ª balloon å°†è¿è¡Œå®¹å™¨ã€‚é€‰é¡¹æœ‰ï¼š<ul><li>ç°æœ‰çš„ balloon å·²ç»æœ‰è¶³å¤Ÿçš„ CPU æ¥è¿è¡Œå½“å‰å’Œæ–°çš„å®¹å™¨</li><li>ç°æœ‰çš„ balloon å¯ä»¥æ‰©å¤§ä»¥é€‚åº”å…¶å½“å‰å’Œæ–°çš„å®¹å™¨</li><li>æ–° balloon</li></ul></li><li>å½“å‘ balloon æ·»åŠ æˆ–ä»å…¶ä¸­ç§»é™¤ CPU æ—¶ï¼Œä¼šæ ¹æ® balloon çš„ CPU ç±»å±æ€§æˆ–ç©ºé—² CPU ç±»å±æ€§é‡æ–°é…ç½® CPU</li></ol><p><strong>podpools ç­–ç•¥</strong></p><p>podpools ç­–ç•¥å®ç° Pod çº§åˆ«çš„å·¥ä½œè´Ÿè½½æ”¾ç½®ã€‚å®ƒå°† Pod çš„æ‰€æœ‰å®¹å™¨åˆ†é…åˆ°åŒä¸€ä¸ª CPU&#x2F;å†…å­˜æ± ã€‚æ± ä¸­çš„ CPU æ•°é‡å¯ç”±ç”¨æˆ·é…ç½®ã€‚</p><p><strong>å®¹å™¨äº²å’Œä¸åäº²å’Œ</strong></p><p>äº²å’Œä¸åäº²å’Œçš„æç¤ºæ˜¯é€šè¿‡ Pod annotations å£°æ˜ï¼š</p><ul><li>åŒä¸€ NUMA èŠ‚ç‚¹å†…çš„ CPU è§†ä¸ºå½¼æ­¤äº²å’Œ</li><li>åŒä¸€ socket ä¸­ä¸åŒ NUMA èŠ‚ç‚¹å†…çš„ CPUï¼Œä»¥åŠä¸åŒ socket å†…çš„ CPU è§†ä¸ºå½¼æ­¤åäº²å’Œ</li></ul><p><strong>blockIO</strong></p><p>blockIO æä¾›ä»¥ä¸‹æ§åˆ¶ï¼š</p><ul><li>å—è®¾å¤‡ IO è°ƒåº¦ä¼˜å…ˆçº§ï¼ˆæƒé‡ï¼‰</li><li>é™åˆ¶ IO å¸¦å®½</li><li>é™åˆ¶ IO æ“ä½œçš„æ•°é‡</li></ul><p>CRI Resource Manager é€šè¿‡ cgroups blockIO æ§åˆ¶å™¨å°† blockIO çš„ç›¸å…³å‚æ•°åº”ç”¨äº Podã€‚</p><h2 id="Volcano"><a href="#Volcano" class="headerlink" title="Volcano"></a>Volcano</h2><p><em><a href="https://github.com/volcano-sh/volcano">https://github.com/volcano-sh/volcano</a></em></p><div align=center><img width="600" style="border: 0px" src="/gallery/volcano/overview.png"></div><p>Volcano æ˜¯ CNCF ä¸‹é¦–ä¸ªä¹Ÿæ˜¯å”¯ä¸€çš„åŸºäº Kubernetes çš„å®¹å™¨æ‰¹é‡è®¡ç®—å¹³å°ï¼Œä¸»è¦ç”¨äºé«˜æ€§èƒ½è®¡ç®—åœºæ™¯ã€‚å®ƒæä¾›äº† Kubernetes ç›®å‰ç¼ºå°‘çš„ä¸€å¥—æœºåˆ¶ï¼Œè¿™äº›æœºåˆ¶é€šå¸¸æ˜¯æœºå™¨å­¦ä¹ å¤§æ•°æ®åº”ç”¨ã€ç§‘å­¦è®¡ç®—ã€ç‰¹æ•ˆæ¸²æŸ“ç­‰å¤šç§é«˜æ€§èƒ½å·¥ä½œè´Ÿè½½æ‰€éœ€çš„ã€‚ä½œä¸ºä¸€ä¸ªé€šç”¨æ‰¹å¤„ç†å¹³å°ï¼ŒVolcano ä¸å‡ ä¹æ‰€æœ‰çš„ä¸»æµè®¡ç®—æ¡†æ¶æ— ç¼å¯¹æ¥ï¼Œå¦‚Sparkã€TensorFlow ã€PyTorchã€ Flink ã€Argo ã€MindSpore ã€ PaddlePaddle ç­‰ã€‚å®ƒè¿˜æä¾›äº†åŒ…æ‹¬åŸºäºå„ç§ä¸»æµæ¶æ„çš„ CPUã€GPU åœ¨å†…çš„å¼‚æ„è®¾å¤‡æ··åˆè°ƒåº¦èƒ½åŠ›ã€‚Volcano çš„è®¾è®¡ç†å¿µå»ºç«‹åœ¨ 15 å¹´æ¥å¤šç§ç³»ç»Ÿå’Œå¹³å°å¤§è§„æ¨¡è¿è¡Œå„ç§é«˜æ€§èƒ½å·¥ä½œè´Ÿè½½çš„ä½¿ç”¨ç»éªŒä¹‹ä¸Šï¼Œå¹¶ç»“åˆæ¥è‡ªå¼€æºç¤¾åŒºçš„æœ€ä½³æ€æƒ³å’Œå®è·µã€‚</p><p><strong>æ„ŸçŸ¥è°ƒåº¦æµç¨‹</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/volcano/numa-aware-process.png"></div><table><thead><tr><th>policy</th><th>action</th></tr></thead><tbody><tr><td>none</td><td>æ— </td></tr><tr><td>best-effort</td><td>è¿‡æ»¤å‡ºæ‹“æ‰‘ç­–ç•¥ä¸º best-effort çš„èŠ‚ç‚¹</td></tr><tr><td>restricted</td><td>è¿‡æ»¤å‡ºæ‹“æ‰‘ç­–ç•¥ä¸º restricted ä¸”æ»¡è¶³ CPU æ‹“æ‰‘è¦æ±‚çš„èŠ‚ç‚¹</td></tr><tr><td>single-numa-node</td><td>è¿‡æ»¤å‡ºæ‹“æ‰‘ç­–ç•¥ä¸º single-numa-node ä¸”æ»¡è¶³ CPU æ‹“æ‰‘è¦æ±‚çš„èŠ‚ç‚¹</td></tr></tbody></table><p>Volcano åœ¨çš„æ„ŸçŸ¥è°ƒåº¦å’Œå…¶ä»–é¡¹ç›®ç±»ä¼¼ï¼Œå°† Kubernetes Topology Manager çš„åŸç”Ÿç­–ç•¥æ‰©å±•è‡³è°ƒåº¦å™¨å±‚é¢ï¼Œåªä¸è¿‡ CRD é‡‡ç”¨çš„æ˜¯ Volcano è®¾è®¡çš„ <a href="https://github.com/volcano-sh/apis/blob/master/pkg/apis/nodeinfo/v1alpha1/numatopo_types.go">Numatopology</a>ï¼Œè€Œéç¤¾åŒºæå‡ºçš„ NodeResourceTopology CRDï¼Œå…¶ä»–æµç¨‹æ–¹é¢å¤§åŒå°å¼‚ã€‚</p><p><strong>èŠ‚ç‚¹ CPU ç¼–æ’</strong></p><p>Volcano å¹¶æœªæä¾›èŠ‚ç‚¹ CPU ç¼–æ’çš„èƒ½åŠ›ï¼Œä½†æ˜¯å‚è€ƒåä¸º CCE äº§å“æ–‡æ¡£ä¸­ï¼ŒCCE åŸºäºç¤¾åŒºåŸç”Ÿçš„ CPU Manager ç­–ç•¥çš„åŸºç¡€ä¸Šï¼Œæå‡ºäº† enhanced-static ç­–ç•¥ï¼Œæ˜¯åœ¨å…¼å®¹ static ç­–ç•¥çš„åŸºç¡€ä¸Šï¼Œæ–°å¢ä¸€ç§ç¬¦åˆæŸäº›èµ„æºç‰¹å¾çš„ Burstable Podï¼ˆCPU çš„ requests å’Œ limits å€¼éƒ½æ˜¯æ­£æ•´æ•°ï¼‰ä¼˜å…ˆä½¿ç”¨æŸäº› CPU çš„èƒ½åŠ›ï¼Œä»¥å‡å°‘åº”ç”¨åœ¨å¤šä¸ª CPU é—´é¢‘ç¹åˆ‡æ¢å¸¦æ¥çš„å½±å“ã€‚</p><p>è¯¥ç‰¹æ€§æ˜¯åŸºäº Huawei Cloud EulerOS 2.0 å†…æ ¸ä¸­ä¼˜åŒ–äº† CPU è°ƒåº¦èƒ½åŠ›å®ç°çš„ã€‚åœ¨ Pod å®¹å™¨ä¼˜å…ˆä½¿ç”¨çš„ CPU åˆ©ç”¨ç‡è¶…è¿‡ 85% æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ†é…åˆ°å…¶ä»–åˆ©ç”¨ç‡è¾ƒä½çš„ CPU ä¸Šï¼Œè¿›è€Œä¿éšœäº†åº”ç”¨çš„å“åº”èƒ½åŠ›ã€‚</p><div align=center><img width="500" style="border: 0px" src="/gallery/volcano/enhanced-static.png"></div><ul><li>å¼€å¯ enhanced-static ç­–ç•¥æ—¶ï¼Œåº”ç”¨æ€§èƒ½ä¼˜äº none ç­–ç•¥ï¼Œä½†å¼±äº static ç­–ç•¥</li><li>åº”ç”¨åˆ†é…çš„ä¼˜å…ˆä½¿ç”¨çš„ CPU å¹¶ä¸ä¼šè¢«ç‹¬å ï¼Œä»å¤„äºå…±äº«çš„ CPU æ± ä¸­ã€‚å› æ­¤åœ¨è¯¥ Pod å¤„äºä¸šåŠ¡æ³¢è°·æ—¶ï¼ŒèŠ‚ç‚¹ä¸Šå…¶ä»– Pod å¯ä½¿ç”¨è¯¥éƒ¨åˆ† CPU èµ„æº</li></ul><h1 id="å®è·µéªŒè¯"><a href="#å®è·µéªŒè¯" class="headerlink" title="å®è·µéªŒè¯"></a>å®è·µéªŒè¯</h1><p><em>ä»¥ cri-resource-managerä¸ºä¾‹</em></p><blockquote><p>based on <strong>v0.8.3</strong></p></blockquote><p><strong>æœåŠ¡å®‰è£…</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… cri-resource-manager æœåŠ¡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">yum -y install https://github.com/intel/cri-resource-manager/releases/download/v0.8.3/cri-resource-manager-0.8.3-0.centos-7.x86_64.rpm</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… cri-resmgr-agent æœåŠ¡ï¼ˆéœ€è¦æ‰‹åŠ¨ç¼–è¯‘å¹¶æ›¿æ¢ IMAGE_PLACEHOLDER å ä½ç¬¦ï¼Œè¿™é‡Œä¸åšè¯¦è¿°ï¼‰</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f https://raw.githubusercontent.com/intel/cri-resource-manager/master/cmd/cri-resmgr-agent/agent-deployment.yaml</span></span><br></pre></td></tr></table></figure><p><strong>å®‰è£…ç»“æœ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl start cri-resource-manager</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl status cri-resource-manager</span></span><br><span class="line">â— cri-resource-manager.service - A CRI proxy with (hardware) resource aware container placement policies.</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/cri-resource-manager.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Mon 2023-06-28 16:26:04 CST; 29min ago</span><br><span class="line">     Docs: https://github.com/intel/cri-resource-manager</span><br><span class="line"> Main PID: 32130 (cri-resmgr)</span><br><span class="line">    Tasks: 49</span><br><span class="line">   Memory: 41.6M</span><br><span class="line">   CGroup: /system.slice/cri-resource-manager.service</span><br><span class="line">           â””â”€32130 /usr/bin/cri-resmgr --fallback-config /etc/cri-resmgr/fallback.cfg</span><br><span class="line">           </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get ds -A</span></span><br><span class="line">NAMESPACE            NAME                  DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br><span class="line">kube-system          cri-resmgr-agent      1         1         1       1            1           &lt;none&gt;                   11m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡‡ç”¨ cri-resmgr-agent ç»´æŠ¤çš„åŠ¨æ€é…ç½®ï¼Œé‡‡ç”¨ topology-aware ç­–ç•¥</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">èŠ‚ç‚¹å…¨é‡çš„ CPU ä¸º 0-47</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- 0-4 ç”¨äºé Kubernetes å¹³å°ä½¿ç”¨ï¼Œå¦‚èŠ‚ç‚¹ç³»ç»ŸæœåŠ¡ç­‰</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- AvailableResources ä¸­çš„ 5-47 å· CPU ç”¨äº Kubernetes å¹³å°ä½¿ç”¨</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - ReservedResources 5-10 å· CPU ç”¨äº Kubernetes çš„é¢„ç•™å‘½åç©ºé—´ä¸‹çš„æœåŠ¡ä½¿ç”¨</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - å‰©ä½™çš„ 10-47 å· CPU ç”¨äº Kubernetes çš„å…¶ä»–å‘½åç©ºé—´ä¸‹çš„æœåŠ¡ä½¿ç”¨</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get cm -n kube-system cri-resmgr-config.node.node1 -o yaml</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  policy: |</span><br><span class="line">    Active: topology-aware</span><br><span class="line">    topology-aware:</span><br><span class="line">      ReservedPoolNamespaces: [kube-system,arsdn,secboat]</span><br><span class="line">    ReservedResources:</span><br><span class="line">      cpu: cpuset:5-10</span><br><span class="line">    AvailableResources:</span><br><span class="line">      cpu: cpuset:5-47</span><br><span class="line">kind: ConfigMap</span><br></pre></td></tr></table></figure><p><strong>æœåŠ¡é…ç½®</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é…ç½® Kubelet çš„ CRI endpoint ä¸º cri-resmgr.sock</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env</span></span><br><span class="line">KUBELET_KUBEADM_ARGS=&quot;--container-runtime=remote --container-runtime-endpoint=unix:///var/run/cri-resmgr/cri-resmgr.sock&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/kubernetes/kubelet.env</span></span><br><span class="line">...</span><br><span class="line">KUBELET_ARGS=&quot;--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf \</span><br><span class="line">--config=/etc/kubernetes/kubelet-config.yaml \</span><br><span class="line">--kubeconfig=/etc/kubernetes/kubelet.conf \</span><br><span class="line">--log-dir=/var/log/kubelet \</span><br><span class="line">--log-file=/var/log/kubelet/kubelet.log \</span><br><span class="line">--logtostderr=false \</span><br><span class="line">--alsologtostderr=false \</span><br><span class="line">--feature-gates=CSIInlineVolume=true,CSIVolumeHealth=true,CPUManagerPolicyOptions=true \</span><br><span class="line">--pod-infra-container-image=harbor.archeros.cn:443/library/ake/pause:3.5-amd64 \</span><br><span class="line">--container-runtime=remote \</span><br><span class="line">--runtime-request-timeout=15m \</span><br><span class="line">--container-runtime-endpoint=unix:///var/run/cri-resmgr/cri-resmgr.sock \</span><br><span class="line">--runtime-cgroups=/systemd/system.slice \</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl daemon-reload &amp;&amp; systemctl restart kubelet</span></span><br></pre></td></tr></table></figure><p><strong>èŠ‚ç‚¹ CPU ç¼–æ’</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">numactl -H</span></span><br><span class="line">available: 2 nodes (0-1)</span><br><span class="line">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 24 25 26 27 28 29 30 31 32 33 34 35</span><br><span class="line">node 0 size: 65413 MB</span><br><span class="line">node 0 free: 15969 MB</span><br><span class="line">node 1 cpus: 12 13 14 15 16 17 18 19 20 21 22 23 36 37 38 39 40 41 42 43 44 45 46 47</span><br><span class="line">node 1 size: 65536 MB</span><br><span class="line">node 1 free: 21933 MB</span><br><span class="line">node distances:</span><br><span class="line">node   0   1</span><br><span class="line">  0:  10  21</span><br><span class="line">  1:  21  10</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éƒ¨ç½²å…±äº« CPU çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f besteffort.yaml &amp;&amp; kubectl apply -f busterable.yaml &amp;&amp; kubectl apply -f guaranteed.yaml</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ CPU åˆ†é…æƒ…å†µï¼šå…±äº«ä¸€ä¸ªåˆé€‚çš„ NUMA node</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps | grep besteffort | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs crictl inspect | grep <span class="string">&quot;\&quot;cpus\&quot;:&quot;</span></span></span><br><span class="line">            &quot;cpus&quot;: &quot;12-23,36-47&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps | grep busterable | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs crictl inspect | grep <span class="string">&quot;\&quot;cpus\&quot;:&quot;</span></span></span><br><span class="line">            &quot;cpus&quot;: &quot;12-23,36-47&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps | grep guaranteed | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs crictl inspect | grep <span class="string">&quot;\&quot;cpus\&quot;:&quot;</span></span></span><br><span class="line">            &quot;cpus&quot;: &quot;12-23,36-47&quot;,           </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éƒ¨ç½²ç‹¬å  CPU çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f guaranteed-exclusive.yaml</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ CPU åˆ†é…æƒ…å†µï¼šç‹¬å åŒä¸€ç‰©ç†æ ¸å¿ƒçš„ä¸¤ä¸ªé€»è¾‘æ ¸å¿ƒ</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps | grep guaranteed-exclusive | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs crictl inspect | grep <span class="string">&quot;\&quot;cpus\&quot;:&quot;</span></span></span><br><span class="line">            &quot;cpus&quot;: &quot;23,47&quot;,</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹çƒ­æ›´æ–°ï¼Œå…±äº« CPU ä¸­å°†ç‹¬å çš„ CPU æ‰£é™¤</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps | grep besteffort | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs crictl inspect | grep <span class="string">&quot;\&quot;cpus\&quot;:&quot;</span></span></span><br><span class="line">            &quot;cpus&quot;: &quot;12-22,36-46&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps | grep busterable | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs crictl inspect | grep <span class="string">&quot;\&quot;cpus\&quot;:&quot;</span></span></span><br><span class="line">            &quot;cpus&quot;: &quot;12-22,36-46&quot;,</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps | grep guaranteed | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs crictl inspect | grep <span class="string">&quot;\&quot;cpus\&quot;:&quot;</span></span></span><br><span class="line">            &quot;cpus&quot;: &quot;12-22,36-46&quot;,</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é¢„ç•™ namespace CPU åˆ†é…</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f reserved.yaml</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl ps | grep reserved | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs crictl inspect | grep <span class="string">&quot;\&quot;cpus\&quot;:&quot;</span></span></span><br><span class="line">            &quot;cpus&quot;: &quot;5-10&quot;,</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Kubernetes NUMA æ„ŸçŸ¥è°ƒåº¦ä¸èŠ‚ç‚¹ CPU ç¼–æ’æ–¹æ¡ˆçš„æ¢ç´¢ä¸ä¼˜åŒ–</summary>
    
    
    
    <category term="Scheduling &amp; Orchestration" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/"/>
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/Kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kubernetes ã€èŠ‚ç‚¹èµ„æºè¶…å–</title>
    <link href="http://shenxianghong.github.io/2023/06/13/2023-06-13%20Kubernetes%20%E8%8A%82%E7%82%B9%E8%B5%84%E6%BA%90%E8%B6%85%E5%8D%96/"/>
    <id>http://shenxianghong.github.io/2023/06/13/2023-06-13%20Kubernetes%20%E8%8A%82%E7%82%B9%E8%B5%84%E6%BA%90%E8%B6%85%E5%8D%96/</id>
    <published>2023-06-12T16:00:00.000Z</published>
    <updated>2023-07-10T05:23:25.847Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kubernetes/logo.svg"></div><hr><blockquote><p>based on <strong>v1.24.10</strong></p></blockquote><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Kubernetes è®¾è®¡åŸè¯­ä¸­ï¼ŒPod å£°æ˜çš„ spec.resources.requests ç”¨äºæè¿°å®¹å™¨æ‰€éœ€èµ„æºçš„æœ€å°è§„æ ¼ï¼ŒKube-scheduler ä¼šæ ¹æ®èµ„æºè¯·æ±‚é‡æ‰§è¡Œè°ƒåº¦æµç¨‹ï¼Œå¹¶åœ¨èŠ‚ç‚¹èµ„æºè§†å›¾ä¸­æ‰£é™¤ï¼›spec.resources.limits ç”¨äºé™åˆ¶å®¹å™¨èµ„æºæœ€å¤§ä½¿ç”¨é‡ï¼Œé¿å…å®¹å™¨æœåŠ¡ä½¿ç”¨è¿‡å¤šçš„èµ„æºå¯¼è‡´èŠ‚ç‚¹æ€§èƒ½ä¸‹é™æˆ–å´©æºƒã€‚Kubelet é€šè¿‡å‚è€ƒ Pod çš„ QoS ç­‰çº§æ¥ç®¡ç†å®¹å™¨çš„èµ„æºè´¨é‡ï¼Œä¾‹å¦‚ OOM ä¼˜å…ˆçº§æ§åˆ¶ç­‰ã€‚Pod çš„ QoS çº§åˆ«åˆ†ä¸º Guaranteedã€Burstable å’Œ BestEffortï¼ŒQoS çº§åˆ«å¹¶ä¸æ˜¯æ˜¾å¼å®šä¹‰ï¼Œè€Œæ˜¯å–å†³äº Pod å£°æ˜çš„ spec.resources.requests å’Œ spec.resources.limits ä¸­ CPU ä¸å†…å­˜ã€‚</p><p>è€Œåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†æé«˜ç¨³å®šæ€§ï¼Œåº”ç”¨ç®¡ç†å‘˜åœ¨æäº¤ Guaranteed å’Œ Burstable è¿™ä¸¤ç±» QoS Pod æ—¶ä¼šé¢„ç•™ç›¸å½“æ•°é‡çš„èµ„æºç¼“å†²æ¥åº”å¯¹ä¸Šä¸‹æ¸¸é“¾è·¯çš„è´Ÿè½½æ³¢åŠ¨ï¼Œåœ¨å¤§éƒ¨åˆ†æ—¶é—´æ®µï¼ŒæœåŠ¡çš„èµ„æºè¯·æ±‚é‡ä¼šè¿œé«˜äºå®é™…çš„èµ„æºä½¿ç”¨ç‡ã€‚</p><div align=center><img width="600" style="border: 0px" src="/gallery/overcommitted/twitter.png"></div><p>ä¸ºäº†æå‡é›†ç¾¤èµ„æºåˆ©ç”¨ç‡ï¼Œåº”ç”¨ç®¡ç†å‘˜ä¼šæäº¤ä¸€äº› BestEffort QoS çš„ä½ä¼˜ä»»åŠ¡ï¼Œæ¥å……åˆ†ä½¿ç”¨é‚£äº›å·²åˆ†é…ä½†æœªä½¿ç”¨çš„èµ„æºã€‚å³åŸºäº Pod QoS çš„æœåŠ¡æ··éƒ¨ï¼ˆco-locationï¼‰ä»¥å®ç° Kubernetes èŠ‚ç‚¹èµ„æºçš„è¶…å–ï¼ˆovercommittedï¼‰ã€‚</p><div align=center><img width="500" style="border: 0px" src="/gallery/overcommitted/overcommitted.png"></div><p>è¿™ç§ç­–ç•¥å¸¸ç”¨äºå®¹å™¨æœåŠ¡å¹³å°çš„åœ¨ç¦»çº¿ä¸šåŠ¡æ··éƒ¨ï¼Œä½†æ˜¯è¿™ç§åŸºç¡€çš„æ··éƒ¨æ–¹æ¡ˆå­˜åœ¨ä¸€äº›å¼Šç«¯ï¼š</p><ul><li>æ··éƒ¨ä¼šå¸¦æ¥åº•å±‚å…±äº«èµ„æºï¼ˆCPUã€å†…å­˜ã€ç½‘ç»œã€ç£ç›˜ç­‰ï¼‰çš„ç«äº‰ï¼Œä¼šå¯¼è‡´åœ¨çº¿ä¸šåŠ¡æ€§èƒ½ä¸‹é™ï¼Œå¹¶ä¸”è¿™ç§ä¸‹é™æ˜¯ä¸å¯é¢„æµ‹çš„</li><li>èŠ‚ç‚¹å¯å®¹çº³ä½ä¼˜ä»»åŠ¡çš„èµ„æºé‡æ²¡æœ‰ä»»ä½•å‚è€ƒï¼Œå³ä½¿èŠ‚ç‚¹å®é™…è´Ÿè½½å·²ç»å¾ˆé«˜ï¼Œç”±äº BestEffort ä»»åŠ¡åœ¨èµ„æºè§„æ ¼ä¸Šç¼ºå°‘å®¹é‡çº¦æŸï¼Œä»ç„¶ä¼šè¢«è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šè¿è¡Œ</li><li>BestEffort ä»»åŠ¡é—´ç¼ºä¹å…¬å¹³æ€§ä¿è¯ï¼Œä»»åŠ¡èµ„æºè§„æ ¼å­˜åœ¨åŒºåˆ«ï¼Œä½†æ— æ³•åœ¨ Pod æè¿°ä¸Šä½“ç°</li></ul><h1 id="è®¾è®¡æ€è€ƒ"><a href="#è®¾è®¡æ€è€ƒ" class="headerlink" title="è®¾è®¡æ€è€ƒ"></a>è®¾è®¡æ€è€ƒ</h1><p>åœ¨åŸºäº Pod QoS æ··éƒ¨å®ç°çš„ Kubernetes èŠ‚ç‚¹èµ„æºè¶…å–æ–¹æ¡ˆä¸­ï¼Œæ‰€è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯å¦‚ä½•å……åˆ†åˆç†çš„åˆ©ç”¨ç¼“å†²èµ„æºï¼Œå³ request buffer ä¸ limit bufferã€‚</p><p>å…¶ä¸­ï¼Œlimit buffer åœ¨ Kubernetes è®¾è®¡ä¸­å¤©ç„¶æ”¯æŒè¶…å–ï¼ŒPod åœ¨å£°æ˜ spec.resources.limits æ—¶ï¼Œä¸å—é›†ç¾¤å‰©ä½™èµ„æºçš„å½±å“ï¼Œé›†ç¾¤ä¸­ Pod limits ä¹‹å’Œä¹Ÿå­˜åœ¨è¶…å‡ºèŠ‚ç‚¹èµ„æºå®¹é‡çš„æƒ…å†µï¼Œlimit buffer éƒ¨åˆ†çš„èµ„æºæ˜¯å…±äº«æŠ¢å çš„ï¼›è€Œ request buffer éƒ¨åˆ†çš„èµ„æºæ˜¯é€»è¾‘ç‹¬å çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ spec.resources.requests çš„å¤§å°ä¼šå†³å®š Pod èƒ½å¦è°ƒåº¦ï¼Œè¿›è€Œç›´æ¥å½±å“åˆ°èŠ‚ç‚¹èµ„æºçš„ä½¿ç”¨ç‡ã€‚</p><p>å› æ­¤ï¼ŒèŠ‚ç‚¹èµ„æºè¶…å–ç†å¿µæ›´å¤šçš„æ˜¯å¯¹ request buffer å¦‚ä½•å……åˆ†åˆ©ç”¨çš„æ€è€ƒã€‚</p><h2 id="èµ„æºå›æ”¶ä¸è¶…å–"><a href="#èµ„æºå›æ”¶ä¸è¶…å–" class="headerlink" title="èµ„æºå›æ”¶ä¸è¶…å–"></a>èµ„æºå›æ”¶ä¸è¶…å–</h2><p>èµ„æºå›æ”¶æ˜¯æŒ‡å›æ”¶ä¸šåŠ¡åº”ç”¨å·²ç”³è¯·çš„ï¼Œç›®å‰è¿˜å¤„äºç©ºé—²çš„èµ„æºï¼Œå°†å…¶ç»™ä½ä¼˜ä¸šåŠ¡ä½¿ç”¨ã€‚ä½†æ˜¯è¿™éƒ¨åˆ†èµ„æºæ˜¯ä½è´¨é‡çš„ï¼Œä¸å…·å¤‡å¤ªé«˜çš„å¯ç”¨æ€§ä¿è¯ã€‚</p><div align=center><img width="600" style="border: 0px" src="/gallery/overcommitted/reclaim.png"></div><p>å¦‚å›¾æ‰€ç¤ºï¼Œreclaimed èµ„æºä»£è¡¨å¯åŠ¨æ€è¶…å–çš„èµ„æºé‡ï¼Œè¿™éƒ¨åˆ†éœ€è¦æ ¹æ®èŠ‚ç‚¹çœŸå®è´Ÿè½½æƒ…å†µåŠ¨æ€æ›´æ–°ï¼Œå¹¶ä»¥æ ‡å‡†æ‰©å±•èµ„æºçš„å½¢å¼å®æ—¶æ›´æ–°åˆ° Kubernetes çš„ Node å…ƒä¿¡æ¯ä¸­ã€‚ä½ä¼˜ä»»åŠ¡å¯ä»¥é€šè¿‡åœ¨ spec.resources.requests å’Œ spec.resources.limits ä¸­å®šä¹‰çš„ reclaimed èµ„æºé…ç½®æ¥ä½¿ç”¨è¿™éƒ¨åˆ†èµ„æºï¼Œè¿™éƒ¨åˆ†é…ç½®åŒæ—¶ä¹Ÿä¼šä½“ç°åœ¨èŠ‚ç‚¹ä¾§çš„èµ„æºé™åˆ¶å‚æ•°ä¸Šï¼Œä¿è¯ä½ä¼˜ä½œä¸šä¹‹é—´çš„å…¬å¹³æ€§ã€‚</p><p>å¯å›æ”¶èµ„æºçš„æ¨å¯¼å…¬å¼å¤§è‡´å¦‚ä¸‹ï¼š</p><blockquote><p>reclaimed &#x3D; nodeAllocatable * thresholdPercent - podUsage - systemUsage</p></blockquote><ul><li><em>nodeAllocatable â€” èŠ‚ç‚¹å¯åˆ†é…èµ„æºæ€»é‡</em></li><li><em>thresholdPercent â€” é¢„ç•™æ°´ä½æ¯”ä¾‹</em></li><li><em>podUsage â€” é«˜ä¼˜ä»»åŠ¡ Pod çš„èµ„æºä½¿ç”¨é‡</em></li><li><em>systemUsage â€” ç³»ç»Ÿèµ„æºçœŸå®ä½¿ç”¨é‡</em></li></ul><h2 id="å¼¹æ€§èµ„æºé™åˆ¶"><a href="#å¼¹æ€§èµ„æºé™åˆ¶" class="headerlink" title="å¼¹æ€§èµ„æºé™åˆ¶"></a>å¼¹æ€§èµ„æºé™åˆ¶</h2><p>åŸç”Ÿçš„ BestEffort åº”ç”¨ç¼ºä¹èµ„æºç”¨é‡çš„å…¬å¹³ä¿è¯ï¼Œè€Œä½¿ç”¨åŠ¨æ€èµ„æºçš„ BestEffort åº”ç”¨éœ€è¦ä¿è¯å…¶ CPU ä½¿ç”¨é‡è¢«é™åˆ¶åœ¨å…¶å…è®¸ä½¿ç”¨çš„åˆç†èŒƒå›´å†…ï¼Œé¿å…åœ¨ä¸åŒ QoS æ··éƒ¨çš„åœºæ™¯ä¸‹å¯¹é«˜ä¼˜ Pod çš„å¹²æ‰°ï¼Œç¡®ä¿æ•´æœºçš„èµ„æºä½¿ç”¨ç‡æ§åˆ¶åœ¨å®‰å…¨æ°´ä½ä¹‹ä¸‹ã€‚</p><p>è€ƒè™‘åˆ° Kubelet cgroup manager ä¸æ”¯æŒæ¥å£æ‰©å±•ï¼Œæ‰€ä»¥éœ€è¦å€ŸåŠ© agent ç±»å‹çš„ç»„ä»¶ç»´æŠ¤å®¹å™¨çš„ cgroupï¼ŒåŒæ—¶åœ¨ CPU ç«äº‰æ—¶ä¹Ÿèƒ½æŒ‰ç…§å„è‡ªå£°æ˜é‡å…¬å¹³ç«äº‰ã€‚</p><h1 id="ç¤¾åŒºæˆæœ"><a href="#ç¤¾åŒºæˆæœ" class="headerlink" title="ç¤¾åŒºæˆæœ"></a>ç¤¾åŒºæˆæœ</h1><p>å›½å†…ç¤¾åŒºåœ¨èŠ‚ç‚¹èµ„æºè¶…å–æ–¹é¢çš„è½åœ°æ€è·¯æ•´ä½“ç›¸ä¼¼ï¼Œéƒ½æ˜¯å›´ç»•å¼¹æ€§èµ„æºçš„å›æ”¶ã€è¶…å–ä¸é™åˆ¶ä¸‰ä¸ªéƒ¨åˆ†å±•å¼€ã€‚æ— è®ºæ˜¯é˜¿é‡Œ Koordinatorã€è…¾è®¯ Craneã€åä¸º Volcanoã€å­—èŠ‚ Katalyst ç­‰å¼€æºé¡¹ç›®ï¼Œè¿˜æ˜¯ç½‘æ˜“è½»èˆŸ NCS å’Œç¾å›¢ LAR ç­‰å†…éƒ¨å¹³å°ç­‰éƒ½æ˜¯ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒä»¬çš„æœ¬è´¨ç›¸åŒï¼Œåªæ˜¯åœ¨å¼¹æ€§èµ„æºç»“ç®—æ–¹å¼ç­‰ç»†èŠ‚ç‚¹ä¸Šæœ‰æ‰€ä¸åŒã€‚</p><h2 id="Koordinator"><a href="#Koordinator" class="headerlink" title="Koordinator"></a>Koordinator</h2><p><u><em><a href="https://github.com/koordinator-sh/koordinator">https://github.com/koordinator-sh/koordinator</a></em></u></p><div align=center><img width="700" style="border: 0px" src="/gallery/koordinator/overview.png"></div><p>Koordinator æ˜¯ä¸€ä¸ªåŸºäº QoS çš„ Kubernetes æ··åˆå·¥ä½œè´Ÿè½½è°ƒåº¦ç³»ç»Ÿï¼Œæ—¨åœ¨æé«˜å¯¹å»¶è¿Ÿæ•æ„Ÿçš„å·¥ä½œè´Ÿè½½å’Œæ‰¹å¤„ç†ä½œä¸šçš„è¿è¡Œæ—¶æ•ˆç‡å’Œå¯é æ€§ï¼Œç®€åŒ–ä¸èµ„æºç›¸å…³çš„é…ç½®è°ƒæ•´çš„å¤æ‚æ€§ï¼Œå¹¶å¢åŠ  Pod éƒ¨ç½²å¯†åº¦ä»¥æé«˜èµ„æºåˆ©ç”¨ç‡ã€‚</p><p><strong>SLO</strong></p><p>åœ¨é›†ç¾¤ä¸­è¿è¡Œçš„ Pod èµ„æº SLOï¼ˆService Level Objectivesï¼‰ç”±ä¸¤ä¸ªæ¦‚å¿µç»„æˆï¼Œå³ä¼˜å…ˆçº§å’Œ QoS</p><ul><li>ä¼˜å…ˆçº§ï¼Œå³èµ„æºçš„ä¼˜å…ˆçº§ï¼Œä»£è¡¨äº†è¯·æ±‚èµ„æºè¢«è°ƒåº¦çš„ä¼˜å…ˆçº§ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§ä¼šå½±å“ Pod åœ¨è°ƒåº¦å™¨å¾…å®šé˜Ÿåˆ—ä¸­çš„ç›¸å¯¹ä½ç½®</li><li>QoSï¼Œä»£è¡¨ Pod è¿è¡Œæ—¶çš„æœåŠ¡è´¨é‡ã€‚å¦‚ cgroups cpu shareã€cfs é…é¢ã€LLCã€å†…å­˜ã€OOM ä¼˜å…ˆçº§ç­‰ç­‰</li></ul><p>Koordinator å®šä¹‰äº†äº”ç§ç±»å‹çš„ QoSï¼Œç”¨äºç¼–æ’è°ƒåº¦ä¸èµ„æºéš”ç¦»åœºæ™¯ï¼š</p><table><thead><tr><th>QoS</th><th>ç‰¹ç‚¹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>SYSTEM</td><td>ç³»ç»Ÿè¿›ç¨‹ï¼Œèµ„æºå—é™</td><td>å¯¹äº DaemonSets ç­‰ç³»ç»ŸæœåŠ¡ï¼Œè™½ç„¶éœ€è¦ä¿è¯ç³»ç»ŸæœåŠ¡çš„å»¶è¿Ÿï¼Œä½†ä¹Ÿéœ€è¦é™åˆ¶èŠ‚ç‚¹ä¸Šè¿™äº›ç³»ç»ŸæœåŠ¡å®¹å™¨çš„èµ„æºä½¿ç”¨ï¼Œä»¥ç¡®ä¿å…¶ä¸å ç”¨è¿‡å¤šçš„èµ„æº</td></tr><tr><td>LSE(Latency Sensitive Exclusive)</td><td>ä¿ç•™èµ„æºå¹¶ç»„ç»‡åŒ QoS çš„ Pod å…±äº«èµ„æº</td><td>å¾ˆå°‘ä½¿ç”¨ï¼Œå¸¸è§äºä¸­é—´ä»¶ç±»åº”ç”¨ï¼Œä¸€èˆ¬åœ¨ç‹¬ç«‹çš„èµ„æºæ± ä¸­ä½¿ç”¨</td></tr><tr><td>LSR(Latency Sensitive Reserved)</td><td>é¢„ç•™èµ„æºä»¥è·å¾—æ›´å¥½çš„ç¡®å®šæ€§</td><td>ç±»ä¼¼äºç¤¾åŒºçš„ Guaranteedï¼ŒCPU æ ¸è¢«ç»‘å®š</td></tr><tr><td>LS(Latency Sensitive)</td><td>å…±äº«èµ„æºï¼Œå¯¹çªå‘æµé‡æœ‰æ›´å¥½çš„å¼¹æ€§</td><td>å¾®æœåŠ¡å·¥ä½œè´Ÿè½½çš„å…¸å‹ QoS çº§åˆ«ï¼Œå®ç°æ›´å¥½çš„èµ„æºå¼¹æ€§å’Œæ›´çµæ´»çš„èµ„æºè°ƒæ•´èƒ½åŠ›</td></tr><tr><td>BE(Best Effort)</td><td>å…±äº«ä¸åŒ…æ‹¬ LSE çš„èµ„æºï¼Œèµ„æºè¿è¡Œè´¨é‡æœ‰é™ï¼Œç”šè‡³åœ¨æç«¯æƒ…å†µä¸‹è¢«æ€æ­»</td><td>æ‰¹é‡ä½œä¸šçš„å…¸å‹ QoS æ°´å¹³ï¼Œåœ¨ä¸€å®šæ—¶æœŸå†…ç¨³å®šçš„è®¡ç®—ååé‡ï¼Œä½æˆæœ¬èµ„æº</td></tr></tbody></table><p>æ­¤å¤–ï¼Œè¿›ä¸€æ­¥å®šä¹‰äº†å››ç±»ä¼˜å…ˆçº§ï¼Œç”¨äºæ‰©å±•ä¼˜å…ˆçº§ç»´åº¦ä»¥å¯¹æ··éƒ¨åœºæ™¯çš„ç»†ç²’åº¦æ”¯æŒï¼š</p><table><thead><tr><th>PriorityClass</th><th>ä¼˜å…ˆçº§èŒƒå›´</th><th>æè¿°</th></tr></thead><tbody><tr><td>koord-prod</td><td>[9000, 9999]</td><td>éœ€è¦æå‰è§„åˆ’èµ„æºé…é¢ï¼Œå¹¶ä¸”ä¿è¯åœ¨é…é¢å†…æˆåŠŸ</td></tr><tr><td>koord-mid</td><td>[7000, 7999]</td><td>éœ€è¦æå‰è§„åˆ’èµ„æºé…é¢ï¼Œå¹¶ä¸”ä¿è¯åœ¨é…é¢å†…æˆåŠŸ</td></tr><tr><td>koord-batch</td><td>[5000, 5999]</td><td>éœ€è¦æå‰è§„åˆ’èµ„æºé…é¢ï¼Œä¸€èˆ¬å…è®¸å€Ÿç”¨é…é¢</td></tr><tr><td>koord-free</td><td>[3000, 3999]</td><td>ä¸ä¿è¯èµ„æºé…é¢ï¼Œå¯åˆ†é…çš„èµ„æºæ€»é‡å–å†³äºé›†ç¾¤çš„æ€»é—²ç½®èµ„æº</td></tr></tbody></table><p><strong>å¼¹æ€§èµ„æºå›æ”¶ä¸è¶…å–</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/koordinator/colocation.png"></div><p>Koordinator çš„æ··éƒ¨èµ„æºæ¨¡å‹ï¼Œå…¶åŸºæœ¬æ€æƒ³æ˜¯åˆ©ç”¨é‚£äº›å·²åˆ†é…ä½†æœªä½¿ç”¨çš„èµ„æºæ¥è¿è¡Œä½ä¼˜å…ˆçº§çš„ Podã€‚å¦‚å›¾æ‰€ç¤ºï¼Œæœ‰å››æ¡çº¿ï¼š</p><ol><li>limitï¼šç°è‰²ï¼Œé«˜ä¼˜å…ˆçº§ Pod æ‰€è¯·æ±‚çš„èµ„æºé‡ï¼Œå¯¹åº”äº Kubernetes çš„ Pod è¯·æ±‚ã€‚</li><li>usageï¼šçº¢è‰²ï¼ŒPod å®é™…ä½¿ç”¨çš„èµ„æºé‡ï¼Œæ¨ªè½´ä¸ºæ—¶é—´çº¿ï¼Œçº¢çº¿ä¸º Pod è´Ÿè½½éšæ—¶é—´å˜åŒ–çš„æ³¢åŠ¨æ›²çº¿ã€‚</li><li>short-term reservationï¼šæ·±è“è‰²ï¼Œè¿™æ˜¯åŸºäºè¿‡å»ï¼ˆè¾ƒçŸ­ï¼‰æ—¶æœŸå†…çš„èµ„æºä½¿ç”¨é‡ï¼Œå¯¹æœªæ¥ä¸€æ®µæ—¶é—´å†…å…¶èµ„æºä½¿ç”¨é‡çš„ä¼°è®¡ã€‚é¢„ç•™å’Œé™åˆ¶çš„åŒºåˆ«åœ¨äºï¼Œåˆ†é…çš„æœªä½¿ç”¨ï¼ˆæœªæ¥ä¸ä¼šä½¿ç”¨çš„èµ„æºï¼‰å¯ä»¥ç”¨æ¥è¿è¡ŒçŸ­æœŸæ‰§è¡Œçš„æ‰¹å¤„ç† Podã€‚</li><li>long-term reservationï¼šæµ…è“è‰²ï¼Œä¸ short-term reservation ç±»ä¼¼ï¼Œä½†ä¼°è®¡çš„å†å²ä½¿ç”¨æœŸæ›´é•¿ã€‚ä»ä¿ç•™åˆ°é™åˆ¶çš„èµ„æºå¯ä»¥ç”¨äºç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„ Podï¼Œä¸çŸ­æœŸçš„é¢„æµ‹å€¼ç›¸æ¯”ï¼Œå¯ç”¨çš„èµ„æºè¾ƒå°‘ï¼Œä½†æ›´ç¨³å®šã€‚</li></ol><p>Koordinator çš„å·®å¼‚åŒ– SLO æä¾›å°†è¿™éƒ¨åˆ†èµ„æºé‡åŒ–çš„èƒ½åŠ›ã€‚å°†ä¸Šå›¾ä¸­çš„çº¢çº¿å®šä¹‰ä¸º usageï¼Œè“çº¿åˆ°çº¢çº¿é¢„ç•™éƒ¨åˆ†èµ„æºå®šä¹‰ä¸º bufferedï¼Œç»¿è‰²è¦†ç›–éƒ¨åˆ†å®šä¹‰ä¸º reclaimedã€‚ä¸ºä½“ç°ä¸åŸç”Ÿèµ„æºç±»å‹çš„å·®å¼‚æ€§ï¼ŒKoordinator ä½¿ç”¨ Batch ä¼˜å…ˆçº§çš„æ¦‚å¿µæè¿°è¯¥éƒ¨åˆ†è¶…å–èµ„æºï¼Œä¹Ÿå°±æ˜¯ batch-cpu å’Œ batch-memoryã€‚</p><p>èŠ‚ç‚¹ä¸­å¯è¶…å–èµ„æºçš„è®¡ç®—å…¬å¼ä¸ºï¼š</p><blockquote><p>nodeBatchAllocatable &#x3D; nodeAllocatable * thresholdPercent - podRequest(non-BE) - systemUsage</p></blockquote><p><em>å…¬å¼ä¸­çš„ thresholdPercent ä¸ºå¯é…ç½®å‚æ•°ï¼Œé€šè¿‡ä¿®æ”¹ ConfigMap ä¸­çš„é…ç½®é¡¹å¯ä»¥å®ç°å¯¹èµ„æºçš„çµæ´»ç®¡ç†ã€‚</em></p><p>Pod é€šè¿‡å£°æ˜æ ‡å‡†æ‰©å±•èµ„æºçš„æ–¹å¼ä½¿ç”¨è¶…å–èµ„æºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># å¿…å¡«ï¼Œæ ‡è®°ä¸ºä½ä¼˜å…ˆçº§ Pod</span></span><br><span class="line">    <span class="attr">koordinator.sh/qosClass:</span> <span class="string">&quot;BE&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="comment"># å•ä½ä¸ºåƒåˆ†ä¹‹ä¸€æ ¸ï¼Œå¦‚ä¸‹è¡¨ç¤º 1 æ ¸</span></span><br><span class="line">        <span class="attr">kubernetes.io/batch-cpu:</span> <span class="string">&quot;1k&quot;</span></span><br><span class="line">        <span class="comment"># å•ä½ä¸ºå­—èŠ‚ï¼Œå¦‚ä¸‹è¡¨ç¤º 1 GB</span></span><br><span class="line">        <span class="attr">kubernetes.io/batch-memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">kubernetes.io/batch-cpu:</span> <span class="string">&quot;1k&quot;</span></span><br><span class="line">        <span class="attr">kubernetes.io/batch-memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼ŒKoordinator æä¾›äº†ä¸€ä¸ª ClusterColocationProfile CRD å’Œå¯¹åº”çš„ webhook ä¿®æ”¹å’ŒéªŒè¯æ–°åˆ›å»ºçš„ Podï¼Œä¸»è¦ä¸º Pod æ³¨å…¥ ClusterColocationProfile ä¸­å£°æ˜çš„ Koordinator QoSClassã€Koordinator Priority ç­‰ï¼Œä»¥åŠå°† Pod ç”³è¯·çš„æ ‡å‡†èµ„æºå˜æ›´è‡³æ‰©å±•èµ„æºã€‚å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><div align=center><img width="800" style="border: 0px" src="/gallery/koordinator/clustercolocationprofile.png"></div><p><strong>å¼¹æ€§èµ„æºé™åˆ¶</strong></p><p>Koordinator åœ¨å®¿ä¸»æœºèŠ‚ç‚¹æä¾›äº†å¼¹æ€§èµ„æºé™åˆ¶èƒ½åŠ›ï¼Œç¡®ä¿ä½ä¼˜å…ˆçº§ BEï¼ˆBestEffortï¼‰ç±»å‹ Pod çš„ CPU èµ„æºä½¿ç”¨åœ¨åˆç†èŒƒå›´å†…ï¼Œä¿éšœèŠ‚ç‚¹å†…å®¹å™¨ç¨³å®šè¿è¡Œã€‚</p><p>åœ¨ Koordinator æä¾›çš„åŠ¨æ€èµ„æºè¶…å–æ¨¡å‹ä¸­ï¼Œreclaimed èµ„æºæ€»é‡æ ¹æ®é«˜ä¼˜å…ˆçº§ LSï¼ˆLatency Sensitiveï¼‰ç±»å‹ Pod çš„å®é™…èµ„æºç”¨é‡è€ŒåŠ¨æ€å˜åŒ–ï¼Œè¿™éƒ¨åˆ†èµ„æºå¯ä»¥ä¾›ä½ä¼˜å…ˆçº§ BEï¼ˆBestEffortï¼‰ç±»å‹ Pod ä½¿ç”¨ã€‚é€šè¿‡åŠ¨æ€èµ„æºè¶…å–èƒ½åŠ›ï¼Œå¯ä»¥å°† LS ä¸ BE ç±»å‹å®¹å™¨æ··åˆéƒ¨ç½²ï¼Œä»¥æ­¤æå‡é›†ç¾¤èµ„æºåˆ©ç”¨ç‡ã€‚ä¸ºäº†ç¡®ä¿ BE ç±»å‹Pod çš„ CPU èµ„æºä½¿ç”¨åœ¨åˆç†èŒƒå›´å†…ï¼Œé¿å… LS ç±»å‹åº”ç”¨çš„è¿è¡Œè´¨é‡å—åˆ°å¹²æ‰°ï¼ŒKoordinator  åœ¨èŠ‚ç‚¹ä¾§æä¾›äº† CPU èµ„æºå¼¹æ€§é™åˆ¶çš„èƒ½åŠ›ã€‚å¼¹æ€§èµ„æºé™åˆ¶åŠŸèƒ½å¯ä»¥åœ¨æ•´æœºèµ„æºç”¨é‡å®‰å…¨æ°´ä½ä¸‹ï¼Œæ§åˆ¶ BE ç±»å‹ Pod å¯ä½¿ç”¨çš„ CPU èµ„æºé‡ï¼Œä¿éšœèŠ‚ç‚¹å†…å®¹å™¨ç¨³å®šè¿è¡Œã€‚</p><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨æ•´æœºå®‰å…¨æ°´ä½ä¸‹ï¼ˆCPU Thresholdï¼‰ï¼Œéšç€ LS ç±»å‹ Pod èµ„æºä½¿ç”¨é‡çš„å˜åŒ–ï¼ˆPodï¼ˆLSï¼‰.Usageï¼‰ï¼ŒBE ç±»å‹ Pod å¯ç”¨çš„ CPU èµ„æºè¢«é™åˆ¶åœ¨åˆç†çš„èŒƒå›´å†…ï¼ˆCPU Restriction for BEï¼‰ã€‚é™åˆ¶æ°´ä½çš„é…ç½®ä¸åŠ¨æ€èµ„æºè¶…å–æ¨¡å‹ä¸­çš„é¢„ç•™æ°´ä½åŸºæœ¬ä¸€è‡´ï¼Œä»¥æ­¤ä¿è¯ CPU èµ„æºä½¿ç”¨çš„ä¸€è‡´æ€§ã€‚</p><div align=center><img width="700" style="border: 0px" src="/gallery/koordinator/restriction.png"></div><p>Koordinator æ”¯æŒé€šè¿‡ ConfigMap é…ç½®å¼¹æ€§é™åˆ¶å‚æ•°ã€‚</p><h1 id="å®è·µéªŒè¯"><a href="#å®è·µéªŒè¯" class="headerlink" title="å®è·µéªŒè¯"></a>å®è·µéªŒè¯</h1><p><em>ä»¥ Koordinator ä¸ºä¾‹</em></p><blockquote><p>based on <strong>v1.2.0</strong></p></blockquote><p><strong>ä½¿ç”¨ helm å®‰è£…</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Firstly add koordinator charts repository <span class="keyword">if</span> you haven<span class="string">&#x27;t do this.</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">helm repo add koordinator-sh https://koordinator-sh.github.io/charts/</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">[Optional]</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">helm repo update</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">Install the latest version.</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">helm install koordinator koordinator-sh/koordinator --version 1.2.0</span></span></span><br></pre></td></tr></table></figure><p><strong>å®‰è£…ç»“æœ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get all -n koordinator-system</span></span><br><span class="line">NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/koord-descheduler-68845fcc47-k72l5   1/1     Running   0          3d4h</span><br><span class="line">pod/koord-descheduler-68845fcc47-vk79v   1/1     Running   0          3d4h</span><br><span class="line">pod/koord-manager-7f68bbcf77-cbscj       1/1     Running   0          3d4h</span><br><span class="line">pod/koord-manager-7f68bbcf77-sjpw7       1/1     Running   0          3d4h</span><br><span class="line">pod/koord-scheduler-f4db87d4c-5p5j4      1/1     Running   0          3d4h</span><br><span class="line">pod/koord-scheduler-f4db87d4c-x242f      1/1     Running   0          3d4h</span><br><span class="line">pod/koordlet-nz58m                       1/1     Running   0          3d4h</span><br><span class="line"></span><br><span class="line">NAME                                  TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/koordinator-webhook-service   ClusterIP   10.96.178.39   &lt;none&gt;        443/TCP   3d4h</span><br><span class="line"></span><br><span class="line">NAME                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line">daemonset.apps/koordlet   1         1         1       1            1           &lt;none&gt;          3d4h</span><br><span class="line"></span><br><span class="line">NAME                                READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/koord-descheduler   2/2     2            2           3d4h</span><br><span class="line">deployment.apps/koord-manager       2/2     2            2           3d4h</span><br><span class="line">deployment.apps/koord-scheduler     2/2     2            2           3d4h</span><br><span class="line"></span><br><span class="line">NAME                                           DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/koord-descheduler-68845fcc47   2         2         2       3d4h</span><br><span class="line">replicaset.apps/koord-manager-7f68bbcf77       2         2         2       3d4h</span><br><span class="line">replicaset.apps/koord-scheduler-f4db87d4c      2         2         2       3d4h</span><br></pre></td></tr></table></figure><p>Koordinator ç”±ä¸¤ä¸ªæ§åˆ¶é¢ Koordinator Schedulerã€Koordinator Manager å’Œä¸€ä¸ª DaemonSet ç»„ä»¶ Koordlet ç»„æˆã€‚Koordinator åœ¨ Kubernetes åŸæœ‰çš„èƒ½åŠ›åŸºç¡€ä¸Šå¢åŠ äº†æ··éƒ¨åŠŸèƒ½ï¼Œå¹¶å…¼å®¹äº† Kubernetes åŸæœ‰çš„å·¥ä½œè´Ÿè½½ã€‚</p><p><em><strong>Koordinator Scheduler</strong></em></p><p>Koordinator Scheduler ä»¥ Deployment çš„å½¢å¼éƒ¨ç½²ï¼Œç”¨äºå¢å¼º Kubernetes åœ¨æ··éƒ¨åœºæ™¯ä¸‹çš„èµ„æºè°ƒåº¦èƒ½åŠ›ï¼ŒåŒ…æ‹¬:</p><ul><li>æ›´å¤šçš„åœºæ™¯æ”¯æŒï¼ŒåŒ…æ‹¬å¼¹æ€§é…é¢è°ƒåº¦ã€èµ„æºè¶…å–ã€èµ„æºé¢„ç•™ã€Gang è°ƒåº¦ã€å¼‚æ„èµ„æºè°ƒåº¦</li><li>æ›´å¥½çš„æ€§èƒ½ï¼ŒåŒ…æ‹¬åŠ¨æ€ç´¢å¼•ä¼˜åŒ–ã€ç­‰ä»· class è°ƒåº¦ã€éšæœºç®—æ³•ä¼˜åŒ–</li><li>æ›´å®‰å…¨çš„ deschedulingï¼ŒåŒ…æ‹¬å·¥ä½œè´Ÿè½½æ„ŸçŸ¥ã€ç¡®å®šæ€§çš„ Pod è¿ç§»ã€ç»†ç²’åº¦çš„æµé‡æ§åˆ¶å’Œå˜æ›´å®¡è®¡æ”¯æŒ</li></ul><p><em><strong>Koordinator Manager</strong></em></p><p>Koordinator Manager ä»¥ Deployment çš„å½¢å¼éƒ¨ç½²ï¼Œé€šå¸¸ç”±ä¸¤ä¸ªå®ä¾‹ç»„æˆï¼Œä¸€ä¸ª leader å®ä¾‹å’Œä¸€ä¸ª backup å®ä¾‹ã€‚Koordinator Manager ç”±å‡ ä¸ªæ§åˆ¶å™¨å’Œ webhooks ç»„æˆï¼Œç”¨äºåè°ƒæ··éƒ¨åœºæ™¯ä¸‹çš„å·¥ä½œè´Ÿè½½ï¼Œèµ„æºè¶…å–å’Œ SLO ç®¡ç†ã€‚</p><p>ç›®å‰ï¼Œæä¾›äº†ä¸‰ä¸ªç»„ä»¶:</p><ul><li>Colocation Profileï¼Œç”¨äºæ”¯æŒæ··éƒ¨è€Œä¸éœ€è¦ä¿®æ”¹å·¥ä½œè´Ÿè½½ã€‚ç”¨æˆ·åªéœ€è¦åœ¨é›†ç¾¤ä¸­åšå°‘é‡çš„é…ç½®ï¼ŒåŸæ¥çš„å·¥ä½œè´Ÿè½½å°±å¯ä»¥åœ¨æ··éƒ¨æ¨¡å¼ä¸‹è¿è¡Œ</li><li>SLO æ§åˆ¶å™¨ï¼Œç”¨äºèµ„æºè¶…å–ç®¡ç†ï¼Œæ ¹æ®èŠ‚ç‚¹æ··éƒ¨æ—¶çš„è¿è¡ŒçŠ¶æ€ï¼ŒåŠ¨æ€è°ƒæ•´é›†ç¾¤çš„è¶…å‘é…ç½®æ¯”ä¾‹ã€‚è¯¥æ§åˆ¶å™¨çš„æ ¸å¿ƒèŒè´£æ˜¯ç®¡ç†æ··éƒ¨æ—¶çš„ SLOï¼Œå¦‚æ™ºèƒ½è¯†åˆ«å‡ºé›†ç¾¤ä¸­çš„å¼‚å¸¸èŠ‚ç‚¹å¹¶é™ä½å…¶æƒé‡ï¼ŒåŠ¨æ€è°ƒæ•´æ··éƒ¨æ—¶çš„æ°´ä½å’Œå‹åŠ›ç­–ç•¥ï¼Œä»è€Œä¿è¯é›†ç¾¤ä¸­ Pod çš„ç¨³å®šæ€§å’Œååé‡</li><li>Recommenderï¼Œå®ƒä½¿ç”¨ histograms æ¥ç»Ÿè®¡å’Œé¢„æµ‹å·¥ä½œè´Ÿè½½çš„èµ„æºä½¿ç”¨ç»†èŠ‚ï¼Œç”¨æ¥é¢„ä¼°å·¥ä½œè´Ÿè½½çš„å³°å€¼èµ„æºéœ€æ±‚ï¼Œä»è€Œæ”¯æŒæ›´å¥½åœ°åˆ†æ•£çƒ­ç‚¹ï¼Œæé«˜æ··éƒ¨çš„æ•ˆç‡ã€‚æ­¤å¤–ï¼Œæä¾›èµ„æºç”»åƒåŠŸèƒ½ï¼Œé¢„ä¼°å·¥ä½œè´Ÿè½½çš„å³°å€¼èµ„æºéœ€æ±‚ï¼Œèµ„æº profiling è¿˜å°†ç”¨äºç®€åŒ–ç”¨æˆ·èµ„æºè§„èŒƒåŒ–é…ç½®çš„å¤æ‚æ€§ï¼Œå¦‚æ”¯æŒ VPA</li></ul><p><em><strong>Koordlet</strong></em></p><p>Koordlet ä»¥ DaemonSet çš„å½¢å¼éƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œç”¨äºæ”¯æŒæ··éƒ¨åœºæ™¯ä¸‹çš„èµ„æºè¶…å–ã€å¹²æ‰°æ£€æµ‹ã€QoS ä¿è¯ç­‰ã€‚</p><p>åœ¨ Koordlet å†…éƒ¨ï¼Œå®ƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ¨¡å—:</p><ul><li>èµ„æº profilingï¼Œä¼°ç®— Pod èµ„æºçš„å®é™…ä½¿ç”¨æƒ…å†µï¼Œå›æ”¶å·²åˆ†é…ä½†æœªä½¿ç”¨çš„èµ„æºï¼Œç”¨äºä½ä¼˜å…ˆçº§ Pod çš„ overcommit</li><li>èµ„æºéš”ç¦»ï¼Œä¸ºä¸åŒç±»å‹çš„ Pod è®¾ç½®èµ„æºéš”ç¦»å‚æ•°ï¼Œé¿å…ä½ä¼˜å…ˆçº§çš„ Pod å½±å“é«˜ä¼˜å…ˆçº§ Pod çš„ç¨³å®šæ€§å’Œæ€§èƒ½</li><li>å¹²æ‰°æ£€æµ‹ï¼Œå¯¹äºè¿è¡Œä¸­çš„ Podï¼ŒåŠ¨æ€æ£€æµ‹èµ„æºäº‰å¤ºï¼ŒåŒ…æ‹¬ CPU è°ƒåº¦ã€å†…å­˜åˆ†é…å»¶è¿Ÿã€ç½‘ç»œã€ç£ç›˜ IO å»¶è¿Ÿç­‰</li><li>QoS ç®¡ç†å™¨ï¼Œæ ¹æ®èµ„æºå‰–æã€å¹²æ‰°æ£€æµ‹ç»“æœå’Œ SLO é…ç½®ï¼ŒåŠ¨æ€è°ƒæ•´æ··éƒ¨èŠ‚ç‚¹çš„æ°´ä½ï¼ŒæŠ‘åˆ¶å½±å“æœåŠ¡è´¨é‡çš„ Pod</li><li>èµ„æºè°ƒä¼˜ï¼Œé’ˆå¯¹æ··éƒ¨åœºæ™¯è¿›è¡Œå®¹å™¨èµ„æºè°ƒä¼˜ï¼Œä¼˜åŒ–å®¹å™¨çš„ CPU Throttleã€OOM ç­‰ï¼Œæé«˜æœåŠ¡è¿è¡Œè´¨é‡</li></ul><p><strong>å¼¹æ€§èµ„æºé…ç½®</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ack-slo-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">colocation-config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      # æ˜¯å¦å¼€å¯èŠ‚ç‚¹ Batch èµ„æºçš„åŠ¨æ€æ›´æ–°ï¼Œå…³é—­æ—¶ Batch èµ„æºé‡ä¼šè¢«é‡ç½®ä¸º 0ã€‚é»˜è®¤å€¼ä¸º false</span></span><br><span class="line"><span class="string">      &quot;enable&quot;: true,</span></span><br><span class="line"><span class="string">      # Batch èµ„æºæœ€å°æ›´æ–°é¢‘ç‡ï¼Œå•ä½ä¸ºç§’ã€‚é€šå¸¸å»ºè®®ä¿æŒä¸º 1 åˆ†é’Ÿ</span></span><br><span class="line"><span class="string">      &quot;metricAggregateDurationSeconds&quot;: 60,</span></span><br><span class="line"><span class="string">      # è®¡ç®—èŠ‚ç‚¹ batch-cpu èµ„æºå®¹é‡æ—¶çš„é¢„ç•™ç³»æ•°ã€‚é»˜è®¤å€¼ä¸º 65ï¼Œå•ä½ä¸ºç™¾åˆ†æ¯”</span></span><br><span class="line"><span class="string">      &quot;cpuReclaimThresholdPercent&quot;: 60,</span></span><br><span class="line"><span class="string">      # è®¡ç®—èŠ‚ç‚¹ batch-memory èµ„æºå®¹é‡æ—¶çš„é¢„ç•™ç³»æ•°ã€‚é»˜è®¤å€¼ä¸º 65ï¼Œå•ä½ä¸ºç™¾åˆ†æ¯”</span></span><br><span class="line"><span class="string">      &quot;memoryReclaimThresholdPercent&quot;: 70,</span></span><br><span class="line"><span class="string">      # è®¡ç®—èŠ‚ç‚¹ batch-memory èµ„æºå®¹é‡æ—¶çš„ç­–ç•¥</span></span><br><span class="line"><span class="string">      # &quot;usage&quot;ï¼šé»˜è®¤å€¼ï¼Œè¡¨ç¤º batch-memory å†…å­˜èµ„æºæŒ‰ç…§é«˜ä¼˜å…ˆçº§ Pod çš„å†…å­˜çœŸå®ç”¨é‡è®¡ç®—ï¼ŒåŒ…æ‹¬äº†èŠ‚ç‚¹æœªç”³è¯·çš„èµ„æºï¼Œä»¥åŠå·²ç”³è¯·ä½†æœªä½¿ç”¨çš„èµ„æºé‡ã€‚</span></span><br><span class="line"><span class="string">      # &quot;request&quot;ï¼šè¡¨ç¤º batch-memory å†…å­˜èµ„æºæŒ‰ç…§é«˜ä¼˜å…ˆçº§ Pod çš„å†…å­˜è¯·æ±‚é‡è®¡ç®—ï¼Œä»…åŒ…æ‹¬èŠ‚ç‚¹æœªç”³è¯·çš„èµ„æº</span></span><br><span class="line"><span class="string">      &quot;memoryCalculatePolicy&quot;: &quot;usage&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">resource-threshold-config:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;clusterStrategy&quot;: &#123;</span></span><br><span class="line"><span class="string">        # é›†ç¾¤æ˜¯å¦å¼€å¯å¼¹æ€§èµ„æºé™åˆ¶èƒ½åŠ›</span></span><br><span class="line"><span class="string">        &quot;enable&quot;: true,</span></span><br><span class="line"><span class="string">        # å•ä½ä¸ºç™¾åˆ†æ¯”ï¼Œè¡¨ç¤ºå¼¹æ€§èµ„æºé™åˆ¶å¯¹åº”çš„èŠ‚ç‚¹å®‰å…¨æ°´ä½é˜ˆå€¼ï¼Œé»˜è®¤ä¸º 65</span></span><br><span class="line"><span class="string">        &quot;cpuSuppressThresholdPercent&quot;: 65</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure><p>å¼€å¯ååŠ¨æ€èµ„æºåï¼Œå¯ä»¥çœ‹åˆ°èŠ‚ç‚¹å·²ç»è¯†åˆ«åˆ°æ‰©å±•èµ„æº <code>kubernetes.io/batch-cpu</code> ä¸ <code>kubernetes.io/batch-memory</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe node wnx</span></span><br><span class="line">Capacity:</span><br><span class="line">  cpu:                         8</span><br><span class="line">  memory:                      12057632Ki</span><br><span class="line">  kubernetes.io/batch-cpu:     4034</span><br><span class="line">  kubernetes.io/batch-memory:  4455468942</span><br><span class="line">Allocatable:</span><br><span class="line">  cpu:                         8</span><br><span class="line">  memory:                      11955232Ki</span><br><span class="line">  kubernetes.io/batch-cpu:     4034</span><br><span class="line">  kubernetes.io/batch-memory:  4455468942</span><br><span class="line">Allocated resources:</span><br><span class="line">  (Total limits may be over 100 percent, i.e., overcommitted.)</span><br><span class="line">  Resource                    Requests      Limits</span><br><span class="line">  --------                    --------      ------</span><br><span class="line">  cpu                         4100m (51%)   6500m (81%)</span><br><span class="line">  memory                      1776Mi (15%)  6740Mi (57%)</span><br><span class="line">  kubernetes.io/batch-cpu     0             0</span><br><span class="line">  kubernetes.io/batch-memory  0             0</span><br></pre></td></tr></table></figure><p>mutating webook æ³¨å…¥çš„ä¿¡æ¯æ˜¯æ ¹æ® ClusterColocationProfile å†³å®šçš„ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">config.koordinator.sh/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterColocationProfile</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">colocation-profile-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">koordinator.sh/enable-colocation:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">koordinator.sh/enable-colocation:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">qosClass:</span> <span class="string">BE</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">koord-batch</span></span><br><span class="line">  <span class="attr">koordinatorPriority:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">koord-scheduler</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">koordinator.sh/mutated:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line">    <span class="attr">koordinator.sh/intercepted:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">patch:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure><p><strong>æ¨¡æ‹Ÿåœ¨ç¦»çº¿æœåŠ¡æ··éƒ¨</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">online</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ubuntu:18.04</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;tail -f /dev/null&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;3000Mi&quot;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;3000Mi&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">offline</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">koordinator.sh/enable-colocation:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">ubuntu:18.04</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;tail -f /dev/null&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;100Mi&quot;</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;100Mi&quot;</span></span><br></pre></td></tr></table></figure><p>åœ¨èŠ‚ç‚¹å‰©ä½™ 4C å·¦å³çš„èµ„æºæ—¶ï¼Œé€šè¿‡ç¦»çº¿æœåŠ¡ä½¿ç”¨è¶…å–èµ„æºã€åœ¨çº¿æœåŠ¡ä½¿ç”¨æ ‡å‡†èµ„æºçš„æ··éƒ¨æ¨¡å¼ï¼Œå¯ä»¥è®©æœåŠ¡å‡æˆåŠŸéƒ¨ç½²åœ¨èŠ‚ç‚¹ä¸Šã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod</span> </span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">offline     1/1     Running   0          2m25s</span><br><span class="line">online      1/1     Running   0          2m23s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe node wnx</span></span><br><span class="line">Non-terminated Pods:    (18 in total)</span><br><span class="line">  Namespace    Name        CPU Requests  CPU Limits  Memory Requests  Memory Limits  Age</span><br><span class="line">  ---------    ----        ------------  ----------  ---------------  -------------  ---</span><br><span class="line">  default      offline     0 (0%)        0 (0%)      0 (0%)           0 (0%)         8s</span><br><span class="line">  default      online      3 (37%)       3 (37%)     3000Mi (25%)     3000Mi (25%)   6s</span><br><span class="line">Allocated resources:</span><br><span class="line">  (Total limits may be over 100 percent, i.e., overcommitted.)</span><br><span class="line">  Resource                    Requests      Limits</span><br><span class="line">  --------                    --------      ------</span><br><span class="line">  cpu                         7100m (88%)   9500m (118%)</span><br><span class="line">  memory                      4776Mi (40%)  9740Mi (83%)</span><br><span class="line">  kubernetes.io/batch-cpu     3k            3k</span><br><span class="line">  kubernetes.io/batch-memory  100Mi         100Mi</span><br></pre></td></tr></table></figure><p><strong>å¼¹æ€§èµ„æºé™åˆ¶</strong></p><p>è™½ç„¶ç¦»çº¿æœåŠ¡çš„ cgroup è¿˜æ˜¯ä½äº kubepods çš„ besteffort ç»„ä¸­ï¼ˆç”±äºåŸæœ¬å£°æ˜çš„æ ‡å‡†èµ„æºè¢« webhook å˜æ›´ä¸ºæ‰©å±•èµ„æºï¼Œä¹Ÿå°±å˜æˆäº† BestEffort QoS çš„ Podï¼‰ï¼Œä½†æ˜¯ Koordlet ä¼šæ ¹æ®æ‰©å±•èµ„æºçš„å£°æ˜è§„æ ¼æ‰‹åŠ¨ç»´æŠ¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /sys/fs/cgroup/cpu/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod4bb9f204_6690_43cf_a871_808874ad0ed4.slice/cpu.cfs_quota_us</span> </span><br><span class="line">300000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /sys/fs/cgroup/cpu/kubepods.slice/kubepods-besteffort.slice/kubepods-besteffort-pod4bb9f204_6690_43cf_a871_808874ad0ed4.slice/cpu.cfs_period_us</span> </span><br><span class="line">100000</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œåœ¨ç¦»çº¿æœåŠ¡æ‰€ä½¿ç”¨çš„ CPU æ˜¯æœ‰åŒºåˆ«çš„</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">BE QoS Pod ä½¿ç”¨çš„ CPU ä¸º 0-4</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl logs -n koordinator-system   koordlet-bw5kj</span></span><br><span class="line">nodeSuppressBE[CPU(Core)]:5 = node.Total:8 * SLOPercent:65% - systemUsage:1 - podLSUsed:1</span><br><span class="line">calculated BE suppress policy: cpuset [0 1 2 3 4]</span><br><span class="line">suppressBECPU finished, suppress be cpu successfully: current cpuset [0 1 2 3 4]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨çº¿æœåŠ¡ä½¿ç”¨çš„ CPU ä»ç„¶ä¸º 0-7</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /sys/fs/cgroup/cpuset/kubepods/pod7090d2d1-48db-4fb2-8318-dea7084334e2/c108b3e5f44969b6f9a71fd4217b909f3639dafe4cc88665db93b986abe0a031/cpuset.cpus</span></span><br><span class="line">0-7</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¦»çº¿æœåŠ¡ä½¿ç”¨çš„ CPU ä¸º 0-4</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /sys/fs/cgroup/cpuset/kubepods/besteffort/podcee106b7-48ff-4441-9bba-b37c0e4620f9/ef02220e4d28ff6ebd8768ac55a4f73b22b80fac5321f1acbde35acebaa1a74f/cpuset.cpus</span></span><br><span class="line">0-4</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”ï¼Œéšç€èŠ‚ç‚¹è´Ÿè½½ä¸Šå‡ï¼ˆé€šè¿‡åœ¨çº¿æœåŠ¡å®¹å™¨ stress è¿›ç¨‹æ¨¡æ‹Ÿï¼‰ï¼ŒèŠ‚ç‚¹ä¸­å¯ç”¨çš„å¼¹æ€§èµ„æºï¼ˆcapacity ä¸ allocatableï¼‰ä¹Ÿä¼šé€æ¸å˜å°‘ï¼Œç¦»çº¿æœåŠ¡ä½¿ç”¨çš„ CPU ä¹Ÿä¼šç›¸åº”çš„ç¼©å‡ï¼Œä½†æ˜¯ä¸ä¼šåœæ­¢ç¦»çº¿æœåŠ¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /sys/fs/cgroup/cpuset/kubepods/besteffort/podcee106b7-48ff-4441-9bba-b37c0e4620f9/ef02220e4d28ff6ebd8768ac55a4f73b22b80fac5321f1acbde35acebaa1a74f/cpuset.cpus</span></span><br><span class="line">0-4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å½“åœ¨çº¿æœåŠ¡èµ„æºç”¨é‡æå‡æ—¶ï¼Œç¦»çº¿æœåŠ¡ä½¿ç”¨çš„ CPU è¢«é€æ¸ç¼©å‡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /sys/fs/cgroup/cpuset/kubepods/besteffort/podcee106b7-48ff-4441-9bba-b37c0e4620f9/ef02220e4d28ff6ebd8768ac55a4f73b22b80fac5321f1acbde35acebaa1a74f/cpuset.cpus</span></span><br><span class="line">0-1</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">åŸºäº Pod QoS æ··éƒ¨å®ç° Kubernetes èŠ‚ç‚¹èµ„æºè¶…å–æ–¹æ¡ˆçš„æ¢ç´¢ä¸ä¼˜åŒ–</summary>
    
    
    
    <category term="Scheduling &amp; Orchestration" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/"/>
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/Kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ OpenFaaS ã€å¿«é€Ÿå¼€å§‹</title>
    <link href="http://shenxianghong.github.io/2023/06/05/2023-06-05%20OpenFaaS%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"/>
    <id>http://shenxianghong.github.io/2023/06/05/2023-06-05%20OpenFaaS%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/</id>
    <published>2023-06-04T16:00:00.000Z</published>
    <updated>2023-07-05T09:56:10.152Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/openfaas/logo.png"></div><hr><p>OpenFaaS æ”¯æŒéƒ¨ç½²è‡³ä»¥ä¸‹ç¯å¢ƒä¸­ï¼š</p><ul><li>Kubernetesã€K3sã€OpenShift ç­‰å®¹å™¨ç¼–æ’ç¯å¢ƒ</li><li>è¿è¡Œ faasd æœåŠ¡çš„å•ç‚¹æœåŠ¡å™¨ç¯å¢ƒ</li></ul><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œä¸ Kubernetes ç­‰å®¹å™¨ç¼–æ’ç¯å¢ƒé›†æˆèƒ½å¤Ÿæä¾›æ›´å¥½çš„å¯æ‰©å±•èƒ½åŠ›ã€‚</p><h1 id="OpenFaaS-CE"><a href="#OpenFaaS-CE" class="headerlink" title="OpenFaaS CE"></a>OpenFaaS CE</h1><blockquote><p>based on <strong>0.26.3</strong></p></blockquote><p><em>OpenFaaS  Community Edition ç‰ˆæœ¬é¢å‘å†…éƒ¨ä½¿ç”¨ã€å¼€å‘å’Œæ¦‚å¿µéªŒè¯ã€‚</em></p><p>OpenFaaS CE å®‰è£…æ–¹æ³•ï¼š</p><ul><li><a href="https://arkade.dev/">arkade</a><br><em>arkade æœ¬è´¨ä¸Šä¸ºä¸€ç«™å¼éƒ¨ç½²å·¥å…·ï¼Œæ”¯æŒè®¸å¤šæœåŠ¡éƒ¨ç½²ï¼Œå…¶ä¸­å¯¹äº OpenFaaS æœåŠ¡æ”¯æŒå®Œå–„ã€‚å†…éƒ¨é›†æˆäº†äºŒè¿›åˆ¶çš„ä¸‹è½½ä¸ Helm chart çš„å®‰è£…ï¼Œarkade å°è£…äº† helm çš„å‚æ•°èµ‹å€¼ä¸éƒ¨ç½²ï¼Œä¹Ÿå°±æ˜¯åœ¨ helm ä¸­é€šè¿‡ â€“set è®¾ç½®çš„å˜é‡ï¼Œarkade é€šè¿‡ â€“flags çš„æ–¹å¼å¤„ç†äº†</em></li><li>Helm chartã€Flux æˆ–è€… ArgoCD</li><li>é™æ€ YAML é…ç½®æ–‡ä»¶</li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="faas-cli"><a href="#faas-cli" class="headerlink" title="faas-cli"></a>faas-cli</h3><p><strong>ä½¿ç”¨ arkade å®‰è£…</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… arkade</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSL https://get.arkade.dev | sudo -E sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… faas-cli</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arkade get faas-cli</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">mv</span> /root/.arkade/bin/faas-cli /usr/local/bin/</span></span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ bash å®‰è£…</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSL https://cli.openfaas.com | sh</span></span><br><span class="line">New version of faas-cli installed to /usr/local/bin</span><br><span class="line">Creating alias &#x27;faas&#x27; for &#x27;faas-cli&#x27;.</span><br></pre></td></tr></table></figure><h3 id="OpenFaaS"><a href="#OpenFaaS" class="headerlink" title="OpenFaaS"></a>OpenFaaS</h3><p><strong>ä½¿ç”¨ arkade å®‰è£…</strong></p><p><em>arkade å°è£…äº† helm çš„å‚æ•°èµ‹å€¼ä¸éƒ¨ç½²ï¼Œä¹Ÿå°±æ˜¯åœ¨ helm ä¸­é€šè¿‡ â€“set è®¾ç½®çš„å˜é‡ï¼Œarkade é€šè¿‡ â€“flags çš„æ–¹å¼å¤„ç†äº†</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… arkade</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSL https://get.arkade.dev | sudo -E sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é»˜è®¤å®‰è£…</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arkade install openfaas</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£…å¯é€‰å‚æ•°</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">arkade install openfaas --<span class="built_in">help</span></span></span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ helm å®‰è£…</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®‰è£… helm</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSLf https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¨èåˆ›å»ºä¸¤ä¸ª namespaceï¼šopenfaas å’Œ openfaas-fnï¼Œå‰è€…ç”¨äºéƒ¨ç½² OpenFaaS æœåŠ¡ç»„ä»¶ï¼Œåè€…ç”¨äºéƒ¨ç½²å‡½æ•°</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">arkade éƒ¨ç½²ä¸­ï¼Œé»˜è®¤åˆ›å»ºäº†è¿™ä¸¤ä¸ª namespace</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f https://raw.githubusercontent.com/openfaas/faas-netes/master/namespaces.yml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm repo add openfaas https://openfaas.github.io/faas-netes/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">helm repo update &amp;&amp; helm upgrade openfaas --install openfaas/openfaas --namespace openfaas</span></span><br></pre></td></tr></table></figure><p><strong>å®‰è£…ç»“æœ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deploy -n openfaas</span></span><br><span class="line">NAME           READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">alertmanager   1/1     1            1           71s</span><br><span class="line">gateway        1/1     1            1           71s</span><br><span class="line">nats           1/1     1            1           71s</span><br><span class="line">prometheus     1/1     1            1           71s</span><br><span class="line">queue-worker   1/1     1            1           71s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get svc -n openfaas</span></span><br><span class="line">NAME               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">alertmanager       ClusterIP   10.96.76.14     &lt;none&gt;        9093/TCP         74s</span><br><span class="line">gateway            ClusterIP   10.96.4.162     &lt;none&gt;        8080/TCP         74s</span><br><span class="line">gateway-external   NodePort    10.96.10.134    &lt;none&gt;        8080:31112/TCP   74s</span><br><span class="line">nats               ClusterIP   10.96.196.157   &lt;none&gt;        4222/TCP         74s</span><br><span class="line">prometheus         ClusterIP   10.96.166.131   &lt;none&gt;        9090/TCP         74s</span><br></pre></td></tr></table></figure><h2 id="ç½‘å…³è®¤è¯"><a href="#ç½‘å…³è®¤è¯" class="headerlink" title="ç½‘å…³è®¤è¯"></a>ç½‘å…³è®¤è¯</h2><p>è¿™é‡Œé‡‡ç”¨ NodePort çš„å½¢å¼éƒ¨ç½² OpenFaaS CE æœåŠ¡ã€‚å…¶ä¸­ï¼Œgateway-external ä¸ºå¯¹å¤–æš´éœ²çš„ç½‘å…³æœåŠ¡ï¼Œgateway ä¸ºå¯¹å†…æš´éœ²çš„ç½‘å…³æœåŠ¡ï¼Œå…¶åç«¯å‡ä¸º gateway Podã€‚æ— è®ºå“ªç§æ–¹å¼å‡é‡‡ç”¨ HTTP è®¤è¯ç™»å½•æ–¹å¼ï¼Œè®¤è¯ç”¨æˆ·åå’Œå¯†ç åœ¨ Secret ä¸­ä¿å­˜ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">USER=$(kubectl get secret -n openfaas basic-auth -o jsonpath=<span class="string">&quot;&#123;.data.basic-auth-user&#125;&quot;</span> | <span class="built_in">base64</span> --decode; <span class="built_in">echo</span>)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">PASSWORD=$(kubectl get secret -n openfaas basic-auth -o jsonpath=<span class="string">&quot;&#123;.data.basic-auth-password&#125;&quot;</span> | <span class="built_in">base64</span> --decode; <span class="built_in">echo</span>)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;OpenFaaS user: <span class="variable">$USER</span>&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> <span class="string">&quot;OpenFaaS password: <span class="variable">$PASSWORD</span>&quot;</span></span></span><br></pre></td></tr></table></figure><p><strong>gateway</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl rollout status -n openfaas deploy/gateway</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl port-forward -n openfaas svc/gateway 8080:8080 &amp;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> -n <span class="variable">$PASSWORD</span> | faas-cli login --username admin --password-stdin</span></span><br><span class="line">Calling the OpenFaaS server to validate the credentials...</span><br><span class="line">Handling connection for 8080</span><br><span class="line">credentials saved for admin http://127.0.0.1:8080</span><br></pre></td></tr></table></figure><p>é»˜è®¤ faas-cli æ“ä½œçš„ OpenFaaS å®ä¾‹ä¸º <code>http://127.0.0.1:8080</code>ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ â€“gateway è¿›ä¸€æ­¥æŒ‡å®šã€‚</p><p><strong>gateway-external</strong></p><p>HTTP è®¤è¯ç™»å½• gateway-external æš´éœ²çš„æœåŠ¡ï¼Œå³ <code>http://178.104.162.69:31112/ui/</code>ã€‚è®¤è¯åï¼Œå³å¯è¿›å…¥ OpenFaaS UIï¼š</p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/home.png"></div><h2 id="æ¨¡æ¿å•†åº—"><a href="#æ¨¡æ¿å•†åº—" class="headerlink" title="æ¨¡æ¿å•†åº—"></a>æ¨¡æ¿å•†åº—</h2><p>ç¤¾åŒºæä¾›çš„æ¨¡æ¿å•†åº—ä¸º <a href="https://github.com/openfaas/store/blob/master/templates.json%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%9D%A5%E6%BA%90%E8%87%AA">https://github.com/openfaas/store/blob/master/templates.jsonï¼Œå…¶ä¸­æ¥æºè‡ª</a> OpenFaaS å®˜æ–¹ç¤¾åŒºä¸å‘¨è¾¹ç¤¾åŒºã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&#123;</span><br><span class="line">        &quot;template&quot;: &quot;go&quot;,</span><br><span class="line">        &quot;platform&quot;: &quot;x86_64&quot;,</span><br><span class="line">        &quot;language&quot;: &quot;Go&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;openfaas&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;Legacy Golang template&quot;,</span><br><span class="line">        &quot;repo&quot;: &quot;https://github.com/openfaas/templates&quot;,</span><br><span class="line">        &quot;official&quot;: &quot;true&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;template&quot;: &quot;rust&quot;,</span><br><span class="line">        &quot;platform&quot;: &quot;x86_64&quot;,</span><br><span class="line">        &quot;language&quot;: &quot;Rust&quot;,</span><br><span class="line">        &quot;source&quot;: &quot;openfaas-incubator&quot;,</span><br><span class="line">        &quot;description&quot;: &quot;Community Rust template&quot;,</span><br><span class="line">        &quot;repo&quot;: &quot;https://github.com/openfaas-incubator/openfaas-rust-template&quot;,</span><br><span class="line">        &quot;official&quot;: &quot;false&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹é»˜è®¤æ”¯æŒçš„æ¨¡æ¿å•†åº—ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli template store list</span></span><br><span class="line">NAME                     RECOMMENDED DESCRIPTION        SOURCE</span><br><span class="line">bash-streaming           [x]         openfaas-incubator Bash Streaming template</span><br><span class="line">dockerfile               [x]         openfaas           Classic Dockerfile template</span><br><span class="line">golang-middleware        [x]         openfaas           HTTP middleware interface in Go</span><br><span class="line">java11-vert-x            [x]         openfaas           Java 11 Vert.x template</span><br><span class="line">node18                   [x]         openfaas           HTTP-based Node 18 template</span><br><span class="line">php8                     [x]         openfaas           Classic PHP 8 template</span><br><span class="line">python3-http             [x]         openfaas           Python 3 with Flask and HTTP</span><br><span class="line">python3-http-debian      [x]         openfaas           Python 3 with Flask and HTTP based on Debian</span><br><span class="line">ruby-http                [x]         openfaas           Ruby 2.4 HTTP template</span><br><span class="line">cobol                    [ ]         devries            COBOL Template</span><br><span class="line">crystal                  [ ]         tpei               Crystal template</span><br><span class="line">crystal-http             [ ]         koffeinfrei        Crystal HTTP template</span><br><span class="line">csharp-httprequest       [ ]         distantcam         C# HTTP template</span><br><span class="line">csharp-kestrel           [ ]         burtonr            C# Kestrel HTTP template</span><br><span class="line">lua53                    [ ]         affix              Lua 5.3 Template</span><br><span class="line">perl-alpine              [ ]         tmiklas            Perl language template based on Alpine image</span><br><span class="line">python3-dlrs             [ ]         intel              Deep Learning Reference Stack v0.4 for ML workloads</span><br><span class="line">quarkus-native           [ ]         pmlopes            Quarkus.io native image template</span><br><span class="line">rust                     [ ]         openfaas-incubator Community Rust template</span><br><span class="line">rust-http                [ ]         openfaas-incubator Community Rust template with HTTP bindings</span><br><span class="line">swift                    [ ]         affix              Swift 4.2 Template</span><br><span class="line">vala                     [ ]         affix              Vala Template</span><br><span class="line">vala-http                [ ]         affix              Non-Forking Vala Template</span><br><span class="line">vertx-native             [ ]         pmlopes            Eclipse Vert.x native image template</span><br><span class="line">csharp                   [ ]         openfaas           Classic C# template</span><br><span class="line">go                       [ ]         openfaas           Legacy Golang template</span><br><span class="line">golang-http              [ ]         openfaas           Request/response style HTTP template</span><br><span class="line">java11                   [ ]         openfaas           Java 11 template</span><br><span class="line">node                     [ ]         openfaas           Legacy Node 12 template</span><br><span class="line">node12                   [ ]         openfaas           HTTP-based Node 12 template</span><br><span class="line">node14                   [ ]         openfaas           HTTP-based Node 14 template</span><br><span class="line">node16                   [ ]         openfaas           HTTP-based Node 16 template</span><br><span class="line">node17                   [ ]         openfaas           HTTP-based Node 17 template</span><br><span class="line">php7                     [ ]         openfaas           Classic PHP 7 template</span><br><span class="line">powershell-http-template [ ]         openfaas-incubator Powershell Core HTTP Ubuntu:16.04 template</span><br><span class="line">powershell-template      [ ]         openfaas-incubator Powershell Core Ubuntu:16.04 template</span><br><span class="line">puppeteer-nodelts        [ ]         alexellis          A puppeteer template for headless Chrome</span><br><span class="line">python                   [ ]         openfaas           Classic Python 2.7 template</span><br><span class="line">python27-flask           [ ]         openfaas           Python 2.7 Flask template</span><br><span class="line">python3                  [ ]         openfaas           Classic Python 3 template</span><br><span class="line">python3-debian           [ ]         openfaas           Python 3 Debian template</span><br><span class="line">python3-flask            [ ]         openfaas           Python 3 Flask template</span><br><span class="line">python3-flask-debian     [ ]         openfaas           Python 3 Flask template based on Debian</span><br><span class="line">ruby                     [ ]         openfaas           Classic Ruby 2.5 template</span><br></pre></td></tr></table></figure><p>è·å–æ‰˜ç®¡åœ¨æ¨¡æ¿å•†åº—ä¸­çš„ OpenFaaS å®˜æ–¹ç»å…¸æ¨¡æ¿ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli template pull</span></span><br><span class="line">Fetch templates from repository: https://github.com/openfaas/templates.git at </span><br><span class="line">2023/06/05 17:15:07 Attempting to expand templates from https://github.com/openfaas/templates.git</span><br><span class="line">2023/06/05 17:15:09 Fetched 18 template(s) : [csharp dockerfile go java11 java11-vert-x node node12 node12-debian node14 node16 node17 node18 php7 php8 python python3 python3-debian ruby] from https://github.com/openfaas/templates.git</span><br></pre></td></tr></table></figure><p>è·å–æ‰˜ç®¡åœ¨æ¨¡æ¿å•†åº—ä¸­çš„æŒ‡å®šæ¨¡æ¿ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli template store pull rust</span></span><br><span class="line">Fetch templates from repository: https://github.com/openfaas-incubator/openfaas-rust-template at </span><br><span class="line">2023/06/05 17:41:58 Attempting to expand templates from https://github.com/openfaas-incubator/openfaas-rust-template</span><br><span class="line">2023/06/05 17:42:02 Fetched 1 template(s) : [rust] from https://github.com/openfaas-incubator/openfaas-rust-template</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡ â€“url å‚æ•°ï¼Œè·å–æŒ‡å®šæ¥æºçš„æ¨¡æ¿ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli template store pull --url=https://raw.githubusercontent.com/openfaas/store/master/templates.json</span></span><br></pre></td></tr></table></figure><p>è·å–åˆ°çš„æ¨¡æ¿æ–‡ä»¶ä¿å­˜åœ¨å½“å‰çš„ template ç›®å½•ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> template/</span></span><br><span class="line">csharp  dockerfile  go  java11  java11-vert-x  node  node12  node12-debian  node14  node16  node17  node18  php7  php8  python  python3  python3-debian  ruby</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree template/golang-middleware/</span></span><br><span class="line">template/golang-middleware/</span><br><span class="line">â”œâ”€â”€ Dockerfile# å‡½æ•°æœ€ç»ˆä¼šæ„å»ºæˆé•œåƒ</span><br><span class="line">â”œâ”€â”€ function# ä¸šåŠ¡ä»£ç ï¼Œæ¯”å¦‚å®ç° HTTP endpoint å¤„ç†è¯·æ±‚</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ go.mod</span><br><span class="line">â”‚Â Â  â””â”€â”€ handler.go</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.work</span><br><span class="line">â”œâ”€â”€ main.go# å‡½æ•°å…¥å£ï¼Œç”¨äºå¯åŠ¨ HTTP æœåŠ¡å™¨ï¼Œæ³¨å†Œ endpoint</span><br><span class="line">â””â”€â”€ template.yml# æ¨¡æ¿è¯´æ˜</span><br><span class="line"></span><br><span class="line">1 directory, 7 files</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli new --list</span></span><br><span class="line">Languages available as templates:</span><br><span class="line">- csharp</span><br><span class="line">- dockerfile</span><br><span class="line">- go</span><br><span class="line">- java11</span><br><span class="line">- java11-vert-x</span><br><span class="line">- node</span><br><span class="line">- node12</span><br><span class="line">- node12-debian</span><br><span class="line">- node14</span><br><span class="line">- node16</span><br><span class="line">- node17</span><br><span class="line">- node18</span><br><span class="line">- php7</span><br><span class="line">- php8</span><br><span class="line">- python</span><br><span class="line">- python3</span><br><span class="line">- python3-debian</span><br><span class="line">- ruby</span><br></pre></td></tr></table></figure><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><blockquote><p>based on <strong>Kubernetes 1.24.10</strong></p></blockquote><h3 id="åˆ›å»ºå‡½æ•°"><a href="#åˆ›å»ºå‡½æ•°" class="headerlink" title="åˆ›å»ºå‡½æ•°"></a>åˆ›å»ºå‡½æ•°</h3><p><em>è¿™é‡Œä»¥ Golang çš„ golang-middleware å‡½æ•°æ¨¡æ¿ä¸ºä¾‹ï¼Œè¯¥å‡½æ•°ä¸ºç®€å•çš„ HTTP è¯·æ±‚å“åº”ã€‚</em></p><table><thead><tr><th>å¯é€‰æ¨¡æ¿</th><th>æ‰˜ç®¡å•†åº—</th><th>watchdog</th><th>Go ç‰ˆæœ¬</th><th>åŸºç¡€ OS</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>go</td><td><a href="https://github.com/openfaas/templates">https://github.com/openfaas/templates</a></td><td>classic</td><td>1.18</td><td>Alpine Linux</td><td>Legacy Golang template</td></tr><tr><td>golang-middleware</td><td><a href="https://github.com/openfaas/golang-http-template">https://github.com/openfaas/golang-http-template</a></td><td>of-watchdog</td><td>1.19</td><td>Alpine Linux</td><td>HTTP middleware interface in Go</td></tr><tr><td>golang-http</td><td><a href="https://github.com/openfaas/golang-http-template">https://github.com/openfaas/golang-http-template</a></td><td>of-watchdog</td><td>1.19</td><td>Alpine Linux</td><td>Request&#x2F;response style HTTP template</td></tr></tbody></table><p>ä½¿ç”¨ golang-middleware æ¨¡æ¿åˆ›å»ºåä¸º go-fn çš„å‡½æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli new go-fn --lang golang-middleware</span></span><br><span class="line">Folder: go-fn created.</span><br><span class="line">  ___                   _____           ____</span><br><span class="line"> / _ \ _ __   ___ _ __ |  ___|_ _  __ _/ ___|</span><br><span class="line">| | | | &#x27;_ \ / _ \ &#x27;_ \| |_ / _` |/ _` \___ \</span><br><span class="line">| |_| | |_) |  __/ | | |  _| (_| | (_| |___) |</span><br><span class="line"> \___/| .__/ \___|_| |_|_|  \__,_|\__,_|____/</span><br><span class="line">      |_|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Function created in folder: go-fn</span><br><span class="line">Stack file written: go-fn.yml</span><br><span class="line"></span><br><span class="line">Notes:</span><br><span class="line">You have created a new function which uses Go 1.19 and Alpine</span><br><span class="line">Linux as its base image.</span><br><span class="line"></span><br><span class="line">To disable the go module, for private vendor code, please use</span><br><span class="line">&quot;--build-arg GO111MODULE=off&quot; with faas-cli build or configure this</span><br><span class="line">via your stack.yml file.</span><br><span class="line"></span><br><span class="line">See more: https://docs.openfaas.com/cli/templates/</span><br><span class="line"></span><br><span class="line">For the template&#x27;s repo and more examples:</span><br><span class="line">https://github.com/openfaas/golang-http-template</span><br></pre></td></tr></table></figure><p>å‡½æ•°æ¨¡æ¿åˆ›å»ºåï¼Œä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ go-fn ç›®å½•ï¼Œå…¶å†…å®¹æºè‡ªäº template&#x2F;golang-middleware&#x2F;function ä»¥åŠ go-fn.yml æ–‡ä»¶ï¼Œç”¨äºæè¿°å‡½æ•°æ„å»ºçš„å…·ä½“è§„æ ¼ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">1.0</span></span><br><span class="line"><span class="attr">provider:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">openfaas</span></span><br><span class="line">  <span class="attr">gateway:</span> <span class="string">http://127.0.0.1:8080</span></span><br><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">go-fn:</span></span><br><span class="line">    <span class="attr">lang:</span> <span class="string">golang-middleware</span></span><br><span class="line">    <span class="attr">handler:</span> <span class="string">./go-fn</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.archeros.cn/dev/ake/openfaas-fn:dev</span></span><br></pre></td></tr></table></figure><h3 id="æ„å»ºå‡½æ•°é•œåƒ"><a href="#æ„å»ºå‡½æ•°é•œåƒ" class="headerlink" title="æ„å»ºå‡½æ•°é•œåƒ"></a>æ„å»ºå‡½æ•°é•œåƒ</h3><p><code>faas-cli build</code> æ„å»ºå‡½æ•°æ—¶ï¼Œé»˜è®¤è¯»å–å½“å‰ç›®å½•ä¸‹çš„ stack.yml æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ -f æŒ‡å®šã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli build -f go-fn.yml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker images</span></span><br><span class="line">harbor.archeros.cn/dev/ake/openfaas-fn     dev     891e42d0a44c     23 minutes ago     21MB</span><br></pre></td></tr></table></figure><p>æ„å»ºæ—¶ä½¿ç”¨çš„ Dockerfile ä½äº build&#x2F;go-fn&#x2F;Dockerfileï¼ˆæºè‡ª template&#x2F;golang-middleware&#x2F;Dockerfileï¼‰ã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> --platform=$&#123;TARGETPLATFORM:-linux/amd64&#125; ghcr.io/openfaas/of-watchdog:<span class="number">0.9</span>.<span class="number">11</span> as watchdog</span><br><span class="line"><span class="keyword">FROM</span> --platform=$&#123;BUILDPLATFORM:-linux/amd64&#125; golang:<span class="number">1.19</span>-alpine as build</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> TARGETPLATFORM</span><br><span class="line"><span class="keyword">ARG</span> BUILDPLATFORM</span><br><span class="line"><span class="keyword">ARG</span> TARGETOS</span><br><span class="line"><span class="keyword">ARG</span> TARGETARCH</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add git</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=watchdog /fwatchdog /usr/bin/fwatchdog</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /usr/bin/fwatchdog</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /go/src/handler</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /go/src/handler</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> GO111MODULE=<span class="string">&quot;on&quot;</span></span><br><span class="line"><span class="keyword">ARG</span> GOPROXY=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">ARG</span> GOFLAGS=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">ARG</span> CGO_ENABLED=<span class="number">0</span></span><br><span class="line"><span class="keyword">ENV</span> CGO_ENABLED=$&#123;CGO_ENABLED&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run a gofmt and exclude all vendored code.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">test</span> -z <span class="string">&quot;<span class="subst">$(gofmt -l $(find . -type f -name &#x27;*.go&#x27; -not -path <span class="string">&quot;./vendor/*&quot;</span> -not -path <span class="string">&quot;./function/vendor/*&quot;</span>)</span>)&quot;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;Run \&quot;gofmt -s -w\&quot; on your Golang code&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /go/src/handler/function</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /go/src/handler/function/static</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> GOOS=<span class="variable">$&#123;TARGETOS&#125;</span> GOARCH=<span class="variable">$&#123;TARGETARCH&#125;</span> go <span class="built_in">test</span> ./... -cover</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /go/src/handler</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> GOOS=<span class="variable">$&#123;TARGETOS&#125;</span> GOARCH=<span class="variable">$&#123;TARGETARCH&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    go build --ldflags <span class="string">&quot;-s -w&quot;</span> -o handler .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> --platform=$&#123;TARGETPLATFORM:-linux/amd64&#125; alpine:<span class="number">3.17</span>.<span class="number">2</span> as ship</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add non root user and certs</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add ca-certificates \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; addgroup -S app &amp;&amp; adduser -S -g app app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Split instructions so that buildkit can run &amp; cache</span></span><br><span class="line"><span class="comment"># the previous command ahead of time.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /home/app \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chown</span> app /home/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build --<span class="built_in">chown</span>=app /go/src/handler/handler           .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build --<span class="built_in">chown</span>=app /usr/bin/fwatchdog                .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build --<span class="built_in">chown</span>=app /go/src/handler/function/static   static</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> fprocess=<span class="string">&quot;./handler&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> mode=<span class="string">&quot;http&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> upstream_url=<span class="string">&quot;http://127.0.0.1:8082&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> prefix_logs=<span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./fwatchdog&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œæ„å»ºå‚æ•°å¯ä»¥é€šè¿‡ stack.yml æ–‡ä»¶ä¸­çš„ build_args é€‰é¡¹æŒ‡å®šï¼Œæ•ˆæœç­‰ä»·äº <code>faas-cli build --build-arg key1=value1,key2=value2</code>ã€‚æœ€ç»ˆï¼Œbuild_args æŒ‡å®šçš„å‚æ•°ä¼šé€šè¿‡ docker build â€“build-arg é€ä¼ ç»™ Dockerfile ä¸­çš„ ARGã€‚</p><p>ä¾‹å¦‚ï¼ŒæŒ‡å®šä½¿ç”¨æœ¬åœ° vendor æ„å»º Golang åº”ç”¨</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">functions:</span></span><br><span class="line">  <span class="attr">with_go_modules:</span></span><br><span class="line">    <span class="attr">handler:</span> <span class="string">./with_go_modules</span></span><br><span class="line">    <span class="attr">lang:</span> <span class="string">go</span></span><br><span class="line">    <span class="attr">build_args:</span></span><br><span class="line">      <span class="attr">GO111MODULE:</span> <span class="string">off</span></span><br><span class="line">      <span class="attr">GOFLAGS:</span> <span class="string">&quot;-mod=vendor&quot;</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤å‡½æ•°åº”ç”¨é•œåƒæ‹‰å–ç­–ç•¥ä¸º Alwaysï¼Œéœ€è¦å°†é•œåƒæ¨é€è‡³è¿œç¨‹ä»“åº“ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli push -f go-fn.yml</span></span><br></pre></td></tr></table></figure><h3 id="å‘å¸ƒå‡½æ•°"><a href="#å‘å¸ƒå‡½æ•°" class="headerlink" title="å‘å¸ƒå‡½æ•°"></a>å‘å¸ƒå‡½æ•°</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli deploy -f go-fn.yml</span> </span><br><span class="line">Deploying: go-fn.</span><br><span class="line">Handling connection for 8080</span><br><span class="line"></span><br><span class="line">Deployed. 202 Accepted.</span><br><span class="line">URL: http://127.0.0.1:8080/function/go-fn</span><br></pre></td></tr></table></figure><p>å‡½æ•°å‘å¸ƒåï¼Œå¯¹åº”ç€ä¸€ä¸ª Deploy åˆ›å»ºã€‚OpenFaaS CE ç‰ˆæœ¬ä¸­ï¼Œå‰¯æœ¬æ•°æœ€å°ä¸º 1ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod -n openfaas-fn</span></span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">go-fn-757f844cc5-v5tvn   1/1     Running   0          8s</span><br></pre></td></tr></table></figure><p>Pod çš„å…³é”®å‚æ•°ä¸ºï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fprocess</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">./handler</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">harbor.archeros.cn/dev/ake/openfaas-fn:dev</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/_/health</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">go-fn</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/_/health</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kube-api-access-b7kx5</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">wnx</span></span><br><span class="line">  <span class="attr">preemptionPolicy:</span> <span class="string">PreemptLowerPriority</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kube-api-access-b7kx5</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">serviceAccountToken:</span></span><br><span class="line">          <span class="attr">expirationSeconds:</span> <span class="number">3607</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">token</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">ca.crt</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">ca.crt</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kube-root-ca.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">downwardAPI:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">namespace</span></span><br></pre></td></tr></table></figure><p>å·²å‘å¸ƒçš„å‡½æ•°ä¸­ï¼ŒInvocations ä¸ºè°ƒç”¨æ¬¡æ•°ï¼ŒReplicas ä¸ºå½“å‰å‡½æ•°åº”ç”¨çš„å‰¯æœ¬ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli list</span></span><br><span class="line">Function    Invocations    Replicas</span><br><span class="line">go-fn        0              1   </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas describe go-fn</span></span><br><span class="line">Name:               go-fn</span><br><span class="line">Status:             Not Ready</span><br><span class="line">Replicas:           1</span><br><span class="line">Available Replicas: 0</span><br><span class="line">Invocations:        17542</span><br><span class="line">Image:              harbor.archeros.cn/dev/ake/openfaas-fn:dev</span><br><span class="line">Function Process:   ./handler</span><br><span class="line">URL:                http://127.0.0.1:8080/function/go-fn</span><br><span class="line">Async URL:          http://127.0.0.1:8080/async-function/go-fn</span><br><span class="line">Labels:</span><br><span class="line"> faas_function: go-fn</span><br><span class="line">Annotations:</span><br><span class="line"> prometheus.io.scrape: false</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡éƒ¨ç½²æ—¶æŒ‡å®š â€“label é™åˆ¶æ‰©å®¹è§„æ ¼ç­‰ä¿¡æ¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli deploy -f go-fn.yml --label com.openfaas.scale.max=2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ­¤æ—¶æ— è®ºå¤šå¤§çš„è¯·æ±‚é‡ï¼Œæœ€å¤§æ‰©å®¹è§„æ ¼ä¸º 2 å‰¯æœ¬</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli describe go-fn</span></span><br><span class="line">Name:               go-fn</span><br><span class="line">Status:             Ready</span><br><span class="line">Replicas:           2</span><br><span class="line">Available Replicas: 2</span><br><span class="line">Invocations:        21517</span><br><span class="line">Image:              harbor.archeros.cn/dev/ake/openfaas-fn:dev</span><br><span class="line">Function Process:   ./handler</span><br><span class="line">URL:                http://127.0.0.1:8080/function/go-fn</span><br><span class="line">Async URL:          http://127.0.0.1:8080/async-function/go-fn</span><br><span class="line">Labels:</span><br><span class="line"> com.openfaas.scale.max: 2</span><br><span class="line"> faas_function: go-fn</span><br><span class="line">Annotations:</span><br><span class="line"> prometheus.io.scrape: false</span><br></pre></td></tr></table></figure><p>é™¤äº† faas-cliï¼Œå‡½æ•°çš„åˆ›å»ºã€æ„å»ºä¸å‘å¸ƒä¹Ÿå¯ä»¥é€šè¿‡ OpenFaaS UI æ“ä½œï¼š</p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/deploy.png"></div><h3 id="è°ƒç”¨å‡½æ•°"><a href="#è°ƒç”¨å‡½æ•°" class="headerlink" title="è°ƒç”¨å‡½æ•°"></a>è°ƒç”¨å‡½æ•°</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli invoke go-fn</span></span><br><span class="line">Reading from STDIN - hit (Control + D) to stop.</span><br><span class="line">Hello World</span><br><span class="line">Body: Hello World</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç­‰ä»·äº</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> Hello World | faas-cli invoke go-fn</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli invoke go-fn --from-literal=<span class="string">&quot;Hello World&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli invoke go-fn --from-file=~/Downloads/derek.pem</span></span><br></pre></td></tr></table></figure><p>UI è°ƒç”¨æ–¹å¼ä¸ºï¼š</p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/invoke.png"></div><p>æ­¤å¤–ï¼Œæ ¹æ®å‡½æ•°è°ƒç”¨çš„è·¯ç”±ï¼Œä¹Ÿåˆ†ä¸ºåŒæ­¥è°ƒç”¨ä¸å¼‚æ­¥è°ƒç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åŒæ­¥è°ƒç”¨ <span class="keyword">function</span> è·¯ç”±</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -i -d <span class="string">&quot;Hello World&quot;</span> http://127.0.0.1:8080/function/go-fn</span></span><br><span class="line">Handling connection for 8080</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Length: 17</span><br><span class="line">Content-Type: text/plain; charset=utf-8</span><br><span class="line">Date: Fri, 09 Jun 2023 03:43:13 GMT</span><br><span class="line">X-Call-Id: 98630f05-1b39-4fc5-bb89-7c2c66c1cf7f</span><br><span class="line">X-Duration-Seconds: 0.002147</span><br><span class="line">X-Start-Time: 1686282193791968394</span><br><span class="line"></span><br><span class="line">Body: Hello World</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¼‚æ­¥è°ƒç”¨ async-function è·¯ç”±</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -i -d <span class="string">&quot;Hello World&quot;</span> http://127.0.0.1:8080/async-function/go-fn</span></span><br><span class="line">Handling connection for 8080</span><br><span class="line">HTTP/1.1 202 Accepted</span><br><span class="line">X-Call-Id: fea5f39d-e7ad-4454-8283-1a213710f3a7</span><br><span class="line">X-Start-Time: 1686282228379248896</span><br><span class="line">Date: Fri, 09 Jun 2023 03:43:48 GMT</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure><h3 id="è‡ªåŠ¨æ‰©ç¼©å®¹"><a href="#è‡ªåŠ¨æ‰©ç¼©å®¹" class="headerlink" title="è‡ªåŠ¨æ‰©ç¼©å®¹"></a>è‡ªåŠ¨æ‰©ç¼©å®¹</h3><p>æ¨¡æ‹Ÿæµ·é‡è¯·æ±‚ï¼Œè§‚å¯Ÿ OpenFaaS å‡½æ•°åº”ç”¨çš„è‡ªåŠ¨æ‰©å®¹ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="keyword">while</span> <span class="literal">true</span> ;<span class="keyword">do</span> <span class="built_in">echo</span> Hello World | faas-cli invoke go-fn; <span class="keyword">done</span></span></span><br></pre></td></tr></table></figure><p>éšç€è¯·æ±‚è°ƒç”¨é‡çš„å¢åŠ ï¼Œå‰¯æœ¬æ•°ä¹Ÿé€æ¸å¢åŠ ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deploy -n openfaas-fn   go-fn -w</span></span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">go-fn   1/1     1            1           7m57s</span><br><span class="line">go-fn   1/2     2            1           8m35s</span><br><span class="line">go-fn   2/2     2            2           8m38s</span><br><span class="line">go-fn   2/3     3            2           9m15s</span><br><span class="line">go-fn   3/3     3            3           9m18s</span><br><span class="line">go-fn   3/4     3            3           9m55s</span><br><span class="line">go-fn   4/4     4            4           9m59s</span><br><span class="line">go-fn   4/5     4            4           10m</span><br><span class="line">go-fn   5/5     5            5           10m</span><br></pre></td></tr></table></figure><p>å½“åœæ­¢æ¨¡æ‹Ÿè¯·æ±‚æ—¶ï¼Œå‰¯æœ¬æ•°ä¹Ÿé€æ¸å‡å°‘ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deploy -n openfaas-fn   go-fn -w</span></span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">go-fn   5/5     5            5           11m</span><br><span class="line">go-fn   5/1     5            5           11m</span><br><span class="line">go-fn   1/1     1            1           11m</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡éƒ¨ç½²æ—¶æŒ‡å®š â€“label é™åˆ¶æ‰©å®¹è§„æ ¼ç­‰ä¿¡æ¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli deploy -f go-fn.yml --label com.openfaas.scale.max=2</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli describe go-fn</span></span><br><span class="line">Name:               go-fn</span><br><span class="line">Status:             Ready</span><br><span class="line">Replicas:           2</span><br><span class="line">Available Replicas: 2</span><br><span class="line">Invocations:        21517</span><br><span class="line">Image:              harbor.archeros.cn/dev/ake/openfaas-fn:dev</span><br><span class="line">Function Process:   ./handler</span><br><span class="line">URL:                http://127.0.0.1:8080/function/go-fn</span><br><span class="line">Async URL:          http://127.0.0.1:8080/async-function/go-fn</span><br><span class="line">Labels:</span><br><span class="line"> com.openfaas.scale.max: 2</span><br><span class="line"> faas_function: go-fn</span><br><span class="line">Annotations:</span><br><span class="line"> prometheus.io.scrape: false</span><br></pre></td></tr></table></figure><h3 id="å‡½æ•°æ—¥å¿—"><a href="#å‡½æ•°æ—¥å¿—" class="headerlink" title="å‡½æ•°æ—¥å¿—"></a>å‡½æ•°æ—¥å¿—</h3><p>é’ˆå¯¹ Kubernetes çš„æ—¥å¿— provider ä¸º faas-netes ç»„ä»¶ï¼Œå…¶è·å–æ—¥å¿—çš„æ–¹å¼ç­‰ä»·äº <code>kubectl logs -n openfaas-fn deploy/function</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli logs go-fn</span></span><br><span class="line">2023-06-07T16:15:23+08:00 2023/06/07 08:15:23 POST / - 200 OK - ContentLength: 18B (0.0008s)</span><br><span class="line">2023-06-07T16:15:23+08:00 2023/06/07 08:15:23 POST / - 200 OK - ContentLength: 18B (0.0005s)</span><br><span class="line">2023-06-07T16:15:24+08:00 2023/06/07 08:15:24 POST / - 200 OK - ContentLength: 18B (0.0015s)</span><br><span class="line">2023-06-07T16:15:24+08:00 2023/06/07 08:15:24 POST / - 200 OK - ContentLength: 18B (0.0007s)</span><br><span class="line">2023-06-07T16:15:24+08:00 2023/06/07 08:15:24 POST / - 200 OK - ContentLength: 18B (0.0017s)</span><br></pre></td></tr></table></figure><h3 id="ç§»é™¤å‡½æ•°"><a href="#ç§»é™¤å‡½æ•°" class="headerlink" title="ç§»é™¤å‡½æ•°"></a>ç§»é™¤å‡½æ•°</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli remove go-fn</span></span><br><span class="line">Deleting: go-fn.</span><br><span class="line">Handling connection for 8080</span><br><span class="line">Removing old function.</span><br></pre></td></tr></table></figure><h2 id="Secret-ç®¡ç†"><a href="#Secret-ç®¡ç†" class="headerlink" title="Secret ç®¡ç†"></a>Secret ç®¡ç†</h2><p>ä¹‹æ‰€ä»¥äºŒæ¬¡å°è£… APIï¼Œæ˜¯ä¸ºäº†ä¾¿äºç®¡ç†å‡½æ•°æ‰€ç”¨åˆ°çš„ Secretã€‚</p><p>é»˜è®¤æ“ä½œçš„ Secret ä½äº openfaas-fn å‘½åç©ºé—´ä¸‹ï¼Œå¯ä»¥é€šè¿‡ â€“namespace æŒ‡å®šï¼›é»˜è®¤æ“ä½œçš„ OpenFaaS å®ä¾‹ä¸º </p><p><strong>create</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret create my-secret</span></span><br><span class="line">Reading from STDIN - hit (Control + D) to stop.</span><br><span class="line">my-password</span><br><span class="line">Creating secret: my-secret.</span><br><span class="line">Handling connection for 8080</span><br><span class="line">Created: 202 Accepted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç­‰ä»·äº</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> my-password | faas-cli secret create my-secret</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret create my-secret --from-literal=<span class="string">&quot;my-password&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret create my-secret --from-file=~/Downloads/derek.pem</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">my-secret:</span> <span class="string">bXktcGFzc3dvcmQ=</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">&quot;2023-06-07T06:19:14Z&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/managed-by:</span> <span class="string">openfaas</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">openfaas-fn</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">&quot;11584461&quot;</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">dd0803f2-76d8-453a-a770-ec2633cd6b22</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br></pre></td></tr></table></figure><p><strong>update</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret update my-secret</span></span><br><span class="line">Reading from STDIN - hit (Control + D) to stop.</span><br><span class="line">my-new-pasword</span><br><span class="line">Updating secret: my-secret</span><br><span class="line">Handling connection for 8080</span><br><span class="line">Updated: 202 Accepted</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç­‰ä»·äº</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">echo</span> my-new-secret | faas-cli secret update my-secret</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret update my-secret --from-literal=<span class="string">&quot;my-password&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret update my-secret --from-file=~/Downloads/derek.pem</span></span><br></pre></td></tr></table></figure><p><strong>list</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret list</span></span><br><span class="line">Handling connection for 8080</span><br><span class="line"></span><br><span class="line">NAME</span><br><span class="line">my-secret</span><br></pre></td></tr></table></figure><p><strong>delete</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli secret remove my-secret</span></span><br><span class="line">faas-cli secret remove my-secret</span><br><span class="line">Handling connection for 8080</span><br><span class="line">Removed.. OK.</span><br></pre></td></tr></table></figure><h1 id="OpenFaaS-Pro"><a href="#OpenFaaS-Pro" class="headerlink" title="OpenFaaS Pro"></a>OpenFaaS Pro</h1><blockquote><p>based on <strong>0.26.3</strong></p></blockquote><p><em>OpenFaaS Pro æ˜¯ OpenFaaS çš„å•†ä¸šè®¸å¯å‘è¡Œç‰ˆï¼Œå…·æœ‰é™„åŠ åŠŸèƒ½ã€é…ç½®å’Œå•†ä¸šæ”¯æŒã€‚</em></p><h2 id="å®‰è£…-1"><a href="#å®‰è£…-1" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="faas-cli-pro"><a href="#faas-cli-pro" class="headerlink" title="faas-cli pro"></a>faas-cli pro</h3><p>faas-cli å¯¹äº OpenFaaS Pro çš„æ”¯æŒæ˜¯é€šè¿‡æ’ä»¶çš„æ–¹å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli plugin get pro</span></span><br><span class="line">Fetching plugin: pro</span><br><span class="line">Downloaded in (4s)</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  faas-cli pro</span><br></pre></td></tr></table></figure><p>æ ¹æ® github è´¦å·æ ¡éªŒ OpenFaaS Pro è´­ä¹°è®¤è¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faas-cli pro <span class="built_in">enable</span></span></span><br><span class="line">Please visit: https://github.com/login/device</span><br><span class="line">and enter the code: 168C-29B2</span><br><span class="line">Waiting for authorization...</span><br><span class="line">Waiting for authorization...</span><br><span class="line">Waiting for authorization...</span><br><span class="line">Waiting for authorization...</span><br><span class="line">GET https://api.github.com/user/memberships/orgs: 401 Bad credentials []</span><br></pre></td></tr></table></figure><h2 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h2><h3 id="Support"><a href="#Support" class="headerlink" title="Support"></a>Support</h3><table><thead><tr><th align="left">Description</th><th align="left">OpenFaaS CE</th><th align="left">OpenFaaS Pro</th><th align="left">OpenFaaS for Enterprise</th></tr></thead><tbody><tr><td align="left">Suitability</td><td align="left">Open Source developers and initial exploration</td><td align="left">Production, business critical, or PoC</td><td align="left">Regulated companies which may have additional legal and compliance requirements</td></tr><tr><td align="left">SLA</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left">Response within 1 business day for P1</td></tr><tr><td align="left">Buying process</td><td align="left">N&#x2F;a</td><td align="left">Invoice paid by bank transfer</td><td align="left">Supplier portals, custom paperwork, negotiation with procurement.</td></tr><tr><td align="left">Legal review of contract</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left">Yes</td></tr><tr><td align="left">Signing of Mutual NDA</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left">Subject to agreement</td></tr><tr><td align="left">Additional compliance needs</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left">Subject to agreement</td></tr><tr><td align="left">Support via email</td><td align="left">N&#x2F;a</td><td align="left">Pro features only</td><td align="left">All certified Open Source and commercial components</td></tr><tr><td align="left">Support via GitHub</td><td align="left">N&#x2F;a</td><td align="left">Pro features only using the Customer Community</td><td align="left">N&#x2F;a</td></tr><tr><td align="left">Support via Slack</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left">Up to 5 developers</td></tr><tr><td align="left">License</td><td align="left"><a href="https://github.com/openfaas/faas/blob/master/LICENSE">MIT</a></td><td align="left"><a href="https://github.com/openfaas/faas/blob/master/pro/EULA">Commercial license EULA</a></td><td align="left">As per Pro</td></tr><tr><td align="left">Architecture review</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left">With our team via Zoom</td></tr><tr><td align="left">Onboarding call</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left">With our team via Zoom</td></tr><tr><td align="left"><a href="https://github.com/openfaas/customers">Customer Community</a></td><td align="left">N&#x2F;a</td><td align="left">Private access to <a href="https://github.com/openfaas/customers">Customer Community</a> - one user per licensed cluster</td><td align="left">Custom amount of users</td></tr></tbody></table><h3 id="Autoscaling"><a href="#Autoscaling" class="headerlink" title="Autoscaling"></a>Autoscaling</h3><table><thead><tr><th align="left">Description</th><th align="left">OpenFaaS CE</th><th align="left">OpenFaaS Pro</th><th align="left">OpenFaaS for Enterprise</th></tr></thead><tbody><tr><td align="left">Scale to Zero</td><td align="left">Not supported</td><td align="left"><a href="https://docs.openfaas.com/openfaas-pro/scale-to-zero">Global default, or custom time per function</a></td><td align="left">As per Pro</td></tr><tr><td align="left">Maximum replicas per function</td><td align="left">5 Pods</td><td align="left">No limit applied</td><td align="left">As per Pro</td></tr><tr><td align="left">Scale to From</td><td align="left">Not supported</td><td align="left">Supported, with additional checks for Istio</td><td align="left">As per Pro</td></tr><tr><td align="left">Autoscaling strategy</td><td align="left">RPS-only</td><td align="left"><a href="https://docs.openfaas.com/architecture/autoscaling">CPU utilization, Capacity (inflight requests) or RPS</a></td><td align="left">As per Pro</td></tr><tr><td align="left">Autoscaling granularity</td><td align="left">Single rule for all functions</td><td align="left">Configurable per function</td><td align="left">As per Pro</td></tr></tbody></table><h3 id="Core-Features"><a href="#Core-Features" class="headerlink" title="Core Features"></a>Core Features</h3><table><thead><tr><th align="left">Description</th><th align="left">OpenFaaS CE</th><th align="left">OpenFaaS Pro</th><th align="left">OpenFaaS for Enterprise</th></tr></thead><tbody><tr><td align="left">UI Dashboard</td><td align="left">Legacy UI (in code-freeze)</td><td align="left"><a href="https://docs.openfaas.com/openfaas-pro/dashboard">New UI dashboard</a> with metrics, logs &amp; CI integration</td><td align="left">As per Pro, but with support for multiple namespaces</td></tr><tr><td align="left">Consume secrets in <code>faas-cli build</code> for npm, Go and Pypy</td><td align="left">Not available</td><td align="left">Via build-time secrets</td><td align="left">As Per Pro</td></tr><tr><td align="left">Kubernetes service accounts for functions</td><td align="left">N&#x2F;a</td><td align="left"><a href="https://docs.openfaas.com/reference/workloads">Supported per function</a></td><td align="left">As per Pro</td></tr><tr><td align="left">Async &#x2F; queueing</td><td align="left">In-memory only, max 10 items in queue, 256KB message size</td><td align="left">JetStream with shared queue</td><td align="left">JetStream with dedicated queues</td></tr><tr><td align="left">Metrics</td><td align="left">Basic function metrics</td><td align="left">Function, HTTP, CPU&#x2F;RAM usage, and async&#x2F;queue metrics</td><td align="left">As per Pro</td></tr><tr><td align="left">CPU &amp; RAM utilization</td><td align="left">Not available</td><td align="left">Integrated with Prometheus metrics, OpenFaaS REST API &amp; CLI</td><td align="left">As per Pro</td></tr><tr><td align="left">Grafana Dashboards</td><td align="left">N&#x2F;a</td><td align="left">4x dashboards supplied in <a href="https://github.com/openfaas/customers">Customer Community</a> - overview, spotlight for debugging a function, queue-worker and Function Builder API</td><td align="left">As per Pro</td></tr><tr><td align="left">GitOps &amp; CRD support</td><td align="left">Not available</td><td align="left">ArgoCD, FluxCD and Helm compatibility using the Function CRD</td><td align="left">As per Pro</td></tr><tr><td align="left">Deployment options</td><td align="left">faas-cli or REST API</td><td align="left">As per CE, plus: Function CRD with kubectl, Helm or GitOps</td><td align="left">As per Pro</td></tr><tr><td align="left">Custom Resource Definition</td><td align="left">Not available</td><td align="left">Function and Profile</td><td align="left"></td></tr></tbody></table><h3 id="Event-Connectors"><a href="#Event-Connectors" class="headerlink" title="Event Connectors"></a>Event Connectors</h3><table><thead><tr><th align="left">Description</th><th align="left">OpenFaaS CE</th><th align="left">OpenFaaS Pro</th><th align="left">OpenFaaS for Enterprise</th></tr></thead><tbody><tr><td align="left">Number of topics per function</td><td align="left">One topic per function</td><td align="left">Multiple topics per function</td><td align="left">As per Pro</td></tr><tr><td align="left"><a href="https://docs.openfaas.com/openfaas-pro/kafka-events">Kafka event trigger</a></td><td align="left">Not supported</td><td align="left">Supports SASL or TLS auth, Aiven, Confluent and self-hosted</td><td align="left">Support with SLA</td></tr><tr><td align="left"><a href="https://docs.openfaas.com/openfaas-pro/postgres-events">Postgres trigger</a></td><td align="left">Not supported</td><td align="left">Supports insert, update and delete, with table-level filters using WAL or LISTEN&#x2F;NOTIFY.</td><td align="left">Support with SLA</td></tr><tr><td align="left"><a href="https://docs.openfaas.com/openfaas-pro/sqs-events">AWS SQS trigger</a></td><td align="left">Not supported</td><td align="left">Standard support</td><td align="left">Support with SLA</td></tr><tr><td align="left"><a href="https://docs.openfaas.com/reference/cron">Cron and scheduled invocations</a></td><td align="left">Community support</td><td align="left">Standard support</td><td align="left">Support with SLA</td></tr></tbody></table><h3 id="Durability-and-Reliability"><a href="#Durability-and-Reliability" class="headerlink" title="Durability and Reliability"></a>Durability and Reliability</h3><table><thead><tr><th align="left">Description</th><th align="left">OpenFaaS CE</th><th align="left">OpenFaaS Pro</th><th align="left">OpenFaaS for Enterprise</th></tr></thead><tbody><tr><td align="left">Readiness probes</td><td align="left">Not supported</td><td align="left"><a href="https://docs.openfaas.com/reference/workloads">Readiness probes</a> supported with custom HTTP path and intervals per function</td><td align="left">As per Pro</td></tr><tr><td align="left">Retries for failed function invocations</td><td align="left">Not supported</td><td align="left"><a href="https://docs.openfaas.com/openfaas-pro/retries">Retry invocations</a> for configured HTTP codes with an exponential back-off</td><td align="left">As per Pro</td></tr><tr><td align="left">Highly Available messaging</td><td align="left">Not available, in-memory only</td><td align="left">Available for NATS JetStream, with 3x servers.</td><td align="left">As per Pro</td></tr><tr><td align="left">Long executions of async functions</td><td align="left">Limited to 5 minutes</td><td align="left">Configurable duration</td><td align="left">As per Pro</td></tr><tr><td align="left">Callback to custom URL for async functions</td><td align="left">Supported</td><td align="left">As per CE</td><td align="left">As per CE</td></tr></tbody></table><h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><table><thead><tr><th align="left">Description</th><th align="left">OpenFaaS CE</th><th align="left">OpenFaaS Pro</th><th align="left">OpenFaaS for Enterprise</th></tr></thead><tbody><tr><td align="left">Authentication for OpenFaaS API, CLI and UI</td><td align="left">Shared admin password between everyone who uses OpenFaaS</td><td align="left">N&#x2F;a</td><td align="left"><a href="https://docs.openfaas.com/openfaas-pro/sso">Single Sign-On with OIDC</a></td></tr><tr><td align="left">Compatibility with Istio for mTLS</td><td align="left">N&#x2F;a</td><td align="left">Supported</td><td align="left">As per Pro</td></tr><tr><td align="left">PCI&#x2F;GDPR compliance</td><td align="left">Sensitive information such as the request body&#x2F;response body, headers may be printed into the logs for each asynchronous invocation</td><td align="left">Sensitive information is not printed to the logs for asynchronous requests</td><td align="left">As per Pro</td></tr><tr><td align="left">Secure isolation with Kata containers or gVisor</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left">Supported using an <a href="https://docs.openfaas.com/reference/profiles">OpenFaaS Pro Profile and runtimeClass</a></td></tr><tr><td align="left"><a href="https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/#accessing-the-service">Service links</a> injected as environment variables</td><td align="left">Yes, cannot be disabled</td><td align="left">Disabled as a default</td><td align="left">As per Pro</td></tr><tr><td align="left"><a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/#restricted">Pod privilege escalation</a></td><td align="left">Default for Kubernetes</td><td align="left">Explicitly disabled</td><td align="left">As per Pro</td></tr><tr><td align="left">Split installation without ClusterAdmin role</td><td align="left">N&#x2F;a</td><td align="left">Provided in <a href="https://github.com/openfaas/customers">Customer Community</a></td><td align="left">As per Pro</td></tr></tbody></table><h3 id="Platform-Features"><a href="#Platform-Features" class="headerlink" title="Platform Features"></a>Platform Features</h3><table><thead><tr><th align="left">Description</th><th align="left">OpenFaaS CE</th><th align="left">OpenFaaS Pro</th><th align="left">OpenFaaS for Enterprise</th></tr></thead><tbody><tr><td align="left">Deploy functions via REST API</td><td align="left">Yes</td><td align="left">As per CE</td><td align="left">As per CE</td></tr><tr><td align="left">Build containers and functions via REST API</td><td align="left">N&#x2F;a</td><td align="left">N&#x2F;a</td><td align="left"><a href="https://docs.openfaas.com/openfaas-pro/builder">Yes via Function Builder API</a></td></tr><tr><td align="left">Multiple namespace support</td><td align="left">No support</td><td align="left">N&#x2F;a</td><td align="left">Supported with Kubernetes namespaces</td></tr></tbody></table><h1 id="faasd"><a href="#faasd" class="headerlink" title="faasd"></a>faasd</h1><blockquote><p>based on <strong>0.16.9</strong></p></blockquote><p>faasd æ˜¯ OpenFaaS çš„é‡æ–°æ„æƒ³ï¼Œä½†æ²¡æœ‰ Kubernetes çš„æˆæœ¬å’Œå¤æ‚æ€§ã€‚å…¶æœ¬è´¨å°±æ˜¯ä¸€ä¸ª Golang äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå®ƒå¯ä»¥åœ¨è¦æ±‚éå¸¸ä½çš„å•ä¸ªä¸»æœºä¸Šè¿è¡Œï¼Œä½¿å…¶å¿«é€Ÿä¸”æ˜“äºç®¡ç†ã€‚åœ¨åº•å±‚ï¼Œå®ƒä½¿ç”¨ Containerd å’Œ CNI ä»¥åŠæ¥è‡ªä¸»é¡¹ç›®çš„ç›¸åŒæ ¸å¿ƒ OpenFaaS ç»„ä»¶ï¼Œå› æ­¤åœ¨ä½¿ç”¨å±‚é¢å¯ä»¥å®Œå…¨å‚è€ƒ OpenFaaS CE çš„æ“ä½œã€‚</p><h2 id="å®‰è£…-2"><a href="#å®‰è£…-2" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/openfaas/faasd/releases/download/0.16.9/faasd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x faasd &amp;&amp; <span class="built_in">mv</span> faasd /usr/local/bin</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">basic-auth-user å’Œ secrets/basic-auth-password ä¸ºç½‘å…³è®¤è¯çš„ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">faasd install</span></span><br><span class="line">2023/06/08 17:53:15 Writing to: &quot;/var/lib/faasd/secrets/basic-auth-password&quot;</span><br><span class="line">2023/06/08 17:53:15 Writing to: &quot;/var/lib/faasd/secrets/basic-auth-user&quot;</span><br><span class="line">Check status with:</span><br><span class="line">  sudo journalctl -u faasd --lines 100 -f</span><br><span class="line"></span><br><span class="line">Login with:</span><br><span class="line">  sudo cat /var/lib/faasd/secrets/basic-auth-password | faas-cli login -s</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">systemctl status faasd</span></span><br><span class="line">â— faasd.service - faasd</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/faasd.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2023-06-08 17:53:17 CST; 4min 26s ago</span><br><span class="line"> Main PID: 43031 (faasd)</span><br><span class="line">    Tasks: 11</span><br><span class="line">   Memory: 30.9M (limit: 500.0M)</span><br><span class="line">   CGroup: /system.slice/faasd.service</span><br><span class="line">           â””â”€43031 /usr/local/bin/faasd up</span><br><span class="line"></span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Looking up IP for: &quot;prometheus&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;localhost&quot;=&quot;127.0.0.1&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;faasd-provider&quot;=&quot;10.62.0.1&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;nats&quot;=&quot;10.62.0.2&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;prometheus&quot;=&quot;10.62.0.3&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;gateway&quot;=&quot;10.62.0.4&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Resolver: &quot;queue-worker&quot;=&quot;10.62.0.5&quot;</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Proxy from: 127.0.0.1:9090, to: prometheus:9090 (10.62.0.3)</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 faasd: waiting for SIGTERM or SIGINT</span><br><span class="line">Jun 08 17:54:34 wnx faasd[43031]: 2023/06/08 17:54:34 Proxy from: 0.0.0.0:8080, to: gateway:8080 (10.62.0.4)</span><br></pre></td></tr></table></figure><p>é€šè¿‡æœåŠ¡çŠ¶æ€å¯ä»¥çœ‹åˆ°ï¼Œ10.62.0.1 ~ 10.62.0.5 ç”¨äºç›‘å¬ OpenFaaS æ ¸å¿ƒæœåŠ¡ï¼Œä½äº Containerd çš„ openfaas å‘½åç©ºé—´ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ctr -n openfaas c <span class="built_in">ls</span></span></span><br><span class="line">CONTAINER       IMAGE                                      RUNTIME                  </span><br><span class="line">gateway         ghcr.io/openfaas/gateway:0.26.3            io.containerd.runc.v2    </span><br><span class="line">nats            docker.io/library/nats-streaming:0.25.3    io.containerd.runc.v2    </span><br><span class="line">prometheus      docker.io/prom/prometheus:v2.42.0          io.containerd.runc.v2    </span><br><span class="line">queue-worker    ghcr.io/openfaas/queue-worker:0.13.3       io.containerd.runc.v2 </span><br></pre></td></tr></table></figure><h2 id="ç½‘å…³è®¤è¯-1"><a href="#ç½‘å…³è®¤è¯-1" class="headerlink" title="ç½‘å…³è®¤è¯"></a>ç½‘å…³è®¤è¯</h2><p>å¤–éƒ¨ç½‘å…³ä¸º <code>http://178.104.162.69:8080/ui</code>ï¼Œè®¤è¯ä¿¡æ¯ä½äº &#x2F;var&#x2F;lib&#x2F;faasd&#x2F;secrets&#x2F;basic-auth-user å’Œ &#x2F;var&#x2F;lib&#x2F;faasd&#x2F;secrets&#x2F;basic-auth-passwordã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /var/lib/faasd/secrets/basic-auth-password | faas-cli login -s</span></span><br><span class="line">Calling the OpenFaaS server to validate the credentials...</span><br><span class="line">credentials saved for admin http://127.0.0.1:8080</span><br></pre></td></tr></table></figure><p>å…¶ä½™æ¨¡æ¿å•†åº—å’Œä½¿ç”¨æ–¹å¼ç­‰æ“ä½œå’Œ OpenFaaS CE å®Œå…¨ä¸€è‡´ã€‚å…¶ä¸­ï¼ŒOpenFaaS å‡½æ•°å®¹å™¨æ‰˜ç®¡åœ¨ Containerd çš„ openfaas-fn å‘½åç©ºé—´ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ctr -n openfaas-fn c <span class="built_in">ls</span></span></span><br><span class="line">CONTAINER    IMAGE                                         RUNTIME                  </span><br><span class="line">go-fn        harbor.archeros.cn/dev/ake/openfaas-fn:dev    io.containerd.runc.v2</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">OpenFaaS åœ¨ä¸åŒæœåŠ¡é©±åŠ¨ä¸‹ï¼ˆOpenFaaS CEã€OpenFaaS Pro å’Œ faasdï¼‰çš„ç®€å•ä½¿ç”¨ç¤ºä¾‹</summary>
    
    
    
    <category term="Serverless" scheme="http://shenxianghong.github.io/categories/Serverless/"/>
    
    
    <category term="OpenFaaS" scheme="http://shenxianghong.github.io/tags/OpenFaaS/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” virtcontainers/hypervisor</title>
    <link href="http://shenxianghong.github.io/2023/05/19/2023-05-19%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20hypervisor/"/>
    <id>http://shenxianghong.github.io/2023/05/19/2023-05-19%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20hypervisor/</id>
    <published>2023-05-18T16:00:00.000Z</published>
    <updated>2023-06-20T06:53:58.308Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><h1 id="Hypervisor"><a href="#Hypervisor" class="headerlink" title="Hypervisor"></a>Hypervisor</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;hypervisor.go</u></em></p><p>Kata Containers æ”¯æŒçš„ hypervisor æœ‰ QEMUã€Cloud Hypervisorã€Firecrackerã€ACRN ä»¥åŠ DragonBallï¼Œå…¶ä¸­ DragonBall æ˜¯ Kata Containers 3.0 ä¸ºæ–°å¢çš„ runtime-rs ç»„ä»¶å¼•å…¥çš„å†…ç½® hypervisorï¼Œè€Œ runtime-rs çš„æ•´ä½“æ¶æ„åŒºåˆ«äºå½“å‰çš„ runtimeï¼Œä¸åœ¨æ­¤è¯¦è¯» DragonBall å®ç°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// qemu is an Hypervisor interface implementation for the Linux qemu hypervisor.</span></span><br><span class="line"><span class="keyword">type</span> qemu <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// é’ˆå¯¹ä¸åŒ CPU æ¶æ„ä¸‹çš„ QEMU é…ç½®é¡¹ï¼Œåç»­ä¼šè¿›ä¸€æ­¥æ„å»ºæˆ qemuConfig</span></span><br><span class="line">arch qemuArch</span><br><span class="line"></span><br><span class="line">virtiofsDaemon VirtiofsDaemon</span><br><span class="line"></span><br><span class="line">ctx context.Context</span><br><span class="line">id <span class="type">string</span></span><br><span class="line">mu sync.Mutex</span><br><span class="line"></span><br><span class="line"><span class="comment">// fds is a list of file descriptors inherited by QEMU process</span></span><br><span class="line"><span class="comment">// they&#x27;ll be closed once QEMU process is running</span></span><br><span class="line">fds []*os.File</span><br><span class="line"></span><br><span class="line"><span class="comment">// HotplugVFIOOnRootBus: [hypervisor].hotplug_vfio_on_root_bus</span></span><br><span class="line"><span class="comment">// PCIeRootPort: [hypervisor].pcie_root_port</span></span><br><span class="line">state QemuState</span><br><span class="line"></span><br><span class="line">qmpMonitorCh qmpChannel</span><br><span class="line"></span><br><span class="line"><span class="comment">// QEMU è¿›ç¨‹çš„é…ç½®å‚æ•°</span></span><br><span class="line">qemuConfig govmmQemu.Config</span><br><span class="line"></span><br><span class="line"><span class="comment">// QEMU å®ç°ä¸‹çš„ hypervisor é…ç½®</span></span><br><span class="line">config HypervisorConfig</span><br><span class="line"></span><br><span class="line"><span class="comment">// if in memory dump progress</span></span><br><span class="line">memoryDumpFlag sync.Mutex</span><br><span class="line"></span><br><span class="line"><span class="comment">// NVDIMM è®¾å¤‡æ•°é‡</span></span><br><span class="line">nvdimmCount <span class="type">int</span></span><br><span class="line"></span><br><span class="line">stopped <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å‰ç½®è¯´æ˜</span></span><br><span class="line"><span class="comment"> protection</span></span><br><span class="line"><span class="comment"> - amd64ï¼šé»˜è®¤ä¸º noneProtection</span></span><br><span class="line"><span class="comment">   å¦‚æœå¯ç”¨ [hypervisor].confidential_guestï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­ protection</span></span><br><span class="line"><span class="comment">   - å¦‚æœ host ä¸Š /sys/firmware/tdx_seam/ æ–‡ä»¶å¤¹å­˜åœ¨æˆ–è€… CPU flags ä¸­åŒ…å« tdxï¼Œåˆ™ä¸º tdxProtectionï¼ˆIntel Trust Domain Extensionsï¼‰</span></span><br><span class="line"><span class="comment">   - å¦‚æœ host ä¸Š /sys/module/kvm_amd/parameters/sev æ–‡ä»¶å­˜åœ¨ä¸”å†…å®¹ä¸º 1 æˆ–è€… Y åˆ™ä¸º sevProtectionï¼ˆAMD Secure Encrypted Virtualizationï¼‰</span></span><br><span class="line"><span class="comment">  - arm64ï¼šnoneProtection </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Config is the qemu configuration structure.</span></span><br><span class="line"><span class="comment">// It allows for passing custom settings and parameters to the qemu API.</span></span><br><span class="line"><span class="comment">// nolint: govet</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Path is the qemu binary path.</span></span><br><span class="line"><span class="comment">// - amd64: /usr/bin/qemu-system-x86_64</span></span><br><span class="line"><span class="comment">// - arm64: /usr/bin/qemu-system-aarch64</span></span><br><span class="line">Path <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ctx is the context used when launching qemu.</span></span><br><span class="line">Ctx context.Context</span><br><span class="line"><span class="comment">// User ID.</span></span><br><span class="line">Uid <span class="type">uint32</span></span><br><span class="line"><span class="comment">// Group ID.</span></span><br><span class="line">Gid <span class="type">uint32</span></span><br><span class="line"><span class="comment">// Supplementary group IDs.</span></span><br><span class="line">Groups []<span class="type">uint32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Name is the qemu guest name</span></span><br><span class="line"><span class="comment">// -name å‚æ•°ï¼Œä¾‹å¦‚ sandbox-4230a13dac935c3fef99f8b15d27d493ff1de957224043354374efd50bdfeeb7</span></span><br><span class="line"><span class="comment">// sandbox-&lt;qemuID&gt;</span></span><br><span class="line">Name <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// UUID is the qemu process UUID.</span></span><br><span class="line"><span class="comment">// -uuid å‚æ•°ï¼Œä¾‹å¦‚ -uuid 42f0c7b9-7aa9-4581-a26c-2d84b40f1190</span></span><br><span class="line"><span class="comment">// éšæœºç”Ÿæˆ</span></span><br><span class="line">UUID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CPUModel is the CPU model to be used by qemu.</span></span><br><span class="line"><span class="comment">// -cpu å‚æ•°ï¼Œä¾‹å¦‚ -cpu host,pmu=off</span></span><br><span class="line"><span class="comment">// é»˜è®¤ä¸º hostï¼Œå¦‚æœæŒ‡å®š [hypervisor].cpu_features åˆ™ç»§ç»­è¿½åŠ </span></span><br><span class="line">CPUModel <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SeccompSandbox is the qemu function which enables the seccomp feature</span></span><br><span class="line"><span class="comment">// [hypervisor].seccompsandbox</span></span><br><span class="line">SeccompSandbox <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Machine</span></span><br><span class="line"><span class="comment">// -machine å‚æ•°ï¼Œä¾‹å¦‚ -machine q35,accel=kvm,kernel_irqchip=on,nvdimm=on</span></span><br><span class="line"><span class="comment">// Type: [hypervisor].machine_type</span></span><br><span class="line"><span class="comment">// - amd64: é»˜è®¤ä¸º q35</span></span><br><span class="line"><span class="comment">// - arm64: virt</span></span><br><span class="line"><span class="comment">// Options: </span></span><br><span class="line"><span class="comment">// - amd64: é»˜è®¤ä¸º accel=kvm,kernel_irqchip=on</span></span><br><span class="line"><span class="comment">//   å¦‚æœå¯ç”¨ [hypervisor].confidential_guest æˆ–è€…å¯ç”¨ hypervisor[enable_iommu]ï¼Œåˆ™è¦†ç›– Options ä¸º accel=kvm,kernel_irqchip=split</span></span><br><span class="line"><span class="comment">//   å¦‚æœ sgxEPCSize ä¸ä¸º 0ï¼Œåˆ™è¿½åŠ  sgx-epc.0.memdev=epc0,sgx-epc.0.node=0</span></span><br><span class="line"><span class="comment">//   å¦‚æœå¯ç”¨ [hypervisor].confidential_guest: </span></span><br><span class="line"><span class="comment">//   - å¦‚æœ protection ä¸º tdxProtectionï¼Œåˆ™è¿½åŠ  kvm-type=tdx,confidential-guest-support=tdx</span></span><br><span class="line"><span class="comment">//   - å¦‚æœ protection ä¸º sevProtectionï¼Œåˆ™è¿½åŠ  confidential-guest-support=sev</span></span><br><span class="line"><span class="comment">//   å¦‚æœé•œåƒç±»å‹ä¸º [hypervisor].image ä¸” disableNvdimm ä¸º falseï¼Œåˆ™è¿½åŠ  nvdimm=on</span></span><br><span class="line"><span class="comment">// - arm64: usb=off,accel=kvm,gic-version=host</span></span><br><span class="line"><span class="comment">// å¦‚æœæŒ‡å®š [hypervisor].machine_acceleratorsï¼Œåˆ™ç»§ç»­è¿½åŠ </span></span><br><span class="line">Machine Machine</span><br><span class="line"></span><br><span class="line"><span class="comment">// QMPSockets is a slice of QMP socket description.</span></span><br><span class="line"><span class="comment">// -qmp å‚æ•°ï¼Œä¾‹å¦‚ -qmp unix:/run/vc/vm/&lt;qemuid&gt;/qmp.sock,server=on,wait=off</span></span><br><span class="line"><span class="comment">// Type: unix</span></span><br><span class="line"><span class="comment">// Name: </span></span><br><span class="line"><span class="comment">// - root æƒé™: /run/vc/vm/&lt;qemuID&gt;/qmp.sock</span></span><br><span class="line"><span class="comment">// - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/vc/vm/&lt;qemuID&gt;/qmp.sockï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line"><span class="comment">// Server: true</span></span><br><span class="line"><span class="comment">// NoWait: true</span></span><br><span class="line">QMPSockets []QMPSocket</span><br><span class="line"></span><br><span class="line"><span class="comment">// Devices is a list of devices for qemu to create and drive.</span></span><br><span class="line"><span class="comment">// -device å‚æ•°</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// =========== Bridge ===========</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ -device pci-bridge,bus=pcie.0,id=pci-bridge-0,chassis_nr=1,shpc=off,addr=2,io-reserve=4k,mem-reserve=1m,pref64-reserve=1m</span></span><br><span class="line"><span class="comment">// BridgeDeviceï¼ˆæ•°é‡ç­‰äº [hypervisor].default_bridgesï¼‰</span></span><br><span class="line"><span class="comment">//   Type: é»˜è®¤ä¸º 0ï¼Œå³ PCIï¼Œå¦‚æœ bridge ç±»å‹ä¸º PCIeï¼Œåˆ™ä¸º PCIe</span></span><br><span class="line"><span class="comment">//   Bus: é»˜è®¤ä¸º pci.0ï¼Œå¦‚æœ Machine.Type ä¸º q35 æˆ–è€… virtï¼Œåˆ™ä¸º pcie.0</span></span><br><span class="line"><span class="comment">//   ID: &lt;bt&gt;-bridge-&lt;idx&gt;ï¼Œå…¶ä¸­ idx ä¸º 0 ~ [hypervisor].default_bridges çš„é€’å¢ç´¢å¼•</span></span><br><span class="line"><span class="comment">//   - å¦‚æœ Machine.Type ä¸º q35ã€virt å’Œ pseriesï¼Œåˆ™ bt ä¸º pciï¼Œå®¹é‡ä¸º 30</span></span><br><span class="line"><span class="comment">//   - å¦‚æœ Machine.Type ä¸º s390-ccw-virtioï¼Œåˆ™ bt ä¸º ccwï¼Œå®¹é‡ä¸º 65535</span></span><br><span class="line"><span class="comment">//   Chassis: idx + 1ï¼Œå…¶ä¸­ idx ä¸º bridge åˆ—è¡¨çš„ç´¢å¼•</span></span><br><span class="line"><span class="comment">//  SHPC: false</span></span><br><span class="line"><span class="comment">//   Addr: idx + 2ï¼Œå…¶ä¸­ idx ä¸º bridge åˆ—è¡¨çš„ç´¢å¼•</span></span><br><span class="line"><span class="comment">//   IOReserve: 4k</span></span><br><span class="line"><span class="comment">//   MemReserve: 1m</span></span><br><span class="line"><span class="comment">//   Pref64Reserve: 1m</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// =========== Console ===========</span></span><br><span class="line"><span class="comment">// - ç¦ç”¨ [hypervisor].use_legacy_serial</span></span><br><span class="line"><span class="comment">//   ä¾‹å¦‚ -device virtio-serial-pci,disable-modern=true,id=serial0 -device virtconsole,chardev=charconsole0,id=console0 -chardev socket,id=charconsole0,path=/run/vc/vm/&lt;qemuID&gt;/console.sock,server=on,wait=off</span></span><br><span class="line"><span class="comment">//   CharDevice</span></span><br><span class="line"><span class="comment">//     Driver: virtconsole</span></span><br><span class="line"><span class="comment">//     Backend: socket</span></span><br><span class="line"><span class="comment">//     DeviceID: console0</span></span><br><span class="line"><span class="comment">//     ID: charconsole0</span></span><br><span class="line"><span class="comment">//     Path: </span></span><br><span class="line"><span class="comment">//     - root æƒé™: /run/vc/vm/&lt;qemuID&gt;/console.sock</span></span><br><span class="line"><span class="comment">//     - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/vc/vm/&lt;qemuID&gt;/console.sockï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line"><span class="comment">//   SerialDevice</span></span><br><span class="line"><span class="comment">//     Driver: virtio-serial</span></span><br><span class="line"><span class="comment">//     ID: serial0</span></span><br><span class="line"><span class="comment">//     DisableModern: </span></span><br><span class="line"><span class="comment">//     - amd64: å½“æœªç¦ç”¨ [hypervisor].disable_nesting_checksï¼Œä¸” CPU flags ä¸­æœ‰ hypervisorï¼Œè§†ä¸º trueï¼›å¦åˆ™ï¼Œä¸º false</span></span><br><span class="line"><span class="comment">//     - arm64: false</span></span><br><span class="line"><span class="comment">//     MaxPorts: 2</span></span><br><span class="line"><span class="comment">// - å¯ç”¨ [hypervisor].use_legacy_serial</span></span><br><span class="line"><span class="comment">//   ä¾‹å¦‚ -serial chardev:charconsole0 -chardev socket,id=charconsole0,path=/run/vc/vm/&lt;qemuID&gt;/console.sock,server=on,wait=off</span></span><br><span class="line"><span class="comment">//   CharDevice</span></span><br><span class="line"><span class="comment">//     Driver: serial</span></span><br><span class="line"><span class="comment">//     Backend: socket</span></span><br><span class="line"><span class="comment">//     DeviceID: console0</span></span><br><span class="line"><span class="comment">//     ID: charconsole0</span></span><br><span class="line"><span class="comment">//     Path: </span></span><br><span class="line"><span class="comment">//     - root æƒé™: /run/vc/vm/&lt;qemuID&gt;/console.sock</span></span><br><span class="line"><span class="comment">//     - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/vc/vm/&lt;qemuID&gt;/console.sockï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line"><span class="comment">//   LegacySerialDevice</span></span><br><span class="line"><span class="comment">//     Chardev: charconsole0</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// =========== Imageï¼ˆå½“é•œåƒç±»å‹ä¸º [hypervisor].imageï¼‰ ===========</span></span><br><span class="line"><span class="comment">// - ç¦ç”¨ [hypervisor].disable_image_nvdimm</span></span><br><span class="line"><span class="comment">//   ä¾‹å¦‚ -drive id=image-199896efe4d8ad3b,file=/opt/kata/share/kata-containers/kata-clearlinux-latest.image,aio=threads,format=raw,if=none,readonly=on</span></span><br><span class="line"><span class="comment">//   BlockDrive</span></span><br><span class="line"><span class="comment">//     File: [hypervisor].image</span></span><br><span class="line"><span class="comment">//   Format: raw</span></span><br><span class="line"><span class="comment">//   ID: image-&lt;éšæœºå­—ç¬¦ä¸²&gt;</span></span><br><span class="line"><span class="comment">//   ShareRW: true</span></span><br><span class="line"><span class="comment">//   ReadOnly: true</span></span><br><span class="line"><span class="comment">// - å¯ç”¨ [hypervisor].disable_image_nvdimm</span></span><br><span class="line"><span class="comment">//   ä¾‹å¦‚ -device nvdimm,id=nv0,memdev=mem0,unarmed=on -object memory-backend-file,id=mem0,mem-path=/opt/kata/share/kata-containers/kata-clearlinux-latest.image,size=134217728,readonly=on</span></span><br><span class="line"><span class="comment">//   Object</span></span><br><span class="line"><span class="comment">//     Driver: nvdimm</span></span><br><span class="line"><span class="comment">//     Type: memory-backend-file</span></span><br><span class="line"><span class="comment">//     DeviceID: nv0</span></span><br><span class="line"><span class="comment">//     ID: mem0</span></span><br><span class="line"><span class="comment">//     MemPath: [hypervisor].image</span></span><br><span class="line"><span class="comment">//     Size: [hypervisor].image å¤§å°</span></span><br><span class="line"><span class="comment">//     ReadOnly: true</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// =========== IOMMUï¼ˆå½“å¯ç”¨ [hypervisor].enable_iommuï¼‰ ===========</span></span><br><span class="line"><span class="comment">// IommuDev</span></span><br><span class="line"><span class="comment">//   Intremap: true</span></span><br><span class="line"><span class="comment">//   DeviceIotlb: true</span></span><br><span class="line"><span class="comment">//   CachingMode: true</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// =========== PVPanicï¼ˆå½“æŒ‡å®š [hypervisor].guest_memory_dump_pathï¼‰ ===========</span></span><br><span class="line"><span class="comment">// PVPanicDevice</span></span><br><span class="line"><span class="comment">//   NoShutdown: true</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// =========== BlockDeviceDriverï¼ˆå½“ [hypervisor].block_device_driver ä¸º virtio-scsiï¼‰ ===========</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ -device virtio-scsi-pci,id=scsi0,disable-modern=true</span></span><br><span class="line"><span class="comment">// SCSIController</span></span><br><span class="line"><span class="comment">//   ID: scsi0</span></span><br><span class="line"><span class="comment">//   DisableModern: </span></span><br><span class="line"><span class="comment">//   - amd64: å½“æœªç¦ç”¨ [hypervisor].disable_nesting_checksï¼Œä¸” CPU flags ä¸­æœ‰ hypervisorï¼Œè§†ä¸º trueï¼›å¦åˆ™ï¼Œä¸º false</span></span><br><span class="line"><span class="comment">//   - arm64: false</span></span><br><span class="line"><span class="comment">//   IOThread:ï¼ˆå½“å¯ç”¨ [hypervisor].enable_iothreadsï¼‰</span></span><br><span class="line"><span class="comment">//     ID: iothread-&lt;éšæœºå­—ç¬¦ä¸²&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// =========== Protection ===========</span></span><br><span class="line"><span class="comment">// Objectï¼ˆå½“ sgxEPCSize ä¸ä¸º 0 æ—¶ï¼‰</span></span><br><span class="line"><span class="comment">//   Type: memory-backend-epc</span></span><br><span class="line"><span class="comment">//   ID: epc0</span></span><br><span class="line"><span class="comment">//   Prealloc: true</span></span><br><span class="line"><span class="comment">//   Size: sgxEPCSize</span></span><br><span class="line"><span class="comment">// Objectï¼ˆå½“ protection ä¸º tdxProtection æ—¶ï¼‰</span></span><br><span class="line"><span class="comment">//   Driver: loader</span></span><br><span class="line"><span class="comment">//   Type: tdx-guest</span></span><br><span class="line"><span class="comment">//   ID: tdx</span></span><br><span class="line"><span class="comment">//   DeviceID: fd&lt;idx&gt;ï¼Œå…¶ä¸­ idx ä¸º loader ç±»å‹ Driver çš„ç»Ÿè®¡æ•°é‡</span></span><br><span class="line"><span class="comment">//   Debug: false</span></span><br><span class="line"><span class="comment">//   File: [hypervisor].firmware</span></span><br><span class="line"><span class="comment">//   FirmwareVolume: [hypervisor].firmware_volume</span></span><br><span class="line"><span class="comment">// Objectï¼ˆå½“ protection ä¸º sevProtection æ—¶ï¼‰</span></span><br><span class="line"><span class="comment">//   Type: sev-guest</span></span><br><span class="line"><span class="comment">// ID: sev</span></span><br><span class="line"><span class="comment">//   Debug: false</span></span><br><span class="line"><span class="comment">//   File: [hypervisor].firmware</span></span><br><span class="line"><span class="comment">//   CBitPos: ebx &amp; 0x3F</span></span><br><span class="line"><span class="comment">//   ReducedPhysBits: (ebx &gt;&gt; 6) &amp; 0x3F</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// =========== rngDevï¼ˆå½“ Machine.Type ä¸ä¸º s390-ccw-virtioï¼‰===========</span></span><br><span class="line"><span class="comment">// RNGDev</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ -object rng-random,id=rng0,filename=/dev/urandom</span></span><br><span class="line"><span class="comment">//   ID: rng0</span></span><br><span class="line"><span class="comment">//   FileName: [hypervisor].entropy_source</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// =========== PCIeï¼ˆå½“ [hypervisor].pcie_root_port å¤§äº 0 ä¸” Machine.Type ä¸º q35 æˆ– virtï¼‰===========</span></span><br><span class="line"><span class="comment">// PCIeRootPortDeviceï¼ˆæ•°é‡ç­‰äº [hypervisor].pcie_root_portï¼‰</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ -device pcie-root-port,id=rp1,bus=pcie.0,chassis=0,slot=1,multifunction=off,pref64-reserve=2097152B,mem-reserve=4194304B</span></span><br><span class="line"><span class="comment">//   ID: rp&lt;idx&gt;ï¼Œå…¶ä¸­ idx ä¸º 0 ~ [hypervisor].pcie_root_port çš„é€’å¢ç´¢å¼•</span></span><br><span class="line"><span class="comment">//   Bus: pcie.0</span></span><br><span class="line"><span class="comment">//   Chassis: 0</span></span><br><span class="line"><span class="comment">//   Slot: idx</span></span><br><span class="line"><span class="comment">//   Multifunction: false</span></span><br><span class="line"><span class="comment">//   Addr: 0</span></span><br><span class="line"><span class="comment">//   MemReserve: é»˜è®¤ 4MBï¼Œå¦‚æœç´¯åŠ æ¯ä¸ª BAR çš„ 32 ä½å†…å­˜çª—å£å€¼æ›´å¤§ï¼Œåˆ™ä»¥æ­¤å€¼ä¸ºå‡†ï¼Œå¹¶ä¹˜ä»¥ 2</span></span><br><span class="line"><span class="comment">//   Pref64Reserve: é»˜è®¤ 2MBï¼Œå¦‚æœç´¯åŠ æ¯ä¸ª BAR çš„ 64 ä½å†…å­˜çª—å£å€¼æ›´å¤§ï¼Œåˆ™ä»¥æ­¤å€¼ä¸ºå‡†</span></span><br><span class="line">Devices []Device</span><br><span class="line"></span><br><span class="line"><span class="comment">// RTC is the qemu Real Time Clock configuration</span></span><br><span class="line"><span class="comment">// -rtc å‚æ•°ï¼Œä¾‹å¦‚ -rtc base=utc,driftfix=slew,clock=host</span></span><br><span class="line"><span class="comment">// Base: utc</span></span><br><span class="line"><span class="comment">// Clock: host</span></span><br><span class="line"><span class="comment">// DriftFix: slew</span></span><br><span class="line">RTC RTC</span><br><span class="line"></span><br><span class="line"><span class="comment">// VGA is the qemu VGA mode.</span></span><br><span class="line"><span class="comment">// -vga å‚æ•°ï¼Œä¾‹å¦‚ -vga none</span></span><br><span class="line"><span class="comment">// none</span></span><br><span class="line">VGA <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Kernel is the guest kernel configuration.</span></span><br><span class="line"><span class="comment">// -kernel å‚æ•°ï¼Œä¾‹å¦‚ -kernel /opt/kata/share/kata-containers/vmlinux-5.19.2-96</span></span><br><span class="line"><span class="comment">// -initrd å‚æ•°ï¼Œä¾‹å¦‚ -initrd /opt/kata/share/kata-containers/kata-alpine-3.15.initrd</span></span><br><span class="line"> <span class="comment">// -append å‚æ•°ï¼Œä¾‹å¦‚ -append tsc=reliable no_timer_check rcupdate.rcu_expedited=1 i8042.direct=1 i8042.dumbkbd=1 i8042.nopnp=1 i8042.noaux=1 noreplace-smp reboot=k cryptomgr.notests net.ifnames=0 pci=lastbus=0 console=hvc0 console=hvc1 debug panic=1 nr_cpus=8 scsi_mod.scan=none agent.log=debug agent.debug_console agent.debug_console_vport=1026</span></span><br><span class="line"><span class="comment">// Path: [hypervisor].kernel</span></span><br><span class="line"><span class="comment">// InitrdPath: [hypervisor].initrdï¼Œå½“é•œåƒç±»å‹ä¸º [hypervisor].image æ—¶ï¼Œæ²¡æœ‰ -initrd å‚æ•°</span></span><br><span class="line"><span class="comment">// Params: </span></span><br><span class="line"><span class="comment">// - kernelParams: </span></span><br><span class="line"><span class="comment">//   - amd64: é»˜è®¤ä¸º tsc=reliable no_timer_check rcupdate.rcu_expedited=1 i8042.direct=1 i8042.dumbkbd=1 i8042.nopnp=1 i8042.noaux=1 noreplace-smp reboot=k cryptomgr.notests net.ifnames=0 pci=lastbus=0 panic=1 nr_cpus=[hypervisor].default_maxvcpus</span></span><br><span class="line"><span class="comment">//     å¦‚æœå¯ç”¨ [hypervisor].enable_iommuï¼Œåˆ™è¿½åŠ  intel_iommu=on iommu=pt</span></span><br><span class="line"><span class="comment">//     å¦‚æœé•œåƒç±»å‹ä¸º [hypervisor].image: </span></span><br><span class="line"><span class="comment">//     - å¦‚æœ disableNvdimm ä¸º trueï¼Œåˆ™è¿½åŠ  root=/dev/vda1 rootflags=data=ordered errors=remount-ro ro rootfstype=ext4</span></span><br><span class="line"><span class="comment">//     - å¦‚æœ disableNvdimm ä¸º false: </span></span><br><span class="line"><span class="comment">//       - å¦‚æœ dax ä¸º falseï¼Œåˆ™è¿½åŠ  root=/dev/pmem0p1 rootflags=data=ordered errors=remount-ro ro rootfstype=ext4</span></span><br><span class="line"><span class="comment">//       - å¦‚æœ dax ä¸º trueï¼Œåˆ™è¿½åŠ  root=/dev/pmem0p1 rootflags=dax data=ordered errors=remount-ro ro rootfstype=ext4</span></span><br><span class="line"><span class="comment">//     å¦‚æœå¯ç”¨ [hypervisor].use_legacy_serialï¼Œåˆ™è¿½åŠ  console=ttyS0ï¼Œå¦åˆ™ï¼Œåˆ™è¿½åŠ  console=hvc0 console=hvc1</span></span><br><span class="line"><span class="comment">//   - arm64: iommu.passthrough=0 panic=1 nr_cpus=[hypervisor].default_maxvcpus</span></span><br><span class="line"><span class="comment">// - kernelParamsDebug: é»˜è®¤ä¸º debugï¼Œå¦‚æœé•œåƒç±»å‹ä¸º [hypervisor].imageï¼Œåˆ™è¿½åŠ  systemd.show_status=true systemd.log_level=debug</span></span><br><span class="line"><span class="comment">// - kernelParamsNonDebug: é»˜è®¤ä¸º quietï¼Œå¦‚æœé•œåƒç±»å‹ä¸º [hypervisor].imageï¼Œåˆ™è¿½åŠ  systemd.show_status=false</span></span><br><span class="line"><span class="comment">// ç”±ä»¥ä¸Šä¸‰ä¸ªå‚æ•°ç»„æˆï¼Œå…·ä½“ä¸º kernelParams + kernelParamsDebug/kernelParamsNonDebugï¼ˆå–å†³äº [hypervisor].enable_debugï¼‰ï¼Œå¦‚æœæŒ‡å®š [hypervisor].kernel_paramsï¼Œåˆ™ç»§ç»­è¿½åŠ </span></span><br><span class="line">Kernel Kernel</span><br><span class="line"></span><br><span class="line"><span class="comment">// Memory is the guest memory configuration.</span></span><br><span class="line"><span class="comment">// -m å‚æ•°ï¼Œä¾‹å¦‚ -m 2048M,slots=10,maxmem=12799M</span></span><br><span class="line"><span class="comment">// Size: [hypervisor].default_memory</span></span><br><span class="line"><span class="comment">// Slots: [hypervisor].memory_slots</span></span><br><span class="line"><span class="comment">// MaxMem: </span></span><br><span class="line"><span class="comment">// - amd64: [hypervisor].memory_offset + [hypervisor].default_maxmemory</span></span><br><span class="line"><span class="comment">// - arm64: [hypervisor].default_maxmemory</span></span><br><span class="line"><span class="comment">// Path: </span></span><br><span class="line"><span class="comment">// - å¦‚æœä¸º VM factory åœºæ™¯ï¼Œåˆ™ä¸º [factory].template_path/memory</span></span><br><span class="line"><span class="comment">// - å¦‚æœ [hypervisor].shared_fs ä¸º virtio-fs æˆ–è€… virtio-fs-nydus, å†æˆ–è€… annotations[&quot;io.katacontainers.config.hypervisor.file_mem_backend&quot;] ä¸ä¸ºç©ºï¼Œåˆ™ä¸º /dev/shmï¼ˆå¦‚æœ annotations ä¼ é€’ï¼Œåˆ™ä»¥ annotations ä¸ºå‡†ï¼‰</span></span><br><span class="line">Memory Memory</span><br><span class="line"></span><br><span class="line"><span class="comment">// SMP is the quest multi processors configuration.</span></span><br><span class="line"><span class="comment">// -smp å‚æ•°ï¼Œä¾‹å¦‚ -smp 1,cores=1,threads=1,sockets=8,maxcpus=8</span></span><br><span class="line"><span class="comment">// CPUs: [hypervisor].default_vcpus</span></span><br><span class="line"><span class="comment">// Cores: 1</span></span><br><span class="line"><span class="comment">// Threads: 1</span></span><br><span class="line"><span class="comment">// Sockets: [hypervisor].default_maxvcpus</span></span><br><span class="line"><span class="comment">// MaxCPUs: [hypervisor].default_maxvcpus</span></span><br><span class="line">SMP SMP</span><br><span class="line"></span><br><span class="line"><span class="comment">// GlobalParam is the -global parameter.</span></span><br><span class="line"><span class="comment">// -global å‚æ•°ï¼Œä¾‹å¦‚ -global kvm-pit.lost_tick_policy=discard</span></span><br><span class="line"><span class="comment">// kvm-pit.lost_tick_policy=discard</span></span><br><span class="line">GlobalParam <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Knobs is a set of qemu boolean settings.</span></span><br><span class="line"><span class="comment">// -no-user-config -nodefaults -nographic --no-reboot -daemonize å‚æ•°</span></span><br><span class="line"><span class="comment">// NoUserConfigã€NoDefaultsã€NoGraphicã€NoRebootã€Daemonize: true</span></span><br><span class="line"><span class="comment">// MemPrealloc: é»˜è®¤ä¸º [hypervisor].enable_mem_preallocï¼Œå¦‚æœ [hypervisor].shared_fs ä¸º virtio-fs æˆ–è€… virtio-fs-nydus, å†æˆ–è€… annotations[&quot;io.katacontainers.config.hypervisor.file_mem_backend&quot;] ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å¯ç”¨ [hypervisor].enable_hugepagesï¼Œåˆ™ä¸º true</span></span><br><span class="line"><span class="comment">// HugePages: [hypervisor].enable_hugepages</span></span><br><span class="line"><span class="comment">// IOMMUPlatform: [hypervisor].enable_iommu_platform</span></span><br><span class="line"><span class="comment">// FileBackedMem: </span></span><br><span class="line"><span class="comment">// - å¦‚æœä¸º VM factory åœºæ™¯ï¼Œåˆ™ä¸º true</span></span><br><span class="line"><span class="comment">// - å¦‚æœ [hypervisor].shared_fs ä¸º virtio-fs æˆ–è€… virtio-fs-nydus, å†æˆ–è€… annotations[&quot;io.katacontainers.config.hypervisor.file_mem_backend&quot;] ä¸ä¸ºç©ºï¼Œåˆ™ä¸º true</span></span><br><span class="line"><span class="comment">// MemShared: </span></span><br><span class="line"><span class="comment">// - å¦‚æœä¸º VM factory ä¸­çš„å¯åŠ¨ä¸ºæ¨¡æ¿åœºæ™¯ï¼Œåˆ™ä¸º true</span></span><br><span class="line"><span class="comment">// - å¦‚æœ [hypervisor].shared_fs ä¸º virtio-fs æˆ–è€… virtio-fs-nydus, å†æˆ–è€… annotations[&quot;io.katacontainers.config.hypervisor.file_mem_backend&quot;] ä¸ä¸ºç©ºï¼Œåˆ™ä¸º true</span></span><br><span class="line"><span class="comment">// - å¦‚æœå¯ç”¨ [hypervisor].enable_vhost_user_storeï¼Œåˆ™ä¸º true</span></span><br><span class="line">Knobs Knobs</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bios is the -bios parameter</span></span><br><span class="line"><span class="comment">// -bios å‚æ•°</span></span><br><span class="line"><span class="comment">// [hypervisor].firmware</span></span><br><span class="line">Bios <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PFlash specifies the parallel flash images (-pflash parameter)</span></span><br><span class="line"><span class="comment">// -pflash å‚æ•°</span></span><br><span class="line"><span class="comment">// [hypervisor].pflashes</span></span><br><span class="line">PFlash []<span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Incoming controls migration source preparation</span></span><br><span class="line"><span class="comment">// MigrationType: å¦‚æœä¸º VM factory ä¸­çš„ä»æ¨¡æ¿å¯åŠ¨åœºæ™¯ï¼Œåˆ™ä¸º 3</span></span><br><span class="line">Incoming Incoming</span><br><span class="line"></span><br><span class="line"><span class="comment">// fds is a list of open file descriptors to be passed to the spawned qemu process</span></span><br><span class="line">fds []*os.File</span><br><span class="line"></span><br><span class="line"><span class="comment">// FwCfg is the -fw_cfg parameter</span></span><br><span class="line">FwCfg []FwCfg</span><br><span class="line"></span><br><span class="line"><span class="comment">// Devices ä¸­ SCSIController.IOThread</span></span><br><span class="line">IOThreads []IOThread</span><br><span class="line"></span><br><span class="line"><span class="comment">// PidFile is the -pidfile parameter</span></span><br><span class="line"><span class="comment">// -pidfile å‚æ•°ï¼Œä¾‹å¦‚ -pidfile /run/vc/vm/&lt;qemuID&gt;/pid</span></span><br><span class="line"><span class="comment">// - root æƒé™: /run/vc/vm/&lt;qemuID&gt;/pid</span></span><br><span class="line"><span class="comment">// - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/vc/vm/&lt;qemuID&gt;/pidï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line">PidFile <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// LogFile is the -D parameter</span></span><br><span class="line"><span class="comment">// -D å‚æ•°ï¼Œä¾‹å¦‚ -D /run/vc/vm/&lt;qemuID&gt;/qemu.log</span></span><br><span class="line"><span class="comment">// - root æƒé™: /run/vc/vm/&lt;qemuID&gt;/qemu.log</span></span><br><span class="line"><span class="comment">// - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/vc/vm/&lt;qemuID&gt;/qemu.logï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line">LogFile <span class="type">string</span></span><br><span class="line"></span><br><span class="line">qemuParams []<span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> cloudHypervisor <span class="keyword">struct</span> &#123;</span><br><span class="line">console         console.Console</span><br><span class="line">virtiofsDaemon  VirtiofsDaemon</span><br><span class="line">APIClient       clhClient</span><br><span class="line">ctx             context.Context</span><br><span class="line">id              <span class="type">string</span></span><br><span class="line">netDevices      *[]chclient.NetConfig</span><br><span class="line">devicesIds      <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line">netDevicesFiles <span class="keyword">map</span>[<span class="type">string</span>][]*os.File</span><br><span class="line">vmconfig        chclient.VmConfig</span><br><span class="line">state           CloudHypervisorState</span><br><span class="line">config          HypervisorConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// firecracker is an Hypervisor interface implementation for the firecracker VMM.</span></span><br><span class="line"><span class="keyword">type</span> firecracker <span class="keyword">struct</span> &#123;</span><br><span class="line">console console.Console</span><br><span class="line">ctx     context.Context</span><br><span class="line"></span><br><span class="line">pendingDevices []firecrackerDevice <span class="comment">// Devices to be added before the FC VM ready</span></span><br><span class="line"></span><br><span class="line">firecrackerd *exec.Cmd              <span class="comment">//Tracks the firecracker process itself</span></span><br><span class="line">fcConfig     *types.FcConfig        <span class="comment">// Parameters configured before VM starts</span></span><br><span class="line">connection   *client.FirecrackerAPI <span class="comment">//Tracks the current active connection</span></span><br><span class="line"></span><br><span class="line">id               <span class="type">string</span> <span class="comment">//Unique ID per pod. Normally maps to the sandbox id</span></span><br><span class="line">vmPath           <span class="type">string</span> <span class="comment">//All jailed VM assets need to be under this</span></span><br><span class="line">chrootBaseDir    <span class="type">string</span> <span class="comment">//chroot base for the jailer</span></span><br><span class="line">jailerRoot       <span class="type">string</span></span><br><span class="line">socketPath       <span class="type">string</span></span><br><span class="line">hybridSocketPath <span class="type">string</span></span><br><span class="line">netNSPath        <span class="type">string</span></span><br><span class="line">uid              <span class="type">string</span> <span class="comment">//UID and GID to be used for the VMM</span></span><br><span class="line">gid              <span class="type">string</span></span><br><span class="line">fcConfigPath     <span class="type">string</span></span><br><span class="line"></span><br><span class="line">info   FirecrackerInfo</span><br><span class="line">config HypervisorConfig</span><br><span class="line">state  firecrackerState</span><br><span class="line"></span><br><span class="line">jailed <span class="type">bool</span> <span class="comment">//Set to true if jailer is enabled</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Acrn is an Hypervisor interface implementation for the Linux acrn hypervisor.</span></span><br><span class="line"><span class="keyword">type</span> Acrn <span class="keyword">struct</span> &#123;</span><br><span class="line">sandbox    *Sandbox</span><br><span class="line">ctx        context.Context</span><br><span class="line">arch       acrnArch</span><br><span class="line">store      persistapi.PersistDriver</span><br><span class="line">id         <span class="type">string</span></span><br><span class="line">state      AcrnState</span><br><span class="line">acrnConfig Config</span><br><span class="line">config     HypervisorConfig</span><br><span class="line">info       AcrnInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CreateVM"><a href="#CreateVM" class="headerlink" title="CreateVM"></a>CreateVM</h2><p><strong>å‡†å¤‡åˆ›å»º VM æ‰€éœ€çš„é…ç½®ä¿¡æ¯</strong></p><h3 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/qemu.go#L490">source code</a></p><ol><li>æ ¹æ® QEMU å®ç°çš„ hypervisor é…ç½®é¡¹åˆå§‹åŒ–å¯¹åº”æ¶æ„ä¸‹çš„ qemuï¼Œå…¶ä¸­åŒ…å«äº† qemu-systemï¼ˆgovmmQemu.Configï¼‰å’Œ virtiofsd&#x2F;nydusdï¼ˆVirtiofsDaemonï¼‰è¿›ç¨‹çš„é…ç½®å‚æ•°</li></ol><h1 id="VirtiofsDaemon"><a href="#VirtiofsDaemon" class="headerlink" title="VirtiofsDaemon"></a>VirtiofsDaemon</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;virtiofsd.go</u></em></p><p>VirtiofsDaemon æ˜¯ç”¨äº host ä¸ guest çš„æ–‡ä»¶å…±äº«çš„è¿›ç¨‹æœåŠ¡ï¼Œå®ç°åŒ…æ‹¬ä¼ ç»Ÿçš„ virtiofsd ä»¥åŠé’ˆå¯¹èš‚èšç¤¾åŒºæå‡ºçš„ nydusdã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> virtiofsd <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Neded by tracing</span></span><br><span class="line">ctx context.Context</span><br><span class="line"><span class="comment">// PID process ID of virtiosd process</span></span><br><span class="line">PID <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// path to virtiofsd daemon</span></span><br><span class="line"><span class="comment">// [hypervisor].shared_fs</span></span><br><span class="line">path <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// socketPath where daemon will serve</span></span><br><span class="line"><span class="comment">// - root æƒé™: /run/vc/vm/&lt;qemuID&gt;/vhost-fs.sock</span></span><br><span class="line"><span class="comment">// - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/vc/vm/&lt;qemuID&gt;/vhost-fs.sockï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line">socketPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// cache size for virtiofsd</span></span><br><span class="line"><span class="comment">// [hypervisor].virtio_fs_cache</span></span><br><span class="line">cache <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// sourcePath path that daemon will help to share</span></span><br><span class="line"><span class="comment">// - root æƒé™: /run/kata-containers/shared/sandboxes/&lt;containerID&gt;/shared</span></span><br><span class="line"><span class="comment">// - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/kata-containers/shared/sandboxes/&lt;containerID&gt;/sharedï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line">sourcePath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// extraArgs list of extra args to append to virtiofsd command</span></span><br><span class="line"><span class="comment">// [hypervisor].virtio_fs_extra_args</span></span><br><span class="line">extraArgs []<span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> nydusd <span class="keyword">struct</span> &#123;</span><br><span class="line">startFn         <span class="function"><span class="keyword">func</span><span class="params">(cmd *exec.Cmd)</span></span> <span class="type">error</span> <span class="comment">// for mock testing</span></span><br><span class="line">waitFn          <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span>              <span class="comment">// for mock</span></span><br><span class="line">setupShareDirFn <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span>              <span class="comment">// for mock testing</span></span><br><span class="line">  pid             <span class="type">int</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// [hypervisor].shared_fs</span></span><br><span class="line">path <span class="type">string</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// - root æƒé™: /run/vc/vm/&lt;qemuID&gt;/vhost-fs.sock</span></span><br><span class="line"><span class="comment">// - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/vc/vm/&lt;qemuID&gt;/vhost-fs.sockï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line">sockPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// - root æƒé™: /run/vc/vm/&lt;qemuID&gt;/nydusd-api.sock</span></span><br><span class="line"><span class="comment">// - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/vc/vm/&lt;qemuID&gt;/nydusd-api.sockï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line">apiSockPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// - root æƒé™: /run/kata-containers/shared/sandboxes/&lt;containerID&gt;/shared</span></span><br><span class="line"><span class="comment">// - rootless æƒé™: &lt;XDG_RUNTIME_DIR&gt;/run/kata-containers/shared/sandboxes/&lt;containerID&gt;/sharedï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;ï¼‰</span></span><br><span class="line">sourcePath <span class="type">string</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">// [hypervisor].virtio_fs_extra_args</span></span><br><span class="line">extraArgs []<span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [hypervisor].debug</span></span><br><span class="line">debug <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">virtcontainers ä¸­ä¸ Hypervisor ç­‰è™šæ‹ŸåŒ–ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€èµ„æºé™åˆ¶</title>
    <link href="http://shenxianghong.github.io/2023/05/15/2023-05-15%20Kata%20Containers%20%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/"/>
    <id>http://shenxianghong.github.io/2023/05/15/2023-05-15%20Kata%20Containers%20%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6/</id>
    <published>2023-05-14T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.274Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><h1 id="cgroup-ç®¡ç†"><a href="#cgroup-ç®¡ç†" class="headerlink" title="cgroup ç®¡ç†"></a>cgroup ç®¡ç†</h1><p>Kata Containers ç›®å‰æ”¯æŒ cgroups v1 å’Œ v2ã€‚</p><p>Kata Containers ä¸­ï¼Œå·¥ä½œè´Ÿè½½æ˜¯åœ¨ VM ä¸­è¿è¡Œï¼ŒVM ç”±è¿è¡Œåœ¨ host ä¸Šçš„ VMMï¼ˆvirtual machine monitorï¼‰ç®¡ç†ã€‚å› æ­¤ï¼ŒKata Containers è¿è¡Œåœ¨ä¸¤å±‚ cgroup ä¹‹ä¸Šï¼šä¸€å±‚ä¸ºå·¥ä½œè´Ÿè½½æ‰€åœ¨çš„ guestï¼Œå¦ä¸€å±‚ä¸ºè¿è¡Œ VMM å’Œç›¸å…³çº¿ç¨‹çš„ hostã€‚</p><p>å®¹å™¨ cgroup è·¯å¾„çš„é…ç½®æ˜¯åœ¨ <a href="https://github.com/opencontainers/runtime-spec/blob/main/config-linux.md">OCI runtime spec</a> ä¸­å£°æ˜çš„ cgroupsPath å­—æ®µï¼Œå¯ç”¨äºæ§åˆ¶å®¹å™¨çš„ cgroup å±‚æ¬¡ç»“æ„ä»¥åŠåœ¨å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ã€‚åœ¨ Kubernetes åœºæ™¯ä¸­ï¼ŒPod çš„ cgroup æ˜¯ç”± Kubelet ç®¡ç†ï¼Œè€Œå®¹å™¨çš„ cgroup æ˜¯ç”±è¿è¡Œæ—¶ç®¡ç†ã€‚ Kubelet å°†æ ¹æ®å®¹å™¨èµ„æºéœ€æ±‚è°ƒæ•´ Pod çš„ cgroup å¤§å°ï¼Œå…¶ä¸­åŒ…å« Pod spec.Overhead ä¸­å£°æ˜çš„èµ„æºã€‚</p><p>Kata Containers çš„è®¾è®¡ä¸º sandbox å¼•å…¥äº†ä¸å¯å¿½ç•¥çš„èµ„æºå¼€é”€ã€‚é€šå¸¸ï¼Œä¸åŸºäºè¿›ç¨‹çº§åˆ«çš„å®¹å™¨è¿è¡Œæ—¶ç›¸æ¯”ï¼ŒKata shimï¼ˆå³ containerd-shim-kata-v2ï¼‰ä¼šè°ƒç”¨åº•å±‚ VMM åˆ›å»ºé¢å¤–çš„çº¿ç¨‹ï¼Œä¾‹å¦‚åŠè™šæ‹ŸåŒ– I&#x2F;O åç«¯ã€VMM å®ä¾‹ä»¥åŠ Kata shim è¿›ç¨‹ã€‚è¿™äº› host è¿›ç¨‹æ¶ˆè€—çš„å†…å­˜å’Œ CPU èµ„æºæ˜¯ä¸ä¸å®¹å™¨ä¸­çš„å·¥ä½œè´Ÿè½½ç›´æ¥ç›¸å…³ï¼Œè€Œæ˜¯å±äºå¼•å…¥ sandbox å¸¦æ¥çš„é¢å¤–å¼€é”€ã€‚ä¸ºäº†ä½¿ Kata å·¥ä½œè´Ÿè½½åœ¨ä¸æ˜¾ç€é™ä½æ€§èƒ½çš„æƒ…å†µä¸‹è¿è¡Œï¼Œå¿…é¡»ç›¸åº”åœ°é…ç½®å…¶ sandbox çš„å¼€é”€ã€‚å› æ­¤ï¼Œå¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>ä¸Šå±‚ç¼–æ’å™¨åœ¨è°ƒæ•´ Pod cgroup å¤§å°æ—¶è€ƒè™‘è¿è¡Œ sandbox çš„é¢å¤–å¼€é”€ã€‚ä¾‹å¦‚ï¼ŒKubernetes çš„ Pod Overhead ç‰¹æ€§å…è®¸ç¼–æ’å™¨å°† sandbox çš„é¢å¤–å¼€é”€è®¡å…¥å…¶æ‰€æœ‰å®¹å™¨èµ„æºçš„æ€»å’Œä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒKata åˆ›å»ºçš„æ‰€æœ‰è¿›ç¨‹éƒ½å°†åœ¨ Pod çš„ cgroup çº¦æŸå’Œé™åˆ¶ä¸‹è¿è¡Œ</li><li>ä¸Šå±‚ç¼–æ’å™¨ä¸è€ƒè™‘ sandbox çš„é¢å¤–å¼€é”€ï¼Œå› æ­¤ Pod çš„ cgroup å¤§å°å¯èƒ½æ— æ³•æ»¡è¶³è¿è¡Œ Kata åˆ›å»ºçš„æ‰€æœ‰è¿›ç¨‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†æ‰€æœ‰ Kata ç›¸å…³è¿›ç¨‹é™„åŠ åˆ° Pod çš„ cgroup ä¸­å¯èƒ½ä¼šå¯¼è‡´ä¸å¯å¿½ç•¥çš„å·¥ä½œè´Ÿè½½æ€§èƒ½ä¸‹é™ã€‚å› æ­¤ï¼ŒKata Containers ä¼šå°†é™¤ vCPU çº¿ç¨‹ä¹‹å¤–çš„æ‰€æœ‰è¿›ç¨‹ç§»åŠ¨åˆ°åä¸º &#x2F;kata_overhead ä¸‹çš„å­ cgroup ä¸­ã€‚ Kata è¿è¡Œæ—¶ä¸ä¼šå¯¹è¯¥ cgroup ä½œå‡ºä»»ä½•çº¦æŸæˆ–é™åˆ¶ï¼Œè€Œç”±é›†ç¾¤ç®¡ç†å‘˜é€‰æ‹©æ€§è®¾ç½®</li></ul><p>Kata Containers å¹¶ä¸ä¼šåŠ¨æ€æ£€æµ‹è¿™ä¸¤ç§æƒ…å†µï¼Œè€Œæ˜¯é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ [runtime].sandbox_cgroup_only é€‰é¡¹å†³å®šçš„ã€‚</p><p><strong>cgroup ç§ç±»</strong></p><ul><li><p>Pod cgroup</p><p>ä½äº &#x2F;kubepods å±‚çº§ä¸‹çš„å­ cgroupï¼Œå‘½åä¸º &#x2F;kubepods&#x2F;&lt;PodUID&gt;ï¼Œç”± Kubelet ç®¡ç†</p><ul><li><p>sandbox cgroup</p><p>ä½äº &#x2F;kubepods&#x2F;&lt;PodUID&gt; å±‚çº§ä¸‹çš„å­ cgroupï¼Œå‘½åä¸º &#x2F;kata_&lt;sandboxID&gt;ï¼Œç”±è¿è¡Œæ—¶ç®¡ç†</p></li></ul></li><li><p>overhead cgroup</p><p>ä½äº &#x2F;kata_overhead å±‚çº§ä¸‹çš„å­ cgroupï¼Œå‘½åä¸º &#x2F;kata_overhead&#x2F;&lt;sandboxID&gt;ï¼Œç”±è¿è¡Œæ—¶ç®¡ç†</p></li></ul><p><strong>æµ‹è¯•è´Ÿè½½</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: kata</span><br><span class="line">spec:</span><br><span class="line">  runtimeClassName: kata</span><br><span class="line">  containers:</span><br><span class="line">  - name: kata</span><br><span class="line">    image: ubuntu:18.04</span><br><span class="line">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;tail -f /dev/null&quot;]</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: &quot;1Gi&quot;</span><br><span class="line">        cpu: &quot;1&quot;</span><br><span class="line">      limits:</span><br><span class="line">        memory: &quot;1Gi&quot;</span><br><span class="line">        cpu: &quot;1&quot;</span><br></pre></td></tr></table></figure><h2 id="sandbox-cgroup-only-x3D-true"><a href="#sandbox-cgroup-only-x3D-true" class="headerlink" title="sandbox_cgroup_only &#x3D; true"></a>sandbox_cgroup_only &#x3D; true</h2><p>sandbox_cgroup_only è®¾ç½®ä¸º true æ„å‘³ç€ Kubelet åœ¨è®¾ç½® Pod cgroup çš„å¤§å°æ—¶ä¼šå°† Pod çš„é¢å¤–å¼€é”€è€ƒè™‘åœ¨å†…ï¼ˆKubernetes 1.16 èµ·ï¼Œå€ŸåŠ© Pod Overhead ç‰¹æ€§ï¼‰ã€‚ç›¸å¯¹è€Œè¨€ï¼Œè¿™ç§æ–¹å¼è¾ƒä¸ºæ¨èï¼ŒKata Containers æ‰€æœ‰ç›¸å…³è¿›ç¨‹éƒ½å¯ä»¥ç®€å•åœ°æ”¾ç½®åœ¨ç»™å®šçš„ cgroup è·¯å¾„ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</span><br><span class="line">â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚ â”‚ vCPU threads        â”‚     â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚ â”‚ I/O threads         â”‚     â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚ â”‚ VMM                 â”‚     â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚ â”‚ Kata Shim           â”‚     â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚ â”‚                     â”‚     â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚ â”‚ /kata_&lt;sandboxID&gt;   â”‚     â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â”‚Pod                          â”‚  â”‚   â”‚</span><br><span class="line">â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚</span><br><span class="line">â”‚  â”‚/kubepods                         â”‚   â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</span><br><span class="line">â”‚ Node                                    â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><p>å½“å¯ç”¨ sandbox_cgroup_only æ—¶ï¼ŒKata shim å°†åœ¨ Pod cgroup ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º &#x2F;kata_&lt;sandboxID&gt; çš„å­ cgroupï¼Œå³ sandbox cgroupã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œsandbox cgroup ä¸ä½œå•ç‹¬çº¦æŸå’Œé™åˆ¶ï¼Œè€Œæ˜¯è‡ªç»§æ‰¿çˆ¶ cgroupã€‚cpuset å’Œ devices cgroup å­ç³»ç»Ÿé™¤å¤–ï¼Œå®ƒä»¬æ˜¯ç”± Kata shim ç®¡ç†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">runC çš„ cgroup å±‚çº§ä¸é™åˆ¶</span></span><br><span class="line">â””â”€â”€ /kubepods/pod505eb17b-78d4-4dce-bfb2-60085f629344</span><br><span class="line">â”œâ”€â”€ tasks(ç©º)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_quota_us(-&gt; 100000)</span><br><span class="line">    â”œâ”€â”€ 499316b3661bc989f0999dd51901d2afaad0dda0aa614a2ebcd39f2517e7c56b(ä¸šåŠ¡å®¹å™¨)</span><br><span class="line">    |â”œâ”€â”€ tasks(ä¸šåŠ¡è¿›ç¨‹)</span><br><span class="line">    | â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    |â””â”€â”€ cpu.cfs_quota_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€fa6545c433f02a1c712db11cb58bb100a013f9622d725c6a41c60500c20031c5(infra å®¹å™¨)</span><br><span class="line">    â”œâ”€â”€ tasks(pause è¿›ç¨‹)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kata çš„ cgroup å±‚çº§ä¸é™åˆ¶</span></span><br><span class="line">â””â”€â”€ /kubepods/pod08ae4074-5398-439b-93ae-a63035cbd3ae</span><br><span class="line">â”œâ”€â”€ tasks(ç©º)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_quota_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€ kata_dc5e4c1588ba3cdeb4fe1dffcb2420997408f42ad2545ddc792724b3bbfb7654(infra å®¹å™¨)</span><br><span class="line">    â”œâ”€â”€ tasks(containerd-shim-kata-v2ã€virtiofsdã€vhost å’Œ qemu-system è™šæ‹ŸåŒ–è¿›ç¨‹)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kata VM ä¸­çš„ cgroup å±‚çº§ä¸é™åˆ¶</span></span><br><span class="line">â””â”€â”€ /kubepods/pod08ae4074-5398-439b-93ae-a63035cbd3ae</span><br><span class="line">â”œâ”€â”€ tasks(ç©º)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br><span class="line">    â”œâ”€â”€ 8d0a3396afc32d47276b4b25e76e23cdf80dfc51ca980846fb3c847effbe84f9(ä¸šåŠ¡å®¹å™¨)</span><br><span class="line">    |â”œâ”€â”€ tasks(ä¸šåŠ¡è¿›ç¨‹)</span><br><span class="line">    |â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    |â””â”€â”€ cpu.cfs_quota_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€dc5e4c1588ba3cdeb4fe1dffcb2420997408f42ad2545ddc792724b3bbfb7654(infra å®¹å™¨)</span><br><span class="line">    â”œâ”€â”€ tasks(pause è¿›ç¨‹)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br></pre></td></tr></table></figure><p>åˆ›å»º sandbox cgroup ä¹‹åï¼ŒKata shim ä¼šåœ¨ VM å¯åŠ¨ä¹‹å‰å°†å…¶è‡ªèº«åŠ å…¥åˆ°è¯¥ cgroup ä¸­ã€‚å› æ­¤ï¼Œéšåç”± Kata shim åˆ›å»ºçš„æ‰€æœ‰è¿›ç¨‹ï¼ˆVMM æœ¬èº«ï¼Œä»¥åŠæ‰€æœ‰ vCPU å’Œ I&#x2F;O ç›¸å…³çº¿ç¨‹ï¼‰éƒ½å°†å— sandbox cgroup çº¦æŸã€‚</p><h3 id="sandbox-cgroup-çš„ä»·å€¼"><a href="#sandbox-cgroup-çš„ä»·å€¼" class="headerlink" title="sandbox cgroup çš„ä»·å€¼"></a>sandbox cgroup çš„ä»·å€¼</h3><p>ä¸ºä»€ä¹ˆä¸ç›´æ¥å°† sandboxã€shim ç­‰ Kata ç›¸å…³è¿›ç¨‹æ·»åŠ åˆ° Pod cgroupï¼Ÿ</p><p>Kata shim å®ç°äº† per-sandbox cgroup ï¼ˆå³æ¯ä¸€ä¸ª sandbox éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ sandbox cgroupï¼‰æ¥æ”¯æŒ Docker åœºæ™¯ã€‚å°½ç®¡ Docker æ²¡æœ‰ Pod çš„æ¦‚å¿µï¼Œä½† Kata Containers ä»ç„¶åˆ›å»ºäº†ä¸€ä¸ª sandbox æ¥æ”¯æŒ Docker å®ç°çš„æ—  Podã€å•ä¸€å®¹å™¨ç”¨ä¾‹ï¼ˆå³ single_containerï¼‰ã€‚ä¸ºäº†ç®€åŒ–ä½¿ç”¨ï¼ŒKata Containers é€‰æ‹©ä¸€ä¸ªç‹¬ç«‹çš„ sandbox cgroupï¼Œè€Œä¸æ˜¯æ„å»ºå®¹å™¨å’Œ sandbox ä¹‹é—´çš„ cgroup æ˜ å°„å…³ç³»ã€‚</p><h3 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h3><p>å°† Kata Containers æ‰€æœ‰è¿›ç¨‹æ”¾ç½®åœ¨é€‚å½“å¤§å°çš„ Pod cgroup ä¸­å¯ä»¥ç®€åŒ–æ§åˆ¶æµç¨‹ï¼Œæœ‰åŠ©äºæ”¶é›†å‡†ç¡®çš„æŒ‡æ ‡ç»Ÿè®¡æ•°æ®å¹¶é˜²æ­¢ Kata å·¥ä½œè´Ÿè½½äº§ç”Ÿè¿‘é‚»å¹²æ‰°ï¼ˆnoisy neighborï¼‰ï¼Œå…·ä½“ä¸ºï¼š</p><p><strong>Pod èµ„æºç»Ÿè®¡</strong></p><p>å¦‚æœæƒ³è·å– Kata å®¹å™¨åœ¨ host ä¸Šçš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥ä» Pod cgroup ä¸­è·å–æŒ‡æ ‡ç»Ÿè®¡ä¿¡æ¯ã€‚å…¶ä¸­ï¼Œcgroup çš„ç»Ÿè®¡æ•°æ®åŒ…æ‹¬ Kata çš„é¢å¤–å¼€é”€ï¼Œæä¾›äº†åœ¨ Pod çº§åˆ«å’Œå®¹å™¨çº§åˆ«æ”¶é›†ä½¿ç”¨é™æ€ä¿¡æ¯çš„èƒ½åŠ›ã€‚</p><p><strong>æ›´å¥½çš„ host èµ„æºéš”ç¦»</strong></p><p>Kata è¿è¡Œæ—¶ä¼šå°†æ‰€æœ‰ Kata è¿›ç¨‹æ”¾åœ¨ Pod cgroup ä¸­ï¼Œæ‰€ä»¥å¯¹ Pod cgroup è®¾ç½®çš„èµ„æºé™åˆ¶å°†ä½œç”¨äº host ä¸­å±äº Kata sandbox çš„æ‰€æœ‰è¿›ç¨‹ï¼ˆä¾‹å¦‚ qemu-systemã€virtiofsd ç­‰ï¼‰ï¼Œä»è€Œå¯ä»¥æ”¹å–„ host ä¸­çš„éš”ç¦»ï¼Œé˜²æ­¢ Kata äº§ç”Ÿè¿‘é‚»å¹²æ‰°ï¼ˆnoisy neighborï¼‰ã€‚</p><h2 id="sandbox-cgroup-only-x3D-false"><a href="#sandbox-cgroup-only-x3D-false" class="headerlink" title="sandbox_cgroup_only &#x3D; false"></a>sandbox_cgroup_only &#x3D; false</h2><p>å¦‚æœæä¾›ç»™ Kata å®¹å™¨çš„ Pod cgroup å¤§å°ä¸åˆé€‚ï¼ŒKata ç»„ä»¶å°†æ¶ˆè€—å®é™…å®¹å™¨å·¥ä½œè´Ÿè½½æœŸæœ›ä½¿ç”¨çš„èµ„æºï¼Œå¯¼è‡´ä¸ç¨³å®šå’Œæ€§èƒ½ä¸‹é™ã€‚</p><p>ä¸ºé¿å…è¿™ç§æƒ…å†µï¼ŒKata Containers åˆ›å»ºäº†ä¸€ä¸ªåä¸º &#x2F;kata_overhead çš„ cgroupï¼Œå³ overhead cgroupï¼Œå¹¶å°†æ‰€æœ‰ä¸å·¥ä½œè´Ÿè½½æ— å…³çš„è¿›ç¨‹ï¼ˆé™¤ vCPU çº¿ç¨‹å¤–çš„ä»»ä½•è¿›ç¨‹ï¼‰ç§»è‡³å…¶ä¸­ã€‚</p><p>Kata Containers ä¸å¯¹ overhead cgroup ä½œä»»ä½•çº¦æŸæˆ–é™åˆ¶ï¼Œå› æ­¤å¯ä»¥</p><ul><li>é¢„å…ˆåˆ›å»ºå¹¶è§„åˆ’ overhead cgroup çš„é™åˆ¶æ¡ä»¶ï¼ŒKata Containers ä¸ä¼šå†é¢å¤–åˆ›å»ºï¼Œè€Œæ˜¯å°†æ‰€æœ‰ä¸å·¥ä½œè´Ÿè½½æ— å…³çš„è¿›ç¨‹ç§»åŠ¨åˆ°å…¶ä¸­</li><li>è®© Kata Containers åˆ›å»º overhead cgroupï¼Œè®©å…¶ä¸å—çº¦æŸæˆ–äº‹åè°ƒæ•´å¤§å°</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</span><br><span class="line">â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â”‚ â”‚  vCPU threads       â”‚ â”‚    â”‚ â”‚  VMM                â”‚ â”‚ â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â”‚ â”‚                     â”‚ â”‚    â”‚ â”‚  I/O threads        â”‚ â”‚ â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â”‚ â”‚                     â”‚ â”‚    â”‚ â”‚  Kata Shim          â”‚ â”‚ â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â”‚ â”‚                     â”‚ â”‚    â”‚ â”‚                     â”‚ â”‚ â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â”‚ â”‚ /kata_&lt;sandboxID&gt;   â”‚ â”‚    â”‚ â”‚ /&lt;sandboxID&gt;        â”‚ â”‚ â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â”‚  Pod                    â”‚    â”‚                         â”‚ â”‚  â”‚</span><br><span class="line">â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚</span><br><span class="line">â”‚  â”‚ /kubepods                   â”‚    â”‚ /kata_overhead            â”‚  â”‚</span><br><span class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</span><br><span class="line">â”‚ Node                                                               â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><h3 id="å®ç°ç»†èŠ‚-1"><a href="#å®ç°ç»†èŠ‚-1" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h3><p>å½“ sandbox_cgroup_only è¢«ç¦ç”¨æ—¶ï¼ŒKata shim å°†åœ¨ Pod cgroup ä¸‹åˆ›å»º sandbox cgroup å­ cgroupï¼Œå¹¶åœ¨ overhead cgroup ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º &#x2F;&lt;sandboxID&gt; çš„å­ cgroupã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">runC çš„ cgroup å±‚çº§ä¸é™åˆ¶</span></span><br><span class="line">â””â”€â”€ /kubepods/pod505eb17b-78d4-4dce-bfb2-60085f629344</span><br><span class="line">â”œâ”€â”€ tasks(ç©º)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_quota_us(-&gt; 100000)</span><br><span class="line">    â”œâ”€â”€ 499316b3661bc989f0999dd51901d2afaad0dda0aa614a2ebcd39f2517e7c56b(ä¸šåŠ¡å®¹å™¨)</span><br><span class="line">    |â”œâ”€â”€ tasks(ä¸šåŠ¡è¿›ç¨‹)</span><br><span class="line">    | â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    |â””â”€â”€ cpu.cfs_quota_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€fa6545c433f02a1c712db11cb58bb100a013f9622d725c6a41c60500c20031c5(infra å®¹å™¨)</span><br><span class="line">    â”œâ”€â”€ tasks(pause è¿›ç¨‹)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kata çš„ cgroup å±‚çº§ä¸é™åˆ¶</span></span><br><span class="line">â”œâ”€â”€ /kubepods/podf2f4d981-27ab-4deb-87c0-07764f72f63c</span><br><span class="line">|â”œâ”€â”€ tasks(ç©º)</span><br><span class="line">|   â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">|   â”œâ”€â”€ cpu.cfs_quota_us(-&gt; 100000)</span><br><span class="line">|   â””â”€â”€ kata_db541270577881d786b38b188d86959301c2e3e22bb7f08dcab009ed089d80d8(infra å®¹å™¨)</span><br><span class="line">|    â”œâ”€â”€ tasks(æœ‰ PIDï¼Œä½†æ˜¯è¿›ç¨‹ä¿¡æ¯å·²é”€æ¯ï¼Œåº”è¯¥å°±æ˜¯ç¤¾åŒºè¯´çš„ vCPU çº¿ç¨‹)</span><br><span class="line">|    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">|    â””â”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br><span class="line">â””â”€â”€ /kata_overhead/db541270577881d786b38b188d86959301c2e3e22bb7f08dcab009ed089d80d8</span><br><span class="line">â”œâ”€â”€ tasks(containerd-shim-kata-v2ã€virtiofsdã€vhost å’Œ qemu-system è™šæ‹ŸåŒ–è¿›ç¨‹)</span><br><span class="line">â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">â””â”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Kata VM ä¸­çš„ cgroup å±‚çº§ä¸é™åˆ¶</span></span><br><span class="line">â””â”€â”€ /kubepods/podf2f4d981-27ab-4deb-87c0-07764f72f63c</span><br><span class="line">â”œâ”€â”€ tasks(ç©º)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br><span class="line">    â”œâ”€â”€ 87bd38d05b248b095e2feb4d3e1196a8ab604baf1ede6f81b55a3fca42545a83(ä¸šåŠ¡å®¹å™¨)</span><br><span class="line">    |â”œâ”€â”€ tasks(ä¸šåŠ¡è¿›ç¨‹)</span><br><span class="line">    |â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    |â””â”€â”€ cpu.cfs_quota_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€db541270577881d786b38b188d86959301c2e3e22bb7f08dcab009ed089d80d8(infra å®¹å™¨)</span><br><span class="line">    â”œâ”€â”€ tasks(pause è¿›ç¨‹)</span><br><span class="line">    â”œâ”€â”€ cpu.cfs_period_us(-&gt; 100000)</span><br><span class="line">    â””â”€â”€ cpu.cfs_quota_us(-&gt; -1)</span><br></pre></td></tr></table></figure><p>ä¸å¯ç”¨ sandbox_cgroup_only æ—¶ä¸åŒï¼ŒKata shim å°†å…¶è‡ªèº«åŠ å…¥åˆ° overhead cgroup ä¸­ï¼Œç„¶åå°† vCPU çº¿ç¨‹ç§»åŠ¨åˆ° sandbox cgroup ä¸­ã€‚é™¤ vCPU çº¿ç¨‹å¤–çš„å…¶ä»– Kata è¿›ç¨‹å’Œçº¿ç¨‹éƒ½å°†åœ¨ overhead cgroup ä¸‹è¿è¡Œã€‚</p><p>åœ¨ç¦ç”¨ sandbox_cgroup_only çš„æƒ…å†µä¸‹ï¼ŒKata Containers å‡å®š Pod cgroup çš„å¤§å°ä»…èƒ½æ»¡è¶³å®¹å™¨å·¥ä½œè´Ÿè½½è¿›ç¨‹ã€‚VMM åˆ›å»ºçš„ vCPU çº¿ç¨‹æ˜¯å”¯ä¸€åœ¨ Pod cgroup ä¸‹è¿è¡Œçš„ Kata ç›¸å…³çº¿ç¨‹ï¼Œé™ä½äº† VMMã€Kata shim å’Œ I&#x2F;O çº¿ç¨‹ OOM çš„é£é™©ã€‚</p><h3 id="ä¼˜ç¼ºç‚¹"><a href="#ä¼˜ç¼ºç‚¹" class="headerlink" title="ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h3><p>åœ¨ä¸å—çº¦æŸçš„ overhead cgroup ä¸‹è¿è¡Œæ‰€æœ‰é vCPU çº¿ç¨‹å¯èƒ½ä¼šå¯¼è‡´å·¥ä½œè´Ÿè½½æ½œåœ¨åœ°æ¶ˆè€—å¤§é‡ host èµ„æºã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œç”±äº overhead cgroup çš„ä¸“ç”¨æ€§ï¼Œåœ¨ overhead cgroup ä¸‹è¿è¡Œæ‰€æœ‰é vCPU çº¿ç¨‹å¯ä»¥è·å– Kata Container Pod é¢å¤–å¼€é”€çš„å‡†ç¡®æŒ‡æ ‡ï¼Œä»¥æ­¤æ›´åˆç†çš„è°ƒæ•´ overhead cgroup å¤§å°å’Œçº¦æŸã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>VM è‡ªèº«çš„è§„æ ¼ç”¨äºé™åˆ¶ VM ä¸­æ‰€æœ‰ç³»ç»ŸæœåŠ¡ï¼ˆå¦‚ Kata agentï¼‰ä¸ç”¨æˆ·æœåŠ¡ï¼ˆå¦‚å®¹å™¨å·¥ä½œè´Ÿè½½ï¼‰çš„èµ„æºå¼€é”€</li><li>VM ä¸­çš„ cgroup ç”¨äºé™åˆ¶ Kata å®¹å™¨çš„å·¥ä½œè´Ÿè½½çš„èµ„æºå¼€é”€</li><li>host çš„ cgroup ç”¨äºé™åˆ¶ Kata å®¹å™¨åœ¨ host ä¾§è™šæ‹ŸåŒ–å±‚é¢çš„èµ„æºå¼€é”€ï¼ˆè§†ä¸åŒçš„ cgroup ç®¡ç†æ–¹å¼è€Œå®šï¼‰</li></ul><h1 id="runtimeClass-overhead"><a href="#runtimeClass-overhead" class="headerlink" title="runtimeClass.overhead"></a>runtimeClass.overhead</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kata</span></span><br><span class="line"><span class="attr">handler:</span> <span class="string">kata</span></span><br><span class="line"><span class="attr">overhead:</span></span><br><span class="line">  <span class="attr">podFixed:</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">&quot;1024Mi&quot;</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br></pre></td></tr></table></figure><p><strong>requests</strong>ï¼šresources.requests + runtimeClass.overhead</p><ul><li>èŠ‚ç‚¹è°ƒåº¦æ—¶ï¼Œæ— è®ºæ˜¯å¦å£°æ˜ resources.requestsï¼ŒruntimeClass.overhead å‡ä¼šè¿½åŠ åˆ° resources.requests ä¸­ï¼Œä¸¤è€…ä¹‹å’Œä½œä¸ºè°ƒåº¦çš„èµ„æºè¯·æ±‚é‡</li></ul><p><strong>limits</strong>ï¼šresources.limits + runtimeClass.overhead</p><ul><li><p>èµ„æºé™åˆ¶æ—¶ï¼Œå¦‚æœå£°æ˜äº† resources.limitï¼Œåˆ™ runtimeClass.overhead ä¼šè¿½åŠ åˆ°å…¶ä¸­ï¼Œä¸¤è€…ä¹‹å’Œä½œä¸ºèµ„æºçš„é™åˆ¶ä½¿ç”¨é‡</p><p>runtimeClass.overhead éƒ¨åˆ†ä¼šä½œç”¨åœ¨ Pod cgroup å±‚é¢</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Namespace     Name     CPU Requests     CPU Limits     Memory Requests     Memory Limits     Age</span><br><span class="line">---------     ----     ------------     ----------     ---------------     -------------     ---</span><br><span class="line">default       kata     1500m (4%)       1500m (4%)     2Gi (13%)           2Gi (13%)         7s</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œoverhead çš„èµ„æºå£°æ˜è§„èŒƒå¹¶ä¸ä¼šå½±å“åˆ° Pod çš„ QoSï¼Œä¹Ÿä¸ä¼šå½±å“åˆ° VM æœ€ç»ˆçš„è§„æ ¼ã€‚</p><h1 id="VM-è§„æ ¼"><a href="#VM-è§„æ ¼" class="headerlink" title="VM è§„æ ¼"></a>VM è§„æ ¼</h1><p>VM æœ€ç»ˆè§„æ ¼ä¸º</p><ul><li><strong>CPU</strong>ï¼š[hypervisor].default_vcpus + resources.limitsï¼Œæœ€å¤§ä¸è¶…è¿‡ [hypervisor].default_maxvcpus</li><li><strong>MEM</strong>ï¼š[hypervisor].default_memory + resources.limits</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:/# nproc</span><br><span class="line">2</span><br><span class="line">root@localhost:/# free -m</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           3017          46        2832           0         138        2929</span><br><span class="line">Swap:             0           0           0</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Kata Containers åœ¨ Kubernetes é›†ç¾¤åœºæ™¯ä¸­èµ„æºé™åˆ¶ä¸å®è·µéªŒè¯</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ OpenFaaS ã€æ¶æ„ä¸ç»„ä»¶æ¦‚è¿°</title>
    <link href="http://shenxianghong.github.io/2023/05/08/2023-05-08%20OpenFaaS%20%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0/"/>
    <id>http://shenxianghong.github.io/2023/05/08/2023-05-08%20OpenFaaS%20%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0/</id>
    <published>2023-05-07T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.274Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/openfaas/logo.png"></div><hr><blockquote><p>based on <strong>0.26.3</strong></p></blockquote><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><blockquote><p>Serverless Functions Made Simple</p></blockquote><p>OpenFaaS ä½¿å¼€å‘äººå‘˜å¯ä»¥è½»æ¾åœ°å°†äº‹ä»¶é©±åŠ¨ï¼ˆevent-drivenï¼‰çš„åŠŸèƒ½å’Œå¾®æœåŠ¡éƒ¨ç½²åˆ° Kubernetes ä¸­ï¼Œè€Œæ— éœ€é‡å¤çš„æ¨¡æ¿ä»£ç ã€‚OpenFaaS å°†ä»£ç æˆ–ç°æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…åˆ° Docker é•œåƒä¸­ï¼Œä½¿å…¶å…·æœ‰è‡ªåŠ¨ç¼©æ”¾å’ŒæœåŠ¡æŒ‡æ ‡çš„é«˜åº¦å¯æ‰©å±•ç‚¹ã€‚</p><p><strong>OpenFaaS äº®ç‚¹</strong></p><ul><li>æ”¯æŒä¸°å¯Œ UI å’Œä¸€é”®å®‰è£…ï¼Œä¾¿äºä½¿ç”¨</li><li>å€ŸåŠ©<a href="https://www.openfaas.com/blog/template-store/">æ¨¡æ¿åº“</a> æˆ– Dockerfile ä»¥ä»»ä½•è¯­è¨€ç¼–å†™æœåŠ¡å’Œå‡½æ•°</li><li>æ„å»ºå’Œå‘å¸ƒä»£ç è‡³ Docker é•œåƒæˆ–å…¶ä»– OCI å…¼å®¹æ ¼å¼çš„é•œåƒä¸­</li><li>æ˜“äºç§»æ¤ï¼Œå€ŸåŠ© <a href="https://github.com/openfaas/faas-netes">faas-netes</a> å¯åœ¨ç°æœ‰ç¡¬ä»¶æˆ–å…¬æœ‰&#x2F;ç§æœ‰äº‘ä¸Šè¿è¡Œ</li><li>æ”¯æŒ YAML æ ¼å¼çš„å‘½ä»¤è¡Œå·¥å…· â€” <a href="https://github.com/openfaas/faas-cli">faas-cli</a> ï¼Œç”¨äºæ¨¡æ¿åŒ–å’Œå®šä¹‰å‡½æ•°</li><li>è‡ªåŠ¨ç¼©æ”¾ï¼Œæ”¯æŒæµé‡é«˜å³°æ‰©å®¹ï¼Œå¹¶åœ¨ç©ºé—²æ—¶ç¼©å‡ç›´è‡³ 0</li><li><a href="https://www.openfaas.com/pricing/">ç‰ˆæœ¬ä¸°å¯Œ</a>ï¼ŒåŒ…å«ç¤¾åŒºç‰ˆã€æ ‡å‡†ç‰ˆå’Œå•†ä¸šç‰ˆ</li></ul><h1 id="è®¾è®¡ä¸æ¶æ„"><a href="#è®¾è®¡ä¸æ¶æ„" class="headerlink" title="è®¾è®¡ä¸æ¶æ„"></a>è®¾è®¡ä¸æ¶æ„</h1><h2 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h2><p>æ— è®ºæ˜¯æœ¬åœ°ç¯å¢ƒã€è‡ªæ‰˜ç®¡é›†ç¾¤ï¼Œè¿˜æ˜¯å¸¦æœ‰æ‰˜ç®¡æœåŠ¡ï¼ˆå¦‚ AWS Elastic Kubernetes Service (EKS)ï¼‰çš„å¹³å°ï¼Œéƒ¨ç½² OpenFaaS çš„æ¨èå¹³å°éƒ½æ˜¯ <strong>Kubernetes</strong>ã€‚</p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/of-layer-overview.png"></div><h3 id="CI-x2F-GitOps-layer"><a href="#CI-x2F-GitOps-layer" class="headerlink" title="CI &#x2F; GitOps layer"></a>CI &#x2F; GitOps layer</h3><p>OpenFaaS æ—¢å¯ä»¥è¿è¡Œå‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¿è¡Œ HTTP å¾®æœåŠ¡ã€‚æ¯ä¸ªå·¥ä½œè´Ÿè½½éƒ½æ„å»ºåˆ°ä¸€ä¸ªå®¹å™¨é•œåƒä¸­ï¼Œå¹¶å‘å¸ƒè‡³é•œåƒä»“åº“ã€‚</p><p>åœ¨å¼€å‘é˜¶æ®µï¼Œé€šå¸¸ä½¿ç”¨ faas-cli æ‰‹åŠ¨æ“ä½œå®Œæˆï¼Œè€Œåœ¨ç”Ÿäº§é˜¶æ®µï¼Œæœ‰å‡ ä¸ªå¸¸è§çš„é€‰æ‹©ï¼š</p><ul><li><p>æºä»£ç æ§åˆ¶ç®¡ç†ï¼ˆSCMï¼‰ç³»ç»Ÿä¸­å†…ç½®çš„ CI å·¥å…·</p><p>GitHub Actions æˆ– GitLab pipeline æ˜¯é€šè¿‡åœ¨ Job ä¸­æ‰§è¡Œ faas-cli deploy æˆ– faas-cli up æ„å»ºå’Œéƒ¨ç½²å‡½æ•°ã€‚éƒ¨ç½²æ˜¯åœ¨ Job å®Œæˆåè¿›è¡Œçš„ï¼Œå°†å˜æ›´æ¨é€åˆ°é›†ç¾¤ä¸­ã€‚å¦‚æœéœ€è¦è®¿é—®ç§æœ‰ VPC æˆ–æœ¬åœ°çš„é›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨ç§æœ‰ä¸”å®‰å…¨çš„å…¥å£éš§é“æ¥å®ç°</p></li><li><p>ä½¿ç”¨ ArgoCD å’Œ Flux ç­‰ GitOps æ§åˆ¶å™¨</p><p>GitOps æ–¹å¼é€šå¸¸åœ¨æ–°ç‰ˆæœ¬å¯ç”¨æ—¶ç«‹å³æŒç»­éƒ¨ç½² ã€‚éƒ¨ç½²æ˜¯é€šè¿‡ä»ç‰¹æ®Šçš„é…ç½®åº“ä¸­è·å–é¢„æœŸçŠ¶æ€æ¥è¿›è¡Œçš„</p></li></ul><h3 id="Application-Layer"><a href="#Application-Layer" class="headerlink" title="Application Layer"></a>Application Layer</h3><ul><li><a href="https://docs.openfaas.com/architecture/gateway/">OpenFaaS gateway</a> æä¾›äº†ä¸€ä¸ª REST APIï¼Œç”¨äºç®¡ç†å‡½æ•°ã€è®°å½•æŒ‡æ ‡å’Œç¼©æ”¾</li><li><a href="https://github.com/nats-io">NATS</a> ç”¨äºå¼‚æ­¥å‡½æ•°æ‰§è¡Œå’Œæ’é˜Ÿ</li><li>Prometheus æä¾›æŒ‡æ ‡å¹¶å¯ç”¨ Community Edition å’Œ OpenFaaS Pro çš„è‡ªåŠ¨ç¼©æ”¾ç‰¹æ€§</li></ul><p>ä½¿ç”¨ OpenFaaS Proï¼Œå¯ä»¥é€šè¿‡ HTTPã€Cronã€AWS SQS æˆ– Apache Kafka è§¦å‘å‡½æ•°ã€‚</p><p>æ„æˆ OpenFaaS çš„é¡¹ç›®ï¼ˆPrometheusã€Linuxã€OpenFaaSã€NATS å’Œ Kubernetesï¼‰å¯ä»¥ç§°ä¸º <a href="https://www.openfaas.com/blog/plonk-stack/">PLONK Stack</a>ã€‚ PLONK Stack èƒ½å¤Ÿè¿è¡Œäº‹ä»¶é©±åŠ¨ï¼ˆevent-drivenï¼‰çš„åŠŸèƒ½å’Œä¼ ç»Ÿçš„åŸºäº HTTP çš„å¾®æœåŠ¡ã€‚</p><p>è¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ Helm charts æˆ–ä½¿ç”¨ ArgoCDã€Flux ç­‰ GitOps æ§åˆ¶å™¨å®‰è£…ã€‚</p><h3 id="Infrastructure-Layer"><a href="#Infrastructure-Layer" class="headerlink" title="Infrastructure Layer"></a>Infrastructure Layer</h3><ul><li>å‡½æ•°çš„æ‰§è¡Œå•å…ƒæ˜¯ Podï¼Œç”± Containerd æˆ– Docker ç®¡ç†</li><li>é•œåƒä»“åº“å°†æ¯ä¸ªå‡½æ•°ä½œä¸ºä¸å¯å˜çš„åˆ¶å“ä¿å­˜ï¼Œå¯ä»¥å€ŸåŠ©é•œåƒä»“åº“çš„ REST APIã€UI æˆ– CLI å°†å…¶éƒ¨ç½²åˆ° OpenFaaS gateway</li><li>Kubernetes æ˜¯å…è®¸å‡½æ•°è·¨å¹³å°ï¼Œfaasd æ˜¯å°å‹å®‰è£…çš„æ›´ç®€å•æ›¿ä»£æ–¹æ¡ˆ</li></ul><p>è¯¥ Layer é€šå¸¸åœ¨æ¢ç´¢å’Œå¼€å‘æœŸé—´æ‰‹åŠ¨æ„å»ºï¼Œåœ¨ç”Ÿäº§æœŸé—´ä½¿ç”¨ Terraform ç­‰å·¥å…·æ„å»ºã€‚</p><h3 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h3><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/of-workflow.png"></div><p>å¯ä»¥é€šè¿‡å…¶ REST APIã€CLI æˆ– UI è®¿é—® OpenFaas Gatewayã€‚æ‰€æœ‰æœåŠ¡æˆ–å‡½æ•°éƒ½ä¼šæš´éœ²ä¸€ä¸ªé»˜è®¤è·¯ç”±ï¼Œä½†è‡ªå®šä¹‰åŸŸä¹Ÿå¯ä»¥ç”¨äºæ¯ä¸ªç«¯ç‚¹ã€‚</p><p>Prometheus æ”¶é›†æŒ‡æ ‡ï¼Œè¿™äº›æŒ‡æ ‡å¯é€šè¿‡ OpenFaas Gateway çš„ API è·å¾—å¹¶ç”¨äºè‡ªåŠ¨ç¼©æ”¾ã€‚</p><p>é€šè¿‡å°†å‡½æ•°çš„ URL ä»åŒæ­¥çš„ &#x2F;function&#x2F;NAME è½¬å˜ä¸ºå¼‚æ­¥çš„ &#x2F;async-function&#x2F;NAMEï¼Œå¯ä»¥ä½¿ç”¨ NATS Streaming åœ¨é˜Ÿåˆ—ä¸­è¿è¡Œè°ƒç”¨ã€‚è¿˜å¯ä»¥ä¼ é€’ä¸€ä¸ªå¯é€‰çš„å›è°ƒ URLã€‚</p><p>faas-netes æ˜¯ OpenFaaS æœ€å—æ¬¢è¿çš„ç¼–æ’ Providerï¼Œä½†ç¤¾åŒºä¹Ÿæä¾›äº†é’ˆå¯¹ Docker Swarmã€Hashicorp Nomadã€AWS Fargate&#x2F;ECS å’Œ AWS Lambda çš„ Providerã€‚ Provider ä½¿ç”¨ <a href="https://github.com/openfaas/faas-provider">faas-provider</a> SDK æ„å»ºã€‚</p><h2 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h2><p><em><a href="https://github.com/openfaas/faas/tree/master/gateway">https://github.com/openfaas/faas/tree/master/gateway</a></em></p><p>API Gateway ä¸ºå‡½æ•°æä¾›å¤–éƒ¨è·¯ç”±ï¼Œå¹¶é€šè¿‡ Prometheus æ”¶é›†äº‘åŸç”ŸæŒ‡æ ‡ã€‚æ­¤å¤–ï¼ŒAPI Gateway å†…ç½®çš„ UI å¯ç”¨äºéƒ¨ç½²ç”¨æˆ·è‡ªå®šä¹‰çš„å‡½æ•°æˆ–æ¥è‡ª OpenFaaS Function Store çš„å‡½æ•°ï¼Œå¹¶è°ƒç”¨ã€‚</p><p>API Gateway å°†é€šè¿‡æ›´æ”¹ Kubernetes API ä¸­çš„æœåŠ¡å‰¯æœ¬è®¡æ•°æ¥æ»¡è¶³éœ€æ±‚æ‰©å±•åŠŸèƒ½ã€‚API Gateway çš„ &#x2F;system&#x2F;alert endpoint ç”¨äºæ¥æ”¶ AlertManager ç”Ÿæˆçš„è‡ªå®šä¹‰å‘Šè­¦ã€‚</p><p><strong>æ ¸å¿ƒç‰¹ç‚¹</strong></p><ul><li>å†…ç½® UI</li><li>æ”¯æŒä» Function Store éƒ¨ç½²å‡½æ•°æˆ–éƒ¨ç½²è‡ªå®šä¹‰å‡½æ•°</li><li>é€šè¿‡ Prometheus æ£€æµ‹</li><li>é€šè¿‡ AlertManager å’Œ Prometheus è‡ªåŠ¨ç¼©æ”¾</li><li>ç¼©æ”¾è‡³ 0</li><li>æ”¯æŒ REST API Swagger æ–‡æ¡£</li></ul><p><strong>ä»¥ Kubernetes ä½œä¸ºç¼–æ’ Provider çš„æµç¨‹ç¤ºä¾‹</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/of-conceptual-operator.png"></div><h2 id="Watchdog"><a href="#Watchdog" class="headerlink" title="Watchdog"></a>Watchdog</h2><p>OpenFaaS watchdog è´Ÿè´£å¯åŠ¨å’Œç›‘æ§ OpenFaaS ä¸­çš„å‡½æ•°ã€‚é€šè¿‡ä½¿ç”¨ watchdogï¼Œä»»ä½•äºŒè¿›åˆ¶æ–‡ä»¶éƒ½å¯ä»¥æˆä¸ºä¸€ä¸ªå‡½æ•°ã€‚</p><p>watchdog ä½œä¸ºä¸€ä¸ªâ€œåˆå§‹åŒ–è¿›ç¨‹â€ï¼Œå¸¦æœ‰ä¸€ä¸ªç”¨ Golang ç¼–å†™çš„åµŒå…¥å¼ HTTP æœåŠ¡å™¨ï¼Œå®ƒå¯ä»¥æ”¯æŒå¹¶å‘è¯·æ±‚ã€è¶…æ—¶å’Œå¥åº·æ£€æŸ¥ã€‚å’Œ of-watchdog ç±»ä¼¼ï¼Œä½†éå¸¸é€‚åˆæµå¼çš„ä½¿ç”¨åœºæ™¯æˆ–éœ€è¦åœ¨ç»´æŠ¤å…³é”®èµ„æºçš„æƒ…å†µï¼Œä¾‹å¦‚æ•°æ®åº“è¿æ¥ã€ML æ¨¡å‹æˆ–å…¶ä»–æ•°æ®ç­‰è¯·æ±‚ä¹‹é—´ã€‚</p><p>å®˜æ–¹æä¾›çš„ <a href="https://github.com/openfaas/templates">templates repository</a> æ¨¡æ¿ä»“åº“å†…ç½®äº†çš„é€šç”¨ç¼–ç¨‹è¯­è¨€çš„ watchdog æ¨¡æ¿ï¼š</p><table><thead><tr><th>Name</th><th>Language</th><th>Version</th><th>Linux base</th><th>Watchdog</th><th>Link</th></tr></thead><tbody><tr><td>dockerfile</td><td>Dockerfile</td><td>N&#x2F;A</td><td>Alpine Linux</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/dockerfile">Dockerfile template</a></td></tr><tr><td>go</td><td>Go</td><td>1.18</td><td>Alpine Linux</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/go">Go template</a></td></tr><tr><td>node12</td><td>NodeJS</td><td>12</td><td>Alpine Linux</td><td>of-watchdog</td><td><a href="https://github.com/openfaas/templates/tree/master/template/node12">NodeJS template</a></td></tr><tr><td>node14</td><td>NodeJS</td><td>14</td><td>Alpine Linux</td><td>of-watchdog</td><td><a href="https://github.com/openfaas/templates/tree/master/template/node14">NodeJS template</a></td></tr><tr><td>node16</td><td>NodeJS</td><td>16</td><td>Alpine Linux</td><td>of-watchdog</td><td><a href="https://github.com/openfaas/templates/tree/master/template/node16">NodeJS template</a></td></tr><tr><td>node17</td><td>NodeJS</td><td>17</td><td>Alpine Linux</td><td>of-watchdog</td><td><a href="https://github.com/openfaas/templates/tree/master/template/node17">NodeJS template</a></td></tr><tr><td>node18</td><td>NodeJS</td><td>18</td><td>Alpine Linux</td><td>of-watchdog</td><td><a href="https://github.com/openfaas/templates/tree/master/template/node18">NodeJS template</a></td></tr><tr><td>node</td><td>NodeJS</td><td>12</td><td>Alpine Linux</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/node">NodeJS template</a></td></tr><tr><td>python3</td><td>Python</td><td>3</td><td>Alpine Linux</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/python3">Python 3 template</a></td></tr><tr><td>python3-debian</td><td>Python</td><td>3</td><td>Debian Linux</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/python3-debian">Python 3 Debian template</a></td></tr><tr><td>python</td><td>Python</td><td>2.7</td><td>Alpine Linux</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/python">Python 2.7 template</a></td></tr><tr><td>java11-vert-x</td><td>Java and <a href="https://vertx.io/">Vert.x</a></td><td>11</td><td>Debian GNU&#x2F;Linux</td><td>of-watchdog</td><td><a href="https://github.com/openfaas/templates/tree/master/template/java11-vert-x">Java LTS template</a></td></tr><tr><td>java11</td><td>Java</td><td>11</td><td>Debian GNU&#x2F;Linux</td><td>of-watchdog</td><td><a href="https://github.com/openfaas/templates/tree/master/template/java11">Java LTS template</a></td></tr><tr><td>ruby</td><td>Ruby</td><td>2.7</td><td>Alpine Linux 3.11</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/ruby">Ruby template</a></td></tr><tr><td>php7</td><td>PHP</td><td>7.4</td><td>Alpine Linux</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/php7">PHP 7 template</a></td></tr><tr><td>php8</td><td>PHP</td><td>8.1</td><td>Alpine Linux</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/php8">PHP 8 template</a></td></tr><tr><td>csharp</td><td>C#</td><td>N&#x2F;A</td><td>Debian GNU&#x2F;Linux 9</td><td>classic</td><td><a href="https://github.com/openfaas/templates/tree/master/template/csharp">C# template</a></td></tr></tbody></table><p>æ­¤å¤–ï¼Œè¿˜æœ‰ç¤¾åŒºæä¾›çš„ <a href="https://github.com/openfaas/store/blob/master/templates.json">community template store</a> æ¨¡æ¿ä»“åº“ã€‚</p><h3 id="Classic-watchdog"><a href="#Classic-watchdog" class="headerlink" title="Classic watchdog"></a>Classic watchdog</h3><p>Classic watchdog æœ€åˆç”¨äºæ‰€æœ‰å®˜æ–¹ OpenFaaS æ¨¡æ¿ï¼Œä½† of-watchdog ç°åœ¨æ›´å—é’çã€‚<em>æ›´å¤šå‚è€ƒï¼š<a href="https://github.com/openfaas/classic-watchdog/blob/master/README.md">https://github.com/openfaas/classic-watchdog/blob/master/README.md</a></em></p><p><strong>watchdog è°ƒç”¨æµç¨‹</strong></p><div align=center><img width="600" style="border: 0px" src="/gallery/openfaas/classic-watchdog.jpeg"></div><h3 id="of-watchdog"><a href="#of-watchdog" class="headerlink" title="of-watchdog"></a>of-watchdog</h3><blockquote><p>Reverse proxy for HTTP microservices and STDIO</p></blockquote><p>of-watchdog é¡¹ç›®æ˜¯å¯¹ä¸Šè¿° Classic Watchdog çš„è¡¥å……ï¼ˆof-watchdog é€‚ç”¨äºç”Ÿäº§ï¼Œæ˜¯ openfaas GitHub ç»„ç»‡çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚å®ƒäº 2017 å¹´ 10 æœˆå¯åŠ¨ï¼Œä¸º watchdog å’Œå‡½æ•°ä¹‹é—´çš„é€šä¿¡æä¾›äº† STDIO çš„æ›¿ä»£æ–¹æ¡ˆã€‚</p><p><strong>of-watchdog ç»„ä»¶çš„å„ç§æ¨¡å¼</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/watchdog-modes.png"></div><p>of-watchdog å®ç°äº†ä¸€ä¸ªç›‘å¬ 8080 ç«¯å£çš„ HTTP æœåŠ¡å™¨ï¼Œä½œä¸ºè¿è¡Œå‡½æ•°å’Œå¾®æœåŠ¡çš„åå‘ä»£ç†ã€‚å®ƒå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸º OpenFaaS å®¹å™¨çš„å…¥å£ç‚¹ã€‚</p><p>è¿™ä¸ªç‰ˆæœ¬çš„ OpenFaaS çœ‹é—¨ç‹—å¢åŠ äº†å¯¹ HTTP ä»£ç†å’Œ STDIO çš„æ”¯æŒï¼Œå…·æœ‰å†…å­˜é‡ç”¨å’Œé«˜é€Ÿè¯·æ±‚æœåŠ¡å“åº”çš„ç‰¹æ€§ï¼Œä¸»è¦åŒºåˆ«åœ¨äºåœ¨è°ƒç”¨ä¹‹é—´ä¿æŒå‡½æ•°è¿›ç¨‹å¤„äºå¾…å‘½çŠ¶æ€ï¼ˆwarmï¼‰çš„èƒ½åŠ›ã€‚Classic watchdog ä¸ºæ¯ä¸ªè¯·æ±‚ fork ä¸€ä¸ªè¿›ç¨‹ï¼Œæä¾›æœ€é«˜çº§åˆ«çš„å¯ç§»æ¤æ€§ï¼Œåœ¨è¾ƒæ–°çš„ç‰ˆæœ¬å¯ç”¨äº†ä¸€ç§ HTTP æ¨¡å¼ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œå¯ä»¥å¤ç”¨è¿›ç¨‹ä»¥æŠµæ¶ˆ fork å¸¦æ¥çš„å»¶è¿Ÿã€‚</p><p>å®ƒçš„ç›®çš„ä¸æ˜¯è¦å–ä»£ Classic watchdogï¼Œè€Œæ˜¯ä¸ºé‚£äº›éœ€è¦è¿™äº›åŠŸèƒ½çš„äººæä¾›å¦ä¸€ç§é€‰æ‹©ã€‚</p><h2 id="Auto-Scaler"><a href="#Auto-Scaler" class="headerlink" title="Auto Scaler"></a>Auto Scaler</h2><p><em>ä»… OpenFaas Pro æ”¯æŒã€‚</em></p><p>OpenFaas Pro çš„è‡ªåŠ¨ç¼©æ”¾çš„ç­–ç•¥æ˜¯æ ¹æ®ä»¥ä¸‹å‡½æ•°æ ‡ç­¾è¿›è¡Œé…ç½®ã€‚é€šè¿‡ç½‘å…³çš„æ‰€æœ‰è°ƒç”¨ï¼Œæ— è®ºæ˜¯åŒæ­¥å‡½æ•° <code>/function/</code> è¿˜æ˜¯å¼‚æ­¥å‡½æ•° <code>/async-function</code> ï¼Œéƒ½é‡‡ç”¨è¿™ç§è‡ªåŠ¨ç¼©æ”¾é…ç½®ï¼š</p><table><thead><tr><th>Label</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>com.openfaas.scale.max</code></td><td>The maximum number of replicas to scale to.</td><td><code>20</code></td></tr><tr><td><code>com.openfaas.scale.min</code></td><td>The minimum number of replicas to scale to.</td><td><code>1</code></td></tr><tr><td><code>com.openfaas.scale.zero</code></td><td>Whether to scale to zero.</td><td><code>false</code></td></tr><tr><td><code>com.openfaas.scale.zero-duration</code></td><td>Idle duration before scaling to zero</td><td><code>15m</code></td></tr><tr><td><code>com.openfaas.scale.target</code></td><td>Target load per replica for scaling</td><td><code>50</code></td></tr><tr><td><code>com.openfaas.scale.target-proportion</code></td><td>Proportion as a float of the target i.e. 1.0 &#x3D; 100% of target</td><td><code>0.90</code></td></tr><tr><td><code>com.openfaas.scale.type</code></td><td>Scaling mode of <code>rps</code>, <code>capacity</code>, <code>cpu</code></td><td><code>rps</code></td></tr></tbody></table><p>OpenFaaS Pro è‡ªåŠ¨ç¼©æ”¾ç¤ºä¾‹ï¼š</p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/openfaas-pro-scale.jpeg"></div><p><strong>ç¼©æ”¾ä¾æ®</strong></p><p>OpenFaaS Pro æä¾›ä¸‰ç§è‡ªåŠ¨ç¼©æ”¾æ¨¡å¼ï¼š</p><ul><li><p>capacity</p><p>åŸºäºè¯·æ±‚æˆ–è¿æ¥æ€»é‡ã€‚é€‚ç”¨äºé•¿æ—¶é—´è¿è¡Œçš„å‡½æ•°æˆ–ä¸€æ¬¡åªèƒ½å¤„ç†æœ‰é™æ•°é‡è¯·æ±‚çš„å‡½æ•°</p></li><li><p>rps</p><p>åŸºäºå‡½æ•°æ¯ç§’å®Œæˆçš„è¯·æ±‚ã€‚éå¸¸é€‚åˆæ‰§è¡Œé€Ÿåº¦å¿«ä¸”ååé‡é«˜çš„å‡½æ•°</p></li><li><p>cpu</p><p>åŸºäºå‡½æ•°çš„ CPU ä½¿ç”¨ç‡ï¼Œæ­¤ç­–ç•¥é€‚ç”¨äºå— CPU é™åˆ¶çš„å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…åœ¨ capacity å’Œ RPS æ¨¡å¼ä¸‹æœªæä¾›æœ€ä½³æ‰©å±•é…ç½®æ–‡ä»¶çš„æƒ…å†µã€‚è¿™é‡Œé…ç½®çš„å€¼æ˜¯ä»¥ milli-CPU ä¸ºå•ä½çš„ï¼Œæ‰€ä»¥1000 å  1 ä¸ª CPU æ ¸</p></li></ul><p>æ— è®ºå“ªç§ç¼©æ”¾æ¨¡å¼ï¼Œéƒ½éœ€è¦åœ¨é…ç½®å‡½æ•°è‡ªåŠ¨ç¼©æ”¾æ—¶è®¾ç½®ä¸€ä¸ªç›®æ ‡å€¼ï¼Œå³å‡½æ•°æ¯ä¸ªå‰¯æœ¬çš„å¹³å‡è´Ÿè½½ã€‚OpenFaaS ä¼šå®šæœŸæŸ¥è¯¢å¹¶è®¡ç®—å½“å‰è´Ÿè½½ï¼Œç”¨äºè®¡ç®—é¢„æœŸå‰¯æœ¬æ•°ï¼Œè§„åˆ™ä¸ºï¼š</p><blockquote><p>desired &#x3D; ready pods * ( mean load per pod &#x2F; target load per pod )</p></blockquote><p>æ­¤å¤–ï¼Œtarget-proportion å¯ç”¨äºè°ƒæ•´æå‰æˆ–å»¶è¿Ÿç¼©æ”¾å‘ç”Ÿçš„æ—¶é—´ï¼š</p><blockquote><p>desired &#x3D; ready pods * ( mean load per pod &#x2F; ( target load per pod * target-proportion ) )</p></blockquote><p><strong>æµç¨‹ç¤ºä¾‹</strong></p><p>å‰ç½®æ¡ä»¶ä¸ºï¼š</p><ul><li>sleep å‡½æ•°åº”ç”¨åœ¨ capacity æ¨¡å¼ä¸‹è¿è¡Œï¼Œç›®æ ‡è´Ÿè½½ä¸º 5 ä¸ªè¯·æ±‚é‡</li><li>å½“å‰ sleep å‡½æ•°åº”ç”¨çš„å®é™…è´Ÿè½½ä¸º 15 ä¸ªè¯·æ±‚é‡</li><li>sleep å‡½æ•°åº”ç”¨å‰¯æœ¬å½“å‰ä¸º 1</li><li>target-proportion è®¾ç½®ä¸º 1.0ï¼Œå³ä¸º 100%</li></ul><p>ç¼©æ”¾æµç¨‹ä¸ºï¼š</p><ol><li>å‚è€ƒä¸Šè¿°è§„åˆ™ï¼Œå¹³å‡æ¯ä¸ªå‰¯æœ¬çš„è¯·æ±‚é‡ä¸º <code>15 / 1 = 15</code>ï¼Œè¶…å‡º 5 ä¸ª è¯·æ±‚é‡çš„é¢„æœŸå€¼ï¼Œè¯„ä¼°å‰¯æœ¬æ•°ä¸º <code>ceil ( 1 * ( 15 / 5 * 1 ) ) = 3</code></li><li>å‰¯æœ¬æ•°è°ƒæ•´ä¸º 3 åï¼Œè¯·æ±‚é‡å¢åŠ åˆ° 25ï¼Œæ­¤æ—¶å¹³å‡æ¯ä¸ªå‰¯æœ¬çš„è¯·æ±‚é‡ä¸º <code>25 / 3 = 8.33</code>ï¼Œè¯„ä¼°å‰¯æœ¬æ•°ä¸º <code>ceil ( 3 * ( 8.33 / 5 * 1 ) ) = 5</code></li><li>å½“ä¸å†æœ‰è¯·æ±‚æ—¶ï¼Œè¯„ä¼°å‰¯æœ¬æ•°ä¸º <code>ceil ( 3 * ( 0 / 5 * 1) ) = 0</code></li><li>æ˜¯å¦æ”¯æŒç¼©å®¹ä¸º 0 å–å†³äº OpenFaaS ç‰ˆæœ¬</li></ol><p><strong>è®¾è®¡åˆè¡·</strong></p><p>åœ¨é—²ç½®æ—¶å°†å‡½æ•°ç¼©å®¹åˆ°é›¶å‰¯æœ¬å¯ä»¥é€šè¿‡å‡å°‘é›†ç¾¤ä¸­æ‰€éœ€çš„èŠ‚ç‚¹æ•°é‡æ¥èŠ‚çœæˆæœ¬ï¼Œè¿˜å¯ä»¥å‡å°‘é™æ€å¤§å°æˆ–æœ¬åœ°é›†ç¾¤ä¸Šçš„èŠ‚ç‚¹æ¶ˆè€—ã€‚</p><p>åœ¨ OpenFaaS ä¸­ï¼Œç¼©æ”¾åˆ°é›¶åœ¨é»˜è®¤æƒ…å†µä¸‹æ˜¯å…³é—­çš„ï¼Œå¹¶ä¸”æ˜¯ OpenFaaS Pro ä¸€éƒ¨åˆ†åŠŸèƒ½ã€‚å®‰è£…åï¼Œç©ºé—²å‡½æ•°å¯ä»¥é…ç½®ä¸ºåœ¨ä¸€æ®µæ—¶é—´å†…æœªæ”¶åˆ°ä»»ä½•è¯·æ±‚æ—¶ç¼©å‡ã€‚ç¤¾åŒºå»ºè®®å°†æ­¤æ•°å­—è®¾ç½®ä¸ºæœ€å¤§è¶…æ—¶çš„ 2 å€ã€‚</p><p>å¯ä»¥é€šè¿‡ OpenFaaS ç½‘å…³çš„ scale_from_zero ç¯å¢ƒå˜é‡åˆ‡æ¢ä»é›¶å‰¯æœ¬å‘ä¸Šæ‰©å±•ã€‚è¯¥ç‰¹æ€§åœ¨ Kubernetes å’Œ faasd ä¸Šé»˜è®¤å¼€å¯ã€‚</p><p>å¯¹ä¸å¯ç”¨å‡½æ•°çš„è¯·æ±‚ï¼Œä»å‘é€å¤„ç†åˆ°æœåŠ¡å¤„ç†è¯¥è¯·æ±‚ä¹‹é—´çš„å»¶è¿Ÿæˆä¸ºå†·å¯åŠ¨ã€‚</p><ul><li><p>å¦‚æœä¸æƒ³å†·å¯åŠ¨æ€ä¹ˆåŠï¼Ÿ</p><p>OpenFaaS ä¸­çš„å†·å¯åŠ¨æ˜¯ä¸¥æ ¼å¯é€‰çš„ã€‚å¯¹äºæ—¶é—´æ•æ„Ÿçš„æ“ä½œï¼Œå¯ä»¥é€šè¿‡è‡³å°‘æœ‰ 1 ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬æ¥é¿å…å†·å¯åŠ¨ã€‚é€šè¿‡å…³é”®å‡½æ•°ç¦æ­¢ç¼©æ”¾åˆ° 0ï¼Œæˆ–è€…é€šè¿‡å¼‚æ­¥è·¯ç”±è°ƒç”¨æ¥å®ç°ï¼Œä»è€Œå°†è¯·æ±‚æ—¶é—´ä¸è°ƒç”¨è€…åˆ†ç¦»</p></li><li><p>å†·å¯åŠ¨åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p><p>å†·å¯åŠ¨åŒ…æ‹¬ä»¥ä¸‹æµç¨‹ï¼šåˆ›å»ºè¯·æ±‚åœ¨èŠ‚ç‚¹ä¸Šè°ƒåº¦å®¹å™¨ã€æ‰¾åˆ°åˆé€‚çš„èŠ‚ç‚¹ã€æ‹‰å– Docker é•œåƒã€åœ¨å®¹å™¨å¯åŠ¨å¹¶è¿è¡Œåè¿›è¡Œåˆå§‹æ£€æŸ¥ã€‚å¯ä»¥é€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šé¢„çƒ­é•œåƒä»¥åŠå°† Kubernetes Liveness å’Œ Readiness Probes è®¾ç½®ä¸ºæ›´å¿«çš„èŠ‚å¥è¿è¡Œï¼Œå¯ä»¥é™ä½æ€»å¼€é”€ã€‚æ›´å¤šå‚è€ƒï¼š<a href="https://github.com/openfaas/faas-netes/tree/master/chart/openfaas">å†·å¯åŠ¨è¿›è¡Œä¼˜åŒ–çš„è¯´æ˜</a>ã€‚</p><p>å½“å¯ç”¨ scale_from_zero æ—¶ï¼Œç¼“å­˜ä¼šä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œæ ¹æ®æ¯ä¸ªå‡½æ•°çš„å°±ç»ªæƒ…å†µï¼Œå¦‚æœæ”¶åˆ°è¯·æ±‚æ—¶å‡½æ•°æœªå°±ç»ªï¼Œåˆ™ HTTP è¿æ¥å°†è¢«é˜»æ­¢ï¼Œå‡½æ•°å°†ç¼©æ”¾åˆ°æœ€å°å‰¯æœ¬ï¼Œä¸€æ—¦å‰¯æœ¬å¯ç”¨ï¼Œè¯·æ±‚å°±ä¼šæŒ‰æ­£å¸¸æ–¹å¼å¤„ç†ã€‚å…·ä½“æµç¨‹åœ¨ç½‘å…³ç»„ä»¶çš„æ—¥å¿—ä¸­å¯ä»¥çœ‹åˆ°ã€‚æ›´å¤šå‚è€ƒï¼š<a href="https://www.openfaas.com/blog/what-serverless-coldstart/">å†·å¯åŠ¨æ¦‚è¿°</a>ã€‚</p></li><li><p>å¦‚æœå‡½æ•°åœ¨æŒ‰æ¯”ä¾‹ç¼©å°æ—¶ä»åœ¨è¿è¡Œæ€ä¹ˆåŠï¼Ÿ</p><p>ä¸åº”è¯¥å‘ç”Ÿï¼Œå‰ææ˜¯å·²ç»ä¸ºå‡½æ•°çš„ç©ºé—²æ£€æµ‹è®¾ç½®äº†è¶³å¤Ÿçš„å€¼ã€‚ä½†å¦‚æœæ˜¯è¿™æ ·ï¼ŒOpenFaaS watchdog å’Œå®˜æ–¹å‡½æ•°æ¨¡æ¿å°†å…è®¸å‡½æ•°æ­£å¸¸ç»ˆæ­¢ã€‚æ›´å¤šå‚è€ƒï¼š<a href="https://www.openfaas.com/blog/long-running-jobs/">ä¸º OpenFaaS ç”¨æˆ·æ”¹è¿›é•¿æ—¶é—´è¿è¡Œçš„ä½œä¸š</a>ã€‚</p></li></ul><p>Prometheus å°†ç›‘æ§æŒ‡æ ‡å‘ç»™ AlertManager ä¹‹åï¼ŒAlertManager ä¼šè°ƒç”¨ &#x2F;system&#x2F;alert æ¥å£ï¼Œè¿™ä¸ªæ¥å£çš„ handler æ˜¯ç”± handlers.MakeAlertHandler æ–¹æ³•ç”Ÿæˆã€‚MakeAlertHandler æ–¹æ³•æ¥æ”¶çš„å‚æ•°æ˜¯ ServiceQueryã€‚ServiceQuery æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œç”¨æ¥è·å–æˆ–è€…è®¾ç½®æœ€å¤§çš„å‰¯æœ¬æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServiceQuery provides interface for replica querying/setting</span></span><br><span class="line"><span class="keyword">type</span> ServiceQuery <span class="keyword">interface</span> &#123;</span><br><span class="line">GetReplicas(service, namespace <span class="type">string</span>) (response ServiceQueryResponse, err <span class="type">error</span>)</span><br><span class="line">SetReplicas(service, namespace <span class="type">string</span>, count <span class="type">uint64</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MakeAlertHandler çš„å‡½æ•°ä¸»è¦æ˜¯ä» http.Request ä¸­è¯»å– bodyï¼Œç„¶åååºåˆ—åŒ–æˆ PrometheusAlert å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œæ”¯æŒå¯¹å¤šä¸ªå‡½æ•°è¿›è¡Œç¼©æ”¾ã€‚ååºåˆ—åŒ–ä¹‹åï¼Œè°ƒç”¨ handleAlerts æ–¹æ³•ï¼Œè€Œ handleAlerts å¯¹ alerts è¿›è¡Œéå†ï¼Œé’ˆå¯¹æ¯ä¸ª alert è°ƒç”¨äº† scaleService æ–¹æ³•ã€‚scaleService æ‰æ˜¯çœŸæ­£å¤„ç†ä¼¸ç¼©æœåŠ¡çš„å‡½æ•°ã€‚</p><p>å¯¹äº OpenFaaS CE è€Œè¨€ï¼ŒAuto Scaler èƒ½åŠ›ç›¸å¯¹è€Œè¨€è¾ƒä½ï¼Œä»…æ”¯æŒæœ€å¤§å’Œæœ€å°çš„å‰¯æœ¬æ•°ï¼š</p><table><thead><tr><th>Label</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td><code>com.openfaas.scale.max</code></td><td>The maximum number of replicas to scale to.</td><td><code>5</code></td></tr><tr><td><code>com.openfaas.scale.min</code></td><td>The minimum number of replicas to scale to.</td><td><code>1</code></td></tr><tr><td><code>com.openfaas.scale.factor</code></td><td>Define the overall scaling behavior of the function.</td><td><code>20%</code></td></tr></tbody></table><h2 id="Faas-Provider"><a href="#Faas-Provider" class="headerlink" title="Faas Provider"></a>Faas Provider</h2><p>faas-provider æä¾›å‡½æ•°çš„ CRUD API ä»¥åŠè°ƒç”¨åŠŸèƒ½ã€‚</p><p>faas-provider æ˜¯ä¸€ä¸ªç”¨ Go ç¼–å†™çš„ SDKï¼Œå®ƒç¬¦åˆ OpenFaaS Provider çš„ HTTP REST APIã€‚å®ç°æ¥å£å£°æ˜çš„ provider åº”è¯¥ä¸ OpenFaaS å·¥å…·é“¾å’Œç”Ÿæ€ç³»ç»Ÿå…¼å®¹ï¼ŒåŒ…æ‹¬ UIã€CLIã€Function Store å’Œ Template Storeã€‚</p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/providers-conceptual-flow.png"></div><p>æ¯ä¸ª Provider éƒ½å®ç°ä»¥ä¸‹è¡Œä¸ºï¼š</p><ul><li>å‡½æ•°ï¼ˆæˆ–å¾®æœåŠ¡ï¼‰çš„ CRUD</li><li>é€šè¿‡ä»£ç†è°ƒç”¨å‡½æ•°</li><li>å‡½æ•°ç¼©æ”¾</li><li>Secret çš„ CRUDï¼ˆå¯é€‰ï¼‰</li><li>æ—¥å¿—æµï¼ˆå¯é€‰ï¼‰</li></ul><table><thead><tr><th>Provider</th><th>Overview</th></tr></thead><tbody><tr><td>Kubernetes Provider (<a href="https://github.com/openfaas/faas-netes">faas-netes</a>)</td><td>é’ˆå¯¹ Kubernetes çš„å®˜æ–¹ OpenFaaS Providerï¼Œé»˜è®¤å†…ç½®åœ¨ Helm chart ä¸­</td></tr><tr><td>faasd Provider (<a href="https://github.com/openfaas/faasd">faasd</a>)</td><td>OpenFaaS çš„å¦ä¸€ç§æ€è·¯å®ç°ï¼ŒæŠ›å»äº† Kubernetes çš„æˆæœ¬å’Œå¤æ‚æ€§ã€‚å¯ä»¥åœ¨è¦æ±‚éå¸¸ä½çš„å•ä¸ªä¸»æœºä¸Šè¿è¡Œï¼Œä¸”å…·å¤‡å¿«é€Ÿã€æ˜“äºç®¡ç†çš„ç‰¹ç‚¹ã€‚å…¶åº•å±‚æ˜¯ç”± Containerd ã€å®¹å™¨ç½‘ç»œæ¥å£ ï¼ˆCNIï¼‰ ä»¥åŠæ¥è‡ª OpenFaaS é¡¹ç›®çš„æ ¸å¿ƒç»„ä»¶æ„æˆ</td></tr><tr><td>Docker Swarm Provider <a href="https://github.com/openfaas/faas-swarm">faas-swarm</a>)</td><td>é’ˆå¯¹ Docker Swarm çš„å®˜æ–¹ OpenFaaS Providerï¼Œç°å·²å¼ƒç”¨ä¸”ä¸å†ç»´æŠ¤</td></tr><tr><td>faas-memory Provider (<a href="https://github.com/openfaas-incubator/faas-memory">faas-memory</a>)</td><td>ä½¿ç”¨æœ¬åœ°ä»£ç å†…å­˜ç©ºé—´å­˜å‚¨çŠ¶æ€ï¼Œä»…ç”¨äºæµ‹è¯•ç›®çš„å’Œç®€å•ç¤ºä¾‹</td></tr><tr><td>ç¤¾åŒº Provider</td><td>å‚è€ƒå®ç°ï¼š<a href="https://github.com/openfaas/faas/blob/master/community.md#openfaas-providers">https://github.com/openfaas/faas/blob/master/community.md#openfaas-providers</a></td></tr></tbody></table><p><strong>faas-netes</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/OpenFaaS on Kubernetes Cluster.png"></div><p><strong>faasd</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/openfaas/OpenFaaS on Containerd.png"></div><h2 id="Log-Provider"><a href="#Log-Provider" class="headerlink" title="Log Provider"></a>Log Provider</h2><p>OpenFaaS æ”¯æŒé›†æˆè‡ªå®šä¹‰çš„ Log Providerã€‚</p><p>Log Provider æ˜¯ä¸€ä¸ª HTTP æœåŠ¡å™¨ï¼Œå¯¹å¤–æš´éœ² &#x2F;system&#x2F;logs endpointï¼Œè¯¥ endpoint æ”¯æŒå…·æœ‰ä»¥ä¸‹æŸ¥è¯¢å‚æ•°çš„ GET è¯·æ±‚ï¼š</p><ul><li>name - å‡½æ•°åç§°ï¼ˆå¿…éœ€ï¼‰</li><li>instance - å®¹å™¨åç§°ï¼ˆå¯é€‰ï¼‰ï¼Œå…è®¸ä»ç‰¹å®šå‡½æ•°å®ä¾‹ä¸­è¯·æ±‚æ—¥å¿—</li><li>since - æ—¥å¿—èµ·å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼‰</li><li>tail - æ—¥å¿—æ¶ˆæ¯è¿”å›çš„æœ€å¤§æ•°é‡ï¼Œ&lt;&#x3D;0 è¡¨ç¤ºæ— é™åˆ¶</li><li>follow - å…è®¸ç”¨æˆ·è¯·æ±‚æ—¥å¿—æµç›´è‡³è¶…æ—¶ï¼ˆå¯ç”¨æ—¶ï¼ŒæœåŠ¡å™¨å¿…é¡»ä½¿ç”¨ HTTP åˆ†å—ç¼–ç æ¥å‘é€æ—¥å¿—çš„å®æ—¶æµï¼‰</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenFaaS Gateway ä¼šå°†æ—¥å¿—è¯·æ±‚ä»£ç†åˆ°å‡½æ•° Providerã€‚å¯ä»¥åœ¨ OpenFaaS Gateway æœåŠ¡ä¸­è®¾ç½® logs_provider_url ç¯å¢ƒå˜é‡ï¼ŒOpenFaaS Gateway ä¼šå°†æ—¥å¿—è¯·æ±‚ä»£ç†åˆ°æ­¤ URLï¼Œå®ç° Log Provider æ›¿æ¢ã€‚</p><table><thead><tr><th>Log Provider</th><th>Overview</th></tr></thead><tbody><tr><td>Kubernetes Provider (<a href="https://github.com/openfaas/faas-netes">faas-netes</a>)</td><td>Kubernetes Provider å¹¶ä» Kubernetes API æŸ¥è¯¢æ—¥å¿—</td></tr><tr><td>faasd Provider (<a href="https://github.com/openfaas/faasd">faasd</a>)</td><td>ä» journal æœåŠ¡ä¸­æŸ¥è¯¢æ—¥å¿—ï¼ŒæŒ‰å‡½æ•°å’Œæ ¸å¿ƒæœåŠ¡å­˜å‚¨</td></tr><tr><td>Grafana Provider (<a href="https://github.com/LucasRoesler/openfaas-loki">openfaas-loki</a>)</td><td>ç¤¾åŒºæä¾›çš„ Log Providerï¼Œä½¿ç”¨ <a href="https://github.com/grafana/loki">Grafana Loki</a> æ¥æ”¶é›†å’ŒæŸ¥è¯¢åŠŸèƒ½æ—¥å¿—</td></tr><tr><td>è‡ªå®šä¹‰ Provider</td><td>å€ŸåŠ© <code>github.com/openfaas/faas-provider/logs</code> åŒ…æä¾›çš„å°è£…ï¼Œå¯ä»¥æ„å»ºè‡ªå®šä¹‰çš„ Log Provider HTTP æœåŠ¡ï¼Œå‚è€ƒç¤ºä¾‹ï¼š<a href="https://github.com/openfaas/faas-provider/tree/master/logs/example">https://github.com/openfaas/faas-provider/tree/master/logs/example</a></td></tr></tbody></table>]]></content>
    
    
    <summary type="html">OpenFaaS æ¶æ„è®¾è®¡ç†å¿µä¸ç»„ä»¶åŠŸèƒ½æ¦‚è¿°</summary>
    
    
    
    <category term="Serverless" scheme="http://shenxianghong.github.io/categories/Serverless/"/>
    
    
    <category term="OpenFaaS" scheme="http://shenxianghong.github.io/tags/OpenFaaS/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” virtcontainers/network</title>
    <link href="http://shenxianghong.github.io/2023/04/15/2023-04-15%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20network/"/>
    <id>http://shenxianghong.github.io/2023/04/15/2023-04-15%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20network/</id>
    <published>2023-04-14T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.272Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><h1 id="Endpoint"><a href="#Endpoint" class="headerlink" title="Endpoint"></a>Endpoint</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;endpoint.go</u></em></p><p>Endpoint ä»£è¡¨äº†æŸä¸€ä¸ªç‰©ç†æˆ–è™šæ‹Ÿç½‘ç»œè®¾å¤‡çš„åŸºç¡€ç»“æ„ï¼Œå…·ä½“åŒ…æ‹¬ï¼švethã€ipvlanã€macvlanã€macvtapã€physicalã€vhostuserã€tap å’Œ tuntap 8 ç§å®ç°æ–¹å¼ã€‚å€ŸåŠ© <code>github.com/vishvananda/netlink</code> å°†æŠ½è±¡ endpoint ç±»å‹è½¬å˜æˆå…·ä½“çš„ netlink ç±»å‹ï¼Œé…ç½®åå›å†™åˆ° endpoint çš„å…·ä½“å±æ€§ï¼ˆä¾‹å¦‚ netPair ç­‰ï¼‰åï¼Œäº¤ç”± hypervisor åˆ›å»ºæˆ–é…ç½®è¯¥è®¾å¤‡ä¿¡æ¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VethEndpoint gathers a network pair and its properties.</span></span><br><span class="line"><span class="keyword">type</span> VethEndpoint <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å›ºå®šä¸º virtual</span></span><br><span class="line">EndpointType EndpointType</span><br><span class="line"></span><br><span class="line"><span class="comment">// idx ä¸º VM ä¸­ endpoint è®¾å¤‡çš„é€’å¢åºå·</span></span><br><span class="line"><span class="comment">// NetPair.TapInterface.Name ä¸ºé€»è¾‘ç½‘æ¡¥åç§°ï¼Œå›ºå®šä¸º br&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// NetPair.TapInterface.TAPIface.Name ä¸º tap è®¾å¤‡åç§°ï¼Œå›ºå®šä¸º tap&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// NetPair.VirtIface.Name ä¸º endpoint è®¾å¤‡åç§°ï¼Œé»˜è®¤ä¸º eth&lt;idx&gt;</span></span><br><span class="line"><span class="comment">// NetPair.VirtIface.HardAddr ä¸ºéšæœºç”Ÿæˆçš„ MAC åœ°å€</span></span><br><span class="line"><span class="comment">// NetPair.NetInterworkingModel ä¸º [runtime].internetworking_modelï¼Œå¯é€‰æœ‰ macvtap å’Œ tcfilterï¼ˆé»˜è®¤ï¼‰</span></span><br><span class="line">NetPair NetworkInterfacePair</span><br><span class="line"></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡å±æ€§ä¿¡æ¯</span></span><br><span class="line">EndpointProperties NetworkInfo</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡ inbound/outbound é™é€Ÿæ ‡è¯†</span></span><br><span class="line">RxRateLimiter <span class="type">bool</span></span><br><span class="line">TxRateLimiter <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IPVlanEndpoint represents a ipvlan endpoint that is bridged to the VM</span></span><br><span class="line"><span class="keyword">type</span> IPVlanEndpoint <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å›ºå®šä¸º ipvlan</span></span><br><span class="line">EndpointType EndpointType</span><br><span class="line"></span><br><span class="line"><span class="comment">// idx ä¸º VM ä¸­ endpoint è®¾å¤‡çš„é€’å¢åºå·</span></span><br><span class="line"><span class="comment">// NetPair.TapInterface.Name ä¸ºé€»è¾‘ç½‘æ¡¥åç§°ï¼Œå›ºå®šä¸º br&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// NetPair.TapInterface.TAPIface.Name ä¸º tap è®¾å¤‡åç§°ï¼Œå›ºå®šä¸º tap&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// NetPair.VirtIface.Name ä¸º endpoint è®¾å¤‡åç§°ï¼Œé»˜è®¤ä¸º eth&lt;idx&gt;</span></span><br><span class="line"><span class="comment">// NetPair.VirtIface.HardAddr ä¸ºéšæœºç”Ÿæˆçš„ MAC åœ°å€</span></span><br><span class="line"><span class="comment">// NetPair.NetInterworkingModel ä¸º tcfilter</span></span><br><span class="line">NetPair NetworkInterfacePair</span><br><span class="line"></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡å±æ€§ä¿¡æ¯</span></span><br><span class="line">EndpointProperties NetworkInfo</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡ inbound/outbound é™é€Ÿæ ‡è¯†</span></span><br><span class="line">RxRateLimiter <span class="type">bool</span></span><br><span class="line">TxRateLimiter <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MacvlanEndpoint represents a macvlan endpoint that is bridged to the VM</span></span><br><span class="line"><span class="keyword">type</span> MacvlanEndpoint <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å›ºå®šä¸º macvlan</span></span><br><span class="line">EndpointType EndpointType</span><br><span class="line"></span><br><span class="line"><span class="comment">// idx ä¸º VM ä¸­ endpoint è®¾å¤‡çš„é€’å¢åºå·</span></span><br><span class="line"><span class="comment">// NetPair.TapInterface.Name ä¸ºé€»è¾‘ç½‘æ¡¥åç§°ï¼Œå›ºå®šä¸º br&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// NetPair.TapInterface.TAPIface.Name ä¸º tap è®¾å¤‡åç§°ï¼Œå›ºå®šä¸º tap&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// NetPair.VirtIface.Name ä¸º endpoint è®¾å¤‡åç§°ï¼Œé»˜è®¤ä¸º eth&lt;idx&gt;</span></span><br><span class="line"><span class="comment">// NetPair.VirtIface.HardAddr ä¸ºéšæœºç”Ÿæˆçš„ MAC åœ°å€</span></span><br><span class="line"><span class="comment">// NetPair.NetInterworkingModel ä¸º [runtime].internetworking_modelï¼Œå¯é€‰æœ‰ macvtap å’Œ tcfilterï¼ˆé»˜è®¤ï¼‰</span></span><br><span class="line">NetPair NetworkInterfacePair</span><br><span class="line"></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡å±æ€§ä¿¡æ¯</span></span><br><span class="line">EndpointProperties NetworkInfo</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡ inbound/outbound é™é€Ÿæ ‡è¯†</span></span><br><span class="line">RxRateLimiter <span class="type">bool</span></span><br><span class="line">TxRateLimiter <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MacvtapEndpoint represents a macvtap endpoint</span></span><br><span class="line"><span class="keyword">type</span> MacvtapEndpoint <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å›ºå®šä¸º macvtap</span></span><br><span class="line">EndpointType EndpointType</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…ƒç´ æ•°é‡ç­‰äº [hypervisor].default_vcpus çš„ /dev/tap&lt;EndpointProperties.Iface.Index&gt; æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">VMFds    []*os.File</span><br><span class="line"><span class="comment">// å…ƒç´ æ•°é‡ç­‰äº [hypervisor].default_vcpus çš„ /dev/vhost-net æ–‡ä»¶å¥æŸ„</span></span><br><span class="line">VhostFds []*os.File</span><br><span class="line"></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡å±æ€§ä¿¡æ¯</span></span><br><span class="line">    EndpointProperties NetworkInfo</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡ inbound/outbound é™é€Ÿæ ‡è¯†</span></span><br><span class="line">RxRateLimiter <span class="type">bool</span></span><br><span class="line">TxRateLimiter <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PhysicalEndpoint gathers a physical network interface and its properties</span></span><br><span class="line"><span class="keyword">type</span> PhysicalEndpoint <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å›ºå®šä¸º physical</span></span><br><span class="line">EndpointType EndpointType</span><br><span class="line">    </span><br><span class="line"><span class="comment">// æ ¹æ® IfaceName è§£æè·å¾—ï¼Œç±»æ¯”äº ethtool -i &lt;IfaceName&gt; ç»“æœä¸­çš„ bus-info</span></span><br><span class="line">BDF <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¯é“¾æ¥ /sys/bus/pci/devices/&lt;BDF&gt;/driver æŒ‡å‘å®ä½“æ–‡ä»¶è·¯å¾„çš„åŸºç¡€</span></span><br><span class="line">Driver <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”± /sys/bus/pci/devices/&lt;BDF&gt;/vendor å’Œ /sys/bus/pci/devices/&lt;BDF&gt;/device æ–‡ä»¶å†…å®¹æ‹¼æ¥è€Œæˆ</span></span><br><span class="line">VendorDeviceID <span class="type">string</span></span><br><span class="line"></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡å±æ€§ä¿¡æ¯</span></span><br><span class="line">IfaceName          <span class="type">string</span></span><br><span class="line">HardAddr           <span class="type">string</span></span><br><span class="line">    EndpointProperties NetworkInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VhostUserEndpoint represents a vhost-user socket based network interface</span></span><br><span class="line"><span class="keyword">type</span> VhostUserEndpoint <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å›ºå®šä¸º vhost-user</span></span><br><span class="line">EndpointType EndpointType</span><br><span class="line"></span><br><span class="line"><span class="comment">// Path to the vhost-user socket on the host system</span></span><br><span class="line"><span class="comment">// æ ¹æ® endpoint è®¾å¤‡çš„æ‰€æœ‰ IPï¼Œè·å¾—ä¸€ä¸ªå­˜åœ¨çš„ /tmp/vhostuser_&lt;IP&gt;/vhu.sock è·¯å¾„</span></span><br><span class="line">SocketPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡å±æ€§ä¿¡æ¯</span></span><br><span class="line">HardAddr           <span class="type">string</span></span><br><span class="line">IfaceName          <span class="type">string</span></span><br><span class="line">EndpointProperties NetworkInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TapEndpoint represents just a tap endpoint</span></span><br><span class="line"><span class="keyword">type</span> TapEndpoint <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å›ºå®šä¸º tap</span></span><br><span class="line">EndpointType EndpointType</span><br><span class="line">    </span><br><span class="line"><span class="comment">// TapInterface.Name ä¸º endpoint è®¾å¤‡åç§°ï¼Œé»˜è®¤ä¸º eth&lt;idx&gt;</span></span><br><span class="line"><span class="comment">// TapInterface.TAPIface.Name ä¸º tap è®¾å¤‡åç§°ï¼Œå›ºå®šä¸º tap&lt;idx&gt;_kata</span></span><br><span class="line">TapInterface TapInterface</span><br><span class="line"></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line">    </span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡å±æ€§ä¿¡æ¯</span></span><br><span class="line">EndpointProperties NetworkInfo</span><br><span class="line">    </span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡ inbound/outbound é™é€Ÿæ ‡è¯†</span></span><br><span class="line">RxRateLimiter <span class="type">bool</span></span><br><span class="line">TxRateLimiter <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TuntapEndpoint represents just a tap endpoint</span></span><br><span class="line"><span class="keyword">type</span> TuntapEndpoint <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å›ºå®šä¸º tuntap</span></span><br><span class="line">EndpointType EndpointType</span><br><span class="line"></span><br><span class="line"><span class="comment">// idx ä¸º VM ä¸­è®¾å¤‡çš„é€’å¢åºå·</span></span><br><span class="line"><span class="comment">// TuntapInterface.Name ä¸º endpoint è®¾å¤‡åç§°ï¼Œé»˜è®¤ä¸º eth&lt;idx&gt;</span></span><br><span class="line"><span class="comment">// TuntapInterface.TAPIface.Name ä¸º tap è®¾å¤‡åç§°ï¼Œå›ºå®šä¸º tap&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// TuntapInterface.TAPIface.HardAddr ä¸º tap è®¾å¤‡ MAC åœ°å€</span></span><br><span class="line">TuntapInterface TuntapInterface</span><br><span class="line"></span><br><span class="line"><span class="comment">// idx ä¸º VM ä¸­è®¾å¤‡çš„é€’å¢åºå·</span></span><br><span class="line"><span class="comment">// NetPair.TapInterface.Name ä¸ºé€»è¾‘ç½‘æ¡¥åç§°ï¼Œå›ºå®šä¸º br&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// NetPair.TapInterface.TAPIface.Name ä¸º tap è®¾å¤‡åç§°ï¼Œå›ºå®šä¸º tap&lt;idx&gt;_kata</span></span><br><span class="line"><span class="comment">// NetPair.VirtIface.Name ä¸º endpoint è®¾å¤‡åç§°ï¼Œé»˜è®¤ä¸º eth&lt;idx&gt;</span></span><br><span class="line"><span class="comment">// NetPair.VirtIface.HardAddr ä¸ºéšæœºç”Ÿæˆçš„ MAC åœ°å€</span></span><br><span class="line"><span class="comment">// NetPair.NetInterworkingModel ä¸º [runtime].internetworking_modelï¼Œå¯é€‰æœ‰ macvtap å’Œ tcfilterï¼ˆé»˜è®¤ï¼‰</span></span><br><span class="line">NetPair NetworkInterfacePair</span><br><span class="line"></span><br><span class="line">    PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡å±æ€§ä¿¡æ¯</span></span><br><span class="line">EndpointProperties NetworkInfo</span><br><span class="line">    </span><br><span class="line"><span class="comment">// endpoint è®¾å¤‡ inbound/outbound é™é€Ÿæ ‡è¯†</span></span><br><span class="line">RxRateLimiter <span class="type">bool</span></span><br><span class="line">TxRateLimiter <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NetworkInterfacePair defines a pair between VM and virtual network interfaces.</span></span><br><span class="line"><span class="keyword">type</span> NetworkInterfacePair <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å–å†³äºå…·ä½“ endpoint å®ç°ï¼Œå†…å®¹æœ‰æ‰€ä¸åŒ</span></span><br><span class="line">TapInterface</span><br><span class="line">VirtIface NetworkInterface</span><br><span class="line"></span><br><span class="line"><span class="comment">// [runtime].internetworking_modelï¼Œå¯é€‰çš„æœ‰ macvtap å’Œ tcfilterï¼ˆé»˜è®¤ï¼‰</span></span><br><span class="line">NetInterworkingModel</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NetworkInterfacePair å³ netpairï¼ˆä¾‹å¦‚ br0_kataï¼‰ï¼Œæè¿°äº† tap è®¾å¤‡ï¼ˆTapInterfaceï¼‰å’Œ veth è®¾å¤‡ï¼ˆVirtIfaceï¼Œå³ä½äºå®¹å™¨å‘½åç©ºé—´å†…éƒ¨çš„ veth-pair è®¾å¤‡ï¼Œå¦‚ eth0ï¼‰çš„æ•°æ®ç»“æ„ï¼ˆnetPair å¹¶éçœŸå®è®¾å¤‡ï¼Œè€Œæ˜¯ä¸€ä¸ªç”¨äºæè¿°å¦‚ä½•è¿é€šå®¹å™¨ç½‘ç»œå’Œ VM ç½‘ç»œçš„é€»è¾‘ç½‘æ¡¥ï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NetworkInfo gathers all information related to a network interface.</span></span><br><span class="line"><span class="comment">// It can be used to store the description of the underlying network.</span></span><br><span class="line"><span class="keyword">type</span> NetworkInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">Iface     NetlinkIface</span><br><span class="line">DNS       DNSInfo</span><br><span class="line">Link      netlink.Link</span><br><span class="line">Addrs     []netlink.Addr</span><br><span class="line">Routes    []netlink.Route</span><br><span class="line">Neighbors []netlink.Neigh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NetworkInfo æè¿° endpoint è®¾å¤‡çš„é€šç”¨å±æ€§ä¿¡æ¯ï¼Œé€šè¿‡ç›¸å…³ Golang ç³»ç»Ÿè°ƒç”¨åº“è·å¾—ã€‚</p><p>Endpoint ä¸­å£°æ˜çš„ <strong>Properties</strong>ã€<strong>Type</strong>ã€<strong>PciPath</strong>ã€<strong>SetProperties</strong>ã€<strong>SetPciPath</strong>ã€<strong>GetRxRateLimiter</strong>ã€<strong>SetRxRateLimiter</strong>ã€<strong>GetTxRateLimiter</strong> å’Œ <strong>GetTxRateLimiter</strong> å‡ä¸ºå‚æ•°è·å–ä¸èµ‹å€¼ï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸ä½œè¯¦è¿°ã€‚<br>å…¶ä¸­ï¼Œ<strong>Name</strong>ã€<strong>HardwareAddr</strong> å’Œ <strong>NetworkPair</strong> è§†ä¸åŒçš„ endpoint å®ç°ï¼Œå–å€¼å­—æ®µæœ‰æ‰€ä¸åŒï¼Œå…·ä½“ä¸ºï¼š</p><table><thead><tr><th>Endpoint</th><th>Name</th><th>HardwareAddr</th><th>NetworkPair</th></tr></thead><tbody><tr><td>VethEndpoint</td><td>NetPair.VirtIface.Name</td><td>NetPair.TAPIface.HardAddr</td><td>NetPair</td></tr><tr><td>IPVlanEndpoint</td><td>NetPair.VirtIface.Name</td><td>NetPair.TAPIface.HardAddr</td><td>NetPair</td></tr><tr><td>MacvlanEndpoint</td><td>NetPair.VirtIface.Name</td><td>NetPair.TAPIface.HardAddr</td><td>NetPair</td></tr><tr><td>MacvtapEndpoint</td><td>EndpointProperties.Iface.Name</td><td>EndpointProperties.Iface.HardwareAddr</td><td>â€”</td></tr><tr><td>PhysicalEndpoint</td><td>IfaceName</td><td>HardAddr</td><td>â€”</td></tr><tr><td>VhostUserEndpoint</td><td>IfaceName</td><td>HardAddr</td><td>â€”</td></tr><tr><td>TapEndpoint</td><td>TapInterface.Name</td><td>TapInterface.TAPIface.HardAddr</td><td>â€”</td></tr><tr><td>TuntapEndpoint</td><td>TuntapInterface.Name</td><td>TapInterface.TAPIface.HardAddr</td><td>NetPair</td></tr></tbody></table><h2 id="Attach"><a href="#Attach" class="headerlink" title="Attach"></a>Attach</h2><p><strong>æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</strong></p><h3 id="VethEndpointã€IPVlanEndpointã€MacvlanEndpointã€TuntapEndpoint"><a href="#VethEndpointã€IPVlanEndpointã€MacvlanEndpointã€TuntapEndpoint" class="headerlink" title="VethEndpointã€IPVlanEndpointã€MacvlanEndpointã€TuntapEndpoint"></a>VethEndpointã€IPVlanEndpointã€MacvlanEndpointã€TuntapEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/veth_endpoint.go#L99">source code</a></p><ol><li>è°ƒç”¨ network çš„ <strong>xConnectVMNetwork</strong>ï¼Œé…ç½®ç½‘ç»œä¿¡æ¯</li><li>è°ƒç”¨ hypervisor çš„ <strong>AddDevice</strong>ï¼Œä»¥ NetDev ç±»å‹æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</li></ol><h3 id="MacvtapEndpoint"><a href="#MacvtapEndpoint" class="headerlink" title="MacvtapEndpoint"></a>MacvtapEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/macvtap_endpoint.go#L68">source code</a></p><ol><li>åˆ›å»º &#x2F;dev&#x2F;tap&lt;endpoint.EndpointProperties.Iface.Index&gt;ï¼Œæ„å»º fdsï¼ˆ[]*os.Fileï¼Œå…ƒç´ ä¸ºæ•°é‡ç­‰äº [hypervisor].default_vcpus çš„ &#x2F;dev&#x2F;tap&lt;endpoint.EndpointProperties.Iface.Index&gt; æ–‡ä»¶å¥æŸ„ï¼‰ï¼Œå›å†™åˆ° endpoint.VMFds ä¸­</li><li>å¦‚æœ [hypervisor].disable_vhost_net æœªå¼€å¯ï¼Œåˆ™åˆ›å»º &#x2F;dev&#x2F;vhost-netï¼Œæ„å»º fdsï¼ˆ[]*os.Fileï¼Œå…ƒç´ ä¸ºæ•°é‡ç­‰äº [hypervisor].default_vcpus çš„ &#x2F;dev&#x2F;vhost-net æ–‡ä»¶å¥æŸ„ï¼‰ï¼Œå›å†™åˆ° endpoint.VhostFds ä¸­</li><li>è°ƒç”¨ hypervisor çš„ <strong>AddDevice</strong>ï¼Œä»¥ NetDev ç±»å‹æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</li></ol><h3 id="PhysicalEndpoint"><a href="#PhysicalEndpoint" class="headerlink" title="PhysicalEndpoint"></a>PhysicalEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/physical_endpoint.go#L82">source code</a></p><ol><li>å°† endpoint.BDF å†™å…¥ &#x2F;sys&#x2F;bus&#x2F;pci&#x2F;devices&#x2F;&lt;endpoint.BDF&gt;&#x2F;driver&#x2F;unbind æ–‡ä»¶ä¸­<br><em>ç”¨äºè§£é™¤è¯¥è®¾å¤‡åœ¨ host driver ä¸Šçš„ç»‘å®š</em></li><li>å°† endpoint.VendorDeviceID å†™å…¥ &#x2F;sys&#x2F;bus&#x2F;pci&#x2F;drivers&#x2F;vfio-pci&#x2F;new_id æ–‡ä»¶ä¸­ï¼›å¹¶å°† endpoint.BDF å†™å…¥ &#x2F;sys&#x2F;bus&#x2F;pci&#x2F;drivers&#x2F;vfio-pci&#x2F;bind æ–‡ä»¶ä¸­<br><em>ç”¨äºå°†è¯¥è®¾å¤‡ç»‘å®šåˆ° vfio-pci driver ä¸Šï¼Œåç»­ä»¥ vfio-passthrough ä¼ é€’ç»™ hypervisor</em></li><li>è·å– &#x2F;sys&#x2F;bus&#x2F;pci&#x2F;devices&#x2F;&lt;endpoint.BDF&gt;&#x2F;iommu_group è½¯é“¾æ¥çš„æŒ‡å‘è·¯å¾„ï¼Œå¾—åˆ°å…¶ base è·¯å¾„ï¼ˆå³è·¯å¾„æœ€åä¸€ä¸ªå…ƒç´ ï¼‰ï¼Œæ„å»º vfio è®¾å¤‡è·¯å¾„ï¼Œå³ &#x2F;dev&#x2F;vfio&#x2F;&lt;base&gt; </li><li>æ ¹æ® vfio è®¾å¤‡è·¯å¾„ï¼Œè·å–è®¾å¤‡ä¿¡æ¯ï¼Œæ„å»º DeviceInfoï¼Œå¹¶è°ƒç”¨ devManager çš„ <strong>NewDevice</strong>ï¼Œåˆå§‹åŒ– vfio ç±»å‹è®¾å¤‡</li><li>è°ƒç”¨ devManager çš„ <strong>AttachDevice</strong>ï¼Œå†·æ·»åŠ æ­¤è®¾å¤‡åˆ° VM ä¸­</li></ol><h3 id="VhostUserEndpoint"><a href="#VhostUserEndpoint" class="headerlink" title="VhostUserEndpoint"></a>VhostUserEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/vhostuser_endpoint.go#L84">source code</a></p><ol><li>è°ƒç”¨ hypervisor çš„ <strong>AddDevice</strong>ï¼Œä»¥ VhostuserDev ç±»å‹æ·»åŠ  virtio-net-pci è®¾å¤‡ï¼ˆsocketPathã€MacAddress ç­‰ä¿¡æ¯ä» endpoint ä¸­èµ‹å€¼ï¼‰åˆ° VM ä¸­</li></ol><h3 id="TapEndpoint"><a href="#TapEndpoint" class="headerlink" title="TapEndpoint"></a>TapEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/tap_endpoint.go#L76">source code</a></p><ol><li>æš‚ä¸æ”¯æŒæ·»åŠ æ­¤ç±»è®¾å¤‡ï¼Œè¿”å›é”™è¯¯</li></ol><h2 id="Detach"><a href="#Detach" class="headerlink" title="Detach"></a>Detach</h2><p><strong>ç§»é™¤ VM ä¸­çš„ endpoint è®¾å¤‡</strong></p><h3 id="VethEndpointã€IPVlanEndpointã€MacvlanEndpoint"><a href="#VethEndpointã€IPVlanEndpointã€MacvlanEndpoint" class="headerlink" title="VethEndpointã€IPVlanEndpointã€MacvlanEndpoint"></a>VethEndpointã€IPVlanEndpointã€MacvlanEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/veth_endpoint.go#L114">source code</a></p><ol><li>å¦‚æœ netns ä¸æ˜¯ç”± Kata Containers åˆ›å»ºçš„ï¼Œåˆ™ç›´æ¥è·³è¿‡åç»­<br><em>æ ¹æ®åˆ›å»º pod_sandbox æˆ–è€… single_container æ—¶ï¼Œspec.Linux.Namespace ä¸­çš„ network æ˜¯å¦æŒ‡å®šåˆ¤æ–­ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œè¡¨ç¤ºéœ€è¦ç”± Kata Containers åˆ›å»ºï¼Œåä¹‹è¡¨ç¤º netns å·²ç»æå‰åˆ›å»ºå¥½</em></li><li>è¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œè°ƒç”¨ network çš„ <strong>xDisconnectVMNetwork</strong>ï¼Œç§»é™¤ç½‘ç»œä¿¡æ¯</li></ol><h3 id="MacvtapEndpointã€VhostUserEndpoint"><a href="#MacvtapEndpointã€VhostUserEndpoint" class="headerlink" title="MacvtapEndpointã€VhostUserEndpoint"></a>MacvtapEndpointã€VhostUserEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/macvtap_endpoint.go#L92">source code</a></p><ol><li>æ— ä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›</li></ol><h3 id="PhysicalEndpoint-1"><a href="#PhysicalEndpoint-1" class="headerlink" title="PhysicalEndpoint"></a>PhysicalEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/physical_endpoint.go#L112">source code</a></p><ol><li>å°† endpoint.BDF å†™å…¥ &#x2F;sys&#x2F;bus&#x2F;pci&#x2F;devices&#x2F;&lt;endpoint.BDF&gt;&#x2F;driver&#x2F;unbind æ–‡ä»¶ä¸­<br><em>ç”¨äºè§£é™¤è¯¥è®¾å¤‡åœ¨ vfio-pci driver ä¸Šçš„ç»‘å®š</em></li><li>å°† endpoint.VendorDeviceID å†™å…¥ &#x2F;sys&#x2F;bus&#x2F;pci&#x2F;drivers&#x2F;vfio-pci&#x2F;remove_id æ–‡ä»¶ä¸­ï¼›å¹¶å°† endpoint.BDF å†™å…¥ &#x2F;sys&#x2F;bus&#x2F;pci&#x2F;drivers&#x2F;&lt;endpoint.Driver&gt;&#x2F;bind æ–‡ä»¶ä¸­<br><em>ç”¨äºå°†è¯¥è®¾å¤‡ç»‘å®šåˆ° host driver ä¸Š</em></li></ol><h3 id="TapEndpointã€TuntapEndpoint"><a href="#TapEndpointã€TuntapEndpoint" class="headerlink" title="TapEndpointã€TuntapEndpoint"></a>TapEndpointã€TuntapEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/tap_endpoint.go#L81">source code</a></p><ol><li>å¦‚æœ netns ä¸æ˜¯ç”± Kata Containers åˆ›å»ºçš„ï¼Œå¹¶ä¸” netns è·¯å¾„å­˜åœ¨ï¼Œåˆ™ç›´æ¥è·³è¿‡åç»­</li><li>è¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œè·å–åä¸º tap0_kataï¼ˆç¤ºä¾‹åç§°ï¼Œå…¶ä¸­ 0 ä¸ºé€’å¢ç”Ÿæˆçš„ç´¢å¼•ï¼‰çš„è®¾å¤‡ï¼Œå…³åœå¹¶ç§»é™¤</li></ol><h2 id="HotAttach"><a href="#HotAttach" class="headerlink" title="HotAttach"></a>HotAttach</h2><p><strong>çƒ­æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</strong></p><h3 id="VethEndpoint"><a href="#VethEndpoint" class="headerlink" title="VethEndpoint"></a>VethEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/veth_endpoint.go#L130">source code</a></p><ol><li>è°ƒç”¨ Network çš„ <strong>xConnectVMNetwork</strong>ï¼Œé…ç½®ç½‘ç»œä¿¡æ¯</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugAddDevice</strong>ï¼Œä»¥ NetDev ç±»å‹çƒ­æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</li></ol><h3 id="IPVlanEndpointã€MacvlanEndpointã€MacvtapEndpointã€PhysicalEndpointã€VhostUserEndpoint"><a href="#IPVlanEndpointã€MacvlanEndpointã€MacvtapEndpointã€PhysicalEndpointã€VhostUserEndpoint" class="headerlink" title="IPVlanEndpointã€MacvlanEndpointã€MacvtapEndpointã€PhysicalEndpointã€VhostUserEndpoint"></a>IPVlanEndpointã€MacvlanEndpointã€MacvtapEndpointã€PhysicalEndpointã€VhostUserEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/ipvlan_endpoint.go#L130">source code</a></p><ol><li>æš‚ä¸æ”¯æŒçƒ­æ·»åŠ æ­¤ç±»è®¾å¤‡ï¼Œè¿”å›é”™è¯¯</li></ol><h3 id="TapEndpoint-1"><a href="#TapEndpoint-1" class="headerlink" title="TapEndpoint"></a>TapEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/tap_endpoint.go#L96">source code</a></p><ol><li>åˆ›å»ºåä¸º tap0_kataï¼ˆç¤ºä¾‹åç§°ï¼Œå…¶ä¸­ 0 ä¸ºé€’å¢ç”Ÿæˆçš„ç´¢å¼•ï¼‰çš„ tuntap è®¾å¤‡ï¼ˆmode ä¸º tapï¼›é˜Ÿåˆ—é•¿åº¦å–è‡ª [hypervisor].default_vcpus æœ€å¤§ä¸º 1ï¼Œå³å¦‚æœé˜Ÿåˆ—é•¿åº¦å¤§äº 1ï¼Œä¸ºäº†é¿å…ä¸æ”¯æŒå¤šé˜Ÿåˆ—ï¼Œéœ€è¦é‡ç½®ä¸º 1ï¼Œå‚è€ƒ <a href="https://github.com/kata-containers/kata-containers/blob/e6e5d2593ac319329269d7b58c30f99ba7b2bf5a/src/runtime/vendor/github.com/vishvananda/netlink/link_linux.go#L1164-L1316">tuntap å®ç°</a>ï¼‰ï¼Œå¹¶è¿”å›ç©ºçš„ fdsï¼Œå›å†™åˆ° endpoint.TapInterface.VMFds ä¸­</li><li>å¦‚æœ [hypervisor].disable_vhost_net æœªå¼€å¯ï¼Œåˆ™åˆ›å»º &#x2F;dev&#x2F;vhost-netï¼Œæ„å»º fdsï¼ˆ[]*os.Fileï¼Œå…ƒç´ ä¸ºé˜Ÿåˆ—é•¿åº¦æ•°é‡çš„ &#x2F;dev&#x2F;vhost-net æ–‡ä»¶å¥æŸ„ï¼‰ï¼Œå›å†™åˆ° endpoint.TapInterface.VhostFds ä¸­</li><li>è®¾ç½® endpoint.TapInterface.TAPIface.HardAddr ä¸º veth è®¾å¤‡çš„ MAC åœ°å€<br><em>å°† veth MAC åœ°å€ä¿å­˜åˆ° tap ä¸­ï¼Œä»¥ä¾¿ç¨åç”¨äºæ„å»º hypervisor å‘½ä»¤è¡Œã€‚ æ­¤ MAC åœ°å€å¿…é¡»æ˜¯ VM å†…éƒ¨çš„åœ°å€ï¼Œä»¥é¿å…ä»»ä½•é˜²ç«å¢™é—®é¢˜ã€‚ host ä¸Šçš„ç½‘ç»œæ’ä»¶é¢„æœŸæµé‡æºè‡ªè¿™ä¸ª MAC åœ°å€</em></li><li>è®¾ç½® tuntap è®¾å¤‡çš„ mtu å€¼ä¸º veth è®¾å¤‡çš„ mtu å€¼</li><li>å¯ç”¨ tuntap è®¾å¤‡</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugAddDevice</strong>ï¼Œä»¥ NetDev ç±»å‹çƒ­æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</li></ol><h3 id="TuntapEndpoint"><a href="#TuntapEndpoint" class="headerlink" title="TuntapEndpoint"></a>TuntapEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/tuntap_endpoint.go#L107">source code</a></p><ol><li>åˆ›å»ºåä¸º tap0_kataï¼ˆç¤ºä¾‹åç§°ï¼Œå…¶ä¸­ 0 ä¸ºé€’å¢ç”Ÿæˆçš„ç´¢å¼•ï¼‰çš„ tuntap è®¾å¤‡ï¼ˆmode ä¸º tapï¼›é˜Ÿåˆ—é•¿åº¦å–è‡ª [hypervisor].default_vcpus æœ€å¤§ä¸º 1ï¼Œå³å¦‚æœé˜Ÿåˆ—é•¿åº¦å¤§äº 1ï¼Œä¸ºäº†é¿å…ä¸æ”¯æŒå¤šé˜Ÿåˆ—ï¼Œéœ€è¦é‡ç½®ä¸º 1ï¼Œå‚è€ƒ <a href="https://github.com/kata-containers/kata-containers/blob/e6e5d2593ac319329269d7b58c30f99ba7b2bf5a/src/runtime/vendor/github.com/vishvananda/netlink/link_linux.go#L1164-L1316">tuntap å®ç°</a>ï¼‰</li><li>è®¾ç½® endpoint.TuntapInterface.TAPIface.HardAddr ä¸º veth è®¾å¤‡çš„ MAC åœ°å€<br><em>å°† veth MAC åœ°å€ä¿å­˜åˆ° tap ä¸­ï¼Œä»¥ä¾¿ç¨åç”¨äºæ„å»º hypervisor å‘½ä»¤è¡Œã€‚ æ­¤ MAC åœ°å€å¿…é¡»æ˜¯ VM å†…éƒ¨çš„åœ°å€ï¼Œä»¥é¿å…ä»»ä½•é˜²ç«å¢™é—®é¢˜ã€‚ host ä¸Šçš„ç½‘ç»œæ’ä»¶é¢„æœŸæµé‡æºè‡ªè¿™ä¸ª MAC åœ°å€</em></li><li>è®¾ç½® tuntap è®¾å¤‡çš„ mtu å€¼ä¸º veth è®¾å¤‡çš„ mtu å€¼</li><li>å¯ç”¨ tuntap è®¾å¤‡</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugAddDevice</strong>ï¼Œä»¥ NetDev ç±»å‹çƒ­æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</li></ol><h2 id="HotDetach"><a href="#HotDetach" class="headerlink" title="HotDetach"></a>HotDetach</h2><p><strong>çƒ­ç§»é™¤ VM ä¸­çš„ endpoin è®¾å¤‡</strong></p><h3 id="VethEndpoint-1"><a href="#VethEndpoint-1" class="headerlink" title="VethEndpoint"></a>VethEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/veth_endpoint.go#L147">source code</a></p><ol><li>å¦‚æœ netns ä¸æ˜¯ç”± Kata Containers åˆ›å»ºçš„ï¼Œåˆ™ç›´æ¥è·³è¿‡åç»­<br><em>æ ¹æ®åˆ›å»º pod_sandbox æˆ–è€… single_container æ—¶ï¼Œspec.Linux.Namespace ä¸­çš„ network æ˜¯å¦æŒ‡å®šåˆ¤æ–­ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œè¡¨ç¤ºéœ€è¦ç”± Kata Containers åˆ›å»ºï¼Œåä¹‹è¡¨ç¤º netns å·²ç»æå‰åˆ›å»ºå¥½</em></li><li>è¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œè°ƒç”¨ <strong>xDisconnectVMNetwork</strong>ï¼Œç§»é™¤ç½‘ç»œä¿¡æ¯</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugRemoveDevice</strong>ï¼Œä»¥ NetDev çƒ­ç§»é™¤ endpoint ä¸­ VM çš„è®¾å¤‡</li></ol><h3 id="IPVlanEndpointã€MacvlanEndpointã€MacvtapEndpointã€PhysicalEndpointã€VhostUserEndpoint-1"><a href="#IPVlanEndpointã€MacvlanEndpointã€MacvtapEndpointã€PhysicalEndpointã€VhostUserEndpoint-1" class="headerlink" title="IPVlanEndpointã€MacvlanEndpointã€MacvtapEndpointã€PhysicalEndpointã€VhostUserEndpoint"></a>IPVlanEndpointã€MacvlanEndpointã€MacvtapEndpointã€PhysicalEndpointã€VhostUserEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/ipvlan_endpoint.go#L135">source code</a></p><ol><li>æš‚ä¸æ”¯æŒçƒ­ç§»é™¤æ­¤ç±»è®¾å¤‡ï¼Œè¿”å›é”™è¯¯</li></ol><h3 id="TapEndpointã€TuntapEndpoint-1"><a href="#TapEndpointã€TuntapEndpoint-1" class="headerlink" title="TapEndpointã€TuntapEndpoint"></a>TapEndpointã€TuntapEndpoint</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/tap_endpoint.go#L115">source code</a></p><ol><li>è¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œè·å–åä¸º tap0_kataï¼ˆç¤ºä¾‹åç§°ï¼Œå…¶ä¸­ 0 ä¸ºé€’å¢ç”Ÿæˆçš„ç´¢å¼•ï¼‰çš„è®¾å¤‡ï¼Œå…³åœå¹¶ç§»é™¤</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugRemoveDevice</strong>ï¼Œä»¥ NetDev çƒ­ç§»é™¤ VM ä¸­çš„ endpoint è®¾å¤‡</li></ol><h1 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;network.go</u></em></p><p>å®é™…æ“ä½œå‡å€ŸåŠ© <code>github.com/vishvananda</code> å®ç°ï¼Œè¯¥åº“æä¾›äº†ç­‰ä»·äº ip addrã€ip linkã€tc qdiscã€tc filter ç­‰å‘½ä»¤è¡Œçš„åŠŸèƒ½ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LinuxNetwork represents a sandbox networking setup.</span></span><br><span class="line"><span class="keyword">type</span> LinuxNetwork <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// OCI spec ä¸­ç±»å‹ä¸º network çš„ linux.namespace.path</span></span><br><span class="line">netNSPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// netns ä¸­çš„ endpoint è®¾å¤‡</span></span><br><span class="line">eps []Endpoint</span><br><span class="line"></span><br><span class="line"><span class="comment">// [runtime].internetworking_modelï¼Œå¯é€‰æœ‰ macvtap å’Œ tcfilterï¼ˆé»˜è®¤ï¼‰</span></span><br><span class="line">interworkingModel NetInterworkingModel</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰ netns æ˜¯å¦ä¸º Kata Containers åˆ›å»º</span></span><br><span class="line"><span class="comment">// - falseï¼šnetns ä¸ºäº‹å…ˆå‡†å¤‡å¥½ï¼Œåˆ›å»º Kata å®¹å™¨æ—¶ï¼Œåœ¨ OCI spec ä¸­ä¼ é€’è¯¥ netnsï¼ˆnetwork ç±»å‹çš„ linux.namespaceï¼‰ã€‚ä¾‹å¦‚ Kubernetes åœºæ™¯ä¸‹ï¼Œnetns ç”± CNI åˆ›å»º</span></span><br><span class="line"><span class="comment">// - trueï¼šKata Containers å‘ç° OCI spec ä¸­ä¸å­˜åœ¨ network ç±»å‹çš„ linux.namespaceï¼Œåˆ™ä¼šæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª netnsï¼ˆä»¥ cnitest å¼€å¤´ï¼‰ã€‚ä¾‹å¦‚ Containerd åœºæ™¯ä¸‹ï¼Œè¿è¡Œ single_container</span></span><br><span class="line">netNSCreated <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Network ä¸­å£°æ˜çš„ <strong>NetworkID</strong>ã€<strong>NetworkCreated</strong>ã€<strong>Endpoints</strong> å’Œ <strong>SetEndpoints</strong> å‡ä¸ºå‚æ•°è·å–ä¸èµ‹å€¼ï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸ä½œè¯¦è¿°ã€‚å…¶ä¸­ï¼Œ<strong>Run</strong> æ˜¯å°è£…äº†è¿›å…¥ netns ä¸­æ‰§è¡Œå›è°ƒå‡½æ•°çš„æµç¨‹ã€‚</p><h2 id="xConnectVMNetwork"><a href="#xConnectVMNetwork" class="headerlink" title="xConnectVMNetwork"></a>xConnectVMNetwork</h2><p><strong>æ ¹æ®ä¸åŒçš„ç½‘ç»œæ¨¡å‹ï¼Œæ‰“é€šå®¹å™¨å’Œ VM ä¹‹é—´çš„ç½‘ç»œ</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/network_linux.go#L518">source code</a></p><ol><li><p>è°ƒç”¨ endpoint çš„ <strong>NetworkPair</strong>ï¼Œè·å– netPair å¯¹è±¡çš„ç½‘ç»œæ¨¡å‹ï¼ˆå³[runtime].internetworking_modelï¼Œé»˜è®¤ä¸º tcfilterï¼‰</p></li><li><p>è°ƒç”¨ hypervisor çš„ <strong>Capabilities</strong>ï¼Œåˆ¤æ–­ hypervisor æ˜¯å¦æ”¯æŒå¤šé˜Ÿåˆ—ç‰¹æ€§ã€‚å¦‚æœæ”¯æŒï¼Œåˆ™é˜Ÿåˆ—æ•°è®¾ä¸º [hypervisor].default_vcpusï¼›å¦åˆ™ä¸º 0</p></li><li><p>æ ¹æ®ç½‘ç»œæ¨¡å‹ï¼Œåˆ›å»ºå¯¹åº”çš„ tap è®¾å¤‡ï¼Œè¿é€šå®¹å™¨å’Œ VM ä¹‹é—´çš„ç½‘ç»œ</p><p><em>æ— è®ºå“ªç§ç½‘ç»œæ¨¡å¼ï¼ŒVM ä¸­çš„ eth0 éƒ½æ˜¯ hypervisor åŸºäº tap è®¾å¤‡è™šæ‹ŸåŒ–å‡ºæ¥ï¼Œå¹¶ attach åˆ° VM ä¸­å»ºç«‹ä¸¤è€…çš„å…³è”å…³ç³»ã€‚åŒºåˆ«åœ¨äº tap è®¾å¤‡å’Œ veth è®¾å¤‡ï¼ˆå³ CNI ä¸ºå®¹å™¨å†…åˆ†é…çš„ eth0ï¼‰çš„ç½‘ç»œæ‰“é€šæ–¹å¼</em></p><ul><li><p>å¦‚æœç½‘ç»œæ¨¡å‹ä¸º macvtap</p><ol><li>è°ƒç”¨ endpoint çš„ <strong>NetworkPair</strong>ï¼Œè·å– netPair å¯¹è±¡ï¼Œå¹¶è¿›ä¸€æ­¥è·å– veth è®¾å¤‡</li><li>åˆ›å»º macvtap è®¾å¤‡ï¼Œå…¶ä¸­åç§°ä¸º tap0_kataï¼ˆç¤ºä¾‹åç§°ï¼Œå…¶ä¸­ 0 ä¸ºé€’å¢ç”Ÿæˆçš„ç´¢å¼•ï¼‰ã€txQLen å±æ€§ç»§æ‰¿è‡ª veth è®¾å¤‡ä¸” parentIndex æŒ‡å‘å®¹å™¨ eth0 è®¾å¤‡ï¼ˆä¸‹ç§° veth è®¾å¤‡ï¼‰<br><em>ç›®å‰ macvtap åœºæ™¯ä¸‹éœ€è¦ç‰¹æ®Šå¤„ç†ç´¢å¼•ï¼ˆè¯¥ç´¢å¼•åç»­ç”¨ä½œå‘½å &#x2F;dev&#x2F;tap&lt;idx&gt;ï¼‰ï¼Œæ˜¯ç”±äº Linux å†…æ ¸ä¸­å­˜åœ¨ä¸€ä¸ªé™åˆ¶ï¼Œä¼šå¯¼è‡´ macvtap&#x2F;macvlan link åœ¨ç½‘ç»œ namespace ä¸­åˆ›å»ºæ—¶æ— æ³•è·å¾—æ­£ç¡®çš„ link ç´¢å¼•<br><a href="https://github.com/clearcontainers/runtime/issues/708">https://github.com/clearcontainers/runtime/issues/708</a><br>åœ¨ä¿®å¤è¯¥é”™è¯¯ä¹‹å‰ï¼Œéœ€è¦éšæœºä¸€ä¸ªéå†²çªç´¢å¼•ï¼ˆå³ 8192 + éšæœºä¸€ä¸ªæ•°å­—ï¼‰å¹¶å°è¯•åˆ›å»ºä¸€ä¸ª linkã€‚ å¦‚æœå¤±è´¥ï¼Œåˆ™ç»§ç»­é‡è¯•ï¼Œä¸Šé™ä¸º 128 æ¬¡ã€‚æ‰€æœ‰å†…æ ¸éƒ½ä¸ä¼šæ£€æŸ¥é“¾æ¥ ID æ˜¯å¦ä¸ä¸»æœºä¸Šçš„ link ID å†²çªï¼Œå› æ­¤éœ€è¦åç§» link ID ä»¥é˜²æ­¢ä¸ä¸»æœºç´¢å¼•å‘ç”Ÿä»»ä½•é‡å ï¼Œå†…æ ¸å°†ç¡®ä¿æ²¡æœ‰ç«äº‰æ¡ä»¶</em></li><li>è®¾ç½® netPair.TAPIface.HardAddr ä¸º veth è®¾å¤‡çš„ MAC åœ°å€<br><em>å°† veth MAC åœ°å€ä¿å­˜åˆ° tap ä¸­ï¼Œä»¥ä¾¿ç¨åç”¨äºæ„å»º hypervisor å‘½ä»¤è¡Œã€‚ æ­¤ MAC åœ°å€å¿…é¡»æ˜¯ VM å†…éƒ¨çš„åœ°å€ï¼Œä»¥é¿å…ä»»ä½•é˜²ç«å¢™é—®é¢˜ã€‚ host ä¸Šçš„ç½‘ç»œæ’ä»¶é¢„æœŸæµé‡æºè‡ªè¿™ä¸ª MAC åœ°å€</em></li><li>è®¾ç½® macvtap è®¾å¤‡çš„ mtu å€¼ä¸º veth è®¾å¤‡çš„ mtu å€¼</li><li>è®¾ç½® veth è®¾å¤‡çš„ MAC åœ°å€ä¸ºéšæœºç”Ÿæˆçš„ MAC åœ°å€ï¼ˆå³ netPair.VirtIface.HardAddrï¼Œè¯¥å­—æ®µåˆå§‹åŒ–æ—¶ä¸ºéšæœºç”Ÿæˆçš„ MAC  åœ°å€ï¼‰ï¼Œå¹¶è®¾ç½® macvtap è®¾å¤‡çš„ MAC åœ°å€ä¸º veth è®¾å¤‡çš„ MAC åœ°å€</li><li>å¯ç”¨ macvtap è®¾å¤‡</li><li>è·å– veth è®¾å¤‡çš„å…¨éƒ¨ IP åœ°å€ï¼Œä¿å­˜è‡³ netPair.VirtIface.Addrsï¼Œå¹¶ä» veth è®¾å¤‡ä¸­ç§»é™¤è¿™äº› IP åœ°å€<br><em>æ¸…ç†æ‰ veth è®¾å¤‡ä¸­ç”± CNI åˆ†é…çš„ IP åœ°å€ï¼Œé¿å… ARP å†²çª</em></li><li>æ ¹æ®æ­¥éª¤ 2 ä¸­ç”Ÿæˆéšæœºç´¢å¼•ï¼Œåˆ›å»º &#x2F;dev&#x2F;tap&lt;idx&gt;ï¼Œæ„å»º fdsï¼ˆ[]*os.Fileï¼Œå…ƒç´ ä¸ºé˜Ÿåˆ—é•¿åº¦æ•°é‡çš„ &#x2F;dev&#x2F;tap&lt;idx&gt; æ–‡ä»¶å¥æŸ„ï¼‰ï¼Œå›å†™åˆ° netPair.VMFds ä¸­</li><li>å¦‚æœ [hypervisor].disable_vhost_net æœªå¼€å¯ï¼Œåˆ™åˆ›å»º &#x2F;dev&#x2F;vhost-netï¼Œæ„å»º fdsï¼ˆ[]*os.Fileï¼Œå…ƒç´ ä¸ºé˜Ÿåˆ—é•¿åº¦æ•°é‡çš„ &#x2F;dev&#x2F;vhost-net æ–‡ä»¶å¥æŸ„ï¼‰ï¼Œå›å†™åˆ° netPair.VhostFds ä¸­</li></ol><p>ç»¼ä¸Šæ‰€è¿°ï¼Œmacvtap ç½‘ç»œæ¨¡å¼ä¸‹ï¼Œæ˜¯å°† veth è®¾å¤‡å’Œ macvtap è®¾å¤‡çš„ mac åœ°å€ç­‰ä¿¡æ¯äº’æ¢ï¼Œå¹¶å°† veth è®¾å¤‡çš„ç½‘ç»œä¿¡æ¯è½¬ç§»åˆ° VM ä¸­ eth0 è®¾å¤‡ï¼ˆå®è´¨ä¸Šæ˜¯æ¸…ç† veth è®¾å¤‡ç½‘ç»œä¿¡æ¯ï¼ŒåŒæ—¶å€ŸåŠ© VM dhcp è·å– CNI åˆ†é…çš„ IP åœ°å€ï¼‰ï¼Œç»“åˆ macvtap è®¾å¤‡çš„ parentIndex æŒ‡å‘ veth è®¾å¤‡ï¼Œå®ç°å®¹å™¨ç½‘ç»œæµé‡å’Œ VM ç½‘ç»œæµé‡çš„äº’é€šã€‚</p></li><li><p>å¦‚æœç½‘ç»œæ¨¡å‹ä¸º tcfilter</p><ol><li>è°ƒç”¨ endpoint çš„ <strong>NetworkPair</strong>ï¼Œè·å– netPair å¯¹è±¡ï¼Œå¹¶è¿›ä¸€æ­¥è·å– veth è®¾å¤‡</li><li>åˆ›å»ºåä¸º tap0_kataï¼ˆç¤ºä¾‹åç§°ï¼Œå…¶ä¸­ 0 ä¸ºé€’å¢ç”Ÿæˆçš„ç´¢å¼•ï¼‰çš„ tuntap è®¾å¤‡ï¼ˆmode ä¸º tapï¼›é˜Ÿåˆ—é•¿åº¦æœ€å¤§ä¸º 1ï¼Œå³å¦‚æœé˜Ÿåˆ—é•¿åº¦å¤§äº 1ï¼Œä¸ºäº†é¿å…ä¸æ”¯æŒå¤šé˜Ÿåˆ—ï¼Œéœ€è¦é‡ç½®ä¸º 1ï¼Œå‚è€ƒ <a href="https://github.com/kata-containers/kata-containers/blob/e6e5d2593ac319329269d7b58c30f99ba7b2bf5a/src/runtime/vendor/github.com/vishvananda/netlink/link_linux.go#L1164-L1316">tuntap å®ç°</a>ï¼‰ï¼Œå¹¶è¿”å›ç©ºçš„ fdsï¼Œå›å†™åˆ° netPair.VMFds ä¸­</li><li>å¦‚æœ [hypervisor].disable_vhost_net æœªå¼€å¯ï¼Œåˆ™åˆ›å»º &#x2F;dev&#x2F;vhost-netï¼Œæ„å»º fdsï¼ˆ[]*os.Fileï¼Œå…ƒç´ ä¸ºé˜Ÿåˆ—é•¿åº¦æ•°é‡çš„ &#x2F;dev&#x2F;vhost-net æ–‡ä»¶å¥æŸ„ï¼‰ï¼Œå›å†™åˆ° netPair.VhostFds ä¸­</li><li>è®¾ç½® netPair.TAPIface.HardAddr ä¸º veth è®¾å¤‡çš„ MAC åœ°å€<br><em>å°† veth MAC åœ°å€ä¿å­˜åˆ° tap ä¸­ï¼Œä»¥ä¾¿ç¨åç”¨äºæ„å»º hypervisor å‘½ä»¤è¡Œã€‚ æ­¤ MAC åœ°å€å¿…é¡»æ˜¯ VM å†…éƒ¨çš„åœ°å€ï¼Œä»¥é¿å…ä»»ä½•é˜²ç«å¢™é—®é¢˜ã€‚ host ä¸Šçš„ç½‘ç»œæ’ä»¶é¢„æœŸæµé‡æºè‡ªè¿™ä¸ª MAC åœ°å€</em></li><li>è®¾ç½® tuntap è®¾å¤‡çš„ mtu å€¼ä¸º veth è®¾å¤‡çš„ mtu å€¼</li><li>å¯ç”¨ tuntap è®¾å¤‡</li><li>ä¸º tuntap è®¾å¤‡å’Œ veth è®¾å¤‡åˆ†åˆ«åˆ›å»º ingress ç±»å‹çš„ç½‘ç»œé˜Ÿåˆ—è§„åˆ™ä¸ tc è§„åˆ™ï¼Œå°†ä¸€æ–¹çš„å…¥ç«™æµé‡é‡å®šå‘åˆ°å¦ä¸€æ–¹è¿›è¡Œå‡ºç«™å¤„ç†ï¼Œä½¿å¾—æ‰€æœ‰æµé‡åœ¨ä¸¤è€…ä¹‹é—´å¯ä»¥è¢«é‡å®šå‘</li></ol><p>ç»¼ä¸Šæ‰€è¿°ï¼Œtcfilter ç½‘ç»œæ¨¡å¼ä¸‹ï¼Œä»…ä»…æ˜¯åœ¨ veth å’Œ tap è®¾å¤‡ä¹‹é—´é…ç½® tc è§„åˆ™ï¼Œå®ç°å®¹å™¨ç½‘ç»œæµé‡å’Œ VM ç½‘ç»œæµé‡çš„äº’é€šã€‚</p></li></ul><p><em><strong>æ•ˆæœç¤ºä¾‹</strong></em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç½‘ç»œæ¨¡å‹ä¸º macvtap æ—¶</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-97333755-9052-db96-37fe-37d4e39bf046 ethtool -i tap0_kata</span></span><br><span class="line">driver: macvlan</span><br><span class="line">version: 0.1</span><br><span class="line">firmware-version: </span><br><span class="line">expansion-rom-version: </span><br><span class="line">bus-info: </span><br><span class="line">supports-statistics: no</span><br><span class="line">supports-test: no</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: no</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-fb0bd424-5621-3672-62d9-9233708dc54d ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">4: eth0@if18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1430 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 46:ba:a7:d6:85:ec brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">55446: tap0_kata@eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1430 qdisc fq_codel state UP group default qlen 1500</span><br><span class="line">    link/ether c6:f1:06:ac:46:53 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::c4f1:6ff:feac:4653/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime <span class="built_in">exec</span> 7af17cb96ddaa59a4e370c0de584ea6df5759278ce6c203a188a3ab18b461216</span> </span><br><span class="line">root@localhost:/# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1430 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether c6:f1:06:ac:46:53 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.244.69.173/32 brd 10.244.69.173 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::c4f1:6ff:feac:4653/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç½‘ç»œæ¨¡å‹ä¸º tcfilter æ—¶</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-d7e932c4-51a6-53e0-e73c-662aa84b4653 ethtool -i tap0_kata</span></span><br><span class="line">driver: tun</span><br><span class="line">version: 1.6</span><br><span class="line">firmware-version: </span><br><span class="line">expansion-rom-version: </span><br><span class="line">bus-info: tap</span><br><span class="line">supports-statistics: no</span><br><span class="line">supports-test: no</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: no</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-d7e932c4-51a6-53e0-e73c-662aa84b4653 ip a</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">4: eth0@if17: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1430 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether 1e:03:66:df:ad:5e brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 10.244.69.163/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::1c03:66ff:fedf:ad5e/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: tap0_kata: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1430 qdisc mq state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether ee:b0:99:52:54:ef brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::ecb0:99ff:fe52:54ef/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime <span class="built_in">exec</span> 8a390592512f2f27a35accd0fa5c2c82d29dea2f3d1eb982c6225be7856e78a6</span> </span><br><span class="line">root@localhost:/# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1430 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 1e:03:66:df:ad:5e brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.244.69.163/32 brd 10.244.69.163 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::1c03:66ff:fedf:ad5e/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li></ol><h2 id="xDisconnectVMNetwork"><a href="#xDisconnectVMNetwork" class="headerlink" title="xDisconnectVMNetwork"></a>xDisconnectVMNetwork</h2><p><strong>æ ¹æ®ä¸åŒçš„ç½‘ç»œæ¨¡å‹ï¼Œç§»é™¤å®¹å™¨å’Œ VM ä¹‹é—´çš„ç½‘ç»œé…ç½®</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/network_linux.go#L552">source code</a></p><ol><li>è°ƒç”¨ endpoint çš„ <strong>NetworkPair</strong>ï¼Œè·å– netPair å¯¹è±¡çš„ç½‘ç»œæ¨¡å‹ï¼ˆå³[runtime].internetworking_modelï¼Œé»˜è®¤ä¸º tcfilterï¼‰</li><li>æ ¹æ®ç½‘ç»œæ¨¡å‹ï¼Œç§»é™¤å¯¹åº”çš„ tap è®¾å¤‡<ul><li>å¦‚æœç½‘ç»œæ¨¡å‹ä¸º macvtap<ol><li>è°ƒç”¨ endpoint çš„ <strong>NetworkPair</strong>ï¼Œè·å– netPair å¯¹è±¡ï¼Œå¹¶è¿›ä¸€æ­¥è·å– macvtap è®¾å¤‡ä¸ veth è®¾å¤‡</li><li>ç§»é™¤ macvtap è®¾å¤‡</li><li>å°† veth è®¾å¤‡çš„ MAC åœ°å€è¿˜åŸï¼ˆåœ¨ <strong>xConnextVMNetwork</strong> æµç¨‹ä¸­ä¿å­˜åœ¨ netPair.TAPIface.HardAddrï¼‰</li><li>å…³åœ veth è®¾å¤‡</li><li>å°† veth è®¾å¤‡çš„ IP åœ°å€è¿˜åŸï¼ˆåœ¨ <strong>xConnextVMNetwork</strong> æµç¨‹ä¸­ä¿å­˜åœ¨ netPair.VirtIface.Addrsï¼‰</li></ol></li><li>å¦‚æœç½‘ç»œæ¨¡å‹ä¸º tcfilter<ol><li>è°ƒç”¨ endpoint çš„ <strong>NetworkPair</strong>ï¼Œè·å– netPair å¯¹è±¡ï¼Œå¹¶è¿›ä¸€æ­¥è·å– tuntap è®¾å¤‡ä¸ veth è®¾å¤‡</li><li>å…³åœ tuntap è®¾å¤‡ï¼Œå¹¶ç§»é™¤</li><li>åˆ é™¤ veth è®¾å¤‡æ‰€æœ‰çš„ tc è§„åˆ™ä¸ ingress ç±»å‹çš„ç½‘ç»œé˜Ÿåˆ—è§„åˆ™</li><li>å…³åœ veth è®¾å¤‡</li></ol></li></ul></li></ol><h2 id="addSingleEndpoint"><a href="#addSingleEndpoint" class="headerlink" title="addSingleEndpoint"></a>addSingleEndpoint</h2><p><strong>æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/network_linux.go#L110">source code</a></p><ol><li><p>æ ¹æ®ç½‘å£çš„ç±»å‹ï¼Œåˆå§‹åŒ–å¯¹åº”çš„ endpoint<br><em>ç‰©ç†è®¾å¤‡æ˜¯æ ¹æ® ethtools è·å–æŒ‡å®šç½‘å£åç§°çš„ bus ä¿¡æ¯åˆ¤æ–­ï¼Œå¦‚æœ bus æ ¼å¼ä¸º 0000:00:03.0ï¼ˆå³ä»¥å†’å·åˆ‡åˆ†åé•¿åº¦ä¸º 3ï¼‰ï¼Œåˆ™è¡¨ç¤ºä¸ºç‰©ç†è®¾å¤‡ï¼›<br>vhost-user è®¾å¤‡æ˜¯æ ¹æ® &#x2F;tmp&#x2F;vhostuser_&lt;addr&gt;&#x2F;vhu.sockï¼ˆå…¶ä¸­ addr ä¸ºç½‘å¡çš„æ¯ä¸€ä¸ªåœ°å€ï¼‰æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è¡¨ç¤ºä¸º vhost-user è®¾å¤‡ï¼›<br>tuntap è®¾å¤‡ä»…æ”¯æŒ tap mode</em></p></li><li><p>è°ƒç”¨ endpoint çš„ <strong>SetProperties</strong>ï¼Œè®¾ç½® endpoint å±æ€§ä¿¡æ¯</p></li><li><p>æ ¹æ®æ˜¯å¦ä¸º hotplugï¼Œåˆ™è°ƒç”¨ endpoint çš„ <strong>HotAttach</strong> æˆ– <strong>Attach</strong>ï¼Œçƒ­ï¼ˆæ·»åŠ ï¼‰endpoint è®¾å¤‡åˆ° VM ä¸­</p></li><li><p>è°ƒç”¨ hypervisor çš„ <strong>IsRateLimiterBuiltin</strong>ï¼Œåˆ¤æ–­æ˜¯å¦å†…ç½®æ”¯æŒé™é€Ÿç‰¹æ€§ã€‚å¦‚æœæœ¬èº«ä¸æ”¯æŒé™é€Ÿï¼ˆä¾‹å¦‚ QEMUï¼‰ï¼Œåˆ™éœ€è¦é¢å¤–é…ç½®ï¼š</p><ul><li><p>ç½‘ç»œ I&#x2F;O inbound å¸¦å®½é™é€Ÿï¼ˆå³ [hypervisor].rx_rate_limiter_max_rate å¤§äº 0ï¼‰</p><p><em>vethã€ipvlanã€tuntap å’Œ macvlan ç±»å‹çš„ endpointï¼Œå¾…é™é€Ÿè®¾å¤‡ä¸º endpoint.NetPair çš„ tap è®¾å¤‡ï¼›<br>macvtap å’Œ tap ç±»å‹çš„ endpointï¼Œå¾…é™é€Ÿè®¾å¤‡ä¸ºå…¶æœ¬èº«ï¼Œå³ endpoint.Name()</em></p><ol><li><p>è°ƒç”¨ endpoint çš„ <strong>SetRxRateLimiter</strong>ï¼Œè®¾ç½® inbound é™é€Ÿæ ‡è¯†</p></li><li><p>è·å–å¾…é™é€Ÿè®¾å¤‡çš„ç´¢å¼•ï¼Œä½¿ç”¨ HTBï¼ˆHierarchical Token Bucketï¼‰qdisc traffic shaping æ–¹æ¡ˆæ¥æ§åˆ¶ç½‘å£æµé‡ï¼Œè®¾ç½® class çš„ rate å’Œ ceil å‡ä¸º [hypervisor].rx_rate_limiter_max_rate<br><em>class 1:2 æ˜¯åŸºäº class 1:1 åˆ›å»ºï¼Œä¸¤è€…çš„ rate å’Œ ceil æµæ§æŒ‡æ ‡ä¿æŒä¸€è‡´ï¼Œclass 1:2 æœ€ç»ˆä½œä¸ºé»˜è®¤çš„ classï¼Œclass 1:n ç”¨äºé™åˆ¶ç‰¹å®šæµé‡ï¼ˆæˆªè‡³ Kata 3.0ï¼Œæš‚æœªå®ç°ï¼‰<br>ä¹‹æ‰€ä»¥åˆ›å»ºäº† class 1:2 ä½œä¸ºé»˜è®¤çš„ classï¼Œæ˜¯ä¸€ç§å¸¸è§„åšæ³•ï¼Œä¸€èˆ¬ class 1:1 æ‰¿æ‹…é™åˆ¶æ•´ä½“çš„æœ€å¤§é€Ÿç‡ï¼Œclass 1:2 ç”¨äºæ§åˆ¶éç‰¹æƒæµé‡ã€‚å¦‚æœç»Ÿä¸€ç”± class 1:1 è´Ÿè´£ï¼Œå¯èƒ½ä¼šå¯¼è‡´éç‰¹æƒæµé‡æ— æ³•å¾—åˆ°é€‚å½“çš„æ§åˆ¶å’Œä¼˜å…ˆçº§ç®¡ç†ã€‚æ²¡æœ‰ä¸“é—¨çš„å­ç±»åˆ«æ¥å®šä¹‰è§„åˆ™å’Œé™åˆ¶éç‰¹æƒæµé‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´è¿™äº›æµé‡å ç”¨è¿‡å¤šçš„å¸¦å®½ï¼Œä»è€Œå½±å“ç½‘ç»œçš„æ€§èƒ½å’ŒæœåŠ¡è´¨é‡ï¼›éš¾ä»¥çµæ´»åœ°è°ƒæ•´é™åˆ¶ç­–ç•¥ã€‚å¦‚æœéœ€è¦æ ¹æ®å…·ä½“æƒ…å†µå¯¹éç‰¹æƒæµé‡è¿›è¡Œä¸åŒçš„é™åˆ¶å’Œä¼˜å…ˆçº§åˆ†é…ï¼Œä½¿ç”¨å•ä¸€çš„1:1ç±»åˆ«ä¼šæ˜¾å¾—ä¸å¤Ÿçµæ´»ã€‚è€Œæœ‰ä¸€ä¸ªä¸“é—¨çš„å­ç±»åˆ«ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å®šä¹‰æ›´å…·ä½“çš„è§„åˆ™å’Œç­–ç•¥ï¼Œæ›´å¥½åœ°æ§åˆ¶éç‰¹æƒæµé‡ã€‚æ‰€ä»¥ï¼Œé€šè¿‡è®¾ç½®ä¸“é—¨çš„ class 1:2ï¼Œå¯ä»¥æ›´å¥½åœ°ç»„ç»‡å’Œç®¡ç†æµé‡ï¼Œç¡®ä¿ç½‘ç»œçš„èµ„æºåˆ†é…å’Œæ€§èƒ½æ»¡è¶³ç‰¹å®šçš„éœ€æ±‚å’Œä¼˜å…ˆçº§</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----+     +---------+     +-----------+      +-----------+</span><br><span class="line">|     |     |  qdisc  |     | class 1:1 |      | class 1:2 |</span><br><span class="line">| NIC |     |   htb   |     |   rate    |      |   rate    |</span><br><span class="line">|     | --&gt; | def 1:2 | --&gt; |   ceil    | -+-&gt; |   ceil    |</span><br><span class="line">+-----+     +---------+     +-----------+  |   +-----------+</span><br><span class="line">                                           |</span><br><span class="line">                                           |   +-----------+</span><br><span class="line">                                           |   | class 1:n |</span><br><span class="line">                                           |   |   rate    |</span><br><span class="line">                                           +-&gt; |   ceil    |</span><br><span class="line">                                           |   +-----------+</span><br></pre></td></tr></table></figure></li></ol></li><li><p>ç½‘ç»œ I&#x2F;O outbound å¸¦å®½é™é€Ÿï¼ˆå³ [hypervisor].tx_rate_limiter_max_rate å¤§äº 0ï¼‰</p><p><em>vethã€ipvlanã€tuntap å’Œ macvlan ç±»å‹çš„ endpoint ä¸”å½“ç½‘ç»œæ¨¡å‹ä¸º tcfilter æ—¶ï¼Œå¾…é™é€Ÿè®¾å¤‡ä¸º endpoint.NetPair çš„ veth è®¾å¤‡ï¼Œå½“ç½‘ç»œæ¨¡å‹ä¸º macvtap æˆ– none æ—¶ï¼Œå¾…é™é€Ÿè®¾å¤‡ä¸º endpoint.NetPair çš„ tap è®¾å¤‡ï¼›<br>macvtap å’Œ tap ç±»å‹çš„ endpointï¼Œå¾…é™é€Ÿè®¾å¤‡ä¸ºè®¾å¤‡æœ¬èº«ï¼Œå³ endpoint.Name()</em></p><ol><li>å¯¹äº vethã€ipvlanã€tuntap å’Œ macvlan ç±»å‹çš„ endpoint ä¸”å½“ç½‘ç»œæ¨¡å‹ä¸º tcfilter æ—¶ï¼Œåˆ™è·å– endpoint.NetPair ä¸­ veth è®¾å¤‡çš„ç´¢å¼•ï¼ŒåŒæ ·çš„ä½¿ç”¨ HTBï¼ˆHierarchical Token Bucketï¼‰qdisc traffic shaping æ–¹æ¡ˆæ¥æ§åˆ¶ veth ç½‘å£æµé‡ï¼Œè®¾ç½® class çš„ rate å’Œ ceil å‡ä¸º [hypervisor].tx_rate_limiter_max_rate<br><em>å¯¹äº tcfilterï¼Œåªéœ€å°† htb qdisc åº”ç”¨äº veth pairã€‚ å¯¹äºå…¶ä»–ç½‘ç»œæ¨¡å‹ï¼Œä¾‹å¦‚ macvtapï¼Œå€ŸåŠ© ifbï¼Œé€šè¿‡å°† endpoint è®¾å¤‡å…¥å£æµé‡é‡å®šå‘åˆ° ifb å‡ºå£ï¼Œç„¶åå°† htb åº”ç”¨äº ifb å‡ºå£ï¼Œå®ç°é™é€Ÿ</em></li><li>å…¶ä»–åœºæ™¯æ—¶ï¼Œè°ƒç”¨ endpoint çš„ <strong>SetTxRateLimiter</strong>ï¼Œè®¾ç½® outbound é™é€Ÿæ ‡è¯†</li><li>å°è¯•åŠ è½½ host çš„ ifb æ¨¡å—ï¼Œåˆ›å»ºåä¸º ifb0 çš„ ifb è®¾å¤‡å¹¶å¯ç”¨ï¼Œè¿”å› ifb è®¾å¤‡ç´¢å¼•å·</li><li>ä¸ºå¾…é™é€Ÿçš„è®¾å¤‡åˆ›å»º ingress ç±»å‹çš„ç½‘ç»œé˜Ÿåˆ—è§„åˆ™</li><li>ä¸ºå¾…é™é€Ÿè®¾å¤‡æ·»åŠ è¿‡æ»¤å™¨è§„åˆ™ï¼Œå°†å…¶å…¥ç«™æµé‡é‡å®šå‘åˆ° ifb è®¾å¤‡è¿›è¡Œå‡ºç«™å¤„ç†</li><li>ä½¿ç”¨ HTBï¼ˆHierarchical Token Bucketï¼‰qdisc traffic shaping æ–¹æ¡ˆæ¥æ§åˆ¶ ifb ç½‘å£æµé‡ï¼Œè®¾ç½® class çš„ rate å’Œ ceil å‡ä¸º [hypervisor].tx_rate_limiter_max_rate</li></ol></li></ul><p><em><strong>é™é€Ÿç¤ºä¾‹ï¼ˆveth endpointï¼‰</strong></em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">inbound é™é€Ÿä¸º 1024ï¼Œoutbound é™é€Ÿä¸º 2048</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> /etc/kata-containers/configuration.toml | grep rate_limiter_max_rate</span></span><br><span class="line">rx_rate_limiter_max_rate = 1024</span><br><span class="line">tx_rate_limiter_max_rate = 2048</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç½‘ç»œæ¨¡å‹ä¸º macvtap æ—¶</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-593e147b-3839-2615-f57f-39dc53181ef5 tc qdisc show</span></span><br><span class="line">qdisc noqueue 0: dev lo root refcnt 2 </span><br><span class="line">qdisc noqueue 0: dev eth0 root refcnt 2 </span><br><span class="line">qdisc htb 1: dev tap0_kata root refcnt 2 r2q 10 default 2 direct_packets_stat 0 direct_qlen 1500</span><br><span class="line">qdisc ingress ffff: dev tap0_kata parent ffff:fff1 ---------------- </span><br><span class="line">qdisc htb 1: dev ifb0 root refcnt 2 r2q 10 default 2 direct_packets_stat 0 direct_qlen 32</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># inbound é™é€Ÿä½œç”¨åœ¨ tap0_kata è®¾å¤‡ä¸Š</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-593e147b-3839-2615-f57f-39dc53181ef5 tc class show dev tap0_kata</span></span><br><span class="line">class htb 1:1 root rate 1024bit ceil 1024bit burst 1600b cburst 1600b </span><br><span class="line">class htb 1:2 parent 1:1 prio 0 rate 1024bit ceil 1024bit burst 1600b cburst 1600b </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># outbound é™é€Ÿä½œç”¨åœ¨ ifb0 è®¾å¤‡ä¸Š</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-593e147b-3839-2615-f57f-39dc53181ef5 tc class show dev eth0</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-593e147b-3839-2615-f57f-39dc53181ef5 tc class show dev ifb0</span></span><br><span class="line">class htb 1:1 root rate 2048bit ceil 2048bit burst 1600b cburst 1600b </span><br><span class="line">class htb 1:2 parent 1:1 prio 0 rate 2048bit ceil 2048bit burst 1600b cburst 1600b</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç½‘ç»œæ¨¡å‹ä¸º tcfilter æ—¶</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-58d2c6b0-b9e5-797d-4c9f-291769802ac1 tc qdisc show</span></span><br><span class="line">qdisc noqueue 0: dev lo root refcnt 2 </span><br><span class="line">qdisc htb 1: dev eth0 root refcnt 2 r2q 10 default 2 direct_packets_stat 0 direct_qlen 1000</span><br><span class="line">qdisc ingress ffff: dev eth0 parent ffff:fff1 ---------------- </span><br><span class="line">qdisc htb 1: dev tap0_kata root refcnt 257 r2q 10 default 2 direct_packets_stat 0 direct_qlen 1000</span><br><span class="line">qdisc ingress ffff: dev tap0_kata parent ffff:fff1 ---------------- </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># inbound é™é€Ÿä½œç”¨åœ¨ tap0_kata è®¾å¤‡ä¸Š</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-58d2c6b0-b9e5-797d-4c9f-291769802ac1 tc class show dev tap0_kata</span></span><br><span class="line">class htb 1:1 root rate 1024bit ceil 1024bit burst 1600b cburst 1600b </span><br><span class="line">class htb 1:2 parent 1:1 prio 0 rate 1024bit ceil 1024bit burst 1600b cburst 1600b </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># outbound é™é€Ÿä½œç”¨åœ¨å®¹å™¨ veth pair çš„ eth0 è®¾å¤‡ä¸Š</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ip netns <span class="built_in">exec</span> cni-58d2c6b0-b9e5-797d-4c9f-291769802ac1 tc class show dev eth0</span></span><br><span class="line">class htb 1:1 root rate 2048bit ceil 2048bit burst 1600b cburst 1600b </span><br><span class="line">class htb 1:2 parent 1:1 prio 0 rate 2048bit ceil 2048bit burst 1600b cburst 1600b</span><br></pre></td></tr></table></figure></li></ol><h2 id="AddEndpoints"><a href="#AddEndpoints" class="headerlink" title="AddEndpoints"></a>AddEndpoints</h2><p><strong>æ·»åŠ  endpoint è®¾å¤‡åˆ° VM ä¸­</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/network_linux.go#L324">source code</a></p><ol><li>å¦‚æœæœªæŒ‡å®š endpointï¼Œåˆ™é»˜è®¤æ·»åŠ  netns ä¸­æ‰€æœ‰çš„ enpoint è®¾å¤‡<ol><li>é’ˆå¯¹ netns ä¸­æ¯ä¸€ä¸ªç½‘ç»œè®¾å¤‡æ¥å£ä¿¡æ¯ï¼ˆå³ NetworkInfoï¼‰ï¼Œè·å¾—å…¶åç§°ã€ç±»å‹ã€IP åœ°å€ã€è·¯ç”±ã€ARP neighbor ç­‰ä¿¡æ¯ï¼ˆåç»­ä¼šè®¾ç½®åœ¨ endpoint.EndpointProperties ä¸­ï¼Œç”¨äºæè¿° endpoint çš„å±æ€§ï¼‰</li><li>å¿½ç•¥ç¼ºå°‘ IP åœ°å€çš„ç½‘ç»œæ¥å£ï¼Œä»¥åŠæœ¬åœ°å›ç¯æ¥å£<br><em>ç¼ºå°‘ IP åœ°å€æ„å‘³ç€è¦ä¹ˆæ˜¯æ²¡æœ‰å‘½åç©ºé—´çš„åŸºæœ¬éš§é“è®¾å¤‡ï¼Œå¦‚ gre0ã€gretap0ã€sit0ã€ipip0ã€tunl0ï¼Œè¦ä¹ˆæ˜¯é”™è¯¯è®¾ç½®çš„æ¥å£</em></li><li>è¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œè°ƒç”¨ <strong>addSingleEndpoint</strong>ï¼Œå‘ VM ä¸­æ·»åŠ  endpoint è®¾å¤‡</li></ol></li><li>å¦åˆ™ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ª endpointï¼Œè¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œè°ƒç”¨ <strong>addSingleEndpoint</strong>ï¼Œå‘ VM ä¸­æ·»åŠ  endpoint è®¾å¤‡</li></ol><h2 id="RemoveEndpoints"><a href="#RemoveEndpoints" class="headerlink" title="RemoveEndpoints"></a>RemoveEndpoints</h2><p><strong>ç§»é™¤ VM ä¸­çš„ endpoint è®¾å¤‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/network_linux.go#L356">source code</a></p><ol><li>å¦‚æœæœªæŒ‡å®š endpointï¼Œåˆ™é»˜è®¤ä¸º netns ä¸­æ‰€æœ‰çš„ endpoint è®¾å¤‡ï¼ˆä¹Ÿå°±æ˜¯ AddEndpoints ä¸­æ·»åŠ çš„ endpoint è®¾å¤‡ï¼‰ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªå¾…ç§»é™¤çš„ endpoint<ol><li>è°ƒç”¨ endpoint çš„ <strong>GetRxRateLimiter</strong>ï¼Œå¦‚æœè®¾ç½®äº† inbound é™é€Ÿï¼Œåˆ™è¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œç§»é™¤é™é€Ÿè®¾å¤‡ htb ç±»å‹çš„ç½‘ç»œé˜Ÿåˆ—è§„åˆ™<br><em>æœ¬è´¨ä¸Šå°±æ˜¯å¯¹ addSingleEndpoint ä¸­ inbound é™é€Ÿå¤„ç†çš„é€†æ“ä½œ</em></li><li>è°ƒç”¨ endpoint çš„ <strong>GetTxRateLimiter</strong>ï¼Œå¦‚æœè®¾ç½®äº† outbound é™é€Ÿï¼Œåˆ™è¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œç§»é™¤é™é€Ÿè®¾å¤‡ htb ç±»å‹çš„ç½‘ç»œé˜Ÿåˆ—è§„åˆ™ã€åˆ é™¤é™é€Ÿè®¾å¤‡æ‰€æœ‰çš„ tc è§„åˆ™ä¸ ingress ç±»å‹çš„ç½‘ç»œé˜Ÿåˆ—è§„åˆ™ä»¥åŠå…³åœå¹¶ç§»é™¤ ifb0 è®¾å¤‡<br><em>æœ¬è´¨ä¸Šå°±æ˜¯å¯¹ addSingleEndpoint ä¸­ outbound é™é€Ÿå¤„ç†çš„é€†æ“ä½œ</em></li><li>æ ¹æ®æ˜¯å¦ä¸º hotplugï¼Œåˆ™è°ƒç”¨ endpoint çš„ <strong>HotDetach</strong> æˆ– <strong>Detach</strong>ï¼Œï¼ˆçƒ­ï¼‰ç§»é™¤ VM ä¸­çš„ endpoint è®¾å¤‡</li></ol></li><li>å¦‚æœ netns æ˜¯ç”± Kata Containers åˆ›å»ºï¼Œå¹¶ä¸”æœªæŒ‡å®š endpointï¼ˆå³åˆ é™¤äº† netns ä¸­æ‰€æœ‰çš„ endpointï¼‰ï¼Œåˆ™ç§»é™¤è¯¥ netns çš„æŒ‚è½½ç‚¹ï¼Œå¹¶åˆ é™¤è¯¥ netns</li></ol>]]></content>
    
    
    <summary type="html">virtcontainers ä¸­ä¸ Endpointã€Network ç­‰ç½‘ç»œç®¡ç†ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” virtcontainers/resource controller</title>
    <link href="http://shenxianghong.github.io/2023/04/09/2023-04-09%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20resource%20controller%20-%20%E5%89%AF%E6%9C%AC/"/>
    <id>http://shenxianghong.github.io/2023/04/09/2023-04-09%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20resource%20controller%20-%20%E5%89%AF%E6%9C%AC/</id>
    <published>2023-04-08T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.272Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><h1 id="ResourceController"><a href="#ResourceController" class="headerlink" title="ResourceController"></a>ResourceController</h1><p><em><u>src&#x2F;runtime&#x2F;pkg&#x2F;resourcecontrol&#x2F;controller.go</u></em></p><p>ResourceController åœ¨ Linux ä¸Šçš„å®ç°ä¸º LinuxCgroupï¼Œè€Œ LinuxCgroup å…·ä½“ä½“ç°ä¸ºä¸¤ç§ï¼šsandboxController å’Œ overheadControllerï¼š</p><ul><li>å½“ [runtime].sandbox_cgroup_only å¼€å¯æ—¶ï¼Œé¡¾åæ€ä¹‰ä»…æœ‰ sandboxControllerï¼Œç”¨äºç®¡ç† Pod æ‰€æœ‰çš„çº¿ç¨‹èµ„æº</li><li>å½“ [runtime].sandbox_cgroup_only æœªå¼€å¯æ—¶ï¼Œèµ„æºåˆ†ä¸ºä¸¤ç±»ï¼Œå…¶ä¸­ vCPU çº¿ç¨‹èµ„æºä¼šç”± sandboxController ç®¡ç†ï¼Œå…¶ä½™èµ„æºç”± overheadController ç®¡ç†</li></ul><p><em>å…·ä½“æ‰§è¡Œæ ‡å‡†å‚è€ƒ OCI runtime-specï¼š<a href="https://github.com/opencontainers/runtime-spec/blob/main/config-linux.md%E3%80%82">https://github.com/opencontainers/runtime-spec/blob/main/config-linux.mdã€‚</a></em></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LinuxCgroup <span class="keyword">struct</span> &#123;</span><br><span class="line">sync.Mutex</span><br><span class="line">    </span><br><span class="line"><span class="comment">// cgroup å®ç°ï¼Œå…¶ä¸­ç±»å‹åŒ…æ‹¬ legacyã€hybrid å’Œ unifiedï¼Œç”¨äºåŒºåˆ† cgroups v1 å’Œ v2</span></span><br><span class="line">cgroup  <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cgroup è·¯å¾„</span></span><br><span class="line">path    <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾…é™åˆ¶çš„ CPU</span></span><br><span class="line">cpusets *specs.LinuxCPU</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å¾…é™åˆ¶çš„ sandbox è®¾å¤‡</span></span><br><span class="line"><span class="comment">// é™¤äº†åˆ›å»ºæ—¶æŒ‡å®šçš„ sandbox è®¾å¤‡ï¼Œè¿˜ä¼šè¿½åŠ ä»¥ä¸‹è®¾å¤‡ï¼š</span></span><br><span class="line"><span class="comment">//   é»˜è®¤è®¾å¤‡ï¼š/dev/nullã€/dev/randomã€/dev/fullã€/dev/ttyã€/dev/zeroã€/dev/urandom å’Œ /dev/console</span></span><br><span class="line"><span class="comment">//   è™šæ‹ŸåŒ–è®¾å¤‡ï¼š/dev/kvmã€/dev/vhost-netã€/dev/vfio/vfio å’Œ /dev/vhost-vsock</span></span><br><span class="line"><span class="comment">//   wildcard è®¾å¤‡ï¼ˆé€šè¿‡æ‰‹åŠ¨æŒ‡å®š majorã€minorã€access å’Œ type å±æ€§æ„é€ çš„è®¾å¤‡ï¼‰ï¼štuntapã€/dev/pts ç­‰</span></span><br><span class="line">devices []specs.LinuxDeviceCgroup</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LinuxCgroup çš„å®ç°æ–¹å¼æœ¬è´¨ä¸Šæ˜¯å°è£…äº† <code>github.com/containerd/cgroups </code> åº“ï¼Œç”¨äºå¤„ç† cgroup èµ„æºã€‚å› æ­¤ï¼Œ<strong>Type</strong>ã€<strong>ID</strong>ã€<strong>Parent</strong>ã€<strong>Delete</strong>ã€<strong>Stat</strong>ã€<strong>AddProcess</strong>ã€<strong>AddThread</strong>ã€<strong>Update</strong>ã€<strong>MoveTo</strong>ã€<strong>AddDevice</strong>ã€<strong>RemoveDevice</strong> å’Œ <strong>UpdateCpuSet</strong> å‡ä¸ºè¯¥åº“é’ˆå¯¹ cgroup v1 å’Œ v2 ä¸åŒç‰ˆæœ¬ä¸‹ç»Ÿä¸€å…¥å£çš„äºŒæ¬¡å°è£…ã€‚<em>è¯¥åº“ä¸æ”¯æŒé’ˆå¯¹ systemd åˆ›å»ºå…·æœ‰ v1 å’Œ v2 cgroup çš„ scopeï¼Œå› æ­¤è¿™éƒ¨åˆ†æ˜¯ç›´æ¥ä¸ systemd äº¤äº’åˆ›å»º cgroupï¼Œç„¶åä½¿ç”¨ containerd çš„ api åŠ è½½å®ƒã€‚ æ·»åŠ è¿è¡Œæ—¶è¿›ç¨‹ï¼Œæ— éœ€è°ƒç”¨ setupCgroups</em></p><p><em>æ­¤å¤–ï¼Œä»¥ä¸‹çš„å‡½æ•°å£°æ˜å¹¶é ResourceController çš„æ¥å£å£°æ˜ï¼Œè€Œæ˜¯ VCSandbox çš„æ‰©å±•å°è£…ï¼Œä¸ºäº†ä¾¿äºç†è§£ï¼Œå°†å…¶å½’ç±»è‡³ ResourceController ä¸‹ã€‚</em></p><h2 id="setupResourceController"><a href="#setupResourceController" class="headerlink" title="setupResourceController"></a>setupResourceController</h2><p><strong>é…ç½® resourceController</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L2275">source code</a></p><ol><li>è°ƒç”¨ sandboxController æˆ– overheadControllerï¼ˆå–å†³äº sandbox èµ„æºæ˜¯å¦åˆ†å¼€ç®¡ç†ï¼Œå³ [runtime].sandbox_cgroup_only çš„é…ç½®ï¼‰çš„ <strong>AddProcess</strong>ï¼Œå°†å½“å‰è¿›ç¨‹ ID åŠ å…¥åˆ° cgroup ä¸­ç®¡ç†<br><em>ç¡®ä¿è¿è¡Œæ—¶çš„ä»»ä½•å­è¿›ç¨‹ï¼ˆå³æœåŠ¡äº Kata Pod çš„æ‰€æœ‰è¿›ç¨‹ï¼‰éƒ½å°†å­˜åœ¨äº resourceController ä¸­ï¼Œä¸”å¦‚æœæœ‰ overheadController åˆ™ç”± overheadController ç®¡ç†æ­¤ç±»è¿›ç¨‹ä»¥åŠå­è¿›ç¨‹</em></li></ol><h2 id="resourceControllerUpdate"><a href="#resourceControllerUpdate" class="headerlink" title="resourceControllerUpdate"></a>resourceControllerUpdate</h2><p><strong>æ›´æ–° resourceController ä»¥åŠ cgroup ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L2191">source code</a></p><ol><li>èšåˆ sandbox ä¸­æ‰€æœ‰å®¹å™¨çš„ CPUSet å’Œ MEMSet ä¿¡æ¯ï¼Œè°ƒç”¨ sandboxController çš„ <strong>UpdateCpuSet</strong>ï¼Œæ›´æ–°åˆ° cgroup ä¸­</li><li>å¦‚æœ sandbox çš„èµ„æºåˆ†å¼€ç®¡ç†ï¼ˆå³å­˜åœ¨ overheadControllerï¼‰ï¼Œåˆ™è°ƒç”¨ hypervisor çš„ <strong>GetThreadIDs</strong>ï¼Œè·å– vCPU çº¿ç¨‹ï¼Œå¹¶è°ƒç”¨ sandboxController çš„ <strong>AddThread</strong>ï¼Œå°† vCPU çº¿ç¨‹çš„åŠ å…¥åˆ° cgroup ä¸­ç®¡ç†<br><em>å› ä¸ºå½“æœ‰ overheadController æ—¶ï¼Œæ„å‘³ç€ä¼šäº§ç”Ÿæ–°çš„ vCPU çº¿ç¨‹ä¼šä½œä¸º hypervisor çš„å­çº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦å¹¶å…¥ç»Ÿä¸€çš„ cgroup ä¸­ç®¡ç†</em></li></ol><h2 id="resourceControllerDelete"><a href="#resourceControllerDelete" class="headerlink" title="resourceControllerDelete"></a>resourceControllerDelete</h2><p><strong>åˆ é™¤ resourceController ä»¥åŠ cgroup ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L2216">source code</a></p><ol><li>è°ƒç”¨ <strong>LoadResourceController</strong>ï¼Œæ ¹æ® sandboxController çš„ cgroupPath è·å– sandboxController</li><li>è°ƒç”¨ sandboxController çš„ <strong>Parent</strong>ï¼Œè·å–çˆ¶çº§ä¿¡æ¯ï¼›è°ƒç”¨ sandboxController çš„ <strong>MoveTo</strong>ï¼Œå°†å…¶ç®¡ç†çš„è¿›ç¨‹ç§»è‡³çˆ¶çº§ï¼›å¹¶è°ƒç”¨ sandboxController çš„ <strong>Delete</strong>ï¼Œåˆ é™¤ sandboxController çš„ cgroup</li><li>å¦‚æœ sandbox çš„èµ„æºåˆ†å¼€ç®¡ç†ï¼ˆå³å­˜åœ¨ overheadControllerï¼‰ï¼Œåˆ™æ‰§è¡ŒåŒæ ·çš„æ“ä½œ</li></ol>]]></content>
    
    
    <summary type="html">virtcontainers ä¸­ä¸ ResourceController ç­‰èµ„æºé™åˆ¶ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” virtcontainers/device</title>
    <link href="http://shenxianghong.github.io/2023/03/18/2023-03-18%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20device/"/>
    <id>http://shenxianghong.github.io/2023/03/18/2023-03-18%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20device/</id>
    <published>2023-03-17T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.271Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><p>DeviceReceiver æ˜¯ä¸€ç»„ç›¸å¯¹è€Œè¨€è¾ƒåº•å±‚çš„æ¥å£å£°æ˜ï¼Œå…¶ç›´æ¥è°ƒç”¨ hypervisor æ‰§è¡Œè®¾å¤‡çƒ­æ’æ‹”ç­‰æ“ä½œï¼›è€Œ Device æè¿°äº†è®¾å¤‡çš„å®ç°ç»†èŠ‚ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ DeviceReceiver çš„æ¥å£å®ç°å„è‡ªçš„çƒ­æ’æ‹”åŠŸèƒ½ï¼›è€Œ DeviceManager åˆ™å¯¹å¤–æä¾›è®¾å¤‡ç®¡ç†èƒ½åŠ›ï¼Œå…¶å†…éƒ¨å±è”½äº†è®¾å¤‡çš„å…·ä½“ç±»å‹ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ Device çš„æ¥å£ç®¡ç†è®¾å¤‡ã€‚</p><h1 id="DeviceReceiver"><a href="#DeviceReceiver" class="headerlink" title="DeviceReceiver"></a>DeviceReceiver</h1><p><em><u>src&#x2F;runtime&#x2F;pkg&#x2F;device&#x2F;api&#x2F;interface.go</u></em></p><p>DeviceReceiver çš„å®ç°ç”± Sandbox æ¥å£å®Œæˆã€‚</p><p>DeviceReceiver ä¸­å£°æ˜çš„ <strong>GetHypervisorType</strong> ä¸ºå‚æ•°è·å–ï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸ä½œè¯¦è¿°ã€‚</p><h2 id="HotplugAddDevice"><a href="#HotplugAddDevice" class="headerlink" title="HotplugAddDevice"></a>HotplugAddDevice</h2><p><strong>çƒ­æ·»åŠ è®¾å¤‡åˆ° sandbox ä¸­</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1789">source code</a></p><ol><li>è°ƒç”¨ sandboxController çš„ <strong>AddDevice</strong>ï¼Œå°† device çš„ <strong>GetHostPath</strong> æ·»åŠ åˆ° cgroup ç®¡ç†ä¸­</li><li>å¦‚æœè®¾å¤‡ç±»å‹ä¸º vfio<ol><li>è°ƒç”¨ device çš„ <strong>GetDeviceInfo</strong>ï¼Œè·å– iommu group ä¸­æ‰€æœ‰è®¾å¤‡</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugAddDevice</strong>ï¼Œçƒ­æ·»åŠ æ‰€æœ‰ vfio è®¾å¤‡<br><em>group æ˜¯ IOMMU èƒ½å¤Ÿè¿›è¡Œ DMA éš”ç¦»çš„æœ€å°ç¡¬ä»¶å•å…ƒï¼Œä¸€ä¸ª group å†…å¯èƒ½åªæœ‰ä¸€ä¸ª deviceï¼Œä¹Ÿå¯èƒ½æœ‰å¤šä¸ª deviceï¼Œè¿™å–å†³äºç‰©ç†å¹³å°ä¸Šç¡¬ä»¶çš„ IOMMU æ‹“æ‰‘ç»“æ„ã€‚ è®¾å¤‡ç›´é€šçš„æ—¶å€™ä¸€ä¸ª group é‡Œé¢çš„è®¾å¤‡å¿…é¡»éƒ½ç›´é€šç»™ä¸€ä¸ªè™šæ‹Ÿæœºã€‚ ä¸èƒ½å¤Ÿè®©ä¸€ä¸ªgroup é‡Œçš„å¤šä¸ª device åˆ†åˆ«ä»å±äº 2 ä¸ªä¸åŒçš„ VMï¼Œä¹Ÿä¸å…è®¸éƒ¨åˆ† device åœ¨ host ä¸Šè€Œå¦ä¸€éƒ¨åˆ†è¢«åˆ†é…åˆ° guest é‡Œï¼Œ å› ä¸ºå°±è¿™æ ·ä¸€ä¸ª guest ä¸­çš„ device å¯ä»¥åˆ©ç”¨ DMA æ”»å‡»è·å–å¦å¤–ä¸€ä¸ª guest é‡Œçš„æ•°æ®ï¼Œå°±æ— æ³•åšåˆ°ç‰©ç†ä¸Šçš„ DMA éš”ç¦»ã€‚</em></li></ol></li><li>å¦‚æœè®¾å¤‡ç±»å‹ä¸º block æˆ– vhost-user-blk-pciï¼Œç›´æ¥è°ƒç”¨ hypervisor çš„ <strong>HotplugAddDevice</strong>ï¼Œçƒ­æ·»åŠ è®¾å¤‡</li><li>å¦‚æœè®¾å¤‡ç±»å‹ä¸º genericï¼ˆå³é vfioã€block æˆ–è€… vhost-user è®¾å¤‡ï¼‰ï¼Œåˆ™ä¸åšæ“ä½œ<br><em>æ ¹æ®æ³¨é‡Šçš„ TODOï¼ŒçŒœæµ‹åç»­ç‰ˆæœ¬ä¼šæœ‰æ“ä½œï¼Œæˆªè‡³ 3.0.0 æš‚æ— é€»è¾‘</em></li><li>å¦‚æœä¸ºå…¶ä»–è®¾å¤‡ç±»å‹ï¼Œåˆ™ä¸åšæ“ä½œ</li></ol><h2 id="HotplugRemoveDevice"><a href="#HotplugRemoveDevice" class="headerlink" title="HotplugRemoveDevice"></a>HotplugRemoveDevice</h2><p><strong>çƒ­ç§»é™¤ sandbox ä¸­çš„è®¾å¤‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1843">source code</a></p><ol><li>å¦‚æœè®¾å¤‡ç±»å‹ä¸º vfio<ol><li>è°ƒç”¨ device çš„ <strong>GetDeviceInfo</strong>ï¼Œè·å– iommu group ä¸­æ‰€æœ‰è®¾å¤‡</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugRemoveDevice</strong>ï¼Œçƒ­ç§»é™¤æ‰€æœ‰ vfio è®¾å¤‡</li></ol></li><li>å¦‚æœè®¾å¤‡ç±»å‹ä¸º blockï¼ˆé PMEM è®¾å¤‡ï¼Œå› ä¸ºæŒä¹…å†…å­˜è®¾å¤‡æ— æ³•çƒ­ç§»é™¤ï¼‰æˆ– vhost-user-blk-pci<ol><li>è°ƒç”¨ device çš„ <strong>GetDeviceInfo</strong>ï¼Œè·å–è®¾å¤‡è¯¦æƒ…</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugRemoveDevice</strong>ï¼Œçƒ­ç§»é™¤è®¾å¤‡</li></ol></li><li>å¦‚æœè®¾å¤‡ç±»å‹ä¸º genericï¼ˆå³é vfioã€block æˆ–è€… vhost-user è®¾å¤‡ï¼‰ï¼Œåˆ™ä¸åšæ“ä½œ<br><em>æ ¹æ®æ³¨é‡Šçš„ TODOï¼ŒçŒœæµ‹åç»­ç‰ˆæœ¬ä¼šæœ‰æ“ä½œï¼Œæˆªè‡³ 3.0.0 æš‚æ— é€»è¾‘</em></li><li>å¦‚æœä¸ºå…¶ä»–è®¾å¤‡ç±»å‹ï¼Œåˆ™ä¸åšæ“ä½œ</li><li>è°ƒç”¨ sandboxController çš„ <strong>RemoveDevice</strong>ï¼Œå°† device çš„ <strong>GetHostPath</strong> ä» cgroup ç®¡ç†ä¸­ç§»é™¤</li></ol><h2 id="GetAndSetSandboxBlockIndex"><a href="#GetAndSetSandboxBlockIndex" class="headerlink" title="GetAndSetSandboxBlockIndex"></a>GetAndSetSandboxBlockIndex</h2><p><strong>è·å–å¹¶è®¾ç½® virtio-block ç´¢å¼•ï¼Œä»…æ”¯æŒ virtio-blk å’Œ virtio-scsi ç±»å‹è®¾å¤‡</strong></p><p><em>ç”¨äºè®°å½•åˆ†é…ç»™ sandbox ä¸­å®¹å™¨çš„å—è®¾å¤‡ç´¢å¼•ï¼ˆé€šè¿‡ BlockIndexMapï¼ˆmap[int]struct{}ï¼‰ï¼‰</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1901">source code</a></p><ol><li>è·å–ç»´æŠ¤åœ¨ sandbox.state.BlockIndexMap ä¸­ï¼Œä» 0 åˆ° 65534 èŒƒå›´å†…æ²¡æœ‰è¢«ä½¿ç”¨çš„ç´¢å¼• ID</li></ol><h2 id="UnsetSandboxBlockIndex"><a href="#UnsetSandboxBlockIndex" class="headerlink" title="UnsetSandboxBlockIndex"></a>UnsetSandboxBlockIndex</h2><p><strong>é‡Šæ”¾è®°å½•çš„ virtio-block ç´¢å¼•ï¼Œä»…æ”¯æŒ virtio-blk å’Œ virtio-scsi ç±»å‹è®¾å¤‡</strong></p><p><em>ç”¨äºè®°å½•åˆ†é…ç»™ sandbox ä¸­å®¹å™¨çš„å—è®¾å¤‡ç´¢å¼•ï¼ˆé€šè¿‡ BlockIndexMapï¼ˆmap[int]struct{}ï¼‰ï¼‰</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1907">source code</a></p><ol><li>ç§»é™¤ç»´æŠ¤åœ¨ sandbox.state.BlockIndexMapï¼ˆmap[int]struct{}ï¼‰ä¸­çš„ç´¢å¼•</li></ol><h2 id="AppendDevice"><a href="#AppendDevice" class="headerlink" title="AppendDevice"></a>AppendDevice</h2><p><strong>å‘ sandbox ä¸­æ·»åŠ ä¸€ä¸ª vhost-user ç±»å‹çš„è®¾å¤‡ï¼Œç”¨äºå‘ hypervisor ä¼ é€’å¯åŠ¨å‚æ•°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1914">source code</a></p><ol><li>å¦‚æœè®¾å¤‡ç±»å‹ä¸º vhost-user-scsi-pciã€virtio-net-pciã€vhost-user-blk-pci å’Œ vhost-user-fs-pci<ol><li>è°ƒç”¨ device çš„ <strong>GetDeviceInfo</strong>ï¼Œè·å–è®¾å¤‡ä¿¡æ¯</li><li>è°ƒç”¨ hypervisor çš„ <strong>AddDevice</strong>ï¼Œæ·»åŠ è®¾å¤‡</li></ol></li><li>å¦‚æœè®¾å¤‡ç±»å‹ä¸º vfio<ol><li>è°ƒç”¨ device çš„ <strong>GetDeviceInfo</strong>ï¼Œè·å– vfio group ä¸­æ‰€æœ‰è®¾å¤‡</li><li>è°ƒç”¨ hypervisor çš„ <strong>AddDevice</strong>ï¼Œæ·»åŠ æ‰€æœ‰ vfio è®¾å¤‡</li></ol></li><li>å…¶ä½™è®¾å¤‡ç±»å‹å‡ä¸æ”¯æŒ</li></ol><h1 id="Device"><a href="#Device" class="headerlink" title="Device"></a>Device</h1><p><em><u>src&#x2F;runtime&#x2F;pkg&#x2F;device&#x2F;api&#x2F;interface.go</u></em></p><p>Device æœ‰ä»¥ä¸‹å®ç°æ–¹å¼ï¼šGenericDeviceã€VFIODeviceã€BlockDeviceã€VhostUserBlkDeviceã€VhostUserFSDeviceã€VhostUserNetDevice å’Œ VhostUserSCSIDeviceï¼Œå…¶ä¸­å‡ä»¥ GenericDevice ä¸ºåŸºç¡€ï¼Œæ‰©å±•éƒ¨åˆ†æ–¹æ³•ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DeviceInfo is an embedded type that contains device data common to all types of devices.</span></span><br><span class="line"><span class="keyword">type</span> DeviceInfo <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// DriverOptions is specific options for each device driver</span></span><br><span class="line"><span class="comment">// for example, for BlockDevice, we can set DriverOptions[&quot;block-driver&quot;]=&quot;virtio-blk&quot;</span></span><br><span class="line">DriverOptions <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Hostpath is device path on host</span></span><br><span class="line">HostPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ContainerPath is device path inside container</span></span><br><span class="line">ContainerPath <span class="type">string</span> <span class="string">`json:&quot;-&quot;`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Type of device: c, b, u or p</span></span><br><span class="line"><span class="comment">// c , u - character(unbuffered)</span></span><br><span class="line"><span class="comment">// p - FIFO</span></span><br><span class="line"><span class="comment">// b - block(buffered) special file</span></span><br><span class="line"><span class="comment">// More info in mknod(1).</span></span><br><span class="line">DevType <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ID for the device that is passed to the hypervisor.</span></span><br><span class="line">ID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Major, minor numbers for device.</span></span><br><span class="line">Major <span class="type">int64</span></span><br><span class="line">Minor <span class="type">int64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// FileMode permission bits for the device.</span></span><br><span class="line">FileMode os.FileMode</span><br><span class="line"></span><br><span class="line"><span class="comment">// id of the device owner.</span></span><br><span class="line">UID <span class="type">uint32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// id of the device group.</span></span><br><span class="line">GID <span class="type">uint32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Pmem enabled persistent memory. Use HostPath as backing file</span></span><br><span class="line"><span class="comment">// for a nvdimm device in the guest.</span></span><br><span class="line">Pmem <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// If applicable, should this device be considered RO</span></span><br><span class="line">ReadOnly <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ColdPlug specifies whether the device must be cold plugged (true)</span></span><br><span class="line"><span class="comment">// or hot plugged (false).</span></span><br><span class="line">ColdPlug <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DeviceInfo æè¿°äº†è®¾å¤‡çš„å±æ€§ä¿¡æ¯ï¼Œé€šå¸¸æ˜¯æ ¹æ® OCI spec ä¸­è·å¾—ï¼Œå¹¶æ ¹æ®å…·ä½“çš„å®é™…è®¾å¤‡ç±»å‹è¦†ç›–ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VFIODevice is a vfio device meant to be passed to the hypervisor</span></span><br><span class="line"><span class="comment">// to be used by the Virtual Machine.</span></span><br><span class="line"><span class="keyword">type</span> VFIODevice <span class="keyword">struct</span> &#123;</span><br><span class="line">*GenericDevice</span><br><span class="line">    </span><br><span class="line"><span class="comment">// å…ƒç´ ä¸º /sys/kernel/iommu_groups/&lt;DeviceInfo.HostPath&gt;/devices ç›®å½•ä¸‹çš„æ‰€æœ‰å­è®¾å¤‡ï¼ˆIOMMUï¼‰è¯¦æƒ…</span></span><br><span class="line">VfioDevs []*config.VFIODev</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ª VFIO è®¾å¤‡ä¹Ÿå°±æ˜¯ä¸€ç»„ IOMMU è®¾å¤‡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BlockDevice refers to a block storage device implementation.</span></span><br><span class="line"><span class="keyword">type</span> BlockDevice <span class="keyword">struct</span> &#123;</span><br><span class="line">*GenericDevice</span><br><span class="line">BlockDrive *config.BlockDrive</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VhostUserBlkDevice is a block vhost-user based device</span></span><br><span class="line"><span class="keyword">type</span> VhostUserBlkDevice <span class="keyword">struct</span> &#123;</span><br><span class="line">*GenericDevice</span><br><span class="line">VhostUserDeviceAttrs *config.VhostUserDeviceAttrs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VhostUserFSDevice is a virtio-fs vhost-user device</span></span><br><span class="line"><span class="keyword">type</span> VhostUserFSDevice <span class="keyword">struct</span> &#123;</span><br><span class="line">*GenericDevice</span><br><span class="line">config.VhostUserDeviceAttrs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VhostUserNetDevice is a network vhost-user based device</span></span><br><span class="line"><span class="keyword">type</span> VhostUserNetDevice <span class="keyword">struct</span> &#123;</span><br><span class="line">*GenericDevice</span><br><span class="line">*config.VhostUserDeviceAttrs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VhostUserSCSIDevice is a SCSI vhost-user based device</span></span><br><span class="line"><span class="keyword">type</span> VhostUserSCSIDevice <span class="keyword">struct</span> &#123;</span><br><span class="line">*GenericDevice</span><br><span class="line">*config.VhostUserDeviceAttrs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenericDevice refers to a device that is neither a VFIO device, block device or VhostUserDevice.</span></span><br><span class="line"><span class="keyword">type</span> GenericDevice <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// è®¾å¤‡çš„é€šç”¨å±æ€§ä¿¡æ¯</span></span><br><span class="line">ID         <span class="type">string</span></span><br><span class="line">DeviceInfo *config.DeviceInfo</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡å¼•ç”¨ä¸ Attach è®¡æ•°</span></span><br><span class="line">RefCount    <span class="type">uint</span></span><br><span class="line">AttachCount <span class="type">uint</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VFIODev represents a VFIO drive used for hotplugging</span></span><br><span class="line"><span class="comment">// /sys/kernel/iommu_groups/&lt;DeviceInfo.HostPath&gt;/devices ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å‡è§†ä¸ºä¸€ä¸ª VFIODev</span></span><br><span class="line"><span class="keyword">type</span> VFIODev <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// ID is used to identify this drive in the hypervisor options.</span></span><br><span class="line"><span class="comment">// æ ¼å¼ä¸º vfio-&lt;DeviceInfo.ID&gt;&lt;idx&gt;ï¼Œæœ€é•¿ä¿ç•™ 31 ä½ï¼Œå…¶ä¸­ idx ä¸ºéå†æ–‡ä»¶çš„é€’å¢ç´¢å¼•</span></span><br><span class="line">ID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Type of VFIO device</span></span><br><span class="line"><span class="comment">// VFIO è®¾å¤‡è¿›ä¸€æ­¥åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼Œå¯ä»¥é€šè¿‡æ–‡ä»¶ååŒºåˆ«ï¼š</span></span><br><span class="line"><span class="comment">// - å¸¸è§„ç±»å‹ï¼Œä¾‹å¦‚ 0000:04:00.0</span></span><br><span class="line"><span class="comment">// - mediated ç±»å‹ï¼Œä¾‹å¦‚ f79944e4-5a3d-11e8-99ce-479cbab002e4</span></span><br><span class="line">Type VFIODeviceType</span><br><span class="line">    </span><br><span class="line"><span class="comment">// BDF (Bus:Device.Function) of the PCI address</span></span><br><span class="line"><span class="comment">// - å¸¸è§„ç±»å‹ï¼Œä¾‹å¦‚ 0000:04:00.0 -&gt; 04:00.0</span></span><br><span class="line"><span class="comment">// - mediated ç±»å‹ï¼Œä¾‹å¦‚ f79944e4-5a3d-11e8-99ce-479cbab002e4 -&gt; /sys/kernel/iommu_groups/&lt;DeviceInfo.HostPath&gt;/devices/f79944e4-5a3d-11e8-99ce-479cbab002e4 -&gt; /sys/devices/pci0000:00/0000:00:02.0/f79944e4-5a3d-11e8-99ce-479cbab002e4ï¼ˆè½¯é“¾æ¥å…³ç³»ï¼‰-&gt; 0000:00:02.0 -&gt; 00:02.0</span></span><br><span class="line">BDF <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// sysfsdev of VFIO mediated device</span></span><br><span class="line"><span class="comment">// - å¸¸è§„ç±»å‹ï¼Œä¾‹å¦‚ 0000:04:00.0 -&gt; /sys/bus/pci/devices/0000:04:00.0</span></span><br><span class="line"><span class="comment">// - mediated ç±»å‹ï¼Œä¾‹å¦‚ f79944e4-5a3d-11e8-99ce-479cbab002e4 -&gt; /sys/kernel/iommu_groups/&lt;DeviceInfo.HostPath&gt;/devices/f79944e4-5a3d-11e8-99ce-479cbab002e4 -&gt; /sys/devices/pci0000:00/0000:00:02.0/f79944e4-5a3d-11e8-99ce-479cbab002e4ï¼ˆè½¯é“¾æ¥å…³ç³»ï¼‰</span></span><br><span class="line">SysfsDev <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// IsPCIe specifies device is PCIe or PCI</span></span><br><span class="line"><span class="comment">// æ ¹æ® /sys/bus/pci/devices/0000:&lt;BDF&gt;/config æ–‡ä»¶å¤§å°åˆ¤æ–­æ˜¯å¦ä¸º PCI è®¾å¤‡</span></span><br><span class="line"><span class="comment">// - PCI è®¾å¤‡ï¼Œå¤§å°ä¸º 256</span></span><br><span class="line"><span class="comment">// - PCIe è®¾å¤‡ï¼Œå¤§å°ä¸º 4096</span></span><br><span class="line">IsPCIe <span class="type">bool</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// PCI Class Code</span></span><br><span class="line"><span class="comment">// /sys/bus/pci/devices/0000:&lt;BDF&gt;/class æ–‡ä»¶å†…å®¹</span></span><br><span class="line">Class <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Bus of VFIO PCIe device</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸º PCIe è®¾å¤‡ï¼Œåˆ™è®°å½•åç§°ä¸º rp&lt;idx&gt;ï¼Œå…¶ä¸­ idx ä¸ºå½“å‰è®°å½•çš„ PCIe æ€»è®¾å¤‡æ•°é‡</span></span><br><span class="line">Bus <span class="type">string</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// VendorID specifies vendor id</span></span><br><span class="line">VendorID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DeviceID specifies device id</span></span><br><span class="line">DeviceID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Guest PCI path of device</span></span><br><span class="line">GuestPciPath vcTypes.PciPath</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VFIODev æè¿°äº† VFIODevice è®¾å¤‡ç‰¹æœ‰çš„å±æ€§ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸º IOMMU è®¾å¤‡çš„ä¿¡æ¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BlockDrive represents a block storage drive which may be used in case the storage</span></span><br><span class="line"><span class="comment">// driver has an underlying block storage device.</span></span><br><span class="line"><span class="keyword">type</span> BlockDrive <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// File is the path to the disk-image/device which will be used with this drive</span></span><br><span class="line"><span class="comment">// - BlockDeviceï¼š&lt;DeviceInfo.HostPath&gt;</span></span><br><span class="line"><span class="comment">// - SWAPï¼š&lt;XDG_RUNTIME_DIR&gt;/run/kata-containers/shared/sandboxes/swap&lt;idx&gt;ï¼Œå…¶ä¸­ idx ä¸º sandbox ä¸­ SWAP æ–‡ä»¶é€’å¢ç´¢å¼•</span></span><br><span class="line">File <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Format of the drive</span></span><br><span class="line"><span class="comment">// - BlockDeviceï¼šDeviceInfo.DriverOptions[&quot;fstype&quot;] æŒ‡å®šï¼Œé»˜è®¤ä¸º raw</span></span><br><span class="line"><span class="comment">// - SWAPï¼šå›ºå®šä¸º raw</span></span><br><span class="line">Format <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ID is used to identify this drive in the hypervisor options.</span></span><br><span class="line"><span class="comment">// - BlockDeviceï¼šæ ¼å¼ä¸º drive-&lt;DeviceInfo.ID&gt;&lt;idx&gt;ï¼Œæœ€é•¿ä¿ç•™ 31 ä½</span></span><br><span class="line"><span class="comment">// - SWAPï¼šsandbox ä¸­ SWAP æ–‡ä»¶é€’å¢ç´¢å¼•</span></span><br><span class="line">ID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MmioAddr is used to identify the slot at which the drive is attached (order?).</span></span><br><span class="line">MmioAddr <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SCSI Address of the block device, in case the device is attached using SCSI driver</span></span><br><span class="line"><span class="comment">// SCSI address is in the format SCSI-Id:LUN</span></span><br><span class="line"><span class="comment">// - BlockDeviceï¼šå¦‚æœ DeviceInfo.DriverOptions[&quot;block-driver&quot;] ä¸º virtio-scsiï¼ˆä¸æŒ‡å®šé»˜è®¤ä¹Ÿä¸º virtio-scsiï¼‰ï¼Œåˆ™æ ¹æ® Index è·å– SCSI-Idï¼ˆIndex / 256ï¼‰ä»¥åŠ LUNï¼ˆIndex % 256ï¼‰ï¼Œæœ€ç»ˆçš„ SCSI åœ°å€ä¸º &lt;SCSI-Id&gt;:&lt;LUN&gt;</span></span><br><span class="line">SCSIAddr <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NvdimmID is the nvdimm id inside the VM</span></span><br><span class="line">NvdimmID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// VirtPath at which the device appears inside the VM, outside of the container mount namespace</span></span><br><span class="line"><span class="comment">// - BlockDeviceï¼šå¦‚æœ DeviceInfo.DriverOptions[&quot;block-driver&quot;] ä¸ä¸º virtio-scsi æˆ–è€… nvdimmï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­</span></span><br><span class="line"><span class="comment">// -- å¦‚æœ block-driver ä¸º virtio-blk æˆ– virtio-blk-ccwï¼Œåˆ™ç´¢å¼•ä¸º Index</span></span><br><span class="line"><span class="comment">// -- å¦‚æœ block-driver ä¸º virtio-mmioï¼Œåˆ™ç´¢å¼•ä¸º Index + 1</span></span><br><span class="line"><span class="comment">//    æ ¹æ®ç´¢å¼•è®¡ç®—å‡ºè®¾å¤‡è·¯å¾„ï¼Œä¾‹å¦‚ 0 -&gt; /dev/vdaï¼Œ25 -&gt; /dev/vdzï¼Œ27 -&gt; /dev/vdab</span></span><br><span class="line">VirtPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// DevNo identifies the css bus id for virtio-blk-ccw</span></span><br><span class="line">DevNo <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// PCIPath is the PCI path used to identify the slot at which the drive is attached.</span></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// Index assigned to the drive. In case of virtio-scsi, this is used as SCSI LUN index</span></span><br><span class="line"><span class="comment">// - BlockDeviceï¼šè°ƒç”¨ DeviceReceiver.GetAndSetSandboxBlockIndex è·å–</span></span><br><span class="line">Index <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ShareRW enables multiple qemu instances to share the File</span></span><br><span class="line">ShareRW <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadOnly sets the device file readonly</span></span><br><span class="line"><span class="comment">// - BlockDeviceï¼š&lt;DeviceInfo.ReadOnly&gt;</span></span><br><span class="line">ReadOnly <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Pmem enables persistent memory. Use File as backing file</span></span><br><span class="line"><span class="comment">// for a nvdimm device in the guest</span></span><br><span class="line"><span class="comment">// - BlockDeviceï¼š&lt;DeviceInfo.Pmem&gt;</span></span><br><span class="line">Pmem <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This block device is for swap</span></span><br><span class="line">Swap <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BlockDrive æè¿°äº† BlockDevice è®¾å¤‡ç‰¹æœ‰çš„å±æ€§ä¿¡æ¯ï¼Œé™¤äº†åœ¨ BlockDevice ä¸­ä½¿ç”¨ï¼ŒSWAP å’Œ VM é•œåƒä¹Ÿæ˜¯ç”± BlockDrive æ„å»ºã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VhostUserDeviceAttrs represents data shared by most vhost-user devices</span></span><br><span class="line"><span class="keyword">type</span> VhostUserDeviceAttrs <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// VhostUserBlkDeviceï¼šæ ¼å¼ä¸º blk-&lt;DeviceInfo.ID&gt;&lt;idx&gt;ï¼Œæœ€é•¿ä¿ç•™ 31 ä½</span></span><br><span class="line">DevID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// VhostUserBlkDeviceï¼š&lt;DeviceInfo.HostPath&gt;</span></span><br><span class="line">SocketPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MacAddress is only meaningful for vhost user net device</span></span><br><span class="line">MacAddress <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// These are only meaningful for vhost user fs devices</span></span><br><span class="line">Tag <span class="type">string</span></span><br><span class="line"></span><br><span class="line">Cache <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// VhostUserBlkDeviceï¼šå›ºå®šä¸º vhost-user-blk-pci</span></span><br><span class="line">Type DeviceType</span><br><span class="line"></span><br><span class="line"><span class="comment">// PCIPath is the PCI path used to identify the slot at which</span></span><br><span class="line"><span class="comment">// the drive is attached.  It is only meaningful for vhost</span></span><br><span class="line"><span class="comment">// user block devices</span></span><br><span class="line">PCIPath vcTypes.PciPath</span><br><span class="line"></span><br><span class="line"><span class="comment">// Block index of the device if assigned</span></span><br><span class="line"><span class="comment">// é»˜è®¤ä¸º -1ï¼Œå¦‚æœ DeviceInfo.DriverOptions[&quot;block-driver&quot;] ä¸º virtio-blkã€virtio-blk-ccw æˆ– virtio-mmioï¼Œè°ƒç”¨ DeviceReceiver.GetAndSetSandboxBlockIndex è·å–</span></span><br><span class="line">Index <span class="type">int</span></span><br><span class="line"></span><br><span class="line">CacheSize <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VhostUserDeviceAttrs æè¿°äº† VhostUserBlkDeviceã€VhostUserFSDeviceã€VhostUserNetDevice å’Œ VhostUserSCSIDevice è®¾å¤‡ç‰¹æœ‰çš„å±æ€§ä¿¡æ¯ã€‚</p><p>Device ä¸­å£°æ˜çš„ <strong>DeviceID</strong>ã€<strong>GetAttachCount</strong>ã€<strong>GetHostPath</strong> å’Œ <strong>GetMajorMinor</strong> å‡ä¸ºå‚æ•°è·å–ä¸èµ‹å€¼ï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸ä½œè¯¦è¿°ã€‚<br>æ­¤å¤–ï¼Œ<strong>DeviceType</strong> è¿”å›å„è‡ª Device å®ç°çš„ç±»å‹ï¼ˆå¦‚ genericã€vfioã€vhost-user-blk-pciã€vhost-user-fs-pciã€virtio-net-pci å’Œ vhost-user-scsi-pciï¼‰ï¼›<strong>GetDeviceInfo</strong> è¿”å›å„è‡ª Device å®ç°çš„å±æ€§ä¿¡æ¯ï¼›<strong>Reference</strong> å’Œ <strong>Dereference</strong> ç”¨äºç»´æŠ¤è®¾å¤‡çš„å¼•ç”¨è®¡æ•°ï¼Œæœªè¾¾åˆ°æœ€å¤šï¼ˆ^uint(0)ï¼Œå³ 2 çš„ 64 æ¬¡æ–¹å‡ä¸€ï¼‰å’Œæœ€å°‘å¼•ç”¨æ—¶ï¼Œåˆ™è®¡æ•°åŠ ä¸€æˆ–å‡ä¸€å¹¶è¿”å›ï¼›<strong>Save</strong> å’Œ <strong>Load</strong> ç”¨äº Device å’Œ DeviceStateï¼ˆç»“æ„ç±»ä¼¼ï¼Œç”¨äºæè¿°çŠ¶æ€æ•°æ®ï¼‰ä¹‹é—´è½¬æ¢ï¼Œä¸åŒçš„å®ç°é¢å¤–èµ‹å€¼å…¶å„è‡ªçš„å±æ€§ä¿¡æ¯ã€‚</p><h2 id="bumpAttachCount"><a href="#bumpAttachCount" class="headerlink" title="bumpAttachCount"></a>bumpAttachCount</h2><p><strong>è®°å½•è®¾å¤‡çš„ attach æ¬¡æ•°</strong></p><p><em>bumpAttachCount å¹¶é Device å£°æ˜çš„æ¥å£ï¼Œè€Œæ˜¯ GenericDevice çš„ä¸€ä¸ªå¸¸ç”¨æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œå®é™… attach æˆ– detach æ“ä½œï¼Œå‡½æ•°å…¥å‚ä¸­çš„ bool ç”¨äºè¡¨æ˜æ˜¯å¦ä¸º attach æ“ä½œï¼Œå‡ºå‚ä¸­çš„ bool ç”¨äºè¡¨æ˜æ˜¯å¦ä¸ºå•çº¯çš„è®¡æ•°ã€‚</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/generic.go#L101">source code</a></p><ol><li>å¦‚æœä¸º attach æ“ä½œ<ol><li>å¦‚æœå½“å‰ attach è®¡æ•°ä¸º 0ï¼Œåˆ™è®¡æ•°åŠ ä¸€ï¼Œå¹¶è¿”å› falseï¼Œå³éœ€è¦æ‰§è¡Œå®é™…çš„ attach æ“ä½œ</li><li>å¦‚æœå½“å‰ attach è®¡æ•°ä¸º ^uint(0)ï¼ˆå³ 2 çš„ 64 æ¬¡æ–¹å‡ä¸€ï¼‰ï¼Œåˆ™è¿”å› true å’Œè®¾å¤‡ attach æ¬¡æ•°è¿‡å¤šçš„é”™è¯¯</li><li>é™¤æ­¤ä¹‹å¤–ï¼Œé»˜è®¤è®¡æ•°åŠ ä¸€ï¼Œå¹¶è¿”å› trueï¼Œå³ä¸éœ€è¦æ‰§è¡Œå®é™…çš„ attach æ“ä½œ</li></ol></li><li>å¦‚æœä¸º detach æ“ä½œ<ol><li>å¦‚æœå½“å‰ attach è®¡æ•°ä¸º 0ï¼Œåˆ™è¿”å› true å’Œè®¾å¤‡å¹¶æœª attach çš„é”™è¯¯</li><li>å¦‚æœå½“å‰ attach æ¬¡æ•°ä¸º 1ï¼Œåˆ™è®¡æ•°å‡ä¸€ï¼Œå¹¶è¿”å› falseï¼Œå³éœ€è¦æ‰§è¡Œå®é™…çš„ detach æ“ä½œ</li><li>é™¤æ­¤ä¹‹å¤–ï¼Œé»˜è®¤è®¡æ•°å‡ä¸€ï¼Œå¹¶è¿”å› trueï¼Œå³ä¸éœ€è¦æ‰§è¡Œå®é™…çš„ detach æ“ä½œ</li></ol></li></ol><h2 id="Attach"><a href="#Attach" class="headerlink" title="Attach"></a>Attach</h2><p><strong>attach è®¾å¤‡</strong></p><p><em>æ ¹æ®ä¸åŒçš„å®ç°ï¼Œå¯èƒ½æ˜¯å†·æ·»åŠ æˆ–è€…çƒ­æ·»åŠ </em></p><h3 id="GenericDevice"><a href="#GenericDevice" class="headerlink" title="GenericDevice"></a>GenericDevice</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/generic.go#L36">source code</a></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œä¸æ‰§è¡Œå®é™…æ“ä½œ</li></ol><h3 id="VFIODevice"><a href="#VFIODevice" class="headerlink" title="VFIODevice"></a>VFIODevice</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/vfio#L58">source code</a></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œåç»­å®é™…æ“ä½œ</li><li>éå† &#x2F;sys&#x2F;kernel&#x2F;iommu_groups&#x2F;&lt;device.DeviceInfo.HostPath&gt;&#x2F;devicesï¼Œè·å– VFIO è®¾å¤‡çš„ BDFï¼ˆPCIe æ€»çº¿ä¸­çš„æ¯ä¸€ä¸ªåŠŸèƒ½éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ä¸ä¹‹å¯¹åº”ã€‚è¿™ä¸ªæ ‡è¯†ç¬¦å°±æ˜¯ BDFï¼Œå³ Busï¼ŒDeviceï¼ŒFunctionï¼‰ã€sysfsDev å’Œè®¾å¤‡ç±»å‹ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º PCIe è®¾å¤‡ï¼Œè·å– PCI class ç­‰ä¿¡æ¯ï¼Œå¦‚æœä¸º PCIe è®¾å¤‡ï¼Œç”Ÿæˆ Bus ä¿¡æ¯<br><em>å…·ä½“å‚è€ƒ VFIODev ç»“æ„ä½“æ³¨é‡Š</em></li><li>å¦‚æœè®¾å¤‡å¿…é¡»å†·æ·»åŠ ï¼Œåˆ™è°ƒç”¨ devReceiver çš„ <strong>AppendDevice</strong>ï¼Œæ·»åŠ è®¾å¤‡ï¼›å¦åˆ™è°ƒç”¨ devReceiver çš„ <strong>HotplugAddDevice</strong>ï¼Œçƒ­æ·»åŠ è®¾å¤‡</li></ol><h3 id="BlockDevice"><a href="#BlockDevice" class="headerlink" title="BlockDevice"></a>BlockDevice</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/block.go#L38">source code</a></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œåç»­å®é™…æ“ä½œ</li><li>è°ƒç”¨ devReceiver çš„ <strong>GetAndSetSandboxBlockIndex</strong>ï¼Œè®¾ç½®å¹¶è¿”å›å¯ç”¨çš„ç´¢å¼• ID</li><li>æ ¹æ® device.DeviceInfo.DriverOptions[â€œblock-driverâ€]ï¼Œå›å†™å¯¹åº”çš„å­—æ®µï¼ˆSCSIAddr å’Œ VirtPathï¼‰<ol><li>å¦‚æœæœªæŒ‡å®šåˆ™è§†ä¸º virtio-scsiï¼Œæ ¹æ®ç´¢å¼• ID è®¡ç®—å‡º SCSIAddrï¼Œæ ¼å¼ä¸º &lt;index &#x2F; 256&gt;:&lt;index % 256&gt;<br><em>qemu ä»£ç å»ºè®® scsi-id å¯ä»¥å–å€¼ä» 0 åˆ° 255ï¼ˆå«ï¼‰ï¼Œè€Œ lun å¯ä»¥å–å€¼ä» 0 åˆ° 16383ï¼ˆå«ï¼‰ã€‚ ä½†æ˜¯è¶…è¿‡ 255 çš„ lun å€¼ä¼¼ä¹ä¸éµå¾ªä¸€è‡´çš„ SCSI å¯»å€ã€‚ å› æ­¤é™åˆ¶ä¸º 255</em></li><li>å¦‚æœæŒ‡å®šä¸ä¸º nvdimmï¼Œåˆ™æ ¹æ®ç´¢å¼• ID è®¡ç®—å‡º VirtPathï¼Œä¾‹å¦‚ &#x2F;dev&#x2F;vda<br><em>å…¶ä¸­ï¼Œç´¢å¼• 0 å¯¹åº” vdaï¼Œ25 å¯¹åº” vdzï¼Œ27 å¯¹åº” vdabï¼Œ704 å¯¹åº” vdaacï¼Œ18277 å¯¹åº” vdzzz</em></li></ol></li><li>è°ƒç”¨ devReceiver çš„ <strong>HotplugAddDevice</strong>ï¼Œçƒ­æ·»åŠ è®¾å¤‡</li></ol><h3 id="VhostUserBlkDevice"><a href="#VhostUserBlkDevice" class="headerlink" title="VhostUserBlkDevice"></a>VhostUserBlkDevice</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/vhost_user_blk.go#L40">source code</a></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œåç»­å®é™…æ“ä½œ</li><li>æ ¹æ® device.DeviceInfo.DriverOptions[â€œblock-driverâ€]ï¼Œåˆ¤æ–­ block-driver æ˜¯å¦æ˜¯ virtio-blk<br><em>å¦‚æœæœªæŒ‡å®šåˆ™è§†ä¸º virtio-scsiï¼›å¦‚æœæŒ‡å®šä¸º virtio-blkã€virtio-blk-ccw æˆ– virtio-mmio åˆ™è§†ä¸º virtio-blk</em></li><li>å¦‚æœæ˜¯ virtio-blkï¼Œåˆ™è°ƒç”¨ devReceiver çš„ <strong>GetAndSetSandboxBlockIndex</strong>ï¼Œè·å–æœªè¢«ä½¿ç”¨çš„å—ç´¢å¼•ï¼›å¦åˆ™ï¼Œç´¢å¼•é»˜è®¤ä¸º -1</li><li>è°ƒç”¨ devReceiver çš„ <strong>HotplugAddDevice</strong>ï¼Œçƒ­æ·»åŠ è®¾å¤‡</li></ol><h3 id="VhostUserFSDeviceã€VhostUserNetDeviceã€VhostUserSCSIDevice"><a href="#VhostUserFSDeviceã€VhostUserNetDeviceã€VhostUserSCSIDevice" class="headerlink" title="VhostUserFSDeviceã€VhostUserNetDeviceã€VhostUserSCSIDevice"></a>VhostUserFSDeviceã€VhostUserNetDeviceã€VhostUserSCSIDevice</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/vhost_user_fs.go#L25">source code</a></p><p><em>VhostUserFSDeviceã€VhostUserNetDevice å’Œ VhostUserSCSIDevice å®ç°æ–¹å¼ä¸€è‡´ï¼Œä»¥ GenericDevice ä¸ºä¾‹</em></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œåç»­å®é™…æ“ä½œ</li><li>è°ƒç”¨ devReceiver çš„ <strong>AppendDevice</strong>ï¼Œæ·»åŠ è®¾å¤‡</li></ol><h2 id="Detach"><a href="#Detach" class="headerlink" title="Detach"></a>Detach</h2><p><strong>detach è®¾å¤‡</strong></p><p><em>ä¸åŒçš„å®ç°ä¸‹æœªå¿…æ”¯æŒ detach æ“ä½œ</em></p><h3 id="GenericDeviceã€VhostUserFSDeviceã€VhostUserNetDeviceã€VhostUserSCSIDevice"><a href="#GenericDeviceã€VhostUserFSDeviceã€VhostUserNetDeviceã€VhostUserSCSIDevice" class="headerlink" title="GenericDeviceã€VhostUserFSDeviceã€VhostUserNetDeviceã€VhostUserSCSIDevice"></a>GenericDeviceã€VhostUserFSDeviceã€VhostUserNetDeviceã€VhostUserSCSIDevice</h3><p><em>GenericDeviceã€VhostUserFSDeviceã€VhostUserNetDevice å’Œ VhostUserSCSIDevice å®ç°æ–¹å¼ä¸€è‡´ï¼Œä»¥ GenericDevice ä¸ºä¾‹</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/generic.go#L42">source code</a></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œä¸æ‰§è¡Œå®é™…æ“ä½œ</li></ol><h3 id="VFIODevice-1"><a href="#VFIODevice-1" class="headerlink" title="VFIODevice"></a>VFIODevice</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/vfio#L128">source code</a></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œåç»­å®é™…æ“ä½œ</li><li>å¦‚æœè®¾å¤‡æ˜¯å†·æ·»åŠ çš„ï¼Œè¯´æ˜æ²¡æœ‰è¿è¡Œåçš„ attach åŠ¨ä½œï¼Œå› æ­¤åˆ™æ— éœ€ detachï¼›å¦åˆ™ï¼Œè°ƒç”¨ devReceiver çš„ <strong>HotplugRemoveDevice</strong>ï¼Œçƒ­ç§»é™¤è®¾å¤‡</li></ol><h3 id="BlockDevice-1"><a href="#BlockDevice-1" class="headerlink" title="BlockDevice"></a>BlockDevice</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/block.go#L124">source code</a></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œåç»­å®é™…æ“ä½œ</li><li>è°ƒç”¨ devReceiver çš„ <strong>HotplugRemoveDevice</strong>ï¼Œçƒ­ç§»é™¤è®¾å¤‡</li></ol><h3 id="VhostUserBlkDevice-1"><a href="#VhostUserBlkDevice-1" class="headerlink" title="VhostUserBlkDevice"></a>VhostUserBlkDevice</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/drivers/vhost_user_blk.go#L118">source code</a></p><ol><li>è°ƒç”¨ <strong>bumpAttachCount</strong>ï¼Œç»´æŠ¤ attach è®¡æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œåç»­å®é™…æ“ä½œ</li><li>è°ƒç”¨ devReceiver çš„ <strong>HotplugRemoveDevice</strong>ï¼Œçƒ­ç§»é™¤è®¾å¤‡</li><li>æ ¹æ® device.DeviceInfo.DriverOptions[â€œblock-driverâ€]ï¼Œåˆ¤æ–­ block-driver æ˜¯å¦æ˜¯ virtio-blkã€‚å¦‚æœæ˜¯ virtio-blkï¼Œåˆ™è°ƒç”¨ devReceiver çš„ <strong>UnsetSandboxBlockIndex</strong>ï¼Œé‡Šæ”¾è®°å½•çš„ virtio-block ç´¢å¼•<br><em>å¦‚æœæœªæŒ‡å®šåˆ™è§†ä¸º virtio-scsiï¼›å¦‚æœæŒ‡å®šä¸º virtio-blkã€virtio-blk-ccw æˆ– virtio-mmio åˆ™è§†ä¸º virtio-blk</em></li></ol><h1 id="DeviceManager"><a href="#DeviceManager" class="headerlink" title="DeviceManager"></a>DeviceManager</h1><p><em><u>src&#x2F;runtime&#x2F;pkg&#x2F;device&#x2F;api&#x2F;interface.go</u></em></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> deviceManager <span class="keyword">struct</span> &#123;</span><br><span class="line">sync.RWMutex</span><br><span class="line">    </span><br><span class="line"><span class="comment">// VM ä¸­çš„è®¾å¤‡</span></span><br><span class="line">devices <span class="keyword">map</span>[<span class="type">string</span>]api.Device</span><br><span class="line"></span><br><span class="line"><span class="comment">// [hypervisor].block_device_driverï¼Œrootfs å—è®¾å¤‡é©±åŠ¨ï¼Œå¯é€‰æœ‰ virtio-scsiã€virtio-blk å’Œ nvdimm</span></span><br><span class="line">blockDriver <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [hypervisor].vhost_user_store_pathï¼Œé»˜è®¤ä¸º /var/run/kata-containers/vhost-user</span></span><br><span class="line"><span class="comment">// Its sub-path &quot;block&quot; is used for block devices; &quot;block/sockets&quot; is</span></span><br><span class="line"><span class="comment">// where we expect vhost-user sockets to live; &quot;block/devices&quot; is where</span></span><br><span class="line"><span class="comment">// simulated block device nodes for vhost-user devices to live.</span></span><br><span class="line">vhostUserStorePath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [hypervisor].enable_vhost_user_storeï¼Œé»˜è®¤ä¸º false</span></span><br><span class="line"><span class="comment">// Enabling this will result in some Linux reserved block type</span></span><br><span class="line"><span class="comment">// major range 240-254 being chosen to represent vhost-user devices.</span></span><br><span class="line">vhostUserStoreEnabled <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Device ä¸­å£°æ˜çš„ <strong>IsDeviceAttached</strong>ã€<strong>GetDeviceByID</strong> å’Œ <strong>GetAllDevices</strong> ä¸ºå‚æ•°è·å–ï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸ä½œè¯¦è¿°ã€‚</p><h2 id="NewDevice"><a href="#NewDevice" class="headerlink" title="NewDevice"></a>NewDevice</h2><p><strong>åˆå§‹åŒ–è®¾å¤‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/manager/manager.go#L136">source code</a></p><ol><li>å¦‚æœè®¾å¤‡ä¸æ˜¯ pmem ç±»å‹ï¼ˆå³ devInfo.Pmem ä¸º falseï¼‰<ol><li>å¦‚æœå¯ç”¨äº† [hypervisor].enable_vhost_user_storeã€devInfo.DevType ä¸º b å¹¶ä¸”è®¾å¤‡ devInfo.Major æ˜¯ 242ï¼ˆå³ vhost-user-scsiï¼‰æˆ–è€… 241ï¼ˆå³ vhost-user-blkï¼‰ï¼Œåˆ™è·å– &lt;vhostUserStorePath&gt;&#x2F;block&#x2F;devices ç›®å½•ä¸‹ï¼Œæ ¼å¼ä¸º major:minor çš„æ–‡ä»¶åï¼Œä½œä¸º socket æ–‡ä»¶ï¼Œè¿”å› &lt;vhostUserStorePath&gt;&#x2F;block&#x2F;sockets&#x2F;&lt;socket&gt; æ–‡ä»¶è·¯å¾„<br><em>ç”¨äºè·å– vhost-user è®¾å¤‡çš„ä¸»æœºè·¯å¾„ã€‚ å¯¹äº vhost-user å—è®¾å¤‡ï¼Œå¦‚ vhost-user-blk æˆ– vhost-user-scsiï¼Œå…¶ socket åº”ä½äºç›®å½• &lt;vhostUserStorePath&gt;&#x2F;block&#x2F;sockets&#x2F; ä¸‹ï¼Œå®ƒå¯¹åº”çš„è®¾å¤‡èŠ‚ç‚¹åº”è¯¥åœ¨ç›®å½• &lt;vhostUserStorePath&gt;&#x2F;block&#x2F;devices&#x2F; ä¸‹</em></li><li>å¦‚æœ devInfo.DevType ä¸º c æˆ–è€… uï¼Œåˆ™ uevent è·¯å¾„ä¸º &#x2F;sys&#x2F;dev&#x2F;char&#x2F;&lt;major:minor&gt;&#x2F;ueventï¼›å¦‚æœ devInfo.DevType ä¸º bï¼Œåˆ™ uevent è·¯å¾„ä¸º  &#x2F;sys&#x2F;dev&#x2F;block&#x2F;&lt;major:minor&gt;&#x2F;ueventã€‚å¦‚æœ uevent æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› devInfo.ContainerPathï¼Œå¦åˆ™è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆæ–‡ä»¶ä¸º ini æ ¼å¼ï¼‰ï¼Œè§£æ DEVNAME é¡¹ï¼Œè¿”å› &#x2F;dev&#x2F;&lt;DEVNAME &gt; æ–‡ä»¶è·¯å¾„<br><em>æŸäº›è®¾å¤‡ï¼ˆä¾‹å¦‚ &#x2F;dev&#x2F;fuseã€&#x2F;dev&#x2F;cuseï¼‰å¹¶ä¸æ€»æ˜¯åœ¨ &#x2F;sys&#x2F;dev ä¸‹å®ç° sysfs æ¥å£ï¼Œè¿™äº›è®¾å¤‡é»˜è®¤ç”± docker ä¼ é€’ã€‚ åªéœ€è¿”å›åœ¨è®¾å¤‡é…ç½®ä¸­ä¼ é€’çš„è·¯å¾„ï¼Œè¿™ç¡®å®æ„å‘³ç€è¿™äº›è®¾å¤‡ä¸æ”¯æŒè®¾å¤‡é‡å‘½å</em></li><li>è®¾ç½® devInfo.HostPath ä¸ºä¸Šè¿°è¿”å›çš„è·¯å¾„</li></ol></li><li>æ ¹æ® devInfo.Major å’Œ devInfo.Minorï¼Œåˆ¤æ–­è®¾å¤‡æ˜¯å¦å·²ç»å­˜åœ¨ deviceManager çš„ devices ä¸­ï¼Œå­˜åœ¨åˆ™ç›´æ¥è¿”å›å³å¯</li><li>ä¸ºäº†é¿å… deviceID å†²çªï¼Œé‡æ–°ç”Ÿæˆ devInfo.ID</li><li>æ ¹æ®è®¾å¤‡ç±»åˆ«ï¼Œåˆå§‹åŒ–å¯¹åº”çš„è®¾å¤‡<ol><li>å¦‚æœ devInfo.HostPath ä¸º &#x2F;dev&#x2F;vfio&#x2F;xxxï¼ˆæ’é™¤ &#x2F;dev&#x2F;vfio&#x2F;vfio å­—ç¬¦è®¾å¤‡ï¼‰ï¼Œåˆ™è§†ä¸º vfio è®¾å¤‡ç±»å‹</li><li>å¦‚æœ devInfo.DevType ä¸º bï¼Œå¹¶ä¸” devInfo.Major ä¸º 241ï¼Œåˆ™è§†ä¸º vhost-user-blk è®¾å¤‡ç±»å‹</li><li>å¦‚æœ devInfo.DevType ä¸º bï¼Œåˆ™è§†ä¸º block è®¾å¤‡ç±»å‹ï¼ˆä¹Ÿå°±æ˜¯ devInfo.Major ä¸ä¸º 241ï¼‰</li><li>é™¤æ­¤ä¹‹å¤–ï¼Œå‡è§†ä¸º generic è®¾å¤‡ç±»å‹ï¼ˆä¹Ÿå°±æ˜¯ vhost-user-fsã€vhost-user-net å’Œ vhost-user-scsi è®¾å¤‡å‡ä¸ºæ­¤ç±»å‹ï¼‰</li></ol></li><li>è°ƒç”¨ device çš„ <strong>Reference</strong>ï¼Œç»´æŠ¤è®¾å¤‡çš„å¼•ç”¨è®¡æ•°</li><li>ç»´æŠ¤ deviceManager ä¸­çš„è®¾å¤‡ä¿¡æ¯ï¼Œå…¶ä¸­ key ä¸ºè°ƒç”¨ device çš„ <strong>DeviceID</strong> è·å¾—ï¼Œåç»­ç”¨äºåˆ¤æ–­è®¾å¤‡æ˜¯å¦å·²ç»åˆ›å»º</li></ol><h2 id="RemoveDevice"><a href="#RemoveDevice" class="headerlink" title="RemoveDevice"></a>RemoveDevice</h2><p><strong>ç§»é™¤ç»´æŠ¤çš„è®¾å¤‡ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/manager/manager.go#L147">source code</a></p><ol><li>æ ¡éªŒè®¾å¤‡æ˜¯å¦å·²ç»åˆ›å»º</li><li>è°ƒç”¨ device çš„ <strong>Dereference</strong>ï¼Œç§»é™¤å¼•ç”¨</li><li>å¦‚æœç§»é™¤åå¼•ç”¨ä¸º 0ï¼Œåˆ™å¹¶è°ƒç”¨ device çš„ <strong>GetAttachCount</strong>ï¼Œæ ¡éªŒå½“å‰è®¾å¤‡ attach æ¬¡æ•°æ˜¯å¦ä¸º 0ï¼Œç§»é™¤ç»´æŠ¤åœ¨ deviceManager çš„è®¾å¤‡ä¿¡æ¯</li></ol><h2 id="AttachDevice"><a href="#AttachDevice" class="headerlink" title="AttachDevice"></a>AttachDevice</h2><p><strong>attach è®¾å¤‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/manager/manager.go#L181">source code</a></p><ol><li>æ ¡éªŒè®¾å¤‡æ˜¯å¦å·²ç»åˆ›å»º</li><li>è°ƒç”¨ device çš„ <strong>Attach</strong>ï¼Œattach è®¾å¤‡</li></ol><h2 id="DetachDevice"><a href="#DetachDevice" class="headerlink" title="DetachDevice"></a>DetachDevice</h2><p><strong>detach è®¾å¤‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/manager/manager.go#L196">source code</a></p><ol><li>æ ¡éªŒè®¾å¤‡æ˜¯å¦å·²ç»åˆ›å»º</li><li>è°ƒç”¨ device çš„ <strong>GetAttachCount</strong>ï¼Œæ ¡éªŒå½“å‰è®¾å¤‡ attach æ¬¡æ•°æ˜¯å¦ä¸ä¸º 0</li><li>è°ƒç”¨ device çš„ <strong>Detach</strong>ï¼Œdetach è®¾å¤‡</li></ol><h2 id="LoadDevices"><a href="#LoadDevices" class="headerlink" title="LoadDevices"></a>LoadDevices</h2><p><strong>åŠ è½½è®¾å¤‡ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/device/manager/manager.go#L244">source code</a></p><ol><li>éå†å…¥å‚ []config.DeviceState ä¸­æ¯ä¸€ä¸ªè®¾å¤‡ä¿¡æ¯ï¼Œæ ¹æ®å…¶ç±»å‹åˆå§‹åŒ–å¯¹åº”çš„ device å¯¹è±¡</li><li>è°ƒç”¨ device çš„ <strong>Load</strong>ï¼ŒåŠ è½½è®¾å¤‡</li><li>ç»´æŠ¤ deviceManager ä¸­çš„è®¾å¤‡ä¿¡æ¯ï¼Œå…¶ä¸­ key ä¸ºè°ƒç”¨ device çš„ <strong>DeviceID</strong> è·å¾—ï¼Œåç»­ç”¨äºåˆ¤æ–­è®¾å¤‡æ˜¯å¦å·²ç»åˆ›å»º</li></ol>]]></content>
    
    
    <summary type="html">virtcontainers ä¸­ä¸ DeviceReceiverã€Deviceã€DeviceManager ç­‰è®¾å¤‡ç®¡ç†ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” virtcontainers/factory</title>
    <link href="http://shenxianghong.github.io/2023/03/12/2023-03-12%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20factory/"/>
    <id>http://shenxianghong.github.io/2023/03/12/2023-03-12%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20factory/</id>
    <published>2023-03-11T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.271Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><h1 id="Factory"><a href="#Factory" class="headerlink" title="Factory"></a>Factory</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;factory.go</u></em></p><p>Factory ç»§æ‰¿è‡ª FactoryBaseï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äº FactoryBase ç”¨äºåˆ›å»º base VMï¼ˆå³ä¸ºæ¨¡ç‰ˆ VMï¼‰ï¼Œåˆ›å»ºåä¼šå°†å…¶æš‚åœï¼Œè€Œ Factory ä¼šåœ¨ VM ä½¿ç”¨æ—¶å°†å…¶æ¢å¤ï¼Œå¹¶çƒ­æ›´æ–° VM ä»¥æ»¡è¶³è¿è¡Œæ—¶çš„è§„æ ¼è¦æ±‚ã€‚</p><p>FactoryBase æœ‰å››ç§å®ç°ï¼šdirectã€templateã€grpccache å’Œ cacheã€‚ä½†æ˜¯å®ƒä»¬å¹¶ä¸ä¼šå¯¹å¤–æš´éœ²ä½¿ç”¨ï¼Œè€Œæ˜¯åœ¨ Factory çš„å·¥å‚å‡½æ•°ä¸­æ ¹æ®å…·ä½“çš„é…ç½®ç»†èŠ‚åˆå§‹åŒ–å¯¹åº”çš„å®ç°ï¼Œä½œä¸ºç»Ÿä¸€çš„ Factory å¯¹å¤–æä¾›æ¥å£è°ƒç”¨ï¼Œå³ factoryã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> direct <span class="keyword">struct</span> &#123;</span><br><span class="line">config vc.VMConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> grpccache <span class="keyword">struct</span> &#123;</span><br><span class="line">conn   *grpc.ClientConn</span><br><span class="line">config *vc.VMConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> template <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// [factory].template_pathï¼Œé»˜è®¤ä¸º /run/vc/vm/template</span></span><br><span class="line">statePath <span class="type">string</span></span><br><span class="line"></span><br><span class="line">config vc.VMConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> cache <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// cache factory çš„åˆå§‹åŒ–å¿…é¡»åŸºäº template factory æˆ–è€… direct factoryã€‚</span></span><br><span class="line">base base.FactoryBase</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºç»´æŠ¤åˆ›å»ºçš„ VM æ¨¡æ¿</span></span><br><span class="line">vmm <span class="keyword">map</span>[*vc.VM]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">cacheCh   <span class="keyword">chan</span> *vc.VM</span><br><span class="line">closed    <span class="keyword">chan</span>&lt;- <span class="type">int</span></span><br><span class="line">wg        sync.WaitGroup</span><br><span class="line">closeOnce sync.Once</span><br><span class="line">vmmLock   sync.RWMutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VMConfig is a collection of all info that a new blackbox VM needs.</span></span><br><span class="line"><span class="keyword">type</span> VMConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">HypervisorType   HypervisorType</span><br><span class="line">AgentConfig      KataAgentConfig</span><br><span class="line">HypervisorConfig HypervisorConfig</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VMConfig é’ˆå¯¹ VM factory åœºæ™¯ä¸‹ï¼Œèšåˆçš„é…ç½®æ–‡ä»¶ä¸­çš„ç›¸å…³ä¿¡æ¯ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> factory <span class="keyword">struct</span> &#123;</span><br><span class="line">base base.FactoryBase</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å·¥å‚å‡½æ•°</strong></p><p><em>ç›®å‰æ¥çœ‹ï¼Œgrpccache åˆå§‹åŒ–çš„æ¡ä»¶åº”è¯¥ä¸å­˜åœ¨ã€‚æ­¤å¤–ï¼Œå½“å¯ç”¨ VM factory æ—¶ï¼Œå¿…ç„¶æ˜¯ VM template å’Œ VM cache äºŒé€‰ä¸€ï¼Œæ‰€ä»¥ direct ä¸ä¼šä½œä¸º factory ç›´æ¥å¯¹å¤–ä½¿ç”¨ï¼Œè€Œæ˜¯è¿›ä¸€æ­¥åˆå§‹åŒ–æˆ cache factoryã€‚</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/factory.go#L51">source code</a></p><ol><li>æ ¡éªŒ VMConfig é…ç½®çš„åˆæ³•æ€§ï¼Œå…¶ä¸­åŒ…æ‹¬ [hypervisor].kernel æ˜¯å¦ä¸ä¸ºç©ºï¼Œ[hypervisor].image å’Œ [hypervisor].initrd æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªã€‚å¹¶è®¾ç½® [hypervisor].default_vcpus ç¼ºçœæ—¶ä¸º 1ï¼ˆå•ä½ï¼šCoreï¼‰ï¼Œ[hypervisor].default_memory ç¼ºçœæ—¶ä¸º 2048ï¼ˆå•ä½ï¼šMiBï¼‰</li><li>å½“å¯ç”¨ VM template æ—¶ï¼ˆå³ [factory].enable_template ä¸º trueï¼‰ï¼Œåˆ™åˆå§‹åŒ– template factory<ol><li>å¦‚æœ fetchOnly ä¸º trueï¼Œåˆ™æ ¡éªŒ [factory].template_path ç›®å½•ï¼ˆé»˜è®¤ä¸º &#x2F;run&#x2F;vc&#x2F;vm&#x2F;templateï¼‰ä¸‹æ˜¯å¦å­˜åœ¨ state å’Œ memory æ–‡ä»¶</li><li>å¦‚æœ fetchOnly ä¸º falseï¼Œåˆ™åˆå§‹åŒ– template factory<ol><li>æ ¡éªŒ [factory].template_path ç›®å½•ä¸‹æ˜¯å¦ä¸å­˜åœ¨ state å’Œ memory æ–‡ä»¶</li><li>åˆ›å»º [factory].template_path ç›®å½•ï¼Œå°† tmps æŒ‚è½½åˆ°æ­¤ç›®å½•ä¸‹ï¼Œå¤§å°ä¸º [hypervisor].default_memory + 8 MiBï¼ˆamd64 æ¶æ„ä¸‹ä¸º 8 MiBï¼›arm64 æ¶æ„ä¸‹ä¸º 300 MiBï¼‰ï¼Œå¹¶åœ¨æ­¤ç›®å½•ä¸‹åˆ›å»º memory æ–‡ä»¶</li><li>è°ƒç”¨ <strong>NewVM</strong>ï¼ŒåŸºäº VMConfig åˆ›å»º VMï¼ˆåˆ›å»ºååˆ™ä½œä¸ºæ¨¡ç‰ˆ VMï¼‰</li><li>è°ƒç”¨ agent çš„ <strong>disconnect</strong>ï¼Œæ–­å¼€ä¸ agent çš„é“¾æ¥</li><li>è°ƒç”¨ hypervisor çš„ <strong>PauseVM</strong>ï¼Œæš‚åœ VM</li><li>è°ƒç”¨ hypervisor çš„ <strong>SaveVM</strong>ï¼Œä¿å­˜ VM åˆ°ç£ç›˜æ–‡ä»¶</li><li>è°ƒç”¨ hypervisor çš„ <strong>StopVM</strong>ï¼Œå…³åœ VM</li><li>è°ƒç”¨ store çš„ <strong>Destroy</strong>ï¼Œåˆ é™¤çŠ¶æ€æ•°æ®ç›®å½•</li></ol></li></ol></li><li>å½“å¯ç”¨ VM cache æ—¶ï¼ˆå³ [factory].vm_cache_number å¤§äº 0ï¼‰ï¼Œåˆ™åˆå§‹åŒ– cache factory<ol><li>åˆå§‹åŒ– direct factoryï¼ˆcache factory çš„åˆå§‹åŒ–å¿…é¡»ä¾èµ–å…¶ä»– factoryï¼‰</li><li>åå¤è°ƒç”¨ <strong>GetBaseVM</strong>ï¼ˆdirect.GetBaseVMï¼‰ï¼Œç›´è‡³åˆ›å»ºæš‚åœçŠ¶æ€çš„ VM æ•°é‡ç­‰äº [factory].vm_cache_number</li><li>å°†è¿™äº›äº‹å…ˆåˆ›å»ºå¥½çš„ base VM ç»´æŠ¤åœ¨ cache ä¸­<br>*åç»­éœ€è¦æ—¶é€šè¿‡ <strong>GetBaseVM</strong>ï¼ˆcache.GetBaseVMï¼‰ï¼Œè·å– base VMï¼Œå¹¶é€šè¿‡ <strong>GetVM</strong> çƒ­æ›´æ–°*</li></ol></li></ol><h2 id="NewVM"><a href="#NewVM" class="headerlink" title="NewVM"></a>NewVM</h2><p><strong>åŸºäº VMConfig åˆ›å»º VM</strong></p><p><em>NewVM å¹¶é FactoryBase å®šä¹‰æ¥å£ï¼Œè€Œæ˜¯ virtcontainers æä¾›çš„ä¸€ä¸ªåŸºäº VMConfig åˆ›å»º VM çš„å·¥å‚å‡½æ•°ï¼Œä»…ç”¨äº factory ç›¸å…³æµç¨‹</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/vm.go#L85">source code</a></p><ol><li>æ ¡éªŒ VMConfig é…ç½®çš„åˆæ³•æ€§ï¼Œå…¶ä¸­åŒ…æ‹¬ [hypervisor].kernel æ˜¯å¦ä¸ä¸ºç©ºï¼Œ[hypervisor].image å’Œ [hypervisor].initrd æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªã€‚å¹¶è®¾ç½® [hypervisor].default_vcpus ç¼ºçœæ—¶ä¸º 1ï¼Œ[hypervisor].default_memory ç¼ºçœæ—¶ä¸º 2048</li><li>åˆå§‹åŒ– hypervisor å’Œ agent</li><li>è°ƒç”¨ hypervisor çš„ <strong>CreateVM</strong>ï¼Œåˆ›å»ºä¸€ä¸ªä¸å«ç½‘ç»œä¿¡æ¯çš„ VM</li><li>è°ƒç”¨ agent çš„ <strong>configure</strong> å’Œ <strong>setAgentURL</strong>ï¼Œé…ç½® agent ç›¸å…³ä¿¡æ¯</li><li>è°ƒç”¨ hypervisor çš„ <strong>StartVM</strong>ï¼Œå¯åŠ¨ VM</li><li>å¦‚æœ VM ä¸æ˜¯ä» template å¯åŠ¨ï¼ˆå› ä¸ºä» template å¯åŠ¨çš„ VMï¼Œä¼šè¿›å…¥ pause çŠ¶æ€ï¼‰ï¼Œåˆ™è°ƒç”¨ agent çš„ <strong>check</strong>ï¼Œæ£€æµ‹æœåŠ¡å­˜æ´»æ€§</li></ol><h2 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h2><p><strong>è·å– base factory çš„é…ç½®ä¿¡æ¯</strong></p><p><em>cacheã€directã€grpccache å’Œ template å®ç°æ–¹å¼ç›¸åŒã€‚</em> </p><ol><li>è¿”å› VMConfig</li></ol><h2 id="GetVMStatus"><a href="#GetVMStatus" class="headerlink" title="GetVMStatus"></a>GetVMStatus</h2><p><strong>è·å– base VM çš„çŠ¶æ€ä¿¡æ¯</strong></p><p><em>directã€grpccache å’Œ template å®ç°ä¸‹å‡ä¸æ”¯æŒæ­¤æ¥å£ï¼Œä¼šè§¦å‘ panicã€‚</em></p><h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/cache/cache.go#L98">source code</a></p><ol><li>é’ˆå¯¹ cache ä¸­ç¼“å­˜çš„æ¯ä¸€ä¸ª VMï¼Œè·å–å…¶ CPU å’Œå†…å­˜å¤§å°ï¼ˆå³é…ç½®ä¸­å£°æ˜çš„é»˜è®¤å¤§å°ï¼‰ï¼Œå¹¶è°ƒç”¨ hypervisor çš„ <strong>GetPids</strong>ï¼Œè·å–ç›¸å…³çš„ PID</li></ol><h2 id="GetBaseVM"><a href="#GetBaseVM" class="headerlink" title="GetBaseVM"></a>GetBaseVM</h2><p><strong>è·å– base VM</strong></p><h3 id="direct"><a href="#direct" class="headerlink" title="direct"></a>direct</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/direct/direct.go#L32">source code</a></p><ol><li>è°ƒç”¨ <strong>NewVM</strong>ï¼Œåˆ›å»º VM</li><li>è°ƒç”¨ hypervisor çš„ <strong>PauseVM</strong>ï¼Œå°†å…¶æš‚åœå¹¶è¿”å›</li></ol><h3 id="template"><a href="#template" class="headerlink" title="template"></a>template</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/template/template.go#L76">source code</a></p><ol><li>è°ƒç”¨ <strong>NewVM</strong>ï¼Œåˆ›å»º VMï¼ˆè¯¥ VM åŸºäºæ¨¡ç‰ˆåˆ›å»ºï¼Œåˆ›å»ºåä¸ä½œä¸ºæ¨¡ç‰ˆ VMï¼‰</li></ol><h3 id="grpccache"><a href="#grpccache" class="headerlink" title="grpccache"></a>grpccache</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/grpccache/grpccache.go#L53">source code</a></p><ol><li>gRPC è°ƒç”¨ cache server çš„ <strong>GetBaseVM</strong>ï¼Œè·å– VM</li><li>è°ƒç”¨ hypervisor çš„ <strong>fromGrpc</strong>ï¼Œé…ç½® hypervisor ä¿¡æ¯</li><li>è°ƒç”¨ agent çš„ <strong>configureFromGrpc</strong>ï¼Œé…ç½® agent ä¿¡æ¯</li><li>åŸºäºé…ç½®åçš„ hypervisorã€agent å’Œ gRPC è¿”å›ä½“æ„å»ºå¹¶è¿”å› VM</li></ol><h3 id="cache-1"><a href="#cache-1" class="headerlink" title="cache"></a>cache</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/cache/cache.go#L112">source code</a></p><ol><li>ä»ç¼“å­˜çš„ base VM ä¸­è¿”å›ä¸€ä¸ª</li></ol><h2 id="CloseFactory"><a href="#CloseFactory" class="headerlink" title="CloseFactory"></a>CloseFactory</h2><p><strong>å…³é—­å¹¶é”€æ¯ factory</strong></p><p><em>directã€grpccache å®ç°ä¸‹æ­¤æ¥å£ä¸åšä»»ä½•å¤„ç†ï¼Œç›´æ¥è¿”å›å³å¯ã€‚</em></p><h3 id="template-1"><a href="#template-1" class="headerlink" title="template"></a>template</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/template/template.go#L81">source code</a></p><ol><li>ç§»é™¤ [factory].template_path æŒ‚è½½ç‚¹ï¼ˆé»˜è®¤ä¸º &#x2F;run&#x2F;vc&#x2F;vm&#x2F;templateï¼‰ï¼Œå¹¶åˆ é™¤æ­¤ç›®å½•</li></ol><h3 id="cache-2"><a href="#cache-2" class="headerlink" title="cache"></a>cache</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/cache/cache.go#L121">source code</a></p><ol><li>è°ƒç”¨ base factory çš„ <strong>ClostFactory</strong>ï¼Œå…³é—­ factory<br><em>å¦‚ä¸Šæ‰€è¿°ï¼Œcache factory ä¹Ÿå°±æ˜¯è°ƒç”¨ direct factory çš„ CloseFactory</em></li></ol><h2 id="GetVM"><a href="#GetVM" class="headerlink" title="GetVM"></a>GetVM</h2><p><strong>çƒ­æ›´æ–° base VM ä»¥æ»¡è¶³éœ€æ±‚</strong></p><p><em>GetVM ä¸æ˜¯ base factory çš„æ¥å£ï¼Œè€Œæ˜¯ factory çš„æ¥å£<br>GetVM æ¥å—ä¸€ä¸ª VMConfig ç±»å‹çš„å‚æ•°ï¼Œè¯¥å‚æ•°æè¿°äº†é¢„æœŸçš„ VM é…ç½®ï¼ˆä¸‹ç§° newConfigï¼‰ï¼Œè€Œ factory å®ç°ä¸­çš„ VMConfig æ˜¯ base VM çš„é…ç½®ï¼ˆä¸‹ç§° baseConfigï¼‰ï¼Œä¸¤è€…çš„å·®å¼‚ç‚¹è¡¥é½ä¾¿æ˜¯ GetVM æ“ä½œçš„æ ¸å¿ƒé€»è¾‘</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/factory/factory.go#L145">source code</a></p><ol><li>æ ¡éªŒ newConfig é…ç½®çš„åˆæ³•æ€§ï¼Œå…¶ä¸­åŒ…æ‹¬ [hypervisor].kernel æ˜¯å¦ä¸ä¸ºç©ºï¼Œ[hypervisor].image å’Œ [hypervisor].initrd æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªã€‚å¹¶è®¾ç½® [hypervisor].default_vcpus ç¼ºçœæ—¶ä¸º 1ï¼Œ[hypervisor].default_memory ç¼ºçœæ—¶ä¸º 2048</li><li>è°ƒç”¨ <strong>Config</strong>ï¼Œè·å– baseConfig ä¿¡æ¯ï¼Œæ ¡éªŒä¸¤ä¸ªé…ç½®ä¿¡æ¯æ˜¯å¦å¹¶ä¸å†²çª</li><li>è°ƒç”¨ <strong>GetBaseVM</strong>ï¼Œè·å– base VM</li><li>è°ƒç”¨ hypervisor çš„ <strong>ResumeVM</strong>ï¼Œå°† VM ä»æš‚åœçŠ¶æ€æ¢å¤</li><li>å€ŸåŠ© &#x2F;dev&#x2F;urandom é‡æ–°ç”Ÿæˆéšæœºç†µï¼Œè°ƒç”¨ agent çš„ <strong>reseedRNG</strong>ï¼Œä¸º guest å†…å­˜é‡æ–°ç”Ÿæˆéšæœºæ•°</li><li>ä¸ºäº†è¡¥é½ VM çš„æš‚åœæ—¶é—´ï¼Œè°ƒç”¨ agent çš„ <strong>setGuestDateTime</strong>ï¼ŒåŒæ­¥ host æ—¶é—´è‡³ guest ä¸­</li><li>å¦‚æœ base VM ä¸­çš„ CPU æ•°é‡å°äºæœŸæœ›é…ç½®ä¸­çš„ CPU æ•°é‡ï¼Œåˆ™è°ƒç”¨ hypervisor çš„ <strong>HotplugAddDevice</strong>ï¼Œçƒ­æ·»åŠ å·®å€¼ CPUï¼›å†…å­˜åŒç†</li><li>å½“æœ‰ CPU æˆ–å†…å­˜çš„çƒ­æ·»åŠ åŠ¨ä½œåï¼Œè°ƒç”¨ agent çš„ <strong>onlineCPUMem</strong>ï¼Œé€šçŸ¥ agent ä¸Šçº¿èµ„æº</li></ol><h1 id="Cache-Server"><a href="#Cache-Server" class="headerlink" title="Cache Server"></a>Cache Server</h1><p><em><u>src&#x2F;runtime&#x2F;protocols&#x2F;cachecache.pb.go</u></em></p><p>cache server å¹¶éé»˜è®¤å¯åŠ¨çš„ gRPC æœåŠ¡ï¼Œè€Œæ˜¯åœ¨ VM Cache ç‰¹æ€§å¯ç”¨æ—¶ï¼Œé€šè¿‡ kata-runtime factory init å‘½ä»¤å¯åŠ¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> cacheServer <span class="keyword">struct</span> &#123;</span><br><span class="line">rpc     *grpc.Server</span><br><span class="line">factory vc.Factory</span><br><span class="line">done    <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨å‡½æ•°</strong></p><p> <a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/factory.go#L148">source code</a></p><ol><li>åŸºäºé…ç½®ï¼Œåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ factoryï¼ˆå³ fetchOnly ä¸º falseï¼‰</li><li>å¯åŠ¨ gRPC æœåŠ¡ï¼Œç›‘å¬ [factory].vm_cache_endpoint åœ°å€ï¼ˆé»˜è®¤ä¸º &#x2F;var&#x2F;run&#x2F;kata-containers&#x2F;cache.sockï¼‰</li></ol><h2 id="Config-1"><a href="#Config-1" class="headerlink" title="Config"></a>Config</h2><p><strong>è·å– base factory çš„é…ç½®ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/factory.go#L54">source code</a></p><ol><li><p>è¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GrpcVMConfig <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// VMConfig</span></span><br><span class="line">Data                 []<span class="type">byte</span></span><br><span class="line"><span class="comment">// VMConfig.AgentConfig </span></span><br><span class="line">AgentConfig          []<span class="type">byte</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ factory çš„ <strong>Config</strong>ï¼Œè·å– base factory çš„é…ç½®ä¿¡æ¯<br><em>ç”±äº base factory åœ¨ cache server å¯åŠ¨åä¾¿å›ºå®šè§„æ ¼ï¼Œå› æ­¤åœ¨é¦–æ¬¡è°ƒç”¨åï¼Œä¼šä¿å­˜é…ç½®ä¿¡æ¯ï¼Œä¹‹åçš„è°ƒç”¨ç›´æ¥è¿”å›å³å¯</em></p></li></ol><h2 id="GetBaseVM-1"><a href="#GetBaseVM-1" class="headerlink" title="GetBaseVM"></a>GetBaseVM</h2><p><strong>è·å– base VM</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/factory.go#L69">source code</a></p><ol><li><p>è¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GrpcVM <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// VM.id</span></span><br><span class="line">Id                   <span class="type">string</span></span><br><span class="line"><span class="comment">// VM.hypervisor.toGrpc</span></span><br><span class="line">Hypervisor           []<span class="type">byte</span></span><br><span class="line">ProxyPid             <span class="type">int64</span></span><br><span class="line">ProxyURL             <span class="type">string</span></span><br><span class="line"><span class="comment">// VM.cpu</span></span><br><span class="line">Cpu                  <span class="type">uint32</span></span><br><span class="line"><span class="comment">// VM.memory</span></span><br><span class="line">Memory               <span class="type">uint32</span></span><br><span class="line"><span class="comment">// VM.cpuDelta</span></span><br><span class="line">CpuDelta             <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ factory çš„ <strong>Config</strong>ï¼Œè·å– base factory çš„é…ç½®ä¿¡æ¯</p></li><li><p>è°ƒç”¨ factory çš„ <strong>GetBaseVM</strong>ï¼Œè·å– base VM</p></li></ol><h2 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h2><p><strong>è·å– base VM çš„çŠ¶æ€ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/factory.go#L95">source code</a></p><ol><li><p>è¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> GrpcStatus <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å½“å‰è¿›ç¨‹çš„ PID</span></span><br><span class="line">Pid                  <span class="type">int64</span></span><br><span class="line"><span class="comment">// factory.GetVMStatus çš„è¿”å›ç»“æœ</span></span><br><span class="line">Vmstatus             []*GrpcVMStatus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ factory çš„ <strong>GetVMStatus</strong>ï¼Œè·å– base VM çš„çŠ¶æ€ä¿¡æ¯</p></li></ol><h2 id="Quit"><a href="#Quit" class="headerlink" title="Quit"></a>Quit</h2><p><strong>å…³é—­ cache server</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/factory.go#L86">source code</a></p><ol><li>1 ç§’é’Ÿåï¼Œå…³é—­ cache gRPC server</li></ol>]]></content>
    
    
    <summary type="html">virtcontainers ä¸­ä¸ Factoryã€CacheServer ç­‰å·¥å‚æ¨¡å¼ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” virtcontainers/storage</title>
    <link href="http://shenxianghong.github.io/2023/03/05/2023-03-05%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20storage/"/>
    <id>http://shenxianghong.github.io/2023/03/05/2023-03-05%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers%20storage/</id>
    <published>2023-03-04T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.270Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><h1 id="PersistDriver"><a href="#PersistDriver" class="headerlink" title="PersistDriver"></a>PersistDriver</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;persist&#x2F;api&#x2F;interface.go</u></em></p><p>PersistDriverï¼ˆä¹Ÿç§° storeï¼‰çš„å®ç°æœ‰ä¸¤ç±»ï¼šfs å’Œ rootlessï¼Œå…¶ä¸­ rootlessfs driver å®Œå…¨ç»§æ‰¿ fs driverã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FS <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// åŒ…æ‹¬ä¸¤ç§ï¼Œfs å’Œ rootlessï¼ŒåŒºåˆ«åœ¨äºå½“å‰æ˜¯å¦ä¸º root ç”¨æˆ·æƒé™</span></span><br><span class="line">driverName <span class="type">string</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// - fsï¼š/run/vc</span></span><br><span class="line"><span class="comment">// - rootlessï¼š&lt;XDG_RUNTIME_DIR&gt;/run/vcï¼ˆXDG_RUNTIME_DIR é»˜è®¤ä¸º /run/user/&lt;UID&gt;</span></span><br><span class="line"><span class="comment">// ç”¨äºä¿å­˜ sandboxï¼ˆsbsï¼Œå…¶ä¸­å®¹å™¨ä¿¡æ¯ä»¥å­ç›®å½•å½¢å¼ä¿å­˜ï¼‰å’Œ VMï¼ˆvmï¼‰ç›¸å…³çŠ¶æ€ä¿¡æ¯</span></span><br><span class="line">storageRootPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…å­˜çŠ¶æ€æ•°æ®ï¼Œç”¨äºå†…å­˜æ•°æ®å’Œæ–‡ä»¶æ•°æ®çš„æŒä¹…åŒ–è½¬æ¢</span></span><br><span class="line">sandboxState   *persistapi.SandboxState</span><br><span class="line">containerState <span class="keyword">map</span>[<span class="type">string</span>]persistapi.ContainerState</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RootlessFS <span class="keyword">struct</span> &#123;</span><br><span class="line">*FS</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>ä»¥ä¸‹æ¥å£ fs å’Œ rootlessfs å®ç°æ–¹å¼å®Œå…¨ä¸€æ ·ã€‚</em></p><h2 id="ToDisk"><a href="#ToDisk" class="headerlink" title="ToDisk"></a>ToDisk</h2><p><strong>ä¿å­˜ sandbox å’Œå®¹å™¨çŠ¶æ€ä¿¡æ¯åˆ°æ–‡ä»¶ä¸­</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/persist/fs/fs.go#L77">source code</a></p><ol><li>ä»¥å½“å‰ç”¨æˆ·ç»„ä¿¡æ¯åˆ›å»º &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt; ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</li><li>åˆ›å»º &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt;&#x2F;persist.json æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼Œå†™å…¥ sandbox çŠ¶æ€ä¿¡æ¯</li><li>éå†æ‰€æœ‰çš„å®¹å™¨çŠ¶æ€ä¿¡æ¯<ol><li>ä»¥å½“å‰ç”¨æˆ·ç»„ä¿¡æ¯åˆ›å»º &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt;&#x2F;&lt;containerID&gt; ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</li><li>åˆ›å»º &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt;&#x2F;&lt;containerID&gt;&#x2F;persist.json æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼Œå†™å…¥å®¹å™¨çŠ¶æ€ä¿¡æ¯</li></ol></li><li>éå† &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt; ç›®å½•ï¼ˆç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•åç§°å‡ä¸º containerIDï¼‰ï¼Œç”±äºæ­¥éª¤ 3 ä¸­ä¸ºå½“å‰å…¨é‡çš„å®¹å™¨çŠ¶æ€ä¿¡æ¯ï¼Œä»¥æ­¤ä¸ºå‡†ç§»é™¤ä¸å­˜åœ¨çš„å®¹å™¨ç›®å½•</li></ol><h2 id="FromDisk"><a href="#FromDisk" class="headerlink" title="FromDisk"></a>FromDisk</h2><p><strong>è¯»å–å†™å…¥æ–‡ä»¶ä¸­çš„ sandbox å’Œå®¹å™¨çŠ¶æ€ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/persist/fs/fs.go#L170">source code</a></p><ol><li>è¯»å– &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt;&#x2F;persist.json æ–‡ä»¶å†…å®¹ï¼Œè·å– sandbox çŠ¶æ€ä¿¡æ¯</li><li>éå† &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt; ç›®å½•ï¼ˆç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•åç§°å‡ä¸º containerIDï¼‰ï¼Œè¯»å– &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt;&#x2F;&lt;containerID&gt;&#x2F;persist.json æ–‡ä»¶å†…å®¹ï¼Œè·å–å®¹å™¨çŠ¶æ€ä¿¡æ¯</li></ol><h2 id="Destroy"><a href="#Destroy" class="headerlink" title="Destroy"></a>Destroy</h2><p><strong>åˆ é™¤ sandbox çŠ¶æ€ä¿¡æ¯ç›®å½•</strong></p><p><em>å› ä¸º sandbox å’Œå®¹å™¨çŠ¶æ€ä¿¡æ¯ç›®å½•ä¹‹é—´ä¸ºçˆ¶å­ç›®å½•å…³ç³»ï¼Œåˆ é™¤çˆ¶ç›®å½•å³å¯</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/persist/fs/fs.go#L228">source code</a></p><ol><li>åˆ é™¤ &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt; ç›®å½•</li></ol><h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><p><strong>å¯¹ sandbox çŠ¶æ€ä¿¡æ¯ç›®å½•ä¸Šé”</strong></p><p><em>å› ä¸º sandbox å’Œå®¹å™¨çŠ¶æ€ä¿¡æ¯ç›®å½•ä¹‹é—´ä¸ºçˆ¶å­ç›®å½•å…³ç³»ï¼Œå¯¹çˆ¶ç›®å½•ä¸Šé”å³å¯</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/persist/fs/fs.go#L244">source code</a></p><ol><li>è°ƒç”¨ syscall.Flockï¼Œå¯¹ &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt; ç›®å½•ä¸Šå…±äº«é”æˆ–æ’ä»–é”ï¼ˆæ ¹æ®å‡½æ•°ä¼ å‚è€Œå®šï¼‰</li><li>è¿”å›ä¸€ä¸ªè°ƒç”¨ syscall.Flock çš„å‡½æ•°ä½“ï¼Œå¯¹ &lt;RunStoragePath&gt;&#x2F;&lt;sandboxID&gt; ç›®å½•é‡Šæ”¾é”ï¼ˆå³ syscall.LOCK_UNï¼‰</li></ol><h2 id="GlobalWrite"><a href="#GlobalWrite" class="headerlink" title="GlobalWrite"></a>GlobalWrite</h2><p><strong>åœ¨çŠ¶æ€ä¿¡æ¯ç›®å½•ä¸­çš„æ–‡ä»¶å†™å…¥å†…å®¹</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/persist/fs/fs.go#L282">source code</a></p><ol><li>ä»¥å½“å‰ç”¨æˆ·ç»„ä¿¡æ¯åˆ›å»º &lt;storageRootPath&gt;&#x2F;&lt;relativePath&gt; ï¼ˆrelativePath ä¸ºå‡½æ•°ä¼ å‚ä¸­çš„å¾…å†™å…¥å†…å®¹çš„ç›¸å¯¹è·¯å¾„ï¼‰æ‰€åœ¨ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</li><li>åˆ›å»º &lt;storageRootPath&gt;&#x2F;&lt;relativePath&gt; æ–‡ä»¶ï¼Œå†™å…¥æ•°æ®</li></ol><h2 id="GlobalRead"><a href="#GlobalRead" class="headerlink" title="GlobalRead"></a>GlobalRead</h2><p><strong>è¯»å–çŠ¶æ€ä¿¡æ¯ç›®å½•ä¸­çš„æ–‡ä»¶å†…å®¹</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/persist/fs/fs.go#L315">source code</a></p><ol><li>è¯»å– &lt;storageRootPath&gt;&#x2F;&lt;relativePath&gt; æ–‡ä»¶å†…å®¹</li></ol><h2 id="RunStoragePath"><a href="#RunStoragePath" class="headerlink" title="RunStoragePath"></a>RunStoragePath</h2><p><strong>è·å– sandbox çŠ¶æ€ä¿¡æ¯ç›®å½•</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/persist/fs/fs.go#L337">source code</a></p><ol><li>è¿”å› &lt;storageRootPath&gt;&#x2F;sbs è·¯å¾„</li></ol><h2 id="RunVMStoragePath"><a href="#RunVMStoragePath" class="headerlink" title="RunVMStoragePath"></a>RunVMStoragePath</h2><p><strong>è·å– vm çŠ¶æ€ä¿¡æ¯ç›®å½•</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/persist/fs/fs.go#L341">source code</a></p><ol><li>è¿”å› &lt;storageRootPath&gt;&#x2F;vm è·¯å¾„</li></ol><h1 id="FilesystemSharer"><a href="#FilesystemSharer" class="headerlink" title="FilesystemSharer"></a>FilesystemSharer</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;fs_share.go</u></em></p><p>FilesystemSharerï¼ˆä¹Ÿç§° fsSharerï¼‰ä»…æœ‰ linux æ“ä½œç³»ç»Ÿä¸‹çš„å®ç°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FilesystemShare <span class="keyword">struct</span> &#123;</span><br><span class="line">sandbox *Sandbox</span><br><span class="line">sync.Mutex</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è¡¨ç¤ºæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å‡†å¤‡å°±ç»ªï¼Œåœ¨è°ƒç”¨ Prepare åï¼Œè®¾ç½®ä¸º true</span></span><br><span class="line">prepared <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="bindMount"><a href="#bindMount" class="headerlink" title="bindMount"></a>bindMount</h2><p><strong>å°† src ç»‘å®šæŒ‚è½½åˆ° dst</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/mount.go#L257">source code</a></p><ol><li>å¤„ç† src ä¸­çš„ç¬¦å·é“¾æ¥ï¼Œè·å¾—ç»å¯¹è·¯å¾„ï¼Œæ ¡éªŒå…¶æ˜¯å¦å­˜åœ¨</li><li>åˆ›å»º dst çš„çˆ¶ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</li><li>æ ¹æ® src çš„æ ¼å¼ï¼ˆç›®å½•æˆ–æ–‡ä»¶ï¼‰ï¼Œåˆ›å»º dst</li><li>å°† src ä»¥ MS_BIND çš„å±æ€§ç»‘å®šæŒ‚è½½åˆ° dst ä¸‹<br><em>ç­‰ä»·äº mount â€“bind foo barï¼Œä¹Ÿå°±æ˜¯æŠŠ foo ç›®å½•ç»‘å®šæŒ‚è½½åˆ° bar ç›®å½•ï¼Œbar ç›®å½•ä¸º foo ç›®å½•çš„é•œåƒæŒ‚è½½ç‚¹ã€‚ç»‘å®šåçš„ä¸¤ä¸ªç›®å½•ç±»ä¼¼äºç¡¬é“¾æ¥ï¼Œæ— è®ºè¯»å†™ bar è¿˜æ˜¯è¯»å†™ fooï¼Œéƒ½ä¼šååº”åœ¨å¦ä¸€æ–¹ï¼Œå†…æ ¸åœ¨åº•å±‚æ‰€æ“ä½œçš„éƒ½æ˜¯åŒä¸€ä¸ªç‰©ç†ä½ç½®ã€‚å°† bar å¸è½½åï¼Œbar ç›®å½•å›å½’åŸå§‹ç©ºç›®å½•çŠ¶æ€ï¼ŒæœŸé—´æ‰€æ‰§è¡Œçš„ä¿®æ”¹éƒ½ä¿ç•™åœ¨ foo ç›®å½•ä¸‹</em></li><li>æ›´æ”¹ dst ç›®å½•æŒ‚è½½å±æ€§ï¼ˆå³ MS_SHAREDã€MS_PRIVATEã€MS_SLAVE å’Œ MS_UNBINDABLEï¼‰<br><em>ç­‰ä»·äº mount â€“make-slave barï¼Œä¹Ÿå¯ä»¥å’Œæ­¥éª¤ 4 åˆå¹¶æ“ä½œ mount â€“make-slave â€“bind foo barã€‚å•å‘ä¼ æ’­æ¨¡å¼ä¸‹ï¼Œåœ¨ foo ä¸‹æ·»åŠ æˆ–ç§»é™¤å­æŒ‚è½½ç‚¹ï¼Œä¼šåŒæ­¥åˆ° bar æŒ‚è½½ç‚¹ï¼Œè€Œåœ¨ bar ä¸‹æ·»åŠ æˆ–ç§»é™¤å­æŒ‚è½½ç‚¹ï¼Œä¸ä¼šå½±å“ foo</em></li><li>å¦‚æœæŒ‚è½½ä¸ºåªè¯»å±æ€§ï¼Œåˆ™è¿½åŠ è‡³ç»‘å®šæŒ‚è½½å±æ€§ä¸­<br><em>ç­‰ä»·äº mount â€“read-only â€“bind foo bar</em></li></ol><h2 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h2><p><strong>å‡†å¤‡ host&#x2F;guest çš„å…±äº«æ–‡ä»¶ç³»ç»Ÿç›®å½•</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/fs_share_linux.go#L127">source code</a></p><ol><li>åˆ›å»º &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;shared ç›®å½•ï¼ˆç”¨äº 9p&#x2F;virtiofs åœ¨ host å’Œ guest ä¹‹é—´å…±äº«æ•°æ®ï¼‰</li><li>åˆ›å»º &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts ç›®å½•ï¼ˆç”¨äºç»´æŠ¤æ‰€æœ‰ host å’Œ guest ä¹‹é—´çš„æŒ‚è½½ç‚¹ï¼‰</li><li>è°ƒç”¨ <strong>bindMount</strong>ï¼Œå°† mounts ç›®å½•ä»¥åªè¯»å’Œ MS_SLAVE çš„å±æ€§ç»‘å®šæŒ‚è½½åˆ° shared ç›®å½•ä¸‹ï¼ˆä¸ºäº†åé¢ mounts æŒ‚è½½ç‚¹ä¸‹çš„å­æŒ‚è½½ä¹Ÿèƒ½å‡ºç°åœ¨ shared ä¸­ï¼‰</li><li>å¤„ç† [runtime]. sandbox_bind_mounts æŒ‚è½½ç‚¹<ol><li>åˆ›å»º &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;sandbox-mounts ç›®å½•</li><li>é’ˆå¯¹ sandbox_bind_mounts ç›®å½•ä¸­çš„æ¯ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œè°ƒç”¨ <strong>bindMount</strong>ï¼Œä»¥åªè¯»å’Œ MS_PRIVATE çš„å±æ€§ç»‘å®šæŒ‚è½½åˆ° &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;sandbox-mounts&#x2F;&lt;sandbox_bind_mounts&gt; ä¸­ï¼Œå¹¶è¿½åŠ  &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;shared&#x2F;sandbox-mounts&#x2F;&lt;sandbox_bind_mounts&gt; ç»‘å®šæŒ‚è½½çš„åªè¯»å±æ€§</li></ol></li><li>è®¾ç½® prepared ä¸º trueï¼Œè¡¨ç¤ºå…±äº«æ–‡ä»¶ç³»ç»Ÿå·²å°±ç»ªï¼ˆæ ‡è¯†ä½ä¹Ÿç”¨äºä¿è¯ Prepare å’Œ Cleanup æ“ä½œçš„å¹‚ç­‰æ€§ï¼‰</li></ol><h2 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h2><p><strong>æ¸…ç† host&#x2F;guest çš„å…±äº«æ–‡ä»¶ç³»ç»Ÿç›®å½•</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/fs_share_linux.go#L180">source code</a></p><ol><li>å¤„ç† [runtime]. sandbox_bind_mounts æŒ‚è½½ç‚¹<ol><li>é’ˆå¯¹ sandbox_bind_mounts ç›®å½•ä¸­çš„æ¯ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œç§»é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;sandbox-mounts&#x2F;&lt;sandbox_bind_mounts&gt; æŒ‚è½½ç‚¹</li><li>åˆ é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;sandbox-mounts ç›®å½•</li></ol></li><li>ç§»é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;shared æŒ‚è½½ç‚¹</li><li>ç§»é™¤ sandbox ä¸­æ‰€æœ‰å®¹å™¨çš„æŒ‚è½½ç‚¹ã€‚å¦‚æœå®¹å™¨ rootfs çš„ç±»å‹ä¸º fuse.nydus-overlayfsï¼Œåˆ™ç§»é™¤ &#x2F;rafs&#x2F;&lt;containerID&gt;&#x2F;lowerdir virtiofs æŒ‚è½½ç‚¹ï¼Œç§»é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;snapshotdir æŒ‚è½½ç‚¹å¹¶åˆ é™¤æ­¤ç›®å½•ï¼Œåˆ é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;rootfs ç›®å½•ï¼ˆè¯¥ç›®å½•å’Œ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfs æ•°æ®åŒæ­¥ï¼Œå€ŸåŠ© 9pfs&#x2F;virtiofs å®ç°å®¹å™¨æ–‡ä»¶ç³»ç»Ÿå…±äº«ï¼Œåœ¨ host ä¸Šä»¥ overlay æŒ‚è½½ç‚¹å½¢å¼å­˜åœ¨ï¼‰ï¼›å¦åˆ™ï¼Œç§»é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;rootfs æŒ‚è½½ç‚¹å¹¶åˆ é™¤æ­¤ç›®å½•</li><li>åˆ é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt; ç›®å½•</li></ol><h2 id="ShareFile"><a href="#ShareFile" class="headerlink" title="ShareFile"></a>ShareFile</h2><p><strong>å…±äº« host æ–‡ä»¶è‡³ guest ä¸­</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/fs_share_linux.go#L227">source code</a></p><ol><li>å…±äº«æ–‡ä»¶ï¼ˆshareFileï¼‰åç§°æ ¼å¼ä¸º &lt;containerID&gt;-&lt;random bytes&gt;-&lt;dst&gt;<br><em>ä¾‹å¦‚ï¼š&lt;containerID&gt;-47dcc9007bca8805-hostname</em></li><li>è°ƒç”¨ hypervisor çš„ <strong>Capabilities</strong>ï¼Œåˆ¤æ–­æ˜¯å¦æ”¯æŒ host æ–‡ä»¶ç³»ç»Ÿå…±äº«ç‰¹æ€§ï¼ˆQEMU åœºæ™¯ä¸‹æ”¯æŒï¼‰<ul><li>å¦‚æœä¸æ”¯æŒï¼Œåˆ™é€šè¿‡æ–‡ä»¶æ‹·è´å®ç°å…±äº«<ol><li>æ ¡éªŒ src æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœ src éå¸¸è§„æ–‡ä»¶ï¼Œåˆ™ä¸åšå¤„ç†ï¼ˆè¿™é‡Œå¹¶æœªè§†ä¸ºé”™è¯¯ï¼Œè€Œæ˜¯ä½œä¸ºä¸€ç§å±€é™æ€§å°†å…¶å¿½ç•¥ï¼‰</li><li>è°ƒç”¨ agent çš„ <strong>copyFile</strong>ï¼Œå°† src æ–‡ä»¶æ‹·è´è‡³ sandbox çš„ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;containers&#x2F;&lt;shareFile&gt; æ–‡ä»¶ä½ç½®</li></ol></li><li>å¦‚æœæ”¯æŒï¼Œåˆ™é€šè¿‡æ–‡ä»¶æŒ‚è½½å®ç°å…±äº«<ol><li>å¦‚æœæŒ‚è½½ä¸ºè¯»å†™å±æ€§ï¼Œåˆ™è°ƒç”¨ <strong>bindMount</strong>ï¼Œå°† src ä»¥è¯»å†™å’Œ MS_PRIVATE çš„å±æ€§ç»‘å®šæŒ‚è½½åˆ° &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;shareFile&gt;</li><li>å¦åˆ™ï¼Œè°ƒç”¨ <strong>bindMount</strong>ï¼Œå°† src ä»¥åªè¯»å’Œ MS_PRIVATE çš„å±æ€§ç»‘å®šæŒ‚è½½åˆ° &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;private&#x2F;&lt;shareFile&gt;ï¼Œè¿›è€Œè°ƒç”¨ <strong>bindMount</strong>ï¼Œå°† &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;private&#x2F;&lt;shareFile&gt; ä»¥è¯»å†™å’Œ MS_PRIVATE çš„å±æ€§ç»‘å®šæŒ‚è½½åˆ° &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;shareFile&gt;<br><em>å¯¹äºåªè¯»æŒ‚è½½ï¼ŒbindMount é‡æ–°æŒ‚è½½äº‹ä»¶ä¸ä¼šä¼ æ’­åˆ°æŒ‚è½½å­æ ‘ï¼Œå¹¶ä¸”å®ƒä¹Ÿä¸ä¼šå‡ºç°åœ¨ virtiofsd ç‹¬ç«‹æŒ‚è½½å‘½åç©ºé—´ä¸­</em></li><li>è®¾ç½®æŒ‚è½½ä¿¡æ¯çš„ host ä¾§è·¯å¾„ä¸º &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;shareFile&gt;</li></ol></li></ul></li></ol><h2 id="UnshareFile"><a href="#UnshareFile" class="headerlink" title="UnshareFile"></a>UnshareFile</h2><p><strong>ç§»é™¤ host&#x2F;guest å…±äº«æ–‡ä»¶çš„æŒ‚è½½ç‚¹</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/fs_share_linux.go#L296">source code</a></p><ol><li>ç§»é™¤æŒ‚è½½ä¿¡æ¯çš„ host ä¾§æŒ‚è½½ç‚¹</li><li>å¦‚æœæŒ‚è½½ç±»å‹ä¸º bindï¼Œæ ¡éªŒ host ä¾§æŒ‚è½½ç‚¹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœä¸ºå¸¸è§„æ–‡ä»¶ä¸”ä¸ºç©ºï¼Œåˆ™ç›´æ¥åˆ é™¤ï¼›å¦‚æœä¸ºç›®å½•ï¼Œåˆ™ç§»é™¤ç›®å½•</li></ol><h2 id="ShareRootFilesystem"><a href="#ShareRootFilesystem" class="headerlink" title="ShareRootFilesystem"></a>ShareRootFilesystem</h2><p><strong>åˆ›å»º guest ä¸­å®¹å™¨ rootfs å…±äº«æŒ‚è½½</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/fs_share_linux.go#L373">source code</a></p><ol><li>å¦‚æœ rootfs ç±»å‹ä¸º fuse.nydus-overlayfs<ol><li>é€šè¿‡ virtiofsd æŒ‚è½½ &#x2F;rafs&#x2F;&lt;containerID&gt;&#x2F;lowerdir ç›®å½•è‡³ guest ä¸­</li><li>åˆ›å»º &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;rootfs ç›®å½•</li><li>è°ƒç”¨ <strong>bindMount</strong>ï¼Œå°† rootfs æŒ‚è½½å‚æ•°ä¸­çš„ snapshotdir ç›®å½•ä»¥åªè¯»å’Œ MS_SLAVE çš„å±æ€§ç»‘å®šæŒ‚è½½åˆ° &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;snapshotdir</li><li>æŒ‚è½½ç±»å‹ä»ä¸ºè”åˆæ–‡ä»¶ç³»ç»Ÿçš„ overlay å½¢å¼</li></ol></li><li>å¦‚æœ rootfs ç±»å‹ä¸æ˜¯ fuse.nydus-overlayfsï¼Œå¹¶ä¸”æ˜¯åŸºäºå—è®¾å¤‡çš„ rootfs<ol><li>è°ƒç”¨ devManager çš„ <strong>GetDeviceByID</strong>ï¼Œæ ¹æ®å®¹å™¨çŠ¶æ€ä¸­çš„ä¿¡æ¯è·å–åˆ°è®¾å¤‡ä¿¡æ¯</li><li>æŒ‚è½½ç±»å‹è§† [hypervisor].block_device_driver è€Œå®š</li><li>åˆ›å»º &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;rootfs ç›®å½•</li></ol></li><li>å¯¹äºä¼ ç»Ÿçš„ rootfsï¼ˆä¹Ÿå°±æ˜¯é fuse.nydus-overlayfs ç±»å‹ï¼Œå¹¶ä¸”ä¸æ˜¯åŸºäºå—è®¾å¤‡çš„ï¼‰ï¼Œè°ƒç”¨ <strong>bindMount</strong>ï¼Œä»¥è¯»å†™å’Œ MS_PRIVATE çš„å±æ€§å°† rootfsï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼‰ç»‘å®šæŒ‚è½½åˆ° &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;rootfs<br><em>è¿™ä¸ªç›®å½•æœ¬èº«ä¸ºå…±äº«ç›®å½•ï¼Œå› æ­¤æ— éœ€å‘ŠçŸ¥ agent å»æŒ‚è½½ï¼Œåœ¨ host ä¾§æŒ‚è½½åä¼šè‡ªåŠ¨åœ¨ guest ä¸­å‡ºç°</em></li><li>æ— è®ºä»¥ä¸Šå“ªç§æŒ‚è½½å½¢å¼ï¼Œæœ€ç»ˆ guest ä¸­å®¹å™¨ rootfs çš„æŒ‚è½½ç‚¹å‡ä¸º <XDG_RUNTIME_DIR>&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;containers&#x2F;&lt;containerID&gt;&#x2F;rootfs</li></ol><h2 id="UnshareRootFilesystem"><a href="#UnshareRootFilesystem" class="headerlink" title="UnshareRootFilesystem"></a>UnshareRootFilesystem</h2><p><strong>ç§»é™¤ guest ä¸­å®¹å™¨ rootfs å…±äº«æŒ‚è½½</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/fs_share_linux.go#L455">source code</a></p><ol><li>å¦‚æœ rootfs ç±»å‹ä¸º fuse.nydus-overlayfs<ol><li>é€šè¿‡ virtiofsd ç§»é™¤ guest ä¸­çš„ &#x2F;rafs&#x2F;&lt;containerID&gt;&#x2F;lowerdir æŒ‚è½½ç‚¹</li><li>ç§»é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;snapshotdir æŒ‚è½½ç‚¹ï¼Œå¹¶åˆ é™¤ç›®å½•</li><li>ç§»é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;rootfs ç›®å½•</li></ol></li><li>å¦‚æœ rootfs ç±»å‹ä¸æ˜¯ fuse.nydus-overlayfsï¼Œåˆ™ç§»é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt;&#x2F;rootfs æŒ‚è½½ç‚¹ï¼Œå¹¶åˆ é™¤ç›®å½•</li><li>åˆ é™¤ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;&lt;sandboxID&gt;&#x2F;mounts&#x2F;&lt;containerID&gt; ç›®å½•</li></ol>]]></content>
    
    
    <summary type="html">virtcontainers ä¸­ä¸ PersistDriverã€FilesystemSharer ç­‰æ–‡ä»¶å­˜å‚¨ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” virtcontainers</title>
    <link href="http://shenxianghong.github.io/2023/01/30/2023-01-30%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers/"/>
    <id>http://shenxianghong.github.io/2023/01/30/2023-01-30%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20virtcontainers/</id>
    <published>2023-01-29T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.270Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><p>virtcontainers æœ¬è´¨ä¸Šä¸æ˜¯ç‹¬ç«‹ç»„ä»¶ï¼Œè€Œæ˜¯ä¸€ä¸ªç”¨äºæ„å»ºç¡¬ä»¶è™šæ‹ŸåŒ–å®¹å™¨è¿è¡Œæ—¶çš„ Golang åº“ã€‚</p><p>ç°æœ‰çš„å°‘æ•°éƒ¨åˆ†åŸºäº VM çš„å®¹å™¨è¿è¡Œæ—¶éƒ½å…±äº«ç›¸åŒçš„ç¡¬ä»¶è™šæ‹ŸåŒ–è¯­ä¹‰ï¼Œä½†æ˜¯ä½¿ç”¨ä¸åŒçš„ä»£ç åº“æ¥å®ç°ï¼Œvirtcontainers çš„ç›®æ ‡å°±æ˜¯å°†è¿™éƒ¨åˆ†å°è£…æˆä¸€ä¸ªé€šç”¨çš„ Golang åº“ã€‚</p><p>ç†æƒ³æƒ…å†µä¸‹ï¼ŒåŸºäº VM çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œä¼šä»å°†å®ƒä»¬å®ç°çš„è¿è¡Œæ—¶è§„èŒƒï¼ˆä¾‹å¦‚ OCI spec æˆ– Kubernetes CRIï¼‰è½¬æ¢æˆ virtcontainers APIã€‚</p><p>virtcontainers API å¤§è‡´å—åˆ° Kubernetes CRI çš„å¯å‘ã€‚ç„¶è€Œï¼Œå°½ç®¡è¿™ä¸¤ä¸ªé¡¹ç›®ä¹‹é—´çš„ API ç›¸ä¼¼ï¼Œä½† virtcontainers çš„ç›®æ ‡ä¸æ˜¯æ„å»º CRI å®ç°ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªé€šç”¨çš„ã€è¿è¡Œæ—¶è§„èŒƒä¸å¯çŸ¥çš„ã€ç¡¬ä»¶è™šæ‹ŸåŒ–çš„å®¹å™¨åº“ï¼Œå…¶ä»–é¡¹ç›®å¯ä»¥åˆ©ç”¨å®ƒæ¥è‡ªå·±å®ç° CRIã€‚</p><h1 id="VC"><a href="#VC" class="headerlink" title="VC"></a>VC</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;interfaces.go</u></em></p><p>virtcontainers åº“çš„å…¥å£æ¨¡å—ï¼ŒVC åˆå§‹åŒ– VCSandbox æ¨¡å—ç®¡ç† sandboxï¼Œè¿›è€Œåˆå§‹åŒ– VCContainer æ¨¡å—ç®¡ç†å®¹å™¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> VCImpl <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// factory çš„å…·ä½“å®ç°ï¼Œä¸ä¸ºç©ºæ—¶è¡¨ç¤ºä¸º VM factory åœºæ™¯</span></span><br><span class="line">factory Factory</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>VC ä¸­å£°æ˜çš„ <strong>SetLogger</strong> å’Œ <strong>SetFactory</strong> å‡ä¸ºå‚æ•°èµ‹å€¼ï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸ä½œè¯¦è¿°ã€‚</p><h2 id="CreateSandbox"><a href="#CreateSandbox" class="headerlink" title="CreateSandbox"></a>CreateSandbox</h2><p><strong>åˆ›å»º sandbox ä¸ pod_sandbox å®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/implementation.go#L34">source code</a></p><ol><li>åˆ›å»º sandbox<ol><li>æ ¡éªŒ sandboxConfig çš„ annotation ä¸­è‡ªå®šä¹‰è¿è¡Œæ—¶é…ç½®ï¼ˆç§°ä¸º assets ï¼‰çš„åˆæ³•æ€§å¹¶è®¾ç½®<br><em>annotation ä¾‹å¦‚ io.katacontainers.hypervisor.kernel ä¸ºç”¨æˆ·ä¸Šå±‚é€šè¿‡ Pod annotation å®šä¹‰ï¼ŒCRI ä¼šé€ä¼ ç»™åº•å±‚è¿è¡Œæ—¶</em></li><li>åˆå§‹åŒ– VCSandboxï¼Œå‡†å¤‡æ‰€éœ€ç¯å¢ƒ</li><li>å¦‚æœ sandbox ä¸­çŠ¶æ€ä¿¡æ¯ï¼ˆå³ sandbox.stateï¼‰å·²ç»å­˜åœ¨ï¼Œåˆ™è¡¨æ˜ä¸æ˜¯æ–°åˆ›å»ºçš„ pod_sandbox å®¹å™¨ï¼Œæ— éœ€åç»­åŠ¨ä½œï¼Œä»…ç”¨äºçŠ¶æ€æ›´æ–°ç»´æŠ¤ï¼Œç›´æ¥è¿”å› sandbox å³å¯</li><li>è°ƒç”¨ fsShare çš„ <strong>Prepare</strong>ï¼Œå‡†å¤‡ sandbox æ‰€éœ€çš„å…±äº«æ–‡ä»¶ç³»ç»Ÿç›®å½•</li><li>è°ƒç”¨ agent çš„ <strong>createSandbox</strong>ï¼Œå‡†å¤‡ sandbox æ‰€éœ€ç¯å¢ƒ</li><li>è®¾ç½® sandbox çŠ¶æ€ä¸º ready</li></ol></li><li>å¦‚æœæœªå¯ç”¨ [runtime].disable_new_netns å¹¶ä¸”ä¸æ˜¯ VM factory åœºæ™¯ï¼ˆåœ¨ VM factory åœºæ™¯ä¸‹ï¼Œç½‘å¡æ˜¯åœ¨ VM å¯åŠ¨åçƒ­æ’è¿›å»çš„ï¼‰ï¼Œåˆ™è°ƒç”¨ network çš„ <strong>AddEndpoints</strong>ï¼Œæ·»åŠ  netns ä¸­çš„æ‰€æœ‰ç½‘å¡åˆ° VM ä¸­<br><em>netns è¦ä¹ˆæ˜¯ Kata Containers åœ¨è¿è¡Œæ—¶åˆ›å»ºï¼Œè¦ä¹ˆæ˜¯ CNI ç­‰å¤–éƒ¨ç»„ä»¶é¢„å…ˆåˆ›å»ºã€‚æ€»ä¹‹ï¼Œæ­¤æ—¶ netns å·²ç»å­˜åœ¨äº†</em></li><li>è°ƒç”¨ resCtrl çš„ <strong>setupResourceController</strong>ï¼Œå°†å½“å‰è¿›ç¨‹åŠ å…¥ cgroup ä¸­ç®¡ç†</li><li>å¯åŠ¨ VMï¼ˆåœ¨ 1-2 æ­¥éª¤ä¸­çš„ VCSandbox åˆå§‹åŒ–æµç¨‹ä¸­ï¼Œå·²ç»åˆ›å»ºäº† VMï¼‰<ol><li>å¦‚æœ [hypervisor].enable_debug å¯ç”¨ï¼ˆç”¨äºè¾“å‡º  hypervisor å’Œ kernel äº§ç”Ÿçš„æ¶ˆæ¯ï¼‰ï¼Œåˆ™è°ƒç”¨ hypervisor çš„ <strong>GetVMConsole</strong>ï¼Œè·å– VM console åœ°å€ï¼ˆ&#x2F;run&#x2F;vc&#x2F;vm&#x2F;&lt;sandboxID&gt;&#x2F;console.sockï¼‰</li><li>è°ƒç”¨ network çš„ <strong>Run</strong>ï¼Œè¿›å…¥åˆ°è¯¥ netns ä¸­ï¼Œæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼šå¦‚æœä¸º VM factory åœºæ™¯ï¼Œåˆ™è·å– factory ä¸­ç¼“å­˜çš„ VMï¼Œè°ƒç”¨ agent çš„ <strong>reuseAgent</strong>ï¼Œæ›´æ–° agent å®ä¾‹ï¼Œå¹¶åˆ›å»ºè½¯é“¾æ¥ &#x2F;run&#x2F;vc&#x2F;vm&#x2F;&lt;sandboxID&gt; æŒ‡å‘ &#x2F;run&#x2F;vc&#x2F;vm&#x2F;&lt;vmID&gt;ï¼›å¦åˆ™ï¼Œè°ƒç”¨ hypervisor çš„ <strong>StartVM</strong>ï¼Œå¯åŠ¨ VM è¿›ç¨‹</li><li>å¦‚æœä¸º VM factory åœºæ™¯ï¼Œåˆ™è°ƒç”¨ network çš„ <strong>AddEndpoints</strong>ï¼Œçƒ­æ·»åŠ  netns ä¸­çš„æ‰€æœ‰ç½‘å¡åˆ° VM ä¸­</li><li>å¦‚æœå¯ç”¨ [hypervisor].enable_debugï¼Œå®æ—¶è¯»å– VM console åœ°å€è·å–å…¶å®æ—¶å†…å®¹ï¼Œå¹¶ä»¥ debug çº§åˆ«æ—¥å¿—å½¢å¼è¾“å‡º</li><li>è°ƒç”¨ agent çš„ <strong>startSandbox</strong></li></ol></li><li>è°ƒç”¨ network çš„ <strong>Endpoints</strong>ï¼Œè·å– VM æ‰€æœ‰çš„ç½‘å¡è®¾å¤‡ï¼Œè°ƒç”¨ endpoint çš„ <strong>NetworkPair</strong>ï¼Œå…³é—­ä½äº host ä¾§çš„ vhost_net å¥æŸ„ï¼ˆå³ &#x2F;dev&#x2F;vhost-netï¼‰<br><em>æˆªè‡³ Kata 3.0ï¼Œç›®å‰ä»…å¯¹ macvtap ç±»å‹çš„ endpoint ç”Ÿæ•ˆ</em></li><li>è°ƒç”¨ agent çš„ <strong>getGuestDetails</strong>ï¼Œè·å–å¦‚ seccompSupported ç­‰ guest ä¿¡æ¯è¯¦æƒ…ï¼Œæ›´æ–°è‡³ sandbox ä¸­</li><li>åˆ›å»º sandbox ä¸­çš„æ¯ä¸€ä¸ªå®¹å™¨ï¼ˆå…¶å®ï¼Œæ­¤æ—¶ sandbox ä¸­ä»…æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œå°±æ˜¯ pod_sandbox å®¹å™¨æœ¬èº«ï¼‰<ol><li>åˆå§‹åŒ– VCContainerï¼Œå‡†å¤‡å®¹å™¨æ‰€éœ€ç¯å¢ƒ</li><li>æ ¹æ® [hypervisor].disable_block_device_useã€agent æ˜¯å¦å…·å¤‡ä½¿ç”¨å—è®¾å¤‡èƒ½åŠ›ä»¥åŠ hypervisor æ˜¯å¦å…è®¸å—è®¾å¤‡çƒ­æ’æ‹”ï¼Œåˆ¤æ–­æ˜¯å¦å½“å‰æ”¯æŒå—è®¾å¤‡ï¼Œå¹¶ä¸”å®¹å™¨çš„ rootfs ç±»å‹ä¸æ˜¯ fuse.nydus-overlayfsï¼Œä¹Ÿå°±æ˜¯ rootfs æ˜¯åŸºäºå—è®¾å¤‡åˆ›å»ºçš„<ol><li>é€šè¿‡ &#x2F;sys&#x2F;dev&#x2F;block&#x2F;&lt;major&gt;-&lt;minor&gt;&#x2F;dm çš„å­˜åœ¨æ€§ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º devicemapper å—è®¾å¤‡</li><li>å¦‚æœæ˜¯ devicemapper å—è®¾å¤‡ï¼Œåˆ™è°ƒç”¨ devManager çš„ <strong>NewDevice</strong>ï¼Œåˆå§‹åŒ–è®¾å¤‡ï¼Œå¹¶è°ƒç”¨ devManager çš„ <strong>AttachDevice</strong>ï¼Œçƒ­æ’åˆ° VM ä¸­ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;containers&#x2F;&lt;sandboxID&gt; è·¯å¾„</li></ol></li><li>é’ˆå¯¹å®¹å™¨ä¸­çš„æ¯ä¸€ä¸ªè®¾å¤‡ï¼Œè°ƒç”¨ devManager çš„ <strong>AttachDevice</strong>ï¼Œattach åˆ° VM ä¸­</li><li>è°ƒç”¨ agent çš„ <strong>createContainer</strong>ï¼Œåˆ›å»º pod_sandbox å®¹å™¨</li><li>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º ready</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li><li>æ›´æ–°ç»´æŠ¤åœ¨ sandbox ä¸­çš„å®¹å™¨ä¿¡æ¯</li></ol></li><li>è°ƒç”¨ <strong>updateResources</strong>ï¼Œçƒ­æ›´æ–° VM çš„èµ„æºè§„æ ¼ï¼ˆç”±äºè¯¥æµç¨‹ä¸­ä»…ä¸ºåˆ›å»º pod_sandboxï¼Œä¸æ¶‰åŠ pod_containerï¼Œå› æ­¤ä¸ºé…ç½®ä¸­å£°æ˜çš„ [hypervisor].default_vcpus å’Œ [hypervisor].default_memoryï¼‰</li><li>è°ƒç”¨ resCtrl çš„ <strong>resourceControllerUpdate</strong>ï¼Œæ›´æ–° sandbox çš„ cgroup</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="CleanupContainer"><a href="#CleanupContainer" class="headerlink" title="CleanupContainer"></a>CleanupContainer</h2><p><strong>å…³åœã€åˆ é™¤å®¹å™¨å¹¶é”€æ¯ sandbox ç¯å¢ƒ</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/implementation.go#L41">source code</a></p><ol><li>è°ƒç”¨ store çš„ <strong>FromDisk</strong>ï¼Œè¯»å– sandbox çŠ¶æ€ä¿¡æ¯</li><li>è·å– sandbox å¹¶æ›´æ–°å…¶ä¸­çš„å®¹å™¨ï¼ˆæ›´æ–°çš„æ„ä¹‰åœ¨äºåç»­çš„åˆ é™¤æ“ä½œä»¥æ–‡ä»¶å†…å®¹ä¸ºå‡†ï¼‰</li><li>è°ƒç”¨ VCSandbox çš„ <strong>StopContainer</strong> å’Œ <strong>DeleteContainer</strong>ï¼Œå…³åœå¹¶åˆ é™¤è¯¥å®¹å™¨</li><li>è°ƒç”¨ VCSandbox çš„ <strong>GetAllContainers</strong>ï¼Œè·å– sandbox ä¸­çš„æ‰€æœ‰å®¹å™¨ï¼Œå¦‚æœä»å¤§äº 0ï¼ˆè¯´æ˜å½“å‰ sandbox ä»æœ‰å®¹å™¨å­˜åœ¨ï¼Œéœ€è¦ä¿ç•™ sandbox ç¯å¢ƒï¼‰ï¼Œå¦åˆ™è°ƒç”¨ VCSandbox çš„ <strong>Stop</strong>ï¼Œå…³åœ sandboxï¼Œå¹¶è°ƒç”¨ VCSandbox çš„ <strong>Delete</strong>ï¼Œåˆ é™¤ sandbox</li></ol><h1 id="VCSandbox"><a href="#VCSandbox" class="headerlink" title="VCSandbox"></a>VCSandbox</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;interfaces.go</u></em></p><p>virtcontainers åº“ä¸­ç”¨äºç®¡ç† sandbox çš„æ¨¡å—ï¼ŒåŒæ—¶è°ƒç”¨ VCContainer æ¨¡å—é—´æ¥ç®¡ç†å®¹å™¨ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sandbox is composed of a set of containers and a runtime environment.</span></span><br><span class="line"><span class="comment">// A Sandbox can be created, deleted, started, paused, stopped, listed, entered, and restored.</span></span><br><span class="line"><span class="keyword">type</span> Sandbox <span class="keyword">struct</span> &#123;</span><br><span class="line">ctx             context.Context</span><br><span class="line">id<span class="type">string</span></span><br><span class="line">sync.Mutex</span><br><span class="line">annotationsLock *sync.RWMutex</span><br><span class="line">wg              *sync.WaitGroup</span><br><span class="line">monitor         *monitor</span><br><span class="line">config          *SandboxConfig</span><br><span class="line">    </span><br><span class="line"><span class="comment">// virtcontainers ä¸­çš„å„ç±»å­æ¨¡å—</span></span><br><span class="line">devManager api.DeviceManager</span><br><span class="line">factory    Factory</span><br><span class="line">hypervisor Hypervisor</span><br><span class="line">agent      agent</span><br><span class="line">store      persistapi.PersistDriver</span><br><span class="line">fsShare    FilesystemSharer</span><br><span class="line">network    Network</span><br><span class="line"></span><br><span class="line"><span class="comment">// sandbox ä¸­çš„ SWAP è®¾å¤‡</span></span><br><span class="line">swapDevices   []*config.BlockDrive</span><br><span class="line"><span class="comment">// sandbox ä¸­çš„ SWAP è®¾å¤‡æ€»å¤§å°</span></span><br><span class="line">swapSizeBytes <span class="type">int64</span></span><br><span class="line"><span class="comment">// sandbox ä¸­çš„ SWAP è®¾å¤‡æ•°é‡</span></span><br><span class="line">swapDeviceNum <span class="type">uint</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// host å’Œ sandbox çš„å…±äº«å·</span></span><br><span class="line">volumes []types.Volume</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦æ‰€æœ‰å®¹å™¨å…±äº«ç›¸åŒçš„ sandbox çº§åˆ«çš„ PID å‘½åç©ºé—´</span></span><br><span class="line">sharePidNs <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºç›‘è§† guest console è¾“å‡ºæµ</span></span><br><span class="line">cw *consoleWatcher</span><br><span class="line"></span><br><span class="line"><span class="comment">// [runtime].sandbox_cgroup_only]ï¼Œé»˜è®¤ä¸º false</span></span><br><span class="line"><span class="comment">// - falseï¼šsandboxController å’Œ overheadController åŒæ—¶å­˜åœ¨</span></span><br><span class="line"><span class="comment">// - trueï¼šä»…æœ‰ sandboxControllerï¼ŒoverheadController ä¸º nil</span></span><br><span class="line">sandboxController  resCtrl.ResourceController</span><br><span class="line">overheadController resCtrl.ResourceController</span><br><span class="line"></span><br><span class="line"><span class="comment">// sandbox ä¸­çš„å®¹å™¨ï¼ŒKey ä¸º containerID</span></span><br><span class="line">containers <span class="keyword">map</span>[<span class="type">string</span>]*Container</span><br><span class="line"></span><br><span class="line"><span class="comment">// sandbox çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ cgroup è·¯å¾„ã€å—è®¾å¤‡ç´¢å¼•è®°å½•ç­‰</span></span><br><span class="line">state types.SandboxState</span><br><span class="line"></span><br><span class="line"><span class="comment">// destination ä¸º /dev/shmï¼Œtype ä¸º bind çš„æŒ‚è½½ç‚¹çš„ source å¤§å°</span></span><br><span class="line">shmSize <span class="type">uint64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// guest ç‰¹æ€§ï¼Œéœ€è¦è°ƒç”¨ agent æ¥å£è·å¾—</span></span><br><span class="line"><span class="comment">// guest æ˜¯å¦æ”¯æŒ seccomp ç‰¹æ€§</span></span><br><span class="line">seccompSupported  <span class="type">bool</span></span><br><span class="line"><span class="comment">// æ˜¯å¦ç¦æ­¢ VM å…³æœº</span></span><br><span class="line">disableVMShutdown <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å·¥å‚å‡½æ•°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L527">source code</a></p><ol><li>æ ¡éªŒ [runtime].experimental æ˜¯å¦ä¸ºå¯æ”¯æŒçš„ç‰¹æ€§</li><li>åˆå§‹åŒ– hypervisorã€agentã€storeã€fsSharerã€devManager ç­‰ virtcontainers å­æ¨¡å—</li><li>åˆå§‹åŒ– resourceControllerï¼ˆ[runtime].sandbox_cgroup_only ä¸º true è¡¨ç¤º Pod æ‰€æœ‰çš„çº¿ç¨‹å…¨éƒ¨ç”± sandboxController ç®¡ç†ï¼›åä¹‹ï¼Œä»… vCPU çº¿ç¨‹ç”± sandboxController ç®¡ç†ï¼Œè€Œå…¶ä½™çš„ç”± overheadController ç®¡ç†ï¼‰<ol><li>è·å–åˆ° spec.Linux.CgroupsPathï¼ˆç¼ºçœä¸º &#x2F;vcï¼‰ï¼Œå¦‚æœ cgroup ä¸æ˜¯ç”± systemd çº³ç®¡ï¼ˆé€šè¿‡ cgroupPath æ ¼å¼åˆ¤æ–­ï¼‰ï¼Œåˆ™æœ€åä¸€çº§è·¯å¾„æ–°å¢ kata_ å‰ç¼€</li><li>è·å– spec.Linux.Resources.Devices ä¸­ &#x2F;dev&#x2F;null å’Œ &#x2F;dev&#x2F;urandom è®¾å¤‡ä¿¡æ¯ï¼ˆå¦‚æœæœªå£°æ˜ï¼Œåˆ™æ„å»ºï¼‰</li><li>è°ƒç”¨ devManager çš„ <strong>GetAllDevices</strong>ï¼Œè·å–æ‰€æœ‰çš„è®¾å¤‡ï¼›è¿›ä¸€æ­¥è°ƒç”¨ device çš„ <strong>GetHostPath</strong>ï¼Œè·å–è®¾å¤‡ä½äº host ä¸Šçš„è·¯å¾„ï¼Œå°†å…¶æ„å»ºæˆ cgroup ç®¡ç†å½¢å¼</li><li>è°ƒç”¨ resCtrl çš„ <strong>NewSandboxResourceController</strong>ï¼Œåˆå§‹åŒ– sandboxControllerï¼ˆcgroupPath ä¸ºæ­¥éª¤ 1 å¤„ç†åçš„ç»“æœï¼‰</li><li>å¦‚æœ [runtime].sandbox_cgroup_only ä¸º falseï¼Œåˆ™è°ƒç”¨ resCtrl çš„ <strong>NewResourceController</strong>ï¼Œåˆå§‹åŒ– overheadController ï¼ˆcgroupPath ä¸º &#x2F;kata_overhead&#x2F;&lt;sandboxID&gt;ï¼‰</li></ol></li><li>ä»æ–‡ä»¶æ¢å¤ sandbox çŠ¶æ€ä¿¡æ¯<ol><li>è°ƒç”¨ store çš„ <strong>FromDisk</strong>ï¼Œå°è¯•ä»æ–‡ä»¶ä¸­æ¢å¤ sandbox çŠ¶æ€ä¿¡æ¯<br><em>å½“ sandbox æ–°åˆ›å»ºçš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰çŠ¶æ€æ–‡ä»¶ï¼Œå› æ­¤å¿…ç„¶å¤±è´¥ï¼Œä½†æ˜¯ä¼šå¿½ç•¥é”™è¯¯ä¿¡æ¯</em></li><li>è°ƒç”¨ hypervisor çš„ <strong>Load</strong>ï¼ŒåŠ è½½ hypervisor ä¿¡æ¯</li><li>è°ƒç”¨ devManager çš„ <strong>LoadDevices</strong>ï¼ŒåŠ è½½è®¾å¤‡ä¿¡æ¯</li><li>è°ƒç”¨ agent çš„ <strong>load</strong>ï¼ŒåŠ è½½ agent ä¿¡æ¯</li><li>è°ƒç”¨ endpoint çš„ <strong>load</strong>ï¼ŒåŠ è½½ç½‘ç»œ endpoint ä¿¡æ¯</li></ol></li><li>æ ¡éªŒ sandboxConfig ä¸­çš„ hypervisor é…ç½®çš„åˆæ³•æ€§ï¼Œå…¶ä¸­åŒ…æ‹¬ [hypervisor].kernel æ˜¯å¦ä¸ä¸ºç©ºï¼Œ[hypervisor].image å’Œ [hypervisor].initrd æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªã€‚å¹¶è®¾ç½® [hypervisor].default_vcpus ç¼ºçœæ—¶ä¸º 1ï¼Œ[hypervisor].default_memory ç¼ºçœæ—¶ä¸º 2048</li><li>è°ƒç”¨ hypervisor çš„ <strong>CreateVM</strong>ï¼Œåˆ›å»º VM</li><li>è°ƒç”¨ agent çš„ <strong>init</strong>ï¼Œå‡†å¤‡ agent ç¯å¢ƒ</li></ol><p>VCSandbox ä¸­å£°æ˜çš„ <strong>Annotations</strong>ã€<strong>GetNetNs</strong>ã€<strong>GetAllContainers</strong>ã€<strong>GetAnnotations</strong>ã€<strong>GetContainer</strong>ã€<strong>ID</strong> å’Œ <strong>SetAnnotations</strong> å‡ä¸ºå‚æ•°è·å–ä¸èµ‹å€¼ï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸ä½œè¯¦è¿°ã€‚</p><h2 id="updateResources"><a href="#updateResources" class="headerlink" title="updateResources"></a>updateResources</h2><p><strong>çƒ­æ›´æ–° VM çš„èµ„æºè§„æ ¼</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1966">source code</a></p><ol><li><p>å¦‚æœ [runtime].static_sandbox_resource_mgmt å¯ç”¨æ—¶ï¼ˆKata å°†åœ¨å¯åŠ¨è™šæ‹Ÿæœºä¹‹å‰ç¡®å®šåˆé€‚çš„ sandbox å†…å­˜å’Œ CPU å¤§å°ï¼Œè€ŒéåŠ¨æ€æ›´æ–°ã€‚ ä½œä¸º hypervisor ä¸æ”¯æŒ CPUã€å†…å­˜çƒ­æ’æ‹”æ—¶çš„è§£å†³æ–¹æ¡ˆï¼‰ï¼Œåˆ™ä¸è§¦å‘æ›´æ–°æ“ä½œï¼Œç›´æ¥è¿”å›</p></li><li><p>è®¡ç®— sandbox ä¸­æ‰€æœ‰çŠ¶æ€é stopped å®¹å™¨çš„ CPU ã€å†…å­˜å’Œ SWAP æ€»é‡ï¼ˆå‰ææ˜¯ [hypervisor].enable_guest_swap å¼€å¯ï¼Œå¹¶ä¸” memory.swappiness å¤§äº 0ï¼Œæ‰ä¼šè€ƒè™‘ SWAP èµ„æºï¼‰ï¼ŒåŠ ä¸ŠåŸºç¡€ VM å¤§å°ï¼Œå¾—å‡ºæœ€åé¢„æœŸçš„ VM å¤§å°ï¼Œå…¬å¼ä¸º</p><blockquote><p>CPU &#x3D; (C1.cpu-quota * 1000 &#x2F; C1.cpu-period + 999) &#x2F; 1000 + C2â€¦ + [hypervisor].default_vcpus</p><p>MEM &#x3D; C1.memory-limit + C1.hugepages-limit + C2â€¦ + [hypervisor].default_memory</p><p>SWAP &#x3D; </p><table><thead><tr><th><code>swap_in_bytes</code></th><th><code>memory_limit_in_bytes</code></th><th>swap size</th></tr></thead><tbody><tr><td>set</td><td>set</td><td><code>io.katacontainers.container.resource.swap_in_bytes</code>- <code>memory_limit_in_bytes</code></td></tr><tr><td>not set</td><td>set</td><td><code>memory_limit_in_bytes</code></td></tr><tr><td>not set</td><td>not set</td><td><code>io.katacontainers.config.hypervisor.default_memory</code></td></tr><tr><td>set</td><td>not set</td><td>cgroup doesnâ€™t support this usage</td></tr></tbody></table></blockquote><p><em>æˆªè‡³ Kata 3.0ï¼Œåœ¨ K8s åœºæ™¯ä¸‹ï¼ŒSWAP åŠŸèƒ½ä»å­˜åœ¨å¼‚å¸¸ï¼šå‚è€ƒ <a href="https://github.com/kata-containers/kata-containers/issues/5627">https://github.com/kata-containers/kata-containers/issues/5627</a></em></p></li><li><p>å¦‚æœé¢„æœŸ SWAP æ¯”å½“å‰ sandbox çš„ SWAP å¤šï¼Œåˆ™éœ€è¦æ–°å¢ä¸€ä¸ªå¤§å°ä¸ºä¸¤è€…å·®å€¼çš„ SWAP æ–‡ä»¶</p><ol><li>åˆ›å»º &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;swap&lt;ID&gt; æ–‡ä»¶ï¼ˆsandbox ä¸­çš„ SWAP åºå·ä» 0 é€’å¢ï¼‰</li><li>è°ƒæ•´æ–‡ä»¶çš„å¤§å°ä¸ºå·®å€¼å’Œ 10 å€å†…å­˜åˆ†é¡µä¸­æœ€å¤§å€¼ï¼ˆå°äº 10 å€å†…é¡µåˆ†é¡µçš„ SWAP ä¼šè¢« mkswap æ‹’ç»ï¼šmkswap: error: swap area needs to be at least 40 KiBï¼Œå†…å­˜åˆ†é¡µï¼š4096ï¼‰ï¼Œå¹¶é¢å¤–è¿½åŠ ä¸€ä¸ªå†…å­˜åˆ†é¡µå¤§å°ï¼ˆSWAP æ–‡ä»¶éœ€è¦ä¸€ä¸ªå†…å­˜åˆ†é¡µå¤§å°å‚¨å­˜å…ƒæ•°æ®ï¼‰</li><li>è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ mkswapï¼Œè½¬æ¢ä¸º SWAP æ–‡ä»¶ï¼Œå¹¶æ„å»º raw æ ¼å¼çš„å—è®¾å¤‡ç±»å‹</li><li>è°ƒç”¨ hypervisor çš„ <strong>HotplugAddDevice</strong>ï¼Œçƒ­æ·»åŠ  SWAP æ–‡ä»¶åˆ° VM ä¸­</li><li>è°ƒç”¨ agent çš„ <strong>addSwap</strong>ï¼Œé…ç½® SWAP æ–‡ä»¶</li></ol></li><li><p>è°ƒç”¨ hypervisor çš„ <strong>ResizeVCPUs</strong>ï¼Œè°ƒæ•´ VM CPU æ•°é‡</p></li><li><p>å¦‚æœä¸ºæ–°å¢è°ƒæ•´ï¼Œåˆ™è°ƒç”¨ agent çš„ <strong>onlineCPUMem</strong>ï¼Œé€šçŸ¥ agent ä¸Šçº¿çƒ­æ·»åŠ éƒ¨åˆ†çš„ CPU</p></li><li><p>å¾ªç¯è°ƒç”¨ hypervisor çš„ <strong>GetTotalMemoryMB</strong>ï¼Œè·å–å½“å‰ VM çš„å†…å­˜æ•°é‡ï¼Œæ¯”å¯¹é¢„æœŸ VM çš„å†…å­˜æ•°é‡ï¼Œåœ¨ä¸è¶…å‡ºæœ€å¤§çƒ­æ·»åŠ å†…å­˜æ•°é‡é™åˆ¶çš„å‰æä¸‹ï¼ˆéƒ¨åˆ†åœºæ™¯ä¸‹ï¼Œä¾‹å¦‚ ACPI çƒ­æ’æ‹”ï¼Œå†…å­˜çš„å•æ¬¡çƒ­æ·»åŠ æœ‰æœ€å¤§æ•°é‡é™åˆ¶ï¼›è€Œåœ¨ virtio-mem ä¸‹ï¼Œå³ [hypervisor].enable_virtio_mem å¯ç”¨ï¼Œ ä¸” &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;overcommit_memory æ–‡ä»¶å†…å®¹ä¸º 1ï¼Œåˆ™æ²¡æœ‰æœ€å¤§çƒ­æ·»åŠ æ•°é‡é™åˆ¶ï¼‰ï¼Œè°ƒç”¨ hypervisor çš„ <strong>ResizeMemory</strong>ï¼Œåˆ†æ‰¹çƒ­æ·»åŠ  VM å†…å­˜</p></li><li><p>è°ƒç”¨ agent çš„ <strong>memHotplugByProbe</strong>ï¼Œé€šçŸ¥ agent å†…å­˜çƒ­æ’äº‹ä»¶ï¼ˆå¦‚æœ guest å†…æ ¸æ”¯æŒå†…å­˜çƒ­æ·»åŠ æ¢æµ‹ï¼‰ï¼Œå¹¶è°ƒç”¨ agent çš„ <strong>onlineCPUMem</strong>ï¼Œé€šçŸ¥ agent ä¸Šçº¿çƒ­æ·»åŠ éƒ¨åˆ†çš„å†…å­˜</p></li></ol><h2 id="Stats"><a href="#Stats" class="headerlink" title="Stats"></a>Stats</h2><p><strong>è·å– sandbox çš„ç»Ÿè®¡ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1547">source code</a></p><ol><li>è°ƒç”¨ sandboxController çš„ <strong>Stat</strong>ï¼Œè·å– sandbox å…¨éƒ¨çš„ cgroup ç»Ÿè®¡ä¿¡æ¯ï¼ˆæˆªè‡³å½“å‰ï¼Œå¹¶æœªèšåˆ kata_overhead çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå³ overheadController éƒ¨åˆ†ï¼‰</li><li>è°ƒç”¨ hypervisor çš„ <strong>GetThreadIDs</strong>ï¼Œè·å– hypervisor ä½¿ç”¨çš„ CPU æ•°é‡</li><li>èšåˆä»¥ä¸Šä¿¡æ¯å¹¶è¿”å›</li></ol><h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><p><strong>å¯åŠ¨ sandbox ä¸ pod_sandbox å®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1662">source code</a></p><ol><li>æ ¡éªŒ sandbox çŠ¶æ€æ˜¯å¦ä¸º readyã€paused æˆ– stopped</li><li>è®¾ç½® sandbox çŠ¶æ€ä¸º running</li><li>é’ˆå¯¹ sandbox ä¸­çš„æ¯ä¸€ä¸ªå®¹å™¨ï¼Œè°ƒç”¨ VCContainer çš„ <strong>start</strong>ï¼Œå¯åŠ¨å®¹å™¨ï¼ˆå…¶å®ï¼Œæ­¤æ—¶ sandbox ä¸­ä»…æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œå°±æ˜¯ pod_sandbox å®¹å™¨æœ¬èº«ï¼‰</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="Stop"><a href="#Stop" class="headerlink" title="Stop"></a>Stop</h2><p><strong>å…³åœ sandbox ä¸å®¹å™¨ï¼Œå¹¶æ¸…ç†ç›¸å…³èµ„æº</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1687">source code</a></p><ol><li>å¦‚æœ sandbox çŠ¶æ€å·²ç»ä¸º stoppedï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ</li><li>æ ¡éªŒ sandbox çŠ¶æ€æ˜¯å¦ä¸º readyã€running æˆ–è€… paused</li><li>é’ˆå¯¹ sandbox ä¸­çš„æ¯ä¸€ä¸ªå®¹å™¨ï¼Œè°ƒç”¨ VCContainer çš„ <strong>stop</strong>ï¼Œå…³åœå®¹å™¨</li><li>è°ƒç”¨ agent çš„ <strong>stopSandbox</strong>ï¼Œå…³åœ sandbox</li><li>è°ƒç”¨ hypervisor çš„ <strong>StopVM</strong>ï¼Œå…³åœ VM</li><li>å¦‚æœ [hypervisor]. enable_debug å¯ç”¨ï¼Œåˆ™å…³é—­ VM console</li><li>è®¾ç½® sandbox çŠ¶æ€ä¸º stopped</li><li>è°ƒç”¨ network çš„ <strong>RemoveEndpoints</strong>ï¼Œç§»é™¤ VM ä¸­çš„æ‰€æœ‰ç½‘å¡</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li><li>è°ƒç”¨ agent çš„ <strong>disconnect</strong>ï¼Œå…³é—­ä¸ agent çš„è¿æ¥</li><li>ç§»é™¤ host ä¸Šçš„ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;sandboxes&#x2F;swap&lt;ID&gt; æ–‡ä»¶ï¼ˆsandbox ä¸­çš„ SWAP åºå·ä» 0 é€’å¢ï¼‰</li></ol><h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><p><strong>é”€æ¯ sandbox ä¸å®¹å™¨ï¼Œå¹¶æ¸…ç†ç›¸å…³èµ„æº</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L798">source code</a></p><ol><li>æ ¡éªŒ sandbox çš„çŠ¶æ€æ˜¯å¦ä¸º readyã€paused å’Œ stopped</li><li>é’ˆå¯¹ sandbox ä¸­çš„æ¯ä¸€ä¸ªå®¹å™¨ï¼Œè°ƒç”¨ VCContainer çš„ <strong>delete</strong>ï¼Œåˆ é™¤å®¹å™¨</li><li>å¦‚æœåœ¨ root æƒé™ä¸‹ï¼Œåˆ™è°ƒç”¨ resCtrl çš„ <strong>resourceControllerDelete</strong>ï¼Œåˆ é™¤ç›¸å…³çš„ resourceController ä»¥åŠ cgroup èµ„æº</li><li>å…³åœ sandbox çš„ monitor</li><li>è°ƒç”¨ hypervisor çš„ <strong>Cleanup</strong>ï¼Œæ¸…ç† hypervisor èµ„æº</li><li>è°ƒç”¨ fsShare çš„ <strong>Cleanup</strong>ï¼Œæ¸…ç† sandbox çš„å…±äº«æ–‡ä»¶ç³»ç»Ÿ</li><li>è°ƒç”¨ store çš„ <strong>Destroy</strong>ï¼Œåˆ é™¤çŠ¶æ€æ•°æ®ç›®å½•</li></ol><h2 id="Status"><a href="#Status" class="headerlink" title="Status"></a>Status</h2><p><strong>è·å– sandbox ä¸å®¹å™¨çš„è¯¦ç»†ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L333">source code</a></p><ol><li>é’ˆå¯¹ sandbox ä¸­çš„æ¯ä¸€ä¸ªå®¹å™¨ï¼Œè·å–å…¶çŠ¶æ€ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šIDã€rootfsã€çŠ¶æ€ã€å¯åŠ¨æ—¶é—´ã€annotationã€PID ç­‰ï¼‰</li><li>ç»“åˆ sandbox çš„çŠ¶æ€ä¿¡æ¯ï¼ˆä¾‹å¦‚ IDã€çŠ¶æ€ã€hypervisor ç±»åˆ«ã€hypervisor é…ç½®ã€annotation ç­‰ï¼‰è¿”å›</li></ol><h2 id="CreateContainer"><a href="#CreateContainer" class="headerlink" title="CreateContainer"></a>CreateContainer</h2><p><strong>åˆ›å»º pod_container å®¹å™¨å¹¶çƒ­æ›´æ–° sandbox è§„æ ¼</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1300">source code</a></p><ol><li>åˆå§‹åŒ– VCContainerï¼Œå‡†å¤‡å®¹å™¨ç¯å¢ƒï¼ŒæŒ‚è½½è®¾å¤‡ç­‰</li><li>æ ¹æ® [hypervisor].disable_block_device_useã€agent æ˜¯å¦å…·å¤‡ä½¿ç”¨å—è®¾å¤‡èƒ½åŠ›ä»¥åŠ hypervisor æ˜¯å¦å…è®¸å—è®¾å¤‡çƒ­æ’æ‹”ï¼Œåˆ¤æ–­æ˜¯å¦å½“å‰æ”¯æŒå—è®¾å¤‡ï¼Œå¹¶ä¸”å®¹å™¨çš„ rootfs ç±»å‹ä¸æ˜¯ fuse.nydus-overlayfsï¼Œä¹Ÿå°±æ˜¯ rootfs æ˜¯åŸºäºå—è®¾å¤‡åˆ›å»ºçš„<ol><li>é€šè¿‡ &#x2F;sys&#x2F;dev&#x2F;block&#x2F;&lt;major&gt;-&lt;minor&gt;&#x2F;dm çš„å­˜åœ¨æ€§ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º devicemapper å—è®¾å¤‡</li><li>å¦‚æœæ˜¯ devicemapper å—è®¾å¤‡ï¼Œåˆ™è°ƒç”¨ devManager <strong>NewDevice</strong>ï¼Œåˆå§‹åŒ–è®¾å¤‡ï¼Œå¹¶è°ƒç”¨ devManager çš„ <strong>AttachDevice</strong>ï¼Œçƒ­æ’åˆ° VM ä¸­ &lt;XDG_RUNTIME_DIR&gt;&#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;containers&#x2F;&lt;sandboxID&gt; è·¯å¾„</li></ol></li><li>é’ˆå¯¹å®¹å™¨ä¸­çš„æ¯ä¸€ä¸ªè®¾å¤‡ï¼Œè°ƒç”¨ devManager çš„ <strong>AttachDevice</strong>ï¼Œçƒ­æ’åˆ° VM ä¸­</li><li>è°ƒç”¨ agent çš„ <strong>createContainer</strong>ï¼Œåˆ›å»º pod_container å®¹å™¨</li><li>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º ready</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li><li>æ›´æ–°ç»´æŠ¤åœ¨ sandbox ä¸­çš„å®¹å™¨ä¿¡æ¯</li><li>è°ƒç”¨ <strong>updateResources</strong>ï¼Œçƒ­æ›´æ–° VM çš„èµ„æºè§„æ ¼</li><li>è°ƒç”¨ resCtrl çš„ <strong>resourceControllerUpdate</strong>ï¼Œæ›´æ–° sandbox çš„ cgroup</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="DeleteContainer"><a href="#DeleteContainer" class="headerlink" title="DeleteContainer"></a>DeleteContainer</h2><p><strong>åˆ é™¤ sandbox ä¸­çš„æŒ‡å®šå®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1431">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œå¹¶è°ƒç”¨ VCContainer çš„ <strong>delete</strong>ï¼Œåˆ é™¤ç»´æŠ¤çš„å®¹å™¨ä¿¡æ¯</li><li>è°ƒç”¨ resCtrl çš„ <strong>resourceControllerUpdate</strong>ï¼Œæ›´æ–° sandbox çš„ cgroup</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="StartContainer"><a href="#StartContainer" class="headerlink" title="StartContainer"></a>StartContainer</h2><p><strong>å¯åŠ¨ sandbox ä¸­çš„ pod_container å®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1364">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œå¹¶è°ƒç”¨ VCContainer çš„ <strong>start</strong>ï¼Œå¯åŠ¨å®¹å™¨</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li><li>è°ƒç”¨ <strong>updateResources</strong>ï¼Œçƒ­æ›´æ–° VM çš„èµ„æºä¿¡æ¯</li></ol><h2 id="StopContainer"><a href="#StopContainer" class="headerlink" title="StopContainer"></a>StopContainer</h2><p><strong>å…³åœ sandbox ä¸­çš„æŒ‡å®šå®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1392">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œå¹¶è°ƒç”¨ VCContainer çš„ <strong>stop</strong>ï¼Œå…³åœå®¹å™¨å¹¶æ¸…ç†ç›¸å…³èµ„æº</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="KillContainer"><a href="#KillContainer" class="headerlink" title="KillContainer"></a>KillContainer</h2><p><strong>æ€æ­» sandbox ä¸­çš„æŒ‡å®šå®¹å™¨è¿›ç¨‹</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1411">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œå¹¶è°ƒç”¨ VCContainer çš„ <strong>signalProcess</strong>ï¼Œå‘é€ kill ä¿¡å·ï¼ˆç†è®ºä¸Šæ˜¯è¿™æ ·ï¼Œç„¶è€Œå¹¶æœªæœ‰çœŸå®è°ƒç”¨ï¼‰</li></ol><h2 id="StatusContainer"><a href="#StatusContainer" class="headerlink" title="StatusContainer"></a>StatusContainer</h2><p><strong>è·å– sandbox ä¸­æŒ‡å®šå®¹å™¨çš„çŠ¶æ€</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1467">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œè·å–å…¶çŠ¶æ€ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼šIDã€rootfsã€çŠ¶æ€ã€å¯åŠ¨æ—¶é—´ã€annotationã€PID ç­‰ï¼‰</li></ol><h2 id="StatsContainer"><a href="#StatsContainer" class="headerlink" title="StatsContainer"></a>StatsContainer</h2><p><strong>è·å– sandbox ä¸­æŒ‡å®šå®¹å™¨çš„ç»Ÿè®¡ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1532">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œæ ¡éªŒå…¶çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è°ƒç”¨ agent çš„ <strong>statsContainer</strong>ï¼Œè·å–å®¹å™¨çŠ¶æ€ä¿¡æ¯</li></ol><h2 id="PauseContainer"><a href="#PauseContainer" class="headerlink" title="PauseContainer"></a>PauseContainer</h2><p><strong>æš‚åœ sandbox ä¸­çš„æŒ‡å®šå®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1576">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œæ ¡éªŒå…¶çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è°ƒç”¨ agent çš„ <strong>pauseContainer</strong>ï¼Œæš‚åœå®¹å™¨</li><li>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º paused</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="ResumeContainer"><a href="#ResumeContainer" class="headerlink" title="ResumeContainer"></a>ResumeContainer</h2><p><strong>æ¢å¤ sandbox ä¸­çš„æŒ‡å®šå®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1595">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œæ ¡éªŒå…¶çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è°ƒç”¨ agent çš„ <strong>resumeContainer</strong>ï¼Œæ¢å¤å®¹å™¨</li><li>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º running</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="EnterContainer"><a href="#EnterContainer" class="headerlink" title="EnterContainer"></a>EnterContainer</h2><p><strong>åœ¨ sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1493">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œæ ¡éªŒå…¶çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è°ƒç”¨ agent çš„ <strong>exec</strong>ï¼Œè¿›å…¥å®¹å™¨æ‰§è¡ŒæŒ‡å®šå‘½ä»¤</li></ol><h2 id="UpdateContainer"><a href="#UpdateContainer" class="headerlink" title="UpdateContainer"></a>UpdateContainer</h2><p><strong>æ›´æ–° sandbox ä¸­çš„æŒ‡å®šå®¹å™¨èµ„æºè§„æ ¼</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1510">source code</a></p><ol><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œæ ¡éªŒå…¶çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è°ƒç”¨ <strong>updateResources</strong>ï¼Œçƒ­æ›´æ–° VM çš„èµ„æºè§„æ ¼</li><li>è°ƒç”¨ agent çš„ <strong>updateContainer</strong>ï¼Œæ›´æ–°å®¹å™¨</li><li>è°ƒç”¨ resCtrl çš„ <strong>resourceControllerUpdate</strong>ï¼Œæ›´æ–° sandbox çš„ cgroup</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="WaitProcess"><a href="#WaitProcess" class="headerlink" title="WaitProcess"></a>WaitProcess</h2><p><strong>ç­‰å¾… sandbox ä¸­çš„æŒ‡å®šå®¹å™¨è¿›ç¨‹è¿”å›é€€å‡ºç </strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L377">source code</a></p><ol><li>æ ¡éªŒ sandbox çš„çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œæ ¡éªŒå…¶çŠ¶æ€æ˜¯å¦ä¸º ready æˆ– running</li><li>è°ƒç”¨ agent çš„ <strong>waitProcess</strong>ï¼Œç­‰å¾…è¿›ç¨‹è¿”å›é€€å‡ºç </li></ol><h2 id="SignalProcess"><a href="#SignalProcess" class="headerlink" title="SignalProcess"></a>SignalProcess</h2><p><strong>å‘ sandbox ä¸­çš„æŒ‡å®šå®¹å™¨è¿›ç¨‹å‘é€æŒ‡å®šä¿¡å·</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L392">source code</a></p><ol><li>æ ¡éªŒ sandbox çš„çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œè°ƒç”¨ VCContainer çš„ <strong>signalProcess</strong>ï¼Œå‘å®¹å™¨è¿›ç¨‹å‘é€æŒ‡å®šä¿¡å·</li></ol><h2 id="WinsizeProcess"><a href="#WinsizeProcess" class="headerlink" title="WinsizeProcess"></a>WinsizeProcess</h2><p><strong>è®¾ç½® sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ tty å¤§å°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L406">source code</a></p><ol><li>æ ¡éªŒ sandbox çš„çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œæ ¡éªŒå…¶çŠ¶æ€æ˜¯å¦ä¸º ready æˆ– running</li><li>è°ƒç”¨ agent çš„ <strong>winsizeProcess</strong>ï¼Œè®¾ç½®è¿›ç¨‹çš„ tty å¤§å°</li></ol><h2 id="IOStream"><a href="#IOStream" class="headerlink" title="IOStream"></a>IOStream</h2><p><strong>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ IO æµ</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L420">source code</a></p><ol><li>æ ¡éªŒ sandbox çš„çŠ¶æ€æ˜¯å¦ä¸º running</li><li>è·å– sandbox ä¸­çš„æŒ‡å®šå®¹å™¨ï¼Œæ ¡éªŒå…¶çŠ¶æ€æ˜¯å¦ä¸º ready æˆ– running</li><li>åˆå§‹åŒ– IO æµï¼Œè¿”å›å…¶ stdinã€stdout å’Œ stderr</li></ol><h2 id="AddDevice"><a href="#AddDevice" class="headerlink" title="AddDevice"></a>AddDevice</h2><p><strong>å‘ sandbox ä¸­æ·»åŠ è®¾å¤‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L1932">source code</a></p><ol><li>è°ƒç”¨ devManager çš„ <strong>NewDevice</strong>ï¼Œåˆå§‹åŒ–å¯¹åº”ç±»å‹çš„è®¾å¤‡</li><li>è°ƒç”¨ devManager çš„ <strong>AttachDevice</strong>ï¼Œæ·»åŠ è¯¥è®¾å¤‡</li></ol><h2 id="AddInterface"><a href="#AddInterface" class="headerlink" title="AddInterface"></a>AddInterface</h2><p><strong>å‘ sandbox ä¸­æ·»åŠ ç½‘å¡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L918">source code</a></p><ol><li>å°† rpc è¯·æ±‚ä½“è½¬æ¢æˆç½‘å¡ä¿¡æ¯ç»“æ„</li><li>è°ƒç”¨ network çš„ <strong>AddEndpoints</strong>ï¼Œçƒ­æ·»åŠ è¯¥ç½‘å¡</li><li>è·å–ç½‘å¡ PCI åœ°å€ï¼Œè°ƒç”¨ agent çš„ <strong>updateInterface</strong>ï¼Œæ›´æ–°ç½‘å¡ä¿¡æ¯</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="RemoveInterface"><a href="#RemoveInterface" class="headerlink" title="RemoveInterface"></a>RemoveInterface</h2><p><strong>ç§»é™¤ sandbox ä¸­çš„æŒ‡å®šç½‘å¡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L956">source code</a></p><ol><li>è°ƒç”¨ network çš„ <strong>Endpoints</strong>ï¼Œæ ¹æ® MAC åœ°å€åŒ¹é…æ‰€æœ‰ç½‘å¡ä¸­å¾…ç§»é™¤çš„ç½‘å¡</li><li>è°ƒç”¨ network çš„ <strong>RemoveEndpoints</strong>ï¼Œç§»é™¤è¯¥ç½‘å¡</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="ListInterfaces"><a href="#ListInterfaces" class="headerlink" title="ListInterfaces"></a>ListInterfaces</h2><p><strong>è·å– sandbox çš„æ‰€æœ‰ç½‘å¡é…ç½®</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L975">source code</a></p><ol><li>è°ƒç”¨ agent çš„ <strong>listInterfaces</strong>ï¼Œè·å–æ‰€æœ‰ç½‘å¡é…ç½®</li></ol><h2 id="UpdateRoutes"><a href="#UpdateRoutes" class="headerlink" title="UpdateRoutes"></a>UpdateRoutes</h2><p><strong>æ›´æ–° sandbox çš„è·¯ç”±è¡¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L980">source code</a></p><ol><li>è°ƒç”¨ agent çš„ <strong>updateRoutes</strong>ï¼Œæ›´æ–°è·¯ç”±è¡¨</li></ol><h2 id="ListRoutes"><a href="#ListRoutes" class="headerlink" title="ListRoutes"></a>ListRoutes</h2><p><strong>è·å– sandbox çš„æ‰€æœ‰è·¯ç”±é…ç½®</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L985">source code</a></p><ol><li>è°ƒç”¨ agent çš„ <strong>listRoutes</strong>ï¼Œè·å–æ‰€æœ‰è·¯ç”±é…ç½®</li></ol><h2 id="GetOOMEvent"><a href="#GetOOMEvent" class="headerlink" title="GetOOMEvent"></a>GetOOMEvent</h2><p><strong>è·å– sandbox çš„ OOM äº‹ä»¶ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L2320">source code</a></p><ol><li>è°ƒç”¨ agent çš„ <strong>getOOMEvent</strong>ï¼Œè·å– OOM äº‹ä»¶ä¿¡æ¯</li></ol><h2 id="GetHypervisorPid"><a href="#GetHypervisorPid" class="headerlink" title="GetHypervisorPid"></a>GetHypervisorPid</h2><p><strong>è·å– sandbox çš„ hypervisor PID</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L292">source code</a></p><ol><li>è°ƒç”¨ hypervisor çš„ <strong>GetPids</strong>ï¼Œè·å–æ‰€æœ‰ PID åˆ—è¡¨</li><li>è¿”å› PID åˆ—è¡¨é¦–ä½ï¼ˆå› ä¸ºé¦–ä½æ˜¯ hypervisor PIDï¼Œæ¬¡ä½ä¸º virtiofsd PIDï¼‰</li></ol><h2 id="UpdateRuntimeMetrics"><a href="#UpdateRuntimeMetrics" class="headerlink" title="UpdateRuntimeMetrics"></a>UpdateRuntimeMetrics</h2><p><strong>æ›´æ–° sandbox çš„ hypervisor ç›¸å…³æŒ‡æ ‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox_metrics.go#L134">source code</a></p><ol><li>è°ƒç”¨ hypervisor çš„ <strong>GetPids</strong>ï¼Œè·å– hypervisor çš„ PID</li><li>è·å– &#x2F;proc&#x2F;&lt;hypervisorPID&gt;&#x2F;fd ç›®å½•ä¸‹çš„æ–‡ä»¶æ•°é‡ï¼ˆè¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™äº›æ–‡ä»¶æè¿°ç¬¦æ˜¯æŒ‡å‘å®é™…æ–‡ä»¶çš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œä¾‹å¦‚ 0 è¡¨ç¤º stdinã€1 è¡¨ç¤º stdoutã€2 è¡¨ç¤º stderr ç­‰ç­‰ï¼‰ï¼Œä¸ŠæŠ¥ kata_hypervisor_fds æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;hypervisorPID&gt;&#x2F;net&#x2F;dev æ–‡ä»¶å†…å®¹ï¼ˆç½‘ç»œè®¾å¤‡çŠ¶æ€ä¿¡æ¯ï¼Œä¾‹å¦‚ eth0ã€loã€tap0_kata å’Œ tunl0 æ¥å—å’Œå‘é€çš„æ•°æ®åŒ…ã€é”™è¯¯å’Œå†²çªçš„æ•°é‡ä»¥åŠå…¶ä»–åŸºæœ¬ç»Ÿè®¡ï¼Œå‚è€ƒ ifconfig å‘½ä»¤ç»“æœï¼‰ï¼Œä¸ŠæŠ¥ kata_hypervisor_netdev æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;hypervisorPID&gt;&#x2F;stat æ–‡ä»¶å†…å®¹ï¼ˆè¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œå‚è€ƒ ps å‘½ä»¤ç»“æœï¼‰ï¼Œä¸ŠæŠ¥ kata_hypervisor_proc_stat æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;hypervisorPID&gt;&#x2F;status æ–‡ä»¶å†…å®¹ï¼ˆè¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œç›¸è¾ƒäº &#x2F;proc&#x2F;&lt;hypervisorPID&gt;&#x2F;stat æ›´æ˜“è¯»ï¼‰ï¼Œä¸ŠæŠ¥ kata_hypervisor_proc_status æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;hypervisorPID&gt;&#x2F;io æ–‡ä»¶å†…å®¹ï¼ˆè¿›ç¨‹çš„ IO ç»Ÿè®¡ä¿¡æ¯ï¼‰ï¼Œä¸ŠæŠ¥ kata_hypervisor_io æŒ‡æ ‡</li><li>è°ƒç”¨ hypervisor çš„ <strong>GetVirtioFsPid</strong>ï¼Œè·å– virtiofsd çš„ PID</li><li>è·å– &#x2F;proc&#x2F;&lt;virtiofsdPID&gt;&#x2F;fd ç›®å½•ä¸‹çš„æ–‡ä»¶æ•°é‡ï¼Œä¸ŠæŠ¥ kata_virtiofsd_fds æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;virtiofsdPID&gt;&#x2F;stat æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_virtiofsd_proc_stat æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;hypervisorPID&gt;&#x2F;status æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_virtiofsd_proc_status æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;hypervisorPID&gt;&#x2F;io æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_virtiofsd_io æŒ‡æ ‡</li></ol><h2 id="GetAgentMetrics"><a href="#GetAgentMetrics" class="headerlink" title="GetAgentMetrics"></a>GetAgentMetrics</h2><p><strong>è·å– sandbox çš„ agent ç›¸å…³æŒ‡æ ‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox_metrics.go#L221">source code</a></p><ol><li>è°ƒç”¨ agent çš„ <strong>getAgentMetrics</strong>ï¼Œè·å– agent çš„æŒ‡æ ‡ä¿¡æ¯</li></ol><h2 id="GetAgentURL"><a href="#GetAgentURL" class="headerlink" title="GetAgentURL"></a>GetAgentURL</h2><p><strong>è·å– sandbox çš„ agent URI ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L2324">source code</a></p><ol><li>è°ƒç”¨ agent çš„ <strong>getAgentURl</strong>ï¼Œè·å– URI ä¿¡æ¯</li></ol><h2 id="GuestVolumeStats"><a href="#GuestVolumeStats" class="headerlink" title="GuestVolumeStats"></a>GuestVolumeStats</h2><p><strong>è·å– sandbox ä¸­çš„æŒ‡å®šæŒ‚è½½å·ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L2339">source code</a></p><ol><li>æ ¡éªŒå·è·¯å¾„æ˜¯å¦å­˜åœ¨</li><li>éå†æ‰€æœ‰å®¹å™¨çš„æ‰€æœ‰æŒ‚è½½ç‚¹ï¼Œè·å–æŒ‚è½½æºä¸ºæŒ‡å®šå·ç›®å½•çš„ sandbox å†…çš„æŒ‚è½½ç‚¹</li><li>è°ƒç”¨ agent çš„ <strong>getGuestVolumeStats</strong>ï¼Œè·å–å·ä¿¡æ¯</li></ol><h2 id="ResizeGuestVolume"><a href="#ResizeGuestVolume" class="headerlink" title="ResizeGuestVolume"></a>ResizeGuestVolume</h2><p><strong>è°ƒæ•´ sandbox ä¸­çš„æŒ‡å®šæŒ‚è½½å·å¤§å°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox.go#L2348">source code</a></p><ol><li>æ ¡éªŒå·è·¯å¾„æ˜¯å¦å­˜åœ¨</li><li>éå†æ‰€æœ‰å®¹å™¨çš„æ‰€æœ‰æŒ‚è½½ç‚¹ï¼Œè·å–æŒ‚è½½æºä¸ºæŒ‡å®šå·ç›®å½•çš„ sandbox å†…çš„æŒ‚è½½ç‚¹</li><li>è°ƒç”¨ agent çš„ <strong>resizeGuestVolume</strong>ï¼Œè°ƒæ•´å·å¤§å°</li></ol><h2 id="GetIPTables"><a href="#GetIPTables" class="headerlink" title="GetIPTables"></a>GetIPTables</h2><p><strong>è·å– sandbox çš„ iptables ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox_metrics.go#L2329">source code</a></p><ol><li>è°ƒç”¨ agent çš„ <strong>getIPTables</strong>ï¼Œè·å– iptables ä¿¡æ¯</li></ol><h2 id="SetIPTables"><a href="#SetIPTables" class="headerlink" title="SetIPTables"></a>SetIPTables</h2><p><strong>è®¾ç½® sandbox çš„ iptables ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/sandbox_metrics.go#L2334">source code</a></p><ol><li>è°ƒç”¨ agent çš„ <strong>setIPTables</strong>ï¼Œè®¾ç½® iptables ä¿¡æ¯</li></ol><h1 id="VCContainer"><a href="#VCContainer" class="headerlink" title="VCContainer"></a>VCContainer</h1><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;interfaces.go</u></em></p><p>virtcontainers åº“ä¸­ç”¨äºç®¡ç†å®¹å™¨çš„æ¨¡å—ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Container is composed of a set of containers and a runtime environment.</span></span><br><span class="line"><span class="comment">// A Container can be created, deleted, started, stopped, listed, entered, paused and restored.</span></span><br><span class="line"><span class="keyword">type</span> Container <span class="keyword">struct</span> &#123;</span><br><span class="line">ctx           context.Context</span><br><span class="line">config        *ContainerConfig</span><br><span class="line">sandbox       *Sandbox</span><br><span class="line">id            <span class="type">string</span></span><br><span class="line">sandboxID     <span class="type">string</span></span><br><span class="line"><span class="comment">// &lt;sandboxID&gt;/&lt;id&gt;</span></span><br><span class="line">containerPath <span class="type">string</span></span><br><span class="line"><span class="comment">// å›ºå®šä¸º rootfs</span></span><br><span class="line">rootfsSuffix  <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨æŒ‚è½½ä¿¡æ¯ï¼ŒåŒ…æ‹¬ sourceã€destinationã€typeã€options ç­‰ã€‚ä» OCI spec è§£æè·å¾—</span></span><br><span class="line">mounts []Mount</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨è®¾å¤‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬è®¾å¤‡ IDã€å®¹å™¨ä¸­çš„è®¾å¤‡è·¯å¾„ã€æ–‡ä»¶æ¨¡å¼ç­‰ä¿¡æ¯</span></span><br><span class="line">devices []ContainerDevice</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿è¡ŒçŠ¶æ€ï¼ˆreadyã€runningã€pausedã€stopped ä»¥åŠ creatingï¼‰ã€rootfs çš„å—è®¾å¤‡ IDï¼ˆDeviceMapper åœºæ™¯ä¸‹ï¼Œrootfs ä¸ºçƒ­æ·»åŠ çš„å—è®¾å¤‡ï¼‰ã€rootfs çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ˆrootfs ä¸ºå—è®¾å¤‡æ—¶ï¼‰ä»¥åŠ sandbox è¿›ç¨‹æ‰€åœ¨çš„ cgroup è·¯å¾„</span></span><br><span class="line">state types.ContainerState</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®¹å™¨è¿›ç¨‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬ PIDï¼ˆæœ¬è´¨ä¸Šå°±æ˜¯ shimIDï¼‰ã€Token ä»¥åŠå¯åŠ¨æ—¶é—´ç­‰</span></span><br><span class="line">process Process</span><br><span class="line"></span><br><span class="line"> <span class="comment">// å®¹å™¨ rootfs åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬ sourceã€targetã€typeã€options ç­‰</span></span><br><span class="line">rootFs RootFs</span><br><span class="line"></span><br><span class="line"><span class="comment">// systemMountsInfo.BindMountDev è¡¨ç¤ºæ˜¯å¦å°† host çš„ /dev ç›®å½•ä»¥ bind å½¢å¼æŒ‚è½½åˆ°å®¹å™¨çš„ /dev ä¸­</span></span><br><span class="line"><span class="comment">// systemMountsInfo.DevShmSize è¡¨ç¤º host çš„ /dev/shm å¤§å°</span></span><br><span class="line">systemMountsInfo SystemMountsInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å·¥å‚å‡½æ•°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/container.go#L714">source code</a></p><ol><li>æ£€éªŒ containerConfig é…ç½®æ˜¯å¦åˆæ³•ï¼ˆcontainerConfig å–è‡ªäº sandboxConfig ä¸­çš„ç›¸å…³é…ç½®ï¼‰</li><li>æ ¡éªŒ annotation ä¸­ SWAP èµ„æºå£°æ˜æ˜¯å¦åˆæ³•ï¼ˆio.katacontainers.container.resource.swappiness å¿…é¡»å°äº 200ï¼‰ï¼Œå¹¶é€ä¼ è®¾ç½®ï¼ˆåŒºåˆ«äº CPU å’Œå†…å­˜ç­‰èµ„æºï¼ŒSWAP æ— æ³•é€šè¿‡ spec.Containers.Resources çš„æ–¹å¼å£°æ˜ï¼Œè€Œéœ€è¦é€šè¿‡ annotation å£°æ˜ï¼‰</li><li>è°ƒç”¨ store çš„ <strong>FromDisk</strong>ï¼Œè·å– sandbox å’Œå®¹å™¨çš„çŠ¶æ€ä¿¡æ¯ã€‚å¦‚æœæˆåŠŸè·å–åˆ™è¡¨æ˜ä¸æ˜¯æ–°åˆ›å»ºçš„å®¹å™¨ï¼Œæ— éœ€åç»­åŠ¨ä½œï¼Œä»…ç”¨äºçŠ¶æ€æ›´æ–°ç»´æŠ¤ï¼Œç›´æ¥è¿”å›å®¹å™¨å®ä¾‹å³å¯</li><li>å¤„ç†å®¹å™¨æŒ‚è½½ä¿¡æ¯ï¼Œå³ container.mounts<br><em>é™¤äº†å€ŸåŠ© virtcontainers&#x2F;kata-agent çš„å…±äº«ç›®å½•æŒ‚è½½ä¹‹å¤–ï¼Œå—è®¾å¤‡ç±»å‹çš„æŒ‚è½½è¿˜å¯ä»¥é€šè¿‡ hypervisor çƒ­æ·»åŠ åˆ° VMã€‚è¿™é‡Œä»…å¤„ç†æŒ‚è½½æºä¸ºå—è®¾å¤‡ç±»å‹çš„æŒ‚è½½ä¿¡æ¯ï¼Œå¸¸è§„å…±äº«ç›®å½•æŒ‚è½½ä»ç„¶ç”± virtcontainers&#x2F;kata-agent å¤„ç†</em><ol><li>å¦‚æœæœªç¦ç”¨ [hypervisor].disable_block_device_useï¼Œåˆ™è°ƒç”¨ agent çš„ <strong>capabilities</strong> å’Œ hypervisor çš„ <strong>Capabilities</strong>ï¼Œæ ¹æ® agent æ˜¯å¦å…·å¤‡ä½¿ç”¨å—è®¾å¤‡èƒ½åŠ›ä»¥åŠ hypervisor æ˜¯å¦å…è®¸å—è®¾å¤‡çƒ­æ’æ‹”åˆ¤æ–­æ˜¯å¦å½“å‰æ”¯æŒå—è®¾å¤‡<br><em>é»˜è®¤åœºæ™¯ä¸‹ï¼Œrootfs ç”± virtio-fs ä¼ é€’å…±äº«ï¼›åœ¨æœªç¦ç”¨ [hypervisor].disable_block_device_use æ—¶ï¼Œrootfs åŸºäºå—è®¾å¤‡åˆ›å»ºï¼Œå¹¶çƒ­æ’åˆ° VM ä¸­ä½¿ç”¨ï¼Œä»¥æé«˜æ€§èƒ½ã€‚ä¾‹å¦‚ devicemapper åœºæ™¯ä¸‹ rootfs å¿…é¡»æ˜¯åŸºäºå—è®¾å¤‡åˆ›å»ºçš„</em></li><li>é’ˆå¯¹å®¹å™¨ä¸­çš„æ‰€æœ‰æŒ‚è½½ä¿¡æ¯<ol><li>å¦‚æœ mounts.BlockDeviceID å·²ç»å­˜åœ¨ï¼Œåˆ™è¡¨æ˜å·²ç»æœ‰ä¸€ä¸ªè®¾å¤‡å’ŒæŒ‚è½½ç‚¹ç›¸å…³è”ï¼Œå› æ­¤ä¸éœ€è¦åˆ›å»ºè®¾å¤‡ï¼Œè·³è¿‡å³å¯</li><li>å¦‚æœæŒ‚è½½ç±»å‹ä¸æ˜¯ bindï¼Œè·³è¿‡å³å¯</li><li>è·å– &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 mounts.Source&gt;&#x2F;mountInfo.json æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¡¨æ˜å½“å‰æŒ‚è½½è®¾å¤‡éœ€è¦ä»¥ç›´é€šå·çš„æ–¹å¼å¤„ç†ï¼Œå³åˆ›å»º &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 mounts.Source&gt;&#x2F;&lt;sandboxID&gt; æ–‡ä»¶ï¼Œå¹¶æ›¿æ¢åŸæœ¬ mounts ä¸­ Sourceã€Typeã€Optionsã€ReadOnlyã€FSGroupï¼ˆå–è‡ª mountInfo.Metadata[â€œFSGroupâ€]ï¼‰ã€FSGroupChangePolicyï¼ˆå–è‡ª mountInfo.Metadata[â€œFSGroupChangePolicyâ€]ï¼‰ ç­‰ä¿¡æ¯ä¸º mountInfo.json çš„å¯¹åº”å­—æ®µï¼Œåç»­æ”¯æŒç›´é€šå·çš„ CSI ä¼šæ ¹æ®æ­¤æ–‡ä»¶ä¸ä¿¡æ¯ä¸ Kata äº¤äº’<br><em>mounts.Source æ ¼å¼ä¸º &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;&lt;podUID&gt;&#x2F;volumes&#x2F;kubernetes.io~csi&#x2F;&lt;pvName&gt;&#x2F;mountï¼›<br>mountInfo.json ä¸­ device å­—æ®µçš„æ ¼å¼ä¸º &#x2F;dev&#x2F;sdaï¼ˆå–å†³äº host ä¸Šçš„å…·ä½“è®¾å¤‡ï¼‰</em></li><li>å¦‚æœæŒ‚è½½æºä¸ºå—è®¾å¤‡ç±»å‹æˆ– PMEM è®¾å¤‡ï¼Œåˆ™è°ƒç”¨ devManager çš„ <strong>NewDevice</strong>ï¼Œåˆå§‹åŒ–æŒ‚è½½å—è®¾å¤‡ä¿¡æ¯ï¼Œå›å†™ mounts.BlockDeviceID å­—æ®µä¿¡æ¯<br><em>å—è®¾å¤‡ DeviceInfo çš„ HostPathã€ContainerPath ç­‰ä¿¡æ¯å‡ä¸º mounts ä¸­ä¿¡æ¯ï¼›<br>PMEM è®¾å¤‡ DeviceInfo çš„ HostPath å¤„ç†æ–¹å¼æ¯”è¾ƒç‰¹æ®Šï¼šå¦‚æœ DevType ä¸º c æˆ–è€… uï¼Œåˆ™ backingFile è·¯å¾„ä¸º &#x2F;sys&#x2F;dev&#x2F;char&#x2F;&lt;major:minor&gt;&#x2F;loop&#x2F;backing_fileï¼›å¦‚æœ DevType ä¸º bï¼Œåˆ™ backingFile è·¯å¾„ä¸º &#x2F;sys&#x2F;dev&#x2F;block&#x2F;&lt;major:minor&gt;&#x2F;loop&#x2F;backing_fileã€‚è¯»å– backingFile æ–‡ä»¶å†…å®¹ä½œä¸º HostPathã€‚æ­¤å¤–ï¼Œåˆ¤æ–­ HostPath ç­¾åæ˜¯å¦åˆæ³•ï¼ˆå½“ä½¿ç”¨ PMEM è®¾å¤‡å’Œ DAX æŠ€æœ¯æ—¶ï¼Œéœ€è¦ç¡®ä¿æ–‡ä»¶æˆ–è®¾å¤‡è·¯å¾„å…·æœ‰æ­£ç¡®çš„ PFN ç­¾åï¼Œä»¥ä¾¿å†…æ ¸å¯ä»¥æ­£ç¡®åœ°ç®¡ç† PMEM è®¾å¤‡å’Œå¯ç”¨ DAX æŠ€æœ¯ï¼‰ä»¥åŠé€šè¿‡ &#x2F;proc&#x2F;mounts è·å– PMEM çš„æŒ‚è½½æºçš„æ–‡ä»¶ç³»ç»Ÿç±»å‹ fstype</em></li></ol></li></ol></li><li>å‡†å¤‡å®¹å™¨è®¾å¤‡ä¿¡æ¯ï¼Œå³ container.devices<br><em>è®¾å¤‡å‡é€šè¿‡ hypervisor çƒ­æ·»åŠ åˆ° VM ä¸­</em><ol><li>é’ˆå¯¹å®¹å™¨ä¸­æ‰€æœ‰çš„è®¾å¤‡ä¿¡æ¯ï¼Œè°ƒç”¨ devManager çš„ <strong>NewDevice</strong>ï¼Œåˆå§‹åŒ–è®¾å¤‡ä¿¡æ¯ï¼Œå¹¶è¿‡æ»¤ç±»å‹ä¸º CDROM å’Œ floppy çš„è®¾å¤‡</li></ol></li></ol><p>VCContainer ä¸­å£°æ˜çš„ <strong>GetAnnotations</strong>ã€<strong>GetPid</strong>ã€<strong>GetToken</strong>ã€<strong>ID</strong>ã€<strong>Sandbox</strong> ä»¥åŠ <strong>Process</strong> å‡ä¸ºå‚æ•°è·å–ä¸èµ‹å€¼ï¼Œæ— å¤æ‚é€»è¾‘ï¼Œä¸ä½œè¯¦è¿°ã€‚</p><h2 id="start"><a href="#start" class="headerlink" title="start"></a>start</h2><p><strong>å¯åŠ¨å®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/container.go#L940">source code</a></p><ol><li>æ ¡éªŒ sandbox çŠ¶æ€æ˜¯å¦ä¸º running</li><li>æ ¡éªŒå®¹å™¨çŠ¶æ€æ˜¯å¦ä¸º ready æˆ– stopped</li><li>è°ƒç”¨ agent çš„ <strong>startContainer</strong>ï¼Œå¯åŠ¨å®¹å™¨</li><li>å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œåˆ™è°ƒç”¨ <strong>stop</strong>ï¼Œæ‰§è¡Œå›æ»šæ“ä½œï¼›å¦åˆ™ï¼Œè®¾ç½®å®¹å™¨çŠ¶æ€ä¸º runningï¼Œå¹¶è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜ sandbox å’Œå®¹å™¨çš„çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="stop"><a href="#stop" class="headerlink" title="stop"></a>stop</h2><p><strong>å…³åœå®¹å™¨ï¼Œå¹¶æ¸…ç†ç›¸å…³èµ„æº</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/container.go#L966">source code</a></p><ol><li>å¦‚æœå®¹å™¨çŠ¶æ€å·²ç»ä¸º stoppedï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ</li><li>æ ¡éªŒå®¹å™¨çŠ¶æ€æ˜¯å¦ä¸º readyã€running æˆ– paused</li><li>è°ƒç”¨ <strong>signalProcess</strong>ï¼Œå‘ sandbox ä¸­çš„å®¹å™¨è¿›ç¨‹å‘é€ kill ä¿¡å·</li><li>è°ƒç”¨ agent çš„ <strong>waitProcess</strong>ï¼Œç¡®ä¿å®¹å™¨è¿›ç¨‹å·²é€€å‡º</li><li>è°ƒç”¨ agent çš„ <strong>stopContainer</strong>ï¼Œå…³åœå®¹å™¨</li><li>é’ˆå¯¹å®¹å™¨ä¸­æ¯ä¸€ä¸ªæŒ‚è½½ä¿¡æ¯ï¼Œè°ƒç”¨ fsShare çš„ <strong>UnshareFile</strong>ï¼Œç§»é™¤ host ä¾§çš„ sandbox å…±äº«æ–‡ä»¶</li><li>è°ƒç”¨ fsShare çš„ <strong>UnshareRootFilesystem</strong>ï¼Œç§»é™¤ sandbox ä¸­çš„å®¹å™¨ rootfs å…±äº«æŒ‚è½½</li><li>è°ƒç”¨ devManager çš„ <strong>DetachDevice</strong> å’Œ <strong>RemoveDevice</strong>ï¼Œdetach å¹¶ç§»é™¤ sandbox ä¸­çš„æ‰€æœ‰è®¾å¤‡ï¼ˆå«å—è®¾å¤‡ï¼‰</li><li>å¦‚æœå®¹å™¨çš„ rootfs æ˜¯å—è®¾å¤‡ï¼Œåˆ™è°ƒç”¨ devManager çš„ <strong>DetachDevice</strong> å’Œ <strong>RemoveDevice</strong>ï¼Œdetach å¹¶ç§»é™¤å®¹å™¨çš„ rootfs å—è®¾å¤‡</li><li>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º stoppedï¼Œå¹¶è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜ sandbox å’Œå®¹å™¨çš„çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p><strong>åˆ é™¤å®¹å™¨ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/container.go#L896">source code</a></p><ol><li>æ ¡éªŒå®¹å™¨çŠ¶æ€æ˜¯å¦ä¸º ready æˆ– stopped</li><li>åˆ é™¤ç»´æŠ¤åœ¨ sandbox ä¸­çš„å®¹å™¨ä¿¡æ¯</li><li>è°ƒç”¨ store çš„ <strong>ToDisk</strong>ï¼Œä¿å­˜ sandbox å’Œå®¹å™¨çš„çŠ¶æ€æ•°æ®åˆ°æ–‡ä»¶ä¸­</li></ol><h2 id="signalProcess"><a href="#signalProcess" class="headerlink" title="signalProcess"></a>signalProcess</h2><p><strong>å‘å®¹å™¨è¿›ç¨‹å‘é€æŒ‡å®šä¿¡å·</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/virtcontainers/container.go#L1074">source code</a></p><ol><li>æ ¡éªŒ sandbox çŠ¶æ€æ˜¯å¦ä¸º ready æˆ–è€… running</li><li>æ ¡éªŒå®¹å™¨çŠ¶æ€æ˜¯å¦ä¸º readyã€running æˆ–è€… paused</li><li>è°ƒç”¨ agent çš„ <strong>signalProcess</strong>ï¼Œå‘ sandbox ä¸­çš„æŒ‡å®šå®¹å™¨è¿›ç¨‹å‘é€ä¿¡å·ï¼ˆç”±äº Containerd å’Œ CRIO å¹¶ä¸ä¼šå¤„ç† <code>ESRCH: No such process</code> é”™è¯¯ï¼Œå› æ­¤ Kata runtime åœ¨è¿™é‡Œåšäº†ç‰¹æ®Šæ“ä½œï¼Œé’ˆå¯¹æ­¤æŠ¥é”™ä»…è¾“å‡º warning æ—¥å¿—ï¼Œä¸ä½œè¿”å›ï¼‰</li></ol>]]></content>
    
    
    <summary type="html">virtcontainers ä¸­ä¸ VCã€VCSandboxã€VCContainer ç­‰ç¡¬ä»¶è™šæ‹ŸåŒ–ç®¡ç†å¹³é¢ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” kata-monitor</title>
    <link href="http://shenxianghong.github.io/2023/01/29/2023-01-29%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20kata-monitor/"/>
    <id>http://shenxianghong.github.io/2023/01/29/2023-01-29%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20kata-monitor/</id>
    <published>2023-01-28T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.269Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><p>Kata monitor æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œèƒ½å¤Ÿæ”¶é›†å’Œæš´éœ²åœ¨åŒä¸€ host ä¸Šè¿è¡Œçš„æ‰€æœ‰ Kata å®¹å™¨å·¥ä½œè´Ÿè½½ç›¸å…³çš„æŒ‡æ ‡ã€‚ä¸€æ—¦å¯åŠ¨ï¼Œå®ƒä¼šæ£€æµ‹ containerd-shim-kata-v2 ç³»ç»Ÿä¸­æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Kata Containers è¿è¡Œæ—¶ï¼Œå¹¶æš´éœ²ä¸€äº› HTTP endpointsã€‚ä¸»è¦ endpoint æ˜¯ &#x2F;metricsï¼ˆç”¨äºèšåˆæ¥è‡ªæ‰€æœ‰ Kata å·¥ä½œè´Ÿè½½çš„æŒ‡æ ‡ï¼‰ã€‚</p><p>å¯ç”¨æŒ‡æ ‡åŒ…æ‹¬ï¼š</p><ul><li>Kata è¿è¡Œæ—¶æŒ‡æ ‡</li><li>Kata agent æŒ‡æ ‡</li><li>Kata guestOS æŒ‡æ ‡</li><li>hypervisor æŒ‡æ ‡</li><li>Firecracker æŒ‡æ ‡</li><li>Kata monitor æŒ‡æ ‡</li></ul><p>Kata monitor æä¾›çš„æŒ‡æ ‡å‡é‡‡ç”¨ Prometheus æ ¼å¼ã€‚è™½ç„¶ Kata monitor å¯ä»¥åœ¨ä»»ä½•è¿è¡Œ Kata Containers å·¥ä½œè´Ÿè½½çš„ä¸»æœºä¸Šç”¨ä½œç‹¬ç«‹å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºä»æ­£åœ¨è¿è¡Œçš„ Kata è¿è¡Œæ—¶æ£€ç´¢åˆ†ææ•°æ®ï¼Œä½†å®ƒçš„ä¸»è¦é¢„æœŸç”¨é€”æ˜¯ä½œä¸º DaemonSet éƒ¨ç½²åœ¨ Kubernetes é›†ç¾¤ä¸Šã€‚</p><p><em><u>src&#x2F;runtime&#x2F;cmd&#x2F;kata-monitor&#x2F;main.go</u></em></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> KataMonitor <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// ç»´æŠ¤ /run/vc/sbs ç›®å½•ä¸‹çš„ sandbox çš„åŸºç¡€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ uidã€name å’Œ namespace</span></span><br><span class="line">sandboxCache *sandboxCache</span><br><span class="line">    </span><br><span class="line"><span class="comment">// --runtime-endpoint å‚æ•°æŒ‡å®šï¼Œé»˜è®¤ä¸º /run/containerd/containerd.sock</span></span><br><span class="line">runtimeEndpoint <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>main å‡½æ•°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-monitor/main.go#L69">source code</a></p><ol><li><p>å¦‚æœæŒ‡å®šçš„å‚æ•°ä¸º version æˆ–è€… â€“versionï¼Œåˆ™å±•ç¤ºå…¶ç‰ˆæœ¬ã€æ¶æ„ã€commit ç­‰ä¿¡æ¯</p></li><li><p>è§£æ„å‘½ä»¤è¡Œå‚æ•°ä¸åˆå§‹åŒ–æ—¥å¿—</p></li><li><p>åˆå§‹åŒ– monitor server</p><ol><li>æ ¡éªŒ â€“runtime-endpoint å‚æ•°æ˜¯å¦ä¸ä¸ºç©ºï¼Œé»˜è®¤ä¸º &#x2F;run&#x2F;containerd&#x2F;containerd.sock</li><li>æ³¨å†ŒæŒ‡æ ‡è‡³ Prometheus</li><li>å¯åŠ¨ goroutineï¼Œå®æ—¶å¤„ç† sandbox cache<ol><li>å¯åŠ¨ fsnotify watcherï¼Œç›‘å¬ &#x2F;run&#x2F;vc&#x2F;sbs ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ˆæ–‡ä»¶åå³ä¸º sandboxIDï¼‰</li><li>éå†ç›®å½•å†…å®¹ï¼Œå°† sandboxID ç»´æŠ¤åœ¨ km.sandboxCache</li><li>æ ¹æ® fsnotify watcher ç›‘å¬åˆ°çš„åˆ›å»ºæˆ–è€…åˆ é™¤äº‹ä»¶ï¼ŒåŒæ­¥æ›´æ–°ç»´æŠ¤åœ¨ km.sandboxCache ä¸­çš„ sandboxID</li><li>åŒæ—¶ï¼Œé»˜è®¤æ¯éš” 5 ç§’ï¼Œæ ¹æ® â€“runtime-endpoint å‚æ•°æ„å»º gRPC Client è°ƒç”¨ CRI çš„ ListPodSandbox è·å–åˆ° CRI ä¸­æ‰€æœ‰çš„ PodSandboxï¼Œå°†è¯¦ç»†å†…å®¹ï¼ˆå³ sandboxCRIMetadata å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å« UIDã€Name å’Œ Namespace å±æ€§ï¼‰æ›´æ–°è‡³ km.sandboxCache ä¸­</li></ol></li></ol></li><li><p>æ³¨å†Œ &#x2F;metricsã€&#x2F;sandboxesã€&#x2F;agent-url å’Œä¸€ç³»åˆ— Golang pprof çš„ HTTP ç«¯ç‚¹ï¼›æ ¹æœåŠ¡è¯·æ±‚ï¼ˆ&#x2F;ï¼‰ä¼šå±•ç¤ºæ‰€æœ‰å¯ç”¨çš„ HTTP ç«¯ç‚¹</p></li><li><p>å¯åŠ¨ monitor server æœåŠ¡ï¼Œç›‘å¬åœ°å€é€šè¿‡ â€“listen-address æŒ‡å®šï¼Œé»˜è®¤ä¸º 127.0.0.1:8090</p></li></ol><h1 id="ProcessMetricsRequest"><a href="#ProcessMetricsRequest" class="headerlink" title="ProcessMetricsRequest"></a>ProcessMetricsRequest</h1><p><strong>å¤„ç† &#x2F;metrics è¯·æ±‚ï¼Œè·å– shimã€hypervisorã€vm å’Œ agent æŒ‡æ ‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/kata-monitor/metrics.go#L74">source code</a></p><ol><li>è·å–è¯·æ±‚ä¸­çš„ sandbox å‚æ•°</li><li>å¦‚æœæŒ‡å®šäº† sandbox å‚æ•°ï¼Œåˆ™é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock å‘é€ HTTP GET è¯·æ±‚è‡³ shim server çš„ <code>http://shim/metrics</code>ï¼Œè·å–æŒ‡å®š sandbox çš„æŒ‡æ ‡ä¿¡æ¯å¹¶è¿”å›ï¼ˆç­‰ä»·äº kata-runtime metrics &lt;sandboxID&gt;ï¼‰</li><li>å¦‚æœæ²¡æœ‰æŒ‡å®š sandbox å‚æ•°ï¼Œåˆ™é€šè¿‡ Prometheus èšåˆæ‰€æœ‰ sandbox çš„æŒ‡æ ‡å¤„ç†å¹¶è¿”å›</li></ol><h1 id="ListSandboxes"><a href="#ListSandboxes" class="headerlink" title="ListSandboxes"></a>ListSandboxes</h1><p><strong>å¤„ç† &#x2F;sandboxes è¯·æ±‚ï¼Œè·å–æ‰€æœ‰è¿è¡Œçš„ sandbox</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/kata-monitor/monitor.go#L196">source code</a></p><ol><li>è·å–ç»´æŠ¤çš„æ‰€æœ‰ sandboxID</li><li>æ ¹æ®å®é™…è¯·æ±‚ï¼Œå…·ä½“å±•ç¤º HTML æˆ–è€… Text æ ¼å¼çš„å†…å®¹</li></ol><h1 id="GetAgentURL"><a href="#GetAgentURL" class="headerlink" title="GetAgentURL"></a>GetAgentURL</h1><p><strong>å¤„ç† &#x2F;agent-url è¯·æ±‚ï¼Œè·å–æŒ‡å®š sandboxID çš„ agent åœ°å€</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/kata-monitor/monitor.go#L179">source code</a></p><ol><li>æ£€éªŒè¯·æ±‚ä¸­çš„ sandbox å‚æ•°æ˜¯å¦ä¸ä¸ºç©º</li><li>é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock å‘é€ HTTP GET è¯·æ±‚è‡³ shim server çš„ <code>http://shim/agent-url</code>ï¼Œè§£æå†…å®¹è·å¾— sandbox socket åœ°å€</li></ol><h1 id="ExpvarHandlerã€PprofIndexã€PprofCmdlineã€PprofProfileã€PprofSymbolã€PprofTrace"><a href="#ExpvarHandlerã€PprofIndexã€PprofCmdlineã€PprofProfileã€PprofSymbolã€PprofTrace" class="headerlink" title="ExpvarHandlerã€PprofIndexã€PprofCmdlineã€PprofProfileã€PprofSymbolã€PprofTrace"></a>ExpvarHandlerã€PprofIndexã€PprofCmdlineã€PprofProfileã€PprofSymbolã€PprofTrace</h1><p><strong>å¤„ç† pprof ç±»è¯·æ±‚ï¼Œè½¬å‘è‡³ shim server</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/kata-monitor/pprof.go#L38">source code</a></p><ol><li>ä¸åŒçš„ endpoint åœ¨è½¬å‘å‰ä¼šè®¾ç½®ç‰¹å®šçš„è¯·æ±‚å¤´ï¼Œä¾‹å¦‚ Content-Type å’Œ Content-Disposition</li><li>ä»£ç†è¯·æ±‚<ol><li>æ£€éªŒè¯·æ±‚ä¸­çš„ sandbox å‚æ•°æ˜¯å¦ä¸ä¸ºç©º</li><li>é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock è½¬å‘ HTTP GET è¯·æ±‚è‡³ shim server çš„ <code>http://shim/&lt;URL&gt;</code></li><li>æ ¹æ®è°ƒç”¨ä¼ å‚ä¸­çš„è¯·æ±‚å¤„ç†æ–¹å¼åŠ å·¥æ•°æ®å¹¶è¿”å›</li></ol></li></ol>]]></content>
    
    
    <summary type="html">Kata Containers æŒ‡æ ‡é‡‡é›†ã€èšåˆä¸ä¸ŠæŠ¥çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” containerd-shim-kata-v2</title>
    <link href="http://shenxianghong.github.io/2023/01/21/2023-01-21%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20containerd-shim-kata-v2/"/>
    <id>http://shenxianghong.github.io/2023/01/21/2023-01-21%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20containerd-shim-kata-v2/</id>
    <published>2023-01-20T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.268Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><p>æœ¬è´¨ä¸Šï¼ŒKata agent è´Ÿè´£ VMï¼ˆä¹Ÿç§° sandboxã€guest ç­‰ï¼‰ä¸­çš„å®¹å™¨ç­‰è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ã€‚è€Œ containerd-shim-kata-v2 ä½œä¸º Kata agent å”¯ä¸€çš„æœåŠ¡å…¥å£ï¼ˆæœ¬èº«æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œè¿è¡Œåå³ä¸º shim serverï¼‰ï¼Œä¸€éƒ¨åˆ†å®ç°äº† Containerd shimv2 æ¥å£ï¼Œæš´éœ² shim API ç”¨äºä¸ Containerd çš„ gRPC é€šä¿¡ï¼Œä¸€éƒ¨åˆ†æš´éœ² HTTP endpoints ç”¨äºå‘½ä»¤è¡Œå·¥å…·å’Œ Kata monitor çš„æœåŠ¡è¯·æ±‚å¤„ç†ï¼Œå†…éƒ¨è°ƒç”¨ virtcontainers çš„è¯¸å¤šå­æ¨¡å—ï¼Œæä¾›äº†ç”¨æˆ·å’Œ Containerd å¯¹ VM ä»¥åŠå®¹å™¨è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„èƒ½åŠ›ã€‚</p><p><em><u>src&#x2F;runtime&#x2F;vendor&#x2F;github.com&#x2F;containerd&#x2F;containerd&#x2F;runtime&#x2F;v2&#x2F;task&#x2F;shim.pb.go</u></em></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// service is the shim implementation of a remote shim over GRPC</span></span><br><span class="line"><span class="keyword">type</span> service <span class="keyword">struct</span> &#123;</span><br><span class="line">ctx      context.Context</span><br><span class="line">rootCtx  context.Context <span class="comment">// root context for tracing</span></span><br><span class="line">rootSpan otelTrace.Span</span><br><span class="line">sandbox  vc.VCSandbox</span><br><span class="line">monitor  <span class="keyword">chan</span> <span class="type">error</span></span><br><span class="line">ec       <span class="keyword">chan</span> exit</span><br><span class="line">    mu       sync.Mutex</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">config *oci.RuntimeConfig</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å‰ shim service ä¸­çš„å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">containers <span class="keyword">map</span>[<span class="type">string</span>]*container</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹ä»¶æ¶ˆè´¹é˜Ÿåˆ—ï¼ˆTaskCreateã€TaskStartã€TaskDeleteã€TaskPausedã€TaskResumedã€TaskOOMã€TaskExecAdded å’Œ TaskExecStartedï¼‰</span></span><br><span class="line">events      <span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">eventSendMu sync.Mutex</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”± container engine è§¦å‘çš„å…³åœå‡½æ•°</span></span><br><span class="line">cancel    <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="comment">// ç”± container engine ä¼ å…¥çš„ä¿¡æ¯</span></span><br><span class="line">namespace <span class="type">string</span></span><br><span class="line">id       <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸè¯­ä¹‰ä¸º VM ä¸­çš„å®¹å™¨ PIDï¼Œä½†æ˜¯åœ¨ kata æ¨¡å‹ä¸­ shimv2 æ— æ³•è·å¾—ï¼Œå› æ­¤è¿™é‡Œä¸º hypervisor çš„ PID</span></span><br><span class="line">hpid <span class="type">uint32</span></span><br><span class="line"><span class="comment">// shimv2 çš„ PID</span></span><br><span class="line">pid  <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>main å‡½æ•°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/containerd-shim-kata-v2/main.go#L24">source code</a></p><ol><li>å¦‚æœæŒ‡å®šçš„å‚æ•°ä¸º â€“versionï¼Œåˆ™å±•ç¤ºå…¶ç‰ˆæœ¬ã€commit ç­‰ä¿¡æ¯</li><li>é€šè¿‡ shim APIï¼Œåˆå§‹åŒ–å¹¶å¯åŠ¨ shim serverï¼Œæ³¨å†Œåç§°ä¸º containerd-shim-kata-v2ï¼Œå…¶ä¸­ NoReaper å’Œ NoSubreaper å‡ä¸º true<ol><li>åˆå§‹åŒ– containerd-kata-shim-v2 æ¨¡å—çš„ loggerï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ debug æ—¥å¿—çº§åˆ«ï¼Œåˆ™é»˜è®¤è®¾ç½®ä¸º warn çº§åˆ«ï¼Œä»¥æ­¤ logger ä¸ºåŸºå‡†ï¼Œè®¾ç½® virtcontainers ä¸ katautils æ¨¡å—çš„ logger</li><li>æ ¡éªŒå¯åŠ¨æ—¶æ˜¯å¦æŒ‡å®šäº† â€“namespce å‚æ•°ï¼ˆåœ¨ Kubernetes é›†ç¾¤ä¸­ä¸º k8s.ioï¼ŒDocker ä¸­ä¸º mobyï¼Œé»˜è®¤ä¸º defaultï¼‰</li><li>å¯åŠ¨ goroutineï¼ŒæŒç»­å¤„ç† service ä¸­çš„ exit channelï¼Œæ„å»º TaskExit äº‹ä»¶å‘é€è‡³ events channel ä¸­</li><li>åˆå§‹åŒ– eventForwarderï¼Œå¹¶å¯åŠ¨ goroutine è°ƒç”¨ eventForwarder çš„ <strong>forward</strong> æŒç»­ä¸ŠæŠ¥äº‹ä»¶</li><li>è¿”å› serviceï¼Œäº¤ç»™ Containerd è´Ÿè´£é’ˆå¯¹æ¯ä¸ªå®¹å™¨å¯åŠ¨ shim server</li></ol></li></ol><h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>shim server å¯¹å¤–æš´éœ²çš„ gRPC æœåŠ¡ã€‚</p><h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><p><strong>è·å–è¿›ç¨‹çš„è¿è¡Œæ—¶çŠ¶æ€</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L628">source code</a></p><ol><li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StateRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span>   </span><br><span class="line">ExecID               <span class="type">string</span>      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StateResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span>      </span><br><span class="line">Bundle               <span class="type">string</span>      </span><br><span class="line">Pid                  <span class="type">uint32</span>      </span><br><span class="line">Status               task.Status </span><br><span class="line">Stdin                <span class="type">string</span>      </span><br><span class="line">Stdout               <span class="type">string</span>     </span><br><span class="line">Stderr               <span class="type">string</span>      </span><br><span class="line">Terminal             <span class="type">bool</span>       </span><br><span class="line">ExitStatus           <span class="type">uint32</span>      </span><br><span class="line">ExitedAt             time.Time   </span><br><span class="line">ExecID               <span class="type">string</span>           </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>æ ¹æ®å®¹å™¨ä¸­çš„å±æ€§æ„å»ºè¿”å›æ¶ˆæ¯ï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec ä¸­çš„å±æ€§ä¸ºå‡†</p></li></ol><h2 id="Create"><a href="#Create" class="headerlink" title="Create"></a>Create</h2><p><strong>ä½¿ç”¨åº•å±‚ OCI è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L381">source code</a></p><ol><li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CreateTaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span>         </span><br><span class="line">Bundle               <span class="type">string</span>         </span><br><span class="line">Rootfs               []*types.Mount </span><br><span class="line">Terminal             <span class="type">bool</span></span><br><span class="line">Stdin                <span class="type">string</span></span><br><span class="line">Stdout               <span class="type">string</span></span><br><span class="line">Stderr               <span class="type">string</span></span><br><span class="line">Checkpoint           <span class="type">string</span></span><br><span class="line">ParentCheckpoint     <span class="type">string</span></span><br><span class="line">Options              *types1.Any    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CreateTaskResponse <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// shimv2 æ— æ³•ä» VM è·å–å®¹å™¨è¿›ç¨‹ PIDï¼Œå› æ­¤åç»­å¯¹äºéœ€è¦ PID çš„è¿”å›å€¼ï¼Œç›´æ¥è¿”å› hypervisor çš„ PID å³å¯</span></span><br><span class="line">Pid                  <span class="type">uint32</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ ¡éªŒ r.ID æ˜¯å¦ä¸ä¸ºç©ºï¼Œä¸”æ­£åˆ™åŒ¹é…æ»¡è¶³ ^[a-zA-Z0-9][a-zA-Z0-9_.-]+$</p></li><li><p>è°ƒç”¨ <strong>create</strong>ï¼Œåˆ›å»ºå®¹å™¨ï¼Œå°†è¿”å›çš„å®¹å™¨çŠ¶æ€è®¾ä¸º createdï¼Œå¹¶ç»´æŠ¤åœ¨ service.containers ä¸­</p></li><li><p>å‘é€ TaskCreate äº‹ä»¶è‡³ service.events ä¸­</p></li></ol><h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p><strong>åŸºäº service å®ä¾‹å’Œè¯·æ±‚æ¶ˆæ¯åˆ›å»ºå®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/create.go#L51">source code</a></p><ol><li><p>åˆå§‹åŒ–ç©ºçš„ rootfs å¯¹è±¡ï¼Œå¦‚æœè¯·æ±‚ä¸­ r.Rootfs å·²ç»æä¾›äº†ä¸€ä¸ªï¼Œåˆ™ä»¥æ­¤ä¸ºå‡†ï¼Œä¸°å¯Œ rootfs å¯¹è±¡</p></li><li><p>å°† r.Bundle ä¸‹çš„ config.json æ–‡ä»¶ï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;config.jsonï¼Œè¯¥æ–‡ä»¶å³ä¸º <a href="https://github.com/opencontainers/runtime-spec/blob/main/config.md">OCI spec</a>ï¼Œç”± container manager äº‹å…ˆåˆ›å»ºï¼‰ï¼Œè§£æä¸º OCI spec ç»“æ„</p><ol><li>æ ¡éªŒ r.ID ä¸ r.Bundle æ˜¯å¦ä¸ä¸ºç©ºï¼Œå¹¶ä¸” r.Bundle å­˜åœ¨ä¸”ä¸ºç›®å½•ç»“æ„ï¼Œè·å– r.Bundle ç¬¦å·é“¾æ¥ï¼ˆå¦‚æœæ˜¯ï¼‰æŒ‡å‘çš„è·¯å¾„å</li><li>è·å– r.Bundle ç›®å½•ä¸‹çš„ config.jsonï¼Œè¯»å–å…¶å†…å®¹ï¼Œè§£æ„æˆ compatOCISpec ç»“æ„ï¼ˆä¸ºäº†å…¼å®¹ v1.0.0-rc4 å’Œ v1.0.0-rc5ï¼Œå‚è€ƒï¼š<a href="https://github.com/opencontainers/runtime-spec/commit/37391fb%EF%BC%89">https://github.com/opencontainers/runtime-spec/commit/37391fbï¼‰</a></li><li>ä¸åŒç‰ˆæœ¬ä¸‹ spec.Process.Capabilities å­—æ®µå±æ€§ä¸åŒï¼Œé€šè¿‡ç±»å‹æ–­è¨€ï¼Œå°†å…¶ä»¥åŠ compatOCISpec è½¬æ¢æˆå¯¹åº”çš„ OCI specï¼ˆå®é™…ä¸Šï¼Œå®¹å™¨è¿è¡Œåï¼Œspec ä¿¡æ¯å¯ä»¥é€šè¿‡ crictl inspect xxx æˆ–è€… ctr c info xxx æŸ¥çœ‹åˆ°ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹ config.json æ–‡ä»¶ï¼‰ï¼Œå¹¶è¿”å›</li></ol></li><li><p>æ ¹æ® spec ä¸­çš„ annotation ä¿¡æ¯åˆ¤æ–­å…¶å®¹å™¨ç±»å‹ï¼Œå¹¶è½¬æ¢æˆ virtcontainers ä¸­å®šä¹‰çš„å®¹å™¨ç±»å‹</p><ol><li>åˆ¤æ–­ spec.Annotations ä¸­æ˜¯å¦åŒ…å« io.kubernetes.cri.container-typeã€io.kubernetes.cri-o.ContainerType å’Œ io.kubernetes.docker.type çš„ keyï¼ˆåˆ†åˆ«ä»£è¡¨ Containerdã€CRI-O å’Œ Dockershim ä¸‰ç§ CRIï¼‰</li><li>è·å¾— key å¯¹åº”çš„ valueï¼ˆvalue å³ä¸ºå®¹å™¨çš„ç±»å‹ï¼‰ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼Œåˆ†åˆ«æ˜¯ sandbox å’Œ containerï¼ŒåŒºåˆ«äº CRI çš„ä¸åŒï¼Œå…·ä½“çš„åç§°æœ‰æ‰€åŒºåˆ«ï¼ˆContainerd å’Œ CRI-O ä¸­ç§°ä¸º sandbox å’Œ containerï¼Œè€Œ Dockershim ä¸­ç§°ä¸º podsandbox å’Œ containerï¼‰</li><li>æ ¹æ®å®¹å™¨ç±»å‹ï¼Œæ˜ å°„å‡º virtcontainers ä¸­çš„å®¹å™¨ç±»åˆ«ï¼Œä¾‹å¦‚ pod_sandbox å’Œ pod_containerï¼Œå½“ spec.Annotations ä¸­æœªè¯†åˆ«åˆ°ä¸Šè¿°ä¸‰ç§ keyï¼Œåˆ™è§†ä¸º single_containerï¼Œå³é Pod å®¹å™¨ï¼ˆå¦‚é€šè¿‡ ctrï¼Œpodman å¯åŠ¨è¿è¡Œï¼‰</li><li>æ­¤å¤–ï¼ŒåŒ¹é…åˆ° keyï¼Œä½†æ˜¯ value ä¸ç¬¦åˆ sandbox å’Œ container çš„ï¼Œå‡è§†ä¸º unknown_container_type</li></ol></li><li><p>æ„å»º runtimeConfigï¼ˆruntimeConfig èšåˆäº†è¿è¡Œæ—¶æ‰€æœ‰çš„è®¾ç½®ä¿¡æ¯ï¼Œåç»­çš„æ“ä½œä¸­ä¸å†è§£æé…ç½®æ–‡ä»¶ï¼‰ï¼Œä¼˜å…ˆçº§ä¾æ¬¡ä» spec.Annotationsã€shimv2 è¯·æ±‚ä¼ å‚å’Œç¯å¢ƒå˜é‡ä¸­è·å–</p><ol><li>è·å– spec.Annotations ä¸­ key ä¸º io.katacontainers.config_path çš„ value ä½œä¸º configPathï¼ˆä¹Ÿå°±æ˜¯ Kata Containers çš„é™æ€é…ç½®æ–‡ä»¶ï¼‰</li><li>å½“ configPath ä¸ºç©ºæ—¶ï¼Œå°è¯•ä» r.Options ä¸­è·å–ï¼ˆå…¶ä¸­åœ¨ç±»å‹æ–­è¨€æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ github.com&#x2F;containerd&#x2F;containerd&#x2F;pkg&#x2F;runtimeoptions&#x2F;v1 ä¸­çš„ Options ç±»å‹ï¼Œä¸ºäº†å…¼å®¹ 1.4.3ã€1.4.4 ç‰ˆæœ¬çš„ Containerdï¼Œé€€è€Œä½¿ç”¨ github.com&#x2F;containerd&#x2F;cri-containerd&#x2F;pkg&#x2F;api&#x2F;runtimeoptions&#x2F;v1 ä¸­çš„ Options ç±»å‹ï¼‰</li><li>å¦‚æœæ­¤æ—¶ configPath ä»ä¸ºç©ºï¼Œåˆ™ä»ç¯å¢ƒå˜é‡ KATA_CONF_FILE ä¸­è·å–</li><li>å¦‚æœ configPath ä¸ºç©ºï¼Œåˆ™æŒ‰åºä¼˜å…ˆè¯»å– &#x2F;etc&#x2F;kata-containers&#x2F;configuration.toml å’Œ &#x2F;usr&#x2F;share&#x2F;defaults&#x2F;kata-containers&#x2F;configuration.toml é…ç½®æ–‡ä»¶å†…å®¹ï¼Œæ„å»º runtimeConfig</li></ol></li><li><p>æ ¡éªŒéƒ¨åˆ†é…ç½®é¡¹</p><ol><li>[runtime].experimental ç‰¹æ€§æ˜¯å¦æ”¯æŒ</li><li>[runtime].sandbox_bind_mounts æŒ‚è½½ç‚¹æ˜¯å¦åµŒå¥—ï¼ˆå³æŒ‚è½½ç‚¹çš„ base ç›®å½•å­˜åœ¨é‡å¤ï¼‰</li><li>å½“ [runtime].disable_new_netns å¯ç”¨æ—¶ï¼Œ[runtime].internetworking_model æ˜¯å¦è®¾ç½®ä¸º none</li><li>[hypervisor].default_memory æ˜¯å¦ä¸ä¸º 0ã€‚å½“ guest é•œåƒé‡‡ç”¨ initrd æ ¼å¼æ—¶ï¼Œ[hypervisor].default_memory å¿…é¡»å¤§äºé•œåƒå¤§å°ï¼ˆå› ä¸º initrd ä¼šå®Œå…¨è¯»åˆ°å†…å­˜ä¸­ï¼‰ï¼›å½“ guest é•œåƒé‡‡ç”¨ image æ ¼å¼æ—¶ï¼Œé•œåƒå¤§å°å¤§äº [hypervisor].default_memory æ—¶ï¼Œä¼šè¾“å‡ºè­¦å‘Šä¿¡æ¯ï¼ˆè™½ç„¶ image ä¸ä¼šå®Œå…¨è¯»åˆ°å†…å­˜ä¸­ï¼Œä½†æ˜¯æ­¤æƒ…å†µå¹¶éæ­£å¸¸ç°è±¡ï¼‰</li><li>å½“ [factory].enable_template å¯ç”¨æ—¶ï¼Œguest é•œåƒç±»å‹å¿…é¡»ä¸º initrd æ ¼å¼ï¼›å½“ [factory].vm_cache_number å¤§äº 0 æ—¶ï¼Œhypervisor ç±»å‹å¿…é¡»ä¸º QEMU</li></ol></li><li><p>æ ¹æ®ä¸åŒçš„å®¹å™¨ç±»å‹ï¼ŒåŸºäºé…ç½®æ–‡ä»¶å†…å®¹åˆ›å»ºå®¹å™¨</p><p><em><strong>pod_sandbox æˆ– single_container</strong>ï¼ˆä»¥ä¸‹ç»Ÿç§°ä¸º pod_sandboxï¼‰</em></p><ol><li><p>å½“ service.sandbox ä¸ä¸ºç©ºæ—¶ï¼Œæ„å‘³ç€å½“å‰å®¹å™¨ç¯å¢ƒå·²ç»å­˜åœ¨ä¸€ä¸ª sandboxï¼ˆåªæœ‰åœ¨å®Œæˆåˆ›å»ºå®¹å™¨åæ‰ä¼šå›å†™è¯¥å­—æ®µï¼‰ï¼Œæ˜¯æ— æ³•åµŒå¥—åˆ›å»º sandbox çš„</p></li><li><p>åŸºäº [runtime].jaeger_endpointã€[runtime].jaeger_user å’Œ [runtime].jaeger_password åˆ›å»º jaeger tracer</p></li><li><p>å¦‚æœå®¹å™¨ç±»å‹ä¸º pod_sandboxï¼Œåˆ™åŸºäº spec.Annotations ä¸­çš„ io.kubernetes.cri.sandbox-memoryã€io.kubernetes.cri.sandbox-cpu-period å’Œ io.kubernetes.cri.sandbox-cpu-quotaï¼Œè®¡ç®— VM çš„èµ„æºå¤§å°ï¼›å¦‚æœå®¹å™¨ç±»å‹ä¸º single_containerï¼Œåˆ™åŸºäº spec.Linux.Resources ä¸­çš„ Memory.Limitã€CPU.Quota å’Œ CPU.Periodï¼Œè®¡ç®— VM çš„èµ„æºå¤§å°ã€‚ä¸¤è€…å…¬å¼ä¸€è‡´ï¼š</p><blockquote><p>CPU &#x3D; (cpu-quota * 1000 &#x2F; cpu-period + 999) &#x2F; 1000</p><p>MEM &#x3D; memory &#x2F; 1024 &#x2F;1024</p></blockquote></li><li><p>æ£€æŸ¥å®¹å™¨çš„ rootfs ç›®å½•æ˜¯å¦éœ€è¦æŒ‚è½½</p><ol><li>å¦‚æœè¯·æ±‚ä¸­ r.Rootfs æŒ‡å®šäº†ä¸€ä¸ªï¼Œåˆ™åˆ¤æ–­å…¶æ˜¯å¦ä¸ºå—è®¾å¤‡ï¼Œå¹¶ä¸” [hypervisor].disable_block_device_use ä¸º falseï¼ˆdisable_block_device_use ç¦æ­¢å—è®¾å¤‡ç”¨äºå®¹å™¨çš„ rootfsã€‚ åœ¨åƒ devicemapper è¿™æ ·çš„å­˜å‚¨é©±åŠ¨ç¨‹åºä¸­ï¼Œå®¹å™¨çš„ rootfs ç”±å—è®¾å¤‡æ”¯æŒï¼Œå‡ºäºæ€§èƒ½åŸå› ï¼Œå—è®¾å¤‡ç›´æ¥ä¼ é€’ç»™ hypervisorã€‚ è¿™ä¸ªæ ‡å¿—é˜»æ­¢å—è®¾å¤‡è¢«ä¼ é€’ç»™ hypervisorï¼Œè€Œä½¿ç”¨ virtio-fs ä¼ é€’ rootfsï¼‰ï¼›æˆ–è€…ï¼Œrootfs çš„ç±»å‹ä¸º fuse.nydus-overlayfsã€‚æ»¡è¶³æ¡ä»¶ä¹‹ä¸€ï¼Œå³ä¸éœ€è¦æŒ‚è½½ï¼Œè€Œæ˜¯èµ°åç»­çš„çƒ­æ’æµç¨‹</li><li>åˆ›å»º rootfs ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼Œéå† r.Rootfsï¼ŒæŒ‚è½½è‡³ rootfs ç›®å½•ä¸‹ï¼ˆå³ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼‰</li></ol></li><li><p>åŸºäº factory é…ç½®é¡¹ï¼Œå°è¯•è·å–ç°æœ‰ VM factoryï¼Œå¦‚æœè·å–å¤±è´¥ä¸”æœªå¯ç”¨ VM cache ç‰¹æ€§æ—¶ï¼Œä¼šåˆå§‹åŒ–æ–°çš„ VM factoryï¼Œå¹¶è°ƒç”¨ vircontainers çš„ <strong>SetFactory</strong>ï¼Œé€ä¼  VM factory</p></li><li><p>åŸºäº [hypervisor].rootless è®¾ç½® rootlessï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼ŒQEMU ä»¥ root èº«ä»½è¿è¡Œã€‚ å½“è®¾ç½®ä¸º true æ—¶ï¼ŒQEMU å°†ä»¥é root çš„éšæœºç”¨æˆ·è¿è¡Œï¼‰ï¼Œå¦‚æœå¯ç”¨ rootlessï¼Œåˆ™é¢å¤–æ‰§è¡Œä»¥ä¸‹æµç¨‹</p><ol><li>åˆ›å»ºä¸€ä¸ªç”¨äºè¿è¡Œ Kata Containers çš„éšæœºç”¨æˆ·</li><li>æ ¹æ®ç”¨æˆ·åè·å–å¹¶è®¾ç½® UID å’Œ GID</li><li>åˆ›å»ºç”¨æˆ·ç›®å½•ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡ XDG_RUNTIME_DIR</li><li>å°† KVM GID æ·»åŠ åˆ° hypervisor é…ç½®é¡¹ä¸­çš„è¡¥å……ç»„ä¸­ï¼Œä½¿ hypervisor è¿›ç¨‹å¯ä»¥è®¿é—® &#x2F;dev&#x2F;kvm è®¾å¤‡</li></ol></li><li><p>åŸºäºä¸Šè¿°æ„å»ºçš„ OCI specã€runtimeConfigã€rootfsã€bundleã€containerID ç­‰ä¿¡æ¯åˆ›å»º sandbox</p><ol><li>å°† OCI spec å’Œ runtimeConfig è½¬ä¸º virtcontainers æ‰€éœ€çš„é…ç½®ç»“æ„ï¼ˆå³ sandboxConfigï¼‰<br><br>é¢å¤–æ³¨æ˜ï¼ša. éƒ¨åˆ†å‚æ•°å½“ OCI spec annotations ä¸­æœ‰å£°æ˜æ—¶ï¼Œä¼šä»¥ annotations ä¸ºå‡†ï¼Œå‰ææ˜¯ [hypervisor].enable_annotations ä¸­å£°æ˜äº†å…è®¸åŠ¨æ€åŠ è½½çš„é…ç½®é¡¹ä¸”è¯¥é…ç½®é¡¹åˆæ³•ï¼›b. å½“å¯ç”¨ [hypervisor].static_sandbox_resource_mgmtï¼ŒVM è§„æ ¼ä¼šè¢«é™æ€é…ç½®ï¼Œè€Œéå¯åŠ¨åçƒ­æ’æ‹”ï¼Œå› æ­¤ CPU èµ„æºè§„æ ¼ä¸º [hypervisor].default_vcpus + &lt;workloadCPUs&gt;ï¼Œå†…å­˜åŒç†</li><li>å½“ host å¯ç”¨ FIPS æ—¶ï¼ˆå³ &#x2F;proc&#x2F;sys&#x2F;crypto&#x2F;fips_enabled ä¸º 1ï¼‰ï¼ŒsandboxConfig ä¸­é¢å¤–è¿½åŠ  kernel å‚æ•°</li><li>å¯åŠ¨å®¹å™¨å‰ä¼˜å…ˆåˆ›å»º netnsã€‚å½“ [runtime].disable_new_netns å¯ç”¨æ—¶ï¼ˆè¡¨ç¤º shim å’Œ hypervisor ä¼šè¿è¡Œåœ¨ host netns ä¸­ï¼Œè€Œéåˆ›å»ºæ–°çš„ï¼‰ï¼Œåˆ™ç›´æ¥è·³è¿‡åç»­åˆ›å»ºï¼›å¦åˆ™ï¼Œå½“ networkIDï¼ˆspec.Linux.Namespace ä¸­ type ä¸º network çš„ pathï¼‰ä¸ºç©ºæ—¶ï¼ˆè¡¨ç¤º netns å¹¶éç”± CNI æå‰åˆ›å»ºå¥½ï¼Œè€Œæ˜¯éœ€è¦ç”± Kata Containers åˆ›å»ºï¼Œæ¯”å¦‚è„±ç¦» K8s è¿è¡Œ Kata çš„åœºæ™¯ä¸­ï¼‰ï¼Œåˆ™æ ¹æ®å…·ä½“æ˜¯å¦ä¸º rootlessï¼Œæ‰§è¡Œå¯¹åº”çš„åˆ›å»ºç½‘ç»œå‘½åç©ºé—´æµç¨‹ã€‚å¦‚æœä¸ºæå‰åˆ›å»ºå¥½çš„ netnsï¼Œéœ€è¦åˆ¤æ–­å…¶æ˜¯å¦ä¸å½“å‰è¿›ç¨‹çš„ netns ä¸ä¸€è‡´ï¼ˆå½“å‰è¿›ç¨‹å¯ä»¥ä»£è¡¨ host ç½‘ç»œï¼Œè€Œ Kata Containers æ˜¯ä¸æ”¯æŒé‡‡ç”¨ host ç½‘ç»œä½œä¸ºå®¹å™¨ç½‘ç»œçš„ï¼‰</li><li>æ‰§è¡Œ spec.Hooks.Prestartï¼ˆPrestart æ˜¯åœ¨æ‰§è¡Œå®¹å™¨è¿›ç¨‹ä¹‹å‰è¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼Œç°å·²åºŸå¼ƒï¼‰ ä¸­å®šä¹‰çš„åŠ¨ä½œ</li><li>æ‰§è¡Œ spec.Hooks.CreateRuntimeï¼ˆCreateRuntime æ˜¯åœ¨åˆ›å»ºå®¹å™¨ä¹‹åä½†åœ¨è°ƒç”¨ pivot_root æˆ–ä»»ä½•ç­‰æ•ˆæ“ä½œä¹‹å‰è¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼‰ ä¸­å®šä¹‰çš„åŠ¨ä½œ</li><li>è°ƒç”¨ VC çš„ <strong>CreateSandbox</strong>ï¼Œæ ¹æ® sandboxConfig ä¿¡æ¯åˆ›å»º sandboxï¼Œå¹¶å¯åŠ¨ pod_sandbox å®¹å™¨</li><li>è°ƒç”¨ VCSandbox çš„ <strong>GetAllContainers</strong>ï¼Œæ ¡éªŒ sandbox ä¸­çš„å®¹å™¨æ€»æ•°é‡æ˜¯å¦ä¸º 1ï¼Œè¿”å› sandbox</li></ol></li><li><p>è®¾ç½® service.sandbox ä¸ºä¸Šé¢è¿”å›çš„ sandboxï¼Œè°ƒç”¨ VCSandbox çš„ <strong>GetHypervisorPid</strong>ï¼Œè·å– hypervisor çš„ PIDï¼Œè®¾ç½®è‡³ service.hpid ä¸­</p></li><li><p>å¯åŠ¨ç›‘å¬ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock åœ°å€çš„ shim serverï¼Œæ³¨å†ŒæœåŠ¡æœ‰ &#x2F;metricsã€&#x2F;agent-urlã€&#x2F;direct-volume&#x2F;statsã€&#x2F;direct-volume&#x2F;resizeã€&#x2F;iptablesã€&#x2F;ip6tables ä»¥åŠ Pprofï¼Œæ³¨å†Œä¸ŠæŠ¥è‡³ Prometheus çš„ shim ç›¸å…³æŒ‡æ ‡ä»¥åŠ sandbox ç›¸å…³æŒ‡æ ‡</p></li></ol><p><em><strong>pod_container</strong></em></p><ol><li>æ ¡éªŒ service.sandbox æ˜¯å¦ä¸ä¸ºç©ºï¼ˆå› ä¸º pod_container çš„è¿è¡Œæ˜¯è¦ä¾æ‰˜äº pod_sandboxï¼‰</li><li>æ£€æŸ¥å®¹å™¨çš„ rootfs ç›®å½•æ˜¯å¦éœ€è¦æŒ‚è½½<ol><li>å¦‚æœè¯·æ±‚ä¸­ r.Rootfs æŒ‡å®šäº†ä¸€ä¸ªï¼Œåˆ™åˆ¤æ–­å…¶æ˜¯å¦ä¸ºå—è®¾å¤‡ï¼Œå¹¶ä¸” [hypervisor].disable_block_device_use ä¸º falseï¼ˆdisable_block_device_use ç¦æ­¢å—è®¾å¤‡ç”¨äºå®¹å™¨çš„ rootfsã€‚ åœ¨åƒ devicemapper è¿™æ ·çš„å­˜å‚¨é©±åŠ¨ç¨‹åºä¸­ï¼Œå®¹å™¨çš„ rootfs ç”±å—è®¾å¤‡æ”¯æŒï¼Œå‡ºäºæ€§èƒ½åŸå› ï¼Œå—è®¾å¤‡ç›´æ¥ä¼ é€’ç»™ hypervisorã€‚ è¿™ä¸ªæ ‡å¿—é˜»æ­¢å—è®¾å¤‡è¢«ä¼ é€’ç»™ hypervisorï¼Œè€Œä½¿ç”¨ virtio-fs ä¼ é€’ rootfsï¼‰ï¼›æˆ–è€…ï¼Œrootfs çš„ç±»å‹ä¸º fuse.nydus-overlayfsã€‚æ»¡è¶³æ¡ä»¶ä¹‹ä¸€ï¼Œå³ä¸éœ€è¦æŒ‚è½½ï¼Œè€Œæ˜¯èµ°åç»­çš„çƒ­æ’æµç¨‹</li><li>åˆ›å»º rootfs ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰ï¼Œéå† r.Rootfsï¼ŒæŒ‚è½½ rootfs ç›®å½•</li></ol></li><li>åŸºäºä¸Šè¿°æ„å»ºçš„ OCI specã€runtimeConfigã€rootfsã€bundleã€containerID ç­‰ä¿¡æ¯åˆ›å»º container ç±»å‹å®¹å™¨<ol><li>éå† spec.Mountsï¼Œå¦‚æœæŒ‚è½½æºè·¯å¾„ç”± K8s ä¸´æ—¶å­˜å‚¨ï¼ˆå³è·¯å¾„ä¸­æœ‰ kubernetes.io~empty-dir æ ‡è¯†ï¼Œä¸”æ–‡ä»¶ç±»å‹ä¸º tmpfsï¼‰ï¼Œåˆ™å°† spec.Mounts ä¸­å¯¹åº”æŒ‚è½½ç‚¹çš„ç±»å‹è®¾ç½®ä¸º ephemeralï¼›å¦‚æœæŒ‚è½½æºè·¯å¾„ç”± K8s emptydirï¼ˆå³è·¯å¾„ä¸­æœ‰ kubernetes.io~empty-dir æ ‡è¯†ï¼Œä¸”æ–‡ä»¶ç±»å‹ä¸ä¸º tmpfsï¼‰ ä¸” runtimeConfig æ²¡æœ‰ç¦ç”¨ disable_guest_empty_dirï¼ˆå¦‚æœå¯ç”¨ï¼Œå°†ä¸ä¼šåœ¨ guest çš„æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»º emptydir æŒ‚è½½ï¼Œè€Œæ˜¯åœ¨ host ä¸Šåˆ›å»ºï¼Œç”± virtiofs å…±äº«ï¼Œæ€§èƒ½è¾ƒå·®ï¼Œä½†æ˜¯å¯ä»¥å®ç° host å’Œ guest å…±äº«æ–‡ä»¶ï¼‰ï¼Œåˆ™å°† spec.Mounts ä¸­å¯¹åº”æŒ‚è½½ç‚¹çš„ç±»å‹è®¾ç½®ä¸º local ï¼ˆå¯¹äºç»™å®šçš„ Podï¼Œä¸´æ—¶å·ä»…åœ¨ VM å†…ç”± tmpfs æ”¯æŒæ—¶åˆ›å»ºä¸€æ¬¡ã€‚ å¯¹äºåŒä¸€ Pod çš„è¿ç»­å®¹å™¨ï¼Œå°†é‡å¤ä½¿ç”¨å·²ç»å­˜åœ¨çš„å·ï¼‰</li><li>å°† OCI spec å’Œ runtimeConfig è½¬ä¸º virtcontainers æ‰€éœ€çš„é…ç½®ç»“æ„ï¼ˆå³ containerConfigï¼‰</li><li>æ ¹æ® spec.Annotations ä¸­çš„ io.kubernetes.cri.sandbox-idã€io.kubernetes.cri-SandboxID å’Œ io.kubernetes.sandbox.id çš„ keyï¼ˆåˆ†åˆ«ä»£è¡¨ Containerdã€CRI-O å’Œ Dockershim ä¸‰ç§ CRIï¼‰ï¼Œè·å–åˆ° valueï¼ˆvalue å³ä¸º sandboxIDï¼‰</li><li>è°ƒç”¨ VCSandbox çš„ <strong>CreateContainer</strong>ï¼Œåˆ›å»ºå®¹å™¨</li><li>è¿›å…¥åˆ° sandbox çš„ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæ‰§è¡Œ spec.Hooks.Prestartï¼ˆPrestart æ˜¯åœ¨æ‰§è¡Œå®¹å™¨è¿›ç¨‹ä¹‹å‰è¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼Œç°å·²åºŸå¼ƒï¼‰ ä¸­å®šä¹‰çš„åŠ¨ä½œ</li></ol></li></ol></li><li><p>æ„å»ºå¹¶è¿”å›å®¹å™¨</p></li></ol><h2 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h2><p><strong>å¯åŠ¨å®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L440">source code</a></p><ol><li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StartRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">ExecID               <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StartResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">Pid                  <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>å¦‚æœ r.ExecID ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <strong>startContainer</strong>ï¼Œå¯åŠ¨å®¹å™¨ï¼Œå¹¶å‘é€ TaskStart äº‹ä»¶è‡³ service.events ä¸­ï¼›å¦åˆ™ï¼Œè°ƒç”¨ <strong>startExec</strong>ï¼Œå¯åŠ¨ exec è¿›ç¨‹ï¼Œå¹¶å‘é€ TaskExecStart äº‹ä»¶è‡³ service.events ä¸­</p></li></ol><h3 id="startContainer"><a href="#startContainer" class="headerlink" title="startContainer"></a>startContainer</h3><p><strong>å¤„ç†å¯åŠ¨å®¹å™¨è¯·æ±‚</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/start.go#L18">source code</a></p><ol><li>å¦‚æœå®¹å™¨ç±»å‹ä¸º pod_sandbox<ol><li>è°ƒç”¨ VCSandbox çš„ <strong>Start</strong>ï¼Œå¯åŠ¨ sandbox</li><li>è°ƒç”¨ VCSandbox çš„ <strong>Monitor</strong>ï¼Œå¯åŠ¨ monitorï¼Œå¹¶è®¾ç½®åœ¨ service.monitor ä¸­</li><li>å¯åŠ¨ goroutineï¼Œç›‘å¬ service.monitor ä¸­çš„é”™è¯¯å’Œé€€å‡ºä¿¡å·ã€‚å¦‚æœç›‘å¬åˆ°ï¼ˆè§†ä¸ºå¼‚å¸¸ï¼‰ï¼Œåˆ™è°ƒç”¨ VCSandbox çš„ <strong>Stop</strong> å’Œ <strong>Delete</strong>ï¼Œå…³åœä¸é”€æ¯ sandbox å¹¶æ¸…ç†ç›¸å…³èµ„æº</li><li>ç§»é™¤ rootfs æŒ‚è½½ç‚¹ï¼ˆæ³¨æ„ï¼šæ­¤å¤„æ¸…ç†çš„ä¸º &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼Œè€Œå…±äº«ç›®å½•ä¸‹çš„ rootfs åœ¨ä¸Šè¿°æ­¥éª¤ 3 ä¸­å·²ç»æ¸…ç†ï¼‰</li><li>å¯åŠ¨ goroutineï¼Œè°ƒç”¨ VCSandbox çš„ <strong>GetOOMEvent</strong>ï¼ˆå¦‚æœæ˜¯ç”±äº Kata agent å…³åœï¼Œè¿”å›ç±»ä¼¼ ttrpc: closed æˆ–è€… Dead agent çš„é”™è¯¯æ—¶ï¼Œåˆ™ä¸å†ç›‘å¬ï¼›å…¶ä»–å¼‚å¸¸æƒ…å†µï¼Œä»é‡æ–°å°è¯•è°ƒç”¨æ¥å£ï¼‰ï¼Œç›‘å¬ OOM äº‹ä»¶ã€‚å½“æ”¶åˆ° OOM äº‹ä»¶åï¼Œå¦‚æœ container manager ä¸º CRI-O æ—¶ï¼Œåˆ™åœ¨ä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt; ç›®å½•ä¸‹ï¼Œåˆ›å»ºåä¸º oom çš„æ–‡ä»¶ï¼Œç”¨äºé€šçŸ¥ CRI-Oï¼›å¦‚æœ container manager ä¸º Containerd æ—¶ï¼Œåˆ™å‘é€ TaskOOM äº‹ä»¶è‡³ service.events ä¸­</li></ol></li><li>å¦‚æœå®¹å™¨çš„ç±»å‹ä¸ä¸º pod_sandboxï¼Œåˆ™è°ƒç”¨ VCSandbox çš„ <strong>StartContainer</strong>ï¼Œå¯åŠ¨å®¹å™¨</li><li>è¿›å…¥åˆ° sandbox çš„ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œæ‰§è¡Œ spec.Hooks.Poststartï¼ˆPoststart æ˜¯åœ¨å®¹å™¨è¿›ç¨‹å¯åŠ¨åè¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼‰ ä¸­å®šä¹‰çš„åŠ¨ä½œ</li><li>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º running</li><li>è°ƒç”¨ VCSandbox çš„ <strong>IOStream</strong>ï¼Œå¯åŠ¨ goroutineï¼Œå®æ—¶å¤„ç†å®¹å™¨ä¸­çš„æ ‡å‡†è¾“å‡ºç­‰ IO æµ</li><li>å¯åŠ¨ goroutineï¼Œå¤„ç†å®¹å™¨ä¸­çš„é€€å‡ºé˜Ÿåˆ— ï¼Œå³å…ˆç­‰åˆ°å®¹å™¨ IO é€€å‡ºäº‹ä»¶åï¼Œå†è°ƒç”¨ VCSandbox çš„ <strong>WaitProcess</strong>ï¼Œè¿›ä¸€æ­¥ç­‰å¾…è¿›ç¨‹è¿”å›é€€å‡ºç åæ‰§è¡Œåç»­æ¸…ç†æµç¨‹ï¼šå¦‚æœå®¹å™¨ç±»å‹ä¸º pod_sandboxï¼Œåˆ™å…³åœ monitorï¼Œè°ƒç”¨ VCSandbox çš„ <strong>Stop</strong> å’Œ <strong>Delete</strong>ï¼Œå…³åœä¸é”€æ¯ sandboxï¼Œå¹¶æ¸…ç†ç›¸å…³èµ„æºï¼›å¦åˆ™ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>StopContainer</strong>ï¼Œå…³åœå®¹å™¨ã€‚è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º stoppedï¼Œè®°å½•é€€å‡ºæ—¶é—´ï¼ŒçŠ¶æ€ç ç­‰<br><em>ä¾‹å¦‚ï¼Œå½“ Pod å¯åŠ¨ä¹‹åï¼Œpod_sandbox å®¹å™¨ä¼šé€€å‡ºï¼Œæ­¤æ—¶å¯ä»¥æ”¶åˆ° pod_sandbox å®¹å™¨çš„ IO é€€å‡ºäº‹ä»¶ï¼Œä½†æ˜¯åœ¨ WaitProcess æ—¶ï¼Œä¸ä¼šæœ‰è¿”å›ï¼Œå› æ­¤ä¸ä¼šæ‰§è¡Œ sandbox çš„å…³åœä¸é”€æ¯æµç¨‹ï¼›è€Œå½“ Pod åˆ é™¤æ—¶ï¼Œpod_sandbox çš„ WaitProcess æ”¶åˆ°ç»“æœï¼Œä¼´éšç€å…¶ä½™çš„ä¸šåŠ¡å®¹å™¨ä¸€èµ·å…³åœå¹¶åˆ é™¤</em></li><li>å¯åŠ¨ goroutineï¼Œå‘é€é€€å‡ºæ¶ˆæ¯è‡³ service.ec ä¸­</li></ol><h3 id="startExec"><a href="#startExec" class="headerlink" title="startExec"></a>startExec</h3><p><strong>å¤„ç†è¿›å…¥å®¹å™¨è¯·æ±‚</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/start.go#L100">source code</a></p><ol><li>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</li><li>é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec</li><li>è°ƒç”¨ VCSandbox çš„ <strong>EnterContainer</strong>ï¼Œè¿›å…¥å®¹å™¨å†…éƒ¨</li><li>è®¾ç½® exec çŠ¶æ€ä¸º running</li><li>è°ƒç”¨ VCSandbox çš„ <strong>WinsizeProcess</strong>ï¼Œè°ƒæ•´ tty å¤§å°</li><li>è°ƒç”¨ VCSandbox çš„ <strong>IOStream</strong>ï¼Œå¯åŠ¨ goroutineï¼Œå®æ—¶å¤„ç†å®¹å™¨ä¸­çš„æ ‡å‡†è¾“å‡ºç­‰ IO æµ</li><li>å¯åŠ¨ goroutineï¼Œå¤„ç† exec ä¸­çš„é€€å‡ºé˜Ÿåˆ— ï¼Œå³å…ˆç­‰åˆ°å®¹å™¨ IO é€€å‡ºäº‹ä»¶åï¼Œå†è°ƒç”¨ VCSandbox çš„ <strong>WaitProcess</strong>ï¼Œè¿›ä¸€æ­¥ç­‰å¾…è¿›ç¨‹è¿”å›é€€å‡ºç åæ‰§è¡Œåç»­æµç¨‹ã€‚è®¾ç½® exec çŠ¶æ€ä¸º stoppedï¼Œè®°å½•é€€å‡ºæ—¶é—´ï¼ŒçŠ¶æ€ç ç­‰</li><li>å¯åŠ¨ goroutineï¼Œå‘é€é€€å‡ºæ¶ˆæ¯è‡³ service.ec ä¸­</li></ol><h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><p><strong>åˆ é™¤å®¹å™¨æˆ–è€… exec è¿›ç¨‹</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L493">source code</a></p><ol><li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DeleteRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">ExecID               <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DeleteResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">Pid                  <span class="type">uint32</span></span><br><span class="line">ExitStatus           <span class="type">uint32</span></span><br><span class="line">ExitedAt             time.Time </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>å¦‚æœ r.ExecID ä¸ºç©ºï¼Œåˆ™è°ƒç”¨ <strong>deleteContainer</strong>ï¼Œåˆ é™¤å®¹å™¨ï¼Œå¹¶å‘é€ TaskDelete äº‹ä»¶è‡³ service.events ä¸­ï¼›å¦åˆ™ï¼Œç›´æ¥åˆ é™¤ container.execs ä¸­ key ä¸º r.ExecID çš„ exec</p></li></ol><h3 id="deleteContainer"><a href="#deleteContainer" class="headerlink" title="deleteContainer"></a>deleteContainer</h3><p><strong>åˆ é™¤æŒ‡å®šå®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/delete.go#L17">source code</a></p><ol><li>å¦‚æœå®¹å™¨çš„ç±»å‹ä¸æ˜¯ pod_sandboxï¼Œåˆ™å…ˆè°ƒç”¨ VCSandbox çš„ <strong>StopContainer</strong>ï¼Œå…³åœå®¹å™¨ï¼ˆå¦‚æœå®¹å™¨çŠ¶æ€ä¸ä¸º stoppedï¼‰ï¼Œå¹¶è°ƒç”¨ VCSandbox çš„ <strong>DeleteContainer</strong>ï¼Œåˆ é™¤å®¹å™¨</li><li>æ‰§è¡Œ spec.Hooks.Poststopï¼ˆPoststop æ˜¯åœ¨å®¹å™¨è¿›ç¨‹é€€å‡ºåè¦è¿è¡Œçš„ hook åˆ—è¡¨ï¼‰ä¸­å®šä¹‰çš„åŠ¨ä½œ</li><li>å¦‚æœå®¹å™¨æ–‡ä»¶ç³»ç»Ÿå·²ç»æŒ‚è½½å®Œæˆï¼Œåˆ™ç§»é™¤ rootfs æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼Œå…¶åœ¨ host ä¸Šä»¥ overlay æŒ‚è½½ç‚¹å½¢å¼å­˜åœ¨ï¼‰</li><li>åˆ é™¤ s.containers ä¸­çš„ key ä¸º r.ID çš„å®¹å™¨</li></ol><h2 id="Pids"><a href="#Pids" class="headerlink" title="Pids"></a>Pids</h2><p><strong>è¿”å›å®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹ IDï¼Œå¯¹äº Kata Containers è€Œè¨€ï¼Œæ— æ³•ä» VM è·å–è¿›ç¨‹ PIDï¼Œå› æ­¤åªè¿”å› hypervisor çš„ PID</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L829">source code</a></p><ol><li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PidsRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PidsResponse <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// task.ProcessInfo&#123;</span></span><br><span class="line"><span class="comment">//   Pid: s.hpid,</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line">Processes            []*task.ProcessInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Pause"><a href="#Pause" class="headerlink" title="Pause"></a>Pause</h2><p><strong>æš‚åœå®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L684">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PauseRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º pausing</p></li><li><p>è°ƒç”¨ VCSandbox çš„ <strong>PauseContainer</strong>ï¼Œæš‚åœå®¹å™¨</p></li><li><p>å¦‚æœæš‚åœæˆåŠŸï¼Œåˆ™è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º pausedï¼Œå¹¶å‘é€ TaskPaused äº‹ä»¶è‡³ service.events ä¸­ï¼›å¦åˆ™ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>StatusContainer</strong>ï¼ŒæŸ¥è¯¢å®¹å™¨çŠ¶æ€ï¼ˆåˆ†ä¸º readyã€runningã€paused å’Œ stoppedï¼‰ï¼Œå¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œåˆ™å®é™…çŠ¶æ€è§†ä¸º unknownï¼Œè®¾ç½®å®¹å™¨çŠ¶æ€ä¸ºæŸ¥è¯¢åˆ°çš„å®é™…ç»“æœ</p></li></ol><h2 id="Resume"><a href="#Resume" class="headerlink" title="Resume"></a>Resume</h2><p><strong>æ¢å¤å®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L725">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResumeRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>è°ƒç”¨ VCSandbox çš„ <strong>ResumeContainer</strong>ï¼Œæ¢å¤å®¹å™¨</p></li><li><p>å¦‚æœæ¢å¤æˆåŠŸï¼Œåˆ™è®¾ç½®å®¹å™¨çŠ¶æ€ä¸º runningï¼Œå¹¶å‘é€ TaskResumed äº‹ä»¶è‡³ service.events ä¸­ï¼›å¦åˆ™ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>StatusContainer</strong>ï¼ŒæŸ¥è¯¢å®¹å™¨çŠ¶æ€ï¼ˆåˆ†ä¸º readyã€runningã€paused å’Œ stoppedï¼‰ï¼Œå¦‚æœæŸ¥è¯¢å¤±è´¥ï¼Œåˆ™å®é™…çŠ¶æ€è§†ä¸º unknownï¼Œè®¾ç½®å®¹å™¨çŠ¶æ€ä¸ºæŸ¥è¯¢åˆ°çš„å®é™…ç»“æœ</p></li></ol><h2 id="Checkpoint"><a href="#Checkpoint" class="headerlink" title="Checkpoint"></a>Checkpoint</h2><p><strong>åˆ›å»ºå®¹å™¨æ£€æŸ¥ç‚¹</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L897">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CheckpointTaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span>      </span><br><span class="line">Path                 <span class="type">string</span>      </span><br><span class="line">Options              *types1.Any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æˆªè‡³ Kata 3.0ï¼Œå°šæœªå®ç°è¯¥æ¥å£</p></li></ol><h2 id="Kill"><a href="#Kill" class="headerlink" title="Kill"></a>Kill</h2><p><strong>æ ¹æ®æŒ‡å®šä¿¡å·æ€æ­»è¿›ç¨‹</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L764">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> KillRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span>   </span><br><span class="line">ExecID               <span class="type">string</span>  </span><br><span class="line">Signal               <span class="type">uint32</span>  </span><br><span class="line">All                  <span class="type">bool</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>ä»¥å®¹å™¨çŠ¶æ€ä¸ ID ä½œä¸ºå¾…æ€æ­»è¿›ç¨‹çš„ä¿¡æ¯ï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™ä»¥é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec å±æ€§ä¸ºå‡†</p></li><li><p>å¦‚æœä¿¡å·ä¸º SIGKILL æˆ–è€… SIGTERMï¼Œå¹¶ä¸”è¿›ç¨‹çŠ¶æ€å·²ç»ä¸º stoppedï¼Œåˆ™ä¸åšå¤„ç†ï¼Œç›´æ¥è¿”å›å³å¯ï¼ˆæ ¹æ® CRI è§„èŒƒï¼ŒKubelet åœ¨è°ƒç”¨ RemovePodSandbox ä¹‹å‰è‡³å°‘ä¼šè°ƒç”¨ä¸€æ¬¡ StopPodSandbox ï¼Œæ­¤è°ƒç”¨æ˜¯å¹‚ç­‰çš„ï¼Œå¹¶ä¸”å¦‚æœæ‰€æœ‰ç›¸å…³èµ„æºéƒ½å·²è¢«å›æ”¶åˆ™ä¸å¾—è¿”å›é”™è¯¯ã€‚ åœ¨è°ƒç”¨ä¸­å®ƒä¼šå…ˆå‘é€ä¸€ä¸ª SIGKILL ä¿¡å·æ¥å°è¯•åœæ­¢å®¹å™¨ï¼Œå› æ­¤ä¸€æ—¦å®¹å™¨ç»ˆæ­¢ï¼Œåº”è¯¥å¿½ç•¥è¿™ä¸ªä¿¡å·å¹¶ç›´æ¥è¿”å›ï¼‰ï¼›å¦åˆ™ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>SignalProcess</strong>ï¼Œæ€æ­»è¿›ç¨‹</p></li></ol><h2 id="Exec"><a href="#Exec" class="headerlink" title="Exec"></a>Exec</h2><p><strong>åœ¨å®¹å™¨ä¸­è¿½åŠ ä¸€ä¸ªé¢å¤–çš„è¿›ç¨‹</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L547">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ExecProcessRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span>  </span><br><span class="line">ExecID               <span class="type">string</span> </span><br><span class="line">Terminal             <span class="type">bool</span>        </span><br><span class="line">Stdin                <span class="type">string</span>      </span><br><span class="line">Stdout               <span class="type">string</span>      </span><br><span class="line">Stderr               <span class="type">string</span>   </span><br><span class="line">Spec                 *types1.Any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>æ ¡éªŒ r.ExecID æ˜¯å¦åœ¨ container.execs ä¸å­˜åœ¨</p></li><li><p>åŸºäº r.Stdinã€r.Stdoutã€r.Stderrã€r.Terminal å’Œ r.Spec æ„å»º execï¼Œç»´æŠ¤åœ¨ container.execs ä¸­ï¼Œå¹¶å‘é€ TaskExecAdded äº‹ä»¶è‡³ service.events ä¸­</p></li></ol><h2 id="ResizePty"><a href="#ResizePty" class="headerlink" title="ResizePty"></a>ResizePty</h2><p><strong>è°ƒæ•´è¿›ç¨‹çš„ pty å¤§å°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L587">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ResizePtyRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span> </span><br><span class="line">ExecID               <span class="type">string</span> </span><br><span class="line">Width                <span class="type">uint32</span>  </span><br><span class="line">Height               <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>ä»¥ container.ID ä½œä¸ºå¾…å¤„ç†è¿›ç¨‹çš„ IDï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec.ID ä¸ºå‡†ï¼Œå¹¶æ›´æ–° r.Width å’Œ r.Height è‡³ exec ä¸­</p></li><li><p>è°ƒç”¨ VCSandbox çš„ <strong>WinsizeProcess</strong>ï¼Œè°ƒæ•´å¾…å¤„ç†è¿›ç¨‹çš„ pty å¤§å°</p></li></ol><h2 id="CloseIO"><a href="#CloseIO" class="headerlink" title="CloseIO"></a>CloseIO</h2><p><strong>å…³é—­è¿›ç¨‹çš„ IO æµ</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L854">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CloseIORequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">ExecID               <span class="type">string</span>   </span><br><span class="line">Stdin                <span class="type">bool</span>    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>ä»¥ container.stdinPipe å’Œ container.stdinCloser ä½œä¸ºå¾…å¤„ç†è¿›ç¨‹ IO çš„ä¿¡æ¯ï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™ä»¥é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec ä¿¡æ¯ä¸ºå‡†</p></li><li><p>ç›´è‡³ stdinCloser channel ä¸å†é˜»å¡ï¼Œè°ƒç”¨ stdinPipe çš„ Close æ–¹æ³•å…³é—­ IO æµ</p></li></ol><h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p><strong>æ›´æ–°å®¹å™¨</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L1012">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> UpdateTaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span>            </span><br><span class="line">Resources            *types1.Any      </span><br><span class="line">Annotations          <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ VCSandbox çš„ <strong>UpdateContainer</strong>ï¼Œæ›´æ–°å®¹å™¨çš„èµ„æºè§„æ ¼</p></li></ol><h2 id="Wait"><a href="#Wait" class="headerlink" title="Wait"></a>Wait</h2><p><strong>ç­‰å¾…è¿›ç¨‹é€€å‡º</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L1046">source code</a></p><ol><li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WaitRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">ExecID               <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WaitResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">ExitStatus           <span class="type">uint32</span>   </span><br><span class="line">ExitedAt             time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>ä» container.exitCh ä¸­è·å–é€€å‡ºçŠ¶æ€ç ï¼Œå¹¶é‡æ–°å›å¡«è‡³ container.exitChï¼ˆç”¨å®¹å™¨è¿›ç¨‹çš„é€€å‡ºä»£ç é‡æ–°å¡«å…… exitChï¼Œä»¥é˜²æ­¤è¿›ç¨‹æœ‰å…¶ä»–ç­‰å¾…ï¼‰ï¼Œå¦‚æœ r.ExecID ä¸ä¸ºç©ºï¼Œåˆ™ä»¥é€šè¿‡ r.ExecID è·å–ç»´æŠ¤åœ¨ container.execs ä¸­çš„ exec.exitCh ä¸ºå‡†</p></li></ol><h2 id="Stats"><a href="#Stats" class="headerlink" title="Stats"></a>Stats</h2><p><strong>è·å–å®¹å™¨çš„ç»Ÿè®¡ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L981">source code</a></p><ol><li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StatsRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StatsResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">Stats                *types1.Any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ r.ID è·å–ç»´æŠ¤åœ¨ service.containers ä¸­çš„å®¹å™¨</p></li><li><p>è°ƒç”¨ VCSandbox çš„ <strong>StatsContainer</strong>ï¼Œè·å–å®¹å™¨çš„ Hugetlbã€Pidsã€CPUã€Memoryã€Blkio å’Œ Network ç»Ÿè®¡ä¿¡æ¯</p></li></ol><h2 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h2><p><strong>è¿”å› shim ç›¸å…³ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L913">source code</a></p><ol><li><p>è¯·æ±‚ä½“å’Œè¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ConnectRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ConnectResponse <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// å³ service.pid</span></span><br><span class="line">ShimPid              <span class="type">uint32</span></span><br><span class="line"><span class="comment">// å³ service.hpid</span></span><br><span class="line">TaskPid              <span class="type">uint32</span>   </span><br><span class="line">Version              <span class="type">string</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Shutdown"><a href="#Shutdown" class="headerlink" title="Shutdown"></a>Shutdown</h2><p><strong>å…³é—­ shim server</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L935">source code</a></p><ol><li><p>è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ShutdownRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">ID                   <span class="type">string</span></span><br><span class="line">Now                  <span class="type">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœ service.containers ä¸­ä»æœ‰å…ƒç´ ï¼Œä»£è¡¨ shim server ä»ç„¶ç®¡ç†å®¹å™¨ä¸­ï¼Œå› æ­¤ä»…å…³é—­ tracingï¼Œä¸ä½œå…¶ä»–å¤„ç†ï¼Œç›´æ¥è¿”å›</p></li><li><p>è°ƒç”¨ service.cancel é€€å‡º shim serverï¼ˆcancel ç”± Containerd æœåŠ¡æ³¨å†Œå£°æ˜ï¼‰</p></li><li><p>å‘ service.hpid å‘é€ SIGKILL ä¿¡å·ï¼ˆç”±äºåªæ˜¯åœ¨æ‰§è¡Œ stopSandbox æ—¶å‘ QEMU å‘é€äº†ä¸€ä¸ª shutdown qmp å‘½ä»¤ï¼Œå¹¶æ²¡æœ‰ç­‰åˆ° QEMU è¿›ç¨‹é€€å‡ºï¼Œè¿™é‡Œæœ€å¥½ç¡®ä¿å®ƒåœ¨ shim server ç»ˆæ­¢æ—¶å·²ç»é€€å‡ºã€‚ å› æ­¤ï¼Œè¿™é‡Œè¦å¯¹ hypervisor è¿›è¡Œæœ€åçš„æ¸…ç†ï¼‰</p></li><li><p>è°ƒç”¨ os.Exit(0)ï¼Œé€€å‡ºç¨‹åº</p></li></ol><h2 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h2><p><strong>æ¸…ç†å®¹å™¨ç›¸å…³èµ„æº</strong></p><p><em>Cleanup å¹¶æœªç”¨äºå®ç° shimv2 APIï¼Œè€Œæ˜¯ Service çš„åŠŸèƒ½æ‰©å±•ï¼Œç”¨äºåœ¨æ‰§è¡Œ containerd-shim-kata-v2 delete æ“ä½œæ—¶è§¦å‘å®¹å™¨æ¸…ç†æµç¨‹</em></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/service.go#L323">source code</a></p><ol><li><p>è¿”å›ä½“ç»“æ„å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DeleteResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">Pid                  <span class="type">uint32</span></span><br><span class="line">ExitStatus           <span class="type">uint32</span></span><br><span class="line">ExitedAt             time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®æ—¥å¿—è¾“å‡ºè‡³ stderr ä¸­ï¼ˆå› æ­¤ï¼Œæ—¥å¿—ä¿¡æ¯å¹¶ä¸ä¼šå‡ºç°åœ¨ Kata æœåŠ¡ä¸­ï¼‰</p></li><li><p>è·å–å½“å‰ç›®å½•ä¸‹ï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt; ç›®å½•ï¼Œæµç¨‹éœ€è¦åœ¨æ­¤è·¯å¾„ä¸‹æ‰§è¡Œ ï¼‰çš„ config.json æ–‡ä»¶ï¼Œè§£ææˆ OCI spec æ ¼å¼ï¼Œåˆ¤æ–­å…¶å®¹å™¨ç±»å‹</p></li><li><p>å¦‚æœå®¹å™¨ç±»å‹æ˜¯ pod_containerï¼Œåˆ™é€šè¿‡ spec.Annotation ä¸­è·å–åˆ° sandboxIDï¼›å¦‚æœå®¹å™¨ç±»å‹æ˜¯ pod_sandbox æˆ–è€… single_containerï¼ŒsandboxID å³ä¸º service.id</p></li><li><p>è°ƒç”¨ VC çš„ <strong>CleanupContainer</strong>ï¼Œæ¸…ç†å®¹å™¨</p></li><li><p>ç§»é™¤ rootfs æŒ‚è½½ç‚¹ï¼ˆä¾‹å¦‚ &#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;&lt;containerID&gt;&#x2F;rootfsï¼‰</p></li></ol><h1 id="ShimManagement"><a href="#ShimManagement" class="headerlink" title="ShimManagement"></a>ShimManagement</h1><p>shim server å¯¹å¤–æš´éœ²çš„ HTTP æœåŠ¡ã€‚</p><h2 id="agentURL"><a href="#agentURL" class="headerlink" title="agentURL"></a>agentURL</h2><p><strong>å¤„ç† &#x2F;agent-url è¯·æ±‚ï¼Œè¿”å› agent çš„åœ°å€</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L56">source code</a></p><ol><li>è°ƒç”¨ VCSandbox çš„ <strong>GetAgentURL</strong>ï¼Œè·å– agent åœ°å€å¹¶è¿”å›</li></ol><h2 id="serveMetrics"><a href="#serveMetrics" class="headerlink" title="serveMetrics"></a>serveMetrics</h2><p><strong>å¤„ç† &#x2F;metrics è¯·æ±‚ï¼Œè¿”å› guestã€shim å’Œ agent ç›¸å…³çš„æŒ‡æ ‡</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L68">source code</a></p><ol><li>è°ƒç”¨ VCSandbox çš„ <strong>UpdateRuntimeMetrics</strong>ï¼Œæ›´æ–° guest æŒ‡æ ‡ï¼ˆæ›´æ–°å°±æ˜¯é‡æ–°è·å–æŒ‡æ ‡ï¼Œé‡æ–°è®¾ç½®åœ¨ Prometheus ä¸­ï¼‰</li><li>æ›´æ–°å½“å‰è¿›ç¨‹ï¼ˆå³ shimPIDï¼‰çš„æŒ‡æ ‡<ol><li>è·å– &#x2F;proc&#x2F;&lt;shimPID&gt;&#x2F;fd ç›®å½•ä¸‹çš„æ–‡ä»¶æ•°é‡ï¼Œä¸ŠæŠ¥ kata_shim_fds æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;shimPID&gt;&#x2F;stat æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_shim_proc_stat æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;shimPID&gt;&#x2F;status æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_shim_proc_status æŒ‡æ ‡</li><li>è§£æ &#x2F;proc&#x2F;&lt;shimPID&gt;&#x2F;io æ–‡ä»¶å†…å®¹ï¼Œä¸ŠæŠ¥ kata_shim_io æŒ‡æ ‡</li></ol></li><li>å¦‚æœä½¿ç”¨æ—§ç‰ˆæœ¬çš„ agentï¼ˆç°é˜¶æ®µå‡ä¸ºæ–°ç‰ˆæœ¬ï¼‰ï¼Œåˆ™ä¸æ”¯æŒè·å– agent æŒ‡æ ‡ï¼Œç›´æ¥è¿”å› VM å’Œ shim æŒ‡æ ‡å³å¯</li><li>è°ƒç”¨ VCSandbox çš„ <strong>GetAgentMetrics</strong>ï¼Œè·å– agent æŒ‡æ ‡ï¼ˆåœ¨è¿™é‡Œï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™è§†ä¸ºå½“å‰ä½¿ç”¨æ—§ç‰ˆæœ¬çš„ agentï¼Œåç»­åˆ™ç”±æ­¥éª¤ 3 ç›´æ¥è¿”å›ï¼‰</li><li>å¯åŠ¨ goroutineï¼Œä¸ŠæŠ¥ pod_overhead_cpu å’Œ pod_overhead_memory_in_bytes è‡³ Prometheusï¼ˆæ”¶é›† Pod overhead æŒ‡æ ‡éœ€è¦ sleep æ¥è·å– cpu&#x2F;memory èµ„æºä½¿ç”¨çš„å˜åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œåªè§¦å‘ collect æ“ä½œï¼Œä¸‹æ¬¡ä» Prometheus server æ”¶é›†è¯·æ±‚æ—¶æ”¶é›†æ•°æ®ï¼‰<ol><li>è°ƒç”¨ VCSandbox çš„ <strong>Stats</strong>ï¼Œè·å– sandbox çš„ cgroup ç›¸å…³ä¿¡æ¯ï¼›è°ƒç”¨ VCSandbox çš„ <strong>GetAllContainers</strong>ï¼Œè·å–æ‰€æœ‰å®¹å™¨ï¼Œå¹¶é€ä¸€è°ƒç”¨ VCSandbox çš„ <strong>StatsContainer</strong>ï¼Œè·å–å®¹å™¨çš„ cgroup ç›¸å…³ä¿¡æ¯</li><li>é—´éš” 1 ç§’é’Ÿï¼Œé‡å¤æ­¥éª¤ 1ï¼Œå†æ¬¡è·å– sandbox å’Œå®¹å™¨çš„ cgroup ç›¸å…³ä¿¡æ¯</li><li>æ ¹æ®ä¸¤æ¬¡æ•°æ®ä¿¡æ¯ä»¥åŠæ€»è€—æ—¶ï¼Œè®¡ç®— overhead æŒ‡æ ‡</li></ol></li></ol><h2 id="serveVolumeStats"><a href="#serveVolumeStats" class="headerlink" title="serveVolumeStats"></a>serveVolumeStats</h2><p><strong>å¤„ç† &#x2F;direct-volume&#x2F;stats è¯·æ±‚ï¼Œè¿”å› guest ä¸­æŒ‡å®šå·çš„ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L147">source code</a></p><ol><li>æ ¡éªŒè¯·æ±‚ä¸­ path å‚æ•°æ˜¯å¦ä¸ä¸ºç©º</li><li>è°ƒç”¨ VCSandbox çš„ <strong>GuestVolumeStats</strong>ï¼Œè·å– guest ä¸­æŒ‡å®šå·çš„ä¿¡æ¯å¹¶è¿”å›</li></ol><h2 id="serveVolumeResize"><a href="#serveVolumeResize" class="headerlink" title="serveVolumeResize"></a>serveVolumeResize</h2><p><strong>å¤„ç† &#x2F;direct-volume&#x2F;resize è¯·æ±‚ï¼Œæ‰©å®¹ guest ä¸­æŒ‡å®šå·çš„å¤§å°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L175">source code</a></p><ol><li>è¯»å–è¯·æ±‚ä½“ï¼Œå¹¶è§£æ„æˆ VCSandbox æ‰€éœ€çš„æ ¼å¼</li><li>è°ƒç”¨ VCSandbox çš„ <strong>ResizeGuestVolume</strong>ï¼Œæ‰©å®¹ guest ä¸­æŒ‡å®šå·çš„å¤§å°</li></ol><h2 id="ipTablesHandlerã€ip6TablesHandler"><a href="#ipTablesHandlerã€ip6TablesHandler" class="headerlink" title="ipTablesHandlerã€ip6TablesHandler"></a>ipTablesHandlerã€ip6TablesHandler</h2><p><strong>å¤„ç† &#x2F;iptables å’Œ &#x2F;ip6tablesè¯·æ±‚ï¼Œæ“ä½œ guest ä¸­çš„ iptables ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L206">source code (ipTablesHandler)</a><br><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/shim_management.go#L202">source code (ip6TablesHandler)</a></p><ol><li>ä¸¤è€…æœ¬è´¨ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äº ip6TablesHandler çš„ isIPv6 å‚æ•°ä¸º trueï¼Œåç»­è°ƒç”¨æ¥å£æ—¶ï¼Œä¼šä¼ é€’è¯¥å‚æ•°</li><li>åˆ¤æ–­è¯·æ±‚æ–¹æ³•ï¼Œç›®å‰ä»…æ”¯æŒ PUT å’Œ GET ä¸¤ç§ï¼Œå…¶ä½™è¿”å›çŠ¶æ€ç  501ã€‚å¦‚æœä¸º PUT è¯·æ±‚ï¼Œåˆ™è¯»å–è¯·æ±‚ä½“ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>SetIPTables</strong>ï¼Œè®¾ç½® guest ä¸­çš„ iptables ä¿¡æ¯ï¼›å¦‚æœä¸º GET è¯·æ±‚ï¼Œè°ƒç”¨ VCSandbox çš„ <strong>GetIPTables</strong>ï¼Œè·å– guest ä¸­çš„ iptables ä¿¡æ¯</li></ol><h1 id="EventForwarder"><a href="#EventForwarder" class="headerlink" title="EventForwarder"></a>EventForwarder</h1><p><em><u>src&#x2F;runtime&#x2F;pkg&#x2F;containerd-shim-v2&#x2F;event_forwarder.go</u></em></p><p>EventForwarder ä¸ºäº‹ä»¶ä¸ŠæŠ¥æ¨¡å—ï¼Œå…¶ä¸­äº‹ä»¶æºè‡ªäº forwarder ä¸­çš„ service.eventsã€‚forwarder åŒ…æ‹¬ä¸¤ç±»ï¼šlog ä¸ containerdï¼Œå–å†³äºäº‹ä»¶æœ€ç»ˆä¸ŠæŠ¥çš„åœ°ç‚¹ã€‚æ¯ä¸€ä¸ªäº‹ä»¶é»˜è®¤ä¸ŠæŠ¥è¶…æ—¶æ—¶é—´ä¸º 5 ç§’é’Ÿï¼Œè¶…å‡ºä¼šè¢«å–æ¶ˆä¸ŠæŠ¥ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> logForwarder <span class="keyword">struct</span> &#123;</span><br><span class="line">s *service</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> containerdForwarder <span class="keyword">struct</span> &#123;</span><br><span class="line">s         *service</span><br><span class="line">ctx       context.Context</span><br><span class="line">publisher events.Publisher</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œpublisher ç”± Containerd è°ƒç”¨æ—¶æä¾›ã€‚</p><p><strong>å·¥å‚å‡½æ•°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L71">source code</a></p><ol><li>å¦‚æœç¯å¢ƒå˜é‡ä¸­å£°æ˜äº† TTRPC_ADDRESSï¼Œåˆ™åˆå§‹åŒ– containerdForwarderï¼Œå¦åˆ™åˆå§‹åŒ– logForwarder</li></ol><h2 id="forward"><a href="#forward" class="headerlink" title="forward"></a>forward</h2><p><strong>å¤„ç†äº‹ä»¶ä¸ŠæŠ¥</strong></p><h3 id="logForwarder"><a href="#logForwarder" class="headerlink" title="logForwarder"></a>logForwarder</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L40">source code</a></p><ol><li>ç›‘å¬ service.events ä¸­çš„äº‹ä»¶ï¼Œæ–­è¨€å…¶çš„ç±»å‹ï¼Œè·å¾—äº‹ä»¶çš„ topic</li><li>åœ¨ containerd-kata-shim-v2 æ¨¡å—çš„æ—¥å¿—ä¸­è¾“å‡ºäº‹ä»¶å†…å®¹</li></ol><h3 id="containerdForwarder"><a href="#containerdForwarder" class="headerlink" title="containerdForwarder"></a>containerdForwarder</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L56">source code</a></p><ol><li>ç›‘å¬ service.events ä¸­çš„äº‹ä»¶ï¼Œæ–­è¨€å…¶çš„ç±»å‹ï¼Œè·å¾—äº‹ä»¶çš„ topic</li><li>è°ƒç”¨ Containerd çš„ publisher æ¨¡å—çš„ Publishï¼ˆContainerd è´Ÿè´£å®ç°ï¼‰ï¼Œä¸ŠæŠ¥äº‹ä»¶è‡³ Containerd</li></ol><h2 id="forwarderType"><a href="#forwarderType" class="headerlink" title="forwarderType"></a>forwarderType</h2><p><strong>forwarder çš„å…·ä½“ç±»å‹</strong></p><h3 id="logForwarder-1"><a href="#logForwarder-1" class="headerlink" title="logForwarder"></a>logForwarder</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L46">source code</a></p><ol><li>ç±»å‹ä¸º log</li></ol><h3 id="containerdForwarder-1"><a href="#containerdForwarder-1" class="headerlink" title="containerdForwarder"></a>containerdForwarder</h3><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/pkg/containerd-shim-v2/event_forwarder.go#L67">source code</a></p><ol><li>ç±»å‹ä¸º containerd</li></ol>]]></content>
    
    
    <summary type="html">Containerd Shimv2 API çš„å®ç°ä¸ ShimManagementã€EventForwarder ç­‰ç®¡ç†ç›¸å…³æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç èµ°è¯» â€” kata-runtime</title>
    <link href="http://shenxianghong.github.io/2022/11/26/2022-11-26%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20kata-runtime/"/>
    <id>http://shenxianghong.github.io/2022/11/26/2022-11-26%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20kata-runtime/</id>
    <published>2022-11-25T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.268Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><p>kata-runtime æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œç”¨äºè¿è¡ŒåŸºäº OCIï¼ˆOpen Container Initiativeï¼‰æ„å»ºæ‰“åŒ…çš„åº”ç”¨ã€‚</p><p><em><u>src&#x2F;runtime&#x2F;cmd&#x2F;kata-runtime&#x2F;main.go</u></em></p><p>kata-runtime æœ¬èº«æ˜¯åŸºäº <a href="https://github.com/urfave/cli">urfave&#x2F;cli</a> åº“æ„å»ºã€‚kata-runtime åŒ…æ‹¬ 7 ä¸ªå­å‘½ä»¤ï¼šcheckï¼ˆkata-checkï¼‰ã€envï¼ˆkata-envï¼‰ã€execã€metricsã€factoryã€direct-volume å’Œ iptablesã€‚</p><p><strong>beforeSubcommands</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/main.go#L221">source code</a></p><ol><li>å¦‚æœæŒ‡å®šäº† â€“show-default-config-paths å‚æ•°ï¼Œåˆ™å±•ç¤ºé…ç½®æ–‡ä»¶é»˜è®¤çš„è·¯å¾„ï¼ˆ&#x2F;etc&#x2F;kata-containers&#x2F;configuration.toml å’Œ &#x2F;opt&#x2F;kata&#x2F;share&#x2F;defaults&#x2F;kata-containers&#x2F;configuration.tomlï¼‰</li><li>åˆ¤æ–­ç”¨æˆ·çš„è¾“å…¥æ˜¯å¦éœ€è¦å±•ç¤ºç”¨æ³•ï¼ˆä¾‹å¦‚ kata-runtimeã€kata-runtime helpã€kata-runtime â€“help å’Œ kata-runtime -h ç­‰ï¼‰ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™ç›´æ¥å±•ç¤ºç”¨æ³•æ–‡æœ¬ï¼Œä¸æ‰§è¡Œåç»­æµç¨‹</li><li>è§£æ â€“rootless å‚æ•°å¹¶è®¾ç½®</li><li>å¦‚æœå­å‘½ä»¤ä¸º checkï¼ˆkata-checkï¼‰ï¼Œåˆ™è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º warnï¼›å¦åˆ™ï¼Œæ ¹æ® â€“log å‚æ•°åˆ›å»ºæ—¥å¿—æ–‡ä»¶ï¼ˆé»˜è®¤ä¸º &#x2F;dev&#x2F;nullï¼‰ï¼Œæ ¹æ® â€“log-format è®¾ç½®æ—¥å¿—æ ¼å¼ï¼ˆæ”¯æŒ text å’Œ jsonï¼Œé»˜è®¤ä¸º textï¼‰ï¼Œæ—¥å¿—ä¸­æ–°å¢ command å­—æ®µæ ‡è¯†å­å‘½ä»¤ï¼Œæå– context è®¾ç½®ç»™ logger</li><li>å°†é…ç½®æ–‡ä»¶å†…å®¹è§£æå¹¶è½¬ä¸º OCI runtime é…ç½®ï¼Œè®¾ç½®åœ¨ context ä¸­ï¼Œåç»­çš„æ“ä½œä¸­ä¸å†è§£æé…ç½®æ–‡ä»¶</li></ol><h1 id="checkï¼ˆkata-checkï¼‰"><a href="#checkï¼ˆkata-checkï¼‰" class="headerlink" title="checkï¼ˆkata-checkï¼‰"></a>checkï¼ˆkata-checkï¼‰</h1><p><strong>Kata Containers çš„è¿è¡Œç¯å¢ƒè¦æ±‚æ£€æŸ¥</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-check.go#L313">source code</a></p><ol><li><p>å¦‚æœæŒ‡å®šäº† â€“verbose å‚æ•°ï¼Œåˆ™è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º Info</p></li><li><p>å¦‚æœæ²¡æœ‰æŒ‡å®š â€“no-network-checks å‚æ•°å¹¶ä¸”æ²¡æœ‰å£°æ˜ KATA_CHECK_NO_NETWORK ç¯å¢ƒå˜é‡ï¼Œåˆ™å€ŸåŠ©ç½‘ç»œå°è¯•è¿›è¡Œ release ç‰ˆæœ¬æ£€æŸ¥ï¼šå¦‚æœå½“å‰ç”¨æˆ·ä¸º root åˆ™è¾“å‡º Not running network checks as super userï¼Œå¦åˆ™æ‰§è¡Œ release version æ£€æŸ¥</p><ol><li>æ ¡éªŒå½“å‰ç‰ˆæœ¬å·æ˜¯å¦ç¬¦åˆ SemVer ç‰ˆæœ¬è§„èŒƒ</li><li>æ ¹æ®ç‰ˆæœ¬è§£æä¸­çš„ä¸»ç‰ˆæœ¬å·è·å– release URLï¼šå¦‚æœä¸º 0ï¼Œåˆ™ä¸åˆæ³•ï¼›å¦‚æœä¸º 1 åˆ™è·å– 1.x çš„ <a href="https://api.github.com/repos/kata-containers/runtime/releases">release URL</a>ï¼›å¦‚æœä¸º 2 åˆ™è·å– 2.x çš„ <a href="https://api.github.com/repos/kata-containers/kata-containers/releases">release URL</a>ï¼›å¦‚æœç¯å¢ƒå˜é‡ä¸­å£°æ˜äº† KATA_RELEASE_URL åˆ™ä»¥æ­¤ä¸ºå‡†</li><li>æ£€éªŒ release URL çš„åˆæ³•æ€§ï¼Œé™¤äº†é»˜è®¤çš„ 1.x å’Œ 2.x ç‰ˆæœ¬ä¹‹å¤–ï¼Œå…¶ä½™çš„å‡ä¸ºä¸åˆæ³•ï¼Œå› æ­¤é€šè¿‡ç¯å¢ƒå˜é‡ KATA_RELEASE_URL å£°æ˜çš„ release URL ä¹Ÿå¿…é¡»ä¸ºå®˜æ–¹é»˜è®¤çš„</li><li>å¦‚æœå½“å‰ç”¨æˆ·ä¸º root åˆ™è¿”å› No network checks allowed running as super user é”™è¯¯ï¼Œå¦åˆ™è¯·æ±‚ release URLï¼Œæ ¹æ®æ˜¯å¦æŒ‡å®šäº† â€“include-all-releases å‚æ•°ï¼Œè§£æç¬¦åˆè¦æ±‚çš„ release è¯¦æƒ…ä¿¡æ¯</li><li>å¦‚æœæŒ‡å®šäº† â€“only-list-releases å‚æ•°ï¼Œåˆ™å±•ç¤ºæ‰€æœ‰çš„ release è¯¦æƒ…ï¼Œä¸æ‰§è¡Œåç»­æµç¨‹</li><li>è·å–æœ€æ–°çš„ releaseï¼Œå¹¶å±•ç¤ºå…¶è¯¦æƒ…ä¿¡æ¯</li></ol></li><li><p>å¦‚æœæŒ‡å®šäº† â€“check-version-only å‚æ•°æˆ–è€… â€“only-list-releases å‚æ•°åˆ™ä¸æ‰§è¡Œåç»­æµç¨‹</p></li><li><p>è§£æè·å¾— OCI runtime é…ç½®ä¿¡æ¯ï¼Œæ ¹æ®ä½¿ç”¨çš„ hypervisor çš„ç±»åˆ«ï¼Œè®¾ç½® CPU ç±»åˆ«ï¼Œè·å–è¿è¡Œæ‰€éœ€çš„ CPU flags å’Œå†…æ ¸æ¨¡å—</p><p><em><strong>amd64</strong></em></p><ol><li>æ ¹æ® &#x2F;proc&#x2F;cpuinfo æ–‡ä»¶ä¸­å­—ç¬¦ä¸²åŒ¹é… GenuineIntel æˆ– AuthenticAMD è·å¾—å…¶ CPU ç±»å‹ï¼Œx86 æ¶æ„ä¸‹æ”¯æŒ  Intel å’Œ AMD ç±»å‹</li><li>å½“ CPU ç±»å‹ä¸º Intel æ—¶ï¼š<ol><li>æ ¹æ® CPU flags ä¸­æ˜¯å¦å«æœ‰ â€œhypervisorâ€ åˆ¤æ–­æ˜¯å¦è¿è¡Œåœ¨ VM ç¯å¢ƒä¸­ï¼Œå¦‚æœæ²¡è¿è¡Œåœ¨ VM ä¸­ï¼Œåˆ™éœ€è¦æ”¯æŒ <a href="https://communities.vmware.com/t5/VMware-Workstation-Pro/What-is-VMX-Unrestricted-Guest/td-p/2748822">VMX Unrestricted</a> æ¨¡å¼ï¼ˆç”¨äºåˆ¤æ–­ç³»ç»Ÿç¯å¢ƒæ˜¯å¦è¶³å¤Ÿæ–°ï¼Œç”¨ä»¥æ»¡è¶³è¿è¡Œ Kata Containersï¼Œè‡³å°‘æ˜¯ <a href="https://en.wikipedia.org/wiki/Westmere_(microarchitecture)">Westmere</a>ï¼‰</li><li>å¦‚æœ hypervisor ä¸º QEMUã€Cloud hypervisorã€Firecracker å’Œ Dragonball æ—¶ï¼Œåˆ™è¦æ±‚ CPU å…·æœ‰ vmxã€lm å’Œ sse4_1 çš„ flag ç‰¹æ€§ä»¥åŠå†…æ ¸æ¨¡å—ä¸­ kvmã€kvm_intelã€vhostã€vhost_net å’Œ vhost_vsock åº”å¯åŠ¨ï¼›å¦‚æœ hypervisor ä¸º acrn æ—¶ï¼Œåˆ™è¦æ±‚ CPU å…·æœ‰ lm å’Œ sse4_1 çš„ flag ç‰¹æ€§ä»¥åŠå†…æ ¸æ¨¡å—ä¸­ vhm_devã€vhost å’Œ vhost_net åº”å¯åŠ¨ï¼›å¦‚æœ hypervisor ä¸º mock æ—¶ï¼Œåˆ™è¦æ±‚ CPU å…·æœ‰ vmxã€lm å’Œ sse4_1 çš„ flag ç‰¹æ€§</li></ol></li><li>å½“ CPU ç±»å‹ä¸º AMD æ—¶ï¼š<ol><li>æ— è®º hypervisor çš„ç±»å‹ï¼Œè¦æ±‚ CPU å…·æœ‰ svmã€lmã€sse4_1 çš„ flag ç‰¹æ€§ä»¥åŠå†…æ ¸æ¨¡å—ä¸­ kvmã€kvm_amdã€vhostã€vhost_net å’Œ vhost_vsock åº”å¯åŠ¨</li><li>è®°å½•ä»¥ä¸Šä¾èµ–è¦æ±‚è‡³å…¨å±€å˜é‡ä¸­ï¼Œåç»­ä¼šä½œä¸ºè¿è¡Œç¯å¢ƒç›‘æµ‹çš„ä¾æ®</li></ol></li></ol><p><em><strong>arm64</strong></em></p><ol><li>arm64 æ¶æ„ä¸‹ï¼ŒsetCPUtype ä¸åšä»»ä½•å¤„ç†ï¼Œè€Œæ˜¯é‡‡å–äº†ç›¸å…³å…¨å±€å˜é‡ç¡¬ç¼–ç æ–¹å¼</li><li>è¦æ±‚å†…æ ¸æ¨¡å—ä¸­ kvmã€vhostã€vhost_net å’Œ vhost_vsock åº”å¯åŠ¨ï¼ŒCPU flag ç‰¹æ€§æ— ç‰¹æ®Šè¦æ±‚</li></ol></li><li><p>åˆ¤æ–­å½“å‰ç¯å¢ƒæ˜¯å¦æ»¡è¶³è¿è¡Œ Kata Containers è¦æ±‚ï¼Œæ»¡è¶³è¦æ±‚æ—¶è¾“å‡º System is capable of running Kata Containers</p></li><li><p>å¦‚æœå½“å‰ç”¨æˆ·ä¸º rootï¼Œåˆ™é€šè¿‡ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæœ€å°åŒ–çš„ VM ä¹‹åå¹¶åˆ é™¤ï¼Œç”¨ä»¥æ£€æµ‹å½“å‰ç¯å¢ƒæ˜¯å¦èƒ½å¤Ÿæ»¡è¶³åˆ›å»º VM çš„è¦æ±‚</p><p><em><strong>amd64</strong></em></p><ol><li>å½“ hypervisor ä¸º QEMUã€Cloud Hypervisorã€Firecracker æ—¶ï¼ŒéªŒè¯æµç¨‹å‚è€ƒï¼š<a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-check_amd64.go#L234">kvmIsUsable</a>ï¼›hypervisor ä¸º ACRN æ—¶ï¼ŒéªŒè¯æµç¨‹å‚è€ƒï¼š<a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-check_amd64.go#L240">acrnIsUsable</a>ã€‚æ»¡è¶³è¦æ±‚æ—¶è¾“å‡º System can currently create Kata Containers</li></ol><p><em><strong>arm64</strong></em></p><ol><li>ä¸åŒºåˆ† hypervisor ç±»å‹ï¼ŒéªŒè¯æµç¨‹å‚è€ƒï¼š<a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-check_arm64.go#L66">kvmIsUsable</a></li><li>éªŒè¯æ˜¯å¦æ”¯æŒ KVM Extensionï¼ŒéªŒè¯æµç¨‹å‚è€ƒï¼š<a href="#https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-check_arm64.go#L70">checkKVMExtensions</a></li></ol></li></ol><h1 id="envï¼ˆkata-envï¼‰"><a href="#envï¼ˆkata-envï¼‰" class="headerlink" title="envï¼ˆkata-envï¼‰"></a>envï¼ˆkata-envï¼‰</h1><p><strong>å±•ç¤º Kata Containers çš„è®¾ç½®ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-env.go#L427">source code</a></p><ol><li>è°ƒç”¨ä¸Šè¿°çš„ <strong>setCPUtype</strong>ï¼Œæ ¹æ® hypervisor çš„ç±»åˆ«ï¼Œè·å–è¿è¡Œæ‰€éœ€çš„ CPU flags å’Œå†…æ ¸æ¨¡å—</li><li>ç”Ÿæˆ meta é…ç½®é¡¹å†…å®¹ï¼Œå…¶ä¸­ version å›ºå®šä¸º 1.0.26</li><li>é€šè¿‡é…ç½®æ–‡ä»¶å’Œ OCI Runtime çš„ä¿¡æ¯ï¼Œç”Ÿæˆ runtimeã€agentã€ hypervisorã€imageã€initrdã€kernel  é…ç½®é¡¹å†…å®¹</li><li>é€šè¿‡è§£æ &#x2F;proc&#x2F;version è·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ï¼›é€šè¿‡è§£æ &#x2F;etc&#x2F;os-release æˆ–è€… &#x2F;usr&#x2F;lib&#x2F;os-release è·å–å‘è¡Œç‰ˆåç§°å’Œç‰ˆæœ¬ä¿¡æ¯ï¼›é€šè¿‡è§£æ &#x2F;proc&#x2F;cpuinfo è·å¾— CPU ç±»åˆ«å’Œå‹å·ï¼›é€šè¿‡ &#x2F;dev&#x2F;vhost-vsock çš„å­˜åœ¨æ€§ï¼Œåˆ¤æ–­æ˜¯å¦æ”¯æŒ vhost-sockã€‚æ­¤å¤–ï¼Œæ±‡åˆå†…å­˜æ€»é‡ä¸ä½¿ç”¨é‡ã€CPU æ˜¯å¦æ»¡è¶³è¿è¡Œè¦æ±‚ç­‰ï¼Œç”Ÿæˆ host é…ç½®é¡¹å†…å®¹</li><li>æ±‡æ€»ä»¥ä¸Šé…ç½®é¡¹å†…å®¹ï¼Œæ ¹æ®æ˜¯å¦æŒ‡å®š â€“json å‚æ•°ï¼ˆé»˜è®¤ä¸º TOML æ ¼å¼ï¼‰ï¼Œæ ¼å¼åŒ–å±•ç¤ºå†…å®¹</li></ol><h1 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h1><p><strong>å€ŸåŠ© debug console è¿›å…¥åˆ° VM ä¸­</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-exec.go#L51">source code</a></p><ol><li><p>å¦‚æœæ²¡æœ‰æŒ‡å®š â€“kata-debug-port å‚æ•°æˆ–è€…æŒ‡å®šä¸º 0ï¼Œåˆ™ debug ç«¯å£è®¾ç½®ä¸ºé»˜è®¤çš„ 1026</p></li><li><p>æ ¡éªŒæŒ‡å®šçš„ sandboxID å‚æ•°æ˜¯å¦ä¸ä¸ºç©ºï¼Œä¸”æ­£åˆ™åŒ¹é…æ»¡è¶³ ^[a-zA-Z0-9][a-zA-Z0-9_.-]+$</p></li><li><p>é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock å‘é€ HTTP GET è¯·æ±‚è‡³ shim server çš„ <code>http://shim/agent-url</code>ï¼Œè§£æå†…å®¹è·å¾— sandbox çš„ console socketï¼Œç¤ºä¾‹å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl --unix-socket /run/vc/sbs/dd2aa45873a9c0f5e1e93fc38cc0e1fe561e79e33aa85be49487162c1ebc7f43/shim-monitor.sock http://shim/agent-url</span></span><br><span class="line">vsock://4138340623:1024</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœ sandbox çš„ console socket åè®®ä¸º vsockï¼Œåˆ™æ„å»ºæˆç±»ä¼¼ vsock:&#x2F;&#x2F;4138340623:1026 çš„æ ¼å¼ï¼›å¦‚æœåè®®ä¸º hvsockï¼Œåˆ™æ„å»ºæˆ hvsock:&#x2F;&#x2F;&#x2F;run&#x2F;vc&#x2F;firecracker&#x2F;340b412c97bf1375cdda56bfa8f18c8a&#x2F;root&#x2F;kata.hvsock:1026 çš„æ ¼å¼ã€‚ä»…æ”¯æŒæ­¤ä¸¤ç§åè®®ï¼Œå»ºç«‹ grpc è¯·æ±‚é“¾æ¥ï¼Œç”¨äº VM å†…å¤–çš„é€šä¿¡äº¤äº’</p></li><li><p>è·å–å½“å‰è¿›ç¨‹çš„ consoleï¼Œå°† kata-runtime exec &lt;sandboxID&gt; çš„è¾“å‡ºæµå±•ç¤ºåˆ°å½“å‰ console ä¸­</p></li></ol><h1 id="metrics"><a href="#metrics" class="headerlink" title="metrics"></a>metrics</h1><p><strong>è·å– VM ä¸­æš´éœ²çš„æŒ‡æ ‡ä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-metrics.go#L16">source code</a></p><ol><li>æ ¡éªŒæŒ‡å®šçš„ sandboxID å‚æ•°æ˜¯å¦ä¸ä¸ºç©ºï¼Œä¸”æ­£åˆ™åŒ¹é…æ»¡è¶³ ^[a-zA-Z0-9][a-zA-Z0-9_.-]+$</li><li>é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock å‘é€ HTTP GET è¯·æ±‚è‡³ shim server çš„ <code>http://shim/metrics</code>ï¼Œå±•ç¤ºè¯·æ±‚è¿”å›å†…å®¹</li></ol><h1 id="factory"><a href="#factory" class="headerlink" title="factory"></a>factory</h1><h2 id="init"><a href="#init" class="headerlink" title="init"></a>init</h2><p><strong>åˆå§‹åŒ– VM factory</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/factory.go#L148">source code</a></p><ol><li>å¦‚æœå¯ç”¨ VM cache ç‰¹æ€§ï¼ˆå³ [factory].vm_cache_number å¤§äº 0ï¼‰ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ factoryï¼ˆå³ fetchOnly ä¸º falseï¼‰ã€‚å¯åŠ¨ cache serverï¼Œç›‘å¬ [factory].vm_cache_endpointï¼ˆé»˜è®¤ä¸º &#x2F;var&#x2F;run&#x2F;kata-containers&#x2F;cache.sockï¼‰</li><li>å¦‚æœå¯ç”¨ VM template ç‰¹æ€§ï¼ˆå³ [factory].enable_template ä¸º trueï¼‰ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ factoryï¼ˆå³ fetchOnly ä¸º falseï¼‰ï¼›å¦åˆ™è§†ä¸º VM cache å’Œ VM template å‡æœªå¼€å¯å‰æä¸‹è°ƒç”¨ kata-runtime factory initï¼ŒæŠ›å‡ºç›¸å…³æŠ¥é”™</li></ol><h2 id="destory"><a href="#destory" class="headerlink" title="destory"></a>destory</h2><p><strong>é”€æ¯ VM factory</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/factory.go#L224">source code</a></p><ol><li>å¦‚æœå¯ç”¨ VM cache ç‰¹æ€§ï¼ˆå³ [factory].vm_cache_number å¤§äº 0ï¼‰ï¼Œåˆ™é€šè¿‡ [factory].vm_cache_endpointï¼ˆé»˜è®¤ä¸º &#x2F;var&#x2F;run&#x2F;kata-containers&#x2F;cache.sockï¼‰gRPC è°ƒç”¨ cache server çš„ <strong>Quit</strong>ï¼Œè¯·æ±‚å…³é—­ cache server</li><li>å¦‚æœå¯ç”¨ VM template ç‰¹æ€§ï¼ˆå³ [factory].enable_template ä¸º trueï¼‰ï¼Œåˆ™è·å–ç°æœ‰çš„ factory ï¼ˆå³ fetchOnly ä¸º trueï¼‰ï¼Œè°ƒç”¨ factory çš„ <u>CloseFactory</u>ï¼Œå…³é—­ factory</li></ol><h2 id="status"><a href="#status" class="headerlink" title="status"></a>status</h2><p><strong>æŸ¥è¯¢ VM factory çš„çŠ¶æ€</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/factory.go#L274">source code</a></p><ol><li>å¦‚æœå¯ç”¨ VM cache ç‰¹æ€§ï¼ˆå³ [factory].vm_cache_number å¤§äº 0ï¼‰ï¼Œåˆ™é€šè¿‡ [factory].vm_cache_endpointï¼ˆé»˜è®¤ä¸º &#x2F;var&#x2F;run&#x2F;kata-containers&#x2F;cache.sockï¼‰gRPC è°ƒç”¨ cache server çš„ <strong>Status</strong>ï¼Œå±•ç¤ºè¯·æ±‚è¿”å›å†…å®¹</li><li>å¦‚æœå¯ç”¨ VM template ç‰¹æ€§ï¼ˆå³ [factory].enable_template ä¸º trueï¼‰ï¼Œåˆ™è·å–ç°æœ‰çš„ factory ï¼ˆå³ fetchOnly ä¸º trueï¼‰ï¼Œè¾“å‡ºå…¶æ˜¯å¦å­˜åœ¨</li></ol><h1 id="direct-volume"><a href="#direct-volume" class="headerlink" title="direct-volume"></a>direct-volume</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MountInfo contains the information needed by Kata to consume a host block device and mount it as a filesystem inside the guest VM.</span></span><br><span class="line"><span class="keyword">type</span> MountInfo <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// The type of the volume (ie. block)</span></span><br><span class="line">VolumeType <span class="type">string</span> <span class="string">`json:&quot;volume-type&quot;`</span></span><br><span class="line"><span class="comment">// The device backing the volume.</span></span><br><span class="line">Device <span class="type">string</span> <span class="string">`json:&quot;device&quot;`</span></span><br><span class="line"><span class="comment">// The filesystem type to be mounted on the volume.</span></span><br><span class="line">FsType <span class="type">string</span> <span class="string">`json:&quot;fstype&quot;`</span></span><br><span class="line"><span class="comment">// Additional metadata to pass to the agent regarding this volume.</span></span><br><span class="line">Metadata <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;metadata,omitempty&quot;`</span></span><br><span class="line"><span class="comment">// Additional mount options.</span></span><br><span class="line">Options []<span class="type">string</span> <span class="string">`json:&quot;options,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´é€šå·çš„æ“ä½œéƒ½æ˜¯åŸºäº MountInfo ç»“æ„ï¼Œå®ƒæè¿°äº†å¾…ç›´é€šè‡³ VM ä¸­çš„å·ä½äº host ä¾§çš„ä¿¡æ¯è¯¦æƒ…ã€‚</p><h2 id="add"><a href="#add" class="headerlink" title="add"></a>add</h2><p><strong>ä¸ºæŒ‡å®šçš„ VM æ–°å¢ç›´é€šå·</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-volume.go#L42">source code</a></p><ol><li>å¯¹æŒ‡å®šçš„ â€“volume-path å‚æ•°è¿›è¡Œ URLEncoding åï¼Œæ‹¼æ¥æˆ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;volumePath (base64)&gt; è·¯å¾„ç›®å½•</li><li>å¦‚æœè¯¥è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºç›®å½•å±‚çº§ï¼›å¦‚æœè¯¥è·¯å¾„å­˜åœ¨ï¼Œåˆ™åˆ¤æ–­å…¶æ˜¯å¦ä¸ºç›®å½•</li><li>å°† â€“mount-info å‚æ•°å†…å®¹æŒä¹…åŒ–åˆ°è¯¥ç›®å½•ä¸‹çš„ mountInfo.json æ–‡ä»¶ä¸­</li></ol><h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><p><strong>åˆ é™¤æŒ‡å®š VM çš„ç›´é€šå·</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-volume.go#L65">source code</a></p><ol><li>å¯¹æŒ‡å®šçš„ â€“volume-path å‚æ•°è¿›è¡Œ URLEncoding åï¼Œæ‹¼æ¥æˆ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;volumePath (base64)&gt; è·¯å¾„ç›®å½•</li><li>ç§»é™¤è¯¥ç›®å½•</li></ol><h2 id="stats"><a href="#stats" class="headerlink" title="stats"></a>stats</h2><p><strong>è·å– VM ä¸­ç›´é€šå·çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-volume.go#L83">source code</a></p><ol><li>å¯¹æŒ‡å®šçš„ â€“volume-path å‚æ•°è¿›è¡Œ URLEncoding åï¼Œæ‹¼æ¥æˆ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;volumePath (base64)&gt; è·¯å¾„ç›®å½•</li><li>éå†ç›®å½•ï¼Œè·å–åˆ° sandboxIDï¼ˆç›´é€šå·æ¨¡å¼ä¸‹ï¼Œè¯¥ç›®å½•ä¸­ä»…æœ‰ä¸€ä¸ª sandboxID ç›®å½•ä¸ mountInfo.json æ–‡ä»¶ï¼Œå› æ­¤åç§°ä¸ä¸º mountInfo.json å³ä¸º sandboxIDï¼‰</li><li>è·å–å¹¶è§£æç›®å½•ä¸­çš„ mountInto.json æ–‡ä»¶å†…å®¹ï¼Œå¾—åˆ° mountInfo.Deviceï¼ˆå³ä½äº host ä¸Šå¾…ç›´é€šè‡³ VM ä¸­çš„è®¾å¤‡ï¼‰</li><li>é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock å‘é€ HTTP GET è¯·æ±‚è‡³ shim server çš„ <code>http://shim/direct-volume/stats?path=&lt;device&gt;</code>ï¼Œå±•ç¤ºè¯·æ±‚è¿”å›å†…å®¹</li></ol><h2 id="resize"><a href="#resize" class="headerlink" title="resize"></a>resize</h2><p><strong>æ‰©å®¹ VM çš„ç›´é€šå—è®¾å¤‡çš„å·å¤§å°</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-volume.go#L104">source code</a></p><ol><li>å¯¹æŒ‡å®šçš„ â€“volume-path å‚æ•°è¿›è¡Œ URLEncoding åï¼Œæ‹¼æ¥æˆ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;volumePath (base64)&gt; è·¯å¾„ç›®å½•</li><li>éå†ç›®å½•ï¼Œè·å–åˆ° sandboxIDï¼ˆç›´é€šå·æ¨¡å¼ä¸‹ï¼Œè¯¥ç›®å½•ä¸­ä»…æœ‰ä¸€ä¸ª sandboxID ç›®å½•ä¸ mountInfo.json æ–‡ä»¶ï¼Œå› æ­¤åç§°ä¸ä¸º mountInfo.json çš„å³ä¸º sandboxIDï¼‰</li><li>è·å–å¹¶è§£æç›®å½•ä¸­çš„ mountInto.json æ–‡ä»¶å†…å®¹ï¼Œå¾—åˆ° mountInfo.Deviceï¼ˆå³ä½äº host ä¸Šå¾…ç›´é€šè‡³ VM ä¸­çš„è®¾å¤‡ï¼‰</li><li>é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock å‘é€æ ¼å¼ä¸º application&#x2F;json çš„ HTTP POST è¯·æ±‚è‡³ shim server çš„ <code>http://shim/direct-volume/resize</code>ï¼Œå…¶ä¸­è¯·æ±‚ä½“åŒ…å« mountInfo.Device å’Œå·æ‰©å®¹åçš„æœŸæœ›å¤§å°</li></ol><h1 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h1><h2 id="get"><a href="#get" class="headerlink" title="get"></a>get</h2><p><strong>è·å– VM ä¸­çš„ iptables è§„åˆ™</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-iptables.go#L36">source code</a></p><ol><li>æ ¡éªŒæŒ‡å®šçš„ sandboxID å‚æ•°æ˜¯å¦ä¸ä¸ºç©ºï¼Œä¸”æ­£åˆ™åŒ¹é…æ»¡è¶³ ^[a-zA-Z0-9][a-zA-Z0-9_.-]+$</li><li>å¦‚æœé¢å¤–æŒ‡å®šäº† â€“v6 å‚æ•°ï¼Œåˆ™ url ä¸º &#x2F;ip6tablesï¼Œå¦åˆ™ä¸º &#x2F;iptables</li><li>é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock å‘é€ HTTP GET è¯·æ±‚è‡³ shim server çš„ <code>http://shim/&lt;url&gt;</code>ï¼Œå±•ç¤ºè¯·æ±‚è¿”å›å†…å®¹</li></ol><h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><p><strong>åŸºäºæŒ‡å®šçš„æ–‡ä»¶å†…å®¹ï¼Œè®¾ç½® VM ä¸­çš„ iptables è§„åˆ™</strong></p><p><a href="https://github.com/kata-containers/kata-containers/blob/3.0.0/src/runtime/cmd/kata-runtime/kata-iptables.go#L72">source code</a></p><ol><li>æ ¡éªŒæŒ‡å®šçš„ sandboxID å‚æ•°æ˜¯å¦ä¸ä¸ºç©ºï¼Œä¸”æ­£åˆ™åŒ¹é…æ»¡è¶³ ^[a-zA-Z0-9][a-zA-Z0-9_.-]+$</li><li>æ ¡éªŒæŒ‡å®šçš„ iptables å‚æ•°å¯¹åº”çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¹¶è¯»å– iptables æ–‡ä»¶å†…å®¹</li><li>å¦‚æœé¢å¤–æŒ‡å®šäº† â€“v6 å‚æ•°ï¼Œåˆ™ url ä¸º &#x2F;ip6tablesï¼Œå¦åˆ™ä¸º &#x2F;iptables</li><li>é€šè¿‡ &#x2F;run&#x2F;vc&#x2F;sbs&#x2F;&lt;sandboxID&gt;&#x2F;shim-monitor.sock å‘é€æ ¼å¼ä¸º application&#x2F;octet-stream çš„ HTTP PUT è¯·æ±‚è‡³ shim server çš„ <code>http://shim/&lt;url&gt;</code>ï¼Œå…¶ä¸­è¯·æ±‚ä½“åŒ…å« iptables æ–‡ä»¶å†…å®¹æµ</li></ol>]]></content>
    
    
    <summary type="html">Kata Containers å‘½ä»¤è¡Œå·¥å…·çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Virtual Kubelet ã€å¿«é€Ÿå¼€å§‹</title>
    <link href="http://shenxianghong.github.io/2022/11/22/2022-11-22%20Virtual%20Kubelet%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"/>
    <id>http://shenxianghong.github.io/2022/11/22/2022-11-22%20Virtual%20Kubelet%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/</id>
    <published>2022-11-21T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.267Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="150" style="border: 0px" src="/gallery/virtual-kubelet/logo.svg"></div><hr><blockquote><p>based on <strong>v1.7.0</strong></p></blockquote><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><blockquote><p>Kubernetes API on top, programmable back.</p></blockquote><p>Virtual Kubeletï¼ˆVKï¼‰ æ˜¯ Kubernetes ä¸­ Kubelet çš„å…¸å‹ç‰¹æ€§å®ç°ï¼Œå‘ä¸Šä¼ªè£…æˆ Kubeletï¼Œä»è€Œæ¨¡æ‹Ÿå‡º Node å¯¹è±¡ï¼Œå¯¹æ¥ Kubernetes çš„åŸç”Ÿèµ„æºå¯¹è±¡ã€‚å‘ä¸‹æä¾› APIï¼Œå¯å¯¹æ¥å…¶ä»–èµ„æºç®¡ç†å¹³å°æä¾›çš„ Providerï¼Œä¸åŒçš„å¹³å°é€šè¿‡å®ç° Virtual Kubelet å®šä¹‰çš„æ–¹æ³•ï¼Œå…è®¸èŠ‚ç‚¹ç”±å…¶å¯¹åº”çš„ Provider æä¾›ï¼Œå¦‚ ACIã€AWS Fargateã€IoT Edgeã€Tensile Kube ç­‰ã€‚Virtual Kubelet çš„ä¸»è¦åœºæ™¯æ˜¯å°† Kubernetes API æ‰©å±•åˆ° Serverless å®¹å™¨å¹³å°ï¼ˆå¦‚ ACI å’Œ Fargateï¼‰æˆ–è€…æ‰©å±•åˆ°å¦‚ Docker Swarmã€Openstack ZUN ç­‰å®¹å™¨å¹³å°ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Provider çº³ç®¡å…¶ä»– Kubernetes é›†ç¾¤ï¼Œç”šè‡³æ˜¯åŸç”Ÿçš„ IAAS å¹³å°ï¼ˆå¦‚ VMwareã€Openstack ç­‰ã€‚åœ¨ç¤¾åŒºå®—æ—¨ä¸­ï¼ŒVirtual Kubelet ä¸æ˜¯ç”¨æ¥å®ç°é›†ç¾¤è”é‚¦çš„æ‰‹æ®µã€‚</p><p>Virtual Kubelet å…·æœ‰å¯æ’æ‹”æ¶æ„å’Œç›´æ¥ä½¿ç”¨ Kubernetes åŸè¯­çš„ç‰¹ç‚¹ï¼Œæ›´æ˜“äºæ„å»ºã€‚</p><h1 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h1><div align=center><img width="800" style="border: 0px" src="/gallery/virtual-kubelet/diagram.svg"></div><p><strong>ä¸ä¼ ç»Ÿ Kubelet çš„åŒºåˆ«</strong></p><ul><li>ä¼ ç»Ÿçš„ Kubelet å®ç°äº†æ‰€åœ¨èŠ‚ç‚¹çš„ Pod å’Œå®¹å™¨çš„æ“ä½œè¡Œä¸º</li><li>Virtual Kubelet ä»¥èŠ‚ç‚¹çš„å½¢å¼æ³¨å†Œï¼Œå…è®¸å¼€å‘è€…ä»¥è‡ªå®šä¹‰çš„è¡Œä¸ºéƒ¨ç½² Pod å’Œå®¹å™¨</li></ul><p><strong>å½“å‰æ”¯æŒçš„ Kubernetes ç‰¹æ€§</strong></p><ul><li>åˆ›å»ºã€åˆ é™¤å’Œæ›´æ–° Pod</li><li>å®¹å™¨æ—¥å¿—ã€ç®¡ç†å’ŒæŒ‡æ ‡</li><li>è·å– Pod ä»¥åŠçŠ¶æ€</li><li>èŠ‚ç‚¹åœ°å€ã€èŠ‚ç‚¹å®¹é‡ã€èŠ‚ç‚¹å®ˆæŠ¤è¿›ç¨‹ç«¯ç‚¹</li><li>ç®¡ç†æ“ä½œç³»ç»Ÿ</li><li>æºå¸¦ç§æœ‰è™šæ‹Ÿç½‘ç»œ</li></ul><h1 id="Providers"><a href="#Providers" class="headerlink" title="Providers"></a>Providers</h1><p>Virtual Kubelet ä¸“æ³¨äºæä¾›ä¸€ä¸ªåº“ï¼Œç”¨æˆ·å¯ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨è¯¥åº“æ¥æ„å»ºè‡ªå®šä¹‰ Kubernetes èŠ‚ç‚¹ agentã€‚</p><p>è¯¥é¡¹ç›®å…·æœ‰ä¸€ä¸ªå¯æ’æ‹”çš„ Provider æ¥å£ï¼Œå¼€å‘è€…å¯ä»¥å®ç°è¯¥æ¥å£æ¥å®šä¹‰ Kubelet çš„æ“ä½œã€‚</p><p>æ”¯æŒæŒ‰éœ€å’Œä¸ Kubernetes è¿‘ä¹å³æ—¶çš„ç¼–æ’å®¹å™¨è®¡ç®—ï¼Œæ— éœ€ç®¡ç† VM åŸºç¡€è®¾æ–½ï¼ŒåŒæ—¶ä»ç„¶åˆ©ç”¨å¯ç§»æ¤çš„ Kubernetes APIã€‚</p><p>æ¯ä¸ª Provider å¯èƒ½æœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶å’Œæ‰€éœ€çš„ç¯å¢ƒå˜é‡ã€‚</p><p>Provider å¿…é¡»å…·å¤‡ä»¥ä¸‹åŠŸèƒ½æ‰èƒ½ä¸ Virtual Kubelet é›†æˆæ”¯æŒï¼š</p><ul><li><p>æä¾›å¿…è¦çš„åç«¯æœåŠ¡ï¼Œç”¨äºæ”¯æŒ Kubernetes çš„ Podã€å®¹å™¨å’Œæ”¯æŒèµ„æºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</p></li><li><p>ç¬¦åˆ Virtual Kubelet çš„ API è§„èŒƒ</p></li><li><p>æ— æ³•è®¿é—® Kubernetes API æœåŠ¡å™¨ï¼Œå¹¶ä¸”å…·æœ‰å®šä¹‰æ˜ç¡®çš„å›è°ƒæœºåˆ¶æ¥è·å– Secret æˆ– ConfigMap ç­‰æ•°æ®</p></li></ul><p><em>å‚è€ƒï¼š<a href="https://pkg.go.dev/github.com/virtual-kubelet/virtual-kubelet#section-readme">virtual-kubelet godoc</a></em></p><h2 id="Admiralty-Multi-Cluster-Scheduler"><a href="#Admiralty-Multi-Cluster-Scheduler" class="headerlink" title="Admiralty Multi-Cluster Scheduler"></a>Admiralty Multi-Cluster Scheduler</h2><p>Admiralty Multi-Cluster Scheduler å°†ç‰¹å®šçš„ Pod è¿è¡Œåœ¨ Virtual Kubelet èŠ‚ç‚¹ä¸Šï¼Œä½œä¸ºâ€œä»£ç† Podâ€ï¼Œå¹¶åœ¨è¿œç¨‹é›†ç¾¤ï¼ˆå®é™…è¿è¡Œå®¹å™¨ï¼‰ä¸­åˆ›å»ºç›¸åº”çš„â€å§”æ‰˜ Podâ€ã€‚é€šè¿‡æ§åˆ¶å¾ªç¯æœºåˆ¶ï¼Œæ›´æ–°ä»£ç† Pod çš„ä¿¡æ¯ç”¨æ¥åæ˜ å§”æ‰˜ Pod çš„çŠ¶æ€ã€‚</p><p><em>å‚è€ƒï¼š<a href="https://github.com/admiraltyio/multicluster-scheduler">Admiralty Multi-Cluster Scheduler documentation</a></em></p><h2 id="Alibaba-Cloud-Elastic-Container-Instance-ECI"><a href="#Alibaba-Cloud-Elastic-Container-Instance-ECI" class="headerlink" title="Alibaba Cloud Elastic Container Instance (ECI)"></a>Alibaba Cloud Elastic Container Instance (<strong>ECI</strong>)</h2><p>é˜¿é‡Œäº‘ ECIï¼ˆå¼¹æ€§å®¹å™¨å®ä¾‹ï¼‰æ˜¯ä¸€ç§æ— éœ€ç®¡ç†æœåŠ¡å™¨æˆ–é›†ç¾¤å³å¯è¿è¡Œå®¹å™¨çš„æœåŠ¡ã€‚é˜¿é‡Œäº‘ ECI Provider æ˜¯è¿æ¥ K8så’Œ ECI æœåŠ¡ä¹‹é—´çš„æ¡¥æ¢ã€‚</p><p><em>å‚è€ƒï¼š <a href="https://github.com/virtual-kubelet/alibabacloud-eci/blob/master/README.md">Alibaba Cloud ECI documentation</a></em></p><h2 id="Azure-Container-Instances-ACI"><a href="#Azure-Container-Instances-ACI" class="headerlink" title="Azure Container Instances (ACI)"></a>Azure Container Instances (<strong>ACI</strong>)</h2><p>Azure å®¹å™¨å®ä¾‹ Provider å…è®¸åœ¨åŒä¸€ä¸ª Kubernetes é›†ç¾¤ä¸­åŒæ—¶ä½¿ç”¨ VM ä¸Šçš„ Pod å’Œ Azure å®¹å™¨å®ä¾‹ã€‚</p><div align=center><img width="600" style="border: 0px" src="/gallery/virtual-kubelet/aci.png"></div><p><em>å‚è€ƒï¼š<a href="https://github.com/virtual-kubelet/azure-aci/blob/master/README.md">Azure Container Instances documentation</a></em></p><h2 id="AWS-Fargate"><a href="#AWS-Fargate" class="headerlink" title="AWS Fargate"></a>AWS Fargate</h2><p>AWS Fargate æ˜¯ä¸€ç§å…è®¸è¿è¡Œå®¹å™¨è€Œæ— éœ€ç®¡ç†æœåŠ¡å™¨æˆ–é›†ç¾¤çš„æŠ€æœ¯ã€‚</p><p>AWS Fargate æä¾›å•†å…è®¸å°† Pod éƒ¨ç½²åˆ° AWS Fargateã€‚åœ¨ AWS Fargate ä¸Šçš„ Pod å¯ä»¥è®¿é—®å…·æœ‰å­ç½‘ä¸­ä¸“ç”¨ ENI çš„ VPC ç½‘ç»œã€è¿æ¥åˆ°äº’è”ç½‘çš„å…¬å…± IP åœ°å€ã€è¿æ¥åˆ° Kubernetes é›†ç¾¤çš„ç§æœ‰ IP åœ°å€ã€å®‰å…¨ç»„ã€IAM è§’è‰²ã€CloudWatch Logs å’Œè®¸å¤šå…¶ä»– AWS æœåŠ¡ã€‚ Fargate ä¸Šçš„ Pod å¯ä»¥ä¸åŒä¸€ Kubernetes é›†ç¾¤ä¸­å¸¸è§„å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ Pod å…±å­˜ã€‚</p><p><em>å‚è€ƒï¼š<a href="https://github.com/virtual-kubelet/aws-fargate">AWS Fargate documentation</a></em></p><h2 id="Elotl-Kip"><a href="#Elotl-Kip" class="headerlink" title="Elotl Kip"></a>Elotl Kip</h2><p>Kip æ˜¯ä¸€ä¸ªåœ¨äº‘å®ä¾‹ä¸­è¿è¡Œ Pod çš„æä¾›å•†ï¼Œå…è®¸ Kubernetes é›†ç¾¤é€æ˜åœ°å°†å·¥ä½œè´Ÿè½½æ‰©å±•åˆ°äº‘ä¸­ã€‚å½“ä¸€ä¸ª Pod è¢«è°ƒåº¦åˆ°è™šæ‹ŸèŠ‚ç‚¹ä¸Šæ—¶ï¼ŒKip ä¼šä¸º Pod çš„å·¥ä½œè´Ÿè½½å¯åŠ¨ä¸€ä¸ªå¤§å°åˆé€‚çš„äº‘å®ä¾‹ï¼Œå¹¶å°† Pod è°ƒåº¦åˆ°è¯¥å®ä¾‹ä¸Šã€‚å½“ Pod å®Œæˆè¿è¡Œæ—¶ï¼Œäº‘å®ä¾‹å°†ç»ˆæ­¢ã€‚</p><p>å½“å·¥ä½œè´Ÿè½½åœ¨ Kip ä¸Šè¿è¡Œæ—¶ï¼Œé›†ç¾¤å¤§å°è‡ªç„¶ä¼šéšç€é›†ç¾¤å·¥ä½œè´Ÿè½½è€Œæ‰©å±•ï¼ŒPod å½¼æ­¤é«˜åº¦éš”ç¦»ï¼Œå¹¶ä¸”ç”¨æˆ·æ— éœ€ç®¡ç†å·¥ä½œèŠ‚ç‚¹å¹¶å°† Pod æˆ˜ç•¥æ€§åœ°è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šã€‚</p><p><em>å‚è€ƒï¼š<a href="https://github.com/elotl/kip">Elotl Kip documentation</a></em></p><h2 id="Kubernetes-Container-Runtime-Interface-CRI"><a href="#Kubernetes-Container-Runtime-Interface-CRI" class="headerlink" title="Kubernetes Container Runtime Interface (CRI)"></a>Kubernetes Container Runtime Interface (<strong>CRI</strong>)</h2><p>CRI Provider æ˜¯åŸºäº CRI çš„å®¹å™¨è¿è¡Œæ—¶ç®¡ç†çœŸå®çš„ Pod å’Œå®¹å™¨ã€‚</p><p>CRI Provider çš„ç›®çš„ä»…ç”¨äºæµ‹è¯•å’ŒåŸå‹ã€‚ä¸å¾—ç”¨äºä»»ä½•å…¶ä»–ç›®çš„ï¼</p><p>Virtual Kubelet é¡¹ç›®çš„é‡ç‚¹æ˜¯ä¸ºä¸ç¬¦åˆæ ‡å‡†èŠ‚ç‚¹æ¨¡å‹çš„å®¹å™¨è¿è¡Œæ—¶æä¾›æ¥å£ã€‚ è€Œ Kubelet ä»£ç åº“æ˜¯å…¨é¢çš„æ ‡å‡† CRI èŠ‚ç‚¹ä»£ç†ï¼Œå¹¶ä¸”æ­¤ Provider ä¸ä¼šå°è¯•é‡æ–°åˆ›å»ºå®ƒã€‚</p><p>è¿™ä¸ª Provider å®ç°æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„æœ€å°å®ç°ï¼Œå®ƒå¯ä»¥æ›´å®¹æ˜“åœ°é’ˆå¯¹çœŸå®çš„ Pod å’Œå®¹å™¨æµ‹è¯• Virtual Kubelet é¡¹ç›®çš„æ ¸å¿ƒåŠŸèƒ½ â€”â€” æ¢å¥è¯è¯´ï¼Œå®ƒæ¯” MockProvider æ›´å…¨é¢ã€‚</p><p><strong>å·²çŸ¥é™åˆ¶</strong></p><ul><li>CRI Provider å®ç°äº† Provider æ¥å£å…¨éƒ¨æ“ä½œï¼Œä¸»è¦æ˜¯ç®¡ç† Pod çš„ç”Ÿå‘½å‘¨æœŸã€è¿”å›æ—¥å¿—å’Œå…¶ä»–å†…å®¹</li><li>å…·å¤‡åˆ›å»º emptyDirã€configmap å’Œ secret volumes çš„èƒ½åŠ›ï¼Œä½†å¦‚æœå½“å‘ç”Ÿå˜åŒ–æ—¶ä¸ä¼šæ›´æ–°</li><li>ä¸æ”¯æŒä»»ä½•ç±»å‹çš„æŒä¹…å·</li><li>ä¼šåœ¨å¯åŠ¨æ—¶å°è¯•è¿è¡Œ kube-proxyï¼Œå¹¶ä¸”å¯ä»¥æˆåŠŸè¿è¡Œã€‚ä½†æ˜¯ï¼Œå½“å°† Virtual Kubelet è½¬æ¢ä¸ºæŠ½è±¡åœ°å¤„ç† Service å’Œè·¯ç”±çš„æ¨¡å‹æ—¶ï¼Œæ­¤åŠŸèƒ½å°†è¢«é‡æ„ä¸ºæµ‹è¯•è¯¥åŠŸèƒ½çš„ä¸€ç§æ–¹å¼</li><li>ç½‘ç»œç›®å‰æ˜¯éåŠŸèƒ½æ€§çš„</li></ul><h2 id="Huawei-Cloud-Container-Instance-CCI"><a href="#Huawei-Cloud-Container-Instance-CCI" class="headerlink" title="Huawei Cloud Container Instance (CCI)"></a>Huawei Cloud Container Instance (<strong>CCI</strong>)</h2><p>åä¸º CCI Virtual Kubelet Provider å°† CCI é¡¹ç›®é…ç½®æˆä»»ä½• Kubernetes é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚åä¸º CCEï¼ˆäº‘å®¹å™¨å¼•æ“ï¼‰ã€‚CCE æ”¯æŒåŸç”Ÿ Kubernetes åº”ç”¨å’Œå·¥å…·ä½œä¸ºç§æœ‰é›†ç¾¤ï¼Œä¾¿äºè½»æ¾æ­å»ºå®¹å™¨è¿è¡Œç¯å¢ƒã€‚è¢«è°ƒåº¦åˆ° Virtual Kubelet Provider çš„ Pod å°†è¿è¡Œåœ¨ CCI ä¸­ï¼Œä¾¿äºæ›´å¥½çš„åˆ©ç”¨ CCI çš„é«˜æ€§èƒ½ã€‚</p><div align=center><img width="600" style="border: 0px" src="/gallery/virtual-kubelet/cci-provider.svg"></div><p><em>å‚è€ƒï¼š<a href="https://github.com/virtual-kubelet/huawei-cci/blob/master/README.md#readme">Huawei CCI documentation</a></em></p><h2 id="HashiCorp-Nomad"><a href="#HashiCorp-Nomad" class="headerlink" title="HashiCorp Nomad"></a>HashiCorp Nomad</h2><p>Virtual Kubelet çš„ HashiCorp Nomad Provider é€šè¿‡å°† Nomad é›†ç¾¤å…¬å¼€ä¸º Kubernetes ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°†Kubernetes é›†ç¾¤ä¸ Nomad é›†ç¾¤è¿æ¥èµ·æ¥ã€‚å€ŸåŠ© Providerï¼Œåœ¨ Kubernetes ä¸Šæ³¨å†Œçš„è™šæ‹Ÿ Nomad èŠ‚ç‚¹ä¸Šè°ƒåº¦çš„ Pod å°†ä½œä¸º Job åœ¨ Nomad å®¢æˆ·ç«¯ä¸Šè¿è¡Œï¼Œå°±åƒåœ¨ Kubernetes èŠ‚ç‚¹ä¸Šä¸€æ ·ã€‚</p><p><em>å‚è€ƒï¼š<a href="https://github.com/virtual-kubelet/nomad/blob/master/README.md">HashiCorp Nomad documentation</a></em></p><h2 id="Liqo"><a href="#Liqo" class="headerlink" title="Liqo"></a>Liqo</h2><p>Liqo ä¸º Virtual Kubelet å®ç°äº†ä¸€ä¸ª Providerï¼Œæ—¨åœ¨é€æ˜åœ°å°† Pod å’ŒæœåŠ¡å¸è½½åˆ°â€œå¯¹ç­‰â€Kubernetes è¿œç¨‹é›†ç¾¤ã€‚ Liqo èƒ½å¤Ÿå‘ç°é‚»å±…é›†ç¾¤ï¼ˆä½¿ç”¨ DNSã€mDNSï¼‰å¹¶ä¸å…¶â€œå¯¹ç­‰â€ï¼Œæˆ–è€…è¯´å»ºç«‹å…³ç³»ä»¥å…±äº«é›†ç¾¤çš„éƒ¨åˆ†èµ„æºã€‚å½“é›†ç¾¤å»ºç«‹å¯¹ç­‰è¿æ¥æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ Liqo Virtual Kubelet å®ä¾‹ï¼Œé€šè¿‡æä¾›è¿œç¨‹é›†ç¾¤èµ„æºçš„æŠ½è±¡æ¥æ— ç¼æ‰©å±•é›†ç¾¤çš„å®¹é‡ã€‚è¯¥æä¾›å•†ä¸ Liqo ç½‘ç»œç»“æ„ç›¸ç»“åˆï¼Œé€šè¿‡å¯ç”¨ Pod åˆ° Pod æµé‡å’Œå¤šé›†ç¾¤ä¸œè¥¿å‘æœåŠ¡æ‰©å±•é›†ç¾¤ç½‘ç»œï¼Œæ”¯æŒä¸¤ä¸ªé›†ç¾¤ä¸Šçš„ç«¯ç‚¹ã€‚</p><p><em>å‚è€ƒï¼š<a href="https://github.com/liqotech/liqo/blob/master/README.md">Liqo documentation</a></em></p><h2 id="OpenStack-Zun"><a href="#OpenStack-Zun" class="headerlink" title="OpenStack Zun"></a>OpenStack Zun</h2><p>Virtual Kubelet çš„ OpenStack Zun Provider ç”¨äºå°† Kubernetes é›†ç¾¤ä¸ OpenStack é›†ç¾¤æ‰“é€šï¼Œä»è€Œå¯ä»¥åœ¨ OpenStack ä¸Šè¿è¡Œ Kubernetes çš„ Podã€‚å€ŸåŠ©å­ç½‘ä¸­çš„ Neutron ç«¯å£ï¼Œåœ¨ OpenStack ä¸Šçš„ Pod å¯ä»¥è®¿é—® OpenStack ç§Ÿæˆ·ç½‘ç»œï¼Œæ¯ä¸ª Pod éƒ½æœ‰ç§æœ‰ IP åœ°å€ï¼Œå¯ä»¥è¿æ¥åˆ°ç§Ÿæˆ·å†…çš„å…¶ä»– OpenStack èµ„æºï¼ˆä¾‹å¦‚ VMï¼‰ï¼Œä¹Ÿå¯ä»¥å€ŸåŠ©æµ®åŠ¨ IP åœ°å€è¿æ¥äº’è”ç½‘ï¼Œæˆ–è€…å°† Cinder å·ç»‘å®šç»™ Pod å®¹å™¨ä½¿ç”¨ã€‚</p><p><em>å‚è€ƒï¼š<a href="https://github.com/virtual-kubelet/openstack-zun/blob/master/README.md">OpenStack Zun documentation</a></em></p><h2 id="Tencent-Games-Tensile-Kube"><a href="#Tencent-Games-Tensile-Kube" class="headerlink" title="Tencent Games Tensile Kube"></a>Tencent Games Tensile Kube</h2><p>Tensile Kube Provider ç”±è…¾è®¯æ¸¸æˆæä¾›ï¼Œå¯å°† Kubernetes é›†ç¾¤ä¸å…¶ä»– Kubernetes é›†ç¾¤è¿æ¥èµ·æ¥ã€‚è¯¥ Provider èƒ½å¤Ÿå°† Kubernetes é›†ç¾¤è§„æ¨¡æ— é™æ‰©å±•ã€‚åº•å±‚é›†ç¾¤ä»¥è™šæ‹ŸèŠ‚ç‚¹çš„å½¢æ€æ³¨å†Œåˆ°ä¸Šå±‚é›†ç¾¤ä¸­ï¼Œå€ŸåŠ© Providerï¼Œè°ƒåº¦åœ¨è™šæ‹ŸèŠ‚ç‚¹ä¸Šçš„ Pod å°†åœ¨å…¶ä»– Kubernetes é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚</p><h3 id="æ¶æ„è®¾è®¡"><a href="#æ¶æ„è®¾è®¡" class="headerlink" title="æ¶æ„è®¾è®¡"></a>æ¶æ„è®¾è®¡</h3><div align=center><img width="600" style="border: 0px" src="/gallery/virtual-kubelet/tensile-kube.png"></div><ul><li><p>virtual-node</p><p>åŸºäº virtual-kubelet å®ç°çš„ Kubernetes Providerã€‚åœ¨ä¸Šå±‚é›†ç¾¤ä¸­åˆ›å»ºçš„ Pod å°†åŒæ­¥åˆ°åº•å±‚é›†ç¾¤ã€‚å¦‚æœ Pod ä¾èµ–äº ConfigMaps æˆ– Secretï¼Œé‚£ä¹ˆä¾èµ–å…³ç³»ä¹Ÿä¼šåœ¨é›†ç¾¤ä¸­åˆ›å»º</p></li><li><p>multi-cluster scheduler</p><p>åŸºäº K8s schedule framework å®ç°ã€‚å®ƒä¼šåœ¨è°ƒåº¦ Pod æ—¶æ ¹æ®æ‰€æœ‰åº•å±‚é›†ç¾¤çš„å®¹é‡ï¼Œå¹¶è°ƒç”¨ filter è¿‡æ»¤å™¨ã€‚å¦‚æœå¯ç”¨èŠ‚ç‚¹æ•°å¤§äºæˆ–ç­‰äº 1ï¼Œåˆ™ Pod å¯ä»¥è¢«è°ƒåº¦ã€‚å› æ­¤ï¼Œè¿™å¯èƒ½ä¼šæ¶ˆè€—æ›´å¤šèµ„æºï¼Œå› æ­¤æ·»åŠ äº†å¦ä¸€ä¸ªå®ç°ï¼ˆdeschedulerï¼‰</p></li><li><p>descheduler</p><p>descheduler æ˜¯åŸºäº K8s descheduler çš„äºŒæ¬¡ä¼˜åŒ–ï¼Œæ”¹å˜äº†ä¸€äº›é€»è¾‘ã€‚å®ƒä¼šé€šè¿‡æ³¨å…¥ä¸€äº› nodeAffinity é‡æ–°åˆ›å»ºä¸€äº›ä¸å¯è°ƒåº¦çš„ Podã€‚å¯ä»¥é€‰æ‹©éƒ¨ç½²ä¸Šå±‚é›†ç¾¤ä¸­çš„ multi-scheduler å’Œ descheduler ä¹‹ä¸€ï¼Œä¹Ÿå¯ä»¥åŒæ—¶é€‰æ‹©ä¸¤è€…</p><ul><li>å¤§è§„æ¨¡é›†ç¾¤ä¸å»ºè®®ä½¿ç”¨ multi-schedulerï¼Œå½“èŠ‚ç‚¹æ€»æ•°è¶…è¿‡ 10000 æ—¶ï¼Œdescheduler å¼€é”€ç›¸å¯¹æ›´å°</li><li>å½“é›†ç¾¤ä¸­çš„èŠ‚ç‚¹è¾ƒå°‘æ—¶ï¼Œmulti-scheduler æ•ˆæœä¼šæ›´å¥½ï¼Œä¾‹å¦‚æœ‰ 10 ä¸ªé›†ç¾¤ï¼Œæ¯ä¸ªé›†ç¾¤åªæœ‰ 100 ä¸ªèŠ‚ç‚¹</li></ul></li><li><p>webhook</p><p>Webhook æ˜¯åŸºäº K8s mutation webhook è®¾è®¡çš„ã€‚ç”¨äºè½¬æ¢ä¸€äº›å¯èƒ½å½±å“ä¸Šå±‚é›†ç¾¤ä¸­è°ƒåº¦ Podï¼ˆä¸åœ¨ kube-system ä¸­ï¼‰çš„å­—æ®µï¼Œä¾‹å¦‚ nodeSelectorã€nodeAffinity å’Œ tolerationsã€‚ä½†æ˜¯åªæœ‰æ ‡ç­¾ä¸º virtual-pod:true çš„ Pod æ‰ä¼šè¢«è½¬æ¢</p><p>å¼ºçƒˆå»ºè®® Pod è¿è¡Œåœ¨åº•å±‚é›†ç¾¤å¹¶æ·»åŠ æ ‡ç­¾ virtual-pod:trueï¼Œé™¤éé‚£äº› Pod å¿…é¡»éƒ¨ç½²åœ¨ä¸Šå±‚é›†ç¾¤çš„ kube-system ä¸­</p><ul><li>å¯¹äº K8s &lt; 1.16ï¼Œæ²¡æœ‰ label çš„ pod ä¸ä¼šè¢«è½¬æ¢ã€‚ä½†ä»ä¼šå‘é€è¯·æ±‚åˆ° webhook</li><li>å¯¹äº K8s &gt;&#x3D; 1.16ï¼Œå¯ä»¥ä½¿ç”¨ label selector ä¸ºä¸€äº›æŒ‡å®šçš„ pod å¯ç”¨ webhook</li><li>æ€»çš„æ¥è¯´ï¼Œæœ€åˆçš„æƒ³æ³•æ˜¯åªåœ¨åº•å±‚é›†ç¾¤ä¸­è¿è¡Œ Pod</li></ul></li></ul><h3 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h3><ul><li>å¦‚æœè¦ä½¿ç”¨ Serverï¼Œå¿…é¡»ä¿æŒ Pod é—´é€šä¿¡æ­£å¸¸ã€‚é›†ç¾¤ A ä¸­çš„ Pod A å¯ä»¥è¢«é›†ç¾¤ B ä¸­çš„ Pod B é€šè¿‡ ip è®¿é—®ã€‚default å‘½åç©ºé—´ä¸­çš„æœåŠ¡ Kubernetes å’Œ kube-system ä¸­çš„å…¶ä»–æœåŠ¡å°†åŒæ­¥åˆ°è¾ƒåº•å±‚çš„é›†ç¾¤</li><li>åœ¨ repo ä¸­å¼€å‘çš„ multi-scheduler å¯èƒ½ä¼šèŠ±è´¹æ›´å¤šèµ„æºï¼Œå› ä¸ºå®ƒä¼šåŒæ­¥æ‰€æœ‰è¾ƒåº•å±‚é›†ç¾¤ä¸­è°ƒåº¦ç¨‹åºéœ€è¦çš„æ‰€æœ‰å¯¹è±¡</li><li>descheduler ä¸èƒ½ç»å¯¹é¿å…èµ„æºç¢ç‰‡åŒ–</li><li>PV&#x2F;PVC åªæ”¯æŒæœ¬åœ° PV çš„ WaitForFirstConsumerï¼Œä¸Šå±‚é›†ç¾¤çš„è°ƒåº¦å™¨åº”è¯¥å¿½ç•¥ VolumeBindCheck</li></ul><h3 id="ç”¨ä¾‹"><a href="#ç”¨ä¾‹" class="headerlink" title="ç”¨ä¾‹"></a>ç”¨ä¾‹</h3><div align=center><img width="800" style="border: 0px" src="/gallery/virtual-kubelet/multi.png"></div><p><em>å‚è€ƒï¼š<a href="https://github.com/virtual-kubelet/tensile-kube/blob/master/README.md">Tensile Kube documentation</a></em></p><h1 id="Provider-æ¥å£å®ç°"><a href="#Provider-æ¥å£å®ç°" class="headerlink" title="Provider æ¥å£å®ç°"></a>Provider æ¥å£å®ç°</h1><p>Provider å®ç°äº† Kubernetes èŠ‚ç‚¹ä»£ç† ï¼ˆå³ Kubeletï¼‰çš„æ ¸å¿ƒé€»è¾‘ã€‚</p><h2 id="PodLifecylceHandler"><a href="#PodLifecylceHandler" class="headerlink" title="PodLifecylceHandler"></a>PodLifecylceHandler</h2><p>ç”¨äºå¤„ç†åœ¨ Kubernetes ä¸­åˆ›å»ºã€æ›´æ–°æˆ–åˆ é™¤ Pod çš„è¯·æ±‚ã€‚</p><p><a href="https://godoc.org/github.com/virtual-kubelet/virtual-kubelet/node#PodLifecycleHandler">godoc#PodLifecylceHandler</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PodLifecycleHandler <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// CreatePod takes a Kubernetes Pod and deploys it within the provider.</span></span><br><span class="line">    CreatePod(ctx context.Context, pod *corev1.Pod) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// UpdatePod takes a Kubernetes Pod and updates it within the provider.</span></span><br><span class="line">    UpdatePod(ctx context.Context, pod *corev1.Pod) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// DeletePod takes a Kubernetes Pod and deletes it from the provider.</span></span><br><span class="line">    DeletePod(ctx context.Context, pod *corev1.Pod) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// GetPod retrieves a pod by name from the provider (can be cached).</span></span><br><span class="line">    GetPod(ctx context.Context, namespace, name <span class="type">string</span>) (*corev1.Pod, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GetPodStatus retrieves the status of a pod by name from the provider.</span></span><br><span class="line">    GetPodStatus(ctx context.Context, namespace, name <span class="type">string</span>) (*corev1.PodStatus, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// GetPods retrieves a list of all pods running on the provider (can be cached).</span></span><br><span class="line">    GetPods(context.Context) ([]*corev1.Pod, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ä¸ªå¯é€‰å®ç°çš„æ¥å£ PodNotifieryï¼Œç”¨äº Provider å¼‚æ­¥é€šçŸ¥ virtual-kubelet æœ‰å…³ Pod çŠ¶æ€æ›´æ”¹çš„ä¿¡æ¯ã€‚å¦‚æœæ²¡æœ‰å®ç°è¿™ä¸ªæ¥å£ï¼Œvirtual-kubelet ä¼šå‘¨æœŸæ€§çš„æ£€æŸ¥æ‰€æœ‰ Pod çš„çŠ¶æ€ã€‚</p><p><em>å¼ºçƒˆå»ºè®®å®ç° PodNotifierï¼Œå°¤å…¶æ˜¯å½“è¿è¡Œå¤§é‡ Pod æ—¶ã€‚</em></p><p><a href="https://godoc.org/github.com/virtual-kubelet/virtual-kubelet/node#PodNotifier">godoc#PodNotifier</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> PodNotifier <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// NotifyPods instructs the notifier to call the passed in function when</span></span><br><span class="line">    <span class="comment">// the pod status changes.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NotifyPods should not block callers.</span></span><br><span class="line">    NotifyPods(context.Context, <span class="function"><span class="keyword">func</span><span class="params">(*corev1.Pod)</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PodLifecycleHandler ç”± PodController ç»´æŠ¤ï¼ŒPodController æ˜¯ç®¡ç†åˆ†é…ç»™èŠ‚ç‚¹ Pod çš„æ ¸å¿ƒé€»è¾‘ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pc, _ := node.NewPodController(podControllerConfig) <span class="comment">// &lt;-- instatiates the pod controller</span></span><br><span class="line">pc.Run(ctx) <span class="comment">// &lt;-- starts watching for pods to be scheduled on the node</span></span><br></pre></td></tr></table></figure><h2 id="NodeProvider"><a href="#NodeProvider" class="headerlink" title="NodeProvider"></a>NodeProvider</h2><p>NodeProvider è´Ÿè´£é€šçŸ¥ virtual-kubelet èŠ‚ç‚¹çŠ¶æ€æ›´æ–°ã€‚ virtual-kubelet ä¼šå®šæœŸæ£€æŸ¥èŠ‚ç‚¹çš„çŠ¶æ€å¹¶ç›¸åº”åœ°æ›´æ–°è‡³ Kubernetesã€‚</p><p><a href="https://godoc.org/github.com/virtual-kubelet/virtual-kubelet/node#NodeProvider">godoc#NodeProvider</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> NodeProvider <span class="keyword">interface</span> &#123;</span><br><span class="line">    <span class="comment">// Ping checks if the node is still active.</span></span><br><span class="line">    <span class="comment">// This is intended to be lightweight as it will be called periodically as a</span></span><br><span class="line">    <span class="comment">// heartbeat to keep the node marked as ready in Kubernetes.</span></span><br><span class="line">    Ping(context.Context) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// NotifyNodeStatus is used to asynchronously monitor the node.</span></span><br><span class="line">    <span class="comment">// The passed in callback should be called any time there is a change to the</span></span><br><span class="line">    <span class="comment">// node&#x27;s status.</span></span><br><span class="line">    <span class="comment">// This will generally trigger a call to the Kubernetes API server to update</span></span><br><span class="line">    <span class="comment">// the status.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NotifyNodeStatus should not block callers.</span></span><br><span class="line">    NotifyNodeStatus(ctx context.Context, cb <span class="function"><span class="keyword">func</span><span class="params">(*corev1.Node)</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NodeProvider ç”± NodeController ç»´æŠ¤ï¼Œè¿™æ˜¯ Kubernetes ç®¡ç†èŠ‚ç‚¹å¯¹è±¡çš„æ ¸å¿ƒé€»è¾‘ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc, _ := node.NewNodeController(nodeProvider, nodeSpec) <span class="comment">// &lt;-- instantiate a node controller from a node provider and a kubernetes node spec</span></span><br><span class="line">nc.Run(ctx) <span class="comment">// &lt;-- creates the node in kubernetes and starts up he controller</span></span><br></pre></td></tr></table></figure><p><a href="https://godoc.org/github.com/virtual-kubelet/virtual-kubelet/node#NaiveNodeProvider">godoc#NaiveNodeProvider</a></p><p>Virtual Kubelet æä¾›äº†ä¸€ä¸ª NaiveNodeProviderï¼Œç”¨äºä¸æ‰“ç®—è‡ªå®šä¹‰èŠ‚ç‚¹è¡Œä¸ºæ—¶ã€‚</p><h2 id="API-endpoints"><a href="#API-endpoints" class="headerlink" title="API endpoints"></a>API endpoints</h2><p>Kubelet çš„å·¥ä½œä¹‹ä¸€æ˜¯æ¥å—æ¥è‡ª API Server çš„è¯·æ±‚ï¼Œæ¯”å¦‚ kubectl logs å’Œ kubectl execã€‚</p><p>å¦‚æœæƒ³åœ¨é›†ç¾¤ä¸­ä½¿ç”¨ HPAï¼ˆHorizontal Pod Autoscalerï¼‰ï¼ŒProvider åº”è¯¥å®ç° GetStatsSummary å‡½æ•°ã€‚ç„¶å metrics-server å°†èƒ½å¤Ÿè·å– virtual-kubelet ä¸Šçš„ Pod çš„æŒ‡æ ‡ã€‚å¦åˆ™ï¼Œå¯èƒ½ä¼šåœ¨ metrics-server ä¸Šçœ‹åˆ° No metrics for podï¼Œè¿™æ„å‘³ç€ä¸ä¼šæ”¶é›† virtual-kubelet ä¸Šçš„ Pod çš„æŒ‡æ ‡ã€‚</p><h1 id="å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ"><a href="#å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ"></a>å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ</h1><h2 id="Service-ç¼ºå°‘-Load-Balancer-IP"><a href="#Service-ç¼ºå°‘-Load-Balancer-IP" class="headerlink" title="Service ç¼ºå°‘ Load Balancer IP"></a>Service ç¼ºå°‘ Load Balancer IP</h2><p><strong>Provider ä¸æ”¯æŒæœåŠ¡å‘ç°</strong></p><p>Kubernetes 1.9 ä¸ºæ§åˆ¶å¹³é¢çš„ Controller Manager å¼•å…¥äº†ä¸€ä¸ªæ–°æ ‡è¯† ServiceNodeExclusionã€‚åœ¨ Controller Manager çš„é…ç½®æ–‡ä»¶ä¸­å¯ç”¨æ­¤æ ‡å¿—å…è®¸ Kubernetes å°† Virtual Kubelet èŠ‚ç‚¹æ’é™¤åœ¨æ·»åŠ åˆ°è´Ÿè½½å‡è¡¡å™¨æ± ä¹‹å¤–ï¼Œåˆ›å»ºå…·æœ‰å¤–éƒ¨ IP çš„ Serviceã€‚</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><p>é›†ç¾¤è¦æ±‚ï¼šKubernetes 1.9æˆ–ä»¥ä¸Š</p><p>Controller Manager é…ç½®æ–‡ä»¶ä¸­æ–°å¢ â€“feature-gates&#x3D;ServiceNodeExclusion&#x3D;true å‚æ•°å¯ç”¨ ServiceNodeExclusion æ ‡è¯†ã€‚</p><h1 id="å®è·µæ“ä½œ"><a href="#å®è·µæ“ä½œ" class="headerlink" title="å®è·µæ“ä½œ"></a>å®è·µæ“ä½œ</h1><p>ä»¥ Tensile Kube Provider ä¸ºä¾‹ã€‚</p><p><strong>å‡†å¤‡å·¥ä½œ</strong></p><p>Tensile Kube Provider æ˜¯å°†å…¶ä»–çš„ Kubernetes é›†ç¾¤ä»¥è™šæ‹ŸèŠ‚ç‚¹çš„å½¢å¼åŠ å…¥åˆ°ä¸»é›†ç¾¤ï¼Œå› æ­¤éœ€è¦å‡†å¤‡ä¸¤ä¸ªé›†ç¾¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šå±‚é›†ç¾¤</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get node</span></span><br><span class="line">NAME           STATUS   ROLES                  AGE   VERSION</span><br><span class="line">desktop-ca83   Ready    control-plane,master   16d   v1.22.9</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åº•å±‚é›†ç¾¤</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get node</span></span><br><span class="line">NAME              STATUS   ROLES    AGE    VERSION</span><br><span class="line">archcnstcm67370   Ready    master   2d5h   v1.18.15</span><br><span class="line">archcnstcm67371   Ready    master   2d5h   v1.18.15</span><br><span class="line">archcnstcm67372   Ready    master   2d5h   v1.18.15</span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ virtual-node</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git <span class="built_in">clone</span> https://github.com/virtual-kubelet/tensile-kube.git</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> tensile-kube &amp;&amp; make</span></span><br></pre></td></tr></table></figure><p><strong>Provider éƒ¨ç½²</strong></p><p>Tensile Kube Provider è¿è¡Œåœ¨åº•å±‚é›†ç¾¤ä¸­ï¼Œå°†å…¶ä¸‰èŠ‚ç‚¹é›†ç¾¤ä»¥è™šæ‹ŸèŠ‚ç‚¹ vk-node åŠ å…¥åˆ°ä¸Šå±‚é›†ç¾¤ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åº•å±‚é›†ç¾¤å¯åŠ¨ Tensile Kube Providerï¼Œå…¶ä¸­ kubeconfig ä¸ºä¸Šå±‚é›†ç¾¤çš„é…ç½®æ–‡ä»¶ï¼Œclient-kubeconfig ä¸ºåº•å±‚é›†ç¾¤çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./virtual-node --nodename vk-node --kubeconfig ./config --client-kubeconfig /root/.kube/config</span></span><br><span class="line">I1124 16:47:19.501216 3727733 provider.go:158] Informer started</span><br><span class="line">I1124 16:47:19.902257 3727733 service_controller.go:114] Starting controller</span><br><span class="line">I1124 16:47:19.902298 3727733 common_controller.go:115] Starting controller</span><br><span class="line">I1124 16:47:19.902331 3727733 pv_controller.go:129] Starting controller</span><br><span class="line">ERRO[0000] TLS certificates not provided, not setting up pod http server  caPath= certPath= keyPath= node=vk-node operatingSystem=Linux provider=k8s watchedNamespace=</span><br><span class="line">INFO[0000] Initialized                                   node=vk-node operatingSystem=Linux provider=k8s watchedNamespace=</span><br><span class="line">I1124 16:47:19.902447 3727733 node.go:98] Called NotifyNodeStatus</span><br><span class="line">I1124 16:47:19.902455 3727733 pod.go:321] Called NotifyPods</span><br><span class="line">INFO[0000] Pod cache in-sync                             node=vk-node operatingSystem=Linux provider=k8s watchedNamespace=</span><br><span class="line">INFO[0000] starting workers                              node=vk-node operatingSystem=Linux provider=k8s watchedNamespace=</span><br><span class="line">INFO[0000] started workers                               node=vk-node operatingSystem=Linux provider=k8s watchedNamespace=</span><br><span class="line">I1124 16:47:20.607794 3727733 service_controller.go:144] enqueue service addkey istio-system/istio-ingressgateway</span><br><span class="line">I1124 16:47:20.607839 3727733 service_controller.go:144] enqueue service addkey istio-system/istiod</span><br><span class="line">I1124 16:47:20.607855 3727733 service_controller.go:144] enqueue service addkey velero/minio</span><br><span class="line">I1124 16:47:20.607803 3727733 service_controller.go:176] enqueue endpoint add key velero/minio</span><br><span class="line">I1124 16:47:20.607878 3727733 service_controller.go:176] enqueue endpoint add key istio-system/istio-ingressgateway</span><br><span class="line">I1124 16:47:20.607887 3727733 service_controller.go:176] enqueue endpoint add key istio-system/istiod</span><br><span class="line">I1124 16:47:20.702816 3727733 pv_controller.go:135] Sync caches from master successfully</span><br><span class="line">I1124 16:47:20.702859 3727733 pv_controller.go:140] Sync caches from client successfully</span><br><span class="line">I1124 16:47:20.702816 3727733 service_controller.go:120] Sync caches from master successfully</span><br><span class="line">I1124 16:47:20.702903 3727733 service_controller.go:125] Sync caches from client successfully</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šå±‚é›†ç¾¤</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get node</span></span><br><span class="line">NAME           STATUS   ROLES                  AGE   VERSION</span><br><span class="line">desktop-ca83   Ready    control-plane,master   16d   v1.22.9</span><br><span class="line">vk-node        Ready    agent                  9s    v1.18.15</span><br></pre></td></tr></table></figure><p>Provider å¯ä»¥éƒ¨ç½²åœ¨ä»»æ„é›†ç¾¤ä¸­ï¼Œé€šè¿‡ â€“kubeconfig å’Œ â€“client-kubeconfig æŒ‡å®šä¸Šå±‚åº•å±‚é›†ç¾¤å³å¯ï¼Œä¹Ÿå¯ä»¥ç»„æˆç½‘çŠ¶é›†ç¾¤æˆ–è€…å…¬ç”¨è™šæ‹ŸèŠ‚ç‚¹çš„é›†ç¾¤ã€‚</p><p><strong>è°ƒåº¦</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸Šå±‚é›†ç¾¤éƒ¨ç½²çš„è´Ÿè½½ä¿¡æ¯</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myconfigmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">vk-demo</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">USER_NAME:</span> <span class="string">YWRtaW4=</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vk-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">100Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/example</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">          <span class="attr">values:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">vk-node</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vk-demo</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Optional:</span></span><br><span class="line">  <span class="comment"># storageClassName: &lt;YOUR_STORAGE_CLASS_NAME&gt;</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">50Mi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vk-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">automountServiceAccountToken:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.27</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;tail -f /dev/null&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/bar&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/datadir</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">virtual-kubelet</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;virtual-kubelet.io/provider&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myconfigmap</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bar</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br><span class="line">      <span class="attr">optional:</span> <span class="literal">false</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">vk-demo</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº•å±‚é›†ç¾¤é¢„å…ˆå‡†å¤‡å¯ç”¨çš„å·</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vk-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">100Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/example</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">          <span class="attr">values:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">archcnstcm67370</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºè´Ÿè½½ä¹‹åå¯ä»¥çœ‹åˆ°ï¼ŒåŸæœ¬åœ¨ä¸Šå±‚çš„ configmapã€secret å’Œ pvcï¼Œé€ä¼ åˆ°å¯¹åº”çš„åº•å±‚é›†ç¾¤åˆ›å»ºäº†ä¸€ä»½</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åº•å±‚é›†ç¾¤</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get configmap</span></span><br><span class="line">NAME          DATA   AGE</span><br><span class="line">myconfigmap   1      15m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get secret</span></span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-jxhcg   kubernetes.io/service-account-token   3      2d7h</span><br><span class="line">mysecret              Opaque                                1      15m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pvc</span></span><br><span class="line">NAME                 STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS             AGE</span><br><span class="line">vk-demo              Bound    vk-demo  100Gi      RWO                                     16m</span><br></pre></td></tr></table></figure><p>è´Ÿè½½åœ¨ä¸Šå±‚é›†ç¾¤å’Œåº•å±‚é›†ç¾¤å‡å¯ä»¥æŸ¥è¯¢åˆ°ï¼Œä½†ç”±äºä¸¤ä¸ªé›†ç¾¤ Pod ç½‘ç»œæœªæ‰“é€šï¼Œå› æ­¤æ— æ³•é€šè¿‡ä¸Šå±‚é›†ç¾¤ exec æˆ–è€… log æŸ¥çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">I1124 17:52:59.931178 2460220 helper.go:57] pod vk-demo depends on secrets [mysecret]</span><br><span class="line">I1124 17:52:59.931202 2460220 helper.go:70] pod vk-demo depends on configMap [myconfigmap]</span><br><span class="line">I1124 17:52:59.931210 2460220 helper.go:83] pod vk-demo depends on pvc [vk-demo]</span><br><span class="line">I1124 17:52:59.936998 2460220 pod.go:457] Create myconfigmap in default success</span><br><span class="line">I1124 17:52:59.937019 2460220 pod.go:79] Create configmaps [myconfigmap] of default/vk-demo success</span><br><span class="line">INFO[0028] Created pod in provider                      </span><br><span class="line">INFO[0028] Event(v1.ObjectReference&#123;Kind:&quot;Pod&quot;, Namespace:&quot;default&quot;, Name:&quot;vk-demo&quot;, UID:&quot;1c52b390-29ab-40de-b892-860db9fe3418&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;3395567&quot;, FieldPath:&quot;&quot;&#125;): type: &#x27;Normal&#x27; reason: &#x27;ProviderCreateSuccess&#x27; Create pod in provider successfully  node=vk-node operatingSystem=Linux provider=k8s watchedNamespace=</span><br><span class="line">I1124 17:53:00.023488 2460220 pod.go:84] Create pvc [vk-demo] of default/vk-demo success</span><br><span class="line">INFO[0029] Updated pod in provider                      </span><br><span class="line">INFO[0029] Event(v1.ObjectReference&#123;Kind:&quot;Pod&quot;, Namespace:&quot;default&quot;, Name:&quot;vk-demo&quot;, UID:&quot;1c52b390-29ab-40de-b892-860db9fe3418&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;3395570&quot;, FieldPath:&quot;&quot;&#125;): type: &#x27;Normal&#x27; reason: &#x27;ProviderUpdateSuccess&#x27; Update pod in provider successfully  node=vk-node operatingSystem=Linux provider=k8s watchedNamespace=</span><br><span class="line">INFO[0042] Updated pod in provider                      </span><br><span class="line">INFO[0042] Event(v1.ObjectReference&#123;Kind:&quot;Pod&quot;, Namespace:&quot;default&quot;, Name:&quot;vk-demo&quot;, UID:&quot;1c52b390-29ab-40de-b892-860db9fe3418&quot;, APIVersion:&quot;v1&quot;, ResourceVersion:&quot;3395617&quot;, FieldPath:&quot;&quot;&#125;): type: &#x27;Normal&#x27; reason: &#x27;ProviderUpdateSuccess&#x27; Update pod in provider successfully  node=vk-node operatingSystem=Linux provider=k8s watchedNamespace=</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod -o wide</span></span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP           NODE      NOMINATED NODE   READINESS GATES</span><br><span class="line">vk-demo   1/1     Running   0          16m   10.244.0.1   vk-node   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod -o wide</span></span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE              NOMINATED NODE   READINESS GATES</span><br><span class="line">vk-demo   1/1     Running   0          17m   10.244.0.1    archcnstcm67370   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p><strong>æ€»ç»“</strong></p><p>Tensile Kube Provider</p><ul><li>åº•å±‚å¤šèŠ‚ç‚¹é›†ç¾¤æ˜¯ä»¥ä¸€ä¸ªå•ç‹¬çš„è™šæ‹ŸèŠ‚ç‚¹åŠ å…¥çš„ä¸Šå±‚é›†ç¾¤ä¸­</li><li>åœ¨ä¸Šå±‚é›†ç¾¤åˆ›å»ºçš„è´Ÿè½½ï¼Œä¼šé€šè¿‡ virtual-node ç»„ä»¶ä¸‹å‘åˆ°åº•å±‚é›†ç¾¤å¯¹åº”çš„ api-server ä¸­ï¼ˆå¯ä»¥æ”¯æŒ HAï¼‰ï¼Œä¼šæ ¹æ®åº•å±‚é›†ç¾¤çš„æƒ…å†µè¿›è¡Œå®é™…è°ƒåº¦</li><li>ç”±äºå·¥ä½œè´Ÿè½½çœŸå®è¿è¡Œåœ¨åº•å±‚é›†ç¾¤ä¸­ï¼Œå…¶ä¾èµ–çš„ Secretã€Configmap å’Œ PVC ç­‰èµ„æºåŒæ ·çš„ä¼šé€ä¼ ç»™åº•å±‚é›†ç¾¤åˆ›å»ºï¼Œå…¶è¿è¡Œæ—¶çš„èµ„æºç”±åº•å±‚é›†ç¾¤åˆ†é…å¹¶ç»´æŠ¤ï¼Œä¾‹å¦‚ Pod çš„ç½‘ç»œã€å­˜å‚¨ç­‰</li></ul>]]></content>
    
    
    <summary type="html">ä»¥ Tensile Kube Provider å®è·µæ“ä½œä¸ºä¾‹ï¼Œç†è§£ Virtual Kubelet çš„è®¾è®¡ç†å¿µã€Provider åŸè¯­ä»¥åŠå„å‚å•†çš„æ¢ç´¢å®ç°</summary>
    
    
    
    <category term="Serverless" scheme="http://shenxianghong.github.io/categories/Serverless/"/>
    
    
    <category term="Virtual Kubelet" scheme="http://shenxianghong.github.io/tags/Virtual-Kubelet/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æ¶æ„æ¼”è¿›</title>
    <link href="http://shenxianghong.github.io/2022/11/14/2022-11-14%20Kata%20Containers%20%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/"/>
    <id>http://shenxianghong.github.io/2022/11/14/2022-11-14%20Kata%20Containers%20%E6%9E%B6%E6%9E%84%E6%BC%94%E8%BF%9B/</id>
    <published>2022-11-13T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.267Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>åœ¨äº‘åŸç”Ÿåœºæ™¯ä¸­ï¼Œå¯¹å®¹å™¨å¯åŠ¨é€Ÿåº¦ã€èµ„æºæ¶ˆè€—ã€ç¨³å®šæ€§å’Œå®‰å…¨æ€§çš„éœ€æ±‚ä¸æ–­å¢åŠ ï¼Œç›®å‰ Kata Containers è¿è¡Œæ—¶ç›¸å¯¹äºå…¶ä»–è¿è¡Œæ—¶é¢ä¸´æŒ‘æˆ˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸€ç‚¹ï¼Œç¤¾åŒºæå‡ºäº†ä¸€ä¸ªå¯é çš„ã€ç»è¿‡ç°åœºæµ‹è¯•çš„ã€å®‰å…¨çš„ Rust ç‰ˆæœ¬çš„ kata-runtimeã€‚</p><h2 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h2><ul><li>Turn key solution with builtin <code>Dragonball</code> Sandbox</li><li>å¼‚æ­¥ I&#x2F;O ä»¥å‡å°‘èµ„æºæ¶ˆè€—</li><li>ç”¨äºå¤šç§æœåŠ¡ã€è¿è¡Œæ—¶å’Œ hypervisor çš„å¯æ‰©å±•æ¡†æ¶</li><li>sandbox å’Œå®¹å™¨ç›¸å…³è”èµ„æºçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</li></ul><h2 id="é€‰æ‹©-Rust-çš„ç†ç”±"><a href="#é€‰æ‹©-Rust-çš„ç†ç”±" class="headerlink" title="é€‰æ‹© Rust çš„ç†ç”±"></a>é€‰æ‹© Rust çš„ç†ç”±</h2><p>ä¹‹æ‰€ä»¥é€‰æ‹© Rustï¼Œæ˜¯å› ä¸ºå®ƒè¢«è®¾è®¡ä¸ºä¸€ç§æ³¨é‡æ•ˆç‡çš„ç³»ç»Ÿè¯­è¨€ã€‚ä¸ Go ç›¸æ¯”ï¼ŒRust è¿›è¡Œäº†å„ç§è®¾è®¡æƒè¡¡ä»¥è·å¾—è‰¯å¥½çš„æ‰§è¡Œæ€§èƒ½ï¼Œå…¶åˆ›æ–°æŠ€æœ¯ä¸ C æˆ– C++ ç›¸æ¯”ï¼Œæä¾›äº†é’ˆå¯¹å¸¸è§å†…å­˜é”™è¯¯ï¼ˆç¼“å†²åŒºæº¢å‡ºã€æ— æ•ˆæŒ‡é’ˆã€èŒƒå›´é”™è¯¯ï¼‰çš„åˆç†ä¿æŠ¤ã€é”™è¯¯æ£€æŸ¥ï¼ˆç¡®ä¿é”™è¯¯å¾—åˆ°å¤„ç†ï¼‰ã€çº¿ç¨‹å®‰å…¨ã€èµ„æºæ‰€æœ‰æƒç­‰ã€‚</p><p>å½“ Kata agent ç”¨ Rust é‡å†™æ—¶ï¼Œè¿™äº›ä¼˜ç‚¹å¾—åˆ°äº†éªŒè¯ã€‚åŸºäº Rust çš„å®ç°æ˜¾ç€å‡å°‘äº†å†…å­˜ä½¿ç”¨é‡ã€‚</p><h1 id="è®¾è®¡"><a href="#è®¾è®¡" class="headerlink" title="è®¾è®¡"></a>è®¾è®¡</h1><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><div align=center><img width="800" style="border: 0px" src="/gallery/kata-containers/architecture.png"></div><h2 id="å†…ç½®çš„-VMM"><a href="#å†…ç½®çš„-VMM" class="headerlink" title="å†…ç½®çš„ VMM"></a>å†…ç½®çš„ VMM</h2><h3 id="å½“å‰-Kata-2-x-æ¶æ„"><a href="#å½“å‰-Kata-2-x-æ¶æ„" class="headerlink" title="å½“å‰ Kata 2.x æ¶æ„"></a>å½“å‰ Kata 2.x æ¶æ„</h3><div align=center><img width="600" style="border: 0px" src="/gallery/kata-containers/not_built_in_vmm.png"></div><p>å¦‚å›¾æ‰€ç¤ºï¼Œruntime å’Œ VMM æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ã€‚runtime è¿›ç¨‹ fork å‡º VMM è¿›ç¨‹å¹¶é€šè¿‡ RPC è¿›ç¨‹é—´é€šä¿¡ã€‚é€šå¸¸ï¼Œè¿›ç¨‹é—´äº¤äº’æ¯”è¿›ç¨‹å†…äº¤äº’å¼€é”€æ›´å¤§ä¸”æ•ˆç‡æ›´ä½ã€‚åŒæ—¶ï¼Œè¿˜è¦è€ƒè™‘èµ„æºç»´æŠ¤æˆæœ¬ã€‚ä¾‹å¦‚ï¼Œåœ¨å¼‚å¸¸æƒ…å†µä¸‹è¿›è¡Œèµ„æºå›æ”¶æ—¶ï¼Œä»»ä½•è¿›ç¨‹çš„å¼‚å¸¸éƒ½å¿…é¡»è¢«å…¶ä»–ç»„ä»¶æ£€æµ‹åˆ°ï¼Œå¹¶è§¦å‘ç›¸åº”çš„èµ„æºå›æ”¶è¿›ç¨‹ã€‚å¦‚æœæœ‰é¢å¤–çš„è¿‡ç¨‹ï¼Œæ¢å¤å˜å¾—æ›´åŠ å›°éš¾ã€‚</p><h3 id="å¦‚ä½•æ”¯æŒå†…ç½®çš„-VMM"><a href="#å¦‚ä½•æ”¯æŒå†…ç½®çš„-VMM" class="headerlink" title="å¦‚ä½•æ”¯æŒå†…ç½®çš„ VMM"></a>å¦‚ä½•æ”¯æŒå†…ç½®çš„ VMM</h3><p>ç¤¾åŒºæä¾›äº† Dragonball Sandboxï¼Œé€šè¿‡å°† VMM çš„åŠŸèƒ½é›†æˆåˆ° Rust åº“ä¸­æ¥å¯ç”¨å†…ç½®çš„ VMMã€‚å¯ä»¥é€šè¿‡ä½¿ç”¨è¯¥åº“æ¥æ‰§è¡Œä¸ VMM ç›¸å…³çš„åŠŸèƒ½ã€‚å› ä¸º runtime å’Œ VMM åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæ‰€ä»¥åœ¨æ¶ˆæ¯å¤„ç†é€Ÿåº¦å’Œ API åŒæ­¥æ–¹é¢æœ‰æ‰€æ”¹å–„ã€‚è¿˜å¯ä»¥ä¿è¯ runtime å’Œ VMM ç”Ÿå‘½å‘¨æœŸçš„ä¸€è‡´æ€§ï¼Œå‡å°‘èµ„æºå›æ”¶å’Œå¼‚å¸¸å¤„ç†ç»´æŠ¤çš„å¤æ‚åº¦ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><div align=center><img width="600" style="border: 0px" src="/gallery/kata-containers/built_in_vmm.png"></div><h2 id="æ”¯æŒå¼‚æ­¥"><a href="#æ”¯æŒå¼‚æ­¥" class="headerlink" title="æ”¯æŒå¼‚æ­¥"></a>æ”¯æŒå¼‚æ­¥</h2><h3 id="ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥"><a href="#ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥"></a>ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥</h3><p><strong>Async å·²ç»ä¸ºç¨³å®šç‰ˆ Rust ç‰¹æ€§</strong></p><blockquote><p>å‚è€ƒï¼š<a href="https://rust-lang.github.io/async-book/01_getting_started/02_why_async.html">Why Async</a> å’Œ <a href="https://rust-lang.github.io/async-book/01_getting_started/03_state_of_async_rust.html">The State of Asynchronous Rust</a></p></blockquote><ul><li>Async æ˜¾è‘—é™ä½äº† CPU å’Œå†…å­˜å¼€é”€ï¼Œå°¤å…¶æ˜¯å¯¹äºå…·æœ‰å¤§é‡ I&#x2F;O ç»‘å®šç±»å‹çš„ä»»åŠ¡è´Ÿè½½</li><li>Async åœ¨ Rust ä¸­æ˜¯é›¶æˆæœ¬çš„ï¼Œè¿™æ„å‘³ç€åªéœ€åº”ç”¨å±‚é¢å¼€é”€ï¼Œå¯ä»¥ä¸ç”¨å †åˆ†é…å’ŒåŠ¨æ€è°ƒåº¦ï¼Œå¤§å¤§æé«˜æ•ˆç‡</li></ul><p><strong>å¦‚æœä½¿ç”¨ Sync Rust å®ç° kata-runtime å¯èƒ½ä¼šå‡ºç°çš„å‡ ä¸ªé—®é¢˜</strong></p><ul><li>TTRPC è¿æ¥çº¿ç¨‹æ•°å¤ªå¤šï¼ˆTTRPC threads: reaper thread(1) + listener thread(1) + client handler(2)ï¼‰</li><li>æ¯ä¸ªå®¹å™¨æœ‰ä¸‰ä¸ª I&#x2F;O çº¿ç¨‹</li><li>åœ¨ Sync æ¨¡å¼ä¸‹ï¼Œå®ç°è¶…æ—¶æœºåˆ¶å…·æœ‰æŒ‘æˆ˜æ€§ã€‚æ¯”å¦‚ TTRPC API äº¤äº’ä¸­ï¼Œè¶…æ—¶æœºåˆ¶å¾ˆéš¾å’Œ Golang å¯¹é½</li></ul><p><strong>å¦‚ä½•æ”¯æŒ Async</strong></p><p>kata-runtime ç”± TOKIO_RUNTIME_WORKER_THREADS æ§åˆ¶è¿è¡Œ OS çº¿ç¨‹ï¼Œé»˜è®¤ä¸º 2 ä¸ªçº¿ç¨‹ã€‚TTRPC å’Œå®¹å™¨ç›¸å…³çš„çº¿ç¨‹ç»Ÿä¸€è¿è¡Œåœ¨tokio çº¿ç¨‹ä¸­ï¼ŒTimerï¼ŒFileï¼ŒNetlink ç­‰ç›¸å…³çš„ä¾èµ–è°ƒç”¨éœ€è¦åˆ‡æ¢åˆ° Asyncã€‚å€ŸåŠ© Asyncï¼Œå¯ä»¥è½»æ¾æ”¯æŒæ— é˜»å¡ I&#x2F;O å’Œå®šæ—¶å™¨ã€‚ç›®å‰ï¼Œä»…å°† Async ç”¨äº kata-runtimeã€‚å†…ç½®çš„ VMM ä¿ç•™äº† OS çº¿ç¨‹ï¼Œå› ä¸ºå®ƒå¯ä»¥ä¿è¯çº¿ç¨‹çš„å¯æ§æ€§ã€‚</p><h2 id="å¯æ‰©å±•æ¡†æ¶"><a href="#å¯æ‰©å±•æ¡†æ¶" class="headerlink" title="å¯æ‰©å±•æ¡†æ¶"></a>å¯æ‰©å±•æ¡†æ¶</h2><p>Kata 3.x runtime è®¾è®¡äº† serviceã€runtimeã€hypervisor çš„æ‰©å±•ï¼Œç»“åˆé…ç½®æ»¡è¶³ä¸åŒåœºæ™¯çš„éœ€æ±‚ã€‚ç›®å‰æœåŠ¡æä¾›æ³¨å†Œæœºåˆ¶ï¼Œæ”¯æŒå¤šç§æœåŠ¡ã€‚æœåŠ¡å¯ä»¥é€šè¿‡æ¶ˆæ¯ä¸ runtime äº¤äº’ã€‚æ­¤å¤–ï¼Œruntime handler å¤„ç†æ¥è‡ªæœåŠ¡çš„æ¶ˆæ¯ã€‚ä¸ºäº†æ»¡è¶³äºŒè¿›åˆ¶æ”¯æŒå¤šä¸ª runtime å’Œ hypervisor çš„éœ€æ±‚ï¼Œå¯åŠ¨å¿…é¡»é€šè¿‡é…ç½®è·å– runtime handler ç±»å‹å’Œ hypervisor ç±»å‹ã€‚</p><div align=center><img width="800" style="border: 0px" src="/gallery/kata-containers/framework.png"></div><h2 id="èµ„æºç®¡ç†å™¨"><a href="#èµ„æºç®¡ç†å™¨" class="headerlink" title="èµ„æºç®¡ç†å™¨"></a>èµ„æºç®¡ç†å™¨</h2><p>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œä¼šæœ‰å„ç§å„æ ·çš„èµ„æºï¼Œæ¯ä¸ªèµ„æºéƒ½æœ‰å‡ ä¸ªå­ç±»å‹ã€‚ç‰¹åˆ«æ˜¯å¯¹äº virtcontainersï¼Œèµ„æºçš„æ¯ä¸ªå­ç±»å‹éƒ½æœ‰ä¸åŒçš„æ“ä½œã€‚å¹¶ä¸”å¯èƒ½å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œä¾‹å¦‚ share-fs rootfs å’Œ share-fs volume ä¼šä½¿ç”¨ share-fs èµ„æºå°†æ–‡ä»¶å…±äº«åˆ° VMã€‚ç›®å‰ï¼Œnetworkã€share-fs è¢«è§†ä¸ºæ²™ç›’èµ„æºï¼Œrootfsã€volumeã€cgroup è¢«è§†ä¸ºå®¹å™¨èµ„æºã€‚æ­¤å¤–ï¼Œç¤¾åŒºä¸ºæ¯ä¸ªèµ„æºæŠ½è±¡å‡ºä¸€ä¸ªå…¬å…±æ¥å£ï¼Œå¹¶ä½¿ç”¨å­ç±»æ“ä½œæ¥è¯„ä¼°ä¸åŒå­ç±»å‹ä¹‹é—´çš„å·®å¼‚ã€‚</p><div align=center><img width="800" style="border: 0px" src="/gallery/kata-containers/resourceManager.png"></div><h1 id="è·¯çº¿å›¾"><a href="#è·¯çº¿å›¾" class="headerlink" title="è·¯çº¿å›¾"></a>è·¯çº¿å›¾</h1><ul><li>é˜¶æ®µ 1ï¼ˆæˆªè‡³ 2022.06ï¼‰ï¼šæä¾›åŸºç¡€ç‰¹æ€§</li><li>é˜¶æ®µ 2ï¼ˆæˆªè‡³ 2022.09ï¼‰ï¼šæä¾›å¸¸ç”¨ç‰¹æ€§</li><li>é˜¶æ®µ 3ï¼šæä¾›å…¨é‡ç‰¹æ€§</li></ul><table><thead><tr><th><strong>Class</strong></th><th><strong>Sub-Class</strong></th><th><strong>Development Stage</strong></th><th><strong>Status</strong></th></tr></thead><tbody><tr><td>Service</td><td>task service</td><td>Stage 1</td><td>âœ…</td></tr><tr><td></td><td>extend service</td><td>Stage 3</td><td>ğŸš«</td></tr><tr><td></td><td>image service</td><td>Stage 3</td><td>ğŸš«</td></tr><tr><td>Runtime handler</td><td>Virt-Container</td><td>Stage 1</td><td>âœ…</td></tr><tr><td>Endpoint</td><td>VETH Endpoint</td><td>Stage 1</td><td>âœ…</td></tr><tr><td></td><td>Physical Endpoint</td><td>Stage 2</td><td>âœ…</td></tr><tr><td></td><td>Tap Endpoint</td><td>Stage 2</td><td>âœ…</td></tr><tr><td></td><td>Tuntap Endpoint</td><td>Stage 2</td><td>âœ…</td></tr><tr><td></td><td>IPVlan Endpoint</td><td>Stage 2</td><td>âœ…</td></tr><tr><td></td><td>MacVlan Endpoint</td><td>Stage 2</td><td>âœ…</td></tr><tr><td></td><td>MACVTAP Endpoint</td><td>Stage 3</td><td>ğŸš«</td></tr><tr><td></td><td>VhostUserEndpoint</td><td>Stage 3</td><td>ğŸš«</td></tr><tr><td>Network Interworking Model</td><td>Tc filter</td><td>Stage 1</td><td>âœ…</td></tr><tr><td></td><td>MacVtap</td><td>Stage 3</td><td>ğŸš§</td></tr><tr><td>Storage</td><td>Virtio-fs</td><td>Stage 1</td><td>âœ…</td></tr><tr><td></td><td>nydus</td><td>Stage 2</td><td>ğŸš§</td></tr><tr><td></td><td>device mapper</td><td>Stage 2</td><td>ğŸš«</td></tr><tr><td>Cgroup V2</td><td></td><td>Stage 2</td><td>ğŸš§</td></tr><tr><td>Hypervisor</td><td>Dragonball</td><td>Stage 1</td><td>ğŸš§</td></tr><tr><td></td><td>QEMU</td><td>Stage 2</td><td>ğŸš«</td></tr><tr><td></td><td>ACRN</td><td>Stage 3</td><td>ğŸš«</td></tr><tr><td></td><td>Cloud Hypervisor</td><td>Stage 3</td><td>ğŸš«</td></tr><tr><td></td><td>Firecracker</td><td>Stage 3</td><td>ğŸš«</td></tr></tbody></table><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><ul><li><p>serviceã€message dispatcher å’Œ runtime handler éƒ½æ˜¯ Kata 3.x runtime äºŒè¿›åˆ¶çš„ä¸€éƒ¨åˆ†å—ï¼Ÿ</p><p>æ˜¯çš„ã€‚å®ƒä»¬æ˜¯ Kata 3.x è¿è¡Œæ—¶ä¸­çš„ç»„ä»¶ã€‚å®ƒä»¬å°†è¢«æ‰“åŒ…æˆä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶</p><ul><li>service æ˜¯ä¸€ä¸ªæ¥å£ï¼Œè´Ÿè´£å¤„ç†ä»»åŠ¡æœåŠ¡ã€é•œåƒæœåŠ¡ç­‰å¤šç§æœåŠ¡</li><li>message dispatcher ç”¨äºåŒ¹é…æ¥è‡ªæœåŠ¡æ¨¡å—çš„å¤šä¸ªè¯·æ±‚</li><li>runtime handler ç”¨äºå¤„ç†å¯¹æ²™ç®±å’Œå®¹å™¨çš„æ“ä½œ</li></ul></li><li><p>Kata 3.x runtime äºŒè¿›åˆ¶çš„åç§°æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>ç”±äº containerd-shim-v2-kata å·²ç»è¢«ä½¿ç”¨äº†ï¼Œç›®å‰åœ¨å†…éƒ¨ï¼Œç¤¾åŒºä½¿ç”¨ containerd-shim-v2-rund</p></li><li><p>Kata 3.x è®¾è®¡æ˜¯å¦ä¸ containerd shimv2 æ¶æ„å…¼å®¹ï¼Ÿ</p><p>æ˜¯çš„ã€‚å®ƒæ—¨åœ¨éµå¾ª go ç‰ˆæœ¬ kata çš„åŠŸèƒ½ã€‚å®ƒå®ç°äº† containerd shim v2 æ¥å£&#x2F;åè®®</p></li><li><p>ç”¨æˆ·å°†å¦‚ä½•è¿ç§»åˆ° Kata 3.x æ¶æ„ï¼Ÿ</p><p>è¿ç§»è®¡åˆ’å°†åœ¨ Kata 3.x åˆå¹¶åˆ°ä¸»åˆ†æ”¯ä¹‹å‰æä¾›</p></li><li><p>Dragonball æ˜¯ä¸æ˜¯ä»…é™äºè‡ªå·±å†…ç½®çš„ VMMï¼Ÿ Dragonball ç³»ç»Ÿæ˜¯å¦å¯ä»¥é…ç½®ä¸ºä½¿ç”¨å¤–éƒ¨ Dragonball VMM&#x2F;hypervisor å·¥ä½œï¼Ÿ</p><p>Dragonball å¯ä»¥ç”¨ä½œå¤–éƒ¨ç®¡ç†ç¨‹åºã€‚ç„¶è€Œï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¨³å®šæ€§å’Œæ€§èƒ½å…·æœ‰æŒ‘æˆ˜æ€§ã€‚å†…ç½® VMM å¯ä»¥ä¼˜åŒ–å®¹å™¨å¼€é”€ï¼Œæ˜“äºç»´æŠ¤ç¨³å®šæ€§ã€‚runD æ˜¯ runC çš„ containerd-shim-v2 å¯¹åº”ç‰©ï¼Œå¯ä»¥è¿è¡Œ Pod&#x2F;å®¹å™¨ã€‚ Dragonball æ˜¯ä¸€ç§ microvm&#x2F;VMMï¼Œæ—¨åœ¨è¿è¡Œå®¹å™¨å·¥ä½œè´Ÿè½½ã€‚æœ‰æ—¶å°†å…¶ç§°ä¸ºå®‰å…¨æ²™ç®±ï¼Œè€Œä¸æ˜¯ microvm&#x2F;VMM</p></li><li><p>QEMUã€Cloud Hypervisor å’Œ Firecracker æ”¯æŒå·²åœ¨è®¡åˆ’ä¸­ï¼Œä½†å¦‚ä½•è¿ä½œã€‚å®ƒä»¬åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­å·¥ä½œå—ï¼Ÿ</p><p>æ˜¯çš„ã€‚å®ƒä»¬æ— æ³•åƒ VMM ä¸­å†…ç½®çš„é‚£æ ·å·¥ä½œ</p></li><li><p>upcall æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>upcall ç”¨äºçƒ­æ’æ‹” CPU&#x2F;å†…å­˜&#x2F;MMIO è®¾å¤‡ï¼Œå®ƒè§£å†³äº†ä¸¤ä¸ªé—®é¢˜ï¼š</p><ul><li><p>é¿å…ä¾èµ– PCI&#x2F;ACPI</p></li><li><p>é¿å…åœ¨ guest ä¸­ä¾èµ– udevd å¹¶è·å¾—çƒ­æ’æ‹”æ“ä½œçš„ç¡®å®šæ€§ç»“æœã€‚æ‰€ä»¥ upcall æ˜¯åŸºäº ACPI çš„ CPU&#x2F;å†…å­˜&#x2F;è®¾å¤‡çƒ­æ’æ‹”çš„æ›¿ä»£æ–¹æ¡ˆã€‚å¦‚æœéœ€è¦ï¼ŒKata ç¤¾åŒºä¼šä¸ç›¸å…³ç¤¾åŒºåˆä½œæ·»åŠ å¯¹åŸºäº ACPI çš„ CPU&#x2F;å†…å­˜&#x2F;è®¾å¤‡çƒ­æ’æ‹”çš„æ”¯æŒ</p></li></ul><p>Dbs-upcall æ˜¯ VMM å’Œ guest ä¹‹é—´åŸºäº vsock çš„ç›´æ¥é€šä¿¡å·¥å…·ã€‚ upcall çš„æœåŠ¡å™¨ç«¯æ˜¯ guest å†…æ ¸ä¸­çš„é©±åŠ¨ç¨‹åºï¼ˆæ­¤åŠŸèƒ½éœ€è¦å†…æ ¸è¡¥ä¸ï¼‰ï¼Œä¸€æ—¦å†…æ ¸å¯åŠ¨ï¼Œå®ƒå°†å¼€å§‹ä¸ºè¯·æ±‚æä¾›æœåŠ¡ã€‚è€Œå®¢æˆ·ç«¯åœ¨ VMM ä¸­ï¼Œå®ƒå°†æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œé€šè¿‡ uds ä¸ VSOCK é€šä¿¡ã€‚é€šè¿‡upcall ç›´æ¥å®ç°äº†è®¾å¤‡çš„çƒ­æ’æ‹”ï¼Œé¿å…äº†ACPI çš„è™šæ‹ŸåŒ–ï¼Œå°†è™šæ‹Ÿæœºçš„å¼€é”€é™åˆ°æœ€ä½ã€‚é€šè¿‡è¿™ç§ç›´æ¥çš„é€šä¿¡æ‰‹æ®µï¼Œå¯èƒ½è¿˜æœ‰è®¸å¤šå…¶ä»–ç”¨é€”ã€‚ç°ç›®å‰å·²ç»å¼€æºï¼š<a href="https://github.com/openanolis/dragonball-sandbox/tree/main/crates/dbs-upcall">https://github.com/openanolis/dragonball-sandbox/tree/main/crates/dbs-upcall</a></p></li><li><p>å†…æ ¸è¡¥ä¸é€‚ç”¨äº 4.19ï¼Œä½†å®ƒä»¬ä¹Ÿé€‚ç”¨äº 5.15+ å—ï¼Ÿ</p><p>å‘å‰å…¼å®¹åº”è¯¥æ˜¯å¯ä»¥å®ç°çš„ï¼Œç¤¾åŒºå·²ç»å°†å®ƒç§»æ¤åˆ°åŸºäº 5.10 çš„å†…æ ¸</p></li><li><p>è¿™äº›è¡¥ä¸æ˜¯å¦ç‰¹å®šäºå¹³å°ï¼Œæˆ–è€…å®ƒä»¬æ˜¯å¦é€‚ç”¨äºæ”¯æŒ VSOCK çš„ä»»ä½•æ¶æ„ï¼Ÿ</p><p>å®ƒå‡ ä¹ä¸å¹³å°æ— å…³ï¼Œä½†ä¸€äº›ä¸ CPU çƒ­æ’æ‹”ç›¸å…³çš„æ˜¯ä¸å¹³å°ç›¸å…³çš„</p></li><li><p>æ˜¯å¦å¯ä»¥ä½¿ç”¨ loopback VSOCK å°†å†…æ ¸é©±åŠ¨ç¨‹åºæ›¿æ¢ä¸º guest ä¸­çš„ç”¨æˆ·æ€å®ˆæŠ¤ç¨‹åºï¼Ÿ</p><p>éœ€è¦ä¸ºçƒ­æ·»åŠ çš„ CPU&#x2F;å†…å­˜&#x2F;è®¾å¤‡åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œå› æ­¤ç”¨æˆ·ç©ºé—´å®ˆæŠ¤è¿›ç¨‹æ‰§è¡Œè¿™äº›ä»»åŠ¡å¹¶ä¸å®¹æ˜“</p></li><li><p>upcall å…è®¸ VMM å’Œ guest ä¹‹é—´è¿›è¡Œé€šä¿¡çš„äº‹å®è¡¨æ˜ï¼Œæ­¤æ¶æ„å¯èƒ½ä¸ <a href="https://github.com/confidential-containers">https://github.com/confidential-containers</a> ä¸å…¼å®¹ï¼Œå…¶ä¸­ VMM åº”è¯¥ä¸çŸ¥é“ VM å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…</p><ul><li>TDX è¿˜ä¸æ”¯æŒ CPU&#x2F;å†…å­˜çƒ­æ’æ‹”</li><li>å¯¹äºåŸºäº ACPI çš„è®¾å¤‡çƒ­æ’æ‹”ï¼Œå®ƒä¾èµ–äº ACPI DSDT è¡¨ï¼Œguest å†…æ ¸å°†åœ¨å¤„ç†è¿™äº›çƒ­æ’æ‹”äº‹ä»¶æ—¶æ‰§è¡Œ ASL ä»£ç æ¥å¤„ç†ã€‚ä¸ ACPI ASL æ–¹æ³•ç›¸æ¯”ï¼Œå®¡è®¡åŸºäº VSOCK çš„é€šä¿¡åº”è¯¥æ›´å®¹æ˜“</li></ul></li><li><p>å•ä½“ä¸å†…ç½® VMM çš„å®‰å…¨è¾¹ç•Œæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>å®ƒå…·æœ‰è™šæ‹ŸåŒ–çš„å®‰å…¨è¾¹ç•Œã€‚æ›´å¤šç»†èŠ‚å°†åœ¨ä¸‹ä¸€é˜¶æ®µæä¾›</p></li></ul>]]></content>
    
    
    <summary type="html">Kata Containers 3.x è¾ƒ 2.x ç‰ˆæœ¬æ¶æ„å‘å±•æ¼”è¿›ä¸è®¾è®¡åˆè¡·</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€ä¸­å›½ç§»åŠ¨åˆ†äº«</title>
    <link href="http://shenxianghong.github.io/2022/10/27/2022-10-27%20Kata%20Containers%20%E4%B8%AD%E5%9B%BD%E7%A7%BB%E5%8A%A8%E5%88%86%E4%BA%AB/"/>
    <id>http://shenxianghong.github.io/2022/10/27/2022-10-27%20Kata%20Containers%20%E4%B8%AD%E5%9B%BD%E7%A7%BB%E5%8A%A8%E5%88%86%E4%BA%AB/</id>
    <published>2022-10-26T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.266Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p><a href="/reference/kata-containers-chinamobile.pdf">Kata Containers Performance Exploration and Practice</a></p></blockquote>]]></content>
    
    
    <summary type="html">Kata Containers æ€§èƒ½è°ƒä¼˜æ¢ç´¢ä¸å®è·µ</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€èš‚èšé‡‘æœåˆ†äº«</title>
    <link href="http://shenxianghong.github.io/2022/10/14/2022-10-14%20Kata%20Containers%20%E8%9A%82%E8%9A%81%E9%87%91%E6%9C%8D%E5%88%86%E4%BA%AB/"/>
    <id>http://shenxianghong.github.io/2022/10/14/2022-10-14%20Kata%20Containers%20%E8%9A%82%E8%9A%81%E9%87%91%E6%9C%8D%E5%88%86%E4%BA%AB/</id>
    <published>2022-10-13T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.266Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p><a href="/reference/kata-containers-antgroup.pdf">Kata Containers Best Practicesâ€¨ at Ant Group</a></p></blockquote>]]></content>
    
    
    <summary type="html">Kata Containers åœ¨èš‚èšé‡‘æœçš„æœ€ä½³å®è·µ</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” Sidecar</title>
    <link href="http://shenxianghong.github.io/2022/09/16/2022-09-16%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Sidecar/"/>
    <id>http://shenxianghong.github.io/2022/09/16/2022-09-16%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Sidecar/</id>
    <published>2022-09-15T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.258Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>Sidecar æè¿°äº† sidecar ä»£ç†çš„é…ç½®ï¼Œè¯¥ä»£ç†å°†å…¥ç«™å’Œå‡ºç«™é€šä¿¡è°ƒè§£åˆ°å®ƒæ‰€è¿æ¥çš„å·¥ä½œè´Ÿè½½å®ä¾‹ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio å°†å¯¹ç½‘æ ¼ä¸­çš„æ‰€æœ‰ä»£ç†è¿›è¡Œç¼–ç¨‹ï¼Œå¹¶ä½¿ç”¨å¿…è¦çš„é…ç½®æ¥è®¿é—®ç½‘æ ¼ä¸­çš„æ¯ä¸ªå·¥ä½œè´Ÿè½½å®ä¾‹ï¼Œå¹¶æ¥ç®¡ä¸å·¥ä½œè´Ÿè½½å…³è”çš„æ‰€æœ‰ç«¯å£ä¸Šçš„æµé‡ã€‚ Sidecar é…ç½®æä¾›äº†ä¸€ç§å¾®è°ƒç«¯å£é›†çš„æ–¹æ³•ï¼Œä»£ç†åœ¨è½¬å‘æµé‡è¿›å‡ºå·¥ä½œè´Ÿè½½æ—¶å°†æ¥å—çš„åè®®ã€‚æ­¤å¤–ï¼Œå¯ä»¥é™åˆ¶ä»£ç†åœ¨è½¬å‘æ¥è‡ªå·¥ä½œè´Ÿè½½å®ä¾‹çš„å‡ºç«™æµé‡æ—¶å¯ä»¥è®¿é—®çš„æœåŠ¡é›†ã€‚</p><p>ç½‘æ ¼ä¸­çš„æœåŠ¡å’Œé…ç½®è¢«åˆ’åˆ†æˆä¸€ä¸ªæˆ–å¤šä¸ªå‘½åç©ºé—´ï¼ˆä¾‹å¦‚ï¼ŒKubernetes å‘½åç©ºé—´æˆ– CF org&#x2F;spaceï¼‰ã€‚å‘½åç©ºé—´ä¸­çš„ Sidecar é…ç½®å°†åº”ç”¨äºåŒä¸€å‘½åç©ºé—´ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œè´Ÿè½½å®ä¾‹ï¼Œä½¿ç”¨ workloadSelector å­—æ®µé€‰æ‹©ã€‚åœ¨æ²¡æœ‰ workloadSelector çš„æƒ…å†µä¸‹ï¼Œå®ƒå°†åº”ç”¨äºåŒä¸€å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½å®ä¾‹ã€‚åœ¨ç¡®å®šè¦åº”ç”¨äºå·¥ä½œè´Ÿè½½å®ä¾‹çš„ Sidecar é…ç½®æ—¶ï¼Œå°†ä¼˜å…ˆè€ƒè™‘å…·æœ‰é€‰æ‹©æ­¤å·¥ä½œè´Ÿè½½å®ä¾‹çš„ workloadSelector çš„èµ„æºï¼Œè€Œä¸æ˜¯æ²¡æœ‰ä»»ä½• workloadSelector çš„ Sidecar é…ç½®ã€‚</p><p>æ³¨æ„ç‚¹</p><ul><li>æ¯ä¸ªå‘½åç©ºé—´åªèƒ½æœ‰ä¸€ä¸ªæ²¡æœ‰ workloadSelector çš„  Sidecar é…ç½®ï¼Œè¯¥é…ç½®ä¸ºè¯¥å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰ Pod æŒ‡å®šé»˜è®¤å€¼ã€‚å»ºè®®å¯¹å‘½åç©ºé—´èŒƒå›´çš„ sidecar ä½¿ç”¨åç§° defaultã€‚å¦‚æœç»™å®šå‘½åç©ºé—´ä¸­å­˜åœ¨å¤šä¸ªæ— é€‰æ‹©å™¨çš„ Sidecar é…ç½®ï¼Œåˆ™ç³»ç»Ÿçš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚å¦‚æœå…·æœ‰ workloadSelector çš„ä¸¤ä¸ªæˆ–å¤šä¸ª Sidecar é…ç½®é€‰æ‹©ç›¸åŒçš„å·¥ä½œè´Ÿè½½å®ä¾‹ï¼Œåˆ™ç³»ç»Ÿçš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒMeshConfig æ ¹å‘½åç©ºé—´ä¸­çš„ Sidecar é…ç½®å°†åº”ç”¨äºæ‰€æœ‰æ²¡æœ‰ Sidecar é…ç½®çš„å‘½åç©ºé—´ã€‚è¿™ä¸ªå…¨å±€é»˜è®¤ Sidecar é…ç½®ä¸åº”è¯¥æœ‰ä»»ä½• workloadSelector</li></ul><p>ä¸‹é¢çš„ç¤ºä¾‹åœ¨åä¸º istio-config çš„å‘½åç©ºé—´ä¸­å£°æ˜äº†ä¸€ä¸ªå…¨å±€é»˜è®¤ Sidecar é…ç½®ï¼Œè¯¥é…ç½®å°†æ‰€æœ‰å‘½åç©ºé—´ä¸­çš„ Sidecar é…ç½®ä¸ºä»…å…è®¸å‡ºå£æµé‡åˆ°åŒä¸€å‘½åç©ºé—´ä¸­çš„å…¶ä»–å·¥ä½œè´Ÿè½½ä»¥åŠ istio-system å‘½åç©ºé—´ä¸­çš„æœåŠ¡ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Sidecar</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-config</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;./*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;istio-system/*&quot;</span></span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ç¤ºä¾‹åœ¨ prod-us1 å‘½åç©ºé—´ä¸­å£°æ˜äº†ä¸€ä¸ª Sidecar é…ç½®ï¼Œå®ƒè¦†ç›–äº†ä¸Šé¢å®šä¹‰çš„å…¨å±€é»˜è®¤å€¼ï¼Œå¹¶åœ¨å‘½åç©ºé—´ä¸­é…ç½®äº† Sidecar ä»¥å…è®¸å‡ºå£æµé‡åˆ° prod-us1ã€prod-apis å’Œ istio-system ä¸­çš„å‘½åç©ºé—´ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Sidecar</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod-us1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;prod-us1/*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;prod-apis/*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;istio-system/*&quot;</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹åœ¨ prod-us1 å‘½åç©ºé—´ä¸­ä¸ºæ‰€æœ‰å¸¦æœ‰æ ‡ç­¾ app: rating çš„ Pod å£°æ˜äº† Sidecar é…ç½®ï¼Œå±äº rating.prod-us1 æœåŠ¡ã€‚å·¥ä½œè´Ÿè½½åœ¨ç«¯å£ 9080 ä¸Šæ¥å—å…¥ç«™ HTTP æµé‡ã€‚ç„¶åå°†æµé‡è½¬å‘åˆ°åœ¨ Unix åŸŸå¥—æ¥å­—ä¸Šä¾¦å¬çš„é™„åŠ å·¥ä½œè´Ÿè½½å®ä¾‹ã€‚åœ¨å‡ºå£æ–¹å‘ï¼Œé™¤äº† istio-system å‘½åç©ºé—´ï¼ŒSidecar ä»…ä»£ç† prod-us1 å‘½åç©ºé—´ä¸­æœåŠ¡çš„ 9080 ç«¯å£çš„ HTTP æµé‡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Sidecar</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod-us1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ratings</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">somename</span></span><br><span class="line">    <span class="attr">defaultEndpoint:</span> <span class="string">unix:///var/run/someuds.sock</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">egresshttp</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;prod-us1/*&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;istio-system/*&quot;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨æ²¡æœ‰åŸºäº IPTables çš„æµé‡æ•è·çš„æƒ…å†µä¸‹éƒ¨ç½²å·¥ä½œè´Ÿè½½ï¼Œåˆ™ Sidecar é…ç½®æ˜¯è¿æ¥åˆ°å·¥ä½œè´Ÿè½½å®ä¾‹çš„ä»£ç†ä¸Šçš„ç«¯å£çš„å”¯ä¸€æ–¹æ³•ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹åœ¨ prod-us1 å‘½åç©ºé—´ä¸­ä¸ºæ‰€æœ‰å¸¦æœ‰ app: productpage æ ‡ç­¾çš„ Pod å£°æ˜äº† Sidecar é…ç½®ï¼Œå±äº productpage.prod-us1 æœåŠ¡ã€‚å‡è®¾è¿™äº› Pod éƒ¨ç½²æ—¶æ²¡æœ‰ IPtable è§„åˆ™ï¼ˆå³ istio-init å®¹å™¨ï¼‰å¹¶ä¸”ä»£ç†ä¸­ metadata çš„ ISTIO_META_INTERCEPTION_MODE è®¾ç½®ä¸º NONEï¼Œä¸‹é¢çš„è§„èŒƒå…è®¸è¿™äº› Pod åœ¨ç«¯å£ 9080 ä¸Šæ¥æ”¶ HTTP æµé‡ï¼ˆåŒ…è£¹åœ¨ Istio åŒå‘ TLS ä¸­ï¼‰å’Œå°†å…¶è½¬å‘åˆ°ç›‘å¬ 127.0.0.1:8080 çš„åº”ç”¨ç¨‹åºã€‚å®ƒè¿˜å…è®¸åº”ç”¨ç¨‹åºä¸ 127.0.0.1:3306 ä¸Šçš„æ”¯æŒ MySQL æ•°æ®åº“é€šä¿¡ï¼Œç„¶åå°†å…¶ä»£ç†åˆ° mysql.foo.com:3306 ä¸Šçš„å¤–éƒ¨æ‰˜ç®¡ MySQL æœåŠ¡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Sidecar</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="literal">no</span><span class="string">-ip-tables</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod-us1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">productpage</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">9080</span> <span class="comment"># binds to proxy_instance_ip:9080 (0.0.0.0:9080, if no unicast IP is available for the instance)</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">somename</span></span><br><span class="line">    <span class="attr">defaultEndpoint:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">captureMode:</span> <span class="string">NONE</span> <span class="comment"># not needed if metadata is set for entire proxy</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">MYSQL</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">egressmysql</span></span><br><span class="line">    <span class="attr">captureMode:</span> <span class="string">NONE</span> <span class="comment"># not needed if metadata is set for entire proxy</span></span><br><span class="line">    <span class="attr">bind:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*/mysql.foo.com&quot;</span></span><br></pre></td></tr></table></figure><p>ä»¥åŠç”¨äºè·¯ç”±åˆ° mysql.foo.com:3306 çš„å…³è” ServiceEntryï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-mysql</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mysql.foo.com</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">MYSQL</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥åœ¨å•ä¸ªä»£ç†ä¸­æ··åˆå’ŒåŒ¹é…æµé‡æ•è·æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘å†…éƒ¨æœåŠ¡ä½äº 192.168.0.0&#x2F;16 å­ç½‘ä¸Šçš„è®¾ç½®ã€‚å› æ­¤ï¼Œåœ¨ VM ä¸Šè®¾ç½® IP è¡¨ä»¥æ•è· 192.168.0.0&#x2F;16 å­ç½‘ä¸Šçš„æ‰€æœ‰å‡ºç«™æµé‡ã€‚å‡è®¾ VM åœ¨ 172.16.0.0&#x2F;16 å­ç½‘ä¸Šæœ‰ä¸€ä¸ªé¢å¤–çš„ç½‘ç»œæ¥å£ç”¨äºå…¥ç«™æµé‡ã€‚ä»¥ä¸‹ Sidecar é…ç½®å…è®¸ VM åœ¨ 172.16.1.32:80ï¼ˆVM çš„ IPï¼‰ä¸Šå…¬å¼€ä¸€ä¸ªä¾¦å¬å™¨ï¼Œä»¥æ¥æ”¶æ¥è‡ª 172.16.0.0&#x2F;16 å­ç½‘çš„æµé‡ã€‚</p><p>æ³¨æ„ï¼šVM ä¸­ä»£ç†ä¸Šçš„ ISTIO_META_INTERCEPTION_MODE å…ƒæ•°æ®å¯é€‰å€¼æœ‰ REDIRECT æˆ– TPROXYï¼Œè¿™æ„å‘³ç€å½“å‰æ˜¯åŸºäº IP è¡¨çš„æµé‡æ•è·ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Sidecar</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">partial-ip-tables</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod-us1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">productpage</span></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">bind:</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.32</span></span><br><span class="line">    <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span> <span class="comment"># binds to 172.16.1.32:80</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">somename</span></span><br><span class="line">    <span class="attr">defaultEndpoint:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">captureMode:</span> <span class="string">NONE</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">    <span class="comment"># use the system detected defaults</span></span><br><span class="line">    <span class="comment"># sets up configuration to handle outbound traffic to services</span></span><br><span class="line">    <span class="comment"># in 192.168.0.0/16 subnet, based on information provided by the</span></span><br><span class="line">    <span class="comment"># service registry</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">captureMode:</span> <span class="string">IPTABLES</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*/*&quot;</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹åœ¨ prod-us1 å‘½åç©ºé—´ä¸­ä¸ºæ‰€æœ‰å¸¦æœ‰æ ‡ç­¾ app: rating çš„ Pod å£°æ˜äº† Sidecar é…ç½®ï¼Œå±äº rating.prod-us1 æœåŠ¡ã€‚è¯¥æœåŠ¡åœ¨ç«¯å£ 8443 ä¸Šæ¥å—å…¥ç«™ HTTPS æµé‡ï¼Œå¹¶ä¸” sidecar ä»£ç†ä½¿ç”¨ç»™å®šçš„æœåŠ¡å™¨è¯ä¹¦ä»¥ä¸€ç§æ–¹å¼ç»ˆæ­¢ TLSã€‚ç„¶åå°†æµé‡è½¬å‘åˆ°åœ¨ Unix åŸŸå¥—æ¥å­—ä¸Šä¾¦å¬çš„é™„åŠ å·¥ä½œè´Ÿè½½å®ä¾‹ã€‚é¢„è®¡å°†é…ç½® PeerAuthentication ç­–ç•¥ï¼Œä»¥ä¾¿åœ¨ç‰¹å®šç«¯å£ä¸Šå°† mTLS æ¨¡å¼è®¾ç½®ä¸ºâ€œç¦ç”¨â€ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œåœ¨ PORT 80 ä¸Šç¦ç”¨äº† mTLS æ¨¡å¼ã€‚æ­¤åŠŸèƒ½ç›®å‰æ˜¯å®éªŒæ€§çš„ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PeerAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-peer-auth</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod-us1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ratings</span></span><br><span class="line">  <span class="attr">mtls:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">STRICT</span></span><br><span class="line">  <span class="attr">portLevelMtls:</span></span><br><span class="line">    <span class="attr">80:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br></pre></td></tr></table></figure><h1 id="Sidecar"><a href="#Sidecar" class="headerlink" title="Sidecar"></a>Sidecar</h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#WorkloadSelector">workloadSelector</a></td><td>ç”¨äºé€‰æ‹©åº”ç”¨æ­¤ Sidecar é…ç½®çš„ç‰¹å®š Pod&#x2F;VM é›†çš„æ ‡å‡†ã€‚å¦‚æœçœç•¥ï¼ŒSidecar é…ç½®å°†åº”ç”¨äºåŒä¸€å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½å®ä¾‹</td></tr><tr><td><a href="#IstioIngressListener">ingress</a></td><td>Ingress æŒ‡å®š Sidecar çš„é…ç½®ï¼Œç”¨äºå¤„ç†é™„åŠ å·¥ä½œè´Ÿè½½å®ä¾‹çš„å…¥ç«™æµé‡ã€‚å¦‚æœçœç•¥ï¼ŒIstio å°†æ ¹æ®ä»ç¼–æ’å¹³å°è·å¾—çš„å·¥ä½œè´Ÿè½½ä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œæš´éœ²çš„ç«¯å£ã€æœåŠ¡ç­‰ï¼‰è‡ªåŠ¨é…ç½® sidecarã€‚å¦‚æœæŒ‡å®šï¼Œå½“ä¸”ä»…å½“å·¥ä½œè´Ÿè½½å®ä¾‹ä¸æœåŠ¡å…³è”æ—¶ï¼Œæ‰ä¼šé…ç½®å…¥ç«™ç«¯å£</td></tr><tr><td><a href="#IstioEgressListener">egress</a></td><td>Egress æŒ‡å®š sidecar çš„é…ç½®ï¼Œç”¨äºå¤„ç†ä»é™„åŠ å·¥ä½œè´Ÿè½½å®ä¾‹åˆ°ç½‘æ ¼ä¸­å…¶ä»–æœåŠ¡çš„å‡ºç«™æµé‡ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä»å‘½åç©ºé—´èŒƒå›´æˆ–å…¨å±€é»˜è®¤ Sidecar ç»§æ‰¿ç³»ç»Ÿæ£€æµ‹åˆ°çš„é»˜è®¤å€¼</td></tr><tr><td>outboundTrafficPolicy</td><td>å‡ºæ–¹å‘æµé‡ç­–ç•¥çš„é…ç½®ã€‚å¦‚æœåº”ç”¨ç¨‹åºä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªæœªçŸ¥çš„å¤–éƒ¨æœåŠ¡ï¼Œå°†ç­–ç•¥è®¾ç½®ä¸º ALLOW_ANY å°†å¯¼è‡´ sidecar å°†æ¥è‡ªåº”ç”¨ç¨‹åºçš„ä»»ä½•æœªçŸ¥æµé‡è·¯ç”±åˆ°å…¶è¯·æ±‚çš„ç›®çš„åœ°ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä»å‘½åç©ºé—´èŒƒå›´æˆ–å…¨å±€é»˜è®¤ Sidecar ç»§æ‰¿ç³»ç»Ÿæ£€æµ‹åˆ°çš„é»˜è®¤å€¼</td></tr></tbody></table><h1 id="IstioIngressListener"><a href="#IstioIngressListener" class="headerlink" title="IstioIngressListener"></a><a name="IstioIngressListener">IstioIngressListener</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>port</td><td>ä¸ listener å…³è”çš„ç«¯å£</td></tr><tr><td>bind</td><td>listener åº”ç»‘å®šåˆ°çš„ IPï¼ˆIPv4 æˆ– IPv6ï¼‰ã€‚å…¥å£ listener çš„ç»‘å®šå­—æ®µä¸­ä¸å…è®¸ä½¿ç”¨ Unix åŸŸå¥—æ¥å­—åœ°å€ã€‚å¦‚æœçœç•¥ï¼ŒIstio å°†æ ¹æ®å¯¼å…¥çš„æœåŠ¡å’Œåº”ç”¨æ­¤é…ç½®çš„å·¥ä½œè´Ÿè½½å®ä¾‹è‡ªåŠ¨é…ç½®é»˜è®¤å€¼</td></tr><tr><td><a href="#CaptureMode">captureMode</a></td><td>è¡¨ç¤ºå¦‚ä½•æ•è·ï¼ˆæˆ–ä¸æ•è·ï¼‰åˆ° listener çš„æµé‡</td></tr><tr><td>defaultEndpoint</td><td>åº”å°†æµé‡è½¬å‘åˆ°çš„ IP ç«¯ç‚¹æˆ– Unix åŸŸå¥—æ¥å­—ã€‚æ­¤é…ç½®å¯ç”¨äºå°†åˆ°è¾¾ sidecar ä¸Šçš„ç»‘å®š IP:Port çš„æµé‡é‡å®šå‘åˆ°åº”ç”¨ç¨‹åºå·¥ä½œè´Ÿè½½å®ä¾‹æ­£åœ¨ä¾¦å¬è¿æ¥çš„ localhost:port æˆ– Unix åŸŸå¥—æ¥å­—ã€‚ä¸æ”¯æŒä»»æ„ IPã€‚æ ¼å¼åº”è¯¥æ˜¯ 127.0.0.1:PORTã€[::1]:PORTï¼ˆè½¬å‘åˆ° localhostï¼‰ã€0.0.0.0:PORTã€[::]:PORTï¼ˆè½¬å‘åˆ°å®ä¾‹ IPï¼‰æˆ– unix:&#x2F;&#x2F;&#x2F; ä¹‹ä¸€path&#x2F;to&#x2F;socketï¼ˆè½¬å‘åˆ° Unix åŸŸå¥—æ¥å­—ï¼‰</td></tr><tr><td>tls</td><td>ä¸€ç»„ TLS ç›¸å…³é€‰é¡¹ï¼Œå°†åœ¨ sidecar ä¸Šä¸ºæ¥è‡ªç½‘æ ¼å¤–éƒ¨çš„è¯·æ±‚å¯ç”¨ TLS ç»ˆæ­¢ã€‚ç›®å‰ä»…æ”¯æŒ SIMPLE å’Œ MUTUAL TLS æ¨¡å¼</td></tr></tbody></table><h1 id="IstioEgressListener"><a href="#IstioEgressListener" class="headerlink" title="IstioEgressListener"></a><a name="IstioEgressListener">IstioEgressListener</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>port</td><td>ä¸ listener å…³è”çš„ç«¯å£ã€‚å¦‚æœä½¿ç”¨ Unix åŸŸå¥—æ¥å­—ï¼Œè¯·ä½¿ç”¨ 0 ä½œä¸ºç«¯å£å·ï¼Œå¹¶ä½¿ç”¨æœ‰æ•ˆçš„åè®®ã€‚å¦‚æœæŒ‡å®šäº†ç«¯å£ï¼Œå°†ç”¨ä½œä¸å¯¼å…¥ä¸»æœºå…³è”çš„é»˜è®¤ç›®æ ‡ç«¯å£ã€‚å¦‚æœçœç•¥ç«¯å£ï¼ŒIstio å°†æ ¹æ®å¯¼å…¥çš„ä¸»æœºæ¨æ–­ listener ç«¯å£ã€‚è¯·æ³¨æ„ï¼Œå½“æŒ‡å®šå¤šä¸ªå‡ºå£ listener æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªä¾¦å¬å™¨å…·æœ‰ç‰¹å®šç«¯å£è€Œå…¶ä»– listener æ²¡æœ‰ç«¯å£ï¼Œåˆ™åœ¨ listener ç«¯å£ä¸Šæš´éœ²çš„ä¸»æœºå°†åŸºäºå…·æœ‰æœ€ç‰¹å®šç«¯å£çš„ listener</td></tr><tr><td>bind</td><td>listener åº”ç»‘å®šåˆ°çš„ IPï¼ˆIPv4 æˆ– IPv6ï¼‰æˆ– Unix åŸŸå¥—æ¥å­—ã€‚å¦‚æœ bind ä¸ä¸ºç©ºï¼Œåˆ™å¿…é¡»æŒ‡å®šç«¯å£ã€‚æ ¼å¼ï¼šIPv4 æˆ– IPv6 åœ°å€æ ¼å¼æˆ– unix:&#x2F;&#x2F;&#x2F;path&#x2F;to&#x2F;uds æˆ– unix:&#x2F;&#x2F;@foobarï¼ˆLinux æŠ½è±¡å‘½åç©ºé—´ï¼‰ã€‚å¦‚æœçœç•¥ï¼ŒIstio å°†æ ¹æ®å¯¼å…¥çš„æœåŠ¡ã€åº”ç”¨æ­¤é…ç½®çš„å·¥ä½œè´Ÿè½½å®ä¾‹å’Œ captureMode è‡ªåŠ¨é…ç½®é»˜è®¤å€¼ã€‚å¦‚æœ captureMode ä¸º NONEï¼Œbind å°†é»˜è®¤ä¸º 127.0.0.1</td></tr><tr><td><a href="#CaptureMode">captureMode</a></td><td>å½“ç»‘å®šåœ°å€æ˜¯ IP æ—¶ï¼ŒcaptureMode é€‰é¡¹æŒ‡ç¤ºå¦‚ä½•æ•è·ï¼ˆæˆ–ä¸æ•è·ï¼‰åˆ° listener çš„æµé‡ã€‚å¯¹äº Unix åŸŸå¥—æ¥å­—ç»‘å®šï¼ŒcaptureMode å¿…é¡»ä¸º DEFAULT æˆ– NONE</td></tr><tr><td>hosts</td><td>listener ä»¥ namespace&#x2F;dnsName æ ¼å¼æš´éœ²ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ä¸»æœºã€‚ä¸ dnsName åŒ¹é…çš„æŒ‡å®šå‘½åç©ºé—´ä¸­çš„æœåŠ¡å°†è¢«æš´éœ²ã€‚ç›¸åº”çš„æœåŠ¡å¯ä»¥æ˜¯æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ï¼ˆä¾‹å¦‚ï¼ŒKubernetes æˆ–äº‘æœåŠ¡ï¼‰æˆ–ä½¿ç”¨ ServiceEntry æˆ– VirtualService é…ç½®æŒ‡å®šçš„æœåŠ¡ã€‚è¿˜å°†ä½¿ç”¨åŒä¸€å‘½åç©ºé—´ä¸­çš„ä»»ä½•å…³è” DestinationRuleã€‚<br />åº”ä½¿ç”¨ FQDN æ ¼å¼æŒ‡å®š dnsNameï¼Œå¯é€‰æ‹©åœ¨æœ€å·¦ä¾§çš„ç»„ä»¶ä¸­åŒ…å«é€šé…ç¬¦ï¼ˆä¾‹å¦‚ prod&#x2F;*.example.comï¼‰ã€‚å°† dnsName è®¾ç½®ä¸º * ä»¥é€‰æ‹©æŒ‡å®šå‘½åç©ºé—´ä¸­çš„æ‰€æœ‰æœåŠ¡ï¼ˆä¾‹å¦‚ prod&#x2F;*ï¼‰ã€‚<br />å‘½åç©ºé—´å¯ä»¥è®¾ç½®ä¸º <em>ã€. æˆ– ~ï¼Œåˆ†åˆ«è¡¨ç¤ºä»»ä½•å‘½åç©ºé—´ã€å½“å‰å‘½åç©ºé—´æˆ–æ— å‘½åç©ºé—´ã€‚ä¾‹å¦‚ï¼Œ</em>&#x2F;foo.example.com ä»ä»»ä½•å¯ç”¨çš„å‘½åç©ºé—´ä¸­é€‰æ‹©æœåŠ¡ï¼Œè€Œ .&#x2F;foo.example.com ä»…ä» sidecar çš„å‘½åç©ºé—´ä¸­é€‰æ‹©æœåŠ¡ã€‚å¦‚æœä¸»æœºè®¾ç½®ä¸º *&#x2F;<em>ï¼ŒIstio å°†é…ç½® sidecar ä»¥ä¾¿èƒ½å¤Ÿè®¿é—®ç½‘æ ¼ä¸­å¯¼å‡ºåˆ° sidecar å‘½åç©ºé—´çš„æ¯ä¸ªæœåŠ¡ã€‚å€¼ ~&#x2F;</em> å¯ç”¨äºå®Œå…¨ä¿®å‰ª Sidecar çš„é…ç½®ï¼Œè¿™äº› Sidecar ä»…æ¥æ”¶æµé‡å¹¶å“åº”ï¼Œä½†ä¸å»ºç«‹è‡ªå·±çš„å‡ºç«™è¿æ¥ã€‚<br />åªèƒ½å¼•ç”¨å¯¼å‡ºåˆ° sidecar å‘½åç©ºé—´çš„æœåŠ¡å’Œé…ç½®å·¥ä»¶ï¼ˆä¾‹å¦‚ï¼ŒexportTo çš„ * å€¼ï¼‰ã€‚ç§æœ‰é…ç½®ï¼ˆä¾‹å¦‚ï¼ŒexportTo è®¾ç½®ä¸º .ï¼‰</td></tr></tbody></table><h1 id="WorkloadSelector"><a href="#WorkloadSelector" class="headerlink" title="WorkloadSelector"></a><a name="WorkloadSelector">WorkloadSelector</a></h1><p>WorkloadSelector æŒ‡å®šç”¨äºç¡®å®šæ˜¯å¦å¯ä»¥å°† Gatewayã€Sidecarã€EnvoyFilterã€ServiceEntry æˆ– DestinationRule é…ç½®åº”ç”¨äºä»£ç†çš„æ ‡å‡†ã€‚åŒ¹é…æ¡ä»¶åŒ…æ‹¬ä¸ä»£ç†å…³è”çš„å…ƒæ•°æ®ã€å·¥ä½œè´Ÿè½½å®ä¾‹ä¿¡æ¯ï¼ˆä¾‹å¦‚é™„åŠ åˆ° pod&#x2F;VM çš„æ ‡ç­¾ï¼‰æˆ–ä»£ç†åœ¨åˆå§‹æ¡æ‰‹æœŸé—´æä¾›ç»™ Istio çš„ä»»ä½•å…¶ä»–ä¿¡æ¯ã€‚å¦‚æœæŒ‡å®šäº†å¤šä¸ªæ¡ä»¶ï¼Œåˆ™éœ€è¦åŒ¹é…æ‰€æœ‰æ¡ä»¶æ‰èƒ½é€‰æ‹©å·¥ä½œè´Ÿè½½å®ä¾‹ã€‚ç›®å‰ï¼Œä»…æ”¯æŒåŸºäºæ ‡ç­¾çš„é€‰æ‹©æœºåˆ¶ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>labels</td><td>ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼ŒæŒ‡ç¤ºåº”ç”¨é…ç½®çš„ä¸€ç»„ç‰¹å®š Pod&#x2F;VMã€‚æ ‡ç­¾æœç´¢çš„èŒƒå›´ä»…é™äºèµ„æºæ‰€åœ¨çš„é…ç½®å‘½åç©ºé—´</td></tr></tbody></table><h1 id="OutboundTrafficPolicy"><a href="#OutboundTrafficPolicy" class="headerlink" title="OutboundTrafficPolicy"></a><a name="OutboundTrafficPolicy">OutboundTrafficPolicy</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#OutboundTrafficPolicy.Mode">mode</a></td><td>è®¾ç½® sidecar çš„é»˜è®¤è¡Œä¸ºä»¥å¤„ç†æ¥è‡ªåº”ç”¨ç¨‹åºçš„å‡ºç«™æµé‡ã€‚å¦‚æœåº”ç”¨ç¨‹åºä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªå…ˆéªŒæœªçŸ¥çš„å¤–éƒ¨æœåŠ¡ï¼Œå°†ç­–ç•¥è®¾ç½®ä¸º ALLOW_ANY å°†å¯¼è‡´è¾¹è½¦å°†æ¥è‡ªåº”ç”¨ç¨‹åºçš„ä»»ä½•æœªçŸ¥æµé‡è·¯ç”±åˆ°å…¶è¯·æ±‚çš„ç›®çš„åœ°ã€‚å¼ºçƒˆå»ºè®®ç”¨æˆ·ä½¿ç”¨ ServiceEntry é…ç½®æ¥æ˜¾å¼å£°æ˜ä»»ä½•å¤–éƒ¨ä¾èµ–é¡¹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ ALLOW_ANYï¼Œä»¥ä¾¿å¯ä»¥ç›‘æ§åˆ°è¿™äº›æœåŠ¡çš„æµé‡</td></tr></tbody></table><h1 id="OutboundTrafficPolicy-Mode"><a href="#OutboundTrafficPolicy-Mode" class="headerlink" title="OutboundTrafficPolicy.Mode"></a><a name="OutboundTrafficPolicy.Mode">OutboundTrafficPolicy.Mode</a></h1><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>REGISTRY_ONLY</td><td>å‡ºç«™æµé‡å°†ä»…é™äºæœåŠ¡æ³¨å†Œè¡¨ä¸­å®šä¹‰çš„æœåŠ¡ä»¥åŠé€šè¿‡ ServiceEntry é…ç½®å®šä¹‰çš„æœåŠ¡</td></tr><tr><td>ALLOW_ANY</td><td>å¦‚æœç›®æ ‡ç«¯å£æ²¡æœ‰æœåŠ¡æˆ– ServiceEntry é…ç½®ï¼Œåˆ™å°†å…è®¸åˆ°æœªçŸ¥ç›®æ ‡çš„å‡ºç«™æµé‡</td></tr></tbody></table><h1 id="CaptureMode"><a href="#CaptureMode" class="headerlink" title="CaptureMode"></a><a name="CaptureMode">CaptureMode</a></h1><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>DEFAULT</td><td>ç¯å¢ƒå®šä¹‰çš„é»˜è®¤æ•è·æ¨¡å¼</td></tr><tr><td>IPTABLES</td><td>ä½¿ç”¨ IPtables é‡å®šå‘æ•è·æµé‡</td></tr><tr><td>NONE</td><td>æ²¡æœ‰æµé‡æ•è·ã€‚å½“åœ¨å‡ºå£ listener ä¸­ä½¿ç”¨æ—¶ï¼Œåº”ç”¨ç¨‹åºåº”ä¸ listener ç«¯å£æˆ– Unix åŸŸå¥—æ¥å­—æ˜¾å¼é€šä¿¡ã€‚åœ¨å…¥å£ listener ä¸­ä½¿ç”¨æ—¶ï¼Œéœ€è¦æ³¨æ„ç¡®ä¿ listener ç«¯å£æ²¡æœ‰è¢«ä¸»æœºä¸Šçš„å…¶ä»–è¿›ç¨‹ä½¿ç”¨</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†åœºæ™¯ä¸‹çš„ Sidecar èµ„æºå¯¹è±¡ä½¿ç”¨èŒƒä¾‹ä¸ API ç»“æ„æ¦‚è§ˆ</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” ProxyConfig</title>
    <link href="http://shenxianghong.github.io/2022/09/15/2022-09-15%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20ProxyConfig/"/>
    <id>http://shenxianghong.github.io/2022/09/15/2022-09-15%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20ProxyConfig/</id>
    <published>2022-09-14T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.258Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>ProxyConfig æš´éœ²ä»£ç†çº§åˆ«çš„é…ç½®é€‰é¡¹ã€‚ ProxyConfig å¯ä»¥åŸºäºæ¯ä¸ªå·¥ä½œè´Ÿè½½ã€æ¯ä¸ªå‘½åç©ºé—´æˆ–ç½‘æ ¼èŒƒå›´è¿›è¡Œé…ç½®ã€‚ ProxyConfig ä¸æ˜¯å¿…éœ€çš„èµ„æºã€‚</p><p><em>æ³¨æ„ï¼šProxyConfig ä¸­çš„å­—æ®µä¸æ˜¯åŠ¨æ€é…ç½®çš„ï¼Œæ›´æ”¹é…ç½®éœ€è¦é‡å¯å·¥ä½œè´Ÿè½½æ‰èƒ½ç”Ÿæ•ˆã€‚</em></p><p>å¯¹äºä»»ä½•å‘½åç©ºé—´ï¼ŒåŒ…æ‹¬æ ¹é…ç½®å‘½åç©ºé—´ï¼Œä»…å¯¹åªæœ‰ä¸€ä¸ªæ—  workloadSelector çš„ ProxyConfig èµ„æºç”Ÿæ•ˆã€‚</p><p>å¯¹äºå…·æœ‰ workloadSelector çš„èµ„æºï¼Œä»…å¯¹åªæœ‰ä¸€ä¸ªèµ„æºé€‰æ‹©ä»»ä½•ç»™å®šå·¥ä½œè´Ÿè½½ç”Ÿæ•ˆã€‚</p><p>å¯¹äºç½‘æ ¼çº§åˆ«é…ç½®ï¼ŒProxyConfig éœ€éƒ¨ç½²åœ¨ Istio å®‰è£…çš„æ ¹é…ç½®å‘½åç©ºé—´ istio-system ä¸­ï¼Œå¹¶ä¸”æ— éœ€è®¾ç½® workloadSelectorã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ProxyConfig</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-proxyconfig</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">concurrency:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">image:</span></span><br><span class="line">    <span class="attr">imageType:</span> <span class="string">distroless</span></span><br></pre></td></tr></table></figure><p>å¯¹äºå‘½åç©ºé—´çº§åˆ«çš„é…ç½®ï¼ŒProxyConfig éœ€éƒ¨ç½²åœ¨è¯¥å‘½åç©ºé—´ user-namespace ä¸­ï¼Œå¹¶ä¸”æ— éœ€è®¾ç½® workloadSelectorã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ProxyConfig</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-ns-proxyconfig</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">user-namespace</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">concurrency:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>å¯¹äºå·¥ä½œè´Ÿè½½çº§åˆ«é…ç½®ï¼Œåœ¨ ProxyConfig èµ„æºä¸Šè®¾ç½® selector å­—æ®µï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ProxyConfig</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">per-workload-proxyconfig</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ratings</span></span><br><span class="line">  <span class="attr">concurrency:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">image:</span></span><br><span class="line">    <span class="attr">imageType:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå®šä¹‰äº†ä¸å·¥ä½œè´Ÿè½½åŒ¹é…çš„ ProxyConfig CRï¼Œå®ƒå°†ä¸å…¶ proxy.istio.io&#x2F;config æ³¨é‡Šï¼ˆå¦‚æœå­˜åœ¨ï¼‰åˆå¹¶ï¼Œé‡å¤å­—æ®µå†…å®¹ä»¥ ProxyConfig CR ä¸ºå‡†ã€‚åŒæ ·ï¼Œå¦‚æœå®šä¹‰äº†ç½‘æ ¼èŒƒå›´çš„ ProxyConfig CR å¹¶è®¾ç½®äº† meshConfig.DefaultConfigï¼Œåˆ™ä¸¤ä¸ªèµ„æºå°†åˆå¹¶ï¼Œé‡å¤å­—æ®µå†…å®¹ä»¥ ProxyConfig CR ä¸ºå‡†ã€‚</p><h1 id="ProxyConfig"><a href="#ProxyConfig" class="headerlink" title="ProxyConfig"></a>ProxyConfig</h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>selector</td><td>selector æŒ‡å®šå¾…åº”ç”¨æ­¤ ProxyConfig çš„ä¸€ç»„ Pod&#x2F;VMã€‚å¦‚æœæœªè®¾ç½®ï¼ŒProxyConfig èµ„æºå°†åº”ç”¨äºå…¶æ‰€åœ¨å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½</td></tr><tr><td>concurrency</td><td>è¦è¿è¡Œçš„å·¥ä½œçº¿ç¨‹æ•°ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™é»˜è®¤ä¸º 2ã€‚å¦‚æœè®¾ç½®ä¸º 0ï¼Œè¿™å°†è¢«é…ç½®ä¸ºä½¿ç”¨æœºå™¨ä¸Šçš„æ‰€æœ‰å†…æ ¸ä½¿ç”¨ CPU è¯·æ±‚å’Œé™åˆ¶æ¥é€‰æ‹©ä¸€ä¸ªå€¼ï¼Œé™åˆ¶ä¼˜å…ˆäºè¯·æ±‚</td></tr><tr><td>environmentVariables</td><td>ä»£ç†çš„å…¶ä»–ç¯å¢ƒå˜é‡ã€‚ä»¥ ISTIO_META_ å¼€å¤´çš„åç§°å°†åŒ…å«åœ¨ç”Ÿæˆçš„å¼•å¯¼é…ç½®ä¸­å¹¶å‘é€åˆ° XDS æœåŠ¡å™¨</td></tr><tr><td><a href="#ProxyImage">image</a></td><td>æŒ‡å®šä»£ç†çš„é•œåƒ</td></tr></tbody></table><h1 id="ProxyImage"><a href="#ProxyImage" class="headerlink" title="ProxyImage"></a><a name="ProxyImage">ProxyImage</a></h1><p>ç”¨äºæ„é€ ä»£ç†é•œåƒ urlã€‚æ ¼å¼ï¼š${hub}&#x2F;${image_name}&#x2F;${tag}-${image_type}ï¼Œä¾‹å¦‚ï¼šdocker.io&#x2F;istio&#x2F;proxyv2:1.11.1 æˆ– docker.io&#x2F;istio&#x2F;proxyv2:1.11.1-distrolessã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>imageType</td><td>é•œåƒçš„ç±»å‹ã€‚å¯é€‰çš„æœ‰ï¼šdefaultã€debugã€distrolessã€‚å¦‚æœ image ç±»å‹å·²ç»ï¼ˆä¾‹å¦‚ï¼šcentosï¼‰å‘å¸ƒåˆ°æŒ‡å®šçš„ hubï¼Œåˆ™å…è®¸ä½¿ç”¨å…¶ä»–å€¼ã€‚</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†åœºæ™¯ä¸‹çš„ ProxyConfig èµ„æºå¯¹è±¡ä½¿ç”¨èŒƒä¾‹ä¸ API ç»“æ„æ¦‚è§ˆ</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” WorkloadGroup</title>
    <link href="http://shenxianghong.github.io/2022/09/08/2022-09-08%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Workload%20Group/"/>
    <id>http://shenxianghong.github.io/2022/09/08/2022-09-08%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Workload%20Group/</id>
    <published>2022-09-07T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.258Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>WorkloadGroup æè¿°å·¥ä½œè´Ÿè½½å®ä¾‹çš„é›†åˆã€‚æä¾›äº†å·¥ä½œè´Ÿè½½å®ä¾‹å¯ç”¨äºå¼•å¯¼å…¶ä»£ç†çš„è§„èŒƒï¼ŒåŒ…æ‹¬å…ƒæ•°æ®å’Œæ ‡è¯†ã€‚å®ƒä»…é€‚ç”¨äºè™šæ‹Ÿæœºç­‰é Kubernetes å·¥ä½œè´Ÿè½½ï¼Œæ—¨åœ¨æ¨¡ä»¿ç”¨äº Kubernetes å·¥ä½œè´Ÿè½½çš„ç°æœ‰ Sidecar æ³¨å…¥å’Œéƒ¨ç½²è§„èŒƒæ¨¡å‹ä»¥å¼•å¯¼ Istio ä»£ç†ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹å£°æ˜äº†ä¸€ä¸ª WorkloadGroupï¼Œä»£è¡¨äº†ä¸€ç»„åœ¨ bookinfo å‘½åç©ºé—´ä¸­ reviews ä¸‹æ³¨å†Œçš„å·¥ä½œè´Ÿè½½é›†åˆã€‚æ ‡ç­¾é›†å°†åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¸æ¯ä¸ªå·¥ä½œè´Ÿè½½å®ä¾‹ç›¸å…³è”ï¼Œç«¯å£ 3550 å’Œ 8080 å°†ä¸ WorkloadGroup ç›¸å…³è”å¹¶ä½¿ç”¨åä¸º default Service Accountã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkloadGroup</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">reviews</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/version:</span> <span class="string">&quot;1.3.4&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="attr">grpc:</span> <span class="number">3550</span></span><br><span class="line">      <span class="attr">http:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">probe:</span></span><br><span class="line">    <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">timeoutSeconds:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">periodSeconds:</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">successThreshold:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">httpGet:</span></span><br><span class="line">     <span class="attr">path:</span> <span class="string">/foo/bar</span></span><br><span class="line">     <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">     <span class="attr">port:</span> <span class="number">3100</span></span><br><span class="line">     <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">     <span class="attr">httpHeaders:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Lit-Header</span></span><br><span class="line">       <span class="attr">value:</span> <span class="string">Im-The-Best</span></span><br></pre></td></tr></table></figure><h1 id="WorkloadGroup"><a href="#WorkloadGroup" class="headerlink" title="WorkloadGroup"></a>WorkloadGroup</h1><p>WorkloadGroup å¯ä»¥ä¸º bootstrap æŒ‡å®šå•ä¸ªå·¥ä½œè´Ÿè½½çš„å±æ€§ï¼Œå¹¶ä¸º WorkloadEntry æä¾›æ¨¡æ¿ï¼Œç±»ä¼¼äº Deployment é€šè¿‡ Pod æ¨¡æ¿æŒ‡å®šå·¥ä½œè´Ÿè½½çš„å±æ€§ã€‚ä¸€ä¸ª WorkloadGroup å¯ä»¥æœ‰å¤šä¸ª WorkloadEntryã€‚ WorkloadGroup ä¸æ§åˆ¶ ServiceEntry ç­‰æœåŠ¡æ³¨å†Œè¡¨çš„èµ„æºæ²¡æœ‰å…³ç³»ï¼Œå› æ­¤ä¸ä¼šä¸ºè¿™äº›å·¥ä½œè´Ÿè½½é…ç½®ä¸»æœºåã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#WorkloadGroup.ObjectMeta">metadata</a></td><td>metadata ä¼šä½œç”¨äºå¯¹åº”çš„æ‰€æœ‰ WorkloadEntry ä¸­ï¼ŒWorkloadGroup çš„ label è®¾ç½®åº”ä½äº metadata ä¸­ï¼Œè€Œä¸æ˜¯ template</td></tr><tr><td>template</td><td>ç”¨äºç”Ÿæˆå±äºæ­¤ WorkloadGroup çš„ WorkloadEntry èµ„æºçš„æ¨¡æ¿ã€‚æ³¨æ„ï¼Œä¸åº”åœ¨æ¨¡æ¿ä¸­è®¾ç½®åœ°å€å’Œæ ‡ç­¾å­—æ®µï¼Œç©ºçš„ serviceAccount åº”é»˜è®¤ä¸º defaultã€‚å·¥ä½œè´Ÿè½½èº«ä»½ï¼ˆmTLS è¯ä¹¦ï¼‰å°†ä½¿ç”¨æŒ‡å®š Service Account çš„ä»¤ç‰Œè¿›è¡Œåˆå§‹åŒ–ã€‚è¯¥ç»„ä¸­çš„ WorkloadEntry å°†ä¸å·¥ä½œè´Ÿè½½ç»„ä½äºåŒä¸€å‘½åç©ºé—´ä¸­ï¼Œå¹¶ä»ä¸Šè¿° metadata å­—æ®µç»§æ‰¿æ ‡ç­¾å’Œæ³¨é‡Š</td></tr><tr><td><a href="#ReadinessProbe">probe</a></td><td>ReadinessProbe æè¿°äº†ç”¨æˆ·å¯¹å…¶å·¥ä½œè´Ÿè½½è¿›è¡Œå¥åº·æ£€æŸ¥æä¾›çš„é…ç½®ã€‚å…·ä½“å‚è€ƒ Kubernetes çš„è¯­æ³•ä¸é€»è¾‘</td></tr></tbody></table><h1 id="ReadinessProbe"><a href="#ReadinessProbe" class="headerlink" title="ReadinessProbe"></a><a name="ReadinessProbe">ReadinessProbe</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>initialDelaySeconds</td><td>å®¹å™¨å¯åŠ¨åï¼Œè¿›è¡Œå°±ç»ªæ¢æµ‹ä¹‹å‰çš„ç§’æ•°</td></tr><tr><td>timeoutSeconds</td><td>æ¢æµ‹è¶…æ—¶çš„ç§’æ•°ã€‚é»˜è®¤ä¸º 1 ç§’ã€‚æœ€å°å€¼ä¸º 1 ç§’</td></tr><tr><td>periodSeconds</td><td>æ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚é»˜è®¤ä¸º 10 ç§’ã€‚æœ€å°å€¼ä¸º 1 ç§’</td></tr><tr><td>successThreshold</td><td>æ¢æµ‹å¤±è´¥åè¢«è§†ä¸ºæˆåŠŸçš„æœ€å°è¿ç»­æˆåŠŸæ¬¡æ•°ã€‚é»˜è®¤ä¸º 1</td></tr><tr><td>failureThreshold</td><td>æ¢æµ‹æˆåŠŸåè¢«è§†ä¸ºå¤±è´¥çš„æœ€å°è¿ç»­å¤±è´¥æ¬¡æ•°ã€‚é»˜è®¤ä¸º 3</td></tr><tr><td><a href="#HTTPHealthCheckConfig">httpGet</a></td><td>åŸºäº http get çš„å¥åº·æ£€æŸ¥</td></tr><tr><td><a href="#TCPHealthCheckConfig">tcpSocket</a></td><td>åŸºäºä»£ç†æ˜¯å¦èƒ½å¤Ÿè¿æ¥çš„å¥åº·æ£€æŸ¥</td></tr><tr><td><a href="#ExecHealthCheckConfig">exec</a></td><td>åŸºäºæ‰§è¡Œçš„å‘½ä»¤å¦‚ä½•é€€å‡ºçš„å¥åº·æ£€æŸ¥</td></tr></tbody></table><h1 id="HTTPHealthCheckConfig"><a href="#HTTPHealthCheckConfig" class="headerlink" title="HTTPHealthCheckConfig"></a><a name="HTTPHealthCheckConfig">HTTPHealthCheckConfig</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>path</td><td>HTTP æœåŠ¡å™¨ä¸Šçš„è®¿é—®è·¯å¾„</td></tr><tr><td>port</td><td>endpoint æ‰€åœ¨çš„ç«¯å£</td></tr><tr><td>host</td><td>è¦è¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤ä¸º Pod IP</td></tr><tr><td>scheme</td><td>HTTP æˆ–è€… HTTPSï¼Œé»˜è®¤ä¸º HTTP</td></tr><tr><td>httpHeaders</td><td>è¯·æ±‚çš„ headerã€‚å…è®¸é‡å¤çš„è¯·æ±‚å¤´</td></tr></tbody></table><h1 id="HTTPHeader"><a href="#HTTPHeader" class="headerlink" title="HTTPHeader"></a><a name="HTTPHeader">HTTPHeader</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>name</td><td>header çš„é”®</td></tr><tr><td>value</td><td>header çš„å€¼</td></tr></tbody></table><h1 id="TCPHealthCheckConfig"><a href="#TCPHealthCheckConfig" class="headerlink" title="TCPHealthCheckConfig"></a><a name="TCPHealthCheckConfig">TCPHealthCheckConfig</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>host</td><td>å¾…è¿æ¥çš„ä¸»æœºï¼Œé»˜è®¤ä¸º localhost</td></tr><tr><td>port</td><td>ä¸»æœºç«¯å£</td></tr></tbody></table><h1 id="ExecHealthCheckConfig"><a href="#ExecHealthCheckConfig" class="headerlink" title="ExecHealthCheckConfig"></a><a name="ExecHealthCheckConfig">ExecHealthCheckConfig</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>command</td><td>å¾…è¿è¡Œçš„å‘½ä»¤ã€‚é€€å‡ºçŠ¶æ€ä¸º 0 è¢«è§†ä¸ºæ´»åŠ¨&#x2F;å¥åº·ï¼Œéé›¶è¡¨ç¤ºä¸å¥åº·</td></tr></tbody></table><h1 id="WorkloadGroup-ObjectMeta"><a href="#WorkloadGroup-ObjectMeta" class="headerlink" title="WorkloadGroup.ObjectMeta"></a><a name="WorkloadGroup.ObjectMeta">WorkloadGroup.ObjectMeta</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>labels</td><td>æ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>annotations</td><td>æ³¨è§£ä¿¡æ¯</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†åœºæ™¯ä¸‹çš„ WorkloadGroup èµ„æºå¯¹è±¡ä½¿ç”¨èŒƒä¾‹ä¸ API ç»“æ„æ¦‚è§ˆ</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” WorkloadEntry</title>
    <link href="http://shenxianghong.github.io/2022/08/23/2022-08-23%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Workload%20Entry/"/>
    <id>http://shenxianghong.github.io/2022/08/23/2022-08-23%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Workload%20Entry/</id>
    <published>2022-08-22T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.257Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>WorkloadEntry æè¿°å•ä¸ªé Kubernetes å·¥ä½œè´Ÿè½½çš„å±æ€§ï¼Œä¾‹å¦‚ VM æˆ–è£¸æœºæœåŠ¡å™¨ï¼Œå› ä¸ºå®ƒè¢«è½½å…¥åˆ°ç½‘æ ¼ä¸­ã€‚ WorkloadEntry å¿…é¡»ä¼´éšç€ Istio ServiceEntryï¼Œå®ƒé€šè¿‡é€‚å½“çš„æ ‡ç­¾é€‰æ‹©å·¥ä½œè´Ÿè½½å¹¶ä¸º MESH_INTERNAL æœåŠ¡ï¼ˆä¸»æœºåã€ç«¯å£å±æ€§ç­‰ï¼‰æä¾›æœåŠ¡å®šä¹‰ã€‚ ServiceEntry å¯¹è±¡å¯ä»¥æ ¹æ®æœåŠ¡æ¡ç›®ä¸­æŒ‡å®šçš„æ ‡ç­¾é€‰æ‹©å™¨é€‰æ‹©å¤šä¸ªå·¥ä½œè´Ÿè½½æ¡ç›®ä»¥åŠ Kubernetes podã€‚</p><p>å½“å·¥ä½œè´Ÿè½½è¿æ¥åˆ° istiod æ—¶ï¼Œè‡ªå®šä¹‰èµ„æºä¸­çš„ Status å­—æ®µå°†æ›´æ–°ï¼Œè¡¨ç¤ºå·¥ä½œè´Ÿè½½çš„å¥åº·çŠ¶å†µä»¥åŠå…¶ä»–è¯¦ç»†ä¿¡æ¯ï¼Œç±»ä¼¼äº Kubernetes æ›´æ–° Pod çŠ¶æ€çš„æ–¹å¼ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹ä¸º details.bookinfo.com æœåŠ¡å£°æ˜ä¸€ä¸ªè¡¨ç¤º VM çš„ Workload Entryã€‚æ­¤ VM å·²ä½¿ç”¨ details-legacy Service Account å®‰è£…å’Œå¼•å¯¼ Sidecarã€‚è¯¥æœåŠ¡åœ¨ç«¯å£ 80 ä¸Šæš´éœ²ç»™ç½‘æ ¼ä¸­çš„åº”ç”¨ç¨‹åºã€‚åˆ°è¯¥æœåŠ¡çš„ HTTP æµé‡è¢«å°è£…åœ¨ Istio åŒå‘ TLS ä¸­ï¼Œå¹¶å‘é€åˆ°ç›®æ ‡ç«¯å£ 8080 ä¸Š VM ä¸Šçš„ sidecarï¼Œç„¶åå°†å…¶è½¬å‘åˆ°åŒä¸€ç«¯å£ä¸Š localhost ä¸Šçš„åº”ç”¨ç¨‹åºã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkloadEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># use of the service account indicates that the workload has a</span></span><br><span class="line">  <span class="comment"># sidecar proxy bootstrapped with this service account. Pods with</span></span><br><span class="line">  <span class="comment"># sidecars will automatically communicate with the workload using</span></span><br><span class="line">  <span class="comment"># istio mutual TLS.</span></span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">details-legacy</span></span><br><span class="line">  <span class="attr">address:</span> <span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">details-legacy</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">vm1</span></span><br></pre></td></tr></table></figure><p>ç›¸å…³è”çš„ Service Entryï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">details.bookinfo.com</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_INTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">STATIC</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">details-legacy</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨å…¶å®Œå…¨é™å®šçš„ DNS åç§°å£°æ˜ç›¸åŒçš„ VM å·¥ä½œè´Ÿè½½ã€‚æœåŠ¡æ¡ç›®çš„è§£ææ¨¡å¼åº”æ›´æ”¹ä¸º DNSï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯ Sidecar åº”åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æ DNS åç§°ï¼Œç„¶åå†è½¬å‘è¯·æ±‚ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkloadEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># use of the service account indicates that the workload has a</span></span><br><span class="line">  <span class="comment"># sidecar proxy bootstrapped with this service account. Pods with</span></span><br><span class="line">  <span class="comment"># sidecars will automatically communicate with the workload using</span></span><br><span class="line">  <span class="comment"># istio mutual TLS.</span></span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">details-legacy</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">vm1.vpc01.corp.net</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">details-legacy</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">vm1</span></span><br></pre></td></tr></table></figure><p>ç›¸å…³è”çš„ Service Entryï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">details.bookinfo.com</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_INTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">details-legacy</span></span><br></pre></td></tr></table></figure><h1 id="WorkloadEntry"><a href="#WorkloadEntry" class="headerlink" title="WorkloadEntry"></a>WorkloadEntry</h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>address</td><td>ä¸å¸¦ç«¯å£çš„ç½‘ç»œ endpoint åœ°å€ã€‚å½“ä¸”ä»…å½“ resolution è®¾ç½®ä¸º DNS æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨åŸŸåï¼Œå¹¶ä¸”å¿…é¡»æ˜¯å®Œå…¨é™å®šçš„ï¼Œæ²¡æœ‰é€šé…ç¬¦ã€‚Unix åŸŸå¥—æ¥å­— endpoint ä½¿ç”¨æ ¼å¼ï¼šunix:&#x2F;&#x2F;&#x2F;absolute&#x2F;path&#x2F;to&#x2F;socketã€‚</td></tr><tr><td>ports</td><td>ä¸ endpoint å…³è”çš„ endpoint é›†ã€‚å¦‚æœæŒ‡å®šäº†ç«¯å£æ˜ å°„ï¼Œåˆ™å®ƒå¿…é¡»æ˜¯ servicePortName åˆ°æ­¤ endpoint ç«¯å£çš„æ˜ å°„ï¼Œè¿™æ ·åˆ°æœåŠ¡ç«¯å£çš„æµé‡å°†è¢«è½¬å‘åˆ°æ˜ å°„åˆ°æœåŠ¡ç«¯å£åç§°çš„ endpoint ç«¯å£ã€‚å¦‚æœçœç•¥ï¼Œå¹¶ä¸” targetPort è¢«æŒ‡å®šä¸ºæœåŠ¡ç«¯å£è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œåˆ™åˆ°æœåŠ¡ç«¯å£çš„æµé‡å°†è¢«è½¬å‘åˆ°æŒ‡å®š targetPort ä¸Šçš„ endpoint ä¹‹ä¸€ã€‚å¦‚æœæœªæŒ‡å®š targetPort å’Œ endpoint çš„ç«¯å£æ˜ å°„ï¼Œåˆ™åˆ°æœåŠ¡ç«¯å£çš„æµé‡å°†è¢«è½¬å‘åˆ°åŒä¸€ç«¯å£ä¸Šçš„ endpoint ä¹‹ä¸€</td></tr><tr><td>labels</td><td>ä¸ endpoint å…³è”çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾</td></tr><tr><td>network</td><td>ä½¿ Istio èƒ½å¤Ÿå¯¹é©»ç•™åœ¨åŒä¸€ L3 åŸŸ&#x2F;ç½‘ç»œä¸­çš„ endpoint è¿›è¡Œåˆ†ç»„ã€‚å‡å®šåŒä¸€ç½‘ç»œä¸­çš„æ‰€æœ‰ endpoint å½¼æ­¤å¯ç›´æ¥è®¿é—®ã€‚å½“ä¸åŒç½‘ç»œä¸­çš„ endpoint æ— æ³•ç›´æ¥ç›¸äº’è®¿é—®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Istio Gateway å»ºç«‹è¿æ¥ï¼ˆé€šå¸¸åœ¨ Gateway Server ä¸­ä½¿ç”¨ AUTO_PASSTHROUGH æ¨¡å¼ï¼‰ã€‚è¿™æ˜¯ä¸€ç§é«˜çº§é…ç½®ï¼Œé€šå¸¸ç”¨äºè·¨è¶Šå¤šä¸ªé›†ç¾¤çš„ Istio ç½‘æ ¼</td></tr><tr><td>locality</td><td>ä¸ endpoint å…³è”çš„ä½ç½®ä¿¡æ¯ã€‚ä½ç½®å¯¹åº”äºæ•…éšœåŸŸï¼ˆä¾‹å¦‚ï¼Œå›½å®¶&#x2F;åœ°åŒº&#x2F;åŒºåŸŸï¼‰ã€‚ä»»æ„æ•…éšœåŸŸå±‚æ¬¡ç»“æ„å¯ä»¥é€šè¿‡ç”¨ &#x2F; åˆ†éš”æ¯ä¸ªå°è£…æ•…éšœåŸŸæ¥è¡¨ç¤ºã€‚ä¾‹å¦‚ï¼Œendpoint åœ¨ USã€US-East-1 åŒºåŸŸã€å¯ç”¨åŒº az-1 å†…ã€æ•°æ®ä¸­å¿ƒæœºæ¶ r11 ä¸­çš„ä½ç½®å¯ä»¥è¡¨ç¤ºä¸º us&#x2F;us-east-1&#x2F;az-1&#x2F;r11ã€‚ Istio å°†é…ç½® sidecar ä»¥è·¯ç”±åˆ°ä¸ sidecar ç›¸åŒä½ç½®çš„ endpointã€‚å¦‚æœæœ¬åœ°æ²¡æœ‰å¯ç”¨çš„ endpointï¼Œåˆ™å°†é€‰æ‹© endpoint çˆ¶æœ¬åœ°ï¼ˆä½†åœ¨åŒä¸€ç½‘ç»œ ID å†…ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåŒä¸€ç½‘ç»œä¸­æœ‰ä¸¤ä¸ª endpointï¼ˆnetworkID â€œn1â€ï¼‰ï¼Œä¾‹å¦‚ e1 çš„ä½ç½®ä¸º us&#x2F;us-east-1&#x2F;az-1&#x2F;r11 å’Œ e2 çš„ä½ç½®ä¸º us&#x2F;us-east-1&#x2F;az-2 &#x2F;r12ï¼Œæ¥è‡ª us&#x2F;us-east-1&#x2F;az-1&#x2F;r11 åœ°åŒºçš„ Sidecar å°†æ›´å€¾å‘äºæ¥è‡ªåŒä¸€åœ°åŒºçš„ e1 è€Œä¸æ˜¯æ¥è‡ªä¸åŒåœ°åŒºçš„ e2ã€‚endpoint e2 å¯ä»¥æ˜¯ä¸ Gateway å…³è”çš„ IPï¼ˆæ¡¥æ¥ç½‘ç»œ n1 å’Œ n2ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸æ ‡å‡†æœåŠ¡ endpoint å…³è”çš„ IP</td></tr><tr><td>weight</td><td>ä¸ endpoint å…³è”çš„è´Ÿè½½å¹³è¡¡æƒé‡ã€‚å…·æœ‰è¾ƒé«˜æƒé‡çš„ endpoint å°†æŒ‰æ¯”ä¾‹è·å¾—è¾ƒé«˜çš„æµé‡</td></tr><tr><td>serviceAccount</td><td>å¦‚æœå·¥ä½œè´Ÿè½½ä¸­å­˜åœ¨ Sidecarï¼Œåˆ™ä¸å·¥ä½œè´Ÿè½½å…³è”çš„ Service Accountã€‚Service Account å¿…é¡»å­˜åœ¨äºä¸é…ç½®ç›¸åŒçš„å‘½åç©ºé—´ä¸­ï¼ˆWorkloadEntry æˆ– ServiceEntryï¼‰</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†åœºæ™¯ä¸‹çš„ WorkloadEntry èµ„æºå¯¹è±¡ä½¿ç”¨èŒƒä¾‹ä¸ API ç»“æ„æ¦‚è§ˆ</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” ServiceEntry</title>
    <link href="http://shenxianghong.github.io/2022/08/16/2022-08-16%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Service%20Entry/"/>
    <id>http://shenxianghong.github.io/2022/08/16/2022-08-16%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Service%20Entry/</id>
    <published>2022-08-15T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.257Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>ServiceEntry å…è®¸å°†å¤–éƒ¨çš„æœåŠ¡æ·»åŠ åˆ° Istio çš„å†…éƒ¨æœåŠ¡æ³¨å†Œè¡¨ä¸­ï¼Œä»¥ä¾¿ç½‘æ ¼ä¸­çš„æœåŠ¡å¯ä»¥è®¿é—®&#x2F;è·¯ç”±åˆ°è¿™äº›æ‰‹åŠ¨æŒ‡å®šçš„æœåŠ¡ã€‚ServiceEntry æè¿°äº†æœåŠ¡çš„å±æ€§ï¼ˆDNS åç§°ã€VIPã€ç«¯å£ã€åè®®ã€ç«¯ç‚¹ï¼‰ã€‚è¿™äº›æœåŠ¡å¯èƒ½åœ¨ç½‘æ ¼å¤–éƒ¨ï¼ˆä¾‹å¦‚ï¼ŒWeb APIï¼‰æˆ–ç½‘æ ¼å†…éƒ¨æœåŠ¡ï¼Œå®ƒä»¬ä¸å±äºå¹³å°çš„æœåŠ¡æ³¨å†Œè¡¨ï¼ˆä¾‹å¦‚ï¼Œä¸€ç»„ä¸ Kubernetes ä¸­çš„æœåŠ¡é€šä¿¡çš„ VMï¼‰ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ workloadSelector å­—æ®µåŠ¨æ€é€‰æ‹© ServiceEntry  çš„ endpointã€‚è¿™äº› endpoint å¯ä»¥æ˜¯ä½¿ç”¨ WorkloadEntry å¯¹è±¡æˆ– Kubernetes Pod å£°æ˜çš„ VM å·¥ä½œè´Ÿè½½ã€‚åœ¨å•ä¸ªæœåŠ¡ä¸‹åŒæ—¶é€‰æ‹© Pod å’Œ VM çš„èƒ½åŠ›å…è®¸å°†æœåŠ¡ä» VM è¿ç§»åˆ° Kubernetesï¼Œè€Œæ— éœ€æ›´æ”¹ä¸æœåŠ¡å…³è”çš„ç°æœ‰ DNS åç§°ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹ä¸­å£°æ˜äº†ä¸€äº›ç”±å†…éƒ¨åº”ç”¨ç¨‹åºé€šè¿‡ HTTPS è®¿é—®çš„å¤–éƒ¨ APIã€‚ Sidecar æ£€æŸ¥ ClientHello æ¶ˆæ¯ä¸­çš„ SNI å€¼ä»¥è·¯ç”±åˆ°é€‚å½“çš„å¤–éƒ¨æœåŠ¡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-https</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">api.dropboxapi.com</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">www.googleapis.com</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">api.facebook.com</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TLS</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹é…ç½®å°†ä¸€ç»„è¿è¡Œåœ¨éæ‰˜ç®¡ VM ä¸Šçš„ MongoDB å®ä¾‹æ·»åŠ åˆ° Istio çš„æ³¨å†Œè¡¨ä¸­ï¼Œä»¥ä¾¿å¯ä»¥å°†è¿™äº›æœåŠ¡è§†ä¸ºç½‘æ ¼ä¸­çš„æœåŠ¡ã€‚å…³è”çš„ DestinationRule ç”¨äºå¯åŠ¨ä¸æ•°æ®åº“å®ä¾‹çš„ mTLS è¿æ¥ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-mongocluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mymongodb.somedomain</span> <span class="comment"># not used</span></span><br><span class="line">  <span class="attr">addresses:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">192.192</span><span class="number">.192</span><span class="number">.192</span><span class="string">/24</span> <span class="comment"># VIPs</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">27018</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">MONGO</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_INTERNAL</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">STATIC</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">3.3</span><span class="number">.3</span><span class="number">.3</span></span><br></pre></td></tr></table></figure><p>ç›¸å…³è”çš„ DestinationRuleã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mtls-mongocluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">mymongodb.somedomain</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">MUTUAL</span></span><br><span class="line">      <span class="attr">clientCertificate:</span> <span class="string">/etc/certs/myclientcert.pem</span></span><br><span class="line">      <span class="attr">privateKey:</span> <span class="string">/etc/certs/client_private_key.pem</span></span><br><span class="line">      <span class="attr">caCertificates:</span> <span class="string">/etc/certs/rootcacerts.pem</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹ç»“åˆä½¿ç”¨ VirtualService ä¸­çš„ ServiceEntry å’Œ TLS è·¯ç”±ï¼Œæ ¹æ® SNI å€¼å°†æµé‡å¼•å¯¼è‡³å†…éƒ¨å‡ºå£é˜²ç«å¢™ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-redirect</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wikipedia.org</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*.wikipedia.org&quot;</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TLS</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">NONE</span></span><br></pre></td></tr></table></figure><p>åŸºäº SNI å€¼è·¯ç”±çš„ç›¸å…³è”çš„ VirtualServiceã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tls-routing</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wikipedia.org</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*.wikipedia.org&quot;</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">sniHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wikipedia.org</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;*.wikipedia.org&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">internal-egress-firewall.ns1.svc.cluster.local</span></span><br></pre></td></tr></table></figure><p>å…·æœ‰ TLS åŒ¹é…çš„ Virtual Service ç”¨äºè¦†ç›–é»˜è®¤çš„ SNI åŒ¹é…ã€‚åœ¨æ²¡æœ‰ Virtual Service çš„æƒ…å†µä¸‹ï¼Œæµé‡å°†è¢«è½¬å‘åˆ° wikipedia ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹ä¸­æ¼”ç¤ºäº†ä½¿ç”¨ä¸“ç”¨å‡ºå£ç½‘å…³ï¼Œé€šè¿‡è¯¥ç½‘å…³è½¬å‘æ‰€æœ‰å¤–éƒ¨æœåŠ¡æµé‡ã€‚ â€œexportToâ€ å­—æ®µå…è®¸æ§åˆ¶æœåŠ¡å£°æ˜å¯¹ç½‘æ ¼ä¸­å…¶ä»–å‘½åç©ºé—´çš„å¯è§æ€§ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡ä¼šå¯¼å‡ºåˆ°æ‰€æœ‰å‘½åç©ºé—´ã€‚ä¸‹é¢çš„ä¾‹å­é™åˆ¶äº†å½“å‰å‘½åç©ºé—´çš„å¯è§æ€§ï¼Œç”¨ â€œ.â€ è¡¨ç¤ºï¼Œæ‰€ä»¥å®ƒä¸èƒ½è¢«å…¶ä»–å‘½åç©ºé—´ä½¿ç”¨ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-httpbin</span></span><br><span class="line">  <span class="attr">namespace :</span> <span class="string">egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">example.com</span></span><br><span class="line">  <span class="attr">exportTo:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰ä¸€ä¸ª Gateway æ¥å¤„ç†æ‰€æœ‰å‡ºå£æµé‡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">istio-egressgateway</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">istio:</span> <span class="string">egressgateway</span></span><br><span class="line"> <span class="attr">servers:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">     <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">     <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">   <span class="attr">hosts:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><p>å…³è”çš„ VirtualService ä» Sidecar è·¯ç”±åˆ°ç½‘å…³æœåŠ¡ï¼ˆistio-egressgateway.istio-system.svc.cluster.localï¼‰ï¼ŒåŒæ ·çš„ä» Gateway è·¯ç”±åˆ°å¤–éƒ¨æœåŠ¡ã€‚VirtualService è¢«å¯¼å‡ºåˆ°æ‰€æœ‰å‘½åç©ºé—´ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿé€šè¿‡ Gateway å°†æµé‡è·¯ç”±åˆ°å¤–éƒ¨æœåŠ¡ã€‚åƒè¿™æ ·å¼ºåˆ¶æµé‡é€šè¿‡æ‰˜ç®¡ä¸­é—´ä»£ç†æ˜¯ä¸€ç§å¸¸è§åšæ³•ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gateway-routing</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">egress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">example.com</span></span><br><span class="line">  <span class="attr">exportTo:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mesh</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">istio-egressgateway</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">gateways:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mesh</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">istio-egressgateway.istio-system.svc.cluster.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">gateways:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">istio-egressgateway</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">example.com</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†åœ¨ä¸»æœºä¸­ä¸ºå¤–éƒ¨æœåŠ¡ä½¿ç”¨é€šé…ç¬¦ã€‚å¦‚æœå¿…é¡»å°†è¿æ¥è·¯ç”±åˆ°åº”ç”¨ç¨‹åºè¯·æ±‚çš„ IP åœ°å€ï¼ˆå³åº”ç”¨ç¨‹åºè§£æ DNS å¹¶å°è¯•è¿æ¥åˆ°ç‰¹å®š IPï¼‰ï¼Œåˆ™å¿…é¡»å°† resolution è®¾ç½®ä¸º NONEã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-wildcard-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*.bar.com&quot;</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">NONE</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¯é€šè¿‡å®¢æˆ·ç«¯ä¸»æœºä¸Šçš„ Unix åŸŸå¥—æ¥å­—è·å¾—çš„æœåŠ¡ã€‚resolution å¿…é¡»è®¾ç½®ä¸º STATIC æ‰èƒ½ä½¿ç”¨ Unix åœ°å€ endpointã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">unix-domain-socket-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;example.unix.local&quot;</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">STATIC</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">unix:///var/run/example/socket</span></span><br></pre></td></tr></table></figure><p>å¯¹äºåŸºäº HTTP çš„æœåŠ¡ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªç”±å¤šä¸ª DNS å¯å¯»å€ endpoint æ”¯æŒçš„ VirtualServiceã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ HTTP_PROXY ç¯å¢ƒå˜é‡é€æ˜åœ°å°† VirtualService çš„ API è°ƒç”¨é‡æ–°è·¯ç”±åˆ°é€‰å®šçš„åç«¯ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹é…ç½®åˆ›å»ºäº†ä¸€ä¸ªåä¸º foo.bar.com çš„ä¸å­˜åœ¨çš„å¤–éƒ¨æœåŠ¡ï¼Œåç«¯ï¼šus.foo.bar.com:8080ã€uk.foo.bar.com:9080 å’Œ in.foo.bar.com:7080ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-dns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">foo.bar.com</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">us.foo.bar.com</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="attr">http:</span> <span class="number">8080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">uk.foo.bar.com</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="attr">http:</span> <span class="number">9080</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">in.foo.bar.com</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="attr">http:</span> <span class="number">7080</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ HTTP_PROXY&#x3D;<a href="http://localhost/%EF%BC%8C%E4%BB%8E%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%88%B0">http://localhost/ï¼Œä»åº”ç”¨ç¨‹åºåˆ°</a> <a href="http://foo.bar.com/">http://foo.bar.com</a> çš„è°ƒç”¨å°†åœ¨ä¸Šé¢æŒ‡å®šçš„ä¸‰ä¸ªåŸŸä¹‹é—´è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹ <a href="http://foo.bar.com/baz">http://foo.bar.com/baz</a> çš„è°ƒç”¨å°†è¢«è½¬æ¢ä¸º <a href="http://uk.foo.bar.com/baz%E3%80%82">http://uk.foo.bar.com/bazã€‚</a></p><p>ä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†åŒ…å« subjectAltNames çš„ ServiceEntry çš„ç”¨æ³•ï¼Œè¯¥åç§°çš„æ ¼å¼ç¬¦åˆ SPIFFE æ ‡å‡†ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line">  <span class="attr">namespace :</span> <span class="string">httpbin-ns</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">example.com</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_INTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">STATIC</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">3.3</span><span class="number">.3</span><span class="number">.3</span></span><br><span class="line">  <span class="attr">subjectAltNames:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;spiffe://cluster.local/ns/httpbin-ns/sa/httpbin-service-account&quot;</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†ä½¿ç”¨ ServiceEntry å’Œ workloadSelector æ¥å¤„ç†æœåŠ¡ details.bookinfo.com ä» VM åˆ° Kubernetes çš„è¿ç§»ã€‚è¯¥æœåŠ¡æœ‰ä¸¤ä¸ªåŸºäº VM çš„å®ä¾‹å’Œ Sidecarï¼Œä»¥åŠä¸€ç»„ç”±æ ‡å‡†éƒ¨ç½²å¯¹è±¡ç®¡ç†çš„ Kubernetes Podã€‚ç½‘æ ¼ä¸­æ­¤æœåŠ¡çš„ä½¿ç”¨è€…å°†åœ¨ VM å’Œ Kubernetes ä¹‹é—´è‡ªåŠ¨è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚ç”¨äº details.bookinfo.com æœåŠ¡çš„ VMã€‚æ­¤ VM å·²ä½¿ç”¨ details-legacy Service Account å®‰è£…å’Œå¼•å¯¼ Sidecarã€‚ Sidecar åœ¨ç«¯å£ 80 ä¸Šæ¥æ”¶ HTTP æµé‡ï¼ˆåŒ…è£…åœ¨ istio åŒå‘ TLS ä¸­ï¼‰å¹¶å°†å…¶è½¬å‘åˆ°åŒä¸€ç«¯å£ä¸Š localhost ä¸Šçš„åº”ç”¨ç¨‹åºã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkloadEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-vm-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">details</span></span><br><span class="line">  <span class="attr">address:</span> <span class="number">2.2</span><span class="number">.2</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">details</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">vm1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">WorkloadEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-vm-2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">details</span></span><br><span class="line">  <span class="attr">address:</span> <span class="number">3.3</span><span class="number">.3</span><span class="number">.3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">details</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">vm2</span></span><br></pre></td></tr></table></figure><p>å‡è®¾è¿˜æœ‰ä¸€ä¸ª Deployment å¸¦æœ‰ Pod æ ‡ç­¾ app: details ä½¿ç”¨ç›¸åŒçš„ ServiceAccountï¼ˆå³ detailsï¼‰ï¼Œä»¥ä¸‹ ServiceEntry å£°æ˜äº†ä¸€ä¸ªè·¨ VM å’Œ Kubernetes çš„æœåŠ¡ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">details-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">details.bookinfo.com</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_INTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">STATIC</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">details</span></span><br></pre></td></tr></table></figure><h1 id="ServiceEntry"><a href="#ServiceEntry" class="headerlink" title="ServiceEntry"></a>ServiceEntry</h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>hosts</td><td>ä¸ ServiceEntry å…³è”çš„ä¸»æœºã€‚å¯ä»¥æ˜¯å¸¦æœ‰é€šé…ç¬¦å‰ç¼€çš„ DNS åç§°ã€‚<br />- hosts å­—æ®µç”¨äºåœ¨ VirtualServices å’Œ DestinationRules ä¸­é€‰æ‹©åŒ¹é…çš„ä¸»æœº<br />- å¯¹äº HTTP æµé‡ï¼ŒHTTP Host&#x2F;Authority æ ‡å¤´å°†ä¸ hosts å­—æ®µåŒ¹é…<br />- å¯¹äºåŒ…å«æœåŠ¡å™¨åç§°æŒ‡ç¤ºï¼ˆSNIï¼‰ çš„ HTTPs æˆ– TLS æµé‡ï¼ŒSNI å€¼å°†ä¸ hosts å­—æ®µåŒ¹é…<br /><br />NOTEï¼š<br />- å½“è§£æè®¾ç½®ä¸º DNS ç±»å‹ä¸”æœªæŒ‡å®š endpoint æ—¶ï¼Œä¸»æœºå­—æ®µå°†ç”¨ä½œå°†æµé‡è·¯ç”±åˆ°çš„ endpoint çš„ DNS åç§°<br />- å¦‚æœä¸»æœºåä¸å¦ä¸€ä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åç§°åŒ¹é…ï¼Œä¾‹å¦‚ Kubernetesï¼Œå®ƒä¹Ÿæä¾›è‡ªå·±çš„ä¸€ç»„ endpointï¼Œåˆ™ ServiceEntry å°†è¢«è§†ä¸ºç°æœ‰ Kubernetes æœåŠ¡çš„è£…é¥°å™¨ã€‚å¦‚æœé€‚ç”¨ï¼ŒService Entry ä¸­çš„å±æ€§å°†æ·»åŠ åˆ° Kubernetes æœåŠ¡ä¸­ã€‚ç›®å‰ï¼Œistiod åªä¼šè€ƒè™‘ä»¥ä¸‹é™„åŠ å±æ€§ï¼š<br />- subjectAltNamesï¼šé™¤äº†éªŒè¯ä¸æœåŠ¡çš„ pod å…³è”çš„æœåŠ¡å¸æˆ·çš„ SAN ä¹‹å¤–ï¼Œè¿˜å°†éªŒè¯æ­¤å¤„æŒ‡å®šçš„ SAN</td></tr><tr><td>addresses</td><td>ä¸æœåŠ¡å…³è”çš„è™šæ‹Ÿ IP åœ°å€ã€‚å¯èƒ½æ˜¯ CIDR å‰ç¼€ã€‚å¯¹äº HTTP æµé‡ï¼Œç”Ÿæˆçš„è·¯ç”±é…ç½®å°†åŒ…æ‹¬åœ°å€å’Œä¸»æœºå­—æ®µå€¼çš„ http è·¯ç”±åŸŸï¼Œå¹¶ä¸”å°†æ ¹æ® HTTP Host&#x2F;Authority æ ‡å¤´è¯†åˆ«ç›®æ ‡ã€‚å¦‚æœæŒ‡å®šäº†ä¸€ä¸ªæˆ–å¤šä¸ª IP åœ°å€ï¼Œå¦‚æœç›®æ ‡ IP ä¸åœ°å€å­—æ®µä¸­æŒ‡å®šçš„ IP&#x2F;CIDR åŒ¹é…ï¼Œåˆ™ä¼ å…¥æµé‡å°†è¢«æ ‡è¯†ä¸ºå±äºæ­¤æœåŠ¡ã€‚å¦‚æœåœ°å€å­—æ®µä¸ºç©ºï¼Œåˆ™å°†ä»…æ ¹æ®ç›®æ ‡ç«¯å£è¯†åˆ«æµé‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡è¢«è®¿é—®çš„ç«¯å£ä¸èƒ½è¢«ç½‘æ ¼ä¸­çš„ä»»ä½•å…¶ä»–æœåŠ¡å…±äº«ã€‚æ¢å¥è¯è¯´ï¼ŒSidecar å°†å……å½“ç®€å•çš„ TCP ä»£ç†ï¼Œå°†æŒ‡å®šç«¯å£ä¸Šçš„ä¼ å…¥æµé‡è½¬å‘åˆ°æŒ‡å®šçš„ç›®æ ‡ endpoint IP&#x2F;ä¸»æœºã€‚æ­¤å­—æ®µä¸æ”¯æŒ Unix åŸŸå¥—æ¥å­—åœ°å€</td></tr><tr><td>ports</td><td>ä¸å¤–éƒ¨æœåŠ¡å…³è”çš„ç«¯å£ã€‚å¦‚æœ endpoint æ˜¯ Unix åŸŸå¥—æ¥å­—åœ°å€ï¼Œåˆ™å¿…é¡»åªæœ‰ä¸€ä¸ªç«¯å£</td></tr><tr><td><a href="#ServiceEntry.Location">location</a></td><td>æŒ‡å®šæ˜¯å¦åº”å°†æœåŠ¡è§†ä¸ºç½‘æ ¼å¤–éƒ¨æˆ–ç½‘æ ¼çš„ä¸€éƒ¨åˆ†</td></tr><tr><td><a href="#ServiceEntry.Resolution">resolution</a></td><td>ä¸»æœºçš„æœåŠ¡å‘ç°æ¨¡å¼ã€‚ä¸ºæ²¡æœ‰é™„å¸¦ IP åœ°å€çš„ TCP ç«¯å£è®¾ç½®è§£ææ¨¡å¼ä¸º NONE æ—¶éœ€è¦æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å…è®¸åˆ°æ‰€è¿°ç«¯å£ä¸Šçš„ä»»ä½• IP çš„æµé‡ï¼ˆå³ 0.0.0.0:&lt;port&gt;ï¼‰</td></tr><tr><td>endpoints</td><td>ä¸æœåŠ¡å…³è”çš„ä¸€ä¸ªæˆ–å¤šä¸ª endpointã€‚åªèƒ½æŒ‡å®š endpoints æˆ– workloadSelector ä¹‹ä¸€</td></tr><tr><td>workloadSelector</td><td>ä»…é€‚ç”¨äº MESH_INTERNAL æœåŠ¡ã€‚åªèƒ½æŒ‡å®š endpoint æˆ–å·¥ä½œè´Ÿè½½é€‰æ‹©å™¨ä¹‹ä¸€ã€‚æ ¹æ®æ ‡ç­¾é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ª Kubernetes Pod æˆ– VM å·¥ä½œè´Ÿè½½ï¼ˆä½¿ç”¨ WorkloadEntry æŒ‡å®šï¼‰ã€‚è¡¨ç¤º VM çš„ WorkloadEntry å¯¹è±¡åº”ä¸ ServiceEntry å®šä¹‰åœ¨ç›¸åŒçš„å‘½åç©ºé—´ä¸­</td></tr><tr><td>exportTo</td><td>æ­¤æœåŠ¡å¯¼å‡ºåˆ°çš„å‘½åç©ºé—´åˆ—è¡¨ã€‚å¯¼å‡ºæœåŠ¡å…è®¸å®ƒè¢«å…¶ä»–å‘½åç©ºé—´ä¸­å®šä¹‰çš„ Sidecarã€Gateway å’Œ VirtualService ä½¿ç”¨ã€‚æ­¤åŠŸèƒ½ä¸ºæœåŠ¡æ‰€æœ‰è€…å’Œç½‘æ ¼ç®¡ç†å‘˜æä¾›äº†ä¸€ç§æœºåˆ¶æ¥æ§åˆ¶è·¨å‘½åç©ºé—´è¾¹ç•Œçš„æœåŠ¡çš„å¯è§æ€§ã€‚<br />å¦‚æœæœªæŒ‡å®šå‘½åç©ºé—´ï¼Œåˆ™é»˜è®¤å°†æœåŠ¡å¯¼å‡ºåˆ°æ‰€æœ‰å‘½åç©ºé—´ã€‚<br /> â€.â€ ä¿ç•™è¯­ä¹‰è¡¨ç¤ºå¯¼å‡ºåˆ°å£°æ˜æœåŠ¡çš„åŒä¸€å‘½åç©ºé—´ã€‚ç±»ä¼¼åœ°ï¼Œâ€œ*â€ ä¿ç•™è¯­ä¹‰å®šä¹‰å¯¼å‡ºåˆ°æ‰€æœ‰å‘½åç©ºé—´ã€‚<br />å¯¹äº Kubernetes Serviceï¼Œå¯ä»¥é€šè¿‡å°†æ³¨è§£ networking.istio.io&#x2F;exportTo è®¾ç½®ä¸ºä»¥é€—å·åˆ†éš”çš„å‘½åç©ºé—´åç§°åˆ—è¡¨æ¥å®ç°ç­‰æ•ˆæ•ˆæœ</td></tr><tr><td>subjectAltNames</td><td>å¦‚æœæŒ‡å®šï¼Œä»£ç†å°†éªŒè¯æœåŠ¡å™¨è¯ä¹¦çš„ subject alternate name æ˜¯å¦ä¸æŒ‡å®šå€¼ä¹‹ä¸€åŒ¹é…ã€‚<br />æ³¨æ„ï¼šå°† workloadEntry  ä¸ workloadSelector ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒworkloadEntry ä¸­æŒ‡å®šçš„ ServiceAccount ä¹Ÿå°†ç”¨äºæ´¾ç”Ÿåº”éªŒè¯çš„å…¶ä»– subject alternate name</td></tr></tbody></table><h1 id="ServiceEntry-Location"><a href="#ServiceEntry-Location" class="headerlink" title="ServiceEntry.Location"></a><a name="ServiceEntry.Location">ServiceEntry.Location</a></h1><p>location æŒ‡å®šæœåŠ¡æ˜¯ Istio ç½‘æ ¼çš„ä¸€éƒ¨åˆ†è¿˜æ˜¯ç½‘æ ¼ä¹‹å¤–ã€‚location å†³å®šäº†å‡ ä¸ªç‰¹æ€§çš„è¡Œä¸ºï¼Œä¾‹å¦‚æœåŠ¡åˆ°æœåŠ¡çš„ mTLS èº«ä»½éªŒè¯ã€ç­–ç•¥æ‰§è¡Œç­‰ã€‚å½“ä¸ç½‘æ ¼å¤–çš„æœåŠ¡é€šä¿¡æ—¶ï¼ŒIstio çš„ mTLS èº«ä»½éªŒè¯è¢«ç¦ç”¨ï¼Œå¹¶ä¸”ç­–ç•¥æ‰§è¡Œåœ¨å®¢æˆ·ç«¯æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨æœåŠ¡ç«¯ã€‚</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>MESH_EXTERNAL</td><td>è¡¨ç¤ºæœåŠ¡åœ¨ç½‘æ ¼å¤–éƒ¨ã€‚é€šå¸¸ç”¨äºæŒ‡ç¤ºé€šè¿‡ API ä½¿ç”¨çš„å¤–éƒ¨æœåŠ¡</td></tr><tr><td>MESH_INTERNAL</td><td>è¡¨ç¤ºæœåŠ¡æ˜¯ç½‘æ ¼çš„ä¸€éƒ¨åˆ†ã€‚é€šå¸¸ç”¨äºæŒ‡ç¤ºä½œä¸ºæ‰©å±•æœåŠ¡ç½‘æ ¼ä»¥åŒ…æ‹¬éæ‰˜ç®¡åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†è€Œæ˜¾å¼æ·»åŠ çš„æœåŠ¡ï¼ˆä¾‹å¦‚ï¼Œæ·»åŠ åˆ°åŸºäº Kubernetes çš„æœåŠ¡ç½‘æ ¼çš„è™šæ‹Ÿæœºï¼‰</td></tr></tbody></table><h1 id="ServiceEntry-Resolution"><a href="#ServiceEntry-Resolution" class="headerlink" title="ServiceEntry.Resolution"></a><a name="ServiceEntry.Resolution">ServiceEntry.Resolution</a></h1><p>resolution å†³å®šä»£ç†å°†å¦‚ä½•è§£æä¸æœåŠ¡å…³è”çš„ç½‘ç»œ endpoint çš„ IP åœ°å€ï¼Œä»¥ä¾¿å®ƒå¯ä»¥è·¯ç”±åˆ°å…¶ä¸­ä¸€ä¸ªã€‚æ­¤å¤„æŒ‡å®šçš„è§£ææ¨¡å¼å¯¹åº”ç”¨ç¨‹åºå¦‚ä½•è§£æä¸æœåŠ¡å…³è”çš„ IP åœ°å€æ²¡æœ‰å½±å“ã€‚åº”ç”¨ç¨‹åºå¯èƒ½ä»éœ€è¦ä½¿ç”¨ DNS å°†æœåŠ¡è§£æä¸º IPï¼Œä»¥ä¾¿ä»£ç†å¯ä»¥æ•è·å‡ºç«™æµé‡ã€‚æˆ–è€…ï¼Œå¯¹äº HTTP æœåŠ¡ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥ä¸ä»£ç†é€šä¿¡ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡è®¾ç½® HTTP_PROXYï¼‰æ¥ä¸è¿™äº›æœåŠ¡é€šä¿¡ã€‚</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>NONE</td><td>å‡è®¾ä¼ å…¥çš„è¿æ¥å·²ç»è¢«è§£æï¼ˆåˆ°ç‰¹å®šçš„ç›®æ ‡ IP åœ°å€ï¼‰ã€‚æ­¤ç±»è¿æ¥é€šå¸¸ä½¿ç”¨ IP è¡¨ REDIRECT&#x2F;eBPF ç­‰æœºåˆ¶é€šè¿‡ä»£ç†è¿›è¡Œè·¯ç”±ã€‚åœ¨æ‰§è¡Œä»»ä½•ä¸è·¯ç”±ç›¸å…³çš„è½¬æ¢åï¼Œä»£ç†ä¼šå°†è¿æ¥è½¬å‘åˆ°è¿æ¥ç»‘å®šçš„ IP åœ°å€</td></tr><tr><td>STATIC</td><td>ä½¿ç”¨ endpoint ä¸­æŒ‡å®šçš„é™æ€ IP åœ°å€ï¼ˆè§ä¸‹æ–‡ï¼‰ä½œä¸ºä¸æœåŠ¡å…³è”çš„æ”¯æŒå®ä¾‹</td></tr><tr><td>DNS</td><td>å°è¯•é€šè¿‡å¼‚æ­¥æŸ¥è¯¢ç¯å¢ƒ DNS æ¥è§£æ IP åœ°å€ã€‚å¦‚æœæœªæŒ‡å®š endpointï¼Œåˆ™ä»£ç†å°†è§£æä¸»æœºå­—æ®µä¸­æŒ‡å®šçš„ DNS åœ°å€ï¼ˆå¦‚æœæœªä½¿ç”¨é€šé…ç¬¦ï¼‰ã€‚å¦‚æœæŒ‡å®šäº† endpointï¼Œåˆ™å°†è§£æ endpoint ä¸­æŒ‡å®šçš„ DNS åœ°å€ä»¥ç¡®å®šç›®æ ‡ IP åœ°å€ã€‚ DNS è§£æä¸èƒ½ä¸ Unix åŸŸå¥—æ¥å­— endpoint ä¸€èµ·ä½¿ç”¨</td></tr><tr><td>DNS_ROUND_ROBIN</td><td>å°è¯•é€šè¿‡å¼‚æ­¥æŸ¥è¯¢ç¯å¢ƒ DNS æ¥è§£æ IP åœ°å€ã€‚ä¸ DNS ä¸åŒï¼ŒDNS_ROUND_ROBIN ä»…åœ¨éœ€è¦å¯åŠ¨æ–°è¿æ¥æ—¶ä½¿ç”¨è¿”å›çš„ç¬¬ä¸€ä¸ª IP åœ°å€ï¼Œè€Œä¸ä¾èµ–äº DNS è§£æçš„å®Œæ•´ç»“æœï¼Œå³ä½¿ DNS è®°å½•é¢‘ç¹æ›´æ”¹ï¼Œä¸ä¸»æœºå»ºç«‹çš„è¿æ¥ä¹Ÿå°†è¢«ä¿ç•™ï¼Œä»è€Œæ¶ˆé™¤äº†è€—å°½è¿æ¥æ± å’Œè¿æ¥å¾ªç¯ã€‚è¿™æœ€é€‚åˆå¿…é¡»é€šè¿‡ DNS è®¿é—®çš„å¤§å‹ Web è§„æ¨¡æœåŠ¡ã€‚å¦‚æœä¸ä½¿ç”¨é€šé…ç¬¦ï¼Œä»£ç†å°†è§£æä¸»æœºå­—æ®µä¸­æŒ‡å®šçš„ DNS åœ°å€ã€‚ DNS è§£æä¸èƒ½ä¸ Unix åŸŸå¥—æ¥å­— endpoint ä¸€èµ·ä½¿ç”¨</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†åœºæ™¯ä¸‹çš„ ServiceEntry èµ„æºå¯¹è±¡ä½¿ç”¨èŒƒä¾‹ä¸ API ç»“æ„æ¦‚è§ˆ</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” DestinationRule</title>
    <link href="http://shenxianghong.github.io/2022/08/09/2022-08-09%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Destination%20Rule/"/>
    <id>http://shenxianghong.github.io/2022/08/09/2022-08-09%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Destination%20Rule/</id>
    <published>2022-08-08T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.256Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>DestinationRule å®šä¹‰äº†åœ¨è·¯ç”±å‘ç”Ÿååº”ç”¨äºæœåŠ¡çš„æµé‡çš„ç­–ç•¥ã€‚è¿™äº›è§„åˆ™æŒ‡å®šè´Ÿè½½å‡è¡¡çš„é…ç½®ã€sidecar çš„è¿æ¥æ± å¤§å°ä»¥åŠå¼‚å¸¸å€¼æ£€æµ‹è®¾ç½®ï¼Œç”¨æ¥æ£€æµ‹ã€é©±é€è´Ÿè½½å‡è¡¡æ± ä¸­ä¸å¥åº·çš„åç«¯ã€‚</p><p>ä¾‹å¦‚ï¼Œreview æœåŠ¡çš„ç®€å•è´Ÿè½½å‡è¡¡ç­–ç•¥å¦‚ä¸‹ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">LEAST_REQUEST</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡å®šä¹‰ subset è¦†ç›–åœ¨æœåŠ¡çº§åˆ«æŒ‡å®šçš„è®¾ç½®æ¥æŒ‡å®šç‰ˆæœ¬ç‰¹å®šç­–ç•¥ã€‚</p><p>ä»¥ä¸‹è§„åˆ™å¯¹æµå‘åä¸º testversion çš„å­é›†çš„æ‰€æœ‰æµé‡ä½¿ç”¨ ROUND_ROBIN è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">LEAST_REQUEST</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testversion</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v3</span></span><br><span class="line">    <span class="attr">trafficPolicy:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">simple:</span> <span class="string">ROUND_ROBIN</span></span><br></pre></td></tr></table></figure><p><em>æ³¨æ„ï¼šä¸ºå­é›†æŒ‡å®šçš„ç­–ç•¥åœ¨è·¯ç”±è§„åˆ™æ˜ç¡®å‘è¯¥å­é›†å‘é€æµé‡ä¹‹å‰ä¸ä¼šç”Ÿæ•ˆã€‚</em></p><p>æµé‡ç­–ç•¥ä¹Ÿå¯ä»¥é’ˆå¯¹ç‰¹å®šç«¯å£è¿›è¡Œå®šåˆ¶ã€‚ä»¥ä¸‹è§„åˆ™å¯¹æµå‘ç«¯å£ 80 çš„æ‰€æœ‰æµé‡ä½¿ç”¨ LEAST_REQUEST è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œè€Œå¯¹æµå‘ç«¯å£ 9080 çš„æµé‡ä½¿ç”¨ ROUND_ROBIN  è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-ratings-port</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span> <span class="comment"># Apply to all ports</span></span><br><span class="line">    <span class="attr">portLevelSettings:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">simple:</span> <span class="string">LEAST_REQUEST</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">simple:</span> <span class="string">ROUND_ROBIN</span></span><br></pre></td></tr></table></figure><p>ç›®æ ‡è§„åˆ™ä¹Ÿå¯ä»¥é’ˆå¯¹ç‰¹å®šçš„å·¥ä½œè´Ÿè½½è¿›è¡Œå®šåˆ¶ã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºäº†å¦‚ä½•ä½¿ç”¨å·¥ä½œè´Ÿè½½é€‰æ‹©å™¨å°†ç›®æ ‡è§„åˆ™åº”ç”¨äºç‰¹å®šå·¥ä½œè´Ÿè½½ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configure-client-mtls-dr-with-workloadselector</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">workloadSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ratings</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">ROUND_ROBIN</span></span><br><span class="line">    <span class="attr">portLevelSettings:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">31443</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="attr">credentialName:</span> <span class="string">client-credential</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">MUTUAL</span></span><br></pre></td></tr></table></figure><h1 id="DestinationRule"><a href="#DestinationRule" class="headerlink" title="DestinationRule"></a>DestinationRule</h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>host</td><td>æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡åç§°ã€‚æœåŠ¡åç§°ä»å¹³å°çš„æœåŠ¡æ³¨å†Œè¡¨ï¼ˆä¾‹å¦‚ï¼ŒKubernetes æœåŠ¡ã€Consul æœåŠ¡ç­‰ï¼‰å’Œ ServiceEntry å£°æ˜çš„ host ä¸­æŸ¥æ‰¾ã€‚ä¸¤è€…éƒ½æ‰¾ä¸åˆ°çš„æµé‡å°†è¢«ä¸¢å¼ƒã€‚<br /><em>åŒæ ·çš„ï¼Œæ¨èä½¿ç”¨å®Œå…¨é™å®šåŸŸåï¼Œhost å­—æ®µé€‚ç”¨äº HTTP å’Œ TCP çš„æœåŠ¡</em></td></tr><tr><td><a href="#TrafficPolicy">trafficPolicy</a></td><td>è¦åº”ç”¨çš„æµé‡ç­–ç•¥ï¼ˆè´Ÿè½½å‡è¡¡ç­–ç•¥ã€è¿æ¥æ± å¤§å°ã€å¼‚å¸¸å€¼æ£€æµ‹ï¼‰</td></tr><tr><td><a href="#Subset">subsets</a></td><td>ä¸€ä¸ªæˆ–å¤šä¸ªå‘½åé›†ï¼Œä»£è¡¨æœåŠ¡çš„å„ä¸ªç‰ˆæœ¬ã€‚æµé‡ç­–ç•¥å¯ä»¥åœ¨å­é›†çº§åˆ«è¢«è¦†ç›–</td></tr><tr><td>exportTo</td><td>æ­¤ VirtualService æš´éœ²åˆ°çš„å‘½åç©ºé—´åˆ—è¡¨ã€‚æš´éœ² VirtualService å…è®¸å®ƒè¢«å…¶ä»–å‘½åç©ºé—´ä¸­å®šä¹‰çš„ sidecar å’Œ Gateway ä½¿ç”¨ã€‚æ­¤åŠŸèƒ½ä¸ºæœåŠ¡æ‰€æœ‰è€…å’Œç½‘æ ¼ç®¡ç†å‘˜æä¾›äº†ä¸€ç§æœºåˆ¶æ¥æ§åˆ¶è·¨å‘½åç©ºé—´è¾¹ç•Œçš„ VirtualService çš„å¯è§æ€§<br />å¦‚æœæœªæŒ‡å®šå‘½åç©ºé—´ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹å°† VirtualService æš´éœ²åˆ°æ‰€æœ‰å‘½åç©ºé—´<br /> . ä¸ºä¿ç•™æ ‡è¯†ä»£è¡¨æš´éœ²åˆ° VirtualService çš„åŒä¸€å‘½åç©ºé—´ä¸­ã€‚ç±»ä¼¼åœ°ï¼Œ* ä»£è¡¨æš´éœ²åˆ°æ‰€æœ‰å‘½åç©ºé—´</td></tr><tr><td>workloadSelector</td><td>ç”¨äºé€‰æ‹©åº”ç”¨æ­¤ DestinationRule é…ç½®çš„ç‰¹å®š pod&#x2F;VM é›†çš„æ¡ä»¶ã€‚å¦‚æœæŒ‡å®šï¼Œåˆ™ DestinationRule é…ç½®å°†ä»…åº”ç”¨äºä¸åŒä¸€å‘½åç©ºé—´ä¸­çš„é€‰æ‹©å™¨æ ‡ç­¾åŒ¹é…çš„å·¥ä½œè´Ÿè½½å®ä¾‹ã€‚å·¥ä½œè´Ÿè½½é€‰æ‹©å™¨ä¸é€‚ç”¨äºè·¨å‘½åç©ºé—´ã€‚å¦‚æœçœç•¥ï¼ŒDestinationRule å°†å›é€€åˆ°å…¶é»˜è®¤è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œå¦‚æœç‰¹å®šçš„ sidecar éœ€è¦ä¸ºç½‘æ ¼å¤–çš„æœåŠ¡è®¾ç½®å‡ºå£ TLS è®¾ç½®ï¼Œè€Œä¸æ˜¯ç½‘æ ¼ä¸­çš„æ¯ä¸ª sidecar éƒ½éœ€è¦é…ç½®ï¼ˆè¿™æ˜¯é»˜è®¤è¡Œä¸ºï¼‰ï¼Œåˆ™å¯ä»¥æŒ‡å®šå·¥ä½œè´Ÿè½½é€‰æ‹©å™¨</td></tr></tbody></table><h1 id="TrafficPolicy"><a href="#TrafficPolicy" class="headerlink" title="TrafficPolicy"></a><a name="TrafficPolicy">TrafficPolicy</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#LoadBalancerSettings">loadBalancer</a></td><td>è´Ÿè½½å‡è¡¡å™¨ç®—æ³•çš„è®¾ç½®</td></tr><tr><td><a href="#ConnectionPoolSettings">connectionPool</a></td><td>ä¸ä¸Šæ¸¸æœåŠ¡çš„è¿æ¥æ± çš„è®¾ç½®</td></tr><tr><td><a href="#OutlierDetection">outlierDetection</a></td><td>è´Ÿè½½å‡è¡¡æ± ä¸­é€å‡ºä¸å¥åº·åç«¯çš„è®¾ç½®</td></tr><tr><td><a href="#ClientTLSSettings">tls</a></td><td>ä¸ä¸Šæ¸¸æœåŠ¡è¿æ¥çš„ TLS ç›¸å…³è®¾ç½®</td></tr><tr><td><a href="#TrafficPolicy.PortTrafficPolicy">portLevelSettings</a></td><td>å„ä¸ªç«¯å£çš„æµé‡ç­–ç•¥ã€‚<br /><em>æ³¨æ„ï¼ŒportLevelSettings å°†è¦†ç›– destinationLevel è®¾ç½®ã€‚portLevelSettings æœªè®¾ç½®çš„éƒ¨åˆ†ï¼Œä¼šä»¥ destinationLevel  çº§åˆ«ä¸ºå‡†</em></td></tr><tr><td><a href="#TrafficPolicy.TunnelSettings">tunnel</a></td><td>åœ¨ DestinationRule ä¸­é…ç½®çš„ host çš„å…¶ä»–ä¼ è¾“å±‚æˆ–åº”ç”¨å±‚ä¸Šçš„éš§é“ TCP é…ç½®ã€‚éš§é“è®¾ç½®å¯ä»¥åº”ç”¨äº TCP æˆ– TLS è·¯ç”±ï¼Œä½†ä¸èƒ½åº”ç”¨äº HTTP è·¯ç”±</td></tr></tbody></table><h1 id="Subset"><a href="#Subset" class="headerlink" title="Subset"></a><a name="Subset">Subset</a></h1><p>Service çš„ endpoint çš„å­é›†ã€‚å­é›†å¯ç”¨äº A&#x2F;B æµ‹è¯•æˆ–è·¯ç”±åˆ°ç‰¹å®šæœåŠ¡ç‰ˆæœ¬ç­‰åœºæ™¯ã€‚æ­¤å¤–ï¼Œåœ¨ VirtualService çº§åˆ«å®šä¹‰çš„æµé‡ç­–ç•¥å¯ä»¥è¢«å­é›†çº§åˆ«è¦†ç›–ã€‚</p><p>é€šå¸¸éœ€è¦ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾æ¥æ ‡è¯†å­é›†ç›®çš„åœ°ï¼Œä½†æ˜¯ï¼Œå½“ç›¸åº”çš„ DestinationRule è¡¨ç¤ºæ”¯æŒå¤šä¸ª SNI ä¸»æœºçš„ä¸»æœºï¼ˆä¾‹å¦‚ï¼Œå‡ºå£ç½‘å…³ï¼‰æ—¶ï¼Œæ²¡æœ‰æ ‡ç­¾çš„å­é›†å¯èƒ½æ˜¯æœ‰æ„ä¹‰çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨å¸¦æœ‰ ClientTLSSettings çš„æµé‡ç­–ç•¥æ¥è¯†åˆ«ä¸å‘½åå­é›†ç›¸å¯¹åº”çš„ç‰¹å®š SNI ä¸»æœºã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>name</td><td>å­é›†çš„åç§°ã€‚æœåŠ¡åç§°å’Œå­é›†åç§°å¯ç”¨äºè·¯ç”±è§„åˆ™ä¸­çš„æµé‡æ‹†åˆ†</td></tr><tr><td>labels</td><td>æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ endpoint ä¸Šåº”ç”¨è¿‡æ»¤å™¨</td></tr><tr><td><a href="#TrafficPolicy">trafficPolicy</a></td><td>å­é›†çš„æµé‡ç­–ç•¥ã€‚å­é›†ä¼šç»§æ‰¿åœ¨ DestinationRule çº§åˆ«æŒ‡å®šçš„æµé‡ç­–ç•¥ï¼ŒåŒæ—¶ä¼šè¢«å­é›†çº§åˆ«æŒ‡å®šçš„è®¾ç½®è¦†ç›–</td></tr></tbody></table><h1 id="LoadBalancerSettings"><a href="#LoadBalancerSettings" class="headerlink" title="LoadBalancerSettings"></a><a name="LoadBalancerSettings">LoadBalancerSettings</a></h1><p>åº”ç”¨åˆ°ç‰¹å®šç›®çš„åœ°çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/load_balancing">Envoy çš„è´Ÿè½½å‡è¡¡æ–‡æ¡£</a>ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å¯¹æµå‘ ratings æœåŠ¡çš„æ‰€æœ‰æµé‡ä½¿ç”¨ ROUND_ROBIN è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">ROUND_ROBIN</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ç¤ºä¾‹å¯¹äºä½¿ç”¨ User cookie ä½œä¸ºå“ˆå¸Œé”®è®¿é—® rating æœåŠ¡è®¾ç½®ç²˜æ€§ä¼šè¯ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">consistentHash:</span></span><br><span class="line">        <span class="attr">httpCookie:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">user</span></span><br><span class="line">          <span class="attr">ttl:</span> <span class="string">0s</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#LoadBalancerSettings.SimpleLB">simple</a></td><td>å‚è€ƒ LoadBalancerSettings.SimpleLB è¯´æ˜</td></tr><tr><td><a href="#LoadBalancerSettings.ConsistentHashLB">consistentHash</a></td><td>å‚è€ƒ LoadBalancerSettings.ConsistentHashLB è¯´æ˜</td></tr><tr><td><a href="#LocalityLoadBalancerSetting">localityLbSetting</a></td><td>æœ¬åœ°è´Ÿè½½å‡è¡¡å™¨è®¾ç½®ï¼Œè¿™å°†å®Œå…¨è¦†ç›–ç½‘æ ¼èŒƒå›´çš„è®¾ç½®ï¼Œè¿™æ„å‘³ç€ä¸ä¼šåœ¨æ­¤å¯¹è±¡å’Œ MeshConfig ä¹‹é—´æ‰§è¡Œåˆå¹¶</td></tr><tr><td>warmupDurationSecs</td><td>è¡¨ç¤º Service çš„é¢„çƒ­æŒç»­æ—¶é—´ã€‚å¦‚æœè®¾ç½®ï¼Œåˆ™æ–°åˆ›å»ºçš„ service endpoint åœ¨æ­¤çª—å£æœŸé—´ä»å…¶åˆ›å»ºæ—¶é—´å¼€å§‹ä¿æŒé¢„çƒ­æ¨¡å¼ï¼Œå¹¶ä¸” Istio é€æ¸å¢åŠ è¯¥ endpoint çš„æµé‡ï¼Œè€Œä¸æ˜¯å‘é€æˆæ¯”ä¾‹çš„æµé‡ã€‚åº”è¯¥ä¸ºéœ€è¦é¢„çƒ­æ—¶é—´çš„åˆç†å»¶è¿ŸæœåŠ¡å®Œæ•´ç”Ÿäº§è´Ÿè½½çš„æœåŠ¡å¯ç”¨æ­¤åŠŸèƒ½ã€‚ç›®å‰åªæ”¯æŒ ROUND_ROBIN å’Œ LEAST_CONN è´Ÿè½½å‡è¡¡å™¨</td></tr></tbody></table><h1 id="ConnectionPoolSettings"><a href="#ConnectionPoolSettings" class="headerlink" title="ConnectionPoolSettings"></a><a name="ConnectionPoolSettings">ConnectionPoolSettings</a></h1><p>ä¸Šæ¸¸ä¸»æœºçš„è¿æ¥æ± è®¾ç½®ã€‚è¿™äº›è®¾ç½®é€‚ç”¨äºä¸Šæ¸¸æœåŠ¡ä¸­çš„æ¯ä¸ªå•ç‹¬çš„ä¸»æœºã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/circuit_breaking">Envoy çš„æ–­è·¯å™¨</a>ã€‚è¿æ¥æ± è®¾ç½®å¯ä»¥åº”ç”¨äº TCP çº§åˆ«ä»¥åŠ HTTP çº§åˆ«ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™è®¾ç½®äº† 100 ä¸ªè¿æ¥åˆ°åä¸º myredissrv çš„ redis æœåŠ¡çš„é™åˆ¶ï¼Œè¿æ¥è¶…æ—¶ä¸º 30 æ¯«ç§’ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-redis</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">myredissrv.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="string">30ms</span></span><br><span class="line">        <span class="attr">tcpKeepalive:</span></span><br><span class="line">          <span class="attr">time:</span> <span class="string">7200s</span></span><br><span class="line">          <span class="attr">interval:</span> <span class="string">75s</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#ConnectionPoolSettings.TCPSettings">tcp</a></td><td>HTTP å’Œ TCP ä¸Šæ¸¸è¿æ¥é€šç”¨çš„è®¾ç½®</td></tr><tr><td><a href="#ConnectionPoolSettings.HTTPSettings">http</a></td><td>HTTP è¿æ¥æ± è®¾ç½®</td></tr></tbody></table><h1 id="OutlierDetection"><a href="#OutlierDetection" class="headerlink" title="OutlierDetection"></a><a name="OutlierDetection">OutlierDetection</a></h1><p>ä¸€ç§æ–­è·¯å™¨å®ç°ï¼Œç”¨äºè·Ÿè¸ªä¸Šæ¸¸æœåŠ¡ä¸­æ¯ä¸ªå•ç‹¬ä¸»æœºçš„çŠ¶æ€ã€‚</p><p>é€‚ç”¨äº HTTP å’Œ TCP æœåŠ¡ã€‚</p><ul><li>å¯¹äº HTTP æœåŠ¡ï¼Œå¯¹äº API è°ƒç”¨æŒç»­è¿”å› 5xx é”™è¯¯çš„ä¸»æœºå°†åœ¨é¢„å®šä¹‰çš„æ—¶é—´æ®µå†…ä»æ± ä¸­å¼¹å‡º</li><li>å¯¹äº TCP æœåŠ¡ï¼Œåœ¨æµ‹é‡è¿ç»­é”™è¯¯æŒ‡æ ‡æ—¶ï¼Œä¸ç»™å®šä¸»æœºçš„è¿æ¥è¶…æ—¶æˆ–è¿æ¥å¤±è´¥å°†è®¡ä¸ºé”™è¯¯</li></ul><p>æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/outlier">Envoy çš„å¼‚å¸¸å€¼æ£€æµ‹</a>ã€‚</p><p>ä»¥ä¸‹è§„åˆ™å°†è¿æ¥æ± å¤§å°è®¾ç½®ä¸º 100 ä¸ª HTTP1 è¿æ¥ï¼Œå…¶ä¸­ reviews æœåŠ¡çš„å•è¿æ¥çš„è¯·æ±‚æœ€å¤§ä¸è¶…è¿‡ 10 ä¸ªã€‚æ­¤å¤–ï¼Œå®ƒè®¾ç½®äº† 1000 ä¸ªå¹¶å‘ HTTP2 è¯·æ±‚çš„é™åˆ¶ï¼Œå¹¶å°†ä¸Šæ¸¸ host é…ç½®ä¸ºæ¯ 5 åˆ†é’Ÿæ‰«æä¸€æ¬¡ï¼Œä»»ä½•è¿ç»­ 7 æ¬¡å¤±è´¥å¹¶å‡ºç° 502ã€503 æˆ– 504 é”™è¯¯ä»£ç çš„ host å°†è¢«å¼¹å‡º 15 åˆ†é’Ÿã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-cb-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">http2MaxRequests:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">maxRequestsPerConnection:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">outlierDetection:</span></span><br><span class="line">      <span class="attr">consecutive5xxErrors:</span> <span class="number">7</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">5m</span></span><br><span class="line">      <span class="attr">baseEjectionTime:</span> <span class="string">15m</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>splitExternalLocalOriginErrors</td><td>ç¡®å®šæ˜¯å¦åŒºåˆ†æœ¬åœ°æºæ•…éšœå’Œå¤–éƒ¨é”™è¯¯ã€‚å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™è¿ç»­_local_origin_failure è¢«è€ƒè™‘ç”¨äºå¼‚å¸¸å€¼æ£€æµ‹è®¡ç®—ã€‚å½“æ‚¨å¸Œæœ›æ ¹æ®æœ¬åœ°çœ‹åˆ°çš„é”™è¯¯ï¼ˆä¾‹å¦‚è¿æ¥å¤±è´¥ã€è¿æ¥è¶…æ—¶ç­‰ï¼‰è€Œä¸æ˜¯ä¸Šæ¸¸æœåŠ¡é‡æ–°è°ƒæ•´çš„çŠ¶æ€ç æ¥æ¨å¯¼å¼‚å¸¸æ£€æµ‹çŠ¶æ€æ—¶ï¼Œåº”è¯¥ä½¿ç”¨æ­¤é€‰é¡¹ã€‚å½“ä¸Šæ¸¸æœåŠ¡ä¸ºæŸäº›è¯·æ±‚æ˜¾å¼è¿”å› 5xx å¹¶ä¸”æ‚¨å¸Œæœ›åœ¨ç¡®å®šä¸»æœºçš„å¼‚å¸¸æ£€æµ‹çŠ¶æ€æ—¶å¿½ç•¥æ¥è‡ªä¸Šæ¸¸æœåŠ¡çš„è¿™äº›å“åº”æ—¶ï¼Œè¿™å°¤å…¶æœ‰ç”¨ã€‚é»˜è®¤ä¸ºå‡</td></tr><tr><td>consecutiveLocalOriginFailures</td><td>åœ¨å¼¹å‡ºå‘ç”Ÿä¹‹å‰è¿ç»­å‘ç”Ÿçš„æœ¬åœ°æ•…éšœæ•°ã€‚é»˜è®¤ä¸º 5ã€‚å‚æ•°ä»…åœ¨ splitExternalLocalOriginErrors è®¾ç½®ä¸º true æ—¶ç”Ÿæ•ˆ</td></tr><tr><td>consecutiveGatewayErrors</td><td>ä¸»æœºä»è¿æ¥æ± ä¸­å¼¹å‡ºä¹‹å‰çš„ç½‘å…³é”™è¯¯æ•°ã€‚å½“é€šè¿‡ HTTP è®¿é—®ä¸Šæ¸¸ä¸»æœºæ—¶ï¼Œ502ã€503 æˆ– 504 è¿”å›ç è¢«è§†ä¸ºç½‘å…³é”™è¯¯ã€‚å½“é€šè¿‡ä¸é€æ˜çš„ TCP è¿æ¥è®¿é—®ä¸Šæ¸¸ä¸»æœºæ—¶ï¼Œè¿æ¥è¶…æ—¶å’Œè¿æ¥é”™è¯¯&#x2F;å¤±è´¥äº‹ä»¶ç¬¦åˆç½‘å…³é”™è¯¯ã€‚é»˜è®¤ä¸º 0ï¼Œå³ç¦ç”¨æ­¤åŠŸèƒ½</td></tr><tr><td>consecutive5xxErrors</td><td>ä¸»æœºä»è¿æ¥æ± ä¸­å¼¹å‡ºä¹‹å‰çš„ 5xx é”™è¯¯æ•°ã€‚å½“é€šè¿‡ä¸é€æ˜çš„ TCP è¿æ¥è®¿é—®ä¸Šæ¸¸ä¸»æœºæ—¶ï¼Œè¿æ¥è¶…æ—¶ã€è¿æ¥é”™è¯¯&#x2F;å¤±è´¥å’Œè¯·æ±‚å¤±è´¥äº‹ä»¶è¢«è§†ä¸º 5xx é”™è¯¯ã€‚é»˜è®¤ä¸º 5ï¼Œå¯ä»¥é€šè¿‡å°†å€¼è®¾ç½®ä¸º 0 æ¥ç¦ç”¨<br /><em>æ³¨æ„ï¼Œ consecutiveGatewayErrors å’Œ  consecutive5xxErrors å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä¸€èµ·ä½¿ç”¨ã€‚å› ä¸º consecutiveGatewayErrors ç»Ÿè®¡çš„é”™è¯¯ä¹ŸåŒ…å«åœ¨ consecutive5xxErrors ä¸­ï¼Œå¦‚æœ consecutiveGatewayErrors çš„å€¼å¤§äºæˆ–ç­‰äº consecutive5xxErrors çš„å€¼ï¼Œåˆ™ consecutiveGatewayErrors å°†ä¸èµ·ä½œç”¨</em></td></tr><tr><td>interval</td><td>å¼¹å‡ºåˆ†æçš„æ—¶é—´é—´éš”ã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D;1 msã€‚é»˜è®¤ä¸º 10 s</td></tr><tr><td>baseEjectionTime</td><td>æœ€çŸ­å¼¹å‡ºæ—¶é—´ã€‚è¢«å¼¹å‡ºçš„æ—¶é—´ç­‰äºæœ€å°å¼¹å‡ºæŒç»­æ—¶é—´ä¸ä¸»æœºè¢«å¼¹å‡ºæ¬¡æ•°çš„ä¹˜ç§¯ã€‚è¿™ç§æ–¹å¼ä¸‹ç³»ç»Ÿå°†è‡ªåŠ¨å¢åŠ ä¸å¥åº·çš„ä¸Šæ¸¸æœåŠ¡å™¨çš„å¼¹å‡ºå‘¨æœŸã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D;1 msã€‚é»˜è®¤ä¸º 30 s</td></tr><tr><td>maxEjectionPercent</td><td>ä¸Šæ¸¸æœåŠ¡çš„è´Ÿè½½å‡è¡¡æ± ä¸­å¯ä»¥å¼¹å‡ºçš„åç«¯çš„æœ€å¤§ç™¾åˆ†æ¯”ã€‚é»˜è®¤ä¸º 10%</td></tr><tr><td>minHealthPercent</td><td>åªè¦å…³è”çš„è´Ÿè½½å‡è¡¡æ± è‡³å°‘æœ‰ minHealthPercent ä¸»æœºå¤„äºå¥åº·æ¨¡å¼ï¼Œå°±ä¼šå¯ç”¨å¼‚å¸¸å€¼æ£€æµ‹ã€‚å½“è´Ÿè½½å‡è¡¡æ± ä¸­å¥åº·ä¸»æœºçš„ç™¾åˆ†æ¯”ä½äºæ­¤é˜ˆå€¼æ—¶ï¼Œå°†ç¦ç”¨å¼‚å¸¸å€¼æ£€æµ‹ï¼Œå¹¶ä¸”ä»£ç†å°†åœ¨æ± ä¸­çš„æ‰€æœ‰ä¸»æœºï¼ˆå¥åº·å’Œä¸å¥åº·ï¼‰ä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚å¯ä»¥é€šè¿‡å°†é˜ˆå€¼è®¾ç½®ä¸º 0% æ¥ç¦ç”¨è¯¥é˜ˆå€¼ã€‚é»˜è®¤å€¼ä¸º 0%ï¼Œå› ä¸ºå®ƒé€šå¸¸ä¸é€‚ç”¨äºæ¯ä¸ªæœåŠ¡çš„ pod å¾ˆå°‘çš„ k8s ç¯å¢ƒ</td></tr></tbody></table><h1 id="ClientTLSSettings"><a href="#ClientTLSSettings" class="headerlink" title="ClientTLSSettings"></a><a name="ClientTLSSettings">ClientTLSSettings</a></h1><p>ä¸Šæ¸¸è¿æ¥çš„ SSL&#x2F;TLS ç›¸å…³è®¾ç½®ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… <a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/transport_sockets/tls/v3/common.proto.html#common-tls-configuration">Envoy çš„ TLS ä¸Šä¸‹æ–‡</a>ã€‚å¯¹ HTTP å’Œ TCP ä¸Šæ¸¸éƒ½æ˜¯é€šç”¨çš„ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å°†å®¢æˆ·ç«¯é…ç½®ä¸ºä½¿ç”¨åŒå‘ TLSï¼ˆMUTUALï¼‰è¿æ¥åˆ°ä¸Šæ¸¸æ•°æ®åº“é›†ç¾¤ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-mtls</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">mydbserver.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">MUTUAL</span></span><br><span class="line">      <span class="attr">clientCertificate:</span> <span class="string">/etc/certs/myclientcert.pem</span></span><br><span class="line">      <span class="attr">privateKey:</span> <span class="string">/etc/certs/client_private_key.pem</span></span><br><span class="line">      <span class="attr">caCertificates:</span> <span class="string">/etc/certs/rootcacerts.pem</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹è§„åˆ™å°†å®¢æˆ·ç«¯é…ç½®ä¸ºåœ¨ä¸ rating æœåŠ¡é€šä¿¡æ—¶ä½¿ç”¨ Istio åŒå‘ TLSã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-istio-mtls</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">ISTIO_MUTUAL</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#ClientTLSSettings.TLSmode">mode</a></td><td>æ˜¯å¦åº”ä½¿ç”¨ TLS ä¿æŠ¤ä¸æ­¤ç«¯å£çš„è¿æ¥ã€‚è¯¥å­—æ®µçš„å€¼å†³å®šäº† TLS çš„è¡Œä¸ºæ–¹å¼</td></tr><tr><td>clientCertificate</td><td>å¦‚æœ mode ä¸º MUTUAL æ—¶ï¼Œåˆ™ä¸ºå¿…éœ€ã€‚è¡¨ç¤ºä½¿ç”¨çš„å®¢æˆ·ç«¯ TLS è¯ä¹¦çš„æ–‡ä»¶çš„è·¯å¾„ã€‚å¦‚æœæ¨¡å¼ä¸º ISTIO_MUTUALï¼Œåˆ™åº”ä¸ºç©º</td></tr><tr><td>privateKey</td><td>å¦‚æœ mode ä¸º MUTUAL æ—¶ï¼Œåˆ™ä¸ºå¿…éœ€ã€‚ä¿å­˜å®¢æˆ·ç«¯ç§é’¥çš„æ–‡ä»¶çš„è·¯å¾„ã€‚å¦‚æœæ¨¡å¼ä¸º ISTIO_MUTUALï¼Œåˆ™åº”ä¸ºç©º</td></tr><tr><td>caCertificates</td><td>ç”¨äºéªŒè¯æä¾›çš„æœåŠ¡å™¨è¯ä¹¦çš„è¯ä¹¦é¢å‘æœºæ„è¯ä¹¦çš„æ–‡ä»¶çš„è·¯å¾„ã€‚å¦‚æœçœç•¥ï¼Œä»£ç†å°†ä¸ä¼šéªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦ã€‚å¦‚æœæ¨¡å¼ä¸º ISTIO_MUTUALï¼Œåˆ™åº”ä¸ºç©º</td></tr><tr><td>credentialName</td><td>ä¿å­˜å®¢æˆ·ç«¯ TLS è¯ä¹¦çš„å¯†é’¥çš„åç§°ï¼ŒåŒ…æ‹¬ CA è¯ä¹¦ã€‚ Secret å¿…é¡»ä¸ä½¿ç”¨è¯ä¹¦çš„ä»£ç†å­˜åœ¨äºåŒä¸€å‘½åç©ºé—´ä¸­ã€‚å¯†é’¥ï¼ˆé€šç”¨ç±»å‹ï¼‰åº”åŒ…å«ä»¥ä¸‹é”®å’Œå€¼ï¼škeyï¼š&lt;privateKey&gt;ã€certï¼š&lt;clientCert&gt;ã€cacertï¼š&lt;CACertificate&gt;ã€‚è¿™é‡Œ CACertificate ç”¨äºéªŒè¯æœåŠ¡å™¨è¯ä¹¦ã€‚è¿˜æ”¯æŒç”¨äºå®¢æˆ·ç«¯è¯ä¹¦çš„ tls ç±»å‹çš„å¯†é’¥ä»¥åŠç”¨äº CA è¯ä¹¦çš„ ca.crt å¯†é’¥ã€‚åªèƒ½æŒ‡å®šå®¢æˆ·ç«¯è¯ä¹¦å’Œ CA è¯ä¹¦æˆ– credentialName ä¸­çš„ä¸€ä¸ª<br />æ³¨æ„ï¼šä»…å½“ DestinationRule æŒ‡å®šäº†å·¥ä½œè´Ÿè½½é€‰æ‹©å™¨æ—¶ï¼Œæ­¤å­—æ®µæ‰é€‚ç”¨äº sidecarã€‚å¦åˆ™è¯¥å­—æ®µå°†ä»…é€‚ç”¨äºç½‘å…³ï¼Œsidecar å°†ç»§ç»­ä½¿ç”¨è¯ä¹¦è·¯å¾„</td></tr><tr><td>subjectAltNames</td><td>ç”¨äºéªŒè¯è¯ä¹¦ä¸­ä¸»ä½“èº«ä»½çš„å¤‡ç”¨åç§°åˆ—è¡¨ã€‚å¦‚æœæŒ‡å®šï¼Œä»£ç†å°†éªŒè¯æœåŠ¡å™¨è¯ä¹¦çš„ä¸»é¢˜ alt åç§°æ˜¯å¦ä¸æŒ‡å®šå€¼ä¹‹ä¸€åŒ¹é…ã€‚å¦‚æœæŒ‡å®šï¼Œæ­¤åˆ—è¡¨å°†è¦†ç›– ServiceEntry ä¸­çš„ subject_alt_names çš„å€¼ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™å°†æ ¹æ®ä¸‹æ¸¸ HTTP ä¸»æœº&#x2F;æˆæƒæ ‡å¤´è‡ªåŠ¨éªŒè¯æ–°ä¸Šæ¸¸è¿æ¥çš„ä¸Šæ¸¸è¯ä¹¦ï¼Œå‰ææ˜¯ VERIFY_CERT_AT_CLIENT å’Œ ENABLE_AUTO_SNI ç¯å¢ƒå˜é‡è®¾ç½®ä¸º true</td></tr><tr><td>sni</td><td>åœ¨ TLS æ¡æ‰‹æœŸé—´å‘ˆç°ç»™æœåŠ¡å™¨çš„ SNI å­—ç¬¦ä¸²ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™ SNI å°†æ ¹æ® SIMPLE å’Œ MUTUAL TLS æ¨¡å¼çš„ä¸‹æ¸¸ HTTP host&#x2F;authority header è‡ªåŠ¨è®¾ç½®ï¼Œå‰ææ˜¯ ENABLE_AUTO_SNI ç¯å¢ƒå˜é‡è®¾ç½®ä¸º true</td></tr><tr><td>insecureSkipVerify</td><td>InsecureSkipVerify æŒ‡å®šä»£ç†æ˜¯å¦åº”è¯¥è·³è¿‡éªŒè¯ä¸»æœºå¯¹åº”çš„æœåŠ¡å™¨è¯ä¹¦çš„ CA ç­¾åå’Œ SANã€‚ä»…å½“å¯ç”¨å…¨å±€ CA ç­¾åéªŒè¯ï¼ŒVerifyCertAtClient ç¯å¢ƒå˜é‡è®¾ç½®ä¸º trueï¼Œä½†ä¸éœ€è¦å¯¹ç‰¹å®šä¸»æœºè¿›è¡ŒéªŒè¯æ—¶ï¼Œæ‰åº”è®¾ç½®æ­¤æ ‡å¿—ã€‚æ— è®ºæ˜¯å¦å¯ç”¨äº† VerifyCertAtClientï¼Œéƒ½å°†è·³è¿‡ CA ç­¾åå’Œ SAN çš„éªŒè¯<br />InsecureSkipVerify é»˜è®¤ä¸º falseã€‚åœ¨ Istio 1.9 ç‰ˆæœ¬ä¸­ï¼ŒVerifyCertAtClient é»˜è®¤ä¸º falseï¼Œä½†åœ¨ä»¥åçš„ç‰ˆæœ¬ä¸­é»˜è®¤ä¸º true</td></tr></tbody></table><h1 id="LocalityLoadBalancerSetting"><a href="#LocalityLoadBalancerSetting" class="headerlink" title="LocalityLoadBalancerSetting"></a><a name="LocalityLoadBalancerSetting">LocalityLoadBalancerSetting</a></h1><p>ä½ç½®åŠ æƒè´Ÿè½½å‡è¡¡å…è®¸æ ¹æ®æµé‡çš„æ¥æºå’Œç»ˆæ­¢ä½ç½®æ¥æ§åˆ¶åˆ° endpoint çš„æµé‡åˆ†é…ã€‚è¿™äº›åœ°åŒºæ˜¯ä½¿ç”¨ä»»æ„æ ‡ç­¾æŒ‡å®šçš„ï¼Œè¿™äº›æ ‡ç­¾ä»¥ {region}&#x2F;{zone}&#x2F;{sub-zone} å½¢å¼æŒ‡å®šåœ°åŒºå±‚æ¬¡ç»“æ„ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜…<a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/locality_weight">å±€éƒ¨æƒé‡</a>ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹æ˜¾ç¤ºå¦‚ä½•åœ¨ç½‘æ ¼èŒƒå›´å†…è®¾ç½®å±€éƒ¨æƒé‡ï¼šåœ¨ä¸€ä¸ªç½‘æ ¼ä¸­ï¼Œå…¶å·¥ä½œè´Ÿè½½ä¸­çš„æœåŠ¡éƒ¨ç½²åˆ°äº† us-west&#x2F;zone1&#x2F; å’Œ us-west&#x2F;zone2&#x2F; ä¸­ã€‚å½“è®¿é—®æœåŠ¡çš„æµé‡æºè‡ª us-west&#x2F;zone1&#x2F; ä¸­æ—¶ï¼Œ80% çš„æµé‡å°†å‘é€åˆ° us-west&#x2F;zone1&#x2F; çš„ endpointï¼Œå³åŒä¸€åŒºåŸŸï¼Œå…¶ä½™çš„ 20% å°†è¿›å…¥ us-west&#x2F;zone2&#x2F; çš„ endpointã€‚æ­¤è®¾ç½®æ—¨åœ¨å°†æµé‡è·¯ç”±åˆ°åŒä¸€ä½ç½®çš„ endpointã€‚ä¸ºæºè‡ª us-west&#x2F;zone2&#x2F; çš„æµé‡æŒ‡å®šäº†ç±»ä¼¼çš„è®¾ç½®ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">distribute:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span> <span class="string">us-west/zone1/*</span></span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">      <span class="string">&quot;us-west/zone1/*&quot;</span><span class="string">:</span> <span class="number">80</span></span><br><span class="line">      <span class="string">&quot;us-west/zone2/*&quot;</span><span class="string">:</span> <span class="number">20</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span> <span class="string">us-west/zone2/*</span></span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line">      <span class="string">&quot;us-west/zone1/*&quot;</span><span class="string">:</span> <span class="number">20</span></span><br><span class="line">      <span class="string">&quot;us-west/zone2/*&quot;</span><span class="string">:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¿è¥å•†çš„ç›®æ ‡ä¸æ˜¯è·¨åŒºåŸŸå’ŒåŒºåŸŸåˆ†é…è´Ÿè½½ï¼Œè€Œæ˜¯é™åˆ¶æ•…éšœè½¬ç§»çš„åŒºåŸŸæ€§ä»¥æ»¡è¶³å…¶ä»–è¿è¥è¦æ±‚ï¼Œåˆ™è¿è¥å•†å¯ä»¥è®¾ç½®â€œæ•…éšœè½¬ç§»â€ç­–ç•¥è€Œä¸æ˜¯â€œåˆ†å¸ƒâ€ç­–ç•¥ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹ä¸ºåŒºåŸŸè®¾ç½®æœ¬åœ°æ•…éšœè½¬ç§»ç­–ç•¥ã€‚å‡è®¾æœåŠ¡é©»ç•™åœ¨ us-eastã€us-west å’Œ eu-west å†…çš„åŒºåŸŸä¸­ï¼Œæ­¤ç¤ºä¾‹æŒ‡å®šå½“ us-east å†…çš„ endpoint å˜å¾—ä¸å¥åº·æ—¶ï¼Œæµé‡åº”æ•…éšœè½¬ç§»åˆ° eu-west å†…çš„ endpointï¼Œç±»ä¼¼åœ° us-west åº”è¯¥æ•…éšœè½¬ç§»åˆ° us-eastã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">failover:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span> <span class="string">us-east</span></span><br><span class="line">    <span class="attr">to:</span> <span class="string">eu-west</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span> <span class="string">us-west</span></span><br><span class="line">    <span class="attr">to:</span> <span class="string">us-east</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#LocalityLoadBalancerSetting.Distribute">distribute</a></td><td>åªèƒ½è®¾ç½® distributeã€failover æˆ– failoverPriority ä¸­çš„å…¶ä¸€ã€‚æŒ‡å®šè·¨ä¸åŒåŒºåŸŸå’Œåœ°ç†ä½ç½®çš„è´Ÿè½½å¹³è¡¡æƒé‡ã€‚å‚è€ƒ <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/load_balancing/locality_weight">Locality weighted load balancing</a>ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™æ ¹æ®å…¶ä¸­çš„ endpoints æ•°é‡è®¾ç½® locality æƒé‡</td></tr><tr><td><a href="#LocalityLoadBalancerSetting.Failover">failover</a></td><td>åªèƒ½è®¾ç½® distributeã€failover æˆ– failoverPriority ä¸­çš„å…¶ä¸€ã€‚å½“æœ¬åœ°åŒºåŸŸçš„ endpoint å˜å¾—ä¸å¥åº·æ—¶ï¼Œæ˜¾å¼æŒ‡å®šå¾…è½¬ç§»æµé‡çš„åŒºåŸŸã€‚åº”ä¸ OutlierDetection ä¸€èµ·ä½¿ç”¨ä»¥æ£€æµ‹ä¸å¥åº·çš„ endpoint<br /><em>æ³¨æ„ï¼šç”Ÿæ•ˆçš„å‰ææ˜¯æŒ‡å®šäº† OutlierDetection</em></td></tr><tr><td>failoverPriority</td><td>failoverPriority æ˜¯æ ‡ç­¾çš„æœ‰åºåˆ—è¡¨ï¼Œç”¨äºå¯¹ endpoint è¿›è¡Œæ’åºä»¥è¿›è¡ŒåŸºäºä¼˜å…ˆçº§çš„è´Ÿè½½å¹³è¡¡ã€‚è¿™æ˜¯ä¸ºäº†æ”¯æŒè·¨ä¸åŒ endpoint ç»„çš„æµé‡æ•…éšœè½¬ç§»ã€‚å‡è®¾æ€»å…±æŒ‡å®šäº† N ä¸ªæ ‡ç­¾ï¼š<br />- ä¸å®¢æˆ·ç«¯ä»£ç†åŒ¹é…æ‰€æœ‰ N ä¸ªæ ‡ç­¾çš„ endpoint å…·æœ‰ä¼˜å…ˆçº§ P(0)ï¼Œå³æœ€é«˜ä¼˜å…ˆçº§<br />- å°†å‰ N-1 ä¸ªæ ‡ç­¾ä¸å®¢æˆ·ç«¯ä»£ç†åŒ¹é…çš„ endpoint å…·æœ‰ä¼˜å…ˆçº§ P(1)ï¼Œå³ç¬¬äºŒé«˜ä¼˜å…ˆçº§<br />- é€šè¿‡æ‰©å±•æ­¤é€»è¾‘ï¼Œä»…ä¸å®¢æˆ·ç«¯ä»£ç†åŒ¹é…ç¬¬ä¸€ä¸ªæ ‡ç­¾çš„ endpoint å…·æœ‰ä¼˜å…ˆçº§ P(N-1)ï¼Œå³ç¬¬äºŒä½ä¼˜å…ˆçº§<br />- æ‰€æœ‰å…¶ä»– endpoint å…·æœ‰ä¼˜å…ˆçº§ P(N)ï¼Œå³æœ€ä½ä¼˜å…ˆçº§<br />æ³¨æ„ï¼šå¯¹äºè¦è€ƒè™‘åŒ¹é…çš„æ ‡ç­¾ï¼Œä¹‹å‰çš„æ ‡ç­¾å¿…é¡»åŒ¹é…ï¼Œå³ä»…å½“å‰ n-1 ä¸ªæ ‡ç­¾åŒ¹é…æ—¶ï¼Œæ‰ä¼šè®¤ä¸ºç¬¬ n ä¸ªæ ‡ç­¾åŒ¹é…<br />å®ƒå¯ä»¥æ˜¯åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å·¥ä½œè´Ÿè½½ä¸ŠæŒ‡å®šçš„ä»»ä½•æ ‡ç­¾ã€‚è¿˜æ”¯æŒä»¥ä¸‹å…·æœ‰ç‰¹æ®Šè¯­ä¹‰å«ä¹‰çš„æ ‡ç­¾<br />- topology.istio.io&#x2F;network ç”¨äºåŒ¹é… endpoint çš„ç½‘ç»œå…ƒæ•°æ®ï¼Œå¯ä»¥é€šè¿‡ pod&#x2F;namespace æ ‡ç­¾ topology.istio.io&#x2F;networkã€sidecar env ISTIO_META_NETWORK æˆ– MeshNetworks æŒ‡å®š<br />- topology.istio.io&#x2F;cluster ç”¨äºåŒ¹é…ä¸€ä¸ª endpoint çš„clusterIDï¼Œå¯ä»¥é€šè¿‡ pod label topology.istio.io&#x2F;cluster æˆ–pod env ISTIO_META_CLUSTER_ID æŒ‡å®š<br />- topology.kubernetes.io&#x2F;region ç”¨äºåŒ¹é… endpoint çš„åŒºåŸŸå…ƒæ•°æ®ï¼Œæ˜ å°„åˆ° Kubernetes èŠ‚ç‚¹æ ‡ç­¾ topology.kubernetes.io&#x2F;region æˆ– failure-domain.beta.kubernetes.io&#x2F;regionï¼ˆå·²å¼ƒç”¨ï¼‰<br />- topology.kubernetes.io&#x2F;zone ç”¨äºåŒ¹é… endpoint çš„ zone å…ƒæ•°æ®ï¼Œæ˜ å°„åˆ° Kubernetes èŠ‚ç‚¹æ ‡ç­¾ topology.kubernetes.io&#x2F;zone æˆ– failure-domain.beta.kubernetes.io&#x2F;zoneï¼ˆå·²å¼ƒç”¨ï¼‰<br />- topology.istio.io&#x2F;subzone ç”¨äºåŒ¹é… endpoint çš„å­åŒºåŸŸå…ƒæ•°æ®ï¼Œæ˜ å°„åˆ° Istio èŠ‚ç‚¹æ ‡ç­¾ topology.istio.io&#x2F;subzone<br />æ‹“æ‰‘é…ç½®éµå¾ªä»¥ä¸‹ä¼˜å…ˆçº§ï¼š<br />failoverPriority<br/>- topology.istio.io&#x2F;network<br/>- topology.kubernetes.io&#x2F;region<br/>- topology.kubernetes.io&#x2F;zone<br/>- topology.istio.io&#x2F;subzone<br />å³ endpoint å’Œå®¢æˆ·ç«¯ä»£ç†çš„ [network, region, zone, subzone] label çš„åŒ¹é…åº¦è¶Šé«˜ï¼Œåˆ™ä¼˜å…ˆçº§è¶Šé«˜<br />åªèƒ½è®¾ç½® distributeã€failover æˆ– failoverPriority ä¸­çš„å…¶ä¸€ã€‚å¹¶ä¸”åº”è¯¥å’Œ OutlierDetection ä¸€èµ·ä½¿ç”¨æ¥æ£€æµ‹ä¸å¥åº·çš„ endpointï¼Œå¦åˆ™æ²¡æœ‰æ•ˆæœ</td></tr><tr><td>enabled</td><td>æ˜¯å¦å¯ç”¨å±€éƒ¨è´Ÿè½½å¹³è¡¡ï¼Œä¸º DestinationRule çº§åˆ«ï¼Œå°†å®Œå…¨è¦†ç›–ç½‘æ ¼èŒƒå›´çš„è®¾ç½®<br /><em>ä¾‹å¦‚ true è¡¨ç¤ºæ— è®ºç½‘æ ¼èŒƒå›´çš„è®¾ç½®æ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸ºæ­¤ DestinationRule æ‰“å¼€å±€éƒ¨è´Ÿè½½å¹³è¡¡</em></td></tr></tbody></table><h1 id="TrafficPolicy-PortTrafficPolicy"><a href="#TrafficPolicy-PortTrafficPolicy" class="headerlink" title="TrafficPolicy.PortTrafficPolicy"></a><a name="TrafficPolicy.PortTrafficPolicy">TrafficPolicy.PortTrafficPolicy</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>port</td><td>æŒ‡å®šåº”ç”¨æ­¤ç­–ç•¥çš„ç›®æ ‡æœåŠ¡ä¸Šçš„ç«¯å£å·</td></tr><tr><td><a href="#LoadBalancerSettings">loadBalancer</a></td><td>æ§åˆ¶è´Ÿè½½å‡è¡¡å™¨ç®—æ³•çš„è®¾ç½®</td></tr><tr><td><a href="#ConnectionPoolSettings">connectionPool</a></td><td>æ§åˆ¶ä¸ä¸Šæ¸¸æœåŠ¡çš„è¿æ¥é‡çš„è®¾ç½®</td></tr><tr><td><a href="#OutlierDetection">outlierDetection</a></td><td>æ§åˆ¶ä»è´Ÿè½½å‡è¡¡æ± ä¸­é€å‡ºä¸å¥åº·ä¸»æœºçš„è®¾ç½®</td></tr><tr><td><a href="#ClientTLSSettings">tls</a></td><td>ä¸ä¸Šæ¸¸æœåŠ¡è¿æ¥çš„ TLS ç›¸å…³è®¾ç½®</td></tr></tbody></table><h1 id="TrafficPolicy-TunnelSettings"><a href="#TrafficPolicy-TunnelSettings" class="headerlink" title="TrafficPolicy.TunnelSettings"></a><a name="TrafficPolicy.TunnelSettings">TrafficPolicy.TunnelSettings</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>protocol</td><td>æŒ‡å®šç”¨äºéš§é“ä¸‹è¡Œè¿æ¥çš„åè®®ã€‚æ”¯æŒçš„åè®®æœ‰ï¼šconnect - ä½¿ç”¨ HTTP CONNECTï¼› post - ä½¿ç”¨ HTTP POSTã€‚ä¸Šæ¸¸è¯·æ±‚çš„ HTTP ç‰ˆæœ¬ç”±ä¸ºä»£ç†å®šä¹‰çš„æœåŠ¡åè®®ç¡®å®š</td></tr><tr><td>targetHost</td><td>æŒ‡å®šä¸‹æ¸¸è¿æ¥é€šè¿‡éš§é“è¿æ¥åˆ°çš„ä¸»æœºã€‚ç›®æ ‡ä¸»æœºå¿…é¡»æ˜¯ FQDN æˆ– IP åœ°å€</td></tr><tr><td>targetPort</td><td>æŒ‡å®šä¸‹æ¸¸è¿æ¥é€šè¿‡éš§é“è¿æ¥åˆ°çš„ç«¯å£</td></tr></tbody></table><h1 id="LoadBalancerSettings-ConsistentHashLB"><a href="#LoadBalancerSettings-ConsistentHashLB" class="headerlink" title="LoadBalancerSettings.ConsistentHashLB"></a><a name="LoadBalancerSettings.ConsistentHashLB">LoadBalancerSettings.ConsistentHashLB</a></h1><p>ä¸€è‡´çš„åŸºäºå“ˆå¸Œçš„è´Ÿè½½å‡è¡¡å¯ç”¨äºæä¾›åŸºäº HTTP æ ‡å¤´ã€cookie æˆ–å…¶ä»–å±æ€§çš„è½¯ä¼šè¯äº²å’Œæ€§ã€‚å½“ä»ç›®æ ‡æœåŠ¡ä¸­æ·»åŠ &#x2F;åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªä¸»æœºæ—¶ï¼Œä¸ç‰¹å®šç›®æ ‡ä¸»æœºçš„å…³è”å°†è¢«ç§»é™¤ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>httpHeaderName</td><td>åŸºäºç‰¹å®š HTTP æ ‡å¤´çš„ hash</td></tr><tr><td><a href="#LoadBalancerSettings.ConsistentHashLB.HTTPCookie">httpCookie</a></td><td>åŸºäº HTTP cookie çš„ hash</td></tr><tr><td>useSourceIp</td><td>åŸºäºæº IP åœ°å€çš„ hashã€‚é€‚ç”¨äº TCP å’Œ HTTP è¿æ¥</td></tr><tr><td>httpQueryParameterName</td><td>åŸºäºç‰¹å®š HTTP query å‚æ•°çš„ hash</td></tr><tr><td>minimumRingSize</td><td>ç”¨äºå“ˆå¸Œç¯çš„æœ€å°è™šæ‹ŸèŠ‚ç‚¹æ•°ã€‚é»˜è®¤ä¸º 1024ã€‚è¾ƒå¤§çš„ç¯å°ºå¯¸ä¼šäº§ç”Ÿæ›´ç²¾ç»†çš„è´Ÿè½½åˆ†å¸ƒã€‚å¦‚æœè´Ÿè½½å‡è¡¡æ± ä¸­çš„ä¸»æœºæ•°é‡å¤§äºç¯å¤§å°ï¼Œåˆ™æ¯ä¸ªä¸»æœºå°†è¢«åˆ†é…ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹</td></tr></tbody></table><h1 id="LoadBalancerSettings-ConsistentHashLB-HTTPCookie"><a href="#LoadBalancerSettings-ConsistentHashLB-HTTPCookie" class="headerlink" title="LoadBalancerSettings.ConsistentHashLB.HTTPCookie"></a><a name="LoadBalancerSettings.ConsistentHashLB.HTTPCookie">LoadBalancerSettings.ConsistentHashLB.HTTPCookie</a></h1><p>æè¿°å°†ç”¨ä½œä¸€è‡´å“ˆå¸Œè´Ÿè½½å‡è¡¡å™¨çš„å“ˆå¸Œé”®çš„ HTTP cookieã€‚å¦‚æœ cookie ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆ</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>name</td><td>cookie çš„åç§°</td></tr><tr><td>path</td><td>ä¸º cookie è®¾ç½®çš„è·¯å¾„</td></tr><tr><td>ttl</td><td>cookie çš„ç”Ÿå‘½å‘¨æœŸ</td></tr></tbody></table><h1 id="ConnectionPoolSettings-TCPSettings"><a href="#ConnectionPoolSettings-TCPSettings" class="headerlink" title="ConnectionPoolSettings.TCPSettings"></a><a name="ConnectionPoolSettings.TCPSettings">ConnectionPoolSettings.TCPSettings</a></h1><p>HTTP å’Œ TCP ä¸Šæ¸¸è¿æ¥é€šç”¨çš„è®¾ç½®ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>maxConnections</td><td>åˆ°ç›®æ ‡ä¸»æœºçš„æœ€å¤§ HTTP1 &#x2F;TCP è¿æ¥æ•°ã€‚é»˜è®¤ 2^32-1</td></tr><tr><td>connectTimeout</td><td>TCP è¿æ¥è¶…æ—¶ã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D;1msã€‚é»˜è®¤ä¸º 10s</td></tr><tr><td><a href="#ConnectionPoolSettings.TCPSettings.TcpKeepalive">tcpKeepalive</a></td><td>å¦‚æœè®¾ç½®ï¼Œåˆ™åœ¨å¥—æ¥å­—ä¸Šè®¾ç½® SO_KEEPALIVE ä»¥å¯ç”¨ TCP Keepalive</td></tr></tbody></table><h1 id="ConnectionPoolSettings-HTTPSettings"><a href="#ConnectionPoolSettings-HTTPSettings" class="headerlink" title="ConnectionPoolSettings.HTTPSettings"></a><a name="ConnectionPoolSettings.HTTPSettings">ConnectionPoolSettings.HTTPSettings</a></h1><p>é€‚ç”¨äº HTTP1.1&#x2F;HTTP2&#x2F;GRPC è¿æ¥çš„è®¾ç½®ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>http1MaxPendingRequests</td><td>ç›®æ ‡çš„æœ€å¤§æŒ‚èµ· HTTP è¯·æ±‚æ•°ã€‚é»˜è®¤ 2^32-1</td></tr><tr><td>http2MaxRequests</td><td>åç«¯çš„æœ€å¤§è¯·æ±‚æ•°ã€‚é»˜è®¤ 2^32-1</td></tr><tr><td>maxRequestsPerConnection</td><td>æ¯ä¸ªè¿æ¥åˆ°åç«¯çš„æœ€å¤§è¯·æ±‚æ•°ã€‚å°†æ­¤å‚æ•°è®¾ç½®ä¸º 1 å°†ç¦ç”¨ aliveã€‚é»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºæ— é™åˆ¶ï¼Œæœ€å¤§ä¸º 2^29</td></tr><tr><td>maxRetries</td><td>åœ¨ç»™å®šæ—¶é—´å¯ä»¥å¯¹é›†ç¾¤ä¸­çš„æ‰€æœ‰ä¸»æœºè¿›è¡Œçš„æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤ä¸º 2^32-1</td></tr><tr><td>idleTimeout</td><td>ä¸Šæ¸¸è¿æ¥æ± è¿æ¥çš„ç©ºé—²è¶…æ—¶ã€‚ç©ºé—²è¶…æ—¶å®šä¹‰ä¸ºæ²¡æœ‰ alive è¯·æ±‚çš„æ—¶é—´æ®µã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™é»˜è®¤ä¸º 1 å°æ—¶ã€‚å½“è¾¾åˆ°ç©ºé—²è¶…æ—¶æ—¶ï¼Œè¿æ¥å°†è¢«å…³é—­ã€‚å¦‚æœè¿æ¥æ˜¯ HTTP&#x2F;2 è¿æ¥ï¼Œåˆ™ä¼šåœ¨å…³é—­è¿æ¥ä¹‹å‰å‘ç”Ÿè€—å°½åºåˆ—ã€‚è¯·æ³¨æ„ï¼ŒåŸºäºè¯·æ±‚çš„è¶…æ—¶æ„å‘³ç€ HTTP&#x2F;2 PING ä¸ä¼šä½¿è¿æ¥ä¿æŒæ´»åŠ¨çŠ¶æ€ã€‚é€‚ç”¨äº HTTP1.1 å’Œ HTTP2 è¿æ¥</td></tr><tr><td><a href="#ConnectionPoolSettings.HTTPSettings.H2UpgradePolicy">h2UpgradePolicy</a></td><td>æŒ‡å®šæ˜¯å¦åº”å°†å…³è”ç›®æ ‡çš„ http1.1 è¿æ¥å‡çº§åˆ° http2</td></tr><tr><td>useClientProtocol</td><td>å¦‚æœè®¾ç½®ä¸º trueï¼Œåˆ™å¯åŠ¨ä¸åç«¯çš„è¿æ¥æ—¶å°†ä¿ç•™å®¢æˆ·ç«¯åè®®ã€‚è¯·æ³¨æ„ï¼Œå½“è®¾ç½®ä¸º true æ—¶ï¼Œh2UpgradePolicy å°†æ— æ•ˆï¼Œå³å®¢æˆ·ç«¯è¿æ¥ä¸ä¼šå‡çº§åˆ° http2</td></tr></tbody></table><h1 id="ConnectionPoolSettings-TCPSettings-TcpKeepalive"><a href="#ConnectionPoolSettings-TCPSettings-TcpKeepalive" class="headerlink" title="ConnectionPoolSettings.TCPSettings.TcpKeepalive"></a><a name="ConnectionPoolSettings.TCPSettings.TcpKeepalive">ConnectionPoolSettings.TCPSettings.TcpKeepalive</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>probes</td><td>åœ¨ç¡®å®šè¿æ¥å·²æ­»ä¹‹å‰ï¼Œè¦å‘é€ä¸”æ— å“åº”çš„æœ€å¤§ä¿æ´»æ¢æµ‹æ•°ã€‚é»˜è®¤æ˜¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é…ç½®ï¼ˆé™¤éè¢«è¦†ç›–ï¼ŒLinux é»˜è®¤ä¸º 9)</td></tr><tr><td>time</td><td>åœ¨å¼€å§‹å‘é€ keep-alive æ¢æµ‹ä¹‹å‰ï¼Œè¿æ¥éœ€è¦ç©ºé—²çš„æŒç»­æ—¶é—´ã€‚é»˜è®¤æ˜¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é…ç½®ï¼ˆé™¤éè¢«è¦†ç›–ï¼ŒLinux é»˜è®¤ä¸º 7200sï¼‰</td></tr><tr><td>interval</td><td>ä¿æŒæ´»åŠ¨æ¢æµ‹ä¹‹é—´çš„æŒç»­æ—¶é—´ã€‚é»˜è®¤æ˜¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é…ç½®ï¼ˆé™¤éè¢«è¦†ç›–ï¼ŒLinux é»˜è®¤ä¸º 75sï¼‰</td></tr></tbody></table><h1 id="LocalityLoadBalancerSetting-Distribute"><a href="#LocalityLoadBalancerSetting-Distribute" class="headerlink" title="LocalityLoadBalancerSetting.Distribute"></a><a name="LocalityLoadBalancerSetting.Distribute">LocalityLoadBalancerSetting.Distribute</a></h1><p>æè¿°æºè‡ª from åŒºåŸŸæˆ–å­åŒºåŸŸçš„æµé‡å¦‚ä½•åˆ†å¸ƒåœ¨ä¸€ç»„ to åŒºåŸŸä¸Šã€‚æŒ‡å®šåŒºåŸŸçš„è¯­æ³•æ˜¯ {region}&#x2F;{zone}&#x2F;{sub-zone} å¹¶ä¸”è§„èŒƒçš„ä»»ä½•éƒ¨åˆ†éƒ½å…è®¸ä½¿ç”¨ç»ˆç«¯é€šé…ç¬¦ã€‚ä¾‹å¦‚ï¼š</p><ul><li>* åŒ¹é…æ‰€æœ‰çš„åœ°åŒº</li><li>us-west&#x2F;* åŒ¹é… us-west åŒºåŸŸå†…çš„æ‰€æœ‰åŒºåŸŸå’Œå­åŒºåŸŸ</li><li>us-west&#x2F;zone-1&#x2F;* åŒ¹é… us-west&#x2F;zone-1 ä¸­çš„æ‰€æœ‰å­åŒºåŸŸ</li></ul><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>from</td><td>æºä½ç½®ï¼Œç”¨ &#x2F; åˆ†éš”ï¼Œä¾‹å¦‚ region&#x2F;zone&#x2F;sub_zone</td></tr><tr><td>to</td><td>ä¸Šæ¸¸åœ°åŒºåˆ°æµé‡åˆ†å¸ƒæƒé‡çš„åœ°å›¾ã€‚æ‰€æœ‰æƒé‡çš„æ€»å’Œåº”ä¸º 100ã€‚ä»»ä½•ä¸å­˜åœ¨çš„ä½ç½®éƒ½ä¸ä¼šæ”¶åˆ°æµé‡</td></tr></tbody></table><h1 id="LocalityLoadBalancerSetting-Failover"><a href="#LocalityLoadBalancerSetting-Failover" class="headerlink" title="LocalityLoadBalancerSetting.Failover"></a><a name="LocalityLoadBalancerSetting.Failover">LocalityLoadBalancerSetting.Failover</a></h1><p>æŒ‡å®šè·¨åŒºåŸŸçš„æµé‡æ•…éšœè½¬ç§»ç­–ç•¥ã€‚ç”±äºé»˜è®¤æƒ…å†µä¸‹æ”¯æŒåŒºåŸŸå’Œå­åŒºåŸŸæ•…éšœè½¬ç§»ï¼Œå› æ­¤ä»…å½“è¿è¥å•†éœ€è¦é™åˆ¶æµé‡æ•…éšœè½¬ç§»æ—¶æ‰éœ€è¦ä¸ºåŒºåŸŸæŒ‡å®šï¼Œä»¥ä¾¿å…¨å±€æ•…éšœè½¬ç§»åˆ°ä»»ä½• endpoint çš„é»˜è®¤è¡Œä¸ºä¸é€‚ç”¨ã€‚è¿™åœ¨è·¨åŒºåŸŸæ•…éšœè½¬ç§»æµé‡ä¸ä¼šæ”¹å–„æœåŠ¡å¥åº·æˆ–å¯èƒ½éœ€è¦å› ç›‘ç®¡æ§åˆ¶ç­‰å…¶ä»–åŸå› è€Œå—åˆ°é™åˆ¶æ—¶éå¸¸æœ‰ç”¨ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>from</td><td>æºåŒºåŸŸ</td></tr><tr><td>to</td><td>å½“ from åŒºåŸŸä¸­çš„ endpoint å˜å¾—ä¸å¥åº·æ—¶ï¼Œæµé‡å°†æ•…éšœè½¬ç§»åˆ°ç›®æ ‡åŒºåŸŸ</td></tr></tbody></table><h1 id="LoadBalancerSettings-SimpleLB"><a href="#LoadBalancerSettings-SimpleLB" class="headerlink" title="LoadBalancerSettings.SimpleLB"></a><a name="SimpleLB">LoadBalancerSettings.SimpleLB</a></h1><p>æ— éœ€è°ƒæ•´çš„æ ‡å‡†è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>UNSPECIFIED</td><td>ç”¨æˆ·æœªæŒ‡å®šè´Ÿè½½å‡è¡¡ç®—æ³•ã€‚ Istio å°†é€‰æ‹©é€‚å½“çš„é»˜è®¤å€¼</td></tr><tr><td>RANDOM</td><td>éšæœºè´Ÿè½½å‡è¡¡å™¨é€‰æ‹©ä¸€ä¸ªéšæœºçš„å¥åº·ä¸»æœºã€‚å¦‚æœæ²¡æœ‰é…ç½®å¥åº·æ£€æŸ¥ç­–ç•¥ï¼Œéšæœºè´Ÿè½½å‡è¡¡å™¨çš„æ€§èƒ½é€šå¸¸æ¯”è½®è¯¢æ›´å¥½</td></tr><tr><td>PASSTHROUGH</td><td>æ­¤é€‰é¡¹ä¼šå°†è¿æ¥è½¬å‘åˆ°è°ƒç”¨è€…è¯·æ±‚çš„åŸå§‹ IP åœ°å€ï¼Œè€Œä¸è¿›è¡Œä»»ä½•å½¢å¼çš„è´Ÿè½½å¹³è¡¡ã€‚æ…é‡ä½¿ç”¨ã€‚å®ƒé€‚ç”¨äºé«˜çº§ç”¨ä¾‹ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… Envoy ä¸­çš„åŸå§‹ç›®æ ‡è´Ÿè½½å‡è¡¡å™¨</td></tr><tr><td>ROUND_ROBIN</td><td>ä¸€ä¸ªåŸºæœ¬çš„å¾ªç¯è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚è¿™å¯¹äºè®¸å¤šåœºæ™¯ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ endpoint åŠ æƒæ—¶ï¼‰é€šå¸¸æ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šä½¿ endpoint è´Ÿæ‹…è¿‡é‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå€¾å‘äºä½¿ç”¨ LEAST_REQUEST æ›¿ä»£ ROUND_ROBIN</td></tr><tr><td>LEAST_REQUEST</td><td>æœ€å°‘è¯·æ±‚è´Ÿè½½å‡è¡¡å™¨å°†è´Ÿè½½åˆ†æ•£åˆ°å„ä¸ª endpointï¼Œå€¾å‘äºå…·æœ‰æœ€å°‘æœªå®Œæˆè¯·æ±‚çš„ endpointã€‚è¿™é€šå¸¸æ›´å®‰å…¨ï¼Œå¹¶ä¸”å‡ ä¹åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½ä¼˜äº ROUND_ROBINã€‚å€¾å‘äºä½¿ç”¨ LEAST_REQUEST æ›¿ä»£ ROUND_ROBIN</td></tr><tr><td>LEAST_CONN</td><td>å·²å¼ƒç”¨ã€‚æ”¹ç”¨ LEAST_REQUEST</td></tr></tbody></table><h1 id="ConnectionPoolSettings-HTTPSettings-H2UpgradePolicy"><a href="#ConnectionPoolSettings-HTTPSettings-H2UpgradePolicy" class="headerlink" title="ConnectionPoolSettings.HTTPSettings.H2UpgradePolicy"></a><a name="ConnectionPoolSettings.HTTPSettings.H2UpgradePolicy">ConnectionPoolSettings.HTTPSettings.H2UpgradePolicy</a></h1><p>å°† http1.1 è¿æ¥å‡çº§åˆ° http2 çš„ç­–ç•¥ã€‚</p><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>DEFAULT</td><td>ä½¿ç”¨å…¨å±€é»˜è®¤å€¼</td></tr><tr><td>DO_NOT_UPGRADE</td><td>ä¸å°†è¿æ¥å‡çº§åˆ° http2ã€‚ä¼šè¦†ç›–é»˜è®¤å€¼</td></tr><tr><td>UPGRADE</td><td>å°†è¿æ¥å‡çº§åˆ° http2ã€‚ä¼šè¦†ç›–é»˜è®¤å€¼</td></tr></tbody></table><h1 id="ClientTLSSettings-TLSmode"><a href="#ClientTLSSettings-TLSmode" class="headerlink" title="ClientTLSSettings.TLSmode"></a><a name="ClientTLSSettings.TLSmode">ClientTLSSettings.TLSmode</a></h1><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>DISABLE</td><td>ä¸è®¾ç½®åˆ°ä¸Šæ¸¸ endpoint çš„ TLS è¿æ¥</td></tr><tr><td>SIMPLE</td><td>å‘èµ·åˆ°ä¸Šæ¸¸ endpoint çš„ TLS è¿æ¥</td></tr><tr><td>MUTUAL</td><td>é€šè¿‡æä¾›å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä½¿ç”¨åŒå‘ TLS ä¿æŠ¤ä¸ä¸Šæ¸¸çš„è¿æ¥</td></tr><tr><td>ISTIO_MUTUAL</td><td>é€šè¿‡æä¾›å®¢æˆ·ç«¯è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä½¿ç”¨åŒå‘ TLS ä¿æŠ¤ä¸ä¸Šæ¸¸çš„è¿æ¥ã€‚ä¸ MUTUAL æ¨¡å¼ç›¸æ¯”ï¼Œè¯¥æ¨¡å¼ä½¿ç”¨ Istio è‡ªåŠ¨ç”Ÿæˆçš„è¯ä¹¦è¿›è¡Œ mTLS èº«ä»½éªŒè¯ã€‚ä½¿ç”¨æ­¤æ¨¡å¼æ—¶ï¼ŒClientTLSSettings ä¸­çš„æ‰€æœ‰å…¶ä»–å­—æ®µéƒ½åº”ä¸ºç©º</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†åœºæ™¯ä¸‹çš„ DestinationRule èµ„æºå¯¹è±¡ä½¿ç”¨èŒƒä¾‹ä¸ API ç»“æ„æ¦‚è§ˆ</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” VirtualService</title>
    <link href="http://shenxianghong.github.io/2022/08/05/2022-08-05%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Virtual%20Service/"/>
    <id>http://shenxianghong.github.io/2022/08/05/2022-08-05%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Virtual%20Service/</id>
    <published>2022-08-04T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.255Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>VirtualService å®šä¹‰äº†ä¸€ç»„æµé‡è·¯ç”±è§„åˆ™ï¼Œä»¥åœ¨ host è¢«å¯»å€æ—¶åº”ç”¨ã€‚æ¯ä¸ªè·¯ç”±è§„åˆ™éƒ½ä¸ºç‰¹å®šåè®®çš„æµé‡å®šä¹‰äº†åŒ¹é…æ ‡å‡†ã€‚å¦‚æœæµé‡åŒ¹é…ï¼Œåˆ™å°†å…¶å‘é€åˆ°æ³¨å†Œè¡¨ä¸­å®šä¹‰çš„å‘½åç›®æ ‡æœåŠ¡ï¼ˆæˆ–å…¶å­é›†&#x2F;ç‰ˆæœ¬ï¼‰</p><p>æµé‡æ¥æºä¹Ÿå¯ä»¥åœ¨è·¯ç”±è§„åˆ™ä¸­åŒ¹é…ã€‚è¿™å…è®¸ä¸ºç‰¹å®šçš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡å®šåˆ¶è·¯ç”±ã€‚</p><p><strong>Service</strong></p><p>ç»‘å®šåˆ° service registry ä¸­å”¯ä¸€åç§°çš„åº”ç”¨ç¨‹åºè¡Œä¸ºå•å…ƒã€‚Service ç”±å¤šä¸ª endpoints ç»„æˆï¼Œè¿™äº› endpoints ä¹Ÿå°±æ˜¯è¿è¡Œåœ¨ Podã€å®¹å™¨ã€VM ç­‰ä¸Šçš„å·¥ä½œè´Ÿè½½å®ä¾‹ã€‚</p><p><strong>Service versionsï¼ˆsubsetsï¼‰</strong></p><p>åœ¨æŒç»­éƒ¨ç½²åœºæ™¯ä¸­ï¼Œä¸€ä¸ªæœåŠ¡å¯ä»¥æœ‰ä¸åŒçš„å®ä¾‹å­é›†çš„ä¸åŒå˜ä½“ï¼Œè¿™äº›å˜ä½“ä¸ä¸€å®šæ˜¯ä¸åŒçš„ API ç‰ˆæœ¬ï¼Œå®ƒä»¬å¯èƒ½æ˜¯å¯¹åŒä¸€æœåŠ¡çš„è¿­ä»£æ›´æ”¹ï¼Œéƒ¨ç½²åœ¨ä¸åŒçš„ç¯å¢ƒï¼ˆprod, staging, dev ç­‰ï¼‰ä¸­ã€‚å¸¸è§åœºæ™¯åŒ…æ‹¬ A&#x2F;B æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒç­‰ã€‚ä¸åŒç‰ˆæœ¬çš„é€‰æ‹©å¯ä»¥æ ¹æ®å„ç§æ ‡å‡†ï¼ˆheaders, url ç­‰ï¼‰çš„æƒé‡æ¥å†³å®šã€‚æ¯ä¸ªæœåŠ¡éƒ½æœ‰ä¸€ä¸ªç”±å…¶æ‰€æœ‰å®ä¾‹ç»„æˆçš„é»˜è®¤ç‰ˆæœ¬ã€‚</p><p><strong>Source</strong></p><p>è°ƒç”¨æœåŠ¡çš„ä¸‹æ¸¸å®¢æˆ·ç«¯ã€‚</p><p><strong>Host</strong></p><p>å®¢æˆ·ç«¯å°è¯•è¿æ¥åˆ°æœåŠ¡æ—¶ä½¿ç”¨çš„åœ°å€ã€‚</p><p><strong>Access model</strong></p><p>åº”ç”¨ç¨‹åºä»…å¤„ç†ç›®æ ‡æœåŠ¡ï¼ˆHostï¼‰ï¼Œè€Œä¸çŸ¥é“å„ä¸ªæœåŠ¡ç‰ˆæœ¬ï¼ˆsubsetsï¼‰ã€‚ç‰ˆæœ¬çš„å®é™…é€‰æ‹©ç”±ä»£ç†æˆ–è€… sidecar å†³å®šï¼Œè¿™æ ·åº”ç”¨ç¨‹åºä»£ç èƒ½å¤Ÿå°†è‡ªèº«ä¸ä¾èµ–æœåŠ¡çš„è§£è€¦ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ç¤ºä¾‹é»˜è®¤å°†æ‰€æœ‰ HTTP æµé‡è·¯ç”±åˆ°æ ‡ç­¾ä¸º reviewï¼šv1 çš„ review æœåŠ¡çš„ Podã€‚æ­¤å¤–ï¼Œè·¯å¾„ä»¥ &#x2F;wpcatalog&#x2F; æˆ– &#x2F;consumercatalog&#x2F; å¼€å¤´çš„ HTTP è¯·æ±‚å°†è¢«é‡å†™ä¸º &#x2F;newcatalog å¹¶å‘é€åˆ°æ ‡ç­¾ä¸º version: v2 çš„ Podã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;reviews-v2-routes&quot;</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/wpcatalog&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/consumercatalog&quot;</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">&quot;/newcatalog&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;reviews-v1-route&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><p>è·¯ç”±ç›®çš„åœ°çš„å­é›†æˆ–è€…ç‰ˆæœ¬é€šè¿‡å¯¹å¿…é¡»åœ¨ç›¸åº” DestinationRule ä¸­å£°æ˜çš„å‘½åæœåŠ¡å­é›†çš„å¼•ç”¨æ¥æ ‡è¯†ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-destination</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br></pre></td></tr></table></figure><h1 id="VirtualService"><a href="#VirtualService" class="headerlink" title="VirtualService"></a>VirtualService</h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>hosts</td><td>å‘å…¶å‘é€æµé‡çš„ç›®æ ‡ä¸»æœºï¼ˆåªæœ‰è®¿é—®å®¢æˆ·ç«¯çš„ Host å­—æ®µä¸º hosts é…ç½®çš„åœ°å€æ‰èƒ½è·¯ç”±åˆ°åç«¯æœåŠ¡ï¼‰ã€‚å¯ä»¥æ˜¯å¸¦æœ‰é€šé…ç¬¦å‰ç¼€çš„ DNS åç§°æˆ– IP åœ°å€ã€‚æ ¹æ®å¹³å°çš„ä¸åŒï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨çŸ­åç§°ä»£æ›¿ FQDNï¼ˆå³åç§°ä¸­æ²¡æœ‰ç‚¹ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸»æœºçš„ FQDN å°†åŸºäºåº•å±‚å¹³å°æ´¾ç”Ÿ<br />å•ä¸ª VirtualService å¯ç”¨äºæè¿°ç›¸åº” host çš„æ‰€æœ‰æµé‡å±æ€§ï¼ŒåŒ…æ‹¬å¤šä¸ª HTTP å’Œ TCP ç«¯å£çš„æµé‡å±æ€§ã€‚æˆ–è€…ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ª VirtualService å®šä¹‰ host çš„æµé‡å±æ€§ï¼Œä½†æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œå‚é˜…<a href="https://istio.io/latest/docs/ops/best-practices/traffic-management/#split-virtual-services">æ“ä½œæŒ‡å—</a><br />Kubernetes ç”¨æˆ·æ³¨æ„äº‹é¡¹ï¼šå½“ä½¿ç”¨çŸ­åç§°æ—¶ï¼ˆä¾‹å¦‚ reviews è€Œä¸æ˜¯ reviews.default.svc.cluster.localï¼‰ï¼ŒIstio å°†æ ¹æ®è§„åˆ™çš„å‘½åç©ºé—´è€Œä¸æ˜¯æœåŠ¡æ¥è§£æçŸ­åç§°ã€‚åä¸º reviews çš„ host åœ¨ default å‘½åç©ºé—´ä¸­çš„è§„åˆ™å°†è¢«è§£æä¸º reviews.default.svc.cluster.localï¼Œè€Œä¸ reviews æœåŠ¡å…³è”çš„å®é™…å‘½åç©ºé—´æ— å…³ã€‚ä¸ºé¿å…æ½œåœ¨çš„é”™è¯¯é…ç½®ï¼Œå»ºè®®å§‹ç»ˆä½¿ç”¨å®Œå…¨é™å®šåŸŸåè€Œä¸æ˜¯çŸ­åç§°<br />hosts å­—æ®µé€‚ç”¨äº HTTP å’Œ TCP æœåŠ¡ã€‚ç½‘æ ¼å†…çš„æœåŠ¡ï¼Œå³æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ï¼Œå¿…é¡»å§‹ç»ˆä½¿ç”¨å®ƒä»¬çš„å­—æ¯æ•°å­—åç§°æ¥å¼•ç”¨ã€‚ IP åœ°å€ä»…å…è®¸ç”¨äºé€šè¿‡ Gateway å®šä¹‰çš„æœåŠ¡<br />æ³¨æ„ï¼šå¯¹äº delegate VirtualService è€Œè¨€ï¼Œå¿…é¡»ä¸ºç©ºã€‚</td></tr><tr><td>gateways</td><td>åº”ç”¨è¿™äº›è·¯ç”±è§„åˆ™çš„ Gateway å’Œ sidecar çš„åç§°ã€‚ å…¶ä»–å‘½åç©ºé—´ä¸­çš„ Gateway çš„å¼•ç”¨æ–¹å¼ä¸º&lt;gateway namespace&gt;&#x2F;&lt;gateway name&gt;ï¼›æŒ‡å®šæ²¡æœ‰æ˜¾å¼çš„æŒ‡å®šå‘½åç©ºé—´åˆ™ä¸ VirtualService çš„å‘½åç©ºé—´ç›¸åŒã€‚å•ä¸ª VirtualService ç”¨äºç½‘æ ¼å†…çš„ sidecar ä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ª Gatewayã€‚å¯ä»¥ä½¿ç”¨åè®®ç‰¹å®šè·¯ç”±çš„åŒ¹é…æ¡ä»¶ä¸­çš„æºå­—æ®µè¦†ç›–è¯¥å­—æ®µå¼ºåŠ çš„é€‰æ‹©æ¡ä»¶ã€‚ä¿ç•™å­— mesh ç”¨äºè¡¨è¿°ç½‘æ ¼ä¸­çš„æ‰€æœ‰ sidecarã€‚å½“çœç•¥è¯¥å­—æ®µæ—¶ï¼Œå°†ä½¿ç”¨é»˜è®¤ Gateway å³ meshï¼Œè¿™ä¼šå°†è§„åˆ™åº”ç”¨äºç½‘æ ¼ä¸­çš„æ‰€æœ‰ sidecarã€‚å¦‚æœæä¾›äº† Gateway åç§°åˆ—è¡¨ï¼Œåˆ™è§„åˆ™å°†ä»…é€‚ç”¨è¯¥ç›¸å…³çš„ Gatewayã€‚è¦å°†è§„åˆ™åº”ç”¨äº Gateway å’Œ sidecarï¼Œè¯·å°† mesh æŒ‡å®šä¸º gateways ä¹‹ä¸€</td></tr><tr><td><a href="#HTTPRoute">http</a></td><td>HTTP æµé‡çš„è·¯ç”±è§„åˆ™çš„æœ‰åºåˆ—è¡¨ã€‚ ä½¿ç”¨åŒ¹é…ä¼ å…¥è¯·æ±‚çš„ç¬¬ä¸€ä¸ªè§„åˆ™</td></tr><tr><td><a href="#TLSRoute">tls</a></td><td>An ordered list of route rule for non-terminated TLS &amp; HTTPS traffic. Routing is typically performed using the SNI value presented by the ClientHello message. TLS routes will be applied to platform service ports named â€˜https-*â€™, â€˜tls-*â€™, unterminated gateway ports using HTTPS&#x2F;TLS protocols (i.e. with â€œpassthroughâ€ TLS mode) and service entry ports using HTTPS&#x2F;TLS protocols. The first rule matching an incoming request is used. NOTE: Traffic â€˜https-*â€™ or â€˜tls-*â€™ ports without associated virtual service will be treated as opaque TCP traffic.</td></tr><tr><td><a href="#TCPRoute">tcp</a></td><td>ä¸é€æ˜ TCP æµé‡çš„è·¯ç”±è§„åˆ™çš„æœ‰åºåˆ—è¡¨ã€‚ TCP è·¯ç”±å°†åº”ç”¨äºä¸æ˜¯ HTTP æˆ– TLS ç«¯å£çš„ä»»ä½•ç«¯å£ã€‚ä½¿ç”¨åŒ¹é…ä¼ å…¥è¯·æ±‚çš„ç¬¬ä¸€ä¸ªè§„åˆ™</td></tr><tr><td>exportTo</td><td>æ­¤ VirtualService æš´éœ²åˆ°çš„å‘½åç©ºé—´åˆ—è¡¨ã€‚æš´éœ² VirtualService å…è®¸å®ƒè¢«å…¶ä»–å‘½åç©ºé—´ä¸­å®šä¹‰çš„ sidecar å’Œ Gateway ä½¿ç”¨ã€‚æ­¤åŠŸèƒ½ä¸ºæœåŠ¡æ‰€æœ‰è€…å’Œç½‘æ ¼ç®¡ç†å‘˜æä¾›äº†ä¸€ç§æœºåˆ¶æ¥æ§åˆ¶è·¨å‘½åç©ºé—´è¾¹ç•Œçš„ VirtualService çš„å¯è§æ€§<br />å¦‚æœæœªæŒ‡å®šå‘½åç©ºé—´ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹å°† VirtualService æš´éœ²åˆ°æ‰€æœ‰å‘½åç©ºé—´<br /> . ä¸ºä¿ç•™æ ‡è¯†ä»£è¡¨æš´éœ²åˆ° VirtualService çš„åŒä¸€å‘½åç©ºé—´ä¸­ã€‚ç±»ä¼¼åœ°ï¼Œ* ä»£è¡¨æš´éœ²åˆ°æ‰€æœ‰å‘½åç©ºé—´</td></tr></tbody></table><h1 id="Destination"><a href="#Destination" class="headerlink" title="Destination"></a>Destination</h1><p>Destination è¡¨ç¤ºåœ¨å¤„ç†è·¯ç”±è§„åˆ™åå°†è¯·æ±‚ï¼ˆè¿æ¥ï¼‰å‘é€åˆ°çš„ç½‘ç»œå¯å¯»å€æœåŠ¡ã€‚ destination.host åº”è¯¥æ˜ç¡®å¼•ç”¨æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ã€‚ Istio çš„æœåŠ¡æ³¨å†Œè¡¨ç”±å¹³å°æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ‰€æœ‰æœåŠ¡ï¼ˆä¾‹å¦‚ Kubernetes æœåŠ¡ã€Consul æœåŠ¡ï¼‰ä»¥åŠé€šè¿‡ ServiceEntry èµ„æºå£°æ˜çš„æœåŠ¡ç»„æˆã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹ä¸­é»˜è®¤å°†æ‰€æœ‰æµé‡è·¯ç”±åˆ°å¸¦æœ‰æ ‡ç­¾ versionï¼šv1ï¼ˆå³ subset v1ï¼‰çš„ review æœåŠ¡çš„ Podï¼Œå¹¶å°†ç¬¦åˆæ¡ä»¶çš„è·¯ç”±åˆ° subset v2ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">foo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span> <span class="comment"># interpreted as reviews.foo.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/wpcatalog&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/consumercatalog&quot;</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">&quot;/newcatalog&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span> <span class="comment"># interpreted as reviews.foo.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span> <span class="comment"># interpreted as reviews.foo.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ VirtualService ä¸º productpage.prod.svc.cluster.local æœåŠ¡çš„è®¾ç½®äº† 5s çš„è¶…æ—¶æ—¶é—´ã€‚æ­¤è§„åˆ™ä¸­æ²¡æœ‰å®šä¹‰å­é›†ï¼ŒIstio å°†ä»æœåŠ¡æ³¨å†Œè¡¨ä¸­è·å– productpage.prod.svc.cluster.local æœåŠ¡çš„æ‰€æœ‰å®ä¾‹ï¼Œå¹¶å¡«å…… sidecar çš„è´Ÿè½½å‡è¡¡æ± ã€‚å¦å¤–ï¼Œæ­¤è§„åˆ™è®¾ç½®åœ¨ istio-system å‘½åç©ºé—´ä¸­ï¼Œä½†ä½¿ç”¨çš„æ˜¯ productpage æœåŠ¡çš„å®Œå…¨é™å®šåŸŸå productpage.prod.svc.cluster.localã€‚å› æ­¤ï¼Œè§„åˆ™çš„å‘½åç©ºé—´å¯¹è§£æ productpage æœåŠ¡çš„åç§°æ²¡æœ‰å½±å“ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-productpage-rule</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">productpage.prod.svc.cluster.local</span> <span class="comment"># ignores rule namespace</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">productpage.prod.svc.cluster.local</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†è·¯ç”±åˆ°ç½‘æ ¼å¤–æœåŠ¡çš„æµé‡ï¼Œå¿…é¡»é¦–å…ˆä½¿ç”¨ ServiceEntry èµ„æºå°†å¤–éƒ¨æœåŠ¡æ·»åŠ åˆ° Istio çš„å†…éƒ¨æœåŠ¡æ³¨å†Œè¡¨ä¸­ã€‚ç„¶åå¯ä»¥å®šä¹‰ VirtualServices æ¥æ§åˆ¶ç»‘å®šåˆ°è¿™äº›å¤–éƒ¨æœåŠ¡çš„æµé‡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™ä¸º wikipedia.org å®šä¹‰äº†ä¸€ä¸ª Serviceï¼Œå¹¶ä¸º HTTP è¯·æ±‚è®¾ç½®äº† 5s çš„è¶…æ—¶æ—¶é—´ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-wikipedia</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wikipedia.org</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">example-http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-wiki-rule</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wikipedia.org</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">wikipedia.org</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>host</td><td>æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡åç§°ã€‚æœåŠ¡åç§°ä»å¹³å°çš„æœåŠ¡æ³¨å†Œè¡¨ï¼ˆä¾‹å¦‚ï¼ŒKubernetes æœåŠ¡ã€Consul æœåŠ¡ç­‰ï¼‰å’Œ ServiceEntry å£°æ˜çš„ host ä¸­æŸ¥æ‰¾ã€‚ä¸¤è€…éƒ½æ‰¾ä¸åˆ°çš„æµé‡å°†è¢«ä¸¢å¼ƒã€‚<br /><em>åŒæ ·çš„ï¼Œæ¨èä½¿ç”¨å®Œå…¨é™å®šåŸŸå</em></td></tr><tr><td>subset</td><td>æœåŠ¡ä¸­å­é›†çš„åç§°ã€‚ä»…é€‚ç”¨äºç½‘æ ¼å†…çš„æœåŠ¡ã€‚å­é›†å¿…é¡»åœ¨ç›¸åº”çš„ DestinationRule ä¸­å®šä¹‰</td></tr><tr><td><a href="#PortSelector">port</a></td><td>æŒ‡å®šå¯»å€ç›®æ ‡ä¸»æœºä¸Šçš„ç«¯å£ã€‚å¦‚æœæœåŠ¡åªå…¬å¼€ä¸€ä¸ªç«¯å£ï¼Œåˆ™ä¸éœ€è¦æ˜¾å¼é€‰æ‹©ç«¯å£</td></tr></tbody></table><h1 id="HTTPRoute"><a href="#HTTPRoute" class="headerlink" title="HTTPRoute"></a><a name="HTTPRoute">HTTPRoute</a></h1><p>æè¿°è·¯ç”± HTTP&#x2F;1.1ã€HTTP2 å’Œ gRPC æµé‡çš„åŒ¹é…æ¡ä»¶å’Œè¡Œä¸ºã€‚æœ‰å…³ä½¿ç”¨ç¤ºä¾‹ï¼Œè¯·å‚é˜… VirtualServiceã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>name</td><td>åˆ†é…ç»™è·¯ç”±çš„åç§°ï¼Œç”¨ä½œè°ƒè¯•ã€‚è¯¥åç§°å°†ä¸åŒ¹é…çš„è·¯ç”±ç»“æœä¸€èµ·è®°å½•åœ¨è®¿é—®æ—¥å¿—</td></tr><tr><td><a href="#HTTPMatchRequest">match</a></td><td>åº”ç”¨è§„åˆ™éœ€è¦æ»¡è¶³çš„åŒ¹é…æ¡ä»¶ã€‚å•ä¸ªåŒ¹é…å—å†…çš„æ‰€æœ‰æ¡ä»¶éƒ½å…·æœ‰ AND è¯­ä¹‰ï¼Œè€ŒåŒ¹é…å—åˆ—è¡¨å…·æœ‰ OR è¯­ä¹‰ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªåŒ¹é…å—åŒ¹é…æˆåŠŸï¼Œåˆ™åº”ç”¨è¯¥è§„åˆ™</td></tr><tr><td><a href="#HTTPRouteDestination">route</a></td><td>HTTP è§„åˆ™å¯ä»¥é‡å®šå‘æˆ–è½¬å‘ï¼ˆé»˜è®¤ï¼‰æµé‡ã€‚è½¬å‘ç›®æ ‡å¯ä»¥æ˜¯æœåŠ¡çš„å¤šä¸ªç‰ˆæœ¬ä¹‹ä¸€ï¼ˆsubsetï¼‰ã€‚ä¸æœåŠ¡ç‰ˆæœ¬ç›¸å…³çš„æƒé‡å†³å®šäº†å®ƒæ¥æ”¶çš„æµé‡æ¯”ä¾‹</td></tr><tr><td><a href="#HTTPRedirect">redirect</a></td><td>HTTP è§„åˆ™å¯ä»¥é‡å®šå‘æˆ–è½¬å‘ï¼ˆé»˜è®¤ï¼‰æµé‡ã€‚å¦‚æœåœ¨è§„åˆ™ä¸­æŒ‡å®šäº†æµé‡ç›´é€šé€‰é¡¹ï¼Œåˆ™é‡å®šå‘å°†è¢«å¿½ç•¥ã€‚é‡å®šå‘å¯ç”¨äºå°† HTTP 301 é‡å®šå‘å‘é€åˆ°ä¸åŒçš„ URI</td></tr><tr><td><a href="#Delegate">delegate</a></td><td>å§”æ‰˜æ˜¯æŒ‡å®šå¯ç”¨äºå®šä¹‰å§”æ‰˜ HTTPRoute çš„ç‰¹å®š VirtualServiceã€‚åªæœ‰Routeå’ŒRedirectéƒ½ä¸ºç©ºæ—¶æ‰å¯ä»¥è®¾ç½®ï¼Œå¹¶ä¸”delegate VirtualServiceçš„è·¯ç”±è§„åˆ™ä¼šä¸å½“å‰çš„è·¯ç”±è§„åˆ™åˆå¹¶ã€‚<br /><em>æ³¨æ„ï¼šä»…æ”¯æŒä¸€çº§å§”æ´¾ï¼Œdelegate çš„ HTTPMatchRequest å¿…é¡»æ˜¯ root çš„ä¸¥æ ¼å­é›†ï¼Œå¦åˆ™ä¼šå‘ç”Ÿå†²çªï¼ŒHTTPRoute ä¸ä¼šç”Ÿæ•ˆ</em></td></tr><tr><td><a href="#HTTPRewrite">rewrite</a></td><td>é‡å†™ HTTP URI å’Œ Authority headerã€‚ Rewrite ä¸èƒ½ä¸ Redirect åŸè¯­ä¸€èµ·ä½¿ç”¨ã€‚è½¬å‘å‰ä¼šè¿›è¡Œé‡å†™</td></tr><tr><td>timeout</td><td>HTTP è¯·æ±‚è¶…æ—¶ï¼Œé»˜è®¤ç¦ç”¨</td></tr><tr><td><a href="#HTTPRetry">retries</a></td><td>HTTP è¯·æ±‚çš„é‡è¯•ç­–ç•¥</td></tr><tr><td><a href="#HTTPFaultInjection">fault</a></td><td>æ•…éšœæ³¨å…¥ç­–ç•¥åº”ç”¨äºå®¢æˆ·ç«¯çš„ HTTP æµé‡ã€‚<br /><em>æ³¨æ„ï¼Œåœ¨å®¢æˆ·ç«¯å¯ç”¨æ•…éšœæ—¶ï¼Œå°†ä¸ä¼šå¯ç”¨è¶…æ—¶æˆ–é‡è¯•</em></td></tr><tr><td><a href="#Destination">mirror</a></td><td>é™¤äº†å°†è¯·æ±‚è½¬å‘åˆ°é¢„æœŸç›®æ ‡ä¹‹å¤–ï¼Œè¿˜å°† HTTP æµé‡é•œåƒåˆ°å¦ä¸€ä¸ªç›®æ ‡ã€‚é•œåƒæµé‡æ˜¯åœ¨å°½åŠ›è€Œä¸ºçš„åŸºç¡€ä¸Šï¼Œsidercar &#x2F; gateway åœ¨ä»åŸå§‹ç›®çš„åœ°è¿”å›å“åº”ä¹‹å‰ä¸ä¼šç­‰å¾…é•œåƒé›†ç¾¤å“åº”ã€‚ä¼šä¸ºé•œåƒç›®çš„åœ°ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯ã€‚</td></tr><tr><td><a href="#Percent">mirrorPercentage</a></td><td>è¦é•œåƒçš„æµé‡ç™¾åˆ†æ¯”ã€‚é»˜è®¤ä¸ºæ‰€æœ‰çš„æµé‡ï¼ˆ100%ï¼‰éƒ½ä¼šè¢«é•œåƒã€‚æœ€å¤§å€¼ä¸º 100%ã€‚</td></tr><tr><td><a href="#CorsPolicy">corsPolicy</a></td><td>è·¨åŸŸèµ„æºå…±äº«ç­–ç•¥ (CORS)ã€‚æœ‰å…³è·¨æºèµ„æºå…±äº«çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a></td></tr><tr><td><a href="#Headers">headers</a></td><td>Header æ“ä½œè§„åˆ™</td></tr></tbody></table><h1 id="Delegate"><a href="#Delegate" class="headerlink" title="Delegate"></a><a name="Delegate">Delegate</a></h1><p>åœ¨ Istio 1.5 ä¸­ï¼ŒVirtualService èµ„æºä¹‹é—´æ˜¯æ— æ³•è¿›è¡Œè½¬å‘çš„ï¼Œåœ¨ Istio 1.6 ç‰ˆæœ¬ä¸­è§„åˆ’äº† VirtualService Chain æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ delegate é…ç½®é¡¹å°†ä¸€ä¸ª VirtualService ä»£ç†åˆ°å¦å¤–ä¸€ä¸ª VirtualService ä¸­è¿›è¡Œè§„åˆ™åŒ¹é…ã€‚</p><p>ä¾‹å¦‚ï¼Œè·¯ç”±è§„åˆ™é€šè¿‡åä¸º productpage çš„å§”æ‰˜ VirtualService å°†æµé‡è½¬å‘åˆ° &#x2F;productpageï¼Œé€šè¿‡åä¸º reviews çš„å§”æ‰˜ VirtualService å°†æµé‡è½¬å‘åˆ° &#x2F;reviewsã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;bookinfo.com&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygateway</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/productpage&quot;</span></span><br><span class="line">    <span class="attr">delegate:</span></span><br><span class="line">       <span class="attr">name:</span> <span class="string">productpage</span></span><br><span class="line">       <span class="attr">namespace:</span> <span class="string">nsA</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/reviews&quot;</span></span><br><span class="line">    <span class="attr">delegate:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">nsB</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">productpage</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nsA</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/productpage/v1/&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">productpage-v1.nsA.svc.cluster.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">productpage.nsA.svc.cluster.local</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nsB</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.nsB.svc.cluster.local</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>name</td><td>å§”æ‰˜ VirtualService çš„åç§°</td></tr><tr><td>namespace</td><td>å§”æ‰˜ VirtualService æ‰€åœ¨çš„å‘½åç©ºé—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¸æ ¹çš„ç›¸åŒ</td></tr></tbody></table><h1 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a><a name="Headers">Headers</a></h1><p>å½“ Envoy å°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡æœåŠ¡æˆ–ä»ç›®æ ‡æœåŠ¡è½¬å‘å“åº”æ—¶ï¼Œå¯ä»¥æ“ä½œ header ä¿¡æ¯ã€‚å¯ä»¥ä¸ºç‰¹å®šè·¯ç”±ç›®çš„åœ°æˆ–æ‰€æœ‰ç›®çš„åœ°æŒ‡å®š header æ“ä½œè§„åˆ™ã€‚ä»¥ä¸‹ VirtualService å°†å€¼ä¸º test: true çš„è¯·æ±‚å¤´æ·»åŠ åˆ°è·¯ç”±åˆ°ä»»ä½• reviews æœåŠ¡ç›®æ ‡çš„è¯·æ±‚ä¸­ã€‚åŒæ—¶ï¼Œåˆ é™¤äº†ä»…æ¥è‡ª reviews æœåŠ¡çš„ v1 ç‰ˆæœ¬çš„å“åº”å¤´ä¸­çš„ fooã€‚ </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">      <span class="attr">request:</span></span><br><span class="line">        <span class="attr">set:</span></span><br><span class="line">          <span class="attr">test:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">25</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">response:</span></span><br><span class="line">          <span class="attr">remove:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">75</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#HeaderOperations">request</a></td><td>åœ¨å°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡æœåŠ¡ä¹‹å‰åº”ç”¨çš„æ ‡å¤´æ“ä½œè§„åˆ™</td></tr><tr><td><a href="#HeaderOperations">response</a></td><td>åœ¨å‘è°ƒç”¨è€…è¿”å›å“åº”ä¹‹å‰åº”ç”¨çš„æ ‡å¤´æ“ä½œè§„åˆ™</td></tr></tbody></table><h1 id="TLSRoute"><a href="#TLSRoute" class="headerlink" title="TLSRoute"></a><a name="TLSRoute">TLSRoute</a></h1><p>æè¿°è·¯ç”±æœªç»ˆæ­¢çš„ TLS æµé‡ (TLS&#x2F;HTTPS) çš„åŒ¹é…æ¡ä»¶å’Œæ“ä½œã€‚</p><p>ä»¥ä¸‹è·¯ç”±è§„åˆ™æ ¹æ® SNI å€¼å°†åˆ°è¾¾åä¸º mygateway çš„ Gateway çš„ç«¯å£ 443 çš„æœªç»ˆæ­¢ TLS æµé‡è½¬å‘åˆ°ç½‘æ ¼ä¸­çš„å†…éƒ¨æœåŠ¡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-sni</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*.bookinfo.com&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygateway</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">sniHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">login.bookinfo.com</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">login.prod.svc.cluster.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">sniHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">reviews.bookinfo.com</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#TLSMatchAttributes%5B%5D">match</a></td><td>åº”ç”¨è§„åˆ™éœ€è¦æ»¡è¶³çš„åŒ¹é…æ¡ä»¶ã€‚å•ä¸ªåŒ¹é…å—å†…çš„æ‰€æœ‰æ¡ä»¶éƒ½å…·æœ‰ AND è¯­ä¹‰ï¼Œè€ŒåŒ¹é…å—åˆ—è¡¨å…·æœ‰ OR è¯­ä¹‰ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªåŒ¹é…å—åŒ¹é…æˆåŠŸï¼Œåˆ™åº”ç”¨è¯¥è§„åˆ™</td></tr><tr><td><a href="#RouteDestination">route</a></td><td>è¿æ¥åº”è½¬å‘åˆ°çš„ç›®çš„åœ°</td></tr></tbody></table><h1 id="TCPRoute"><a href="#TCPRoute" class="headerlink" title="TCPRoute"></a><a name="TCPRoute">TCPRoute</a></h1><p>æè¿°è·¯ç”± TCP æµé‡çš„åŒ¹é…æ¡ä»¶å’Œæ“ä½œã€‚</p><p>ä»¥ä¸‹è·¯ç”±è§„åˆ™å°†åˆ°è¾¾ç«¯å£ 27017 çš„ mongo.prod.svc.cluster.local çš„æµé‡è½¬å‘åˆ°ç«¯å£ 5555 ä¸Šçš„å¦ä¸€ä¸ª Mongo æœåŠ¡å™¨ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-mongo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mongo.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">tcp:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">mongo.backup.svc.cluster.local</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">5555</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#L4MatchAttributes%5B%5D">match</a></td><td>åº”ç”¨è§„åˆ™éœ€è¦æ»¡è¶³çš„åŒ¹é…æ¡ä»¶ã€‚å•ä¸ªåŒ¹é…å—å†…çš„æ‰€æœ‰æ¡ä»¶éƒ½å…·æœ‰ AND è¯­ä¹‰ï¼Œè€ŒåŒ¹é…å—åˆ—è¡¨å…·æœ‰ OR è¯­ä¹‰ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªåŒ¹é…å—åŒ¹é…æˆåŠŸï¼Œåˆ™åº”ç”¨è¯¥è§„åˆ™</td></tr><tr><td><a href="#RouteDestination%5B%5D">route</a></td><td>è¿æ¥åº”è½¬å‘åˆ°çš„ç›®çš„åœ°</td></tr></tbody></table><h1 id="HTTPMatchRequest"><a href="#HTTPMatchRequest" class="headerlink" title="HTTPMatchRequest"></a><a name="HTTPMatchRequest">HTTPMatchRequest</a></h1><p>HttpMatchRequest æŒ‡å®šè¦æ»¡è¶³çš„ä¸€ç»„æ ‡å‡†ï¼Œä»¥ä¾¿å°†è§„åˆ™åº”ç”¨äº HTTP è¯·æ±‚ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹å†…å®¹å°†è§„åˆ™é™åˆ¶ä¸ºä»…åŒ¹é… URL è·¯å¾„ä»¥ &#x2F;ratings&#x2F;v2&#x2F; å¼€å¤´çš„è¯·æ±‚ï¼Œå¹¶ä¸”è¯·æ±‚åŒ…å«å…·æœ‰å€¼ jason çš„è‡ªå®šä¹‰æœ€ç»ˆç”¨æˆ·æ ‡å¤´ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">end-user:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">jason</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/ratings/v2/&quot;</span></span><br><span class="line">      <span class="attr">ignoreUriCase:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br></pre></td></tr></table></figure><p>HTTPMatchRequest ä¸èƒ½ä¸ºç©ºã€‚æ³¨æ„ï¼šæŒ‡å®šå§”æ‰˜ VirtualService æ—¶ï¼Œä¸èƒ½è®¾ç½®æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²åŒ¹é…ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>name</td><td>åˆ†é…ç»™åŒ¹é…é¡¹çš„åç§°ã€‚åŒ¹é…çš„åç§°å°†ä¸çˆ¶è·¯ç”±çš„åç§°ä¸€åŒè®°å½•åœ¨ä¸è¯¥è·¯ç”±åŒ¹é…çš„è¯·æ±‚çš„è®¿é—®æ—¥å¿—ä¸­</td></tr><tr><td><a href="#StringMatch">uri</a></td><td>åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰<br /><em>æ³¨æ„ï¼šå¯ä»¥é€šè¿‡ ignore_uri_case æ ‡å¿—å¯ç”¨ä¸åŒºåˆ†å¤§å°å†™çš„åŒ¹é…</em></td></tr><tr><td><a href="#StringMatch">scheme</a></td><td>åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰</td></tr><tr><td><a href="#StringMatch">method</a></td><td>åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰</td></tr><tr><td><a href="#StringMatch">authority</a></td><td>åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰</td></tr><tr><td><a href="#StringMatch">headers</a></td><td>header çš„ key å¿…é¡»ä¸ºå°å†™å¹¶ä½¿ç”¨è¿å­—ç¬¦ä½œä¸ºåˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ x-request-idã€‚åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰ã€‚å¦‚æœè¯¥å€¼ä¸ºç©ºå¹¶ä¸”ä»…æŒ‡å®šäº† header çš„åç§°ï¼Œåˆ™æ£€æŸ¥æ ‡å¤´çš„å­˜åœ¨<br /><em>æ³¨æ„ï¼šé”® uriã€schemeã€method å’Œ authority å°†è¢«å¿½ç•¥</em></td></tr><tr><td>port</td><td>æŒ‡å®šæ­£åœ¨å¯»å€çš„ host ä¸Šçš„ç«¯å£ã€‚è®¸å¤šæœåŠ¡åªå…¬å¼€å•ä¸ªç«¯å£æˆ–ä½¿ç”¨å®ƒä»¬æ”¯æŒçš„åè®®æ ‡è®°ç«¯å£ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ˜¾å¼é€‰æ‹©ç«¯å£</td></tr><tr><td>sourceLabels</td><td>ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œç”¨äºé™åˆ¶è§„åˆ™å¯¹å…·æœ‰ç»™å®šæ ‡ç­¾çš„æºï¼ˆå®¢æˆ·ç«¯ï¼‰å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td></tr><tr><td>gateways</td><td>å¾…åº”ç”¨è§„åˆ™çš„ç½‘å…³çš„åç§°ã€‚ VirtualService çš„é¡¶çº§ gateways å­—æ®µä¸­çš„ç½‘å…³åç§°ï¼ˆå¦‚æœæœ‰ï¼‰è¢«è¦†ç›–ã€‚Gateway åŒ¹é…ç‹¬ç«‹äº sourceLabels</td></tr><tr><td><a href="#StringMatch">queryParams</a></td><td>ç”¨äºåŒ¹é…çš„æŸ¥è¯¢å‚æ•°ï¼Œä¾‹å¦‚ exact: â€œtrueâ€ï¼Œextact: â€œâ€ å’Œ regex: â€œ\d+$â€<br /><em>æ³¨æ„ï¼šç›®å‰ä¸æ”¯æŒå‰ç¼€åŒ¹é…</em></td></tr><tr><td>ignoreUriCase</td><td>ç”¨äºæŒ‡å®š URI åŒ¹é…æ˜¯å¦ä¸åŒºåˆ†å¤§å°å†™çš„æ ‡å¿—ã€‚<br /><em>æ³¨æ„ï¼šåªæœ‰åœ¨å®Œå…¨å’Œå‰ç¼€ URI åŒ¹é…çš„æƒ…å†µä¸‹æ‰ä¼šå¿½ç•¥å¤§å°å†™</em></td></tr><tr><td><a href="#StringMatch">withoutHeaders</a></td><td>withoutHeaders ä¸ header çš„è¯­æ³•ç›¸åŒï¼Œä½†å«ä¹‰ç›¸åã€‚å¦‚æœ header ä¸ withoutHeaders ä¸­çš„åŒ¹é…è§„åˆ™åŒ¹é…ï¼Œåˆ™æµé‡å˜ä¸ºä¸åŒ¹é…</td></tr><tr><td>sourceNamespace</td><td>æºå‘½åç©ºé—´é™åˆ¶è§„åˆ™å¯¹è¯¥å‘½åç©ºé—´ä¸­å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td></tr></tbody></table><h1 id="HTTPRouteDestination"><a href="#HTTPRouteDestination" class="headerlink" title="HTTPRouteDestination"></a><a name="HTTPRouteDestination">HTTPRouteDestination</a></h1><p>æ¯ä¸ªè·¯ç”±è§„åˆ™éƒ½ä¸ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ç‰ˆæœ¬ç›¸å…³è”ã€‚ä¸ç‰ˆæœ¬ç›¸å…³çš„æƒé‡å†³å®šäº†å®ƒæ¥æ”¶çš„æµé‡æ¯”ä¾‹ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™ä¼šå°† reviews æœåŠ¡çš„ 25% æµé‡è·¯ç”±åˆ° v2 ç‰ˆæœ¬çš„å®ä¾‹ä¸­ï¼Œè€Œå‰©ä½™æµé‡ï¼ˆå³ 75%ï¼‰å°†è·¯ç”±åˆ° v1 ç‰ˆæœ¬ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">25</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">75</span></span><br></pre></td></tr></table></figure><p>æµé‡ä¹Ÿå¯ä»¥åˆ†æˆä¸¤ä¸ªå®Œå…¨ä¸åŒçš„æœåŠ¡ï¼Œè€Œæ— éœ€å®šä¹‰æ–°çš„å­é›†ï¼ˆä¹Ÿå°±æ˜¯å†…éƒ¨åˆ†æµï¼‰ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å°† 25% çš„æµé‡ä» reviews.com è½¬å‘åˆ° dev.reviews.comã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route-two-domains</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.com</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">dev.reviews.com</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">25</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.com</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">75</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#Destination">destination</a></td><td>è¯·æ±‚&#x2F;è¿æ¥åº”è½¬å‘åˆ°çš„æœåŠ¡å®ä¾‹</td></tr><tr><td>weight</td><td>è¦è½¬å‘åˆ°ç›®çš„åœ°çš„æµé‡çš„ç›¸å¯¹æ¯”ä¾‹ï¼ˆå³æƒé‡&#x2F;æ‰€æœ‰æƒé‡çš„æ€»å’Œï¼‰ã€‚å¦‚æœè§„åˆ™ä¸­åªæœ‰ä¸€ä¸ªç›®çš„åœ°ï¼Œå®ƒå°†æ¥æ”¶æ‰€æœ‰æµé‡ã€‚å¦‚æœæƒé‡ä¸º 0ï¼Œåˆ™ç›®çš„åœ°å°†ä¸ä¼šæ”¶åˆ°ä»»ä½•æµé‡</td></tr><tr><td><a href="#Headers">headers</a></td><td>header æ“ä½œè§„åˆ™</td></tr></tbody></table><h1 id="RouteDestination"><a href="#RouteDestination" class="headerlink" title="RouteDestination"></a><a name="RouteDestination">RouteDestination</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#Destination">destination</a></td><td>è¯·æ±‚&#x2F;è¿æ¥åº”è½¬å‘åˆ°çš„æœåŠ¡å®ä¾‹</td></tr><tr><td>weight</td><td>è¦è½¬å‘åˆ°ç›®çš„åœ°çš„æµé‡çš„ç›¸å¯¹æ¯”ä¾‹ï¼ˆå³æƒé‡&#x2F;æ‰€æœ‰æƒé‡çš„æ€»å’Œï¼‰ã€‚å¦‚æœè§„åˆ™ä¸­åªæœ‰ä¸€ä¸ªç›®çš„åœ°ï¼Œå®ƒå°†æ¥æ”¶æ‰€æœ‰æµé‡ã€‚å¦‚æœæƒé‡ä¸º 0ï¼Œåˆ™ç›®çš„åœ°å°†ä¸ä¼šæ”¶åˆ°ä»»ä½•æµé‡</td></tr></tbody></table><h1 id="L4MatchAttributes"><a href="#L4MatchAttributes" class="headerlink" title="L4MatchAttributes"></a><a name="L4MatchAttributes">L4MatchAttributes</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>destinationSubnets</td><td>å¸¦æœ‰å¯é€‰å­ç½‘çš„ç›®æ ‡ IPv4 æˆ– IPv6 IP åœ°å€ã€‚ä¾‹å¦‚ï¼Œa.b.c.d&#x2F;xx  æˆ–åªæ˜¯ a.b.c.d</td></tr><tr><td>port</td><td>æŒ‡å®šæ­£åœ¨å¯»å€çš„ host ä¸Šçš„ç«¯å£ã€‚è®¸å¤šæœåŠ¡åªå…¬å¼€å•ä¸ªç«¯å£æˆ–ä½¿ç”¨å®ƒä»¬æ”¯æŒçš„åè®®æ ‡è®°ç«¯å£ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ˜¾å¼é€‰æ‹©ç«¯å£</td></tr><tr><td>sourceLabels</td><td>ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œç”¨äºé™åˆ¶è§„åˆ™å¯¹å…·æœ‰ç»™å®šæ ‡ç­¾çš„æºï¼ˆå®¢æˆ·ç«¯ï¼‰å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td></tr><tr><td>gateways</td><td>å¾…åº”ç”¨è§„åˆ™çš„ç½‘å…³çš„åç§°ã€‚ VirtualService çš„é¡¶çº§ gateways å­—æ®µä¸­çš„ç½‘å…³åç§°ï¼ˆå¦‚æœæœ‰ï¼‰è¢«è¦†ç›–ã€‚Gateway åŒ¹é…ç‹¬ç«‹äº sourceLabels</td></tr><tr><td>sourceNamespace</td><td>æºå‘½åç©ºé—´é™åˆ¶è§„åˆ™å¯¹è¯¥å‘½åç©ºé—´ä¸­å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td></tr></tbody></table><h1 id="TLSMatchAttributes"><a href="#TLSMatchAttributes" class="headerlink" title="TLSMatchAttributes"></a><a name="TLSMatchAttributes">TLSMatchAttributes</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>sniHosts</td><td>è¦åŒ¹é…çš„ SNIï¼ˆserver name indicatorï¼‰ã€‚é€šé…ç¬¦å‰ç¼€å¯ç”¨äº SNI å€¼ï¼Œä¾‹å¦‚ï¼Œ*.com å°†åŒ¹é… foo.example.com ä»¥åŠ example.comã€‚ SNI å€¼å¿…é¡»æ˜¯ç›¸åº”è™šæ‹ŸæœåŠ¡ä¸»æœºçš„å­é›†ï¼ˆå³å±äºåŸŸå†…ï¼‰</td></tr><tr><td>destinationSubnets</td><td>å¸¦æœ‰å¯é€‰å­ç½‘çš„ç›®æ ‡ IPv4 æˆ– IPv6 IP åœ°å€ã€‚ä¾‹å¦‚ï¼Œa.b.c.d&#x2F;xx  æˆ–åªæ˜¯ a.b.c.d</td></tr><tr><td>port</td><td>æŒ‡å®šæ­£åœ¨å¯»å€çš„ host ä¸Šçš„ç«¯å£ã€‚è®¸å¤šæœåŠ¡åªå…¬å¼€å•ä¸ªç«¯å£æˆ–ä½¿ç”¨å®ƒä»¬æ”¯æŒçš„åè®®æ ‡è®°ç«¯å£ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ˜¾å¼é€‰æ‹©ç«¯å£</td></tr><tr><td>sourceLabels</td><td>ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œç”¨äºé™åˆ¶è§„åˆ™å¯¹å…·æœ‰ç»™å®šæ ‡ç­¾çš„æºï¼ˆå®¢æˆ·ç«¯ï¼‰å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td></tr><tr><td>gateways</td><td>å¾…åº”ç”¨è§„åˆ™çš„ç½‘å…³çš„åç§°ã€‚ VirtualService çš„é¡¶çº§ gateways å­—æ®µä¸­çš„ç½‘å…³åç§°ï¼ˆå¦‚æœæœ‰ï¼‰è¢«è¦†ç›–ã€‚Gateway åŒ¹é…ç‹¬ç«‹äº sourceLabels</td></tr><tr><td>sourceNamespace</td><td>æºå‘½åç©ºé—´é™åˆ¶è§„åˆ™å¯¹è¯¥å‘½åç©ºé—´ä¸­å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td></tr></tbody></table><h1 id="HTTPRedirect"><a href="#HTTPRedirect" class="headerlink" title="HTTPRedirect"></a><a name="HTTPRedirect">HTTPRedirect</a></h1><p>HTTPRedirect å¯ç”¨äºå‘è°ƒç”¨è€…å‘é€ 301 é‡å®šå‘å“åº”ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å°† review æœåŠ¡ä¸Šçš„ &#x2F;v1&#x2F;getProductRatings API è¯·æ±‚é‡å®šå‘åˆ° bookratings æœåŠ¡æä¾›çš„ &#x2F;v1&#x2F;bookRatingsã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/v1/getProductRatings</span></span><br><span class="line">    <span class="attr">redirect:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">/v1/bookRatings</span></span><br><span class="line">      <span class="attr">authority:</span> <span class="string">newratings.default.svc.cluster.local</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>uri</td><td>åœ¨é‡å®šå‘æ—¶ï¼Œä½¿ç”¨æ­¤å€¼è¦†ç›– URL çš„ path éƒ¨åˆ†ã€‚<br /><em>æ— è®ºè¯·æ±‚ URI æ˜¯å¦åŒ¹é…ä¸ºç¡®åˆ‡è·¯å¾„æˆ–å‰ç¼€ï¼Œéƒ½å°†æ›¿æ¢æ•´ä¸ªè·¯å¾„</em></td></tr><tr><td>authority</td><td>åœ¨é‡å®šå‘æ—¶ï¼Œä½¿ç”¨æ­¤å€¼è¦†ç›– URL çš„ Authority&#x2F;Host éƒ¨åˆ†</td></tr><tr><td>port</td><td>åœ¨é‡å®šå‘æ—¶ï¼Œä½¿ç”¨æ­¤å€¼è¦†ç›– URL çš„ Port éƒ¨åˆ†</td></tr><tr><td><a href="#HTTPRedirect.RedirectPortSelection">derivePort</a></td><td>åœ¨é‡å®šå‘æ—¶ï¼ŒåŠ¨æ€è®¾ç½®ç«¯å£</td></tr><tr><td>scheme</td><td>åœ¨é‡å®šå‘æ—¶ï¼Œä½¿ç”¨æ­¤å€¼è¦†ç›– URL çš„ Scheme éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œhttp æˆ– httpsã€‚å¦‚æœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨åŸ Schemeã€‚å¦‚æœ derivePort è®¾ç½®ä¸º FROM_PROTOCOL_DEFAULTï¼Œè¿™ä¹Ÿä¼šå½±å“è¯¥ç«¯å£</td></tr><tr><td>redirectCode</td><td>åœ¨é‡å®šå‘æ—¶ï¼ŒæŒ‡å®šè¦åœ¨é‡å®šå‘å“åº”ä¸­ä½¿ç”¨çš„ HTTP çŠ¶æ€ä»£ç ã€‚é»˜è®¤å“åº”ä»£ç ä¸º MOVED_PERMANENTLY (301)</td></tr></tbody></table><h1 id="HTTPRewrite"><a href="#HTTPRewrite" class="headerlink" title="HTTPRewrite"></a><a name="HTTPRewrite">HTTPRewrite</a></h1><p>HTTPRewrite å¯ç”¨äºåœ¨å°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡ä¹‹å‰é‡å†™ HTTP è¯·æ±‚çš„ç‰¹å®šéƒ¨åˆ†ã€‚HTTPRewrite åªèƒ½ä¸ HTTPRouteDestination ä¸€èµ·ä½¿ç”¨ã€‚</p><p>ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•åœ¨å®é™…è°ƒç”¨ä¹‹å‰å°† &#x2F;ratings å‰ç¼€é‡å†™ä¸º rating æœåŠ¡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/ratings</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">/v1/bookRatings</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>uri</td><td>ç”¨è¿™ä¸ªå€¼é‡å†™ URI çš„ Path æˆ– Prefix éƒ¨åˆ†ã€‚å¦‚æœåŸå§‹ URI æ˜¯æ ¹æ®å‰ç¼€åŒ¹é…çš„ï¼Œåˆ™æ­¤å­—æ®µä¸­æä¾›çš„å€¼å°†æ›¿æ¢ç›¸åº”åŒ¹é…çš„å‰ç¼€</td></tr><tr><td>authority</td><td>ç”¨è¿™ä¸ªå€¼é‡å†™  Authority&#x2F;Host header</td></tr></tbody></table><h1 id="StringMatch"><a href="#StringMatch" class="headerlink" title="StringMatch"></a><a name="StringMatch">StringMatch</a></h1><p>åŒ¹é… HTTP header ä¸­çš„ç‰¹å®šå­—ç¬¦ä¸²çš„ç­–ç•¥ã€‚åŒ¹é…åŒºåˆ†å¤§å°å†™ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>exact</td><td>ç²¾å‡†åŒ¹é…</td></tr><tr><td>prefix</td><td>å‰ç¼€åŒ¹é…</td></tr><tr><td>regex</td><td>æ­£åˆ™åŒ¹é… ï¼ˆå‚é˜…ï¼š<a href="https://github.com/google/re2/wiki/Syntax%EF%BC%89">https://github.com/google/re2/wiki/Syntaxï¼‰</a></td></tr></tbody></table><h1 id="HTTPRetry"><a href="#HTTPRetry" class="headerlink" title="HTTPRetry"></a><a name="HTTPRetry">HTTPRetry</a></h1><p>HTTP è¯·æ±‚å¤±è´¥æ—¶çš„é‡è¯•ç­–ç•¥ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å°†è°ƒç”¨ rating æœåŠ¡ v1 ç‰ˆæœ¬æ—¶çš„æœ€å¤§é‡è¯•æ¬¡æ•°è®¾ç½®ä¸º 3ï¼Œæ¯æ¬¡é‡è¯•è¶…æ—¶ä¸º 2 ç§’ã€‚å¦‚æœå‡ºç° gateway-errorï¼Œconnect-failure å’Œ refused-stream çš„é”™è¯¯å°†é‡è¯•ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">retries:</span></span><br><span class="line">      <span class="attr">attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">perTryTimeout:</span> <span class="string">2s</span></span><br><span class="line">      <span class="attr">retryOn:</span> <span class="string">gateway-error,connect-failure,refused-stream</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>attempts</td><td>è¯·æ±‚å…è®¸çš„é‡è¯•æ¬¡æ•°ã€‚é‡è¯•é—´éš”å°†è‡ªåŠ¨ç¡®å®šï¼ˆ25ms+ï¼‰ã€‚å½“é…ç½®äº† HTTP è·¯ç”±çš„è¯·æ±‚è¶…æ—¶æˆ– perTryTimeout æ—¶ï¼Œå®é™…å°è¯•çš„é‡è¯•æ¬¡æ•°è¿˜å–å†³äºæŒ‡å®šçš„è¯·æ±‚è¶…æ—¶å’Œ perTryTimeout å€¼</td></tr><tr><td>perTryTimeout</td><td>ç»™å®šè¯·æ±‚çš„æ¯æ¬¡å°è¯•è¶…æ—¶ï¼ŒåŒ…æ‹¬åˆå§‹è°ƒç”¨å’Œä»»ä½•é‡è¯•ã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D;1 msã€‚é»˜è®¤å€¼ä¸ HTTP è·¯ç”±çš„è¯·æ±‚è¶…æ—¶ç›¸åŒï¼Œå³æ²¡æœ‰è¶…æ—¶</td></tr><tr><td>retryOn</td><td>æŒ‡å®šé‡è¯•å‘ç”Ÿçš„æ¡ä»¶ã€‚å¯ä»¥ä½¿ç”¨ , åˆ†éš”åˆ—è¡¨æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªç­–ç•¥ã€‚å¦‚æœ retryOn æŒ‡å®šäº†ä¸€ä¸ªæœ‰æ•ˆçš„ HTTP çŠ¶æ€ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ° retriable_status_codes é‡è¯•ç­–ç•¥ä¸­ã€‚<br /><em>æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜…<a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#x-envoy-retry-on">é‡è¯•ç­–ç•¥</a>å’Œ <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#x-envoy-retry-grpc-on">gRPC é‡è¯•ç­–ç•¥</a></em></td></tr><tr><td>retryRemoteLocalities</td><td>æ˜¯å¦åº”é‡è¯•åˆ°å…¶ä»–ä½ç½®ã€‚<br /><em>æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜…<a href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_connection_management#retry-plugin-configuration">é‡è¯•æ’ä»¶é…ç½®</a></em></td></tr></tbody></table><h1 id="CorsPolicy"><a href="#CorsPolicy" class="headerlink" title="CorsPolicy"></a><a name="CorsPolicy">CorsPolicy</a></h1><p>æè¿°ç»™å®šæœåŠ¡çš„è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰ç­–ç•¥ã€‚æœ‰å…³è·¨æºèµ„æºå…±äº«çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">CORS</a>ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™ä½¿ç”¨ HTTP POST&#x2F;GET å°†è·¨æºè¯·æ±‚é™åˆ¶ä¸ºæ¥è‡ª example.com åŸŸçš„è¯·æ±‚ï¼Œå¹¶å°† Access-Control-Allow-Credentials header è®¾ç½®ä¸º falseã€‚æ­¤å¤–ï¼Œå®ƒåªæš´éœ² X-Foo-bar header å¹¶è®¾ç½® 1 å¤©çš„æœ‰æ•ˆæœŸã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">corsPolicy:</span></span><br><span class="line">      <span class="attr">allowOrigins:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exact:</span> <span class="string">https://example.com</span></span><br><span class="line">      <span class="attr">allowMethods:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">allowCredentials:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">allowHeaders:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">X-Foo-Bar</span></span><br><span class="line">      <span class="attr">maxAge:</span> <span class="string">&quot;24h&quot;</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#StringMatch">allowOrigins</a></td><td>åŒ¹é…å…è®¸çš„æ¥æºçš„å­—ç¬¦ä¸²æ¨¡å¼ã€‚å¦‚æœä»»ä½•å­—ç¬¦ä¸²åŒ¹é…å™¨åŒ¹é…ï¼Œåˆ™å…è®¸æ¥æºã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œåˆ™ä¼ å‡ºçš„ Access-Control-Allow-Origin å°†è®¾ç½®ä¸ºå®¢æˆ·ç«¯æä¾›çš„æº</td></tr><tr><td>allowMethods</td><td>å…è®¸è®¿é—®èµ„æºçš„ HTTP æ–¹æ³•åˆ—è¡¨ã€‚å†…å®¹å°†è¢«åºåˆ—åŒ–åˆ° Access-Control-Allow-Methods header ä¸­</td></tr><tr><td>allowHeaders</td><td>è¯·æ±‚èµ„æºæ—¶å¯ä»¥ä½¿ç”¨çš„ HTTP header åˆ—è¡¨ã€‚åºåˆ—åŒ–ä¸º Access-Control-Allow-Headers header</td></tr><tr><td>exposeHeaders</td><td>å…è®¸æµè§ˆå™¨è®¿é—®çš„ HTTP header åˆ—è¡¨ã€‚åºåˆ—åŒ–ä¸º Access-Control-Expose-Headers header</td></tr><tr><td>maxAge</td><td>æŒ‡å®šé¢„æ£€è¯·æ±‚çš„ç»“æœå¯ä»¥ç¼“å­˜å¤šé•¿æ—¶é—´ã€‚è½¬æ¢ä¸º Access-Control-Max-Age header</td></tr><tr><td>allowCredentials</td><td>æ˜¯å¦å…è®¸è°ƒç”¨è€…ä½¿ç”¨å‡­æ®å‘é€å®é™…è¯·æ±‚ï¼ˆè€Œä¸æ˜¯é¢„æ£€ï¼‰ã€‚è½¬æ¢ä¸º Access-Control-Allow-Credentials header</td></tr></tbody></table><h1 id="HTTPFaultInjection"><a href="#HTTPFaultInjection" class="headerlink" title="HTTPFaultInjection"></a><a name="HTTPFaultInjection">HTTPFaultInjection</a></h1><p>HTTPFaultInjection å¯ç”¨äºåœ¨å°† HTTP è¯·æ±‚è½¬å‘åˆ°è·¯ç”±ä¸­æ³¨å…¥æ•…éšœã€‚æ•…éšœè§„èŒƒæ˜¯ VirtualService è§„åˆ™çš„ä¸€éƒ¨åˆ†ã€‚é”™è¯¯åŒ…æ‹¬ä»ä¸‹æ¸¸æœåŠ¡ä¸­æ­¢ HTTP è¯·æ±‚ã€å»¶è¿Ÿè¯·æ±‚ä»£ç†ç­‰ã€‚æ•…éšœè§„åˆ™ä¸­è‡³å°‘æœ‰ delay æˆ–è€… abortã€‚<br /><em>æ³¨æ„ï¼šdelay å’Œ abort æ•…éšœç›¸äº’ç‹¬ç«‹ï¼Œå³ä½¿ä¸¤è€…åŒæ—¶æŒ‡å®šã€‚</em></p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#HTTPFaultInjection.Delay">delay</a></td><td>åœ¨è½¬å‘ä¹‹å‰å»¶è¿Ÿè¯·æ±‚ï¼Œæ¨¡æ‹Ÿç½‘ç»œé—®é¢˜ã€ä¸Šæ¸¸æœåŠ¡è¿‡è½½ç­‰å„ç§æ•…éšœ</td></tr><tr><td><a href="#HTTPFaultInjection.Abort">abort</a></td><td>ä¸­æ­¢ HTTP è¯·æ±‚å°è¯•å¹¶å°†é”™è¯¯ä»£ç è¿”å›ç»™ä¸‹æ¸¸æœåŠ¡ï¼Œæ¨¡æ‹Ÿä¸Šæ¸¸æœåŠ¡æ•…éšœ</td></tr></tbody></table><h1 id="PortSelector"><a href="#PortSelector" class="headerlink" title="PortSelector"></a><a name="PortSelector">PortSelector</a></h1><p>PortSelector æŒ‡å®šç”¨äºåŒ¹é…æˆ–é€‰æ‹©æœ€ç»ˆè·¯ç”±çš„ç«¯å£å·ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>number</td><td>æœ‰æ•ˆçš„ç«¯å£å·</td></tr></tbody></table><h1 id="Percent"><a href="#Percent" class="headerlink" title="Percent"></a><a name="Percent">Percent</a></h1><p>ç™¾åˆ†æ¯”èŒƒå›´ 0 ~ 100ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>value</td><td>ç™¾åˆ†æ¯”èŒƒå›´</td></tr></tbody></table><h1 id="Headers-HeaderOperations"><a href="#Headers-HeaderOperations" class="headerlink" title="Headers.HeaderOperations"></a><a name="Headers.HeaderOperations">Headers.HeaderOperations</a></h1><p>header æ“ä½œæ–¹å¼ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>set</td><td>ç”¨ç»™å®šçš„å€¼è¦†ç›–åŸ header ä¸­çš„ Key</td></tr><tr><td>add</td><td>è®²ç»™å®šçš„å€¼è¿½åŠ åˆ° header ä¸­çš„ Key ä¸­</td></tr><tr><td>remove</td><td>ç§»é™¤æŒ‡å®šçš„ header</td></tr></tbody></table><h1 id="HTTPFaultInjection-Delay"><a href="#HTTPFaultInjection-Delay" class="headerlink" title="HTTPFaultInjection.Delay"></a><a name="HTTPFaultInjection.Delay">HTTPFaultInjection.Delay</a></h1><p>å»¶è¿Ÿç±»æ•…éšœæ³¨å…¥ã€‚</p><p>ä¾‹å¦‚ï¼Œåœ¨æ‰€æœ‰æ ‡ç­¾ä¸º env: prod çš„ Pod ä¸­å¯¹ reviews æœåŠ¡çš„ v1 ç‰ˆæœ¬çš„å‘èµ·çš„æ¯ 1000 ä¸ªè¯·æ±‚ä¸­å¼•å…¥ 1 ä¸ªå»¶è¿Ÿ 5 ç§’çš„æ•…éšœã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">sourceLabels:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">prod</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">delay:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">0.1</span></span><br><span class="line">        <span class="attr">fixedDelay:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure><p>fixedDelay å­—æ®µç”¨äºæŒ‡ç¤ºå»¶è¿Ÿé‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚å¯é€‰çš„ç™¾åˆ†æ¯”å­—æ®µå¯ç”¨äºä»…å»¶è¿Ÿä¸€å®šç™¾åˆ†æ¯”çš„è¯·æ±‚ã€‚å¦‚æœæœªæŒ‡å®šï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å°†è¢«å»¶è¿Ÿã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>fixedDelay</td><td>åœ¨è½¬å‘è¯·æ±‚ä¹‹å‰æ·»åŠ ä¸€ä¸ªå›ºå®šçš„å»¶è¿Ÿã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D; 1 ms</td></tr><tr><td>percentage</td><td>æ³¨å…¥å»¶è¿Ÿçš„è¯·æ±‚çš„ç™¾åˆ†æ¯”</td></tr><tr><td>percent</td><td>æ³¨å…¥å»¶è¿Ÿçš„è¯·æ±‚çš„ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰ã€‚ä¸æ¨èä½¿ç”¨æ•´æ•°ç™¾åˆ†æ¯”å€¼ã€‚è¯·æ”¹ç”¨ percentage å­—æ®µ</td></tr></tbody></table><h1 id="HTTPFaultInjection-Abort"><a href="#HTTPFaultInjection-Abort" class="headerlink" title="HTTPFaultInjection.Abort"></a><a name="HTTPFaultInjection.Abort">HTTPFaultInjection.Abort</a></h1><p>ä¸­æ­¢ç±»æ•…éšœæ³¨å…¥ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸º ratings æœåŠ¡ v1 ç‰ˆæœ¬çš„æ¯ 1000 ä¸ªè¯·æ±‚ä¸­çš„ 1 ä¸ªè¿”å› HTTP 400 é”™è¯¯ä»£ç ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">abort:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">0.1</span></span><br><span class="line">        <span class="attr">httpStatus:</span> <span class="number">400</span></span><br></pre></td></tr></table></figure><p>httpStatus å­—æ®µè¡¨ç¤ºè¿”å›ç»™è°ƒç”¨è€…çš„ HTTP çŠ¶æ€ç ã€‚å¯é€‰çš„ç™¾åˆ†æ¯”å­—æ®µåªèƒ½ç”¨äºä¸­æ­¢ä¸€å®šç™¾åˆ†æ¯”çš„è¯·æ±‚ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä¸­æ­¢æ‰€æœ‰è¯·æ±‚ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>httpStatus</td><td>ç”¨äºä¸­æ­¢ HTTP è¯·æ±‚çš„ HTTP çŠ¶æ€ç </td></tr><tr><td><a href="#Percent">percentage</a></td><td>ä¸­æ­¢è¯·æ±‚çš„ç™¾åˆ†æ¯”</td></tr></tbody></table><h1 id="HTTPRedirect-RedirectPortSelection"><a href="#HTTPRedirect-RedirectPortSelection" class="headerlink" title="HTTPRedirect.RedirectPortSelection"></a><a name="HTTPRedirect.RedirectPortSelection">HTTPRedirect.RedirectPortSelection</a></h1><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>FROM_PROTOCOL_DEFAULT</td><td>å¯¹äº HTTP è‡ªåŠ¨è®¾ç½®ä¸º 80ï¼Œå¯¹äº HTTPS è‡ªåŠ¨è®¾ç½®ä¸º 443</td></tr><tr><td>FROM_REQUEST_PORT</td><td>è‡ªåŠ¨ä½¿ç”¨è¯·æ±‚çš„ç«¯å£</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†åœºæ™¯ä¸‹çš„ VirtualService èµ„æºå¯¹è±¡ä½¿ç”¨èŒƒä¾‹ä¸ API ç»“æ„æ¦‚è§ˆ</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€Block Volume ç›´é€š</title>
    <link href="http://shenxianghong.github.io/2022/08/01/2022-08-01%20Kata%20Containers%20Block%20Volume%20%E7%9B%B4%E9%80%9A/"/>
    <id>http://shenxianghong.github.io/2022/08/01/2022-08-01%20Kata%20Containers%20Block%20Volume%20%E7%9B%B4%E9%80%9A/</id>
    <published>2022-07-31T16:00:00.000Z</published>
    <updated>2023-07-10T09:47:25.802Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>2.4.3</strong></p></blockquote><h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>Kubernetes è®¾è®¡ä¹‹åˆå¯¹åŸºäº VM çš„å®¹å™¨è¿è¡Œæ—¶è€ƒè™‘è¾ƒå°‘ï¼Œå¾ˆå¤šåœºæ™¯éƒ½é»˜è®¤å®¹å™¨è¿è¡Œæ—¶èƒ½ç›´æ¥è®¿é—®å®¿ä¸»æœºèµ„æºï¼Œè¿™ä¹Ÿä½¿å¾— Kata Containers åœ¨å’Œ Kubernetes é›†æˆæ—¶å¯¹æŸäº› Kubernetes ç‰¹æ€§çš„æ”¯æŒå­˜åœ¨ä¸€äº›ä¸è¶³æˆ–é™åˆ¶ï¼Œå°¤å…¶æ˜¯åœ¨å­˜å‚¨æ–¹é¢ã€‚</p><p>Kubernetes æä¾›äº† PV ï¼ˆpersistent volumeï¼‰èµ„æºæ¥ç®¡ç†å­˜å‚¨å·ï¼Œåˆ¶å®šäº† CSI ï¼ˆContainer Storage Interfaceï¼‰è§„èŒƒåœ¨å­˜å‚¨æä¾›è€…å’Œå®¹å™¨è¿è¡Œæ—¶ä¹‹é—´æ¥ç®¡ç†å­˜å‚¨è®¾å¤‡ã€‚é€šå¸¸æ¥è¯´ï¼ŒCSI ä¼šå°†ä¸åŒç±»å‹çš„å­˜å‚¨è®¾å¤‡ï¼Œæ¯”å¦‚äº‘ç›˜ã€æœ¬åœ°å­˜å‚¨ã€ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿç­‰ï¼Œä»¥æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼æŒ‚è½½åˆ°å®¿ä¸»æœºï¼Œç„¶åå†ä»å®¿ä¸»æœºå°†æ­¤æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚åœ¨ Kata Containers ä¸­ï¼Œè¿™ä¸ªæŒ‚è½½æ˜¯é€šè¿‡ virtiofs åè®®ï¼Œåœ¨å®¿ä¸»æœºå’Œ guest OS ä¸­å®ç°äº†è¯¥å­˜å‚¨å·çš„æ–‡ä»¶å…±äº«ã€‚è™½ç„¶ virtiofs åœ¨æ€§èƒ½ä¸Šæ¯”ä¹‹å‰çš„ 9p æœ‰å¾ˆå¤§æå‡ï¼Œä½†æ˜¯å’Œç›´æ¥åœ¨å®¿ä¸»æœºä¸Šä½¿ç”¨ç›¸æ¯”ï¼Œæ€§èƒ½æŸè€—æˆä¸ºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ Kata Containers çš„é˜»ç¢å› ç´ ä¹‹ä¸€ã€‚</p><p>å…¶æ¬¡ï¼Œä½¿ç”¨ Kata Containers åœ¨çº¿è°ƒæ•´ PV çš„å¤§å°æ˜¯å¾ˆå›°éš¾çš„ã€‚è™½ç„¶ PV å¯ä»¥åœ¨ host ä¸Šæ‰©å±•ï¼Œä½†æ›´æ–°åçš„å…ƒæ•°æ®éœ€è¦ä¼ é€’åˆ° guest OS ä¸­ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºå®¹å™¨ä½¿ç”¨æ‰©å±•çš„å·ã€‚ç›®å‰ï¼Œæ²¡æœ‰åŠæ³•åœ¨ä¸é‡æ–°å¯åŠ¨ Pod sandbox çš„æƒ…å†µä¸‹å°† PV å…ƒæ•°æ®ä» host OS ä¼ é€’åˆ° guest OSã€‚</p><p>ä¸€ä¸ªç†æƒ³çš„é•¿æœŸè§£å†³æ–¹æ¡ˆæ˜¯ Kubelet åè°ƒ CSI Driver å’Œ Container Runtime ä¹‹é—´çš„é€šä¿¡ï¼Œå¦‚ <a href="https://github.com/kubernetes/enhancements/pull/2893/files">KEP-2857</a> è®¨è®ºï¼Œä½†æ˜¯ç›®å‰è€Œè¨€ï¼ŒKEP ä»åœ¨å®¡æŸ¥ä¸­ï¼Œå¹¶ä¸”æè®®çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ä¸ªå¼Šç«¯ï¼š</p><ul><li>å°† csiPlugin.json æ–‡ä»¶å†™å…¥å·çš„æ ¹è·¯å¾„ä¼šå¸¦æ¥å®‰å…¨éšæ‚£ã€‚æ¶æ„ç”¨æˆ·å¯ä»¥å°†è‡ªå·±çš„ csiPlugin.json å†™å…¥ä¸Šè¿°ä½ç½®ï¼Œä»è€Œè·å¾—å¯¹å—è®¾å¤‡çš„æœªç»æˆæƒçš„è®¿é—®</li><li>ææ¡ˆä¸­å¹¶æ²¡æœ‰æè¿°å¦‚ä½•åœ¨å·å’Œ Kata Containers ä¸­å¦‚ä½•å»ºç«‹æ˜ å°„å…³ç³»ï¼Œç„¶è€Œè¿™æ˜¯ CSI è°ƒæ•´å·å¤§å°å’Œä¿¡æ¯æ‰€éœ€çš„å¿…å¤‡ API</li></ul><p>å¯¹æ­¤ Kata Containers ç¤¾åŒºæå‡ºä¸€ä¸ªçŸ­æœŸ&#x2F;ä¸­æœŸçš„è§£å†³æ–¹æ¡ˆ â€” Block Volume ç›´é€šã€‚</p><p><strong>å½“å‰ CSI æŒ‚è½½æ–¹å¼</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/kata-containers/CurrentMounts.png"></div><p><strong>CSI ä¸ Runtime åè°ƒæŒ‚è½½</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/kata-containers/RuntimeAssistedMounts.png"></div><h1 id="ç°é˜¶æ®µç¼ºé™·"><a href="#ç°é˜¶æ®µç¼ºé™·" class="headerlink" title="ç°é˜¶æ®µç¼ºé™·"></a>ç°é˜¶æ®µç¼ºé™·</h1><ul><li>ä¸€ä¸ªå—è®¾å¤‡å·ä¸€æ¬¡åªèƒ½ç”±ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ª Pod ä½¿ç”¨ï¼Œå…¶å®è¿™æ˜¯ Kata Containers ç”¨ä¾‹ä¸­æœ€å¸¸è§çš„æ¨¡å¼ã€‚å°†åŒä¸€ä¸ªå—è®¾å¤‡è¿æ¥åˆ°å¤šä¸ª Kata Pod ä¹Ÿæ˜¯ä¸å®‰å…¨çš„ã€‚åœ¨ Kubernetes ä¸­ï¼Œéœ€è¦å°† PersistentVolumeClaim (PVC) çš„ accessMode è®¾ç½®ä¸º ReadWriteOncePod</li><li>ä¸æ”¯æŒæ›´é«˜çº§çš„ Kubernetes å·åŠŸèƒ½ï¼Œä¾‹å¦‚ fsGroupã€fsGroupChangePolicy å’Œ subPath</li></ul><h1 id="å®ç°æ–¹æ¡ˆ"><a href="#å®ç°æ–¹æ¡ˆ" class="headerlink" title="å®ç°æ–¹æ¡ˆ"></a>å®ç°æ–¹æ¡ˆ</h1><p>ä¼ ç»Ÿ CSI éƒ½ä¼šå°†å­˜å‚¨è®¾å¤‡æŒ‚è½½åˆ°å®¿ä¸»æœºä¸Šï¼Œåœ¨ Kata Containers ä¸­ï¼Œç”±äº VM çš„å­˜åœ¨ï¼ŒæŒ‚è½½æ“ä½œéœ€è¦ç§»åŠ¨åˆ° guest ä¸­ï¼Œç”± Kata agent æ¥å®Œæˆå­˜å‚¨å·çš„æŒ‚è½½ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><strong>åŸæŒ‚è½½æ–¹æ¡ˆ</strong></p><div align=center><img width="600" style="border: 0px" src="/gallery/kata-containers/kata-mount-current.png"></div><p><strong>ç›´é€šæŒ‚è½½æ–¹æ¡ˆ</strong></p><div align=center><img width="600" style="border: 0px" src="/gallery/kata-containers/kata-mount-direct.png"></div><p>å› æ­¤ï¼Œéœ€è¦ CSI å…·å¤‡ç›´é€šå·çš„æŒ‚è½½èƒ½åŠ›ï¼ŒKata Containers ç¤¾åŒºæä¾›äº†ä¸€äº›å‚è€ƒæ–¹æ¡ˆ</p><ul><li>StorageClass å‚æ•°ä¸­æŒ‡å®šç›´é€šå·çš„ç›¸å…³æ ‡è¯†ï¼Œè¿™æ ·å¯ä»¥å…å» CSI æŸ¥è¯¢ PVC æˆ–è€… Pod çš„ä¿¡æ¯ï¼Œä½†æ˜¯åŸºäºè¯¥ StorageClass ä¾›åº”çš„ PV å‡ä¼šè§†ä¸ºç›´é€šå·</li><li>PVC annotation ä¸­æ³¨æ˜ï¼Œéœ€è¦ CSI Plugin æ”¯æŒ â€“extra-create-metadata </li><li>RuntimeClass ä¸­æ³¨æ˜ï¼ŒCSI Driver åœ¨ node publish é˜¶æ®µé€šè¿‡ Runtime æ¥è·å¾— Volume æ˜¯å¦éœ€è¦ç›´æ¥æŒ‚è½½åˆ° guest ä¸­ï¼Œå‚è€ƒ<a href="https://github.com/kubernetes-sigs/alibaba-cloud-csi-driver/blob/master/pkg/disk/nodeserver.go#L248">é˜¿é‡Œäº‘å®ç°</a></li></ul><p>å½“ CSI Driver å¹¶ä¸ä¼šç›´æ¥å°†ç›´é€šå·æŒ‚è½½ç»™ Kata Containers ä½¿ç”¨ï¼Œè€Œæ˜¯éœ€è¦åœ¨ CSI çš„ä¸åŒé˜¶æ®µè°ƒç”¨ Kata Containers åœ¨ 2.4 æ–°å¢çš„ direct-volume å‘½ä»¤å‘ Kata Containers è¿è¡Œæ—¶ä¼ é€’å¹¶æ”¶é›†å·ä¿¡æ¯ã€‚</p><ul><li>NodePublishVolume<br>è°ƒç”¨ kata-runtime direct-volume add â€“volume-path [volumePath] â€“mount-info [mountInfo] å°†å·æŒ‚è½½ä¿¡æ¯ä¼ é€’åˆ° Kata Containers ç”¨æ¥æ‰§è¡Œæ–‡ä»¶ç³»ç»ŸæŒ‚è½½æ“ä½œã€‚ volumePath æ˜¯ CSI NodePublishVolumeRequest ä¸­çš„ target_pathã€‚ mountInfo æ˜¯ä¸€ä¸ªåºåˆ—åŒ–çš„ JSON å­—ç¬¦ä¸²</li><li>NodeGetVolumeStats<br>è°ƒç”¨ kata-runtime direct-volume stats â€“volume-path [volumePath] è·å–ç›´é€šå·çš„ä¿¡æ¯</li><li>NodeExpandVolume<br>è°ƒç”¨ kata-runtime direct-volume resize â€“volume-path [volumePath] â€“size [size] è¯·æ±‚ Kata Containers è°ƒæ•´ç›´é€šå·çš„å¤§å°</li><li>NodeStageVolume&#x2F;NodeUnStageVolume<br>è°ƒç”¨ kata-runtime direct-volume remove â€“volume-path [volumePath] åˆ é™¤ç›´é€šå·çš„å…ƒæ•°æ®ä¿¡æ¯</li></ul><h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="kata-runtime-direct-volume"><a href="#kata-runtime-direct-volume" class="headerlink" title="kata-runtime direct-volume"></a>kata-runtime direct-volume</h2><p><em><u>src&#x2F;runtime&#x2F;cmd&#x2F;kata-runtime&#x2F;kata-volume.go</u></em></p><p>Kata Containers åœ¨ 2.4 ç‰ˆæœ¬æ—¶ï¼Œæ–°å¢äº† kata-runtime direct-volume çš„å‘½ä»¤ï¼Œç”¨äºç®¡ç† Kata Containers æ‰€ä½¿ç”¨çš„ç›´é€šå·ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MountInfo contains the information needed by Kata to consume a host block device and mount it as a filesystem inside the guest VM.</span></span><br><span class="line"><span class="keyword">type</span> MountInfo <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// The type of the volume (ie. block)</span></span><br><span class="line">VolumeType <span class="type">string</span> <span class="string">`json:&quot;volume-type&quot;`</span></span><br><span class="line"><span class="comment">// The device backing the volume.</span></span><br><span class="line">Device <span class="type">string</span> <span class="string">`json:&quot;device&quot;`</span></span><br><span class="line"><span class="comment">// The filesystem type to be mounted on the volume.</span></span><br><span class="line">FsType <span class="type">string</span> <span class="string">`json:&quot;fstype&quot;`</span></span><br><span class="line"><span class="comment">// Additional metadata to pass to the agent regarding this volume.</span></span><br><span class="line">Metadata <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;metadata,omitempty&quot;`</span></span><br><span class="line"><span class="comment">// Additional mount options.</span></span><br><span class="line">Options []<span class="type">string</span> <span class="string">`json:&quot;options,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="add"><a href="#add" class="headerlink" title="add"></a>add</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime direct-volume add</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“volume-path</td><td>å¾…æ“ä½œçš„ç›®æ ‡å·è·¯å¾„</td></tr><tr><td>â€“mount-info</td><td>ç®¡ç†å·æŒ‚è½½çš„è¯¦æƒ…ä¿¡æ¯</td></tr></tbody></table><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¡éªŒåˆæ³•æ€§ï¼Œåˆ›å»º &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 volume path&gt; ç›®å½•</li><li>å°† mount info åºåˆ—åŒ–ä¸º jsonï¼Œä»¥åä¸º mountInfo.json çš„æ–‡ä»¶å½¢å¼ä¿å­˜åœ¨è¯¥ç›®å½•ä¸‹</li></ol><h3 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime direct-volume remove</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“volume-path</td><td>å¾…æ“ä½œçš„ç›®æ ‡å·è·¯å¾„</td></tr></tbody></table><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>ç§»é™¤ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 volume path&gt; ç›®å½•</li></ol><h3 id="stats"><a href="#stats" class="headerlink" title="stats"></a>stats</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime direct-volume stats</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“volume-path</td><td>å¾…æ“ä½œçš„ç›®æ ‡å·è·¯å¾„</td></tr></tbody></table><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å– &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 volume path&gt; ç›®å½•ä¸‹çš„ sandbox id åç§°<br><em>é¢„æœŸæ˜¯ä¸€ä¸ªç›´é€šå·ä»…æœ‰ä¸€ä¸ªç›¸å…³è”çš„ sanboxï¼Œå› æ­¤ï¼Œè¯¥ç›®å½•ä¸‹ï¼Œä»…æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªåä¸º sandbox idï¼Œä¸€ä¸ªåä¸º mountInfo.json</em></li><li>è§£æ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 volume path&gt;&#x2F;mountInfo.json æ–‡ä»¶ï¼Œæ„å»º mountInfo å¯¹è±¡ï¼Œè·å– volume çš„æº device ä¿¡æ¯</li><li>å‘ containerd-shim-kata-v2 çš„ &#x2F;direct-volume&#x2F;stats æ¥å£å‘èµ· HTTP Get è¯·æ±‚</li><li>åˆ¤æ–­ host ä¸Šçš„è¯¥ device æ˜¯å¦å­˜åœ¨ï¼Œæ ¹æ® sandbox ä¸­çš„ container å·æŒ‚è½½çš„æ˜ å°„ä¿¡æ¯ï¼Œè·å–åˆ°ä½äº guest OS ä¸­çš„å¯¹åº”çš„æŒ‚è½½ç‚¹</li><li>å‘ Kata agent å‘èµ· rpc è¯·æ±‚ï¼Œè·å– guest OS ä¸­çš„å·ä¿¡æ¯</li></ol><h3 id="resize"><a href="#resize" class="headerlink" title="resize"></a>resize</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime direct-volume resize</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“volume-path</td><td>å¾…æ“ä½œçš„ç›®æ ‡å·è·¯å¾„</td></tr><tr><td>â€“size</td><td>è°ƒæ•´åçš„å·å¤§å°ï¼Œé»˜è®¤ä¸º 0</td></tr></tbody></table><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å– &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 volume path&gt; ç›®å½•ä¸‹çš„ sandbox id åç§°<br><em>é¢„æœŸæ˜¯ä¸€ä¸ªç›´é€šå·ä»…æœ‰ä¸€ä¸ªç›¸å…³è”çš„ sandboxï¼Œå› æ­¤ï¼Œè¯¥ç›®å½•ä¸‹ï¼Œä»…æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªåä¸º sandbox idï¼Œä¸€ä¸ªåä¸º mountInfo.json</em></li><li>è§£æ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 volume path&gt;&#x2F;mountInfo.json æ–‡ä»¶ï¼Œæ„å»º mountInfo å¯¹è±¡</li><li>å‘ containerd-shim-kata-v2 çš„ &#x2F;direct-volume&#x2F;resize æ¥å£å‘èµ· HTTP Post è¯·æ±‚</li><li>åˆ¤æ–­ host ä¸Šçš„è¯¥ device æ˜¯å¦å­˜åœ¨ï¼Œæ ¹æ® sandbox ä¸­çš„ container å·æŒ‚è½½çš„æ˜ å°„ä¿¡æ¯ï¼Œè·å–åˆ°ä½äº guest OS ä¸­çš„å¯¹åº”çš„æŒ‚è½½ç‚¹</li><li>å‘ Kata agent å‘èµ· rpc è¯·æ±‚ï¼Œå¯¹ guest OS ä¸­æŒ‡å®šçš„å·è¿›è¡Œå¤§å°è°ƒæ•´</li></ol><h2 id="containerd-shim-kata-v2"><a href="#containerd-shim-kata-v2" class="headerlink" title="containerd-shim-kata-v2"></a>containerd-shim-kata-v2</h2><h3 id="createBlockDevices"><a href="#createBlockDevices" class="headerlink" title="createBlockDevices"></a>createBlockDevices</h3><p><em><u>src&#x2F;runtime&#x2F;virtcontainers&#x2F;container.go</u></em></p><p><strong>éƒ¨åˆ†æµç¨‹</strong></p><ol><li>å¦‚æœä¸æ”¯æŒå—è®¾å¤‡çš„æŒ‚è½½ç‰¹æ€§ï¼Œåˆ™ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯</li><li>é’ˆå¯¹æ¯ä¸€ä¸ª container spec ä¸­è®°å½•çš„æŒ‚è½½ç‚¹ mountï¼Œè¿›è¡Œä»¥ä¸‹æ“ä½œ<ol><li>åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰ BlockDeviceID ä¿¡æ¯ï¼Œå¦‚æœæœ‰ä»£è¡¨å·²ç»æœ‰è®¾å¤‡å…³è”æŒ‚è½½ç‚¹ï¼Œåç»­ä¸éœ€è¦ä¸ºå…¶åˆ›å»ºæ–°çš„è®¾å¤‡</li><li>åˆ¤æ–­ mount ç±»å‹æ˜¯å¦æ˜¯ bind</li><li>æ ¹æ® mount source è·å–åˆ° mount info ä¿¡æ¯ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™ä¸æ˜¯ç›´é€šå·</li><li>åœ¨ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;direct-volumes&#x2F;&lt;base64 volume path&gt; ç›®å½•ä¸‹ï¼Œå†™å…¥ä»¥ sandbox ID ä¸ºåçš„æ–‡ä»¶ï¼Œç”¨äºåç»­ CSI ä¸ runtime é€šä¿¡</li><li>æ ¹æ® mount info ä¿¡æ¯ï¼Œè®¾ç½® container mount çš„æ‰€éœ€ä¿¡æ¯</li></ol></li><li>â€¦â€¦</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mount describes a container mount.</span></span><br><span class="line"><span class="comment">// nolint: govet</span></span><br><span class="line"><span class="keyword">type</span> Mount <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// Source is the source of the mount.</span></span><br><span class="line">Source <span class="type">string</span></span><br><span class="line"><span class="comment">// Destination is the destination of the mount (within the container).</span></span><br><span class="line">Destination <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Type specifies the type of filesystem to mount.</span></span><br><span class="line">Type <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HostPath used to store host side bind mount path</span></span><br><span class="line">HostPath <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// GuestDeviceMount represents the path within the VM that the device</span></span><br><span class="line"><span class="comment">// is mounted. Only relevant for block devices. This is tracked in the event</span></span><br><span class="line"><span class="comment">// runtime wants to query the agent for mount stats.</span></span><br><span class="line">GuestDeviceMount <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// BlockDeviceID represents block device that is attached to the</span></span><br><span class="line"><span class="comment">// VM in case this mount is a block device file or a directory</span></span><br><span class="line"><span class="comment">// backed by a block device.</span></span><br><span class="line">BlockDeviceID <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Options list all the mount options of the filesystem.</span></span><br><span class="line">Options []<span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadOnly specifies if the mount should be read only or not</span></span><br><span class="line">ReadOnly <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// FSGroup a group ID that the group ownership of the files for the mounted volume</span></span><br><span class="line"><span class="comment">// will need to be changed when set.</span></span><br><span class="line">FSGroup *<span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// FSGroupChangePolicy specifies the policy that will be used when applying</span></span><br><span class="line"><span class="comment">// group id ownership change for a volume.</span></span><br><span class="line">FSGroupChangePolicy volume.FSGroupChangePolicy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å®è·µæ“ä½œ"><a href="#å®è·µæ“ä½œ" class="headerlink" title="å®è·µæ“ä½œ"></a>å®è·µæ“ä½œ</h1><h2 id="å‡†å¤‡æ“ä½œ"><a href="#å‡†å¤‡æ“ä½œ" class="headerlink" title="å‡†å¤‡æ“ä½œ"></a>å‡†å¤‡æ“ä½œ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å‡†å¤‡ä¸¤ä¸ª runtime ä¸º Kata Containers çš„ Podï¼Œåˆ†åˆ«ä¸º direct å’Œ Virtiofs çš„æ¨¡å¼</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod</span></span><br><span class="line">NAME                READY   STATUS    RESTARTS   AGE</span><br><span class="line">local-kata-direct   1/1     Running   0          2m7s</span><br><span class="line">local-kata-virt     1/1     Running   0          2m3s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">crictl pods --no-trunc</span></span><br><span class="line">POD ID                                                             CREATED             STATE               NAME                                                      NAMESPACE           ATTEMPT</span><br><span class="line">3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9   11 minutes ago      Ready               local-kata-virt                                           default             0</span><br><span class="line">3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7   11 minutes ago      Ready               local-kata-direct                                         default             0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pvc</span></span><br><span class="line">NAME                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS        AGE</span><br><span class="line">local-kata-direct   Bound    pvc-23dc3ecf-37fb-44ee-b8a6-7667a98aeb05   20Mi       RWO            local-kata-direct   20m</span><br><span class="line">local-kata-virt     Bound    pvc-0878818c-5d93-4ed4-b034-5bf37a657a6e   20Mi       RWO            local-kata-virt     20m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ†åˆ«åœ¨æŒä¹…å·ç§å†™å…¥æµ‹è¯•æ•°æ®</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it local-kata-direct <span class="built_in">touch</span> /datadir/direct-data</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it local-kata-virt <span class="built_in">touch</span> /datadir/virt-data</span></span><br></pre></td></tr></table></figure><h2 id="host-ç«¯è¿›ç¨‹"><a href="#host-ç«¯è¿›ç¨‹" class="headerlink" title="host ç«¯è¿›ç¨‹"></a>host ç«¯è¿›ç¨‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtiofs ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -ef | grep 3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9</span></span><br><span class="line">root       889 10374  0 17:23 pts/34   00:00:00 grep --color=auto 3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9</span><br><span class="line">root     42721     1  0 17:10 ?        00:00:00 /usr/local/bin/containerd-shim-kata-v2 -namespace k8s.io -address /run/containerd/containerd.sock -publish-binary /usr/bin/containerd -id 3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9 -debug</span><br><span class="line">root     42744 42721  0 17:10 ?        00:00:00 /opt/kata/libexec/kata-qemu/virtiofsd --syslog -o cache=auto -o no_posix_lock -o source=/run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared --fd=3 -f --thread-pool-size=1 -o announce_submounts</span><br><span class="line">root     42751     1  0 17:10 ?        00:00:01 /opt/kata/bin/qemu-system-x86_64 -name sandbox-3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9 -uuid 26864a9b-ad50-43ab-9d41-2b6f4c7e34c3 -machine q35,accel=kvm,kernel_irqchip=on,nvdimm=on -cpu host,pmu=off -qmp unix:/run/vc/vm/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/qmp.sock,server=on,wait=off -m 256M,slots=10,maxmem=129389M -device pci-bridge,bus=pcie.0,id=pci-bridge-0,chassis_nr=1,shpc=off,addr=2,io-reserve=4k,mem-reserve=1m,pref64-reserve=1m -device virtio-serial-pci,disable-modern=false,id=serial0 -device virtconsole,chardev=charconsole0,id=console0 -chardev socket,id=charconsole0,path=/run/vc/vm/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/console.sock,server=on,wait=off -device nvdimm,id=nv0,memdev=mem0,unarmed=on -object memory-backend-file,id=mem0,mem-path=/opt/kata/share/kata-containers/kata-containers.img,size=134217728,readonly=on -device virtio-scsi-pci,id=scsi0,disable-modern=false -object rng-random,id=rng0,filename=/dev/urandom -device virtio-rng-pci,rng=rng0 -device vhost-vsock-pci,disable-modern=false,vhostfd=3,id=vsock-3588796381,guest-cid=3588796381 -chardev socket,id=char-597c9c629356cf41,path=/run/vc/vm/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/vhost-fs.sock -device vhost-user-fs-pci,chardev=char-597c9c629356cf41,tag=kataShared -netdev tap,id=network-0,vhost=on,vhostfds=4,fds=5 -device driver=virtio-net-pci,netdev=network-0,mac=6e:ae:f6:c6:82:0a,disable-modern=false,mq=on,vectors=4 -rtc base=utc,driftfix=slew,clock=host -global kvm-pit.lost_tick_policy=discard -vga none -no-user-config -nodefaults -nographic --no-reboot -daemonize -object memory-backend-file,id=dimm1,size=256M,mem-path=/dev/shm,share=on -numa node,memdev=dimm1 -kernel /opt/kata/share/kata-containers/vmlinux.container -append tsc=reliable no_timer_check rcupdate.rcu_expedited=1 i8042.direct=1 i8042.dumbkbd=1 i8042.nopnp=1 i8042.noaux=1 noreplace-smp reboot=k console=hvc0 console=hvc1 cryptomgr.notests net.ifnames=0 pci=lastbus=0 root=/dev/pmem0p1 rootflags=dax,data=ordered,errors=remount-ro ro rootfstype=ext4 quiet systemd.show_status=false panic=1 nr_cpus=48 systemd.unit=kata-containers.target systemd.mask=systemd-networkd.service systemd.mask=systemd-networkd.socket scsi_mod.scan=none agent.debug_console agent.debug_console_vport=1026 -pidfile /run/vc/vm/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/pid -smp 1,cores=1,threads=1,sockets=48,maxcpus=48</span><br><span class="line">root     42758 42744  0 17:10 ?        00:00:00 /opt/kata/libexec/kata-qemu/virtiofsd --syslog -o cache=auto -o no_posix_lock -o source=/run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared --fd=3 -f --thread-pool-size=1 -o announce_submounts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">direct ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -ef | grep 3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7</span></span><br><span class="line">root     25155 10374  0 17:26 pts/34   00:00:00 grep --color=auto 3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7</span><br><span class="line">root     38975     1  0 17:10 ?        00:00:00 /usr/local/bin/containerd-shim-kata-v2 -namespace k8s.io -address /run/containerd/containerd.sock -publish-binary /usr/bin/containerd -id 3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7 -debug</span><br><span class="line">root     39008 38975  0 17:10 ?        00:00:00 /opt/kata/libexec/kata-qemu/virtiofsd --syslog -o cache=auto -o no_posix_lock -o source=/run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared --fd=3 -f --thread-pool-size=1 -o announce_submounts</span><br><span class="line">root     39312     1  0 17:10 ?        00:00:01 /opt/kata/bin/qemu-system-x86_64 -name sandbox-3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7 -uuid c3fccd7b-f344-4819-a894-80f5e1c5606d -machine q35,accel=kvm,kernel_irqchip=on,nvdimm=on -cpu host,pmu=off -qmp unix:/run/vc/vm/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/qmp.sock,server=on,wait=off -m 256M,slots=10,maxmem=129389M -device pci-bridge,bus=pcie.0,id=pci-bridge-0,chassis_nr=1,shpc=off,addr=2,io-reserve=4k,mem-reserve=1m,pref64-reserve=1m -device virtio-serial-pci,disable-modern=false,id=serial0 -device virtconsole,chardev=charconsole0,id=console0 -chardev socket,id=charconsole0,path=/run/vc/vm/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/console.sock,server=on,wait=off -device nvdimm,id=nv0,memdev=mem0,unarmed=on -object memory-backend-file,id=mem0,mem-path=/opt/kata/share/kata-containers/kata-containers.img,size=134217728,readonly=on -device virtio-scsi-pci,id=scsi0,disable-modern=false -object rng-random,id=rng0,filename=/dev/urandom -device virtio-rng-pci,rng=rng0 -device vhost-vsock-pci,disable-modern=false,vhostfd=3,id=vsock-2091051760,guest-cid=2091051760 -chardev socket,id=char-2c14db67d9a8d23c,path=/run/vc/vm/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/vhost-fs.sock -device vhost-user-fs-pci,chardev=char-2c14db67d9a8d23c,tag=kataShared -netdev tap,id=network-0,vhost=on,vhostfds=4,fds=5 -device driver=virtio-net-pci,netdev=network-0,mac=86:3f:52:0e:93:29,disable-modern=false,mq=on,vectors=4 -rtc base=utc,driftfix=slew,clock=host -global kvm-pit.lost_tick_policy=discard -vga none -no-user-config -nodefaults -nographic --no-reboot -daemonize -object memory-backend-file,id=dimm1,size=256M,mem-path=/dev/shm,share=on -numa node,memdev=dimm1 -kernel /opt/kata/share/kata-containers/vmlinux.container -append tsc=reliable no_timer_check rcupdate.rcu_expedited=1 i8042.direct=1 i8042.dumbkbd=1 i8042.nopnp=1 i8042.noaux=1 noreplace-smp reboot=k console=hvc0 console=hvc1 cryptomgr.notests net.ifnames=0 pci=lastbus=0 root=/dev/pmem0p1 rootflags=dax,data=ordered,errors=remount-ro ro rootfstype=ext4 quiet systemd.show_status=false panic=1 nr_cpus=48 systemd.unit=kata-containers.target systemd.mask=systemd-networkd.service systemd.mask=systemd-networkd.socket scsi_mod.scan=none agent.debug_console agent.debug_console_vport=1026 -pidfile /run/vc/vm/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/pid -smp 1,cores=1,threads=1,sockets=48,maxcpus=48</span><br><span class="line">root     39547 39008  0 17:10 ?        00:00:00 /opt/kata/libexec/kata-qemu/virtiofsd --syslog -o cache=auto -o no_posix_lock -o source=/run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared --fd=3 -f --thread-pool-size=1 -o announce_submounts</span><br><span class="line">You have mail in /var/spool/mail/root</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯å“ªç§æŒä¹…å·æŒ‚è½½æ–¹å¼ï¼Œhost ä¸Šçš„è¿›ç¨‹ä¿¡æ¯å‡ä¸ºï¼šä¸¤ä¸ª virtiofsd è¿›ç¨‹ï¼Œä¸€ä¸ª qemu-system è¿›ç¨‹ï¼Œä¸€ä¸ª containerd-shim-kata-v2 è¿›ç¨‹</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¹‹æ‰€ä»¥å·ç›´é€šæ¨¡å¼ä¹Ÿä¼šæœ‰ virtiofsd è¿›ç¨‹å¯åŠ¨æ˜¯å› ä¸ºå·ç›´é€šä»…é™äºæŒä¹…å·çš„éƒ¨åˆ†ï¼Œå¯¹äº sandbox rootfs ä»ä»¥ virtiofs åè®®æŒ‚è½½è‡³ guest ä¸­</span></span><br></pre></td></tr></table></figure><h2 id="host-ç«¯å·ç›®å½•ç»“æ„"><a href="#host-ç«¯å·ç›®å½•ç»“æ„" class="headerlink" title="host ç«¯å·ç›®å½•ç»“æ„"></a>host ç«¯å·ç›®å½•ç»“æ„</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtiofs ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> /var/lib/kubelet/pods/6cccbed3-45eb-4925-92af-aa2313f1e3f8/volumes/kubernetes.io~csi/pvc-0878818c-5d93-4ed4-b034-5bf37a657a6e/mount</span></span><br><span class="line">lost+found  virt-data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">direct ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> /var/lib/kubelet/pods/7c974c3d-865a-4684-87ce-25d01a48d89e/volumes/kubernetes.io~csi/pvc-23dc3ecf-37fb-44ee-b8a6-7667a98aeb05/mount/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">direct ç±»å‹çš„å·ç›®å½•å­˜åœ¨ï¼Œä½†æ˜¯æ²¡æœ‰ç›¸åº”çš„æ•°æ®</span></span><br></pre></td></tr></table></figure><h2 id="host-ç«¯æŒ‚è½½ç‚¹"><a href="#host-ç«¯æŒ‚è½½ç‚¹" class="headerlink" title="host ç«¯æŒ‚è½½ç‚¹"></a>host ç«¯æŒ‚è½½ç‚¹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">lsblk</span></span><br><span class="line">...</span><br><span class="line">sdt                                                            65:48   0   200G  0 disk  </span><br><span class="line">â””â”€mpathb                                                      253:11   0   200G  0 mpath </span><br><span class="line">  â”œâ”€i1666574565-lvmlock                                       253:13   0    10G  0 lvm   </span><br><span class="line">  â”œâ”€i1666574565-pvc--23dc3ecf--37fb--44ee--b8a6--7667a98aeb05 253:15   0    20M  0 lvm   </span><br><span class="line">  â””â”€i1666574565-pvc--0878818c--5d93--4ed4--b034--5bf37a657a6e 253:16   0    20M  0 lvm   /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-b00bec5dd6f4958e-datadir</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtiofs ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mount | grep 3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9</span></span><br><span class="line">shm on /run/containerd/io.containerd.grpc.v1.cri/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,size=65536k)</span><br><span class="line">overlay on /run/containerd/io.containerd.runtime.v2.task/k8s.io/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/1/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254839/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254839/work)</span><br><span class="line">tmpfs on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared type tmpfs (ro,mode=755)</span><br><span class="line">overlay on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/1/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254839/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254839/work)</span><br><span class="line">overlay on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/1/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254839/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254839/work)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9-2c4e4dce04926bea-resolv.conf type xfs (ro,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9-2c4e4dce04926bea-resolv.conf type xfs (ro,relatime,attr2,inode64,noquota)</span><br><span class="line">overlay on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/251248/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254840/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254840/work)</span><br><span class="line">overlay on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/251248/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254840/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254840/work)</span><br><span class="line">/dev/mapper/i1666574565-pvc--0878818c--5d93--4ed4--b034--5bf37a657a6e on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-b00bec5dd6f4958e-datadir type ext4 (rw,relatime,data=ordered)</span><br><span class="line">/dev/mapper/i1666574565-pvc--0878818c--5d93--4ed4--b034--5bf37a657a6e on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-b00bec5dd6f4958e-datadir type ext4 (rw,relatime,data=ordered)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-d10c2427b7cfd382-hosts type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-d10c2427b7cfd382-hosts type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-aec3c5c428ab0e89-termination-log type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-aec3c5c428ab0e89-termination-log type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-0a63282c5f8f4163-hostname type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-0a63282c5f8f4163-hostname type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-a9d3c3e132ce299b-resolv.conf type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-a9d3c3e132ce299b-resolv.conf type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">tmpfs on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/mounts/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-30db53e3c43cb09f-serviceaccount type tmpfs (ro,relatime,size=32675592k)</span><br><span class="line">tmpfs on /run/kata-containers/shared/sandboxes/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/shared/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-30db53e3c43cb09f-serviceaccount type tmpfs (ro,relatime,size=32675592k)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">direct ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mount | grep 3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7</span></span><br><span class="line">shm on /run/containerd/io.containerd.grpc.v1.cri/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shm type tmpfs (rw,nosuid,nodev,noexec,relatime,size=65536k)</span><br><span class="line">overlay on /run/containerd/io.containerd.runtime.v2.task/k8s.io/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/1/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254837/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254837/work)</span><br><span class="line">tmpfs on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared type tmpfs (ro,mode=755)</span><br><span class="line">overlay on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/mounts/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/1/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254837/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254837/work)</span><br><span class="line">overlay on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/1/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254837/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254837/work)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/mounts/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7-27977320e8b95e05-resolv.conf type xfs (ro,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7-27977320e8b95e05-resolv.conf type xfs (ro,relatime,attr2,inode64,noquota)</span><br><span class="line">overlay on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/mounts/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/251248/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254838/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254838/work)</span><br><span class="line">overlay on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379/rootfs type overlay (rw,relatime,lowerdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/251248/fs,upperdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254838/fs,workdir=/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/254838/work)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/mounts/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-b03e8081dab8db44-hosts type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-b03e8081dab8db44-hosts type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/mounts/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-fc067734b16d5aec-termination-log type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-fc067734b16d5aec-termination-log type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/mounts/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-9578923c5ca9be73-hostname type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-9578923c5ca9be73-hostname type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/mounts/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-19d449c66d9d623d-resolv.conf type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">/dev/sda2 on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-19d449c66d9d623d-resolv.conf type xfs (rw,relatime,attr2,inode64,noquota)</span><br><span class="line">tmpfs on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/mounts/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-fd37e76da5e2d86d-serviceaccount type tmpfs (ro,relatime,size=32675592k)</span><br><span class="line">tmpfs on /run/kata-containers/shared/sandboxes/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/shared/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-fd37e76da5e2d86d-serviceaccount type tmpfs (ro,relatime,size=32675592k)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å·ç›´é€šåœºæ™¯ä¸‹ï¼ŒæŒä¹…å·çš„å—è®¾å¤‡ç”± CSI æ ¼å¼åŒ–å attach åˆ°èŠ‚ç‚¹åï¼Œä¸ä¼šæ‰§è¡Œ mount åˆ°èŠ‚ç‚¹çš„æ“ä½œï¼Œè€Œæ˜¯ç”± Kata Agent è§¦å‘ mount æ“ä½œï¼ŒæŒ‚è½½åˆ° VM ä¸­ï¼Œå› æ­¤ host ç«¯çœ‹ä¸åˆ°æŒ‚è½½ç‚¹ä¿¡æ¯ï¼Œæ‰€ä»¥å†™åœ¨ç›´é€šå·ä¸­çš„æ•°æ®ä¸ä¼šå‡ºç°åœ¨ host ä¸­</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸¤ç§æ¨¡å¼ä¸‹ï¼Œrootfs çš„æŒ‚è½½ç‚¹ä¸€è‡´</span></span><br></pre></td></tr></table></figure><h2 id="å®¹å™¨ç«¯æŒ‚è½½ç‚¹"><a href="#å®¹å™¨ç«¯æŒ‚è½½ç‚¹" class="headerlink" title="å®¹å™¨ç«¯æŒ‚è½½ç‚¹"></a>å®¹å™¨ç«¯æŒ‚è½½ç‚¹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtiofs ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it local-kata-virt sh</span></span><br><span class="line">/ # df -Th</span><br><span class="line">Filesystem           Type            Size      Used Available Use% Mounted on</span><br><span class="line">none                 virtiofs       80.0G     65.3G     14.7G  82% /</span><br><span class="line">tmpfs                tmpfs          64.0M         0     64.0M   0% /dev</span><br><span class="line">tmpfs                tmpfs         111.9M         0    111.9M   0% /sys/fs/cgroup</span><br><span class="line">none                 virtiofs       18.4M    332.0K     17.6M   2% /datadir</span><br><span class="line">kataShared           virtiofs       80.0G     65.3G     14.7G  82% /etc/hosts</span><br><span class="line">kataShared           virtiofs       80.0G     65.3G     14.7G  82% /dev/termination-log</span><br><span class="line">kataShared           virtiofs       80.0G     65.3G     14.7G  82% /etc/hostname</span><br><span class="line">kataShared           virtiofs       80.0G     65.3G     14.7G  82% /etc/resolv.conf</span><br><span class="line">shm                  tmpfs         111.9M         0    111.9M   0% /dev/shm</span><br><span class="line">none                 virtiofs       31.2G     12.0K     31.2G   0% /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">tmpfs                tmpfs          64.0M         0     64.0M   0% /proc/timer_list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">direct ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it local-kata-direct sh</span></span><br><span class="line">/ # df -Th</span><br><span class="line">Filesystem           Type            Size      Used Available Use% Mounted on</span><br><span class="line">none                 virtiofs       80.0G     65.3G     14.7G  82% /</span><br><span class="line">tmpfs                tmpfs          64.0M         0     64.0M   0% /dev</span><br><span class="line">tmpfs                tmpfs         111.9M         0    111.9M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda             ext4           18.4M    332.0K     17.6M   2% /datadir</span><br><span class="line">kataShared           virtiofs       80.0G     65.3G     14.7G  82% /etc/hosts</span><br><span class="line">kataShared           virtiofs       80.0G     65.3G     14.7G  82% /dev/termination-log</span><br><span class="line">kataShared           virtiofs       80.0G     65.3G     14.7G  82% /etc/hostname</span><br><span class="line">kataShared           virtiofs       80.0G     65.3G     14.7G  82% /etc/resolv.conf</span><br><span class="line">shm                  tmpfs         111.9M         0    111.9M   0% /dev/shm</span><br><span class="line">none                 virtiofs       31.2G     12.0K     31.2G   0% /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">tmpfs                tmpfs          64.0M         0     64.0M   0% /proc/timer_list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtiofs çš„åœºæ™¯ä¸‹çš„æŒä¹…å·ä»¥ virtiofs ç±»å‹æŒ‚è½½åˆ°å®¹å™¨ä¸­</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">direct çš„åœºæ™¯ä¸‹çš„æŒä¹…å·ä»¥ ext4 ç±»å‹æŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œå…¶ä¸­ ext4 å’Œ /dev/sda å‡å¯é€šè¿‡ç›´é€šæ—¶æŒ‡å®š</span></span><br></pre></td></tr></table></figure><h2 id="VM-ç«¯æŒ‚è½½ç‚¹"><a href="#VM-ç«¯æŒ‚è½½ç‚¹" class="headerlink" title="VM ç«¯æŒ‚è½½ç‚¹"></a>VM ç«¯æŒ‚è½½ç‚¹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtiofs ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime <span class="built_in">exec</span> 3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9</span></span><br><span class="line">root@clr-bab03a69f32d46fa9bfa8f735f0a4036 / $ df -Th</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/root      ext4      117M   95M   16M  87% /</span><br><span class="line">devtmpfs       devtmpfs  111M     0  111M   0% /dev</span><br><span class="line">tmpfs          tmpfs     112M     0  112M   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs      45M   28K   45M   1% /run</span><br><span class="line">tmpfs          tmpfs     4.0M     0  4.0M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs          tmpfs     112M     0  112M   0% /tmp</span><br><span class="line">kataShared     virtiofs   63G  147M   63G   1% /run/kata-containers/shared/containers</span><br><span class="line">shm            tmpfs     112M     0  112M   0% /run/kata-containers/sandbox/shm</span><br><span class="line">none           virtiofs   80G   66G   15G  83% /run/kata-containers/3f1316b887ba0cf7b0144a095fb543a262ae0c2b32a94c7658e1dbb3707c5ea9/rootfs</span><br><span class="line">none           virtiofs   80G   66G   15G  83% /run/kata-containers/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce/rootfs</span><br><span class="line">none           virtiofs   32G   12K   32G   1% /run/kata-containers/shared/containers/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-30db53e3c43cb09f-serviceaccount</span><br><span class="line">none           virtiofs   19M  332K   18M   2% /run/kata-containers/shared/containers/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-b00bec5dd6f4958e-datadir</span><br><span class="line">root@clr-bab03a69f32d46fa9bfa8f735f0a4036 / $ lsblk</span><br><span class="line">NAME      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">pmem0     259:0    0  126M  1 disk </span><br><span class="line">`-pmem0p1 259:1    0  124M  1 part /</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">direct ç±»å‹çš„ Pod</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime <span class="built_in">exec</span> 3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7</span></span><br><span class="line">root@clr-e5fe15d519854877912b7c4556e71299 / $ df -Th</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/root      ext4      117M   95M   16M  87% /</span><br><span class="line">devtmpfs       devtmpfs  111M     0  111M   0% /dev</span><br><span class="line">tmpfs          tmpfs     112M     0  112M   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs      45M   28K   45M   1% /run</span><br><span class="line">tmpfs          tmpfs     4.0M     0  4.0M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs          tmpfs     112M     0  112M   0% /tmp</span><br><span class="line">kataShared     virtiofs   63G  147M   63G   1% /run/kata-containers/shared/containers</span><br><span class="line">shm            tmpfs     112M     0  112M   0% /run/kata-containers/sandbox/shm</span><br><span class="line">none           virtiofs   80G   66G   15G  83% /run/kata-containers/3763faeb5fc0aa25265b751123b63fbbae1c8aa35bec202c42a4d569c0ef63a7/rootfs</span><br><span class="line">/dev/sda       ext4       19M  332K   18M   2% /run/kata-containers/sandbox/storage/MDow</span><br><span class="line">none           virtiofs   80G   66G   15G  83% /run/kata-containers/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379/rootfs</span><br><span class="line">none           virtiofs   32G   12K   32G   1% /run/kata-containers/shared/containers/6da9c84109d97ce2895b3e5b38631ebdf7185fc7b915cf4766572803ce4df379-fd37e76da5e2d86d-serviceaccount</span><br><span class="line">root@clr-e5fe15d519854877912b7c4556e71299 / $ lsblk                            </span><br><span class="line">NAME      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS</span><br><span class="line">sda         8:0    0   20M  0 disk /run/kata-containers/sandbox/storage/MDow</span><br><span class="line">pmem0     259:0    0  126M  1 disk </span><br><span class="line">`-pmem0p1 259:1    0  124M  1 part /</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">direct ç±»å‹çš„ Pod ä¼šè¾ƒ virtiofs å¤šä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œ/dev/sda -&gt; /run/kata-containers/sandbox/storage/MDow</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">virtiofs ç±»å‹çš„ Pod ä¼šè¾ƒ direct å¤šä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œ/run/kata-containers/shared/containers/cc3782d5f7aef968f640a0c161ee027efec8054c9860cae9d7254f8fe0659cce-b00bec5dd6f4958e-datadir</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Kata Containers stable-2.4 ç‰ˆæœ¬ä¸­ Block Volume ç›´é€šç‰¹æ€§çš„å®è·µéªŒè¯</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kubernetes ã€æºç èµ°è¯» - CPU Manager</title>
    <link href="http://shenxianghong.github.io/2022/07/11/2022-07-11%20Kubernetes%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20CPU%20Manager/"/>
    <id>http://shenxianghong.github.io/2022/07/11/2022-07-11%20Kubernetes%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20CPU%20Manager/</id>
    <published>2022-07-10T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.247Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src=/gallery/kubernetes/logo.svg></div><hr><blockquote><p>based on <strong>v1.20.12</strong></p></blockquote><h1 id="state"><a href="#state" class="headerlink" title="state"></a>state</h1><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;state&#x2F;state_checkpoint.go</u></em></p><p>åŸºäºå†…å­˜ï¼Œç”¨äºè®°å½• CPU Manager çš„çŠ¶æ€ï¼Œåç»­ Policy è·å– CPU ä»¥åŠåˆ†é…æƒ…å†µç­‰å‡ä» state å¯¹è±¡ä¸­è·å¾—</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// map[pod]map[container]CPU Set</span></span><br><span class="line"><span class="keyword">type</span> ContainerCPUAssignments <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">map</span>[<span class="type">string</span>]cpuset.CPUSet</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> stateMemory <span class="keyword">struct</span> &#123;</span><br><span class="line">sync.RWMutex</span><br><span class="line"><span class="comment">// è®°å½• CPU åˆ†é…æƒ…å†µ</span></span><br><span class="line">assignments   ContainerCPUAssignments</span><br><span class="line"><span class="comment">// è®°å½• CPU ä¿¡æ¯</span></span><br><span class="line">defaultCPUSet cpuset.CPUSet</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="storeState"><a href="#storeState" class="headerlink" title="storeState"></a>storeState</h2><p>å½“æœ‰ CPU åˆ†é…æˆ–è€…å›æ”¶æ—¶ï¼Œä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå°† state å¯¹è±¡æŒä¹…åŒ–ä¸º checkpoint æ–‡ä»¶</p><h2 id="restoreState"><a href="#restoreState" class="headerlink" title="restoreState"></a>restoreState</h2><p>å½“ CPU Manager å¯åŠ¨æ—¶ï¼Œä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå°†èŠ‚ç‚¹ä¸Šçš„ checkpoint æ–‡ä»¶æ¢å¤ä¸º state å¯¹è±¡</p><h1 id="checkpoint"><a href="#checkpoint" class="headerlink" title="checkpoint"></a>checkpoint</h1><p>åŸºäºæ–‡ä»¶ï¼ˆä½äº host ä¸Šçš„ &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;cpu_manager_stateï¼‰ï¼Œç”¨äºè®°å½• CPU Manager çš„çŠ¶æ€ï¼Œä¸ºäº†é¿å… state å¯¹è±¡åœ¨ Kubelet é‡å¯åå†…å­˜ä¸¢å¤±çš„é—®é¢˜</p><h1 id="Policy"><a href="#Policy" class="headerlink" title="Policy"></a>Policy</h1><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy.go</u></em></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Policy <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// è¿”å›ç­–ç•¥åç§°</span></span><br><span class="line">Name() <span class="type">string</span></span><br><span class="line"><span class="comment">// é’ˆå¯¹ State çš„æ ¡éªŒæµç¨‹</span></span><br><span class="line">Start(s state.State) <span class="type">error</span></span><br><span class="line"><span class="comment">// å®¹å™¨ CPU çš„åˆ†é…æµç¨‹</span></span><br><span class="line">Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line"><span class="comment">// å®¹å™¨ç§»é™¤åçš„å›æ”¶æµç¨‹</span></span><br><span class="line">RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span></span><br><span class="line"><span class="comment">// è°ƒç”¨ Policy ä¸­çš„ topologymanager.HintProvider çš„å®ç°</span></span><br><span class="line">GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line"><span class="comment">// è°ƒç”¨ Policy ä¸­çš„ topologymanager.HintProvider çš„å®ç°</span></span><br><span class="line">GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="none"><a href="#none" class="headerlink" title="none"></a>none</h2><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy_none.go</u></em></p><p>é»˜è®¤ç­–ç•¥ã€‚</p><p>CPU Manager çš„ none ç­–ç•¥å¹¶æœªåšä»»ä½•å®é™…çš„é€»è¾‘å¤„ç†ï¼Œä¸æä¾›ä»»ä½•ç³»ç»Ÿè°ƒåº¦å™¨é»˜è®¤è¡Œä¸ºä¹‹å¤–çš„äº²å’Œæ€§ç­–ç•¥ã€‚é€šè¿‡ CFS é…é¢æ¥å®ç° Guaranteed Pods å’Œ Burstable Pods çš„ CPU ä½¿ç”¨é™åˆ¶ã€‚å› æ­¤ï¼Œå…±äº«æ± çš„ CPU ä¹Ÿä¼šåŒ…å« Kubelet é¢„ç•™çš„éƒ¨åˆ†ã€‚</p><h2 id="static"><a href="#static" class="headerlink" title="static"></a>static</h2><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy_static.go</u></em></p><p>ä»…é’ˆå¯¹ QoS ä¸º Guaranteed ä¸” CPU ç”³è¯·é‡ä¸ºæ­£æ•´æ•°çš„ Pod èµ‹äºˆå¢å¼ºçš„ CPU äº²å’Œæ€§å’Œç‹¬å æ€§ã€‚</p><h3 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h3><ol><li>åˆå§‹åŒ–å¯åˆ†é…çš„ CPU ä¿¡æ¯ï¼Œå³è·å–æ‰€æœ‰å¯åˆ†é…çš„ CPUï¼ˆå¦‚æœå¼€å¯äº† strictReservedï¼Œåˆ™å–å…¨é‡ CPU å’Œé¢„ç•™ CPU çš„å·®é›†ï¼‰</li><li>å¦‚æœå¼€å¯äº† strictReservedï¼Œåˆ™æ ¡éªŒå…¨é‡ CPU å’Œé¢„ç•™ CPU æ˜¯å¦æ²¡æœ‰é‡å ï¼›å¦‚æœæœªå¼€å¯ï¼Œåˆ™æ ¡éªŒé¢„ç•™ CPU æ˜¯å¦å…¨åœ¨å…¨é‡ CPU ä¸­</li><li>æ ¡éªŒå·²åˆ†é…çš„ CPU å’Œå¯åˆ†é…çš„ CPU æ˜¯å¦ä¸é‡å </li><li>æ ¡éªŒå¯åˆ†é…çš„ CPU + å·²åˆ†é…çš„ CPU æ˜¯å¦ç­‰äºæ‰€æœ‰çš„ CPU - é¢„ç•™çš„ CPUï¼ˆå¦‚æœå¼€å¯äº† strictReservedï¼Œå¦åˆ™å¿½è§†é¢„ç•™çš„ CPUï¼‰</li></ol><h3 id="Allocate"><a href="#Allocate" class="headerlink" title="Allocate"></a>Allocate</h3><ol><li>åˆ¤æ–­ Pod QoS æ˜¯å¦æ˜¯ Guaranteed çº§åˆ«ï¼Œå¹¶ä¸” Container çš„ CPU request ä¸ºæ•´æ•°ï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œç›´æ¥è¿”å›ï¼Œä¸åšå¤„ç†</li><li>ä»å·²åˆ†é…çš„ CPU ä¿¡æ¯ä¸­åˆ¤æ–­è¯¥ Pod æ˜¯å¦å·²ç»åˆ†é…è¿‡ï¼Œå¦‚æœåˆ†é…è¿‡ï¼Œåˆ™æœ¬åœ°æ›´æ–°</li><li>è°ƒç”¨ Topology Manager è·å–æ‰€æœ‰çš„ hint providers è¿”å›çš„ hint</li><li>è·å–å¯ç”³é¢†çš„ CPUï¼ˆå³å¯åˆ†é… CPU + æ­¥éª¤äºŒä¸­å¯å¤ç”¨çš„ CPUï¼‰</li><li>å¦‚æœå¼€å¯äº† NUMA äº²å’Œç‰¹æ€§ï¼Œåˆ™è·å–åˆ°æ¶‰åŠåˆ°çš„  NUMA ä¸­çš„æ‰€æœ‰ CPUï¼Œå– NUMA CPU ä¹‹å’Œå’Œç”³è¯· CPU ä¸­çš„æœ€å°å€¼ä½œä¸ºå¾…å¯¹é½åˆ†é…çš„ CPU æ•°é‡ï¼Œæ ¡éªŒç”³è¯·çš„ CPU æ•°é‡æ˜¯å¦å¤§äº 1 ä¸”å°äºæ‰€æœ‰å¯ç”¨çš„ CPUï¼Œ</li><li>æ‰§è¡Œæ‹“æ‰‘æ„ŸçŸ¥ best-fit ç®—æ³•ï¼Œä¼˜å…ˆå¯¹é½èƒ½æ»¡è¶³ NUMA çš„éƒ¨åˆ†<br><em>å‚è€ƒ pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;cpu_assignment_test.go å•å…ƒæµ‹è¯•ç¤ºä¾‹</em><ol><li>å¦‚æœè¯·æ±‚çš„ CPU æ•°é‡ä¸å°äºå•å— CPU Socket ä¸­ Thread æ•°é‡ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆå°†æ•´å— CPU Socket ä¸­çš„Thread åˆ†é…<br><em>acc.freeSockets()ï¼Œè¿”å›å• Socket ä¸­æ‰€æœ‰ Thread å‡å¯ç”¨çš„ Socket åˆ—è¡¨</em></li><li>å¦‚æœå‰©ä½™è¯·æ±‚çš„ CPU æ•°é‡ä¸å°äºå•å—ç‰©ç† CPU Core æä¾›çš„ Thread æ•°é‡ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆå°†æ•´å—ç‰©ç† CPU Core ä¸Šçš„ Thread åˆ†é…<br><em>acc.freeCores()ï¼Œè¿”å›å• Core ä¸­æ‰€æœ‰ Thread å‡å¯ç”¨çš„ Core åˆ—è¡¨ï¼ŒæŒ‰ç…§ SocketID åšå‡åºæ’åˆ—</em></li><li>å‰©ä½™è¯·æ±‚çš„ CPU æ•°é‡åˆ™ä»æŒ‰ç…§å¦‚ä¸‹è§„åˆ™æ’å¥½åºçš„ Thread åˆ—è¡¨ä¸­é€‰æ‹©<br><em>acc.freeCPUs()ï¼Œè¿”å›æ‰€æœ‰å¯ç”¨çš„ Thread åˆ—è¡¨ï¼ŒæŒ‰ç…§ SocketID å’Œ CoreID åšå‡åºæ’åˆ—</em><ol><li>ç›¸åŒ Socket ä¸Šå¯ç”¨çš„ Thread</li><li>ç›¸åŒ Core ä¸Šå¯ç”¨çš„ Thread</li><li>CPU ID å‡åºæ’åˆ—</li></ol></li></ol></li><li>å¯¹äºå‰©ä½™çš„ CPUï¼Œè¿›è¡Œå¦‚ä¸Šæ‹“æ‰‘æ„ŸçŸ¥ best-fit ç®—æ³•ï¼Œåˆå¹¶ä»¥ä¸Šä¸¤éƒ¨åˆ†ï¼Œä½œä¸ºæœ€ç»ˆçš„ CPU ç»‘å®šç»“æœ</li><li>ä»å…±äº«æ±  CPU ä¸­å»é™¤å¾…åˆ†é…çš„ CPU</li></ol><h3 id="RemoveContainer"><a href="#RemoveContainer" class="headerlink" title="RemoveContainer"></a>RemoveContainer</h3><ol><li>è·å–åˆ°å®¹å™¨çš„ CPU åˆ†é…ä¿¡æ¯ï¼Œåˆ é™¤æ‰åˆ†é…çš„è®°å½•ä¿¡æ¯ï¼Œå…±äº«æ±  CPU ä¸­æ·»åŠ  CPU</li></ol><h3 id="GetTopologyHints"><a href="#GetTopologyHints" class="headerlink" title="GetTopologyHints"></a>GetTopologyHints</h3><ol><li>è·å–å®¹å™¨ç”³è¯·çš„ CPU æ•°é‡</li><li>å¦‚æœå®¹å™¨å·²ç»åˆ†é…äº†ç”³è¯· CPUï¼Œé‚£ä¹ˆåˆ¤æ–­ç”³è¯·çš„å’Œå·²åˆ†é…çš„æ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰åˆ™ä¸ç»™å‡º hintï¼Œç›´æ¥è¿”å›ï¼›ç›¸ç­‰åˆ™ç”¨å·²åˆ†é…çš„ç”Ÿæˆ hint</li><li>è·å–å¯ç”¨çš„ CPU å’Œå¯å¤ç”¨çš„ CPU ä¿¡æ¯ï¼Œä¸¤è€…çš„åˆé›†ä½œä¸ºå¯å¤ç”¨çš„ CPUï¼Œç”Ÿæˆ hint</li></ol><h3 id="GetPodTopologyHints"><a href="#GetPodTopologyHints" class="headerlink" title="GetPodTopologyHints"></a>GetPodTopologyHints</h3><ol><li>è·å– Pod ç”³è¯·çš„ CPU æ•°é‡ï¼ˆè·å– Init Container æœ€å¤§å€¼å’Œ Container ä¹‹å’Œï¼Œå–ä¸¤è€…æœ€å¤§ä¸º CPU æ•°é‡ï¼‰</li><li>éå† Pod çš„æ¯ä¸ªå®¹å™¨ï¼Œå¦‚æœå®¹å™¨å·²ç»åˆ†é…äº†ç”³è¯· CPUï¼Œé‚£ä¹ˆåˆ¤æ–­ç”³è¯·çš„å’Œå·²åˆ†é…çš„æ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰åˆ™ä¸ç»™å‡º hintï¼Œç›´æ¥è¿”å›ï¼›å¦‚æœæ‰€æœ‰å®¹å™¨çš„å·²åˆ†é…çš„ CPU ä¹‹å’Œç­‰äº Pod çš„ç”³è¯· CPU æ•°é‡ï¼Œåˆ™ç”¨å·²åˆ†é…çš„ç”Ÿæˆ hint</li><li>è·å–å¯ç”¨çš„ CPU å’Œå¯å¤ç”¨çš„ CPU ä¿¡æ¯ï¼Œä¸¤è€…çš„åˆé›†ä½œä¸ºå¯å¤ç”¨çš„ CPUï¼Œç”Ÿæˆ hint</li></ol><h3 id="generateCPUTopologyHints"><a href="#generateCPUTopologyHints" class="headerlink" title="generateCPUTopologyHints"></a>generateCPUTopologyHints</h3><p>ç”Ÿæˆ CPU TopologyHint ä¿¡æ¯ï¼Œå‡è®¾æœ‰ä¸¤ä¸ª NUMA èŠ‚ç‚¹ï¼ˆç¼–å·ä¸º 0 å’Œ 1ï¼‰ï¼ŒNUMA0 ä¸Šæœ‰ CPU1 å’Œ CPU2ï¼ŒNUMA1ä¸Šæœ‰ CPU3 å’Œ CPU4ï¼ŒæŸä¸ª Pod è¯·æ±‚ä¸¤ä¸ª CPUã€‚é‚£ä¹ˆ CPU Manager è¿™ä¸ª HintProvider ä¼šè°ƒç”¨ generateCPUTopologyHints äº§ç”Ÿå¦‚ä¸‹çš„ TopologyHintï¼š</p><ul><li>{01: True} ä»£è¡¨ä» NUMA0 å– 2 ä¸ª CPUï¼Œå¹¶ä¸”æ˜¯â€œä¼˜å…ˆè€ƒè™‘çš„â€</li><li>{10: True} ä»£è¡¨ä» NUMA1 å– 2 ä¸ª CPUï¼Œå¹¶ä¸”æ˜¯â€œä¼˜å…ˆè€ƒè™‘çš„â€</li><li>{11: False} ä»£è¡¨ä» NUMA0 å’Œ NUMA1 å„å–ä¸€ä¸ª CPUï¼Œä¸æ˜¯â€œä¼˜å…ˆè€ƒè™‘çš„â€</li></ul><ol><li>è·å–é›†ç¾¤ä¸­çš„æ‰€æœ‰ NUMA èŠ‚ç‚¹</li><li>è·å– NUMA èŠ‚ç‚¹ç»„åˆä¸­æ¶‰åŠåˆ°çš„ CPU</li><li>å¦‚æœ NUMA èŠ‚ç‚¹ç»„åˆä¸­æ‰€æ¶‰åŠåˆ°çš„ CPU ä¸ªæ•°æ¯”è¯·æ±‚çš„ CPU æ•°å¤§ï¼Œå¹¶ä¸”è¿™ä¸ªç»„åˆæ‰€æ¶‰åŠçš„ NUMA èŠ‚ç‚¹ä¸ªæ•°æ˜¯ç›®å‰ä¸ºæ­¢æ‰€æœ‰ç»„åˆä¸­æœ€å°çš„ï¼Œé‚£ä¹ˆå°±æ›´æ–°æ­¥éª¤ 1 çš„è·å–ç»“æœ</li><li>å¾ªç¯ç»Ÿè®¡å½“å‰èŠ‚ç‚¹å¯ç”¨çš„ CPU ä¸­ï¼Œæœ‰å“ªäº›æ˜¯å±äºå½“å‰æ­£åœ¨å¤„ç†çš„ NUMA èŠ‚ç‚¹ç»„åˆ</li><li>å¦‚æœå½“å‰ NUMA ç»„åˆä¸­å¯ç”¨çš„ CPU æ•°æ¯”è¯·æ±‚çš„ CPU å°ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±åˆ›å»ºä¸€ä¸ª TopologyHintï¼Œå¹¶æŠŠå®ƒåŠ å…¥åˆ° hints ä¸­</li><li>éå†æ¯ä¸€ä¸ª hintï¼Œæ¶‰åŠåˆ°çš„ NUMA èŠ‚ç‚¹ä¸ªæ•°æœ€å°‘ï¼ˆå³æ­¥éª¤ 3 ä¸­è·å–çš„ç»“æœï¼‰çš„ç»„åˆï¼Œä¼šæ ‡æ³¨ preferred ä¸º true</li></ol><h1 id="CPU-Manager"><a href="#CPU-Manager" class="headerlink" title="CPU Manager"></a>CPU Manager</h1><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;cpu_manager.go</u></em></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Manager <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// Kubelet åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œå¯åŠ¨ CPU Manager</span></span><br><span class="line">Start(activePods ActivePodsFunc, sourcesReady config.SourcesReady, podStatusProvider status.PodStatusProvider, containerRuntime runtimeService, initialContainers containermap.ContainerMap) <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å°† CPU åˆ†é…ç»™å®¹å™¨ï¼Œå¿…é¡»åœ¨ AddContainer() ä¹‹å‰çš„æŸä¸ªæ—¶é—´ç‚¹è°ƒç”¨ï¼Œä¾‹å¦‚åœ¨ Pod Admission æ—¶</span></span><br><span class="line">Allocate(pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨å®¹å™¨åˆ›å»ºå’Œå®¹å™¨å¯åŠ¨ä¹‹é—´è°ƒç”¨ï¼Œä»¥ä¾¿å¯ä»¥å°†åˆå§‹ CPU äº²å’Œæ€§è®¾ç½®å†™å…¥ç¬¬ä¸€ä¸ªè¿›ç¨‹å¼€å§‹æ‰§è¡Œä¹‹å‰çš„å®¹å™¨è¿è¡Œæ—¶ä¸­</span></span><br><span class="line">AddContainer(p *v1.Pod, c *v1.Container, containerID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ Kubelet å†³å®šæ€æ­»æˆ–åˆ é™¤ä¸€ä¸ªå¯¹è±¡åè°ƒç”¨ï¼Œåœ¨æ­¤è°ƒç”¨ä¹‹åï¼ŒCPU Manager åœæ­¢å°è¯•åè°ƒè¯¥å®¹å™¨å¹¶ä¸”é‡Šæ”¾ç»‘å®šäºè¯¥å®¹å™¨çš„ä»»ä½• CPU</span></span><br><span class="line"><span class="comment">// ç›®å‰æœªå‘ç°è°ƒç”¨å¤„</span></span><br><span class="line">RemoveContainer(containerID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å†…éƒ¨ CPU Manager çš„çŠ¶æ€</span></span><br><span class="line">State() state.Reader</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ topologymanager.HintProvider çš„å®ç°ï¼Œå¤„ç† NUMA èµ„æºå¯¹é½ç­‰é€»è¾‘</span></span><br><span class="line">GetTopologyHints(*v1.Pod, *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–åˆ†é…ç»™ Pod å®¹å™¨çš„ CPU ä¿¡æ¯</span></span><br><span class="line">GetCPUs(podUID, containerName <span class="type">string</span>) []<span class="type">int64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ topologymanager.HintProvider çš„å®ç°ï¼Œå¤„ç† NUMA èµ„æºå¯¹é½ç­‰é€»è¾‘</span></span><br><span class="line">GetPodTopologyHints(pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Start-1"><a href="#Start-1" class="headerlink" title="Start"></a>Start</h2><ol><li>åˆå§‹åŒ– checkpoint æ–‡ä»¶ï¼Œå¹¶åŸºäºè¯¥æ–‡ä»¶åˆå§‹åŒ– state å¯¹è±¡</li><li>è°ƒç”¨ Policy çš„ Start æ¥å£ï¼Œä¼ å…¥ state</li><li>å¦‚æœç­–ç•¥æ˜¯ noneï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™å¯åŠ¨ goroutine å®šæ—¶è°ƒå’Œ state</li></ol><h2 id="Allocate-1"><a href="#Allocate-1" class="headerlink" title="Allocate"></a>Allocate</h2><ol><li>æ¸…ç†ææµ…çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯è·å– state ä¸­è®°å½•çš„ CPU ä¿¡æ¯ï¼Œä½†æ˜¯å®é™…ä¸Šä½¿ç”¨çš„å®¹å™¨å·²ç»ä¸æ˜¯ active çŠ¶æ€</li><li>è°ƒç”¨ Policy çš„ Allocate æ¥å£</li></ol><h2 id="AddContainer"><a href="#AddContainer" class="headerlink" title="AddContainer"></a>AddContainer</h2><ol><li>ä» state ä¸­è·å– Pod å®¹å™¨çš„ CPU ä¿¡æ¯ï¼Œå¦‚æœä¸ºç©ºç›´æ¥è¿”å›</li><li>è°ƒç”¨ CRI çš„ UpdateContainerResources æ¥å£ï¼Œæ›´æ–°å®¹å™¨çš„ CPU Set ä¿¡æ¯ï¼Œå¦‚æœæ›´æ–°å¤±è´¥è°ƒç”¨ Policy çš„ RemoveContainer æ¥å£å›æ»šçŠ¶æ€ï¼Œä» containerMap ä¸­ç§»é™¤å®¹å™¨ä¿¡æ¯</li></ol><h2 id="RemoveContainer-1"><a href="#RemoveContainer-1" class="headerlink" title="RemoveContainer"></a>RemoveContainer</h2><ol><li>è°ƒç”¨ Policy çš„ RemoveContainer æ¥å£</li><li>ä» containerMap ä¸­ç§»é™¤ Container ä¿¡æ¯</li></ol><h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><ol><li>è¿”å› state å¯¹è±¡</li></ol><h2 id="GetTopologyHints-1"><a href="#GetTopologyHints-1" class="headerlink" title="GetTopologyHints"></a>GetTopologyHints</h2><ol><li>æ¸…ç†ææµ…çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯è·å– state ä¸­è®°å½•çš„ CPU ä¿¡æ¯ï¼Œä½†æ˜¯å®é™…ä¸Šä½¿ç”¨çš„å®¹å™¨å·²ç»ä¸æ˜¯ active çŠ¶æ€</li><li>è°ƒç”¨ Policy çš„ GetTopologyHints æ¥å£</li></ol><h2 id="GetCPUs"><a href="#GetCPUs" class="headerlink" title="GetCPUs"></a>GetCPUs</h2><ol><li>è·å– state ä¸­è®°å½•æœ‰ç»™å®š Pod å’Œå®¹å™¨çš„ CPU åˆ†é…æƒ…å†µï¼Œå¹¶è¿”å›</li></ol><h2 id="GetPodTopologyHints-1"><a href="#GetPodTopologyHints-1" class="headerlink" title="GetPodTopologyHints"></a>GetPodTopologyHints</h2><ol><li>æ¸…ç†ææµ…çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯è·å– state ä¸­è®°å½•çš„ CPU ä¿¡æ¯ï¼Œä½†æ˜¯å®é™…ä¸Šä½¿ç”¨çš„å®¹å™¨å·²ç»ä¸æ˜¯ active çŠ¶æ€</li><li>è°ƒç”¨ Policy çš„ GetPodTopologyHints æ¥å£</li></ol><h2 id="reconcileState"><a href="#reconcileState" class="headerlink" title="reconcileState"></a>reconcileState</h2><p>é’ˆå¯¹é none ç±»å‹çš„ Policy å‘¨æœŸæ€§è°ƒå’Œ</p><ol><li>æ¸…ç†ææµ…çš„èµ„æºï¼Œä¹Ÿå°±æ˜¯è·å– state ä¸­è®°å½•çš„ CPU ä¿¡æ¯ï¼Œä½†æ˜¯å®é™…ä¸Šä½¿ç”¨çš„å®¹å™¨å·²ç»ä¸æ˜¯ active çŠ¶æ€</li><li>éå†æ‰€æœ‰çš„ active çŠ¶æ€çš„ Pod çš„å®¹å™¨</li><li>æ£€æŸ¥è¯¥ ContainerID æ˜¯å¦åœ¨ CPU Manager ç»´æŠ¤çš„ state ä¸­ï¼Œç„¶åæ£€æŸ¥å¯¹åº”çš„ Pod.Status.Phase æ˜¯å¦ä¸º Running ä¸” DeletionTimestamp ä¸º nilï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ CPU Manager çš„ AddContainer å¯¹è¯¥ Container&#x2F;Pod è¿›è¡Œ QoS å’Œ CPU request æ£€æŸ¥ï¼Œå¦‚æœæ»¡è¶³ static Policy çš„æ¡ä»¶ï¼Œåˆ™è°ƒç”¨ takeByTopology ä¸ºè¯¥ Container åˆ†é…æœ€ä½³çš„ CPU Setï¼Œå¹¶å†™å…¥åˆ° state å’Œ checkpoint æ–‡ä»¶ä¸­</li><li>ç„¶åä» State ä¸­è·å–è¯¥ ContainerID å¯¹åº”çš„ CPU Setï¼Œè°ƒç”¨ CRI UpdateContainerResources æ¥å£æ›´æ–°å®¹å™¨çš„ CPU Set ä¿¡æ¯</li></ol>]]></content>
    
    
    <summary type="html">Kubelet ä¸­ CPU Manager æ¨¡å—çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Scheduling &amp; Orchestration" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/"/>
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/Kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” Gateway</title>
    <link href="http://shenxianghong.github.io/2022/07/10/2022-07-10%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Gateway/"/>
    <id>http://shenxianghong.github.io/2022/07/10/2022-07-10%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Gateway/</id>
    <published>2022-07-09T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.212Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>Gateway æè¿°äº†åœ¨ç½‘æ ¼è¾¹ç¼˜è¿è¡Œçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œç”¨äºæ¥æ”¶ä¼ å…¥æˆ–ä¼ å‡ºçš„ HTTP&#x2F;TCP è¿æ¥ã€‚è¯¥è§„èŒƒæè¿°äº†ä¸€ç»„åº”è¯¥å…¬å¼€çš„ç«¯å£ã€è¦ä½¿ç”¨çš„åè®®ç±»å‹ã€è´Ÿè½½å‡è¡¡å™¨çš„ SNI é…ç½®ç­‰ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ Gateway é…ç½®è®¾ç½®ä»£ç†ä»¥å……å½“è´Ÿè½½å‡è¡¡å™¨ï¼Œå°†ç«¯å£ 80 å’Œ 9080 (http)ã€443 (https)ã€9443 (https) å’Œç«¯å£ 2379 (TCP) ç”¨äºå…¥å£ã€‚Gateway ä¼šåº”ç”¨åœ¨å¸¦æœ‰æ ‡ç­¾ app: my-gateway-controller çš„ Pod ä¸Šã€‚<br><em>è™½ç„¶ Istio é…ç½®ä»£ç†ä¾¦å¬è¿™äº›ç«¯å£ï¼Œä½†ç”¨æˆ·æœ‰è´£ä»»ç¡®ä¿å…è®¸åˆ°è¿™äº›ç«¯å£çš„å¤–éƒ¨æµé‡è¿›å…¥ç½‘æ ¼ã€‚</em></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">some-config-namespace</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-gateway-controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uk.bookinfo.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">eu.bookinfo.com</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">httpsRedirect:</span> <span class="literal">true</span> <span class="comment"># sends 301 redirect for http requests</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https-443</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">uk.bookinfo.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">eu.bookinfo.com</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">SIMPLE</span> <span class="comment"># enables HTTPS on this port</span></span><br><span class="line">      <span class="attr">serverCertificate:</span> <span class="string">/etc/certs/servercert.pem</span></span><br><span class="line">      <span class="attr">privateKey:</span> <span class="string">/etc/certs/privatekey.pem</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">9443</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https-9443</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;bookinfo-namespace/*.bookinfo.com&quot;</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">SIMPLE</span> <span class="comment"># enables HTTPS on this port</span></span><br><span class="line">      <span class="attr">credentialName:</span> <span class="string">bookinfo-secret</span> <span class="comment"># fetches certs from Kubernetes secret</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http-wildcard</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">2379</span> <span class="comment"># to expose internal service via external port 2379</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">MONGO</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure><p>Gateway æè¿°äº†è´Ÿè½½å‡è¡¡å™¨çš„ L4 - L6 å±æ€§ã€‚ç„¶åï¼Œå¯ä»¥å°† VirtualService ç»‘å®šåˆ° Gateway æ§åˆ¶åˆ°è¾¾ç‰¹å®š host æˆ– Gateway ç«¯å£çš„æµé‡çš„è½¬å‘ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ VirtualService æŠŠæµé‡è·¯å¾„  <a href="https://uk.bookinfo.com/reviews%E3%80%81https://eu.bookinfo.com/reviews%E3%80%81http://uk.bookinfo.com:9080/reviews%E3%80%81http://eu.bookinfo.com:9080/reviews">https://uk.bookinfo.com/reviewsã€https://eu.bookinfo.com/reviewsã€http://uk.bookinfo.com:9080/reviewsã€http://eu.bookinfo.com:9080/reviews</a> åˆ†ä¸ºäº†ä¸¤ä¸ªç‰ˆæœ¬ï¼ˆprod å’Œ qaï¼‰ã€‚å¦å¤–ï¼ŒåŒ…å« user: dev-123 cookie çš„è¯·æ±‚å°†å‘é€åˆ° 7777 ç«¯å£çš„ qa ç‰ˆæœ¬ã€‚The same rule is also applicable inside the mesh for requests to the â€œreviews.prod.svc.cluster.localâ€ service. This rule is applicable across ports 443, 9080. Note that <a href="http://uk.bookinfo.com/">http://uk.bookinfo.com</a> gets redirected to <a href="https://uk.bookinfo.com/">https://uk.bookinfo.com</a> (i.e. 80 redirects to 443).</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-rule</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">bookinfo-namespace</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">uk.bookinfo.com</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">eu.bookinfo.com</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">some-config-namespace/my-gateway</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mesh</span> <span class="comment"># applies to all the sidecars in the mesh</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">cookie:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">&quot;user=dev-123&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">7777</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.qa.svc.cluster.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/reviews/</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">9080</span> <span class="comment"># can be omitted if it&#x27;s the only port for reviews</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.qa.svc.cluster.local</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹ VirtualService å°†åˆ°è¾¾ï¼ˆå¤–éƒ¨ï¼‰ç«¯å£ 27017 çš„æµé‡è½¬å‘åˆ°ç«¯å£ 5555 ä¸Šçš„å†…éƒ¨ Mongo æœåŠ¡å™¨ã€‚æ­¤è§„åˆ™åœ¨ç½‘æ ¼å†…éƒ¨ä¸é€‚ç”¨ï¼Œå› ä¸º gateways ä¸­çœç•¥äº†ä¿ç•™åç§°ç½‘æ ¼ï¼ˆmeshï¼‰ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-mongo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">bookinfo-namespace</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mongosvr.prod.svc.cluster.local</span> <span class="comment"># name of internal Mongo service</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">some-config-namespace/my-gateway</span> <span class="comment"># can omit the namespace if gateway is in same namespace as virtual service.</span></span><br><span class="line">  <span class="attr">tcp:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">mongo.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">5555</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ hosts å­—æ®µä¸­çš„ namespace&#x2F;host è¯­æ³•æ¥é™åˆ¶å¯ä»¥ç»‘å®šåˆ° Gateway æœåŠ¡å™¨çš„ VirtualServiceã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ Gateway å…è®¸ ns1 å‘½åç©ºé—´ä¸­çš„ä»»ä½• VirtualService ç»‘å®šåˆ°å®ƒï¼ŒåŒæ—¶é™åˆ¶åªæœ‰ ns2 å‘½åç©ºé—´ä¸­å…·æœ‰ foo.bar.com host çš„ VirtualService ç»‘å®šã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">some-config-namespace</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-gateway-controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ns1/*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ns2/foo.bar.com&quot;</span></span><br></pre></td></tr></table></figure><h1 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h1><p>Gateway æè¿°äº†åœ¨ç½‘æ ¼è¾¹ç¼˜è¿è¡Œçš„è´Ÿè½½å‡è¡¡å™¨ï¼Œç”¨äºæ¥æ”¶ä¼ å…¥æˆ–ä¼ å‡ºçš„ HTTP&#x2F;TCP è¿æ¥ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#Server">servers</a></td><td>Server é›†åˆ</td></tr><tr><td>selector</td><td>ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œç”¨ä»¥åŒ¹é…ä¸€ç»„ç‰¹å®š pod&#x2F;VM ä¸Šåº”ç”¨æ­¤ Gatewayã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå·¥ä½œè´Ÿè½½ä¼šæ ¹æ®æ ‡ç­¾é€‰æ‹©å™¨åœ¨æ‰€æœ‰å‘½åç©ºé—´ä¸­è¿›è¡Œæœç´¢ã€‚è¿™æ„å‘³ç€ Namespace foo ä¸­çš„ Gateway èµ„æºå¯ä»¥æ ¹æ®æ ‡ç­¾é€‰æ‹© Namespace bar ä¸­çš„ Podã€‚è¿™ç§è¡Œä¸ºå¯ä»¥é€šè¿‡ Istiod ä¸­çš„ PILOT_SCOPE_GATEWAY_TO_NAMESPACE ç¯å¢ƒå˜é‡æ¥æ§åˆ¶ã€‚å¦‚æœæ­¤å˜é‡è®¾ç½®ä¸º trueï¼Œåˆ™æ ‡ç­¾æœç´¢çš„èŒƒå›´ä»…é™äº Gateway èµ„æºæ‰€åœ¨çš„ Namespaceã€‚æ¢è¨€ä¹‹ï¼ŒGateway èµ„æºå¿…é¡»ä¸ Gateway å·¥ä½œè´Ÿè½½å®ä¾‹ä½äºç›¸åŒçš„ Namespace ä¸­ã€‚å¦‚æœé€‰æ‹©å™¨ä¸º nilï¼Œåˆ™ Gateway å°†åº”ç”¨äºæ‰€æœ‰å·¥ä½œè´Ÿè½½</td></tr></tbody></table><h1 id="Server"><a href="#Server" class="headerlink" title="Server"></a><a name="Server">Server</a></h1><p>Server æè¿°ç‰¹å®šè´Ÿè½½å‡è¡¡ç«¯å£ä¸Šçš„ä»£ç†å±æ€§ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><a href="#Port">port</a></td><td>ä»£ç†ç›‘å¬çš„è¯·æ±‚é“¾æ¥ç«¯å£ä¿¡æ¯</td></tr><tr><td>bind</td><td>ç»‘å®šåˆ°çš„ IP æˆ– Unix åŸŸå¥—æ¥å­—ã€‚æ ¼å¼ä¸º x.x.x.xã€unix:&#x2F;&#x2F;&#x2F;path&#x2F;to&#x2F;uds æˆ– unix:&#x2F;&#x2F;@foobarï¼ˆLinux æŠ½è±¡å‘½åç©ºé—´ï¼‰ã€‚ä½¿ç”¨ Unix åŸŸå¥—æ¥å­—æ—¶ï¼Œç«¯å£å·åº”ä¸º 0ã€‚ç”¨äºå°†æ­¤ server çš„å¯è¾¾æ€§é™åˆ¶ä¸ºä»…é™ Gateway å†…éƒ¨ã€‚è¿™é€šå¸¸åœ¨ Gateway éœ€è¦ä¸å¦ä¸€ä¸ªç½‘æ ¼ server é€šä¿¡æ—¶ä½¿ç”¨ï¼Œä¾‹å¦‚å‘å¸ƒæŒ‡æ ‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨æŒ‡å®šç»‘å®šåˆ›å»ºçš„ server å°†ä¸å¯ç”¨äºå¤–éƒ¨ Gateway å®¢æˆ·ç«¯</td></tr><tr><td>hosts</td><td>Gateway æš´éœ²çš„ host ä¿¡æ¯ã€‚è™½ç„¶é€šå¸¸é€‚ç”¨äº HTTP æœåŠ¡ï¼Œä½†å®ƒä¹Ÿè¡¨è¿°å¸¦æœ‰ SNI çš„ TLS çš„ TCP æœåŠ¡ã€‚host ä¸ºå¸¦æœ‰ &lt;namespace&gt;&#x2F; å¯é€‰å‰ç¼€çš„ dnsNameï¼ˆFQDN æ ¼å¼ï¼Œä¹Ÿå¯ä»¥ç±»ä¼¼å¦‚ prod&#x2F;*.example.comï¼‰ã€‚å°† dnsName è®¾ç½®ä¸º * è¡¨ç¤ºä»æŒ‡å®šçš„å‘½åç©ºé—´ï¼ˆä¾‹å¦‚ prod&#x2F;*ï¼‰ä¸­é€‰æ‹©æ‰€æœ‰ VirtualService hostã€‚<br />namespace å¯ä»¥è®¾ç½®ä¸º * æˆ– .ï¼Œåˆ†åˆ«ä»£è¡¨ä»»ä½•æˆ–å½“å‰å‘½åç©ºé—´ã€‚ä¾‹å¦‚ï¼Œ*&#x2F;foo.example.com ä»ä»»ä½•å¯ç”¨çš„å‘½åç©ºé—´ä¸­é€‰æ‹© serverï¼Œè€Œ .&#x2F;foo.example.com ä»…ä» sidecar çš„å‘½åç©ºé—´ä¸­é€‰æ‹©æœåŠ¡ã€‚å¦‚æœæœªæŒ‡å®š namespace&#x2F; å‰ç¼€éƒ¨åˆ†ï¼Œåˆ™é»˜è®¤ä¸º *&#x2F;ã€‚æ‰€é€‰å‘½åç©ºé—´ä¸­çš„ä»»ä½•å…³è” DestinationRule ä¹Ÿå°†è¢«ä½¿ç”¨ã€‚<br />VirtualService å¿…é¡»ç»‘å®šåˆ° Gatewayï¼Œå¹¶ä¸”å¿…é¡»æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªä¸ server ä¸­åŒ¹é…çš„ hostã€‚åŒ¹é…å¯ä»¥æ˜¯å®Œå…¨åŒ¹é…æˆ–åç¼€åŒ¹é…ã€‚<br /><em>ä¾‹å¦‚ï¼Œå¦‚æœ server çš„ host æŒ‡å®š .example.comï¼Œåˆ™å…·æœ‰ host dev.example.com æˆ– prod.example.com çš„ VirtualService å°†åŒ¹é…ã€‚ä½†æ˜¯ï¼Œhost example.com æˆ– newexample.com çš„ VirtualService å°†ä¸åŒ¹é…</em></td></tr><tr><td><a href="#ServerTLSSettings">tls</a></td><td>ä¸€ç»„æ§åˆ¶ server è¡Œä¸ºçš„ TLS ç›¸å…³é€‰é¡¹ã€‚ä½¿ç”¨è¿™äº›é€‰é¡¹æ¥æ§åˆ¶æ˜¯å¦åº”å°†æ‰€æœ‰ HTTP è¯·æ±‚é‡å®šå‘åˆ° HTTPSï¼Œä»¥åŠè¦ä½¿ç”¨çš„ TLS æ¨¡å¼</td></tr><tr><td>name</td><td>server çš„å¯é€‰åç§°ï¼Œè®¾ç½®ååœ¨æ‰€æœ‰ server ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚å¯ç”¨äºä¾‹å¦‚ä¸ºä½¿ç”¨æ­¤åç§°ç”Ÿæˆçš„ç»Ÿè®¡ä¿¡æ¯æ·»åŠ å‰ç¼€ç­‰</td></tr></tbody></table><h1 id="Port"><a href="#Port" class="headerlink" title="Port"></a><a name="Port">Port</a></h1><p>Port æè¿°äº† server çš„ç‰¹å®šç«¯å£çš„å±æ€§ã€‚</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>number</td><td>ç«¯å£å·</td></tr><tr><td>protocol</td><td>ç«¯å£åè®®ã€‚å¯é€‰å€¼ HTTPã€HTTPSã€GRPCã€HTTP2ã€MONGOã€TCPã€TLSã€‚TLS æ„å‘³ç€è¿æ¥å°†æ ¹æ® SNI æ ‡å¤´è·¯ç”±åˆ°ç›®çš„åœ°ï¼Œè€Œä¸ä¼šç»ˆæ­¢ TLS è¿æ¥</td></tr><tr><td>name</td><td>åˆ†é…ç»™ç«¯å£çš„æ ‡ç­¾</td></tr><tr><td>targetPort</td><td>æ¥æ”¶æµé‡çš„ endpoint ä¸Šçš„ç«¯å£å·ã€‚ä»…åœ¨ä¸ ServiceEntries ä¸€èµ·ä½¿ç”¨æ—¶é€‚ç”¨</td></tr></tbody></table><h1 id="ServerTLSSettings"><a href="#ServerTLSSettings" class="headerlink" title="ServerTLSSettings"></a><a name="ServerTLSSettings">ServerTLSSettings</a></h1><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td>httpsRedirect</td><td>å¦‚æœè®¾ç½®ä¸º trueï¼Œè´Ÿè½½å‡è¡¡å™¨å°†ä¸ºæ‰€æœ‰ HTTP è¿æ¥å‘é€ 301 é‡å®šå‘ï¼Œè¦æ±‚å®¢æˆ·ç«¯ä½¿ç”¨ HTTPS</td></tr><tr><td><a href="#ServerTLSSettings.TLSmode">mode</a></td><td>å¯é€‰ï¼šè¡¨æ˜æ˜¯å¦åº”ä½¿ç”¨ TLS ä¿æŠ¤ä¸æ­¤ç«¯å£çš„è¿æ¥ã€‚è¯¥å­—æ®µçš„å€¼å†³å®šäº† TLS çš„å®æ–½æ–¹å¼</td></tr><tr><td>serverCertificate</td><td>å¦‚æœ mode æ˜¯ SIMPLE æˆ– MUTUALï¼Œåˆ™ä¸ºå¿…éœ€å­—æ®µã€‚ä¿å­˜ä½¿ç”¨çš„æœåŠ¡å™¨ç«¯ TLS è¯ä¹¦çš„æ–‡ä»¶çš„è·¯å¾„</td></tr><tr><td>privateKey</td><td>å¦‚æœ mode æ˜¯ SIMPLE æˆ– MUTUALï¼Œåˆ™ä¸ºå¿…éœ€å­—æ®µã€‚ä¿å­˜æœåŠ¡å™¨ç§é’¥çš„æ–‡ä»¶çš„è·¯å¾„</td></tr><tr><td>caCertificates</td><td>å¦‚æœ mode æ˜¯ MUTUALï¼Œåˆ™ä¸ºå¿…éœ€å­—æ®µã€‚åŒ…å«è¯ä¹¦é¢å‘æœºæ„è¯ä¹¦çš„æ–‡ä»¶çš„è·¯å¾„ï¼Œç”¨äºéªŒè¯æä¾›çš„å®¢æˆ·ç«¯è¯ä¹¦</td></tr><tr><td>credentialName</td><td>å¯¹äºåœ¨ Kubernetes ä¸Šè¿è¡Œçš„ç½‘å…³ï¼ŒåŒ…å« TLS è¯ä¹¦ï¼ˆåŒ…æ‹¬ CA è¯ä¹¦ï¼‰çš„å¯†é’¥çš„åç§°ã€‚ä»…é€‚ç”¨äº Kubernetesã€‚å¯†é’¥ï¼ˆé€šç”¨ç±»å‹ï¼‰åº”åŒ…å«ä»¥ä¸‹é”®å’Œå€¼ï¼šé”®ï¼š&lt;privateKey&gt; å’Œè¯ä¹¦ï¼š&lt;serverCert&gt;ã€‚å¯¹äºåŒå‘ TLSï¼Œcacert: &lt;CACertificate&gt; å¯ä»¥åœ¨åŒä¸€ä¸ªå¯†é’¥æˆ–åä¸º &lt;secret&gt;-cacert çš„å•ç‹¬å¯†é’¥ä¸­æä¾›ã€‚è¿˜æ”¯æŒç”¨äºæœåŠ¡å™¨è¯ä¹¦çš„ tls ç±»å‹çš„å¯†é’¥ä»¥åŠç”¨äº CA è¯ä¹¦çš„ ca.crt å¯†é’¥ã€‚åªèƒ½æŒ‡å®šæœåŠ¡å™¨è¯ä¹¦å’Œ CA è¯ä¹¦æˆ– credentialName ä¹‹ä¸€</td></tr><tr><td>subjectAltNames</td><td>ç”¨äºéªŒè¯å®¢æˆ·ç«¯æä¾›çš„è¯ä¹¦ä¸­çš„ä¸»ä½“èº«ä»½çš„å¤‡ç”¨åç§°åˆ—è¡¨</td></tr><tr><td>verifyCertificateSpki</td><td>æˆæƒå®¢æˆ·ç«¯è¯ä¹¦çš„ SKPI çš„ base64 ç¼–ç  SHA-256 å“ˆå¸Œçš„å¯é€‰åˆ—è¡¨ã€‚æ³¨æ„ï¼šå½“åŒæ—¶æŒ‡å®š verify_certificate_hash å’Œ verify_certificate_spki æ—¶ï¼ŒåŒ¹é…ä»»ä¸€å€¼çš„å“ˆå¸Œå°†å¯¼è‡´è¯ä¹¦è¢«æ¥å—</td></tr><tr><td>verifyCertificateHash</td><td>æˆæƒå®¢æˆ·ç«¯è¯ä¹¦çš„åå…­è¿›åˆ¶ç¼–ç  SHA-256 å“ˆå¸Œçš„å¯é€‰åˆ—è¡¨ã€‚ç®€å•æ ¼å¼å’Œå†’å·åˆ†éš”æ ¼å¼éƒ½å¯ä»¥æ¥å—ã€‚æ³¨æ„ï¼šå½“åŒæ—¶æŒ‡å®š verify_certificate_hash å’Œ verify_certificate_spki æ—¶ï¼ŒåŒ¹é…ä»»ä¸€å€¼çš„å“ˆå¸Œå°†å¯¼è‡´è¯ä¹¦è¢«æ¥å—</td></tr><tr><td><a href="#ServerTLSSettings.TLSProtocol">minProtocolVersion</a></td><td>æœ€ä½ TLS åè®®ç‰ˆæœ¬</td></tr><tr><td><a href="#ServerTLSSettings.TLSProtocol">maxProtocolVersion</a></td><td>æœ€é«˜ TLS åè®®ç‰ˆæœ¬</td></tr><tr><td>cipherSuites</td><td>å¦‚æœæŒ‡å®šï¼Œåªæ”¯æŒæŒ‡å®šçš„å¯†ç åˆ—è¡¨ã€‚å¦åˆ™é»˜è®¤ä¸º Envoy æ”¯æŒçš„é»˜è®¤å¯†ç åˆ—è¡¨</td></tr></tbody></table><h1 id="ServerTLSSettings-TLSmode"><a href="#ServerTLSSettings-TLSmode" class="headerlink" title="ServerTLSSettings.TLSmode"></a><a name="ServerTLSSettings.TLSmode">ServerTLSSettings.TLSmode</a></h1><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>PASSTHROUGH</td><td>å®¢æˆ·ç«¯æä¾›çš„ SNI å­—ç¬¦ä¸²å°†ç”¨ä½œ VirtualService TLS è·¯ç”±ä¸­çš„åŒ¹é…æ ‡å‡†ï¼Œä»¥ç¡®å®šæœåŠ¡æ³¨å†Œè¡¨ä¸­çš„ç›®æ ‡æœåŠ¡</td></tr><tr><td>SIMPLE</td><td>ä½¿ç”¨æ ‡å‡† TLS è¯­ä¹‰çš„å®‰å…¨è¿æ¥</td></tr><tr><td>MUTUAL</td><td>é€šè¿‡æä¾›æœåŠ¡å™¨è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä½¿ç”¨åŒå‘ TLS ä¿æŠ¤ä¸ä¸‹æ¸¸çš„è¿æ¥</td></tr><tr><td>AUTO_PASSTHROUGH</td><td>ä¸ç›´é€šæ¨¡å¼ç±»ä¼¼ï¼Œé™¤äº†å…·æœ‰æ­¤ TLS æ¨¡å¼çš„æœåŠ¡å™¨ä¸éœ€è¦å…³è”çš„ VirtualService ä» SNI å€¼æ˜ å°„åˆ°æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ã€‚è¯¸å¦‚æœåŠ¡&#x2F;å­é›†&#x2F;ç«¯å£ä¹‹ç±»çš„ç›®æ ‡è¯¦ç»†ä¿¡æ¯åœ¨ SNI å€¼ä¸­è¿›è¡Œç¼–ç ã€‚ä»£ç†å°†è½¬å‘åˆ° SNI å€¼æŒ‡å®šçš„ä¸Šæ¸¸ï¼ˆEnvoyï¼‰é›†ç¾¤ï¼ˆä¸€ç»„ç«¯ç‚¹ï¼‰ã€‚æ­¤æœåŠ¡å™¨é€šå¸¸ç”¨äºåœ¨ä¸åŒçš„ L3 ç½‘ç»œä¸­æä¾›æœåŠ¡ä¹‹é—´çš„è¿æ¥ï¼Œå¦åˆ™å®ƒä»¬å„è‡ªçš„ç«¯ç‚¹ä¹‹é—´æ²¡æœ‰ç›´æ¥è¿æ¥ã€‚ä½¿ç”¨æ­¤æ¨¡å¼å‡å®šæºå’Œç›®æ ‡éƒ½ä½¿ç”¨ Istio mTLS æ¥ä¿æŠ¤æµé‡</td></tr><tr><td>ISTIO_MUTUAL</td><td>é€šè¿‡æä¾›æœåŠ¡å™¨è¯ä¹¦è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä½¿ç”¨åŒå‘ TLS ä¿æŠ¤æ¥è‡ªä¸‹æ¸¸çš„è¿æ¥ã€‚ä¸ Mutual æ¨¡å¼ç›¸æ¯”ï¼Œè¯¥æ¨¡å¼ä½¿ç”¨ Istio è‡ªåŠ¨ç”Ÿæˆçš„ä»£è¡¨ç½‘å…³å·¥ä½œè´Ÿè½½èº«ä»½çš„è¯ä¹¦è¿›è¡Œ mTLS èº«ä»½éªŒè¯ã€‚ä½¿ç”¨æ­¤æ¨¡å¼æ—¶ï¼ŒTLSOptions ä¸­çš„æ‰€æœ‰å…¶ä»–å­—æ®µéƒ½åº”ä¸ºç©º</td></tr></tbody></table><h1 id="ServerTLSSettings-TLSProtocol"><a href="#ServerTLSSettings-TLSProtocol" class="headerlink" title="ServerTLSSettings.TLSProtocol"></a><a name="ServerTLSSettings.TLSProtocol">ServerTLSSettings.TLSProtocol</a></h1><table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>TLS_AUTO</td><td>è‡ªåŠ¨é€‰æ‹©æœ€ä½³ TLS ç‰ˆæœ¬</td></tr><tr><td>TLSV1_0</td><td>TLS 1.0 ç‰ˆæœ¬</td></tr><tr><td>TLSV1_1</td><td>TLS 1.1 ç‰ˆæœ¬</td></tr><tr><td>TLSV1_2</td><td>TLS 1.2 ç‰ˆæœ¬</td></tr><tr><td>TLSV1_3</td><td>TLS 1.3 ç‰ˆæœ¬</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†åœºæ™¯ä¸‹çš„ Gateway èµ„æºå¯¹è±¡ä½¿ç”¨èŒƒä¾‹ä¸ API ç»“æ„æ¦‚è§ˆ</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” æ•´ä½“æ¦‚è¿°</title>
    <link href="http://shenxianghong.github.io/2022/07/04/2022-07-04%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20%E6%95%B4%E4%BD%93%E6%A6%82%E8%BF%B0/"/>
    <id>http://shenxianghong.github.io/2022/07/04/2022-07-04%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20%E6%95%B4%E4%BD%93%E6%A6%82%E8%BF%B0/</id>
    <published>2022-07-03T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.172Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><p>Istio çš„æµé‡è·¯ç”±è§„åˆ™å¯ä»¥å¾ˆå®¹æ˜“çš„æ§åˆ¶æœåŠ¡ä¹‹é—´çš„æµé‡å’Œ API è°ƒç”¨ã€‚Istio ç®€åŒ–äº†æœåŠ¡çº§åˆ«å±æ€§çš„é…ç½®ï¼Œæ¯”å¦‚ç†”æ–­å™¨ã€è¶…æ—¶å’Œé‡è¯•ï¼Œå¹¶ä¸”èƒ½è½»æ¾çš„è®¾ç½®é‡è¦çš„ä»»åŠ¡ï¼Œå¦‚ A&#x2F;B æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒã€åŸºäºæµé‡ç™¾åˆ†æ¯”åˆ‡åˆ†çš„æ¦‚ç‡å‘å¸ƒç­‰ã€‚å®ƒè¿˜æä¾›äº†å¼€ç®±å³ç”¨çš„æ•…éšœæ¢å¤ç‰¹æ€§ï¼Œæœ‰åŠ©äºå¢å¼ºåº”ç”¨çš„å¥å£®æ€§ï¼Œä»è€Œæ›´å¥½åœ°åº”å¯¹è¢«ä¾èµ–çš„æœåŠ¡æˆ–ç½‘ç»œå‘ç”Ÿæ•…éšœçš„æƒ…å†µã€‚</p><p>Istio çš„æµé‡ç®¡ç†æ¨¡å‹æºäºå’ŒæœåŠ¡ä¸€èµ·éƒ¨ç½²çš„ Envoy ä»£ç†ã€‚ç½‘æ ¼å†…æœåŠ¡å‘é€å’Œæ¥æ”¶çš„æ‰€æœ‰æµé‡ï¼ˆdata plane æµé‡ï¼‰éƒ½ç»ç”± Envoy ä»£ç†ï¼Œè¿™è®©æ§åˆ¶ç½‘æ ¼å†…çš„æµé‡å˜å¾—å¼‚å¸¸ç®€å•ï¼Œè€Œä¸”ä¸éœ€è¦å¯¹æœåŠ¡åšä»»ä½•çš„æ›´æ”¹ã€‚</p><h1 id="æ•´ä½“æ¦‚è¿°"><a href="#æ•´ä½“æ¦‚è¿°" class="headerlink" title="æ•´ä½“æ¦‚è¿°"></a>æ•´ä½“æ¦‚è¿°</h1><p>ä¸ºäº†åœ¨ç½‘æ ¼ä¸­å¯¼æµï¼ŒIstio éœ€è¦çŸ¥é“æ‰€æœ‰çš„ endpoint åœ¨å“ªå’Œå±äºå“ªä¸ªæœåŠ¡ã€‚ä¸ºäº†å®šä½åˆ° Service Registryï¼ˆæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼‰ï¼ŒIstio ä¼šè¿æ¥åˆ°ä¸€ä¸ªæœåŠ¡å‘ç°ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨ Kubernetes é›†ç¾¤ä¸Šå®‰è£…äº† Istioï¼Œé‚£ä¹ˆå®ƒå°†è‡ªåŠ¨æ£€æµ‹è¯¥é›†ç¾¤ä¸­çš„æœåŠ¡å’Œ endpointã€‚</p><p>ä½¿ç”¨æ­¤æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ŒEnvoy ä»£ç†å¯ä»¥å°†æµé‡å®šå‘åˆ°ç›¸å…³æœåŠ¡ã€‚å¤§å¤šæ•°åŸºäºå¾®æœåŠ¡çš„åº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªæœåŠ¡çš„å·¥ä½œè´Ÿè½½éƒ½æœ‰å¤šä¸ªå®ä¾‹æ¥å¤„ç†æµé‡ï¼Œç§°ä¸ºè´Ÿè½½å‡è¡¡æ± ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒEnvoy ä»£ç†åŸºäºè½®è¯¢è°ƒåº¦æ¨¡å‹åœ¨æœåŠ¡çš„è´Ÿè½½å‡è¡¡æ± å†…åˆ†å‘æµé‡ï¼ŒæŒ‰é¡ºåºå°†è¯·æ±‚å‘é€ç»™æ± ä¸­æ¯ä¸ªæˆå‘˜ï¼Œä¸€æ—¦æ‰€æœ‰æœåŠ¡å®ä¾‹å‡æ¥æ”¶è¿‡ä¸€æ¬¡è¯·æ±‚åï¼Œé‡æ–°å›åˆ°ç¬¬ä¸€ä¸ªæ± æˆå‘˜ã€‚</p><p>Istio åŸºæœ¬çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡èƒ½åŠ›æä¾›äº†ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡ç½‘æ ¼ï¼Œä½†å®ƒèƒ½åšåˆ°çš„è¿œæ¯”è¿™å¤šçš„å¤šã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œå¯èƒ½å¸Œæœ›å¯¹ç½‘æ ¼çš„æµé‡æƒ…å†µè¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚ä½œä¸º A&#x2F;B æµ‹è¯•çš„ä¸€éƒ¨åˆ†ï¼Œå¯èƒ½æƒ³å°†ç‰¹å®šç™¾åˆ†æ¯”çš„æµé‡å®šå‘åˆ°æ–°ç‰ˆæœ¬çš„æœåŠ¡ï¼Œæˆ–è€…ä¸ºç‰¹å®šçš„æœåŠ¡å®ä¾‹å­é›†åº”ç”¨ä¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚å¯èƒ½è¿˜æƒ³å¯¹è¿›å‡ºç½‘æ ¼çš„æµé‡åº”ç”¨ç‰¹æ®Šçš„è§„åˆ™ï¼Œæˆ–è€…å°†ç½‘æ ¼çš„å¤–éƒ¨ä¾èµ–é¡¹æ·»åŠ åˆ°æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚é€šè¿‡ä½¿ç”¨ Istio çš„æµé‡ç®¡ç† API å°†æµé‡é…ç½®æ·»åŠ åˆ° Istioï¼Œå°±å¯ä»¥å®Œæˆæ‰€æœ‰è¿™äº›ç”šè‡³æ›´å¤šçš„å·¥ä½œã€‚</p><p>å’Œå…¶ä»– Istio é…ç½®ä¸€æ ·ï¼Œè¿™äº› API ä¹Ÿä½¿ç”¨ Kubernetes CRD æ¥å£°æ˜ï¼Œå¯ä»¥åƒç¤ºä¾‹ä¸­çœ‹åˆ°çš„é‚£æ ·ä½¿ç”¨ YAML è¿›è¡Œé…ç½®ã€‚</p><p>æ ¸å¿ƒ API åŒ…æ‹¬ï¼šVirtual Servicesï¼ŒDestination Rulesï¼ŒGatewaysï¼ŒService Entries å’Œ Sidecarsã€‚</p><h1 id="Virtual-Service"><a href="#Virtual-Service" class="headerlink" title="Virtual Service"></a>Virtual Service</h1><p>Virtual Service å’Œ Destination Rule æ˜¯ Istio æµé‡è·¯ç”±åŠŸèƒ½çš„å…³é”®æ‹¼å›¾ã€‚Virtual Service é…ç½®å¦‚ä½•åœ¨æœåŠ¡ç½‘æ ¼å†…å°†è¯·æ±‚è·¯ç”±åˆ°æœåŠ¡ï¼Œè¿™åŸºäº Istio å’Œå¹³å°æä¾›çš„åŸºæœ¬çš„è¿é€šæ€§å’ŒæœåŠ¡å‘ç°èƒ½åŠ›ã€‚æ¯ä¸ª Virtual Service åŒ…å«ä¸€ç»„è·¯ç”±è§„åˆ™ï¼ŒIstio æŒ‰é¡ºåºè¯„ä¼°å®ƒä»¬ï¼ŒIstio å°†æ¯ä¸ªç»™å®šçš„è¯·æ±‚åŒ¹é…åˆ° Virtual Service æŒ‡å®šçš„å®é™…ç›®æ ‡åœ°å€ã€‚ç½‘æ ¼å¯ä»¥æœ‰å¤šä¸ª Virtual Serviceï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ï¼Œå–å†³äºä½¿ç”¨åœºæ™¯ã€‚</p><h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-Virtual-Service"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨-Virtual-Service" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Virtual Service"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Virtual Service</h2><p>Virtual Service åœ¨å¢å¼º Istio æµé‡ç®¡ç†çš„çµæ´»æ€§å’Œæœ‰æ•ˆæ€§æ–¹é¢ï¼Œå‘æŒ¥ç€è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œé€šè¿‡å¯¹å®¢æˆ·ç«¯è¯·æ±‚çš„ç›®æ ‡åœ°å€ä¸çœŸå®å“åº”è¯·æ±‚çš„ç›®æ ‡å·¥ä½œè´Ÿè½½è¿›è¡Œè§£è€¦æ¥å®ç°ã€‚Virtual Service åŒæ—¶æä¾›äº†ä¸°å¯Œçš„æ–¹å¼ï¼Œä¸ºå‘é€è‡³è¿™äº›å·¥ä½œè´Ÿè½½çš„æµé‡æŒ‡å®šä¸åŒçš„è·¯ç”±è§„åˆ™ã€‚</p><p>å¦‚æœæ²¡æœ‰ Virtual Serviceï¼ŒEnvoy ä¼šåœ¨æ‰€æœ‰çš„æœåŠ¡å®ä¾‹ä¸­ä½¿ç”¨è½®è¯¢çš„è´Ÿè½½å‡è¡¡ç­–ç•¥åˆ†å‘è¯·æ±‚ï¼Œè€Œæœ‰äº›åœºæ™¯ä¸‹æœ‰ç€ä¸åŒçš„åˆ†å‘éœ€æ±‚ã€‚ä¾‹å¦‚ï¼Œæœ‰äº›å¯èƒ½ä»£è¡¨ä¸åŒçš„ç‰ˆæœ¬ï¼ˆA&#x2F;B æµ‹è¯•ï¼‰ï¼Œå¸Œæœ›åœ¨å…¶ä¸­é…ç½®åŸºäºä¸åŒæœåŠ¡ç‰ˆæœ¬çš„æµé‡ç™¾åˆ†æ¯”è·¯ç”±ï¼Œæˆ–è€…è·¯ç”±å†…éƒ¨ç”¨æˆ·åˆ°ç‰¹å®šå®ä¾‹é›†çš„æµé‡ã€‚</p><p>ä½¿ç”¨ Virtual Serviceï¼Œå¯ä»¥ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªä¸»æœºåæŒ‡å®šæµé‡è¡Œä¸ºã€‚åœ¨ Virtual Service ä¸­ä½¿ç”¨è·¯ç”±è§„åˆ™ï¼Œå‘Šè¯‰ Envoy å¦‚ä½•å‘é€ Virtual Service çš„æµé‡åˆ°é€‚å½“çš„ç›®æ ‡ã€‚è·¯ç”±ç›®æ ‡åœ°å€å¯ä»¥æ˜¯åŒä¸€æœåŠ¡çš„ä¸åŒç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥æ˜¯å®Œå…¨ä¸åŒçš„æœåŠ¡ã€‚</p><p>ä¸€ä¸ªå…¸å‹çš„ç”¨ä¾‹æ˜¯å°†æµé‡å‘é€åˆ°æŒ‡å®šæœåŠ¡å­é›†çš„ä¸åŒç‰ˆæœ¬ã€‚å®¢æˆ·ç«¯å°† Virtual Service è§†ä¸ºä¸€ä¸ªå•ä¸€å®ä½“ï¼Œå°†è¯·æ±‚å‘é€è‡³  Virtual Service ä¸»æœºï¼Œç„¶å Envoy æ ¹æ® Virtual Service è§„åˆ™æŠŠæµé‡è·¯ç”±åˆ°ä¸åŒçš„ç‰ˆæœ¬ã€‚ä¾‹å¦‚ï¼Œå°† 20% çš„è°ƒç”¨è½¬åˆ°æ–°ç‰ˆæœ¬æˆ–è€…å°†è¿™äº›ç”¨æˆ·çš„è°ƒç”¨è½¬åˆ°ç‰ˆæœ¬ 2ã€‚ä¾‹å¦‚ï¼Œåˆ›å»ºä¸€ä¸ªé‡‘ä¸é›€å‘å¸ƒï¼Œé€æ­¥å¢åŠ å‘é€åˆ°æ–°ç‰ˆæœ¬æœåŠ¡çš„æµé‡ç™¾åˆ†æ¯”ã€‚æµé‡è·¯ç”±å®Œå…¨ç‹¬ç«‹äºå®ä¾‹éƒ¨ç½²ï¼Œè¿™æ„å‘³ç€å®ç°æ–°ç‰ˆæœ¬æœåŠ¡çš„å®ä¾‹å¯ä»¥æ ¹æ®æµé‡çš„è´Ÿè½½æ¥ä¼¸ç¼©ï¼Œå®Œå…¨ä¸å½±å“æµé‡è·¯ç”±ã€‚</p><p>Virtual Service å¯ä»¥</p><ul><li>é€šè¿‡å•ä¸ª Virtual Service å¤„ç†å¤šä¸ªåº”ç”¨ç¨‹åºæœåŠ¡ã€‚å¦‚æœç½‘æ ¼ä½¿ç”¨ Kubernetesï¼Œå¯ä»¥é…ç½®ä¸€ä¸ª Virtual Service å¤„ç†ç‰¹å®šå‘½åç©ºé—´ä¸­çš„æ‰€æœ‰æœåŠ¡ã€‚æ˜ å°„å•ä¸€çš„ Virtual Service åˆ°å¤šä¸ªçœŸå® Serviceï¼Œå¯ä»¥åœ¨ä¸éœ€è¦å®¢æˆ·é€‚åº”è½¬æ¢çš„æƒ…å†µä¸‹ï¼Œå°†å•ä½“åº”ç”¨è½¬æ¢ä¸ºå¾®æœåŠ¡æ„å»ºçš„å¤åˆåº”ç”¨ç³»ç»Ÿ</li><li>å’Œ Gateway æ•´åˆå¹¶é…ç½®æµé‡è§„åˆ™æ¥æ§åˆ¶å‡ºå…¥æµé‡</li></ul><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿˜éœ€è¦é…ç½® Destination Ruleï¼ˆç”¨äºæŒ‡å®šæœåŠ¡å­é›†ï¼‰æ¥ä½¿ç”¨è¿™äº›ç‰¹æ€§ã€‚åœ¨ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ä¸­æŒ‡å®šæœåŠ¡å­é›†å’Œå…¶å®ƒç‰¹å®šç›®æ ‡ç­–ç•¥ï¼Œæœ‰åˆ©äºåœ¨ Virtual Service ä¹‹é—´æ›´ç®€æ´åœ°é‡ç”¨è¿™äº›è§„åˆ™ã€‚</p><h2 id="Virtual-Service-ç¤ºä¾‹"><a href="#Virtual-Service-ç¤ºä¾‹" class="headerlink" title="Virtual Service ç¤ºä¾‹"></a>Virtual Service ç¤ºä¾‹</h2><p>ä¸‹é¢çš„ Virtual Service æ ¹æ®è¯·æ±‚æ˜¯å¦æ¥è‡ªç‰¹å®šçš„ç”¨æˆ·ï¼ŒæŠŠå®ƒä»¬è·¯ç”±åˆ°æœåŠ¡çš„ä¸åŒç‰ˆæœ¬ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">end-user:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">jason</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure><h3 id="hosts"><a href="#hosts" class="headerlink" title="hosts"></a>hosts</h3><p>ä½¿ç”¨ hosts å­—æ®µåˆ—ä¸¾ Virtual Service çš„ä¸»æœºâ€”â€”å³ç”¨æˆ·æŒ‡å®šçš„ç›®æ ‡æˆ–æ˜¯è·¯ç”±è§„åˆ™è®¾å®šçš„ç›®æ ‡ã€‚è¿™æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å‘é€è¯·æ±‚æ—¶ä½¿ç”¨çš„ä¸€ä¸ªæˆ–å¤šä¸ªåœ°å€ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">reviews</span></span><br></pre></td></tr></table></figure><p>Virtual Service ä¸»æœºåå¯ä»¥æ˜¯ IP åœ°å€ã€DNS åç§°ï¼Œæˆ–è€…ä¾èµ–äºå¹³å°çš„ä¸€ä¸ªç®€ç§°ï¼ˆä¾‹å¦‚ Kubernetes æœåŠ¡çš„çŸ­åç§°ï¼‰ï¼Œéšå¼æˆ–æ˜¾å¼åœ°æŒ‡å‘ä¸€ä¸ªå®Œå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ï¼ˆâ€œ*â€ï¼‰å‰ç¼€ï¼Œåˆ›å»ºä¸€ç»„åŒ¹é…æ‰€æœ‰æœåŠ¡çš„è·¯ç”±è§„åˆ™ã€‚Virtual Service çš„ hosts å­—æ®µå®é™…ä¸Šä¸å¿…æ˜¯ Istio æœåŠ¡æ³¨å†Œçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒåªæ˜¯è™šæ‹Ÿçš„ç›®æ ‡åœ°å€ã€‚å¯ä»¥ä¸ºæ²¡æœ‰è·¯ç”±åˆ°ç½‘æ ¼å†…éƒ¨çš„è™šæ‹Ÿä¸»æœºå»ºæ¨¡ã€‚</p><h3 id="è·¯ç”±è§„åˆ™"><a href="#è·¯ç”±è§„åˆ™" class="headerlink" title="è·¯ç”±è§„åˆ™"></a>è·¯ç”±è§„åˆ™</h3><p>åœ¨ http å­—æ®µåŒ…å«äº† Virtual Service çš„è·¯ç”±è§„åˆ™ï¼Œç”¨æ¥æè¿°åŒ¹é…æ¡ä»¶å’Œè·¯ç”±è¡Œä¸ºï¼Œå®ƒä»¬æŠŠ HTTP&#x2F;1.1ã€HTTP2 å’Œ gRPC ç­‰æµé‡å‘é€åˆ° hosts å­—æ®µæŒ‡å®šçš„ç›®æ ‡ï¼ˆä¹Ÿå¯ä»¥ç”¨ tcp å’Œ tls ä¸º TCP å’Œæœªç»ˆæ­¢çš„ TLS æµé‡è®¾ç½®è·¯ç”±è§„åˆ™ï¼‰ã€‚ä¸€ä¸ªè·¯ç”±è§„åˆ™åŒ…å«äº†æŒ‡å®šçš„è¯·æ±‚è¦æµå‘å“ªä¸ªç›®æ ‡åœ°å€ï¼Œå…·æœ‰ 0 æˆ–å¤šä¸ªåŒ¹é…æ¡ä»¶ï¼Œå–å†³äºä½¿ç”¨åœºæ™¯ã€‚</p><h4 id="åŒ¹é…æ¡ä»¶"><a href="#åŒ¹é…æ¡ä»¶" class="headerlink" title="åŒ¹é…æ¡ä»¶"></a>åŒ¹é…æ¡ä»¶</h4><p>ç¤ºä¾‹ä¸­çš„ç¬¬ä¸€ä¸ªè·¯ç”±è§„åˆ™æœ‰ä¸€ä¸ªæ¡ä»¶ï¼Œå› æ­¤ä»¥ match å­—æ®µå¼€å§‹ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œå¸Œæœ›æ­¤è·¯ç”±åº”ç”¨äºæ¥è‡ª jason ç”¨æˆ·çš„æ‰€æœ‰è¯·æ±‚ï¼Œæ‰€ä»¥ä½¿ç”¨ headersã€end-user å’Œ exact å­—æ®µåŒ¹é…ç›¸å…³è¯·æ±‚ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">       <span class="attr">end-user:</span></span><br><span class="line">         <span class="attr">exact:</span> <span class="string">jason</span></span><br></pre></td></tr></table></figure><h4 id="ç›®çš„åœ°"><a href="#ç›®çš„åœ°" class="headerlink" title="ç›®çš„åœ°"></a>ç›®çš„åœ°</h4><p>route éƒ¨åˆ†çš„ destination å­—æ®µæŒ‡å®šäº†ç¬¦åˆæ­¤æ¡ä»¶çš„æµé‡çš„å®é™…ç›®æ ‡åœ°å€ã€‚ä¸ Virtual Service çš„ hosts ä¸åŒï¼Œdestination çš„ host å¿…é¡»æ˜¯å­˜åœ¨äº Istio æœåŠ¡æ³¨å†Œä¸­å¿ƒçš„å®é™…ç›®æ ‡åœ°å€ï¼Œå¦åˆ™ Envoy ä¸çŸ¥é“è¯¥å°†è¯·æ±‚å‘é€åˆ°å“ªé‡Œã€‚å¯ä»¥æ˜¯ä¸€ä¸ªæœ‰ä»£ç†çš„æœåŠ¡ç½‘æ ¼ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªé€šè¿‡ Service Entry è¢«æ·»åŠ è¿›æ¥çš„éç½‘æ ¼æœåŠ¡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">route:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">    <span class="attr">subset:</span> <span class="string">v2</span></span><br></pre></td></tr></table></figure><p>åœ¨ç¤ºä¾‹ä¸­ï¼Œä¸ºäº†ç®€å•ï¼Œä½¿ç”¨ Kubernetes çš„çŸ­åç§°è®¾ç½® destination çš„ hostã€‚åœ¨è¯„ä¼°æ­¤è§„åˆ™æ—¶ï¼ŒIstio ä¼šæ·»åŠ ä¸€ä¸ªåŸºäº Virtual Service å‘½åç©ºé—´çš„åŸŸåç¼€ï¼Œè¿™ä¸ª Virtual Service åŒ…å«è¦è·å–ä¸»æœºçš„å®Œå…¨é™å®šåçš„è·¯ç”±è§„åˆ™ã€‚åœ¨ç¤ºä¾‹ä¸­ä½¿ç”¨çŸ­åç§°ä¹Ÿæ„å‘³ç€å¯ä»¥å¤åˆ¶å¹¶åœ¨ä»»ä½•å‘½åç©ºé—´ä¸­å°è¯•å®ƒä»¬ã€‚</p><p><em>åªæœ‰åœ¨ç›®æ ‡ä¸»æœºå’Œ Virtual Service ä½äºç›¸åŒçš„ Kubernetes å‘½åç©ºé—´æ—¶æ‰å¯ä»¥ä½¿ç”¨è¿™æ ·çš„çŸ­åç§°ã€‚å› ä¸ºä½¿ç”¨ Kubernetes çš„çŸ­åç§°å®¹æ˜“å¯¼è‡´é…ç½®å‡ºé”™ï¼Œå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æŒ‡å®šå®Œå…¨é™å®šçš„ä¸»æœºå</em></p><p>destination è¿˜æŒ‡å®šäº† Kubernetes æœåŠ¡çš„å­é›†ï¼Œå°†ç¬¦åˆæ­¤è§„åˆ™æ¡ä»¶çš„è¯·æ±‚è½¬å…¥å…¶ä¸­ã€‚åœ¨æœ¬ä¾‹ä¸­å­é›†åç§°æ˜¯ v2ã€‚</p><h4 id="è·¯ç”±è§„åˆ™ä¼˜å…ˆçº§"><a href="#è·¯ç”±è§„åˆ™ä¼˜å…ˆçº§" class="headerlink" title="è·¯ç”±è§„åˆ™ä¼˜å…ˆçº§"></a>è·¯ç”±è§„åˆ™ä¼˜å…ˆçº§</h4><p>è·¯ç”±è§„åˆ™æŒ‰ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºé€‰æ‹©ï¼ŒVirtual Service ä¸­å®šä¹‰çš„ç¬¬ä¸€æ¡è§„åˆ™æœ‰æœ€é«˜ä¼˜å…ˆçº§ã€‚æœ¬ç¤ºä¾‹ä¸­ï¼Œä¸æ»¡è¶³ç¬¬ä¸€ä¸ªè·¯ç”±è§„åˆ™çš„æµé‡å‡æµå‘ä¸€ä¸ªé»˜è®¤çš„ç›®æ ‡ï¼ˆå³ v2 å­é›†ï¼‰ï¼Œè¯¥ç›®æ ‡åœ¨ç¬¬äºŒæ¡è§„åˆ™ä¸­æŒ‡å®šã€‚å› æ­¤ï¼Œç¬¬äºŒæ¡è§„åˆ™æ²¡æœ‰ match æ¡ä»¶ï¼Œç›´æ¥å°†æµé‡å¯¼å‘ v3 å­é›†ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">      <span class="attr">subset:</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure><p>å»ºè®®æä¾›ä¸€ä¸ªé»˜è®¤çš„â€æ— æ¡ä»¶â€æˆ–åŸºäºæƒé‡çš„è§„åˆ™ä½œä¸ºæ¯ä¸€ä¸ª Virtual Service çš„æœ€åä¸€æ¡è§„åˆ™ï¼Œä»è€Œç¡®ä¿æµç» Virtual Service çš„æµé‡è‡³å°‘èƒ½å¤ŸåŒ¹é…ä¸€æ¡è·¯ç”±è§„åˆ™ã€‚</p><h3 id="è·¯ç”±è§„åˆ™çš„æ›´å¤šå†…å®¹"><a href="#è·¯ç”±è§„åˆ™çš„æ›´å¤šå†…å®¹" class="headerlink" title="è·¯ç”±è§„åˆ™çš„æ›´å¤šå†…å®¹"></a>è·¯ç”±è§„åˆ™çš„æ›´å¤šå†…å®¹</h3><p>è·¯ç”±è§„åˆ™æ˜¯å°†ç‰¹å®šæµé‡å­é›†è·¯ç”±åˆ°æŒ‡å®šç›®æ ‡åœ°å€çš„å¼ºå¤§å·¥å…·ã€‚å¯ä»¥åœ¨æµé‡ç«¯å£ã€header å­—æ®µã€URI ç­‰å†…å®¹ä¸Šè®¾ç½®åŒ¹é…æ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œè¿™ä¸ª Virtual Service è®©ç”¨æˆ·å‘é€è¯·æ±‚åˆ°ä¸¤ä¸ªç‹¬ç«‹çš„æœåŠ¡ï¼šratings å’Œ reviewsã€‚Virtual Service è§„åˆ™æ ¹æ®è¯·æ±‚çš„ URI å’ŒæŒ‡å‘é€‚å½“æœåŠ¡çš„è¯·æ±‚åŒ¹é…æµé‡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bookinfo.com</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/reviews</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/ratings</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="attr">sourceLabels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">reviews</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure><p>æœ‰äº›åŒ¹é…æ¡ä»¶å¯ä»¥ä½¿ç”¨ç²¾ç¡®çš„å€¼ï¼Œå¦‚å‰ç¼€æˆ–æ­£åˆ™ã€‚</p><p>å¯ä»¥ä½¿ç”¨ AND å‘åŒä¸€ä¸ª match å—æ·»åŠ å¤šä¸ªåŒ¹é…æ¡ä»¶ï¼Œæˆ–è€…ä½¿ç”¨ OR å‘åŒä¸€ä¸ªè§„åˆ™æ·»åŠ å¤šä¸ª match å—ã€‚å¯¹äºä»»ä½•ç»™å®šçš„ Virtual Service ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªè·¯ç”±è§„åˆ™ã€‚</p><p>å¦å¤–ï¼Œä½¿ç”¨åŒ¹é…æ¡ä»¶å¯ä»¥æŒ‰ç™¾åˆ†æ¯”â€æƒé‡â€œåˆ†å‘è¯·æ±‚ã€‚è¿™åœ¨ A&#x2F;B æµ‹è¯•å’Œé‡‘ä¸é›€å‘å¸ƒä¸­éå¸¸æœ‰ç”¨ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">75</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">25</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨è·¯ç”±è§„åˆ™åœ¨æµé‡ä¸Šæ‰§è¡Œä¸€äº›æ“ä½œï¼Œä¾‹å¦‚ï¼š</p><ul><li>æ·»åŠ æˆ–åˆ é™¤ header</li><li>é‡å†™ URL</li><li>ä¸ºè°ƒç”¨è¿™ä¸€ç›®æ ‡åœ°å€çš„è¯·æ±‚è®¾ç½®é‡è¯•ç­–ç•¥</li></ul><h1 id="Destination-Rule"><a href="#Destination-Rule" class="headerlink" title="Destination Rule"></a>Destination Rule</h1><p>ä¸ Virtual Service ä¸€æ ·ï¼ŒDestination Rule ä¹Ÿæ˜¯ Istio æµé‡è·¯ç”±åŠŸèƒ½çš„å…³é”®éƒ¨åˆ†ã€‚å¯ä»¥å°† Virtual Service è§†ä¸ºå°†æµé‡å¦‚ä½•è·¯ç”±åˆ°ç»™å®šç›®æ ‡åœ°å€ï¼Œç„¶åä½¿ç”¨ Destination Rule æ¥é…ç½®è¯¥ç›®æ ‡çš„æµé‡ã€‚åœ¨è¯„ä¼° Virtual Service è·¯ç”±è§„åˆ™ä¹‹åï¼ŒDestination Rule å°†åº”ç”¨äºæµé‡çš„çœŸå®ç›®æ ‡åœ°å€ã€‚</p><p>å¯ä»¥ä½¿ç”¨ Destination Rule æ¥æŒ‡å®šå‘½åçš„æœåŠ¡å­é›†ï¼Œä¾‹å¦‚æŒ‰ç‰ˆæœ¬ä¸ºæ‰€æœ‰ç»™å®šæœåŠ¡çš„å®ä¾‹åˆ†ç»„ã€‚ç„¶åå¯ä»¥åœ¨ Virtual Service çš„è·¯ç”±è§„åˆ™ä¸­ä½¿ç”¨è¿™äº›æœåŠ¡å­é›†æ¥æ§åˆ¶åˆ°æœåŠ¡ä¸åŒå®ä¾‹çš„æµé‡ã€‚</p><p>Destination Rule è¿˜å…è®¸åœ¨è°ƒç”¨æ•´ä¸ªç›®çš„åœ°æœåŠ¡æˆ–ç‰¹å®šæœåŠ¡å­é›†æ—¶å®šåˆ¶ Envoy çš„æµé‡ç­–ç•¥ï¼Œæ¯”å¦‚è´Ÿè½½å‡è¡¡æ¨¡å‹ã€TLS å®‰å…¨æ¨¡å¼æˆ–ç†”æ–­å™¨è®¾ç½®ã€‚</p><h2 id="è´Ÿè½½å‡è¡¡é€‰é¡¹"><a href="#è´Ÿè½½å‡è¡¡é€‰é¡¹" class="headerlink" title="è´Ÿè½½å‡è¡¡é€‰é¡¹"></a>è´Ÿè½½å‡è¡¡é€‰é¡¹</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio ä½¿ç”¨è½®è¯¢çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå®ä¾‹æ± ä¸­çš„æ¯ä¸ªå®ä¾‹ä¾æ¬¡è·å–è¯·æ±‚ã€‚Istio åŒæ—¶æ”¯æŒå¦‚ä¸‹çš„è´Ÿè½½å‡è¡¡æ¨¡å‹ï¼Œå¯ä»¥åœ¨ DestinationRule ä¸­ä¸ºæµå‘æŸä¸ªç‰¹å®šæœåŠ¡æˆ–æœåŠ¡å­é›†çš„æµé‡æŒ‡å®šè¿™äº›æ¨¡å‹ã€‚</p><ul><li>Randomï¼šè¯·æ±‚ä»¥éšæœºçš„æ–¹å¼è½¬åˆ°æ± ä¸­çš„å®ä¾‹</li><li>Weightedï¼šè¯·æ±‚æ ¹æ®æŒ‡å®šçš„ç™¾åˆ†æ¯”è½¬åˆ°å®ä¾‹</li><li>Least requestsï¼šè¯·æ±‚è¢«è½¬åˆ°æœ€å°‘è¢«è®¿é—®çš„å®ä¾‹</li></ul><h2 id="Destination-Rule-ç¤ºä¾‹"><a href="#Destination-Rule-ç¤ºä¾‹" class="headerlink" title="Destination Rule ç¤ºä¾‹"></a>Destination Rule ç¤ºä¾‹</h2><p>ä¸‹é¢çš„ç¤ºä¾‹ä¸º my-svc ç›®æ ‡æœåŠ¡é…ç½®äº† 3 ä¸ªå…·æœ‰ä¸åŒè´Ÿè½½å‡è¡¡ç­–ç•¥çš„å­é›†ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-destination-rule</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">my-svc</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">RANDOM</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">trafficPolicy:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">simple:</span> <span class="string">ROUND_ROBIN</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v3</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure><p>æ¯ä¸ªå­é›†éƒ½æ˜¯åŸºäºä¸€ä¸ªæˆ–å¤šä¸ª labels å®šä¹‰çš„ï¼Œåœ¨ Kubernetes ä¸­å®ƒæ˜¯é™„åŠ åˆ°åƒ Pod è¿™ç§å¯¹è±¡ä¸Šçš„é”®&#x2F;å€¼å¯¹ã€‚è¿™äº›æ ‡ç­¾åº”ç”¨äº Kubernetes æœåŠ¡çš„ Deployment å¹¶ä½œä¸º metadata æ¥è¯†åˆ«ä¸åŒçš„ç‰ˆæœ¬ã€‚</p><p>é™¤äº†å®šä¹‰å­é›†ä¹‹å¤–ï¼ŒDestination Rule å¯¹äºæ‰€æœ‰å­é›†éƒ½æœ‰é»˜è®¤çš„æµé‡ç­–ç•¥ï¼Œè€Œå¯¹äºè¯¥å­é›†ï¼Œåˆ™æœ‰ç‰¹å®šäºå­é›†çš„ç­–ç•¥è¦†ç›–å®ƒã€‚å®šä¹‰åœ¨ subsets ä¸Šçš„é»˜è®¤ç­–ç•¥ï¼Œä¸º v1 å’Œ v3 å­é›†è®¾ç½®äº†ä¸€ä¸ªç®€å•çš„éšæœºè´Ÿè½½å‡è¡¡å™¨ã€‚ä¸º  v2 å­é›†è®¾ç½®äº†ä¸€ä¸ªè½®è¯¢è´Ÿè½½å‡è¡¡å™¨ã€‚</p><h1 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h1><p>ä½¿ç”¨ Gateway ä¸ºç½‘æ ¼æ¥ç®¡ç†å…¥ç«™å’Œå‡ºç«™æµé‡ï¼Œå¯ä»¥æŒ‡å®šè¦è¿›å…¥æˆ–ç¦»å¼€ç½‘æ ¼çš„æµé‡ã€‚ç½‘å…³é…ç½®è¢«ç”¨äºè¿è¡Œåœ¨ç½‘æ ¼è¾¹ç•Œçš„ç‹¬ç«‹ Envoy ä»£ç†ï¼Œè€Œä¸æ˜¯æœåŠ¡å·¥ä½œè´Ÿè½½çš„ sidecar ä»£ç†ã€‚</p><p>ä¸ Kubernetes Ingress API è¿™ç§æ§åˆ¶è¿›å…¥ç³»ç»Ÿæµé‡çš„å…¶ä»–æœºåˆ¶ä¸åŒï¼ŒIstio Gateway å……åˆ†åˆ©ç”¨æµé‡è·¯ç”±çš„å¼ºå¤§èƒ½åŠ›å’Œçµæ´»æ€§ã€‚å¯ä»¥è¿™ä¹ˆåšçš„åŸå› æ˜¯ Istio çš„ Gateway èµ„æºå¯ä»¥é…ç½® 4-6 å±‚çš„è´Ÿè½½å‡è¡¡å±æ€§ï¼Œå¦‚å¯¹å¤–æš´éœ²çš„ç«¯å£ã€TLS è®¾ç½®ç­‰ã€‚ä½œä¸ºæ›¿ä»£åº”ç”¨å±‚æµé‡è·¯ç”±ï¼ˆL7ï¼‰åˆ°ç›¸åŒçš„ API èµ„æºï¼Œç»‘å®šäº†ä¸€ä¸ªå¸¸è§„çš„ Istio Virtual Service åˆ° Gateway ã€‚å¯ä»¥åƒç®¡ç†ç½‘æ ¼ä¸­å…¶ä»–æ•°æ®å¹³é¢çš„æµé‡ä¸€æ ·å»ç®¡ç†ç½‘å…³æµé‡ã€‚</p><p>Gateway ä¸»è¦ç”¨äºç®¡ç†è¿›å…¥çš„æµé‡ï¼Œä½†ä¹Ÿå¯ä»¥é…ç½®å‡ºå£ Gateway ã€‚å‡ºå£ Gateway ä¸ºç¦»å¼€ç½‘æ ¼çš„æµé‡é…ç½®ä¸€ä¸ªä¸“ç”¨çš„å‡ºå£èŠ‚ç‚¹ï¼Œè¿™å¯ä»¥é™åˆ¶å“ªäº›æœåŠ¡å¯ä»¥æˆ–åº”è¯¥è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œæˆ–è€…å¯ç”¨å‡ºå£æµé‡å®‰å…¨æ§åˆ¶ä¸ºç½‘æ ¼æ·»åŠ å®‰å…¨æ€§ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ Gateway é…ç½®ä¸€ä¸ªçº¯ç²¹çš„å†…éƒ¨ä»£ç†ã€‚</p><p>Istio æä¾›äº†ä¸€äº›é¢„å…ˆé…ç½®å¥½çš„ Gateway ä»£ç†æœåŠ¡ï¼ˆistio-ingressgateway å’Œ istio-egressgatewayï¼‰ã€‚</p><h2 id="Gateway-ç¤ºä¾‹"><a href="#Gateway-ç¤ºä¾‹" class="headerlink" title="Gateway ç¤ºä¾‹"></a>Gateway ç¤ºä¾‹</h2><p>ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªå¤–éƒ¨ HTTPS å…¥å£æµé‡çš„ç½‘å…³é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ext-host-gwy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">my-gateway-controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ext-host.example.com</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">SIMPLE</span></span><br><span class="line">      <span class="attr">serverCertificate:</span> <span class="string">/tmp/tls.crt</span></span><br><span class="line">      <span class="attr">privateKey:</span> <span class="string">/tmp/tls.key</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ª Gateway é…ç½®è®© HTTPS æµé‡ä» ext-host.example.com é€šè¿‡ 443 ç«¯å£æµå…¥ç½‘æ ¼ï¼Œä½†æ²¡æœ‰ä¸ºè¯·æ±‚æŒ‡å®šä»»ä½•è·¯ç”±è§„åˆ™ã€‚</p><p>ä¸ºæƒ³è¦ç”Ÿæ•ˆçš„ Gateway æŒ‡å®šè·¯ç”±ï¼Œå¿…é¡»æŠŠ Gateway ç»‘å®šåˆ° Virtual Service ä¸Šã€‚ç„¶åå°±å¯ä»¥ä¸ºå‡ºå£æµé‡é…ç½®å¸¦æœ‰è·¯ç”±è§„åˆ™çš„ Virtual Serviceã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">virtual-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ext-host.example.com</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ext-host-gwy</span></span><br></pre></td></tr></table></figure><h1 id="Service-Entry"><a href="#Service-Entry" class="headerlink" title="Service Entry"></a>Service Entry</h1><p>ä½¿ç”¨ Service Entry æ¥æ·»åŠ ä¸€ä¸ªå…¥å£åˆ° Istio å†…éƒ¨ç»´æŠ¤çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚æ·»åŠ äº† Service Entry åï¼ŒEnvoy ä»£ç†å¯ä»¥å‘æœåŠ¡å‘é€æµé‡ï¼Œå°±å¥½åƒå®ƒæ˜¯ç½‘æ ¼å†…éƒ¨çš„æœåŠ¡ä¸€æ ·ã€‚é…ç½® Service Entry å…è®¸ç®¡ç†è¿è¡Œåœ¨ç½‘æ ¼å¤–çš„æœåŠ¡çš„æµé‡ï¼Œå®ƒåŒ…æ‹¬ä»¥ä¸‹å‡ ç§èƒ½åŠ›ï¼š</p><ul><li>ä¸ºå¤–éƒ¨ç›®æ ‡ redirect å’Œè½¬å‘è¯·æ±‚ï¼Œä¾‹å¦‚æ¥è‡ª web ç«¯çš„ API è°ƒç”¨ï¼Œæˆ–è€…æµå‘é—ç•™è€ç³»ç»Ÿçš„æœåŠ¡</li><li>ä¸ºå¤–éƒ¨ç›®æ ‡å®šä¹‰é‡è¯•ã€è¶…æ—¶å’Œæ•…éšœæ³¨å…¥ç­–ç•¥</li><li>æ·»åŠ ä¸€ä¸ªè¿è¡Œåœ¨è™šæ‹Ÿæœºçš„æœåŠ¡æ¥æ‰©å±•æ‚¨çš„ç½‘æ ¼</li></ul><p>ä¸éœ€è¦ä¸ºç½‘æ ¼æœåŠ¡è¦ä½¿ç”¨çš„æ¯ä¸ªå¤–éƒ¨æœåŠ¡éƒ½æ·»åŠ  Service Entryã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio é…ç½® Envoy ä»£ç†å°†è¯·æ±‚ä¼ é€’ç»™æœªçŸ¥æœåŠ¡ã€‚ä½†æ˜¯ï¼Œä¸èƒ½ä½¿ç”¨ Istio çš„ç‰¹æ€§æ¥æ§åˆ¶æ²¡æœ‰åœ¨ç½‘æ ¼ä¸­æ³¨å†Œçš„ç›®æ ‡æµé‡ã€‚</p><h2 id="Service-Entry-ç¤ºä¾‹"><a href="#Service-Entry-ç¤ºä¾‹" class="headerlink" title="Service Entry ç¤ºä¾‹"></a>Service Entry ç¤ºä¾‹</h2><p>ä¸‹é¢çš„ Service Entry å°†å¤–éƒ¨æœåŠ¡ ext-svc.example.com æ·»åŠ åˆ° Istio çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-entry</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ext-svc.example.com</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br></pre></td></tr></table></figure><p>æŒ‡å®šçš„å¤–éƒ¨èµ„æºä½¿ç”¨ hosts å­—æ®µã€‚å¯ä»¥ä½¿ç”¨å®Œå…¨é™å®šåæˆ–é€šé…ç¬¦ä½œä¸ºå‰ç¼€åŸŸåã€‚</p><p>å¯ä»¥é…ç½® Virtual Service å’Œ Destination Ruleï¼Œä»¥æ›´ç»†ç²’åº¦çš„æ–¹å¼æ§åˆ¶åˆ° Service Entry çš„æµé‡ï¼Œè¿™ä¸ç½‘æ ¼ä¸­çš„ä»»ä½•å…¶ä»–æœåŠ¡é…ç½®æµé‡çš„æ–¹å¼ç›¸åŒã€‚</p><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ Destination Rule è°ƒæ•´äº†ä½¿ç”¨ Service Entry é…ç½®çš„ ext-svc.example.com  å¤–éƒ¨æœåŠ¡çš„è¿æ¥è¶…æ—¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ext-res-dr</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">ext-svc.example.com</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="string">1s</span></span><br></pre></td></tr></table></figure><h1 id="Sidecar"><a href="#Sidecar" class="headerlink" title="Sidecar"></a>Sidecar</h1><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio è®©æ¯ä¸ª Envoy ä»£ç†éƒ½å¯ä»¥è®¿é—®æ¥è‡ªå’Œå®ƒå…³è”çš„å·¥ä½œè´Ÿè½½çš„æ‰€æœ‰ç«¯å£çš„è¯·æ±‚ï¼Œç„¶åè½¬å‘åˆ°å¯¹åº”çš„å·¥ä½œè´Ÿè½½ã€‚å¯ä»¥ä½¿ç”¨ Sidecar é…ç½®å»åšä¸‹é¢çš„äº‹æƒ…ï¼š</p><ul><li>å¾®è°ƒ Envoy ä»£ç†æ¥å—çš„ç«¯å£å’Œåè®®é›†</li><li>é™åˆ¶ Envoy ä»£ç†å¯ä»¥è®¿é—®çš„æœåŠ¡é›†åˆ</li></ul><p>å¯èƒ½å¸Œæœ›åœ¨è¾ƒåºå¤§çš„åº”ç”¨ç¨‹åºä¸­é™åˆ¶è¿™æ ·çš„ Sidecar å¯è¾¾æ€§ï¼Œé…ç½®æ¯ä¸ªä»£ç†èƒ½è®¿é—®ç½‘æ ¼ä¸­çš„ä»»æ„æœåŠ¡å¯èƒ½ä¼šå› ä¸ºé«˜å†…å­˜ä½¿ç”¨é‡è€Œå½±å“ç½‘æ ¼çš„æ€§èƒ½ã€‚</p><p>å¯ä»¥æŒ‡å®šå°† Sidecar é…ç½®åº”ç”¨äºç‰¹å®šå‘½åç©ºé—´ä¸­çš„æ‰€æœ‰å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…ä½¿ç”¨ workloadSelector é€‰æ‹©ç‰¹å®šçš„å·¥ä½œè´Ÿè½½ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ Sidecar é…ç½®å°† bookinfo å‘½åç©ºé—´ä¸­çš„æ‰€æœ‰æœåŠ¡é…ç½®ä¸ºä»…èƒ½è®¿é—®è¿è¡Œåœ¨ç›¸åŒå‘½åç©ºé—´å’Œ istio-system æœåŠ¡ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Sidecar</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">egress:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;./*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;istio-system/*&quot;</span></span><br></pre></td></tr></table></figure><h1 id="ç½‘ç»œå¼¹æ€§å’Œæµ‹è¯•"><a href="#ç½‘ç»œå¼¹æ€§å’Œæµ‹è¯•" class="headerlink" title="ç½‘ç»œå¼¹æ€§å’Œæµ‹è¯•"></a>ç½‘ç»œå¼¹æ€§å’Œæµ‹è¯•</h1><p>é™¤äº†ä¸ºç½‘æ ¼å¯¼æµä¹‹å¤–ï¼ŒIstio è¿˜æä¾›äº†å¯é€‰çš„æ•…éšœæ¢å¤å’Œæ•…éšœæ³¨å…¥åŠŸèƒ½ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€é…ç½®è¿™äº›åŠŸèƒ½ã€‚ä½¿ç”¨è¿™äº›ç‰¹æ€§å¯ä»¥è®©åº”ç”¨ç¨‹åºè¿è¡Œç¨³å®šï¼Œç¡®ä¿æœåŠ¡ç½‘æ ¼èƒ½å¤Ÿå®¹å¿æ•…éšœèŠ‚ç‚¹ï¼Œå¹¶é˜²æ­¢å±€éƒ¨æ•…éšœçº§è”å½±å“åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚</p><h2 id="è¶…æ—¶"><a href="#è¶…æ—¶" class="headerlink" title="è¶…æ—¶"></a>è¶…æ—¶</h2><p>è¶…æ—¶æ˜¯ Envoy ä»£ç†ç­‰å¾…æ¥è‡ªç»™å®šæœåŠ¡çš„ç­”å¤çš„æ—¶é—´é‡ï¼Œä»¥ç¡®ä¿æœåŠ¡ä¸ä¼šå› ä¸ºç­‰å¾…ç­”å¤è€Œæ— é™æœŸçš„æŒ‚èµ·ï¼Œå¹¶åœ¨å¯é¢„æµ‹çš„æ—¶é—´èŒƒå›´å†…è°ƒç”¨æˆåŠŸæˆ–å¤±è´¥ã€‚HTTP è¯·æ±‚çš„é»˜è®¤è¶…æ—¶æ—¶é—´æ˜¯ 15 ç§’ï¼Œè¿™æ„å‘³ç€å¦‚æœæœåŠ¡åœ¨ 15 ç§’å†…æ²¡æœ‰å“åº”ï¼Œè°ƒç”¨å°†å¤±è´¥ã€‚</p><p>å¯¹äºæŸäº›åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ï¼ŒIstio çš„ç¼ºçœè¶…æ—¶å¯èƒ½ä¸åˆé€‚ã€‚ä¾‹å¦‚ï¼Œè¶…æ—¶å¤ªé•¿å¯èƒ½ä¼šç”±äºç­‰å¾…å¤±è´¥æœåŠ¡çš„å›å¤è€Œå¯¼è‡´è¿‡åº¦çš„å»¶è¿Ÿï¼›è€Œè¶…æ—¶è¿‡çŸ­åˆ™å¯èƒ½åœ¨ç­‰å¾…æ¶‰åŠå¤šä¸ªæœåŠ¡è¿”å›çš„æ“ä½œæ—¶è§¦å‘ä¸å¿…è¦åœ°å¤±è´¥ã€‚ä¸ºäº†æ‰¾åˆ°å¹¶ä½¿ç”¨æœ€ä½³è¶…æ—¶è®¾ç½®ï¼ŒIstio å…è®¸ä½¿ç”¨ Virtual Service æŒ‰æœåŠ¡è½»æ¾åœ°åŠ¨æ€è°ƒæ•´è¶…æ—¶ï¼Œè€Œä¸å¿…ä¿®æ”¹ä¸šåŠ¡ä»£ç ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ Virtual Service é…ç½®å¯¹ ratings æœåŠ¡çš„ v1 å­é›†çš„è°ƒç”¨æŒ‡å®š 10 ç§’è¶…æ—¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span></span><br></pre></td></tr></table></figure><h2 id="é‡è¯•"><a href="#é‡è¯•" class="headerlink" title="é‡è¯•"></a>é‡è¯•</h2><p>é‡è¯•è®¾ç½®æŒ‡å®šå¦‚æœåˆå§‹è°ƒç”¨å¤±è´¥ï¼ŒEnvoy ä»£ç†å°è¯•è¿æ¥æœåŠ¡çš„æœ€å¤§æ¬¡æ•°ã€‚é€šè¿‡ç¡®ä¿è°ƒç”¨ä¸ä¼šå› ä¸ºä¸´æ—¶è¿‡è½½çš„æœåŠ¡æˆ–ç½‘ç»œç­‰é—®é¢˜è€Œæ°¸ä¹…å¤±è´¥ï¼Œé‡è¯•å¯ä»¥æé«˜æœåŠ¡å¯ç”¨æ€§å’Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚é‡è¯•ä¹‹é—´çš„é—´éš”ï¼ˆ25ms+ï¼‰æ˜¯å¯å˜çš„ï¼Œå¹¶ç”± Istio è‡ªåŠ¨ç¡®å®šï¼Œä»è€Œé˜²æ­¢è¢«è°ƒç”¨æœåŠ¡è¢«è¯·æ±‚æ·¹æ²¡ã€‚HTTP è¯·æ±‚çš„é»˜è®¤é‡è¯•è¡Œä¸ºæ˜¯åœ¨è¿”å›é”™è¯¯ä¹‹å‰é‡è¯•ä¸¤æ¬¡ã€‚</p><p>ä¸è¶…æ—¶ä¸€æ ·ï¼ŒIstio é»˜è®¤çš„é‡è¯•è¡Œä¸ºåœ¨å»¶è¿Ÿæ–¹é¢å¯èƒ½ä¸é€‚åˆåº”ç”¨ç¨‹åºéœ€æ±‚ï¼ˆå¯¹å¤±è´¥çš„æœåŠ¡è¿›è¡Œè¿‡å¤šçš„é‡è¯•ä¼šé™ä½é€Ÿåº¦ï¼‰æˆ–å¯ç”¨æ€§ã€‚å¯ä»¥åœ¨ Virtual Service ä¸­æŒ‰æœåŠ¡è°ƒæ•´é‡è¯•è®¾ç½®ï¼Œè€Œä¸å¿…ä¿®æ”¹ä¸šåŠ¡ä»£ç ã€‚è¿˜å¯ä»¥é€šè¿‡æ·»åŠ æ¯æ¬¡é‡è¯•çš„è¶…æ—¶æ¥è¿›ä¸€æ­¥ç»†åŒ–é‡è¯•è¡Œä¸ºï¼Œå¹¶æŒ‡å®šæ¯æ¬¡é‡è¯•éƒ½è¯•å›¾æˆåŠŸè¿æ¥åˆ°æœåŠ¡æ‰€ç­‰å¾…çš„æ—¶é—´é‡ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ Virtual Service é…ç½®åœ¨åˆå§‹è°ƒç”¨å¤±è´¥åæœ€å¤šé‡è¯• 3 æ¬¡æ¥è¿æ¥åˆ°æœåŠ¡å­é›†ï¼Œæ¯ä¸ªé‡è¯•éƒ½æœ‰ 2 ç§’çš„è¶…æ—¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">retries:</span></span><br><span class="line">      <span class="attr">attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">perTryTimeout:</span> <span class="string">2s</span></span><br></pre></td></tr></table></figure><h2 id="ç†”æ–­å™¨"><a href="#ç†”æ–­å™¨" class="headerlink" title="ç†”æ–­å™¨"></a>ç†”æ–­å™¨</h2><p>ç†”æ–­å™¨æ˜¯ Istio ä¸ºåˆ›å»ºå…·æœ‰å¼¹æ€§çš„å¾®æœåŠ¡åº”ç”¨æä¾›çš„å¦ä¸€ä¸ªæœ‰ç”¨çš„æœºåˆ¶ã€‚åœ¨ç†”æ–­å™¨ä¸­ï¼Œè®¾ç½®ä¸€ä¸ªå¯¹æœåŠ¡ä¸­çš„å•ä¸ªä¸»æœºè°ƒç”¨çš„é™åˆ¶ï¼Œä¾‹å¦‚å¹¶å‘è¿æ¥çš„æ•°é‡æˆ–å¯¹è¯¥ä¸»æœºè°ƒç”¨å¤±è´¥çš„æ¬¡æ•°ã€‚ä¸€æ—¦é™åˆ¶è¢«è§¦å‘ï¼Œç†”æ–­å™¨å°±ä¼šâ€œè·³é—¸â€å¹¶åœæ­¢è¿æ¥åˆ°è¯¥ä¸»æœºã€‚ä½¿ç”¨ç†”æ–­æ¨¡å¼å¯ä»¥å¿«é€Ÿå¤±è´¥è€Œä¸å¿…è®©å®¢æˆ·ç«¯å°è¯•è¿æ¥åˆ°è¿‡è½½æˆ–æœ‰æ•…éšœçš„ä¸»æœºã€‚</p><p>ç†”æ–­é€‚ç”¨äºåœ¨è´Ÿè½½å‡è¡¡æ± ä¸­çš„çœŸå®ç½‘æ ¼ç›®æ ‡åœ°å€ï¼Œå¯ä»¥åœ¨ Destination Rule ä¸­é…ç½®ç†”æ–­å™¨é˜ˆå€¼ï¼Œè®©é…ç½®é€‚ç”¨äºæœåŠ¡ä¸­çš„æ¯ä¸ªä¸»æœºã€‚</p><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ Destination Rule é…ç½®å°† v1 å­é›†çš„ reviews æœåŠ¡å·¥ä½œè´Ÿè½½çš„å¹¶å‘è¿æ¥æ•°é™åˆ¶ä¸º 100ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">trafficPolicy:</span></span><br><span class="line">      <span class="attr">connectionPool:</span></span><br><span class="line">        <span class="attr">tcp:</span></span><br><span class="line">          <span class="attr">maxConnections:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure><h2 id="æ•…éšœæ³¨å…¥"><a href="#æ•…éšœæ³¨å…¥" class="headerlink" title="æ•…éšœæ³¨å…¥"></a>æ•…éšœæ³¨å…¥</h2><p>åœ¨é…ç½®äº†ç½‘ç»œï¼ŒåŒ…æ‹¬æ•…éšœæ¢å¤ç­–ç•¥ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ Istio çš„æ•…éšœæ³¨å…¥æœºåˆ¶æ¥ä¸ºæ•´ä¸ªåº”ç”¨ç¨‹åºæµ‹è¯•æ•…éšœæ¢å¤èƒ½åŠ›ã€‚æ•…éšœæ³¨å…¥æ˜¯ä¸€ç§å°†é”™è¯¯å¼•å…¥ç³»ç»Ÿä»¥ç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿæ‰¿å—å¹¶ä»é”™è¯¯æ¡ä»¶ä¸­æ¢å¤çš„æµ‹è¯•æ–¹æ³•ã€‚ä½¿ç”¨æ•…éšœæ³¨å…¥ç‰¹åˆ«æœ‰ç”¨ï¼Œèƒ½ç¡®ä¿æ•…éšœæ¢å¤ç­–ç•¥ä¸è‡³äºä¸å…¼å®¹æˆ–è€…å¤ªä¸¥æ ¼ï¼Œè¿™ä¼šå¯¼è‡´å…³é”®æœåŠ¡ä¸å¯ç”¨ã€‚</p><p><em>ç›®å‰ï¼Œæ•…éšœæ³¨å…¥é…ç½®ä¸èƒ½ä¸åŒä¸€ä¸ª Virtual Service ä¸Šçš„é‡è¯•æˆ–è¶…æ—¶é…ç½®ç›¸ç»“åˆ</em></p><p>ä¸å…¶ä»–é”™è¯¯æ³¨å…¥æœºåˆ¶ï¼ˆå¦‚å»¶è¿Ÿæ•°æ®åŒ…æˆ–åœ¨ç½‘ç»œå±‚æ€æ‰ Podï¼‰ä¸åŒï¼ŒIstio å…è®¸åœ¨åº”ç”¨å±‚æ³¨å…¥é”™è¯¯ã€‚è¿™å¯ä»¥æ³¨å…¥æ›´å¤šç›¸å…³çš„æ•…éšœï¼Œä¾‹å¦‚ HTTP é”™è¯¯ç ï¼Œä»¥è·å¾—æ›´å¤šç›¸å…³çš„ç»“æœã€‚</p><p>å¯ä»¥æ³¨å…¥ä¸¤ç§æ•…éšœï¼Œå®ƒä»¬éƒ½ä½¿ç”¨ Virtual Service é…ç½®ï¼š</p><ul><li>å»¶è¿Ÿï¼šå»¶è¿Ÿæ˜¯æ—¶é—´æ•…éšœã€‚å®ƒä»¬æ¨¡æ‹Ÿå¢åŠ çš„ç½‘ç»œå»¶è¿Ÿæˆ–ä¸€ä¸ªè¶…è½½çš„ä¸Šæ¸¸æœåŠ¡</li><li>ç»ˆæ­¢ï¼šç»ˆæ­¢æ˜¯å´©æºƒå¤±è´¥ã€‚å®ƒä»¬æ¨¡ä»¿ä¸Šæ¸¸æœåŠ¡çš„å¤±è´¥ã€‚ç»ˆæ­¢é€šå¸¸ä»¥ HTTP é”™è¯¯ç æˆ– TCP è¿æ¥å¤±è´¥çš„å½¢å¼å‡ºç°</li></ul><p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ Virtual Service ç¤ºä¾‹ä¸ºåƒåˆ†ä¹‹ä¸€çš„è®¿é—® ratings æœåŠ¡çš„è¯·æ±‚é…ç½®äº†ä¸€ä¸ª 5 ç§’çš„å»¶è¿Ÿï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">delay:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">0.1</span></span><br><span class="line">        <span class="attr">fixedDelay:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><h2 id="ä¸åº”ç”¨ç¨‹åºååŒå·¥ä½œ"><a href="#ä¸åº”ç”¨ç¨‹åºååŒå·¥ä½œ" class="headerlink" title="ä¸åº”ç”¨ç¨‹åºååŒå·¥ä½œ"></a>ä¸åº”ç”¨ç¨‹åºååŒå·¥ä½œ</h2><p>Istio æ•…éšœæ¢å¤åŠŸèƒ½å¯¹åº”ç”¨ç¨‹åºæ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„ã€‚åœ¨è¿”å›å“åº”ä¹‹å‰ï¼Œåº”ç”¨ç¨‹åºä¸çŸ¥é“ Envoy Sidecar ä»£ç†æ˜¯å¦æ­£åœ¨å¤„ç†è¢«è°ƒç”¨æœåŠ¡çš„æ•…éšœã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœåœ¨åº”ç”¨ç¨‹åºä»£ç ä¸­è®¾ç½®äº†æ•…éšœæ¢å¤ç­–ç•¥ï¼Œé‚£ä¹ˆéœ€è¦è®°ä½è¿™ä¸¤ä¸ªç­–ç•¥éƒ½æ˜¯ç‹¬ç«‹å·¥ä½œçš„ï¼Œå¦åˆ™ä¼šå‘ç”Ÿå†²çªã€‚ä¾‹å¦‚ï¼Œå‡è®¾è®¾ç½®äº†ä¸¤ä¸ªè¶…æ—¶ï¼Œä¸€ä¸ªåœ¨ Virtual Service ä¸­é…ç½®ï¼Œå¦ä¸€ä¸ªåœ¨åº”ç”¨ç¨‹åºä¸­é…ç½®ã€‚åº”ç”¨ç¨‹åºä¸ºæœåŠ¡çš„ API è°ƒç”¨è®¾ç½®äº† 2 ç§’è¶…æ—¶ã€‚è€Œåœ¨ Virtual Service ä¸­é…ç½®äº†ä¸€ä¸ª 3 ç§’è¶…æ—¶å’Œé‡è¯•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºçš„è¶…æ—¶ä¼šå…ˆç”Ÿæ•ˆï¼Œå› æ­¤ Envoy çš„è¶…æ—¶å’Œé‡è¯•å°è¯•ä¼šå¤±æ•ˆã€‚</p><p>è™½ç„¶ Istio æ•…éšœæ¢å¤ç‰¹æ€§æé«˜äº†ç½‘æ ¼ä¸­æœåŠ¡çš„å¯é æ€§å’Œå¯ç”¨æ€§ï¼Œä½†åº”ç”¨ç¨‹åºå¿…é¡»å¤„ç†æ•…éšœæˆ–é”™è¯¯å¹¶é‡‡å–é€‚å½“çš„å›é€€æ“ä½œã€‚ä¾‹å¦‚ï¼Œå½“è´Ÿè½½å‡è¡¡ä¸­çš„æ‰€æœ‰å®ä¾‹éƒ½å¤±è´¥æ—¶ï¼ŒEnvoy è¿”å›ä¸€ä¸ª HTTP 503 çŠ¶æ€ç ã€‚åº”ç”¨ç¨‹åºå¿…é¡»å®ç°å›é€€é€»è¾‘æ¥å¤„ç† HTTP 503 é”™è¯¯ä»£ç ã€‚</p>]]></content>
    
    
    <summary type="html">Istio æµé‡ç®¡ç†çš„è®¾è®¡æ¦‚è¿°ä¸ä½¿ç”¨èŒƒä¾‹</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Istio ã€å¿«é€Ÿå¼€å§‹</title>
    <link href="http://shenxianghong.github.io/2022/05/04/2022-05-04%20Istio%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"/>
    <id>http://shenxianghong.github.io/2022/05/04/2022-05-04%20Istio%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/</id>
    <published>2022-05-03T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.171Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="120" style="border: 0px" src="/gallery/istio/logo.svg"></div><hr><blockquote><p>based on <strong>1.15.0</strong></p></blockquote><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Istio æ˜¯ä¸€ä¸ªå¼€æºæœåŠ¡ç½‘æ ¼ï¼Œå®ƒé€æ˜åœ°åˆ†å±‚åˆ°ç°æœ‰çš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºä¸Šã€‚ Istio å¼ºå¤§çš„ç‰¹æ€§æä¾›äº†ä¸€ç§ç»Ÿä¸€å’Œæ›´æœ‰æ•ˆçš„æ–¹å¼æ¥ä¿æŠ¤ã€è¿æ¥å’Œç›‘è§†æœåŠ¡ã€‚ Istio æ˜¯å®ç°è´Ÿè½½å¹³è¡¡ã€æœåŠ¡åˆ°æœåŠ¡èº«ä»½éªŒè¯å’Œç›‘è§†çš„è·¯å¾„â€”â€”åªéœ€è¦å¾ˆå°‘æˆ–ä¸éœ€è¦æ›´æ”¹æœåŠ¡ä»£ç ã€‚å®ƒå¼ºå¤§çš„æ§åˆ¶å¹³é¢å¸¦æ¥äº†é‡è¦çš„ç‰¹ç‚¹ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>ä½¿ç”¨ TLS åŠ å¯†ã€å¼ºèº«ä»½è®¤è¯å’Œæˆæƒçš„é›†ç¾¤å†…æœåŠ¡åˆ°æœåŠ¡çš„å®‰å…¨é€šä¿¡</li><li>è‡ªåŠ¨è´Ÿè½½å‡è¡¡çš„ HTTPã€gRPCã€WebSocketï¼Œå’Œ TCP æµé‡</li><li>é€šè¿‡ä¸°å¯Œçš„è·¯ç”±è§„åˆ™ã€é‡è¯•ã€æ•…éšœè½¬ç§»å’Œæ•…éšœæ³¨å…¥å¯¹æµé‡è¡Œä¸ºè¿›è¡Œç»†ç²’åº¦æ§åˆ¶</li><li>ä¸€ä¸ªå¯æ’å…¥çš„ç­–ç•¥å±‚å’Œé…ç½® APIï¼Œæ”¯æŒè®¿é—®æ§åˆ¶ã€é€Ÿç‡é™åˆ¶å’Œé…é¢</li><li>å¯¹é›†ç¾¤å†…çš„æ‰€æœ‰æµé‡ï¼ˆåŒ…æ‹¬é›†ç¾¤å…¥å£å’Œå‡ºå£ï¼‰è¿›è¡Œè‡ªåŠ¨åº¦é‡ã€æ—¥å¿—å’Œè·Ÿè¸ª</li></ul><p>Istio æ˜¯ä¸ºå¯æ‰©å±•æ€§è€Œè®¾è®¡çš„ï¼Œå¯ä»¥å¤„ç†ä¸åŒèŒƒå›´çš„éƒ¨ç½²éœ€æ±‚ã€‚Istio çš„æ§åˆ¶å¹³é¢è¿è¡Œåœ¨ Kubernetes ä¸Šï¼Œæ‚¨å¯ä»¥å°†éƒ¨ç½²åœ¨è¯¥é›†ç¾¤ä¸­çš„åº”ç”¨ç¨‹åºæ·»åŠ åˆ°æ‚¨çš„ç½‘æ ¼ä¸­ï¼Œå°†ç½‘æ ¼æ‰©å±•åˆ°å…¶ä»–é›†ç¾¤ï¼Œç”šè‡³è¿æ¥ VM æˆ–è¿è¡Œåœ¨ Kubernetes ä¹‹å¤–çš„å…¶ä»–ç«¯ç‚¹ã€‚</p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><h3 id="Istio-ä¸-Kubernetes-ç‰ˆæœ¬æ˜ å°„å…³ç³»"><a href="#Istio-ä¸-Kubernetes-ç‰ˆæœ¬æ˜ å°„å…³ç³»" class="headerlink" title="Istio ä¸ Kubernetes ç‰ˆæœ¬æ˜ å°„å…³ç³»"></a>Istio ä¸ Kubernetes ç‰ˆæœ¬æ˜ å°„å…³ç³»</h3><p>å‚è€ƒï¼š<a href="https://istio.io/latest/docs/setup/platform-setup/">https://istio.io/latest/docs/setup/platform-setup/</a></p><table><thead><tr><th>Version</th><th>Currently Supported</th><th>Release Date</th><th>End of Life</th><th>Supported Kubernetes Versions</th><th>Tested, but not supported</th></tr></thead><tbody><tr><td>master</td><td>No, development only</td><td></td><td></td><td></td><td></td></tr><tr><td>1.15</td><td>Yes</td><td>August 31, 2022</td><td>~March 2023 (Expected)</td><td>1.22, 1.23, 1.24, 1.25</td><td>1.16, 1.17, 1.18, 1.19, 1.20, 1.21</td></tr><tr><td>1.14</td><td>Yes</td><td>May 24, 2022</td><td>~January 2023 (Expected)</td><td>1.21, 1.22, 1.23, 1.24</td><td>1.16, 1.17, 1.18, 1.19, 1.20</td></tr><tr><td>1.13</td><td>Yes</td><td>February 11, 2022</td><td>~October 2022 (Expected)</td><td>1.20, 1.21, 1.22, 1.23</td><td>1.16, 1.17, 1.18, 1.19</td></tr><tr><td>1.12</td><td>Yes</td><td>November 18, 2021</td><td>~June 2022 (Expected)</td><td>1.19, 1.20, 1.21, 1.22</td><td>1.16, 1.17, 1.18</td></tr><tr><td>1.11</td><td>Yes</td><td>August 12, 2021</td><td>~Mar 2022 (Expected)</td><td>1.18, 1.19, 1.20, 1.21, 1.22</td><td>1.16, 1.17</td></tr><tr><td>1.10</td><td>No</td><td>May 18, 2021</td><td>Jan 7, 2022</td><td>1.18, 1.19, 1.20, 1.21</td><td>1.16, 1.17, 1.22</td></tr><tr><td>1.9</td><td>No</td><td>February 9, 2021</td><td>Oct 8, 2021</td><td>1.17, 1.18, 1.19, 1.20</td><td>1.15, 1.16</td></tr><tr><td>1.8</td><td>No</td><td>November 10, 2020</td><td>May 12, 2021</td><td>1.16, 1.17, 1.18, 1.19</td><td>1.15</td></tr><tr><td>1.7</td><td>No</td><td>August 21, 2020</td><td>Feb 25, 2021</td><td>1.16, 1.17, 1.18</td><td>1.15</td></tr><tr><td>1.6 and earlier</td><td>No</td><td></td><td></td><td></td><td></td></tr></tbody></table><h3 id="profile-æ¦‚å¿µ"><a href="#profile-æ¦‚å¿µ" class="headerlink" title="profile æ¦‚å¿µ"></a>profile æ¦‚å¿µ</h3><p>å‚è€ƒï¼š<a href="https://istio.io/latest/docs/setup/additional-setup/config-profiles/">https://istio.io/latest/docs/setup/additional-setup/config-profiles/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl profile list</span></span><br><span class="line">Istio configuration profiles:</span><br><span class="line">    default</span><br><span class="line">    demo</span><br><span class="line">    empty</span><br><span class="line">    external</span><br><span class="line">    minimal</span><br><span class="line">    openshift</span><br><span class="line">    preview</span><br></pre></td></tr></table></figure><p>profile æè¿°äº† Istio æ§åˆ¶å¹³é¢ä¸æ•°æ®å¹³é¢çš„é…ç½®ä¿¡æ¯ï¼Œä»¥ä¸‹ä¸º Istio å†…å»ºçš„ profile ç±»åˆ«ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒè‡ªå®šä¹‰çš„ profileã€‚</p><ul><li>default<br><em>æ ¹æ® <a href="https://istio.io/latest/zh/docs/reference/config/istio.operator.v1alpha1/">IstioOperator API</a> çš„é»˜è®¤è®¾ç½®å¯åŠ¨ç»„ä»¶ã€‚ å»ºè®®ç”¨äºç”Ÿäº§éƒ¨ç½²å’Œ <a href="https://istio.io/latest/zh/docs/ops/deployment/deployment-models/#multiple-clusters">Multicluster Mesh</a> ä¸­çš„ Primary Cluster</em></li><li>demo<br><em>è¿™ä¸€é…ç½®å…·æœ‰é€‚åº¦çš„èµ„æºéœ€æ±‚ï¼Œæ—¨åœ¨å±•ç¤º Istio åŠŸèƒ½çš„é…ç½®ã€‚å®ƒé€‚åˆè¿è¡Œ <a href="https://istio.io/latest/docs/examples/bookinfo/">Bookinfo</a> åº”ç”¨ç¨‹åºå’Œç›¸å…³ä»»åŠ¡</em></li><li>empty<br><em>ä»€ä¹ˆéƒ½ä¸éƒ¨ç½²ã€‚å¯ä»¥ä½œä¸ºè‡ªå®šä¹‰é…ç½®çš„åŸºæœ¬é…ç½®æ–‡ä»¶</em></li><li>external<br><em>ç”¨äºé…ç½®è¿œç¨‹é›†ç¾¤ç”±ä¸€ä¸ªå¤–éƒ¨æ§åˆ¶å¹³é¢æˆ–è€…é€šè¿‡æ§åˆ¶å¹³é¢ä¸»è¦é›†ç¾¤<a href="https://istio.io/latest/docs/ops/deployment/deployment-models/#multiple-clusters">å¤šé›†ç¾¤ç½‘æ ¼</a></em></li><li>minimal<br><em>ä¸é»˜è®¤é…ç½®æ–‡ä»¶ç›¸åŒï¼Œä½†ä»…å®‰è£…æ§åˆ¶å¹³é¢ç»„ä»¶ã€‚è¿™å…è®¸æ‚¨ä½¿ç”¨<a href="https://istio.io/latest/docs/setup/additional-setup/gateway/#deploying-a-gateway">å•ç‹¬çš„é…ç½®æ–‡ä»¶</a>é…ç½®æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢ç»„ä»¶ï¼ˆä¾‹å¦‚ç½‘å…³ï¼‰</em></li><li>openshift</li><li>preview<br><em>åŒ…å«å®éªŒæ€§åŠŸèƒ½ã€‚æ—¨åœ¨æ¢ç´¢ Istio çš„æ–°åŠŸèƒ½ã€‚ä¸èƒ½ä¿è¯ç¨³å®šæ€§ã€å®‰å…¨æ€§å’Œæ€§èƒ½</em></li></ul><p><strong>ä¸åŒçš„ profile åŒ…å«çš„æ ¸å¿ƒç»„ä»¶</strong></p><table><thead><tr><th></th><th>default</th><th>demo</th><th>minimal</th><th>external</th><th>empty</th><th>preview</th></tr></thead><tbody><tr><td>Core components</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>istio-egressgateway</td><td></td><td>âœ”</td><td></td><td></td><td></td><td></td></tr><tr><td>istio-ingressgateway</td><td>âœ”</td><td>âœ”</td><td></td><td></td><td></td><td>âœ”</td></tr><tr><td>istiod</td><td>âœ”</td><td>âœ”</td><td>âœ”</td><td></td><td></td><td>âœ”</td></tr></tbody></table><p><strong>å±•ç¤º profile å…·ä½“å†…å®¹</strong></p><p>å¯ä»¥å°† profile dump å‡ºæ¥ï¼Œä¾¿äºæµè§ˆå’Œä¿®æ”¹é…ç½®ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ° profile çš„æœ¬è´¨å°±æ˜¯ IstioOperator èµ„æºï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl profile dump demo</span></span><br><span class="line">apiVersion: install.istio.io/v1alpha1</span><br><span class="line">kind: IstioOperator</span><br><span class="line">spec:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥é€šè¿‡ <code>--config-path</code> å‚æ•°ï¼ˆæ›´å¤šé…ç½®å‚è€ƒï¼š<a href="https://istio.io/latest/docs/reference/config/%EF%BC%89%EF%BC%8C%E9%80%89%E6%8B%A9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E6%8C%87%E5%AE%9A%E8%B7%AF%E5%BE%84%E7%9A%84%E5%B1%80%E9%83%A8%E5%86%85%E5%AE%B9">https://istio.io/latest/docs/reference/config/ï¼‰ï¼Œé€‰æ‹©é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè·¯å¾„çš„å±€éƒ¨å†…å®¹</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl profile dump --config-path components.pilot demo</span></span><br><span class="line">enabled: true</span><br><span class="line">k8s:</span><br><span class="line">  env:</span><br><span class="line">  - name: PILOT_TRACE_SAMPLING</span><br><span class="line">    value: &quot;100&quot;</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      cpu: 10m</span><br><span class="line">      memory: 100Mi</span><br></pre></td></tr></table></figure><p><strong>å±•ç¤º profile ä¹‹é—´å·®åˆ«</strong></p><p>å¯ä»¥çœ‹åˆ° default å’Œ demo profile ä¹‹é—´çš„å·®åˆ«ä¹‹ä¸€æ˜¯ï¼Œdefault ä¸ä¼šéƒ¨ç½² istio-egressgateway ç»„ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl profile diff default demo</span></span><br><span class="line">spec:</span><br><span class="line">   components:</span><br><span class="line">     base:</span><br><span class="line">       enabled: true</span><br><span class="line">     cni:</span><br><span class="line">       enabled: false</span><br><span class="line">     egressGateways:</span><br><span class="line">-    - enabled: false</span><br><span class="line">+    - enabled: true</span><br><span class="line">+      k8s:</span><br><span class="line">+        resources:</span><br><span class="line">+          requests:</span><br><span class="line">+            cpu: 10m</span><br><span class="line">+            memory: 40Mi</span><br><span class="line">       name: istio-egressgateway</span><br></pre></td></tr></table></figure><h3 id="Istio-å‡†å¤‡"><a href="#Istio-å‡†å¤‡" class="headerlink" title="Istio å‡†å¤‡"></a>Istio å‡†å¤‡</h3><p>Istio å¯ä»¥é€šè¿‡ <a href="https://github.com/istio/istio/releases/tag/1.15.0">release</a> ä¸‹è½½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Istio å®˜æ–¹æä¾›çš„ downloadIstio è„šæœ¬ä¸‹è½½ï¼Œä¸¤è€…ç­‰ä»·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -L https://istio.io/downloadIstio | sh -</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è„šæœ¬æœ¬èº«ä¹Ÿæä¾›äº†è¯¸å¤šå‚æ•°ï¼Œä¾‹å¦‚æŒ‡å®šç‰ˆæœ¬ã€æŒ‡å®šæ¶æ„ä¸‹è½½</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.15.0 TARGET_ARCH=x86_64 sh -</span></span><br></pre></td></tr></table></figure><p>ä¸‹è½½ååŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼Œå…¶ä¸­ istioctl ä½äº bin ç›®å½•ä¸­ï¼Œç¤ºä¾‹ä½äº samples ç›®å½•ä¸­</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span></span></span><br><span class="line">bin  LICENSE  manifests  manifest.yaml  README.md  samples  tools</span><br></pre></td></tr></table></figure><h3 id="ç¯å¢ƒé¢„æ£€"><a href="#ç¯å¢ƒé¢„æ£€" class="headerlink" title="ç¯å¢ƒé¢„æ£€"></a>ç¯å¢ƒé¢„æ£€</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl x precheck</span></span><br><span class="line">âœ” No issues found when checking the cluster. Istio is safe to install or upgrade!</span><br><span class="line">  To get started, check out https://istio.io/latest/docs/setup/getting-started/</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡-Istioctl-å®‰è£…"><a href="#é€šè¿‡-Istioctl-å®‰è£…" class="headerlink" title="é€šè¿‡ Istioctl å®‰è£…"></a>é€šè¿‡ Istioctl å®‰è£…</h2><p>å®‰è£…é»˜è®¤çš„ Istioï¼ˆå³ profile ä¸º defaultï¼‰ï¼Œè¯¥ profile å¸¸ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl install</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è¿›è¡Œä¸€äº›å®šåˆ¶åŒ–ï¼ˆâ€“setï¼‰ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl install --<span class="built_in">set</span> meshConfig.accessLogFile=/dev/stdout</span></span><br></pre></td></tr></table></figure><p>è¯¥æ•ˆæœç­‰ä»·äºï¼ˆ-fï¼‰ï¼Œä½¿ç”¨ Istio Operator API çš„æ–¹å¼æ›´é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl install -f - &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">apiVersion: install.istio.io/v1alpha1</span><br><span class="line">kind: IstioOperator</span><br><span class="line">spec:</span><br><span class="line">  meshConfig:</span><br><span class="line">    accessLogFile: /dev/stdout</span><br><span class="line">EOF    </span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ›´å¥½çš„æ¼”ç¤º Istio çš„ç‰¹æ€§ï¼Œå› æ­¤ä½¿ç”¨ demo çš„ profile å®‰è£… Istioã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl install --<span class="built_in">set</span> profile=demo -y</span></span><br><span class="line">âœ” Istio core installed</span><br><span class="line">âœ” Istiod installed</span><br><span class="line">âœ” Egress gateways installed</span><br><span class="line">âœ” Ingress gateways installed</span><br><span class="line">âœ” Installation complete</span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡-Istio-Operator-å®‰è£…"><a href="#é€šè¿‡-Istio-Operator-å®‰è£…" class="headerlink" title="é€šè¿‡ Istio Operator å®‰è£…"></a>é€šè¿‡ Istio Operator å®‰è£…</h2><p>ç±»ä¼¼äº Prometheus Operatorï¼ŒIstio æä¾›äº†é€šè¿‡ Operator å®‰è£… Istio çš„æ–¹å¼ï¼Œåªéœ€è¦ç®€å•çš„æ›´æ–° Istio Operator å£°æ˜çš„ API å¯¹è±¡ï¼Œä¾¿å¯ä»¥éå¸¸ä¾¿æ·åœ°å¤„ç†å¤šç‰ˆæœ¬ Istioã€‚</p><h3 id="éƒ¨ç½²-Istio-Operator"><a href="#éƒ¨ç½²-Istio-Operator" class="headerlink" title="éƒ¨ç½² Istio Operator"></a>éƒ¨ç½² Istio Operator</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl operator init</span></span><br><span class="line">Installing operator controller in namespace: istio-operator using image: docker.io/istio/operator:1.15.0</span><br><span class="line">Operator controller will watch namespaces: istio-system</span><br><span class="line">âœ” Istio operator installed</span><br><span class="line">âœ” Installation complete</span><br></pre></td></tr></table></figure><p>åœ¨éƒ¨ç½² Istio Operator æ—¶ï¼Œæ”¯æŒæŒ‡å®šè¯¦ç»†è§„æ ¼ï¼ˆæ›´å¤šé…ç½®å‚è€ƒï¼š<a href="https://istio.io/latest/docs/reference/config/%EF%BC%89%E3%80%82%E4%BE%8B%E5%A6%82%EF%BC%8C%E5%9C%A8%E6%8C%87%E5%AE%9A%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%A7%82%E6%B5%8B%E8%B5%84%E6%BA%90%E3%80%82">https://istio.io/latest/docs/reference/config/ï¼‰ã€‚ä¾‹å¦‚ï¼Œåœ¨æŒ‡å®šå‘½åç©ºé—´è§‚æµ‹èµ„æºã€‚</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl operator init --watchedNamespaces=istio-namespace1,istio-namespace2</span></span><br></pre></td></tr></table></figure><p>éƒ¨ç½² Istio Operator åä¼šäº§ç”Ÿä»¥ä¸‹èµ„æº</p><ul><li><p>CRD</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get crd | grep istio</span></span><br><span class="line">istiooperators.install.istio.io                       2022-05-14T03:11:20Z</span><br></pre></td></tr></table></figure></li><li><p>Deployment</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deploy -n istio-operator</span></span><br><span class="line">NAME             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">istio-operator   1/1     1            1           6m20s</span><br></pre></td></tr></table></figure></li><li><p>Serviceï¼ˆç”¨äºæš´éœ² Istio Operator æŒ‡æ ‡ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get svc -n istio-operator</span></span><br><span class="line">NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">istio-operator   ClusterIP   10.96.212.28   &lt;none&gt;        8383/TCP   6m47s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl 10.96.212.28:8383/metrics</span></span><br></pre></td></tr></table></figure></li><li><p>RBACï¼ˆç»†èŠ‚ä¸åšå±•ç¤ºï¼‰</p></li></ul><h3 id="åˆ›å»º-IstioOperator-èµ„æº"><a href="#åˆ›å»º-IstioOperator-èµ„æº" class="headerlink" title="åˆ›å»º IstioOperator èµ„æº"></a>åˆ›å»º IstioOperator èµ„æº</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f - &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">apiVersion: install.istio.io/v1alpha1</span><br><span class="line">kind: IstioOperator</span><br><span class="line">metadata:</span><br><span class="line">  namespace: istio-system</span><br><span class="line">  name: example-istiocontrolplane</span><br><span class="line">spec:</span><br><span class="line">  profile: demo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>Istio Operator watch åˆ° IstioOperator èµ„æºï¼Œç„¶åæ ¹æ® spec ä¸­å£°æ˜çš„è¯¦ç»†è§„æ ¼ï¼ˆå…·ä½“å‚è€ƒï¼šæ›´å¤šé…ç½®å‚è€ƒï¼š<a href="https://istio.io/latest/docs/reference/config/%EF%BC%89%EF%BC%8C%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2">https://istio.io/latest/docs/reference/config/ï¼‰ï¼Œå®‰è£…éƒ¨ç½²</a> Istio æœåŠ¡ã€‚</p><h2 id="å®‰è£…å†…å®¹"><a href="#å®‰è£…å†…å®¹" class="headerlink" title="å®‰è£…å†…å®¹"></a>å®‰è£…å†…å®¹</h2><p>å®‰è£… Istioï¼ˆprofile ä¸º demoï¼‰åä¼šäº§ç”Ÿä»¥ä¸‹èµ„æº</p><ul><li><p>Deployment</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get deploy -n istio-system</span></span><br><span class="line">NAME                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">istio-egressgateway    1/1     1            1           4m14s</span><br><span class="line">istio-ingressgateway   1/1     1            1           4m14s</span><br><span class="line">istiod                 1/1     1            1           4m23s</span><br></pre></td></tr></table></figure></li><li><p>Service</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get svc -n istio-system</span></span><br><span class="line">NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span><br><span class="line">istio-egressgateway    ClusterIP      10.96.206.121   &lt;none&gt;        80/TCP,443/TCP                                                               85s</span><br><span class="line">istio-ingressgateway   LoadBalancer   10.96.159.246   &lt;pending&gt;     15021:31641/TCP,80:31235/TCP,443:30268/TCP,31400:32741/TCP,15443:31149/TCP   85s</span><br><span class="line">istiod                 ClusterIP      10.96.2.143     &lt;none&gt;        15010/TCP,15012/TCP,443/TCP,15014/TCP                                        2m24s</span><br></pre></td></tr></table></figure></li><li><p>CRD</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get crd | grep istio</span></span><br><span class="line">authorizationpolicies.security.istio.io               2022-09-13T05:55:57Z</span><br><span class="line">destinationrules.networking.istio.io                  2022-09-13T05:55:57Z</span><br><span class="line">envoyfilters.networking.istio.io                      2022-09-13T05:55:57Z</span><br><span class="line">gateways.networking.istio.io                          2022-09-13T05:55:57Z</span><br><span class="line">istiooperators.install.istio.io                       2022-09-13T05:55:57Z</span><br><span class="line">peerauthentications.security.istio.io                 2022-09-13T05:55:57Z</span><br><span class="line">proxyconfigs.networking.istio.io                      2022-09-13T05:55:57Z</span><br><span class="line">requestauthentications.security.istio.io              2022-09-13T05:55:58Z</span><br><span class="line">serviceentries.networking.istio.io                    2022-09-13T05:55:58Z</span><br><span class="line">sidecars.networking.istio.io                          2022-09-13T05:55:58Z</span><br><span class="line">telemetries.telemetry.istio.io                        2022-09-13T05:55:58Z</span><br><span class="line">virtualservices.networking.istio.io                   2022-09-13T05:55:58Z</span><br><span class="line">wasmplugins.extensions.istio.io                       2022-09-13T05:55:58Z</span><br><span class="line">workloadentries.networking.istio.io                   2022-09-13T05:55:58Z</span><br><span class="line">workloadgroups.networking.istio.io                    2022-09-13T05:55:58Z</span><br></pre></td></tr></table></figure></li><li><p>webhook</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get mutatingwebhookconfigurations</span></span><br><span class="line">NAME                         WEBHOOKS   AGE</span><br><span class="line">istio-revision-tag-default   4          8m57s</span><br><span class="line">istio-sidecar-injector       4          9m19s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get validatingwebhookconfigurations</span></span><br><span class="line">NAME                           WEBHOOKS   AGE</span><br><span class="line">istio-validator-istio-system   1          9m27s</span><br><span class="line">istiod-default-validator       1          9m4s</span><br></pre></td></tr></table></figure></li><li><p>RBACï¼ŒPodDisruptionBudgetï¼ŒConfigMapï¼ŒEnvoyFilterï¼ˆç»†èŠ‚ä¸åšå±•ç¤ºï¼‰</p></li></ul><p>ä¹Ÿå¯ä»¥æŸ¥çœ‹ IstioOperator å¯¹è±¡æ¥è·å–å®‰è£…ç»†èŠ‚ï¼Œinstalled-state ä¸º istioctl å®‰è£…çš„é»˜è®¤åç§°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get istiooperator -n istio-system</span></span><br><span class="line">NAME              REVISION   STATUS   AGE</span><br><span class="line">installed-state                       10m</span><br></pre></td></tr></table></figure><p>å¦‚æœ Istio é›†ç¾¤ç”± Istio Operator åˆ›å»ºï¼Œé‚£ä¹ˆ Istio Operator ä¼šç»´æŠ¤ IstioOperator å¯¹è±¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get istiooperator -n istio-system</span></span><br><span class="line">NAMESPACE      NAME                        REVISION   STATUS    AGE</span><br><span class="line">istio-system   example-istiocontrolplane              HEALTHY   2m59s</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆå®‰è£…çš„èµ„æºæ¸…å•ï¼Œå¹¶æ ¡éªŒå®‰è£…æ˜¯å¦å®Œæ•´ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl manifest generate --<span class="built_in">set</span> profile=demo | istioctl verify-install -f -</span></span><br><span class="line">...</span><br><span class="line">âœ” Service: istio-ingressgateway.istio-system checked successfully</span><br><span class="line">âœ” Service: istiod.istio-system checked successfully</span><br><span class="line">Checked 15 custom resource definitions</span><br><span class="line">Checked 3 Istio Deployments</span><br><span class="line">âœ” Istio is installed and verified successfully</span><br></pre></td></tr></table></figure><h2 id="é…ç½®æ ¡éªŒ"><a href="#é…ç½®æ ¡éªŒ" class="headerlink" title="é…ç½®æ ¡éªŒ"></a>é…ç½®æ ¡éªŒ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl analyze --all-namespaces</span></span><br><span class="line"></span><br><span class="line">âœ” No validation issues found when analyzing all namespaces.</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œå½“ VirtualService æŒ‡å‘çš„ Gateway ä¸å­˜åœ¨æ—¶ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl analyze --all-namespaces</span></span><br><span class="line">Error [IST0101] (VirtualService default/bookinfo) Referenced gateway not found: &quot;bookinfo-gateway-error&quot;</span><br><span class="line">Warning [IST0132] (VirtualService default/bookinfo) one or more host [*] defined in VirtualService default/bookinfo not found in Gateway default/bookinfo-gateway-error.</span><br><span class="line">Error: Analyzers found issues when analyzing all namespaces.</span><br><span class="line">See https://istio.io/v1.15/docs/reference/config/analysis for more information about causes and resolutions.</span><br></pre></td></tr></table></figure><h1 id="å¸è½½"><a href="#å¸è½½" class="headerlink" title="å¸è½½"></a>å¸è½½</h1><h2 id="å¸è½½-Istio-Operator"><a href="#å¸è½½-Istio-Operator" class="headerlink" title="å¸è½½ Istio Operator"></a>å¸è½½ Istio Operator</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl operator remove</span></span><br><span class="line">Removing Istio operator...</span><br><span class="line">  Removed Deployment:istio-operator:istio-operator.</span><br><span class="line">  Removed Service:istio-operator:istio-operator.</span><br><span class="line">  Removed ServiceAccount:istio-operator:istio-operator.</span><br><span class="line">  Removed ClusterRole::istio-operator.</span><br><span class="line">  Removed ClusterRoleBinding::istio-operator.</span><br><span class="line">âœ” Removal complete</span><br></pre></td></tr></table></figure><h2 id="å¸è½½-Istio"><a href="#å¸è½½-Istio" class="headerlink" title="å¸è½½ Istio"></a>å¸è½½ Istio</h2><p><code>--purge</code> ä¼šç§»é™¤æ‰€æœ‰ Istio èµ„æºï¼ŒåŒ…æ‹¬é›†ç¾¤çº§åˆ«çš„ï¼ˆä¼šå¯¹å…¶ä»–å…±äº«èµ„æºçš„ Istio é›†ç¾¤é€ æˆç ´åï¼‰ï¼Œæ›´å¤šé…ç½®å‚è€ƒï¼š<a href="https://istio.io/latest/docs/reference/config/">https://istio.io/latest/docs/reference/config/</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl uninstall --purge</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡å®‰è£…çš„èµ„æºæ¸…å•ï¼Œæ‰§è¡Œå¸è½½æ“ä½œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">istioctl manifest generate --<span class="built_in">set</span> profile=demo | kubectl delete -f -</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œistio-system namespace ä¸ä¼šè¢«åˆ é™¤ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete ns istio-system</span></span><br></pre></td></tr></table></figure><h1 id="BookInfo-ç¤ºä¾‹"><a href="#BookInfo-ç¤ºä¾‹" class="headerlink" title="BookInfo ç¤ºä¾‹"></a>BookInfo ç¤ºä¾‹</h1><p>è¿™ä¸ªç¤ºä¾‹éƒ¨ç½²äº†ä¸€ä¸ªç”¨äºæ¼”ç¤ºå¤šç§ Istio ç‰¹æ€§çš„åº”ç”¨ï¼Œè¯¥åº”ç”¨ç”±å››ä¸ªå•ç‹¬çš„å¾®æœåŠ¡æ„æˆã€‚è¿™ä¸ªåº”ç”¨æ¨¡ä»¿åœ¨çº¿ä¹¦åº—çš„ä¸€ä¸ªåˆ†ç±»ï¼Œæ˜¾ç¤ºä¸€æœ¬ä¹¦çš„ä¿¡æ¯ã€‚ é¡µé¢ä¸Šä¼šæ˜¾ç¤ºä¸€æœ¬ä¹¦çš„æè¿°ï¼Œä¹¦ç±çš„ç»†èŠ‚ï¼ˆISBNã€é¡µæ•°ç­‰ï¼‰ï¼Œä»¥åŠå…³äºè¿™æœ¬ä¹¦çš„ä¸€äº›è¯„è®ºã€‚</p><p>BookInfo åº”ç”¨åˆ†ä¸ºå››ä¸ªå•ç‹¬çš„å¾®æœåŠ¡</p><ul><li>productpage ä¼šè°ƒç”¨ details å’Œ reviews ä¸¤ä¸ªå¾®æœåŠ¡ï¼Œç”¨æ¥ç”Ÿæˆé¡µé¢</li><li>details åŒ…å«äº†ä¹¦ç±çš„ä¿¡æ¯</li><li>reviews åŒ…å«äº†ä¹¦ç±ç›¸å…³çš„è¯„è®ºã€‚å®ƒè¿˜ä¼šè°ƒç”¨ ratings å¾®æœåŠ¡</li><li>ratings åŒ…å«äº†ç”±ä¹¦ç±è¯„ä»·ç»„æˆçš„è¯„çº§ä¿¡æ¯</li></ul><p>reviews å¾®æœåŠ¡æœ‰ 3 ä¸ªç‰ˆæœ¬</p><ul><li>v1 ç‰ˆæœ¬ä¸ä¼šè°ƒç”¨ ratings æœåŠ¡</li><li>v2 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªé»‘è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li><li>v3 ç‰ˆæœ¬ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ 1 åˆ° 5 ä¸ªçº¢è‰²æ˜Ÿå½¢å›¾æ ‡æ¥æ˜¾ç¤ºè¯„åˆ†ä¿¡æ¯</li></ul><p>è¯¥åº”ç”¨çš„ç«¯åˆ°ç«¯æ¶æ„å¦‚ä¸‹</p><div align=center><img width="600" style="border: 0px" src="/gallery/istio/withistio.svg"></div><p>BookInfo åº”ç”¨ä¸­çš„å‡ ä¸ªå¾®æœåŠ¡æ˜¯ç”±ä¸åŒçš„è¯­è¨€ç¼–å†™çš„ã€‚ è¿™äº›æœåŠ¡å¯¹ Istio å¹¶æ— ä¾èµ–ï¼Œä½†æ˜¯æ„æˆäº†ä¸€ä¸ªæœ‰ä»£è¡¨æ€§çš„æœåŠ¡ç½‘æ ¼çš„ä¾‹å­ï¼šå®ƒç”±å¤šä¸ªæœåŠ¡ã€å¤šä¸ªè¯­è¨€æ„æˆï¼Œå¹¶ä¸” reviews æœåŠ¡å…·æœ‰å¤šä¸ªç‰ˆæœ¬ã€‚</p><p>æ‰€æœ‰çš„å¾®æœåŠ¡éƒ½å’Œ Envoy sidecar é›†æˆåœ¨ä¸€èµ·ï¼Œè¢«é›†æˆæœåŠ¡æ‰€æœ‰çš„å‡ºå…¥æµé‡éƒ½è¢« sidecar æ‰€åŠ«æŒï¼Œè¿™æ ·å°±ä¸ºå¤–éƒ¨æ§åˆ¶å‡†å¤‡äº†æ‰€éœ€çš„ Hookï¼Œç„¶åå°±å¯ä»¥åˆ©ç”¨ Istio æ§åˆ¶å¹³é¢ä¸ºåº”ç”¨æä¾›æœåŠ¡è·¯ç”±ã€é¥æµ‹æ•°æ®æ”¶é›†ä»¥åŠç­–ç•¥å®æ–½ç­‰åŠŸèƒ½ã€‚</p><p>æ ¹æ®åä¸º istio-ingressgateway çš„ Service çš„ä¿¡æ¯ï¼Œå¯ä»¥æ˜ç¡® http çš„è®¿é—®åœ°å€ä¸º <code>http://178.104.162.69:31235</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get svc -n istio-system istio-ingressgateway</span></span><br><span class="line">NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                      AGE</span><br><span class="line">istio-ingressgateway   LoadBalancer   10.96.159.246   &lt;pending&gt;     15021:31641/TCP,80:31235/TCP,443:30268/TCP,31400:32741/TCP,15443:31149/TCP   3m34s</span><br></pre></td></tr></table></figure><h2 id="æ³¨å…¥-Sidecar"><a href="#æ³¨å…¥-Sidecar" class="headerlink" title="æ³¨å…¥ Sidecar"></a>æ³¨å…¥ Sidecar</h2><p>Istio é»˜è®¤è‡ªåŠ¨æ³¨å…¥ Sidecarï¼Œç›®å‰ä¸º default å‘½åç©ºé—´æ‰“ä¸Šæ ‡ç­¾ istio-injection&#x3D;enabledã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl label namespace default istio-injection=enabled</span></span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²æµ‹è¯•åº”ç”¨"><a href="#éƒ¨ç½²æµ‹è¯•åº”ç”¨" class="headerlink" title="éƒ¨ç½²æµ‹è¯•åº”ç”¨"></a>éƒ¨ç½²æµ‹è¯•åº”ç”¨</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml</span></span><br><span class="line">service/details created</span><br><span class="line">serviceaccount/bookinfo-details created</span><br><span class="line">deployment.apps/details-v1 created</span><br><span class="line">service/ratings created</span><br><span class="line">serviceaccount/bookinfo-ratings created</span><br><span class="line">deployment.apps/ratings-v1 created</span><br><span class="line">service/reviews created</span><br><span class="line">serviceaccount/bookinfo-reviews created</span><br><span class="line">deployment.apps/reviews-v1 created</span><br><span class="line">deployment.apps/reviews-v2 created</span><br><span class="line">deployment.apps/reviews-v3 created</span><br><span class="line">service/productpage created</span><br><span class="line">serviceaccount/bookinfo-productpage created</span><br><span class="line">deployment.apps/productpage-v1 created</span><br></pre></td></tr></table></figure><p>çŠ¶æ€æ£€æŸ¥ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ Pod å‡ä¸º 2 å®¹å™¨ï¼Œå…¶ä¸­å°±åŒ…å«äº† Sidecar å®¹å™¨ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">details-v1-79f774bdb9-m9njc       2/2     Running   2          20m</span><br><span class="line">productpage-v1-6b746f74dc-8xps7   2/2     Running   2          20m</span><br><span class="line">ratings-v1-b6994bb9-54w28         2/2     Running   2          20m</span><br><span class="line">reviews-v1-545db77b95-57wkb       2/2     Running   2          20m</span><br><span class="line">reviews-v2-7bf8c9648f-qj7zg       2/2     Running   2          20m</span><br><span class="line">reviews-v3-84779c7bbc-fl2mx       2/2     Running   1          20m</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get svc</span></span><br><span class="line">NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">details       ClusterIP   10.96.15.22     &lt;none&gt;        9080/TCP   13m</span><br><span class="line">kubernetes    ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP    43d</span><br><span class="line">productpage   ClusterIP   10.96.59.210    &lt;none&gt;        9080/TCP   13m</span><br><span class="line">ratings       ClusterIP   10.96.136.207   &lt;none&gt;        9080/TCP   13m</span><br><span class="line">reviews       ClusterIP   10.96.254.165   &lt;none&gt;        9080/TCP   13m</span><br></pre></td></tr></table></figure><p>é€šè¿‡è®¿é—®å¯ä»¥çœ‹åˆ°ï¼ŒBookinfo æœåŠ¡æ­£åœ¨è¿è¡Œã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it $(kubectl get pod -l app=ratings -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -c ratings -- curl productpage:9080/productpage | grep -o <span class="string">&quot;&lt;title&gt;.*&lt;/title&gt;&quot;</span></span></span><br><span class="line">&lt;title&gt;Simple Bookstore App&lt;/title&gt;</span><br></pre></td></tr></table></figure><h2 id="åˆ›å»º-Gateway-ä¸é»˜è®¤çš„-VirtualService"><a href="#åˆ›å»º-Gateway-ä¸é»˜è®¤çš„-VirtualService" class="headerlink" title="åˆ›å»º Gateway ä¸é»˜è®¤çš„ VirtualService"></a>åˆ›å»º Gateway ä¸é»˜è®¤çš„ VirtualService</h2><p> ä¸ºäº†ä¿è¯æœåŠ¡æµé‡å¯ä»¥è¿›å…¥åˆ°æœåŠ¡ç½‘æ ¼ï¼Œéœ€è¦åˆ›å»º Gateway èµ„æºï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ VirtualServiceã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get gateway</span></span><br><span class="line">NAME               AGE</span><br><span class="line">bookinfo-gateway   9s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get virtualservice</span></span><br><span class="line">NAME       GATEWAYS               HOSTS   AGE</span><br><span class="line">bookinfo   [&quot;bookinfo-gateway&quot;]   [&quot;*&quot;]   23m</span><br></pre></td></tr></table></figure><p>åˆ›å»ºçš„ Gatewayï¼Œæœ¬è´¨ä¸Šæ˜¯å°†å…¥ç«™æµé‡äº¤ç»™æ»¡è¶³æ ‡ç­¾ istio&#x3D;ingressgateway çš„ Pod çš„æµé‡æ¥ç®¡ã€‚</p><p><em>ä¹Ÿå°±æ˜¯è¯´æµé‡ä» istio-ingressgateway çš„ Service 80 ç«¯å£å…¥ç«™ï¼Œè½¬å‘åˆ°åç«¯çš„ istio-ingressgateway çš„ Podã€‚åˆ›å»º Gateway ä¹‹å istio-ingressgateway ä¼šåŠ¨æ€ç»‘å®š Gateway ä¸­å£°æ˜çš„ port ç«¯å£ï¼Œå› æ­¤éœ€è¦ä¿è¯æµé‡å¯ä»¥ä»è·¯ç”±è‡³è¯¥ç«¯å£ï¼ˆå³ istio-ingressgateway Service çš„ Endpoint ç«¯å£ä¸­ä¹ŸåŒæ ·ä¸º 80ï¼‰</em></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">    <span class="attr">servers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">      <span class="attr">port:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">        <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºçš„ VirtualServiceï¼Œç»‘å®šäº†ä¸Šé¢åˆ›å»ºçš„ Gatewayï¼Œæœ¬è´¨ä¸Šæ˜¯å°†åŒ¹é…åˆ°çš„è·¯ç”±å®šå‘åˆ° productpage Service çš„ 9080 ç«¯å£ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">gateways:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bookinfo-gateway</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">/productpage</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">          <span class="attr">prefix:</span> <span class="string">/static</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">/login</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">/logout</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">          <span class="attr">prefix:</span> <span class="string">/api/v1/products</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">productpage</span></span><br><span class="line">          <span class="attr">port:</span></span><br><span class="line">            <span class="attr">number:</span> <span class="number">9080</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è®¿é—® <code>http://178.104.162.69:31235/productpage</code>ï¼Œreview éƒ¨åˆ†åœ¨ v1, v2, v3 ç‰ˆæœ¬å¹³å‡åˆ‡æ¢</p><p><em>å…¶å®å¯ä»¥çœ‹åˆ° VirtualService å°†æµé‡è·¯ç”±åˆ° productpage çš„ Service åï¼Œæ­¤åçš„æµé‡çš„è·¯å¾„è¿˜æ˜¯ K8s åŸç”Ÿçš„è·¯ç”±æ–¹å¼</em></p><h2 id="åˆ›å»º-DestinationRule"><a href="#åˆ›å»º-DestinationRule" class="headerlink" title="åˆ›å»º DestinationRule"></a>åˆ›å»º DestinationRule</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get destinationrule</span></span><br><span class="line">NAME          HOST          AGE</span><br><span class="line">details       details       4m41s</span><br><span class="line">productpage   productpage   4m42s</span><br><span class="line">ratings       ratings       4m41s</span><br><span class="line">reviews       reviews       4m41s</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ BookInfo çš„ VirtualService åªæ˜¯å°†æµé‡è½¬å‘åˆ° productpage ä¸Šï¼Œè€Œ productpage åªæœ‰ v1 ç‰ˆæœ¬ï¼Œå…¶ä»– DestinationRule åªæ˜¯åˆ›å»ºï¼Œæœªè¢«å¼•ç”¨ï¼Œå¯ä»¥ç†è§£æˆ DestinationRule æ³¨å†Œäº† productpage çš„ v1 ç‰ˆæœ¬ä»¥åŠ reviews çš„ v1ï¼Œv2 å’Œ v3 ç‰ˆæœ¬ï¼Œå¦‚æœåç»­éœ€è¦ä½¿ç”¨ï¼Œéœ€è¦åˆ›å»º VirtualService è·¯ç”±æµé‡ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">productpage</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v3</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure><p>ç”±äºæ²¡æœ‰ VirtualService è·¯ç”±è®¿é—® Service çš„æµé‡ï¼Œå› æ­¤ï¼Œæ­¤æ—¶è®¿é—®é¡µé¢ï¼Œé¡µé¢ä¸­ Review å¾®æœåŠ¡è¿˜æ˜¯ä¼šä¸‰ä¸ªç‰ˆæœ¬å¹³å‡åˆ‡æ¢çš„ã€‚</p><h2 id="åˆ›å»ºæ™ºèƒ½è·¯ç”±çš„-VirtualService"><a href="#åˆ›å»ºæ™ºèƒ½è·¯ç”±çš„-VirtualService" class="headerlink" title="åˆ›å»ºæ™ºèƒ½è·¯ç”±çš„ VirtualService"></a>åˆ›å»ºæ™ºèƒ½è·¯ç”±çš„ VirtualService</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get virtualservice</span></span><br><span class="line">NAME          GATEWAYS               HOSTS             AGE</span><br><span class="line">bookinfo      [&quot;bookinfo-gateway&quot;]   [&quot;*&quot;]             5d22h</span><br><span class="line">details                              [&quot;details&quot;]       114s</span><br><span class="line">productpage                          [&quot;productpage&quot;]   114s</span><br><span class="line">ratings                              [&quot;ratings&quot;]       114s</span><br><span class="line">reviews                              [&quot;reviews&quot;]       114s</span><br></pre></td></tr></table></figure><p>åˆ›å»ºçš„ VirtualService çš„æœ¬è´¨ä¸Šæ˜¯å°†è®¿é—®å„ç»„ä»¶çš„æ‰€æœ‰çš„æµé‡è·¯ç”±è‡³å¯¹åº”çš„ v1 ç‰ˆæœ¬ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">productpage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">productpage</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">productpage</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è®¿é—®é¡µé¢ï¼Œé¡µé¢ä¸­çš„ Review åªä¼šæœ‰ v1 ç‰ˆæœ¬æ ·å¼ï¼Œå³æ²¡æœ‰ä»»ä½•æ˜Ÿæ˜Ÿã€‚</p>]]></content>
    
    
    <summary type="html">åˆè¯† Service Meshï¼Œå€ŸåŠ© Bookinfo ç¤ºä¾‹ï¼Œç®€å•ä¸Šæ‰‹ Istio ä½¿ç”¨</summary>
    
    
    
    <category term="Service Mesh" scheme="http://shenxianghong.github.io/categories/Service-Mesh/"/>
    
    
    <category term="Istio" scheme="http://shenxianghong.github.io/tags/Istio/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Golang ã€ä¼˜é›…å¤„ç†æšä¸¾ç±»å‹</title>
    <link href="http://shenxianghong.github.io/2022/04/21/2022-04-21%20Golang%20%E4%BC%98%E9%9B%85%E5%A4%84%E7%90%86%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B/"/>
    <id>http://shenxianghong.github.io/2022/04/21/2022-04-21%20Golang%20%E4%BC%98%E9%9B%85%E5%A4%84%E7%90%86%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B/</id>
    <published>2022-04-20T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.171Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="100" style="border: 0px" src="/gallery/golang/logo.svg"></div><hr><h1 id="Open-Source"><a href="#Open-Source" class="headerlink" title="Open Source"></a>Open Source</h1><p><a href="https://github.com/vmware-tanzu/velero%EF%BC%88Backup">https://github.com/vmware-tanzu/veleroï¼ˆBackup</a> and migrate Kubernetes applications and their persistent volumesï¼‰ã€‚æ˜¯ç”¨äºå¤‡ä»½ä¸æ¢å¤é›†ç¾¤èµ„æºçš„å·¥å…·ï¼Œæ”¯æŒå‘½ä»¤è¡Œæ“ä½œã€‚å…¶ä¸­å…³äºå‘½ä»¤è¡Œä¼ å…¥çš„æšä¸¾å‚æ•°ä½œäº†ä¼˜é›…æ ¡éªŒã€‚</p><h1 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h1><p><a href="https://github.com/shenxianghong/shenxianghong.github.io/tree/main/elegant-coding/enum">https://github.com/shenxianghong/shenxianghong.github.io/tree/main/elegant-coding/enum</a></p><h1 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h1><h2 id="enum-go"><a href="#enum-go" class="headerlink" title="enum.go"></a>enum.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/pkg/errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enum is a Cobra-compatible wrapper for defining a string flag that can be one of a specified set of values.</span></span><br><span class="line"><span class="keyword">type</span> Enum <span class="keyword">struct</span> &#123;</span><br><span class="line">allowedValues []<span class="type">string</span></span><br><span class="line">value         <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewEnum returns a new enum flag with the specified list of allowed values, and the specified default value if none is set.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewEnum</span><span class="params">(defaultValue <span class="type">string</span>, allowedValues ...<span class="type">string</span>)</span></span> *Enum &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Enum&#123;</span><br><span class="line">allowedValues: allowedValues,</span><br><span class="line">value:         defaultValue,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// String returns a string representation of the enum flag.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Enum)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> e.value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set assigns the provided string to the enum receiver. It returns an error if the string is not an allowed value.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Enum)</span></span> Set(s <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, val := <span class="keyword">range</span> e.allowedValues &#123;</span><br><span class="line"><span class="keyword">if</span> val == s &#123;</span><br><span class="line">e.value = s</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> errors.Errorf(<span class="string">&quot;invalid value: %q&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Type returns a string representation of the Enum type.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Enum)</span></span> Type() <span class="type">string</span> &#123;</span><br><span class="line"><span class="comment">// we don&#x27;t want the help text to display anything regarding</span></span><br><span class="line"><span class="comment">// the type because the usage text for the flag should capture</span></span><br><span class="line"><span class="comment">// the possible options.</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AllowedValues returns a slice of the flag&#x27;s valid values.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Enum)</span></span> AllowedValues() []<span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> e.allowedValues</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°è£…äº†æšä¸¾ç±»å‹ï¼ŒåŒ…å«é»˜è®¤å€¼ä»¥åŠå…è®¸çš„æšä¸¾å€¼ï¼ŒEnum ç»“æ„ä½“å®ç°äº† pflag çš„ Value æ¥å£ï¼ˆString()ï¼ŒSet()ï¼ŒType()ï¼‰ï¼Œåœ¨æ‰§è¡Œ flags.StringSliceVar ç­‰æ“ä½œæ—¶ï¼Œpflag ä¼šè°ƒç”¨ Set å‡½æ•°è®¾ç½®å€¼ï¼Œå› æ­¤ Set å¯ä»¥ç”¨äºæ ¡éªŒæšä¸¾å€¼çš„åˆæ³•æ€§ã€‚</p><h2 id="format-flag-go"><a href="#format-flag-go" class="headerlink" title="format_flag.go"></a>format_flag.go</h2><p>å®šä¹‰äº†æ—¥å¿—æ ¼å¼çš„æšä¸¾å€¼ã€é»˜è®¤å€¼ä»¥åŠå¯¹å¤–çš„å·¥å‚å‡½æ•°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// Format is a string representation of the desired output format for logs</span></span><br><span class="line"><span class="keyword">type</span> Format <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">FormatText   Format = <span class="string">&quot;text&quot;</span></span><br><span class="line">FormatJSON   Format = <span class="string">&quot;json&quot;</span></span><br><span class="line">defaultValue Format = FormatText</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// FormatFlag is a command-line flag for setting the logrus</span></span><br><span class="line"><span class="comment">// log format.</span></span><br><span class="line"><span class="keyword">type</span> FormatFlag <span class="keyword">struct</span> &#123;</span><br><span class="line">*Enum</span><br><span class="line">defaultValue Format</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewFormatFlag constructs a new log level flag.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFormatFlag</span><span class="params">()</span></span> *FormatFlag &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;FormatFlag&#123;</span><br><span class="line">Enum: NewEnum(</span><br><span class="line"><span class="type">string</span>(defaultValue),</span><br><span class="line"><span class="type">string</span>(FormatText),</span><br><span class="line"><span class="type">string</span>(FormatJSON),</span><br><span class="line">),</span><br><span class="line">defaultValue: defaultValue,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Parse returns the flag&#x27;s value as a Format.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FormatFlag)</span></span> Parse() Format &#123;</span><br><span class="line"><span class="keyword">return</span> Format(f.String())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="level-flags-go"><a href="#level-flags-go" class="headerlink" title="level_flags.go"></a>level_flags.go</h2><p>åŸç†ç±»ä¼¼ format_flag.goã€‚</p><h2 id="default-logger-go"><a href="#default-logger-go" class="headerlink" title="default_logger.go"></a>default_logger.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/sirupsen/logrus&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultLogger returns a Logger with the default properties.</span></span><br><span class="line"><span class="comment">// The desired output format is passed as a LogFormat Enum.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DefaultLogger</span><span class="params">(level logrus.Level, format Format)</span></span> *logrus.Logger &#123;</span><br><span class="line">logger := logrus.New()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> format == FormatJSON &#123;</span><br><span class="line">logger.Formatter = <span class="built_in">new</span>(logrus.JSONFormatter)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make sure the output is set to stdout so log messages don&#x27;t show up as errors in cloud log dashboards.</span></span><br><span class="line">logger.Out = os.Stdout</span><br><span class="line"></span><br><span class="line">logger.Level = level</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> logger</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®ä¼ å…¥çš„æšä¸¾å€¼ï¼Œåˆå§‹åŒ–ä¸€äº›ä¸Šå±‚ä½¿ç”¨çš„å¯¹è±¡ã€‚</p><h2 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h2><p>ä¸Šå±‚ç”¨æ³•å‚è€ƒã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">logLevelFlag := LogLevelFlag()</span><br><span class="line">formatFlag := NewFormatFlag()</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">&quot;The level at which to log. Valid values are %s.\n&quot;</span>, strings.Join(logLevelFlag.AllowedValues(), <span class="string">&quot;, &quot;</span>))</span><br><span class="line">fmt.Printf(<span class="string">&quot;The format for log output. Valid values are %s.\n&quot;</span>, strings.Join(formatFlag.AllowedValues(), <span class="string">&quot;, &quot;</span>))</span><br><span class="line"></span><br><span class="line">logLevel := logLevelFlag.Parse()</span><br><span class="line">format := FormatJSON</span><br><span class="line"></span><br><span class="line">logger := DefaultLogger(logLevel, format)</span><br><span class="line">logger.Infof(<span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">è®°ä¸€æ¬¡åœ¨ Velero é¡¹ç›®ä¸­å­¦åˆ°çš„ç»“åˆ Cobra ä¸ Pflag å¤„ç†æšä¸¾ç±»å‹å‚æ•°çš„æ–¹å¼</summary>
    
    
    
    <category term="Programming" scheme="http://shenxianghong.github.io/categories/Programming/"/>
    
    
    <category term="Golang" scheme="http://shenxianghong.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kubebuilder ã€å¿«é€Ÿå¼€å§‹</title>
    <link href="http://shenxianghong.github.io/2022/04/13/2022-04-13%20Kubebuilder%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"/>
    <id>http://shenxianghong.github.io/2022/04/13/2022-04-13%20Kubebuilder%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/</id>
    <published>2022-04-12T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.170Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="150" style="border: 0px" src="/gallery/kubebuilder/logo.png"></div><hr><blockquote><p>based on <strong>v3.3.0</strong></p></blockquote><h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p><a href="https://github.com/kubernetes-sigs/kubebuilder">Kubebuilder</a> æ˜¯ä¸€ä¸ªåŸºäº CRD æ¥æ„å»º Kubernetes API çš„æ¡†æ¶ï¼Œå¯ä»¥ä½¿ç”¨ CRD æ¥æ„å»º APIã€Controller å’Œ Admission Webhookã€‚ç±»ä¼¼äº Ruby on Rails å’Œ SpringBoot ä¹‹ç±»çš„ Web å¼€å‘æ¡†æ¶ï¼ŒKubebuilder å¯ä»¥æé«˜é€Ÿåº¦å¹¶é™ä½å¼€å‘äººå‘˜ç®¡ç†çš„å¤æ‚æ€§ï¼Œä»¥ä¾¿åœ¨ Golang ä¸­å¿«é€Ÿæ„å»ºå’Œå‘å¸ƒ Kubernetes APIã€‚å®ƒå»ºç«‹åœ¨ç”¨äºæ„å»ºæ ¸å¿ƒ Kubernetes API çš„è§„èŒƒæŠ€æœ¯çš„åŸºç¡€ä¹‹ä¸Šï¼Œä»¥æä¾›å‡å°‘æ ·æ¿å’Œéº»çƒ¦çš„ç®€å•æŠ½è±¡ã€‚</p><p>ä¸ Kubebuilder ç±»ä¼¼çš„é¡¹ç›®è¿˜æœ‰ <a href="https://github.com/operator-framework/operator-sdk">Operator SDK</a>ï¼Œä¸¤è€…çš„åŒºåˆ«å¯ä»¥å‚è€ƒ <a href="https://github.com/operator-framework/operator-sdk/issues/1758%EF%BC%8C%E7%9B%AE%E5%89%8D%E4%B8%A4%E4%B8%AA%E7%A4%BE%E5%8C%BA%E7%9A%84%E5%9C%A8%E5%81%9A%E5%8A%9F%E8%83%BD%E6%95%B4%E5%90%88%E3%80%82">https://github.com/operator-framework/operator-sdk/issues/1758ï¼Œç›®å‰ä¸¤ä¸ªç¤¾åŒºçš„åœ¨åšåŠŸèƒ½æ•´åˆã€‚</a></p><p>Where they differ is:</p><ul><li>Operator SDK also has support for Ansible and Helm operators, which make it easy to write operators without having to learn Go and if you already have experience with Ansible or Helm</li><li>Operator SDK includes integrations with the Operator Lifecycle Manager (OLM), which is a key component of the Operator Framework that is important to Day 2 cluster operations, like managing a live upgrade of your operator.</li><li>Operator SDK includes a scorecard subcommand that helps you understand if your operator follows best practices.</li><li>Operator SDK includes an e2e testing framework that simplifies testing your operator against an actual cluster.</li><li>Kubebuilder includes an envtest package that allows operator developers to run simple tests with a standalone etcd and apiserver.</li><li>Kubebuilder scaffolds a Makefile to assist users in operator tasks (build, test, run, code generation, etc.); Operator SDK is currently using built-in subcommands. Each has pros and cons. The SDK team will likely be migrating to a Makefile-based approach in the future.</li><li>Kubebuilder uses Kustomize to build deployment manifests; Operator SDK uses static files with placeholders.</li><li>Kubebuilder has recently improved its support for admission and CRD conversion webhooks, which has not yet made it into SDK.</li></ul><p><a href="https://github.com/kubernetes/code-generator">Code Generator</a> æ˜¯ç”¨äºå®ç° Kubernetes é£æ ¼ API ç±»å‹çš„ Golang ä»£ç ç”Ÿæˆå™¨ã€‚å¯ä»¥åˆ©ç”¨è¯¥å·¥ç¨‹è‡ªåŠ¨ç”ŸæˆæŒ‡å®šK8s èµ„æºçš„ clientsetã€informers å’Œ listers API æ¥å£ï¼Œæœ¬èº«æ˜¯ä½äº Kubernetes é¡¹ç›®ä¸­çš„å·¥å…·ï¼Œå†…éƒ¨åŒ…å«äº†å¤§é‡çš„ç”Ÿæˆå™¨ï¼Œä¾‹å¦‚ client-genï¼Œdeepcopy-genï¼Œinformer-genï¼Œlister-gen ç­‰ç­‰ã€‚</p><ul><li><p>deepcopy-gen</p><p>ç”Ÿæˆæ·±åº¦æ‹·è´å¯¹è±¡æ–¹æ³•ï¼Œä¾‹å¦‚ DeepCopyï¼ŒDeepCopyObjectï¼ŒDeepCopyInto ç­‰</p></li><li><p>client-gen</p><p>ç”Ÿæˆ clientSet å¯¹è±¡ï¼Œä¸ºèµ„æºç”Ÿæˆæ ‡å‡†çš„æ“ä½œæ–¹æ³•ï¼Œå¦‚ getï¼Œlistï¼Œwatchï¼Œcreateï¼Œupdateï¼Œpatch å’Œ delete</p></li><li><p>informer-gen</p><p>ç”Ÿæˆ informer å¯¹è±¡ï¼Œæä¾›äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼Œå¦‚ AddFuncï¼ŒUpdateFuncï¼ŒDeleteFunc</p></li><li><p>lister-gen</p><p>ç”Ÿæˆ lister å¯¹è±¡ï¼Œä¸º get å’Œ list æ–¹æ³•æä¾›åªè¯»ç¼“å­˜å±‚</p></li></ul><p>Kubebuilder ä¸ Code Generator éƒ½å¯ä»¥ä¸º CRD ç”Ÿæˆ Kubernetes API ç›¸å…³ä»£ç ï¼Œä»ä»£ç ç”Ÿæˆå±‚é¢æ¥è®²ï¼Œ ä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼š</p><ul><li>Kubebuilder ä¸ä¼šç”Ÿæˆ informersã€listersã€clientsetsï¼Œè€Œ Code Generator ä¼š</li><li>Kubebuilder ä¼šç”Ÿæˆ Controllerã€Admission Webhooksï¼Œè€Œ Code Generator ä¸ä¼š</li><li>Kubebuilder ä¼šç”Ÿæˆ manifests yamlï¼Œè€Œ Code Generator ä¸ä¼š</li><li>Kubebuilder è¿˜å¸¦æœ‰ä¸€äº›å…¶ä»–ä¾¿åˆ©æ€§è®¾æ–½</li></ul><h1 id="Kubebuilder"><a href="#Kubebuilder" class="headerlink" title="Kubebuilder"></a>Kubebuilder</h1><h2 id="ç¯å¢ƒè¦æ±‚"><a href="#ç¯å¢ƒè¦æ±‚" class="headerlink" title="ç¯å¢ƒè¦æ±‚"></a>ç¯å¢ƒè¦æ±‚</h2><ul><li><a href="https://golang.org/dl/">go</a> version v1.15+ (kubebuilder v3.0 &lt; v3.1).</li><li><a href="https://golang.org/dl/">go</a> version v1.16+ (kubebuilder v3.1 &lt; v3.3).</li><li><a href="https://golang.org/dl/">go</a> version v1.17+ (kubebuilder v3.3+).</li><li><a href="https://docs.docker.com/install/">docker</a> version 17.03+.</li><li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> version v1.11.3+.</li><li>Access to a Kubernetes v1.11.3+ cluster.</li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/$(go <span class="built_in">env</span> GOOS)/$(go <span class="built_in">env</span> GOARCH)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">chmod</span> +x kubebuilder &amp;&amp; <span class="built_in">mv</span> kubebuilder /usr/local/bin/</span></span><br></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><p>é¦–å…ˆå€ŸåŠ© Kubebuilder åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubebuilder init --domain huayun.io --repo huayun.io/ake/android-operator --owner AKE --project-name android-operator</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ default</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ manager_auth_proxy_patch.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ manager_config_patch.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ manager</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ controller_manager_config.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ manager.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ prometheus</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ monitor.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ rbac</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ auth_proxy_client_clusterrole.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ auth_proxy_role_binding.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ auth_proxy_role.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ auth_proxy_service.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ leader_election_role_binding.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ leader_election_role.yaml</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ role_binding.yaml</span><br><span class="line">â”‚Â Â      â””â”€â”€ service_account.yaml</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ hack</span><br><span class="line">â”‚Â Â  â””â”€â”€ boilerplate.go.txt</span><br><span class="line">â”œâ”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â””â”€â”€ PROJECT</span><br><span class="line"></span><br><span class="line">6 directories, 24 files</span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“component-config</td><td></td></tr><tr><td>â€“domain</td><td>group çš„ domain ä¿¡æ¯ï¼Œé»˜è®¤ä¸º my.domain</td></tr><tr><td>â€“fetch-deps</td><td>ç¡®ä¿ä¾èµ–å·²ä¸‹è½½ï¼Œé»˜è®¤ä¸º true</td></tr><tr><td>â€“license</td><td>boilerplate.txt ä¸­ä½¿ç”¨çš„ licenseï¼Œå¯é€‰çš„æœ‰ apache2 å’Œ noneï¼Œé»˜è®¤ä¸º apache2</td></tr><tr><td>â€“owner</td><td>copyright ä¸­çš„æ‰€æœ‰è€…åç§°</td></tr><tr><td>â€“project-name</td><td>é¡¹ç›®åç§°</td></tr><tr><td>â€“project-version</td><td>é¡¹ç›®ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º 3</td></tr><tr><td>â€“repo</td><td>go module ä¸­çš„ module åç§°</td></tr><tr><td>â€“skip-go-version-check</td><td>å¦‚æœæŒ‡å®šï¼Œåˆ™è·³è¿‡ Golang ç‰ˆæœ¬æ£€æŸ¥</td></tr></tbody></table><h2 id="ç”Ÿæˆ-API"><a href="#ç”Ÿæˆ-API" class="headerlink" title="ç”Ÿæˆ API"></a>ç”Ÿæˆ API</h2><p>è®¾ç½® Kubebuilder å¼€å¯ multigroupï¼Œå³ api æ”¯æŒå¤š groupï¼Œä¾‹å¦‚ apps&#x2F;policyï¼Œapps&#x2F;admission ç­‰ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubebuilder edit --multigroup=<span class="literal">true</span></span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“multigroup</td><td>æ˜¯å¦å¯ç”¨å¤š api group ç»„</td></tr></tbody></table><p>ç”Ÿæˆ CRD API å¯¹è±¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubebuilder create api --group android --version v1 --kind AnFile --controller --resource --namespaced --plural anfiles</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubebuilder create api --group android --version v1 --kind AnImage --controller --resource --namespaced --plural animages</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“controller</td><td>æ˜¯å¦ä¸è¯¢é—®é»˜è®¤ç”Ÿæˆ controllerï¼Œé»˜è®¤ä¸º true</td></tr><tr><td>â€“force</td><td>å¼ºåˆ¶ç”Ÿæˆèµ„æº</td></tr><tr><td>â€“group</td><td>èµ„æº group ç»„ï¼Œä¾‹å¦‚ storageï¼Œevents ç­‰ï¼Œæœ€ç»ˆä¼šå’Œ domain ä¸€èµ·ä½œä¸º api group ä¿¡æ¯</td></tr><tr><td>â€“kind</td><td>èµ„æº kind ä¿¡æ¯ï¼Œå³èµ„æºåç§°ï¼Œå¦‚ Podï¼ŒService ç­‰</td></tr><tr><td>â€“make</td><td>ç”Ÿæˆæ–‡ä»¶åï¼Œæ˜¯å¦æ‰§è¡Œä¸€æ¬¡ make generateï¼Œé»˜è®¤ä¸º true</td></tr><tr><td>â€“namespaced</td><td>æ˜¯å¦æ˜¯å‘½åç©ºé—´çº§åˆ«çš„èµ„æº</td></tr><tr><td>â€“plural</td><td>èµ„æºçš„å¤æ•°ä¿¡æ¯</td></tr><tr><td>â€“resource</td><td>æ˜¯å¦ä¸è¯¢é—®é»˜è®¤ç”Ÿæˆ resourceï¼Œé»˜è®¤ä¸º true</td></tr><tr><td>â€“version</td><td>èµ„æºç‰ˆæœ¬ä¿¡æ¯ï¼Œå¦‚ v1ï¼Œv1beta1</td></tr></tbody></table><p>æœ€ç»ˆçš„èµ„æºç»“æ„ä¸º</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">android.huayun.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AnImage</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">animage-sample</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># TODO(user): Add fields here</span></span><br></pre></td></tr></table></figure><p>make manifest ä¼šåœ¨ .&#x2F;config&#x2F;crd&#x2F;bases ä¸‹æ ¹æ® API å£°æ˜ä¿¡æ¯ç”Ÿæˆ CRD çš„åŸºç¡€æ¨¡æ¿ï¼Œåœ¨ API å˜åŠ¨åéœ€è¦æ›´æ–°ã€‚</p><h2 id="ç”Ÿæˆ-webhook"><a href="#ç”Ÿæˆ-webhook" class="headerlink" title="ç”Ÿæˆ webhook"></a>ç”Ÿæˆ webhook</h2><p>TODO</p><h2 id="ç›®å½•ç»“æ„"><a href="#ç›®å½•ç»“æ„" class="headerlink" title="ç›®å½•ç»“æ„"></a>ç›®å½•ç»“æ„</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree</span></span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ apis</span><br><span class="line">â”‚Â Â  â””â”€â”€ android</span><br><span class="line">â”‚Â Â      â””â”€â”€ v1</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ anfile_types.go</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ animage_types.go</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ groupversion_info.go</span><br><span class="line">â”‚Â Â          â””â”€â”€ zz_generated.deepcopy.go</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â””â”€â”€ controller-gen</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ crd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomizeconfig.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ patches</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ cainjection_in_anfiles.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ cainjection_in_animages.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ webhook_in_anfiles.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ webhook_in_animages.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ default</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ manager_auth_proxy_patch.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ manager_config_patch.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ manager</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ controller_manager_config.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ manager.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ prometheus</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ monitor.yaml</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ rbac</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ anfile_editor_role.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ anfile_viewer_role.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ animage_editor_role.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ animage_viewer_role.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ auth_proxy_client_clusterrole.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ auth_proxy_role_binding.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ auth_proxy_role.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ auth_proxy_service.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kustomization.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ leader_election_role_binding.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ leader_election_role.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ role_binding.yaml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ service_account.yaml</span><br><span class="line">â”‚Â Â  â””â”€â”€ samples</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ android_v1_anfile.yaml</span><br><span class="line">â”‚Â Â      â””â”€â”€ android_v1_animage.yaml</span><br><span class="line">â”œâ”€â”€ controllers</span><br><span class="line">â”‚Â Â  â””â”€â”€ android</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ anfile_controller.go</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ animage_controller.go</span><br><span class="line">â”‚Â Â      â””â”€â”€ suite_test.go</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ go.mod</span><br><span class="line">â”œâ”€â”€ go.sum</span><br><span class="line">â”œâ”€â”€ hack</span><br><span class="line">â”‚Â Â  â””â”€â”€ boilerplate.go.txt</span><br><span class="line">â”œâ”€â”€ main.go</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â””â”€â”€ PROJECT</span><br><span class="line"></span><br><span class="line">15 directories, 44 files</span><br></pre></td></tr></table></figure><h2 id="Markers"><a href="#Markers" class="headerlink" title="Markers"></a>Markers</h2><p>Kubebuilder æä¾›äº†ä¼—å¤š Markersï¼Œæ”¯æŒå¯¹ CRD çš„æ ¡éªŒï¼Œç”Ÿæˆç­‰æ“ä½œï¼Œå…·ä½“å¯ä»¥å‚è€ƒ<a href="https://book.kubebuilder.io/reference/markers.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p><h1 id="Code-Generator"><a href="#Code-Generator" class="headerlink" title="Code Generator"></a>Code Generator</h1><p>å‚è€ƒäº† Kubernetesï¼ŒVelero ç­‰å¼€æºé¡¹ç›®é£æ ¼ï¼Œå°† apis ç›®å½•ç§»è‡³ pkg å±‚çº§ä¸‹ã€‚</p><h2 id="æ–‡ä»¶å‡†å¤‡"><a href="#æ–‡ä»¶å‡†å¤‡" class="headerlink" title="æ–‡ä»¶å‡†å¤‡"></a>æ–‡ä»¶å‡†å¤‡</h2><h3 id="doc-go"><a href="#doc-go" class="headerlink" title="doc.go"></a>doc.go</h3><p>åœ¨ pkg&#x2F;apis&#x2F;android&#x2F;v1 ç›®å½•ä¸‹åˆ›å»º doc.go æ–‡ä»¶ï¼Œå‚è€ƒå†…å®¹å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// +k8s:deepcopy-gen=package</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Package v1 is the v1 version of the API.</span></span><br><span class="line"><span class="comment">// +groupName=android.huayun.io</span></span><br><span class="line"><span class="keyword">package</span> v1</span><br></pre></td></tr></table></figure><ul><li>groupName çš„åç§°ä¸º &lt;group&gt;.&lt;domain&gt;</li></ul><h3 id="register-go"><a href="#register-go" class="headerlink" title="register.go"></a>register.go</h3><p>åœ¨ pkg&#x2F;apis&#x2F;android&#x2F;v1 ç›®å½•ä¸‹åˆ›å»º register.go æ–‡ä»¶ï¼Œå‚è€ƒå†…å®¹å¦‚ä¸‹</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> v1</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/runtime/schema&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SchemeGroupVersion is group version used to register these objects.</span></span><br><span class="line"><span class="keyword">var</span> SchemeGroupVersion = GroupVersion</span><br><span class="line"></span><br><span class="line"><span class="comment">// Resource takes an unqualified resource and returns a Group qualified GroupResource</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Resource</span><span class="params">(resource <span class="type">string</span>)</span></span> schema.GroupResource &#123;</span><br><span class="line">    <span class="keyword">return</span> SchemeGroupVersion.WithResource(resource).GroupResource()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="lt-CRD-gt-types-go"><a href="#lt-CRD-gt-types-go" class="headerlink" title="&lt;CRD&gt;_types.go"></a>&lt;CRD&gt;_types.go</h3><p>ä»¥ pkg&#x2F;apis&#x2F;android&#x2F;v1&#x2F;animage_types.go ä¸ºä¾‹ï¼Œæ–°å¢ä»¥ä¸‹ tag ä¿¡æ¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Copyright 2022 AKE.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment">you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment">You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">limitations under the License.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> v1</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">metav1 <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// EDIT THIS FILE!  THIS IS SCAFFOLDING FOR YOU TO OWN!</span></span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> json tags are required.  Any new fields you add must have json tags for the fields to be serialized.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AnImageSpec defines the desired state of AnImage</span></span><br><span class="line"><span class="keyword">type</span> AnImageSpec <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster</span></span><br><span class="line"><span class="comment">// Important: Run &quot;make&quot; to regenerate code after modifying this file</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Foo is an example field of AnImage. Edit animage_types.go to remove/update</span></span><br><span class="line">Foo <span class="type">string</span> <span class="string">`json:&quot;foo,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AnImageStatus defines the observed state of AnImage</span></span><br><span class="line"><span class="keyword">type</span> AnImageStatus <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster</span></span><br><span class="line"><span class="comment">// Important: Run &quot;make&quot; to regenerate code after modifying this file</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// +genclient</span></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span></span><br><span class="line"><span class="comment">// +kubebuilder:object:root=true</span></span><br><span class="line"><span class="comment">// +kubebuilder:subresource:status</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AnImage is the Schema for the animages API</span></span><br><span class="line"><span class="keyword">type</span> AnImage <span class="keyword">struct</span> &#123;</span><br><span class="line">metav1.TypeMeta   <span class="string">`json:&quot;,inline&quot;`</span></span><br><span class="line">metav1.ObjectMeta <span class="string">`json:&quot;metadata,omitempty&quot;`</span></span><br><span class="line"></span><br><span class="line">Spec   AnImageSpec   <span class="string">`json:&quot;spec,omitempty&quot;`</span></span><br><span class="line">Status AnImageStatus <span class="string">`json:&quot;status,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</span></span><br><span class="line"><span class="comment">// +kubebuilder:object:root=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// AnImageList contains a list of AnImage</span></span><br><span class="line"><span class="keyword">type</span> AnImageList <span class="keyword">struct</span> &#123;</span><br><span class="line">metav1.TypeMeta <span class="string">`json:&quot;,inline&quot;`</span></span><br><span class="line">metav1.ListMeta <span class="string">`json:&quot;metadata,omitempty&quot;`</span></span><br><span class="line">Items           []AnImage <span class="string">`json:&quot;items&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">SchemeBuilder.Register(&amp;AnImage&#123;&#125;, &amp;AnImageList&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨ AnImage struct ä¸Šï¼Œæ–°å¢ <code>+genclient</code></li><li>åœ¨ AnImage å’Œ AnImageList struct ä¸Šï¼Œæ–°å¢ <code>+k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</code></li></ul><h3 id="tools-go"><a href="#tools-go" class="headerlink" title="tools.go"></a>tools.go</h3><p>è¯¥æ–‡ä»¶ä¸»è¦ç”¨äºè¿½è¸ªæ„å»ºé˜¶æ®µæ‰€éœ€çš„ä¾èµ–åŒ…ï¼Œè€Œéè¿è¡Œé˜¶æ®µï¼Œå› æ­¤ï¼Œæ–‡ä»¶ä½ç½®ã€åç§°å’Œå†…å®¹ç­‰ä¿¡æ¯æ ¹æ®å…·ä½“æƒ…å†µè€Œå®šã€‚</p><p>åœ¨ hack ç›®å½•ä¸‹åˆ›å»º tools.go æ–‡ä»¶ï¼Œå‚è€ƒå†…å®¹å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:build tools</span></span><br><span class="line"><span class="comment">// +build tools</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> tools</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;k8s.io/code-generator&quot;</span></span><br></pre></td></tr></table></figure><h3 id="update-codegen-sh"><a href="#update-codegen-sh" class="headerlink" title="update-codegen.sh"></a>update-codegen.sh</h3><p>è¯¥æ–‡ä»¶ç”¨äºè°ƒç”¨ Code Generator çš„ generate-groups.sh è„šæœ¬ï¼Œç”Ÿæˆä»£ç ã€‚å‚è€ƒå†…å®¹å¦‚ä¸‹ï¼Œé€»è¾‘å‚è€ƒè„šæœ¬æ³¨é‡Š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/env bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#Copyright 2022 AKE.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">you may not use this file except <span class="keyword">in</span> compliance with the License.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    http://www.apache.org/licenses/LICENSE-2.0</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#Unless required by applicable law or agreed to in writing, software</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">distributed under the License is distributed on an <span class="string">&quot;AS IS&quot;</span> BASIS,</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">limitations under the License.</span></span><br><span class="line"></span><br><span class="line">set -o errexit</span><br><span class="line">set -o nounset</span><br><span class="line">set -o pipefail</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">this script expects to be run from the root of the android-operator repo.</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Corresponding to go mod init &lt;module&gt;.</span></span><br><span class="line">MODULE=huayun.io/ake/android-operator</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Corresponding to kubebuilder create api --group &lt;group&gt; --version &lt;version&gt;.</span></span><br><span class="line">GROUP_VERSION=android:v1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Generated output package.</span></span><br><span class="line">OUTPUT_PKG=pkg/generated</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">API package.</span></span><br><span class="line">APIS_PKG=pkg/apis</span><br><span class="line"></span><br><span class="line">SCRIPT_ROOT=$(dirname &quot;$&#123;BASH_SOURCE[0]&#125;&quot;)/..</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Sync k8s.io/code-generator to go.mod</span></span><br><span class="line">go mod tidy </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Grab code-generator version from go.mod.</span></span><br><span class="line">CODEGEN_VERSION=$(grep &#x27;k8s.io/code-generator&#x27; go.mod | awk &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">CODEGEN_PKG=$(go env GOPATH)/pkg/mod/k8s.io/code-generator@$&#123;CODEGEN_VERSION&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Prepare code-generator.</span></span><br><span class="line">if [[ ! -d $&#123;CODEGEN_PKG&#125; ]]; then</span><br><span class="line">    echo &quot;$&#123;CODEGEN_PKG&#125; is missing. Running &#x27;go mod download&#x27;.&quot;</span><br><span class="line">    go mod download</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">echo &quot;&gt;&gt; Using $&#123;CODEGEN_PKG&#125;&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">code-generator does work with go.mod but makes assumptions about</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">the project living <span class="keyword">in</span> `<span class="variable">$GOPATH</span>/src`. To work around this and support</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">any location; create a temporary directory, use this as an output</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">base, and copy everything back once generated.</span></span><br><span class="line">TEMP_DIR=$(mktemp -d)</span><br><span class="line">cleanup() &#123;</span><br><span class="line">    echo &quot;&gt;&gt; Removing $&#123;TEMP_DIR&#125;&quot;</span><br><span class="line">    rm -rf &quot;$&#123;TEMP_DIR&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line">trap &quot;cleanup&quot; EXIT SIGINT</span><br><span class="line"></span><br><span class="line">echo &quot;&gt;&gt; Temporary output directory $&#123;TEMP_DIR&#125;&quot;</span><br><span class="line"></span><br><span class="line">chmod +x &quot;$&#123;CODEGEN_PKG&#125;&quot;/generate-groups.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">generate the code with:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--output-base    because this script should also be able to run inside the vendor <span class="built_in">dir</span> of</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">                 k8s.io/kubernetes. The output-base is needed <span class="keyword">for</span> the generators to output into the vendor <span class="built_in">dir</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">                 instead of the <span class="variable">$GOPATH</span> directly. For normal projects this can be dropped.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;SCRIPT_ROOT&#125;</span>&quot;</span></span></span><br><span class="line">&quot;$&#123;CODEGEN_PKG&#125;&quot;/generate-groups.sh \</span><br><span class="line">  all \</span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">&#123;MODULE&#125;/<span class="variable">$&#123;OUTPUT_PKG&#125;</span> \</span></span><br><span class="line"><span class="language-bash">  <span class="variable">$&#123;MODULE&#125;</span>/<span class="variable">$&#123;APIS_PKG&#125;</span> \</span></span><br><span class="line"><span class="language-bash">  <span class="variable">$&#123;GROUP_VERSION&#125;</span> \</span></span><br><span class="line"><span class="language-bash">  --output-base <span class="string">&quot;<span class="variable">$&#123;TEMP_DIR&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  --go-header-file <span class="string">&quot;<span class="variable">$&#123;SCRIPT_ROOT&#125;</span>&quot;</span>/hack/boilerplate.go.txt</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Copy everything back.</span></span><br><span class="line">cp -a &quot;$&#123;TEMP_DIR&#125;/$&#123;MODULE&#125;/.&quot; &quot;$&#123;SCRIPT_ROOT&#125;/&quot;</span><br></pre></td></tr></table></figure><h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><p>Makefile ä¸­æ–°å¢ .PHONYï¼Œé›†æˆæ„å»ºæµç¨‹ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: update-codegen</span></span><br><span class="line"><span class="section">update-codegen: ## Generate code by code-generator</span></span><br><span class="line">bash ./hack/update-codegen.sh</span><br></pre></td></tr></table></figure><h2 id="ä»£ç ç”Ÿæˆ"><a href="#ä»£ç ç”Ÿæˆ" class="headerlink" title="ä»£ç ç”Ÿæˆ"></a>ä»£ç ç”Ÿæˆ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make update-codegen</span></span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree pkg/generated/</span></span><br><span class="line"></span><br><span class="line">pkg/generated/</span><br><span class="line">â”œâ”€â”€ clientset</span><br><span class="line">â”‚Â Â  â””â”€â”€ versioned</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ clientset.go</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ doc.go</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ fake</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ clientset_generated.go</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ doc.go</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ register.go</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ scheme</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ doc.go</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ register.go</span><br><span class="line">â”‚Â Â      â””â”€â”€ typed</span><br><span class="line">â”‚Â Â          â””â”€â”€ android</span><br><span class="line">â”‚Â Â              â””â”€â”€ v1</span><br><span class="line">â”‚Â Â                  â”œâ”€â”€ android_client.go</span><br><span class="line">â”‚Â Â                  â”œâ”€â”€ anfile.go</span><br><span class="line">â”‚Â Â                  â”œâ”€â”€ animage.go</span><br><span class="line">â”‚Â Â                  â”œâ”€â”€ doc.go</span><br><span class="line">â”‚Â Â                  â”œâ”€â”€ fake</span><br><span class="line">â”‚Â Â                  â”‚Â Â  â”œâ”€â”€ doc.go</span><br><span class="line">â”‚Â Â                  â”‚Â Â  â”œâ”€â”€ fake_android_client.go</span><br><span class="line">â”‚Â Â                  â”‚Â Â  â”œâ”€â”€ fake_anfile.go</span><br><span class="line">â”‚Â Â                  â”‚Â Â  â””â”€â”€ fake_animage.go</span><br><span class="line">â”‚Â Â                  â””â”€â”€ generated_expansion.go</span><br><span class="line">â”œâ”€â”€ informers</span><br><span class="line">â”‚Â Â  â””â”€â”€ externalversions</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ android</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ interface.go</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ v1</span><br><span class="line">â”‚Â Â      â”‚Â Â      â”œâ”€â”€ anfile.go</span><br><span class="line">â”‚Â Â      â”‚Â Â      â”œâ”€â”€ animage.go</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ interface.go</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ factory.go</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ generic.go</span><br><span class="line">â”‚Â Â      â””â”€â”€ internalinterfaces</span><br><span class="line">â”‚Â Â          â””â”€â”€ factory_interfaces.go</span><br><span class="line">â””â”€â”€ listers</span><br><span class="line">    â””â”€â”€ android</span><br><span class="line">        â””â”€â”€ v1</span><br><span class="line">            â”œâ”€â”€ anfile.go</span><br><span class="line">            â”œâ”€â”€ animage.go</span><br><span class="line">            â””â”€â”€ expansion_generated.go</span><br><span class="line"></span><br><span class="line">16 directories, 26 files</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä½¿ç”¨ Kubebuilder å’Œ Code Generator ç”Ÿæˆè‡ªå®šä¹‰çš„ K8s Operator æ¡†æ¶</summary>
    
    
    
    <category term="Scheduling &amp; Orchestration" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/"/>
    
    <category term="Kubernetes" scheme="http://shenxianghong.github.io/categories/Scheduling-Orchestration/Kubernetes/"/>
    
    
    <category term="Kubebuilder" scheme="http://shenxianghong.github.io/tags/Kubebuilder/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æºç èµ°è¯» â€” Plugin</title>
    <link href="http://shenxianghong.github.io/2022/03/20/2022-03-20%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Plugin/"/>
    <id>http://shenxianghong.github.io/2022/03/20/2022-03-20%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Plugin/</id>
    <published>2022-03-19T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.170Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="ObjectStore"><a href="#ObjectStore" class="headerlink" title="ObjectStore"></a>ObjectStore</h1><p><em><u>pkg&#x2F;plugin&#x2F;velero&#x2F;object_store.go</u></em></p><p><em>Velero æ— è¯¥å†…ç½®ç±»å‹çš„ pluginï¼Œå…·ä½“å‚è€ƒ <a href="https://github.com/vmware-tanzu/velero-plugin-for-aws"> velero-plugin-for-aws</a>ã€<a href="https://github.com/vmware-tanzu/velero-plugin-for-microsoft-azure">velero-plugin-for-microsoft-azure</a>ã€<a href="https://github.com/vmware-tanzu/velero-plugin-for-gcp"> velero-plugin-for-gcp</a>ã€‚</em></p><p>ObjectStore åŒ…å«ä»¥ä¸‹æ¥å£</p><ul><li><p>Init</p><p>åˆå§‹åŒ– Object<br><em>å¦‚æœæ¥å£è¿”å› errorï¼ŒBackupStorageLocation Controller åˆ™æ— æ³•è°ƒç”¨ IsValid åˆ¤æ–­ Provider çš„å¯ç”¨æ€§</em></p></li><li><p>PutObject</p><p>ä¸Šä¼  keyï¼ˆio.Readerï¼‰åˆ° Provider ä¸­</p></li><li><p>ObjectExists</p><p>åˆ¤æ–­ key åœ¨ Provider ä¸­æ˜¯å¦å­˜åœ¨</p></li><li><p>GetObject</p><p>è·å– key çš„å†…å®¹ï¼ˆio.ReadCloserï¼‰<br><em>Velero ä¼šåœ¨è°ƒç”¨åè´Ÿè´£ Close è¯¥ io æ“ä½œï¼Œæ— éœ€ plugin æ“ä½œ</em></p></li><li><p>ListCommonPrefixes</p><p>è·å–æ»¡è¶³ç»™å®šå…¬å…±å‰ç¼€çš„æ‰€æœ‰ key</p></li><li><p>ListObjects</p><p>è·å–æ»¡è¶³ç»™å®šå‰ç¼€çš„æ‰€æœ‰ key</p></li><li><p>DeleteObject</p><p>åˆ é™¤ Provider ä¸­çš„æŒ‡å®š key<br><em>ä»…ä¼šåˆ é™¤ key æœ¬èº«ï¼Œå¦‚æœå¯¹äºæ–‡ä»¶å­˜å‚¨ç±»å‹çš„ Providerï¼Œéœ€è¦åœ¨ plugin ä¸­å®ç°åˆ é™¤æœ€åä¸€ä¸ª key æ—¶ï¼ŒåŒæ—¶åˆ é™¤ç›®å½•çš„åŠŸèƒ½</em></p></li><li><p>CreateSignedURL</p><p>ç”Ÿæˆå…·æœ‰è¿‡æœŸæ—¶é—´çš„ pre-signed urlï¼Œç”¨äºè·å– Provider ä¸­çš„æ–‡ä»¶<br><em>å¯¹äºæ–‡ä»¶å­˜å‚¨ç±»å‹ç­‰ä¸å…·å¤‡æä¾›å¯¹å¤–æœåŠ¡çš„ Providerï¼Œè¯¥æ¥å£éœ€è¦æœ‰å…¶ä»–æœåŠ¡æ”¯æ’‘</em></p></li></ul><h1 id="VolumeSnapshotter"><a href="#VolumeSnapshotter" class="headerlink" title="VolumeSnapshotter"></a>VolumeSnapshotter</h1><p><em><u>pkg&#x2F;plugin&#x2F;velero&#x2F;volume_snapshotter.go</u></em></p><p><em>Velero æ— è¯¥å†…ç½®ç±»å‹çš„ pluginï¼Œå…·ä½“å‚è€ƒ <a href="https://github.com/vmware-tanzu/velero-plugin-for-aws"> velero-plugin-for-aws</a>ã€<a href="https://github.com/vmware-tanzu/velero-plugin-for-microsoft-azure">velero-plugin-for-microsoft-azure</a>ã€<a href="https://github.com/vmware-tanzu/velero-plugin-for-gcp"> velero-plugin-for-gcp</a>ã€‚</em></p><p>VolumeSnapshotter åŒ…å«ä»¥ä¸‹æ¥å£</p><ul><li><p>Init</p><p>åˆå§‹åŒ– VolumeSnapshotshotter</p></li><li><p>CreateVolumeFromSnapshot</p><p>æ ¹æ®æŒ‡å®šçš„ zoneã€IOPS ä¿¡æ¯ä»å¿«ç…§æ¢å¤å·<br></p><p><em>Velero åˆ›å»ºå·çš„åŠ¨ä½œä¸ºåŒæ­¥å¤„ç†ï¼Œä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´è‡³å®Œæˆæˆ–è€…å¤±è´¥</em></p></li><li><p>GetVolumeID</p><p>æ ¹æ®æŒ‡å®šçš„ PV è·å– VolumeID</p></li><li><p>SetVolumeID</p><p>å¯¹æŒ‡å®šçš„ PV è®¾ç½® VolumeID</p></li><li><p>GetVolumeInfo</p><p>è·å– Volume ä¿¡æ¯</p></li><li><p>CreateSnapshot</p><p>å¯¹æŒ‡å®šçš„å·åˆ›å»ºå¿«ç…§<br><em>Velero åˆ›å»º PV å¿«ç…§çš„åŠ¨ä½œä¸ºåŒæ­¥å¤„ç†ï¼Œä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´è‡³å®Œæˆæˆ–è€…å¤±è´¥</em></p></li><li><p>DeleteSnapshot</p><p>åˆ é™¤å¿«ç…§</p></li></ul><h1 id="DeleteItemAction"><a href="#DeleteItemAction" class="headerlink" title="DeleteItemAction"></a>DeleteItemAction</h1><p><em><u>pkg&#x2F;plugin&#x2F;velero&#x2F;delete_item_action.go</u></em></p><p><em>Velero æ— è¯¥å†…ç½®ç±»å‹çš„ pluginã€‚</em></p><p>DeleteItemAction åŒ…å«ä»¥ä¸‹æ¥å£</p><ul><li><p>AppliesTo</p><p>è¿”å›åº”è¯¥å¯¹å“ªäº›èµ„æºæ‰§è¡Œé¢å¤–æ“ä½œï¼ˆé€šè¿‡ Included&#x2F;Excluded Namespaces&#x2F;Resources å®ç°ï¼‰ï¼Œç»“æœä¼šç”± Execute å¤„ç†æ‰§è¡Œé¢å¤–æ“ä½œ</p></li><li><p>Execute</p><p>æ ¹æ®è‡ªå®šä¹‰çš„é€»è¾‘åˆ¤æ–­æ˜¯å¦è¦å¯¹å‡½æ•°å…¥å‚ Itemï¼ˆå³ç¬¦åˆ AppliesTo è¿‡æ»¤åçš„èµ„æºå¯¹è±¡ï¼‰åœ¨åˆ é™¤ Backup æ—¶ï¼Œæ‰§è¡Œä¸€äº›é¢å¤–çš„æ“ä½œ</p></li></ul><h1 id="BackupItemAction"><a href="#BackupItemAction" class="headerlink" title="BackupItemAction"></a>BackupItemAction</h1><p><em><u>pkg&#x2F;plugin&#x2F;velero&#x2F;backup_item_action.go</u></em></p><p>BackupItemAction åŒ…å«ä»¥ä¸‹æ¥å£</p><ul><li><p>AppliesTo</p><p>è¿”å›åº”è¯¥å¯¹å“ªäº›èµ„æºæ‰§è¡Œé¢å¤–æ“ä½œï¼ˆé€šè¿‡ Included&#x2F;Excluded Namespaces&#x2F;Resources å®ç°ï¼‰ï¼Œè¯¥è¿‡æ»¤ç»“æœä¼šå’Œ Backup æœ¬èº«çš„è¿‡æ»¤å–äº¤é›†ï¼Œç»“æœä¼šç”± Execute å¤„ç†æ‰§è¡Œé¢å¤–æ“ä½œ</p></li><li><p>Execute</p><p>æ ¹æ®è‡ªå®šä¹‰çš„é€»è¾‘åˆ¤æ–­æ˜¯å¦è¦å¯¹å‡½æ•°å…¥å‚ Itemï¼ˆå³ç¬¦åˆ AppliesTo è¿‡æ»¤åçš„èµ„æºå¯¹è±¡ï¼‰åšé¢å¤–æ“ä½œï¼Œå‡½æ•°ä¼šè¿”å›ä¸¤ä¸ªæ ¸å¿ƒå†…å®¹</p><ul><li>æ›´æ–°åçš„ itemï¼Œæ­¤åçš„æµç¨‹ä¼šä»¥æ­¤ item ä¸ºåŸºå‡†</li><li>éœ€è¦é¢å¤–æ“ä½œçš„å¯¹è±¡ï¼Œä¼šåŠ å…¥æ­¤åå¤‡ä»½æµç¨‹ä¸­æ‰§è¡Œå¤‡ä»½</li></ul></li></ul><h2 id="velero-io-x2F-pv"><a href="#velero-io-x2F-pv" class="headerlink" title="velero.io&#x2F;pv"></a>velero.io&#x2F;pv</h2><p><em><u>pkg&#x2F;backup&#x2F;backup_pv_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: persistentvolumeclaims</p><p><strong>Execute</strong></p><ol><li>PVC item æœªæ›´æ–°</li><li>è·å– PVC ç»‘å®šçš„ PV ä½œä¸ºé¢å¤–æ“ä½œçš„å¯¹è±¡è¿”å›</li></ol><h2 id="velero-io-x2F-pod"><a href="#velero-io-x2F-pod" class="headerlink" title="velero.io&#x2F;pod"></a>velero.io&#x2F;pod</h2><p><em><u>pkg&#x2F;backup&#x2F;pod_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: pods</p><p><strong>Execute</strong></p><ol><li>Pod item æœªæ›´æ–°</li><li>è·å– Pod ä¸­ä½¿ç”¨çš„ PVC ä½œä¸ºé¢å¤–æ“ä½œçš„å¯¹è±¡è¿”å›</li></ol><h2 id="velero-io-x2F-service-account"><a href="#velero-io-x2F-service-account" class="headerlink" title="velero.io&#x2F;service-account"></a>velero.io&#x2F;service-account</h2><p><em><u>pkg&#x2F;backup&#x2F;service_account_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: serviceaccounts</p><p><strong>Execute</strong></p><ol><li>Service Account item æœªæ›´æ–°</li><li>è·å– Service Account å…³è”çš„ ClusterRole å’Œ ClusterRoleBinding ä½œä¸ºé¢å¤–æ“ä½œçš„å¯¹è±¡è¿”å›</li></ol><h2 id="velero-io-x2F-crd-remap-version"><a href="#velero-io-x2F-crd-remap-version" class="headerlink" title="velero.io&#x2F;crd-remap-version"></a>velero.io&#x2F;crd-remap-version</h2><p><em><u>pkg&#x2F;backup&#x2F;remap_crd_version_action</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: customresourcedefinition.apiextensions.k8s.io</p><p><strong>Execute</strong></p><ol><li>å¦‚æœ CRD çš„ apiVersion ä¸º apiextensions.k8s.io&#x2F;v1ï¼Œå¹¶ä¸”å¦‚æœæ˜¯å•ä¸€ç‰ˆæœ¬çš„ CRDï¼Œæˆ–è€…å­˜åœ¨ä½è§£æ„çš„å­—æ®µæˆ–è€…é¢„ç•™å­—æ®µæ—¶ï¼Œåˆ™å°† v1 ç‰ˆæœ¬çš„ CRD item è½¬æ¢ä¸º v1beta1 ç‰ˆæœ¬ï¼Œå¹¶è¿”å›<br><em>å‚è€ƒï¼š<a href="https://kubernetes.io/zh/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions">https://kubernetes.io/zh/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions</a></em></li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li></ol><h1 id="RestoreItemAction"><a href="#RestoreItemAction" class="headerlink" title="RestoreItemAction"></a>RestoreItemAction</h1><p><em><u>pkg&#x2F;plugin&#x2F;velero&#x2F;restore_item_action.go</u></em></p><p>RestoreItemAction åŒ…å«ä»¥ä¸‹æ¥å£</p><ul><li><p>AppliesTo</p><p>è¿”å›åº”è¯¥å¯¹å“ªäº›èµ„æºæ‰§è¡Œé¢å¤–æ“ä½œï¼ˆé€šè¿‡ Included&#x2F;Excluded Namespaces&#x2F;Resources å®ç°ï¼‰ï¼Œè¯¥è¿‡æ»¤ç»“æœä¼šå’Œ Restore æœ¬èº«çš„è¿‡æ»¤å–äº¤é›†ï¼Œç»“æœä¼šç”± Execute å¤„ç†æ‰§è¡Œé¢å¤–æ“ä½œ</p></li><li><p>Execute</p><p>æ ¹æ®è‡ªå®šä¹‰çš„é€»è¾‘åˆ¤æ–­æ˜¯å¦è¦å¯¹ Itemï¼ˆå³ç¬¦åˆ AppliesTo è¿‡æ»¤åçš„èµ„æºå¯¹è±¡ï¼‰åšé¢å¤–æ“ä½œï¼Œå‡½æ•°ä¼šè¿”å›ä¸‰ä¸ªæ ¸å¿ƒå†…å®¹</p><ul><li>æ›´æ–°åçš„ itemï¼Œæ­¤åçš„æµç¨‹ä¼šä»¥æ­¤ item ä¸ºåŸºå‡†</li><li>éœ€è¦é¢å¤–æ“ä½œçš„å¯¹è±¡ï¼Œä¼šåŠ å…¥æ­¤åæ¢å¤æµç¨‹ä¸­æ‰§è¡Œæ¢å¤</li><li>æ˜¯å¦è·³è¿‡æ¢å¤çš„æ ‡è¯† skipRestore</li></ul></li></ul><h2 id="velero-io-x2F-job"><a href="#velero-io-x2F-job" class="headerlink" title="velero.io&#x2F;job"></a>velero.io&#x2F;job</h2><p><em><u>pkg&#x2F;restore&#x2F;job_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: jobs</p><p><strong>Execute</strong></p><ol><li>åˆ é™¤ Job item ä¸­çš„ controller-uid å­—æ®µï¼ˆjob.Spec.Selector.MatchLabels ä»¥åŠ job.Spec.Template.ObjectMeta.Labelsï¼‰ï¼Œå¹¶è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-pod-1"><a href="#velero-io-x2F-pod-1" class="headerlink" title="velero.io&#x2F;pod"></a>velero.io&#x2F;pod</h2><p><em><u>pkg&#x2F;restore&#x2F;pod_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: pods</p><p><strong>Execute</strong></p><ol><li>æ¸…ç©º Pod item çš„ nodeNameã€priority å’Œæ— éœ€ä¿ç•™å·ã€å·æŒ‚è½½ä¿¡æ¯ï¼Œå¹¶è¿”å›<br><em>å¦‚æœ Pod å·æˆ–å·æŒ‚è½½ä»¥ pod.Spec.ServiceAccountName + â€œ-token-â€œ å¼€å¤´ï¼Œåˆ™æ— éœ€ä¿ç•™ã€‚</em></li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-restic"><a href="#velero-io-x2F-restic" class="headerlink" title="velero.io&#x2F;restic"></a>velero.io&#x2F;restic</h2><p><em><u>pkg&#x2F;restore&#x2F;restic_restore_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: pods</p><p><strong>Execute</strong></p><ol><li>è·å–åˆ° Pod item ä¸­çš„è¢« Restic å¤‡ä»½çš„å·ä¿¡æ¯ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œåˆ™ä¼šæ ¹æ®ä¸€ç³»åˆ—çš„é…ç½®ä¿¡æ¯å¯¹ Pod item æ³¨å…¥ä¸€ä¸ª Init Containerï¼ˆrestic-waitï¼‰ï¼Œå¹¶è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-init-restore-hook"><a href="#velero-io-x2F-init-restore-hook" class="headerlink" title="velero.io&#x2F;init-restore-hook"></a>velero.io&#x2F;init-restore-hook</h2><p><em><u>pkg&#x2F;restore&#x2F;init_restorehook_pod_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: pods</p><p><strong>Execute</strong></p><ol><li>è·å– Pod ä¸­æœ‰å…³ init.hook.restore.velero.io&#x2F;xxx çš„ annotation ä¿¡æ¯ï¼Œæ„å»ºä¸€ä¸ª Init Containerï¼Œå¦‚æœ Pod æ²¡æœ‰ç›¸å…³çš„ annotationï¼Œåˆ™è·å– Restore ä¸­çš„ hook ä¿¡æ¯ï¼Œæ ¹æ® selector çš„åŒ¹é…ç»“æœï¼Œæ„å»ºä¸€ä¸ª Init Containerã€‚ä»¥ä¸Šæ„å»ºçš„ Init Container ä¼šè¿½åŠ åœ¨ Pod ä¸­ï¼Œé¡ºåºä¸ºï¼šrestic-waitï¼ˆå¦‚æœ Pod å·²ç»å­˜åœ¨ï¼‰ï¼Œhook1ï¼Œhook2â€¦ï¼Œè¿½åŠ ä½œä¸ºæ›´æ–°åçš„ Pod item è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-service"><a href="#velero-io-x2F-service" class="headerlink" title="velero.io&#x2F;service"></a>velero.io&#x2F;service</h2><p><em><u>pkg&#x2F;restore&#x2F;service_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: services</p><p><strong>Execute</strong></p><ol><li>å¦‚æœ ClusterIP ä¸ä¸º Noneï¼ˆä¹Ÿå°±æ˜¯è¯´åˆ†é…äº†ä¸€ä¸ª Service IPï¼‰ï¼Œåˆ™åˆ é™¤ ClusterIPï¼Œå¦‚æœ Restore æ²¡æœ‰æŒ‡å®š â€“preserve-nodeports å‚æ•°ï¼Œåˆ™åˆ é™¤ Service çš„ NodePort ä¿¡æ¯ï¼Œå¹¶è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-service-account-1"><a href="#velero-io-x2F-service-account-1" class="headerlink" title="velero.io&#x2F;service-account"></a>velero.io&#x2F;service-account</h2><p><em><u>pkg&#x2F;restore&#x2F;service_account_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: serviceaccounts</p><p><strong>Execute</strong></p><ol><li>åˆ é™¤ Service Account ä¸­çš„è¿è¡ŒçŠ¶æ€æ—¶ç”Ÿæˆçš„ &lt;serviceAccountName&gt;-tokenï¼Œå¹¶è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-add-pvc-from-pod"><a href="#velero-io-x2F-add-pvc-from-pod" class="headerlink" title="velero.io&#x2F;add-pvc-from-pod"></a>velero.io&#x2F;add-pvc-from-pod</h2><p><em><u>pkg&#x2F;restore&#x2F;add_pvc_from_pod_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: pods</p><p><strong>Execute</strong></p><ol><li>Pod item æœªæ›´æ–°</li><li>è·å– Pod ä¸­ä½¿ç”¨çš„ PVC ä½œä¸ºé¢å¤–çš„æ“ä½œå¯¹è±¡è¿”å›</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-add-pv-from-pvc"><a href="#velero-io-x2F-add-pv-from-pvc" class="headerlink" title="velero.io&#x2F;add-pv-from-pvc"></a>velero.io&#x2F;add-pv-from-pvc</h2><p><em><u>pkg&#x2F;restore&#x2F;add_pv_from_pod_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: persistentvolumeclaims</p><p><strong>Execute</strong></p><ol><li>PVC item æœªæ›´æ–°</li><li>è·å– PVC ç»‘å®šçš„ PV ä½œä¸ºé¢å¤–çš„æ“ä½œå¯¹è±¡è¿”å›</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-change-storage-class"><a href="#velero-io-x2F-change-storage-class" class="headerlink" title="velero.io&#x2F;change-storage-class"></a>velero.io&#x2F;change-storage-class</h2><p><em><u>pkg&#x2F;restore&#x2F;change_storageclass_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: persistentvolumeclaims, persistentvolumes</p><p><strong>Execute</strong></p><ol><li><p>è·å–é›†ç¾¤ä¸­æœ‰å…³ StorageClass æ˜ å°„å…³ç³»çš„å”¯ä¸€çš„ ConfigMap ä¿¡æ¯ï¼ˆå³ ConfigMap label ä¸­æœ‰ velero.io&#x2F;plugin-config&#x3D;â€â€ å’Œ velero.io&#x2F;change-storage-class&#x3D;RestoreItemActionï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¸åšæ˜ å°„å…³ç³»ï¼‰ï¼Œæ ¹æ® PV æˆ– PVC ä¸­çš„ StorageClassName è·å¾—æ˜ å°„åçš„æ–° StorageClassNameï¼Œæ›´æ–° PV æˆ– PVCï¼Œå¹¶è¿”å›</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">change-storage-class</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">velero</span></span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">velero.io/plugin-config:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">velero.io/change-storage-class:</span> <span class="string">RestoreItemAction</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">ussvd-sc:</span> <span class="string">local-sc</span></span><br></pre></td></tr></table></figure></li><li><p>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</p></li><li><p>skipRestore ä¸º false</p></li></ol><h2 id="velero-io-x2F-role-bindings"><a href="#velero-io-x2F-role-bindings" class="headerlink" title="velero.io&#x2F;role-bindings"></a>velero.io&#x2F;role-bindings</h2><p><em><u>pkg&#x2F;restore&#x2F;rolebinding_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: rolebindings</p><p><strong>Execute</strong></p><ol><li>æ ¹æ® Restore ä¸­çš„ namespace æ˜ å°„å…³ç³»ï¼Œä¿®æ”¹ RoleBinding çš„ namespaceï¼Œå¹¶è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-cluster-role-bindings"><a href="#velero-io-x2F-cluster-role-bindings" class="headerlink" title="velero.io&#x2F;cluster-role-bindings"></a>velero.io&#x2F;cluster-role-bindings</h2><p><em><u>pkg&#x2F;restore&#x2F;clusterrolebinding_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: clusterrolebindings</p><p><strong>Execute</strong></p><ol><li>æ ¹æ® Restore ä¸­çš„ namespace æ˜ å°„å…³ç³»ï¼Œä¿®æ”¹ ClusterRoleBinding çš„ namespaceï¼Œå¹¶è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-crd-preserve-fields"><a href="#velero-io-x2F-crd-preserve-fields" class="headerlink" title="velero.io&#x2F;crd-preserve-fields"></a>velero.io&#x2F;crd-preserve-fields</h2><p><em><u>pkg&#x2F;restore&#x2F;crd_v1_preserve_unknown_fields_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: customresourcedefinition.apiextensions.k8s.io</p><p><strong>Execute</strong></p><ol><li>è®¾ç½®ç‰ˆæœ¬ä¸º apiextensions.k8s.io&#x2F;v1 çš„ CRD çš„ PreserveUnknownFields ä¿¡æ¯ï¼Œå¹¶è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-change-pvc-node-selector"><a href="#velero-io-x2F-change-pvc-node-selector" class="headerlink" title="velero.io&#x2F;change-pvc-node-selector"></a>velero.io&#x2F;change-pvc-node-selector</h2><p><em><u>pkg&#x2F;restore&#x2F;change_pvc_node_selector.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResources: persistentvolumeclaims</p><p><strong>Execute</strong></p><ol><li>è·å–é›†ç¾¤ä¸­æœ‰å…³ PVC NodeSelector æ˜ å°„å…³ç³»çš„å”¯ä¸€ ConfigMap ä¿¡æ¯ï¼Œæ ¹æ® PVC annotation ä¸­çš„ volume.kubernetes.io&#x2F;selected-node è·å¾—æ˜ å°„åçš„æ–° Nodeï¼Œå¦‚æœå­˜åœ¨æ˜ å°„å…³ç³»ï¼Œåˆ™è®¤ä¸ºæ–°çš„ Node å­˜åœ¨ï¼›å¦‚æœä¸å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œåˆ™åˆ¤æ–­æ—§ Node æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ é™¤ volume.kubernetes.io&#x2F;selected-node ä¿¡æ¯ï¼Œå­˜åœ¨åˆ™è®¾ç½® PVC annotation nodeSelector ä¸ºæ—§ Nodeã€‚æ— è®ºæ€æ ·ï¼Œå‡æ›´æ–° PVCï¼Œå¹¶è¿”å›</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º false</li></ol><h2 id="velero-io-x2F-apiservice"><a href="#velero-io-x2F-apiservice" class="headerlink" title="velero.io&#x2F;apiservice"></a>velero.io&#x2F;apiservice</h2><p><em><u>pkg&#x2F;restore&#x2F;apiservice_action.go</u></em></p><p><strong>AppliesTo</strong></p><p>IncludedResrouces: apiservices</p><p>LabelSelector: kube-aggregator.kubernetes.io&#x2F;automanaged</p><p><strong>Execute</strong></p><ol><li>apiservices item æœªæ›´æ–°</li><li>æ— é¢å¤–æ“ä½œçš„å¯¹è±¡</li><li>skipRestore ä¸º trueï¼Œå› ä¸ºè¿™äº› apiservices ç”± kube-aggergator è´Ÿè´£ç»´æŠ¤ï¼Œæ— éœ€æ¢å¤</li></ol>]]></content>
    
    
    <summary type="html">Velero ä¸­ä¸ ObjectStoreã€VolumeSnapshotter ç­‰æ’ä»¶ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æºç èµ°è¯» â€” Server</title>
    <link href="http://shenxianghong.github.io/2022/03/06/2022-03-06%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Server/"/>
    <id>http://shenxianghong.github.io/2022/03/06/2022-03-06%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Server/</id>
    <published>2022-03-05T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.169Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h1><p><em><u>pkg&#x2F;client&#x2F;factory.go</u></em><br><em><u>pkg&#x2F;client&#x2F;config.go</u></em><br><em><u>pkg&#x2F;cmd&#x2F;velero&#x2F;velero.go</u></em><br></p><p>Velero çš„å…¨å±€é…ç½®å‚æ•°ï¼Œæ¯”å¦‚ namespacesï¼Œfeaturesï¼Œcacert å’Œ colorized ç­‰ä¿¡æ¯ï¼Œæ˜¯åœ¨åˆå§‹åŒ– velero æ ¹ command æ—¶ï¼Œè§£æä½äº host çš„ &lt;HOME&gt;&#x2F;.config&#x2F;velero&#x2F;config.json çš„é…ç½®æ–‡ä»¶è·å–é…ç½®å¯¹è±¡ï¼Œåˆå§‹åŒ– factory å¯¹è±¡ï¼Œå°†å…¶é€ä¼ ç»™ä¸‹çº§å­ command å®ç°ï¼Œç”±äº velero æœåŠ¡çš„å¯åŠ¨ä¹Ÿæ˜¯ velero çš„å­å‘½ä»¤ï¼ˆå³ velero serverï¼‰ï¼Œå› æ­¤å®ç°äº†å…¨å±€é…ç½®é€ä¼ åŠŸèƒ½ã€‚</p><h1 id="Generic-Controller"><a href="#Generic-Controller" class="headerlink" title="Generic Controller"></a>Generic Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;generic_controller.go</u></em><br><em><u>pkg&#x2F;controller&#x2F;interface.go</u></em><br><em><u>internal&#x2F;util&#x2F;managercontroller&#x2F;managercontroller.go</u></em></p><p>é¡¾åæ€ä¹‰ï¼ŒGeneric Controller å®šä¹‰æ‰€æœ‰ Controller çš„é€šç”¨è¡Œä¸ºï¼Œæœ¬èº«è´Ÿè´£å‘¨æœŸæ€§è°ƒç”¨ Controller æ³¨å†Œçš„æ–¹æ³•å¤„ç† Keyï¼Œç»´æŠ¤ Controller  Key çš„ç”Ÿå‘½å‘¨æœŸã€‚</p><p>æ¯ä¸€ä¸ª Controller éƒ½ç»§æ‰¿äº† Generic Controllerï¼Œä¸»è¦åŒ…æ‹¬æ³¨å†Œ syncHandler å’Œ resyncFuncï¼Œä»¥åŠ queue å’Œ cacheSyncWaiters ç­‰ã€‚</p><p>Generic Controller ä¸»è¦åŒ…å«ä»¥ä¸‹æ ¸å¿ƒå±æ€§ï¼š</p><p><strong>queue</strong></p><p>é»˜è®¤ä½¿ç”¨ K8s æä¾›çš„ NewNamedRateLimitingQueueï¼Œé˜Ÿåˆ—ä¸­å°±æ˜¯éœ€è¦å¤„ç†çš„ Keyï¼Œæ ¼å¼ä¸º &lt;namespace&gt;&#x2F;&lt;name&gt; æˆ–è€… &lt;name&gt;ï¼ˆå–å†³äºå¯¹è±¡æ˜¯å¦æ˜¯ namespaced scopeï¼‰ã€‚</p><p>Generic Controller æä¾›äº† enqueue çš„æ–¹æ³•ï¼Œç”¨äº Key çš„å…¥é˜Ÿï¼ˆæœ¬è´¨ä¸Šå°±æ˜¯ queue çš„ Add æ–¹æ³•ï¼Œåªä¸è¿‡è½¬æ¢æˆäº†ä¸Šè¿°çš„æ ¼å¼ï¼‰ã€‚</p><p><strong>syncHandler</strong></p><p>Generic Controller ä¼šå‘¨æœŸæ€§çš„è°ƒç”¨ Controller æ³¨å†Œçš„ syncHandlerï¼Œå¤„ç† queue ä¸­çš„ Keyã€‚</p><p><strong>resyncFunc</strong></p><p>Generic Controller ä¼šæ ¹æ® resyncPeriod å‘¨æœŸæ€§çš„è°ƒç”¨ Controller æ³¨å†Œçš„ resyncFuncï¼Œæ‰§è¡Œé¢å¤–å£°æ˜çš„é€»è¾‘ã€‚</p><p><strong>cacheSyncWaiters</strong></p><p>Generic Controller åœ¨æ‰§è¡Œ syncHandler å’Œ resyncFunc ä¹‹å‰ä¼šç­‰å¾…æ³¨å†Œåœ¨ cacheSyncWaiters å…¨éƒ¨ç¼“å­˜å®Œæˆï¼ˆæœ¬è´¨ä¸Šï¼Œå°±æ˜¯ä¸€ç»„ func() bool å‡è¿”å› true å³å¯ï¼Œåªä¸è¿‡ä¼ å…¥çš„å‡ä¸º podInformer.HasSynced å‡½æ•°ï¼‰ã€‚</p><h2 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/generic_controller.go#L54">Run æºç </a></p><p>Generic Controller çš„æ ¸å¿ƒé€»è¾‘</p><ol><li>æ ¡éªŒ syncHandler å’Œ resyncFunc æ˜¯å¦è‡³å°‘æ³¨å†Œäº†ä¸€ä¸ª</li><li>å¦‚æœæ³¨å†Œäº† cacheSyncWaitersï¼Œåˆ™ç­‰å¾…å…¶ç¼“å­˜åŒæ­¥å®Œæˆ<br><em>PodVolumeBackup Controller å’Œ PodVolumeRestore Controller å‡æ³¨å†Œäº† cacheSyncWaitersï¼Œç”¨äºåŒæ­¥ Podã€PVC ä»¥åŠ PodVolumeBackupï¼ˆPodVolumeRestoreï¼‰</em> </li><li>å¯åŠ¨æŒ‡å®š worker æ•°é‡çš„ Goroutineï¼Œæ¯ 1 ç§’é’Ÿå¤„ç†ä¸€æ¬¡ä»¥ä¸‹é€»è¾‘<br><em>è¯¥é€»è¾‘æœ¬èº«æ˜¯æ­»å¾ªç¯ï¼Œåªæœ‰åœ¨ queue å…³é—­æ—¶è¿”å› falseï¼Œå› æ­¤éš” 1 ç§’é’Ÿè¿˜ä¼šé‡æ–°æ‰§è¡Œ</em><ol><li>ä» queue ä¸­è·å– Keyï¼ˆGetï¼‰</li><li>è°ƒç”¨ syncHandler æ³¨å†Œçš„ Handlerï¼Œå¤„ç† Key<ul><li>å¦‚æœå¤„ç†æˆåŠŸï¼Œåˆ™åœ¨ queue ä¸­ç§»é™¤ï¼ˆForgetï¼‰</li><li>å¦‚æœå¤„ç†å¤±è´¥ï¼Œåˆ™é™åˆ¶é€Ÿç‡é‡æ–°åŠ å…¥ queue ä¸­ï¼ˆAddRateLimitedï¼‰</li></ul></li></ol></li><li>æ¯éš” resyncPeriod æ‰§è¡Œä¸€æ¬¡ resyncFunc é€»è¾‘<br><em>resyncFunc çš„å¤„ç†ä¸ä¸€å®šå’Œ Key ç›¸å…³ï¼Œå¯ä»¥æ‰§è¡Œä¸€äº›æŒ‡æ ‡ä¸ŠæŠ¥ç­‰æ“ä½œï¼Œä¾‹å¦‚ Backup Controller çš„ resyncFunc å®ç°</em></li></ol><h2 id="Runable"><a href="#Runable" class="headerlink" title="Runable"></a>Runable</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/internal/util/managercontroller/managercontroller.go#L31">Runable æºç </a></p><p>ç”¨äºå°†è°ƒç”¨ Run å‡½æ•°å¯åŠ¨ Controller çš„æ–¹æ³•å°è£…æˆ manager.Runable è¿”å›ï¼Œä¾› manager.Add ä»¥åŠ manager.Start ä½¿ç”¨<br><em>manager ä¸º controller-runtime çš„ manager</em></p><h1 id="Velero-Server"><a href="#Velero-Server" class="headerlink" title="Velero Server"></a>Velero Server</h1><p><em><u>pkg&#x2F;cmd&#x2F;server&#x2F;server.go</u></em></p><p>æœ¬è´¨ä¸Šæ˜¯ velero cli çš„ server å­å‘½ä»¤ï¼Œæ ¹æ® install ä»¥åŠæ›´å¤šçš„è‡ªå®šä¹‰å‚æ•°ï¼Œå¯åŠ¨ Velero æœåŠ¡ã€‚</p><h2 id="newServer"><a href="#newServer" class="headerlink" title="newServer"></a>newServer</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/3c49ec4fb4ff7f5aaa4ed56e8f7ff1a26f966d72/pkg/cmd/server/server.go#L246">newServer æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>è®¾ç½® client çš„ QPS å’Œ Burstï¼Œæœ€ç»ˆä¼šä½œç”¨åœ¨ Kube Clientï¼ŒVelero Client å’Œ Dynamic Client</li><li>åˆå§‹åŒ– Kube Clientï¼ŒVelero Client å’Œ Dynamic Client</li><li>åˆå§‹åŒ– PluginRegistryï¼Œå‘ç°æ³¨å†Œåœ¨ &#x2F;plugins ç›®å½•ä¸‹çš„æ‰€æœ‰æ’ä»¶ï¼Œå¹¶è°ƒç”¨ velero run-plugins å‘½ä»¤å¯åŠ¨æ’ä»¶çš„ GRPC æœåŠ¡<br><em>æ’ä»¶åŒ…æ‹¬ item-actionã€objectStore ä»¥åŠ volumeSnapshotter ç­‰</em></li><li>å¦‚æœ Velero å¼€å¯äº† CSI ç‰¹æ€§ï¼Œåˆ™åˆå§‹åŒ– CSI Snapshot Client</li><li>æ„å»º controller-runtime çš„ manager å¯¹è±¡</li><li>åˆå§‹åŒ– CredentialFileStoreï¼Œç”¨äºæ“ä½œè®¤è¯æ–‡ä»¶ä¿¡æ¯</li><li>æ ¹æ®ä»¥ä¸Šå†…å®¹ï¼Œæ„å»º server å¯¹è±¡</li></ol><h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/3c49ec4fb4ff7f5aaa4ed56e8f7ff1a26f966d72/pkg/cmd/server/server.go#L352">run æºç </a></p><p>server è¿è¡Œçš„ä¸»ä½“é€»è¾‘</p><ol><li>å¦‚æœé…ç½®äº† profile åœ°å€ï¼Œåˆ™å¯åŠ¨ pprof æœåŠ¡</li><li>æ£€æŸ¥ Velero namespace æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æŠ¥é”™</li><li>åˆå§‹åŒ– DiscoveryHelperï¼Œæ¯ 5 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ï¼Œè·å–å¯ä»¥å¤‡ä»½çš„å¯¹è±¡ä¿¡æ¯</li><li>æ£€æŸ¥ Velero æœåŠ¡æ‰€éœ€è¦çš„ CRD æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æŠ¥é”™</li><li>æ£€æŸ¥ Restic æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¾“å‡º warning ä¿¡æ¯ï¼Œç¡®ä¿ restic æ‰€éœ€è¦çš„ secret å­˜åœ¨ï¼ˆå³ velero-restic-credentialsï¼‰ï¼Œåˆå§‹åŒ– RepositoryManager</li><li>è°ƒç”¨ runControllersï¼Œå¯åŠ¨æ‰€æœ‰çš„ Controller</li></ol><h2 id="runControllers"><a href="#runControllers" class="headerlink" title="runControllers"></a>runControllers</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/3c49ec4fb4ff7f5aaa4ed56e8f7ff1a26f966d72/pkg/cmd/server/server.go#L566">runControllers æºç </a></p><p>å¯åŠ¨ controller ä»¥åŠå…¶ä»–æœåŠ¡</p><ol><li>å¯åŠ¨ promHttp æœåŠ¡ï¼Œå¯¹æ¥ Prometheus</li><li>åˆå§‹åŒ– <a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/plugin/clientmgmt/manager.go#L30">pluginManager</a>ï¼Œæä¾›ä¸ Velero Plugin äº¤äº’çš„åŸç”Ÿæ¥å£</li><li>åˆå§‹åŒ– backupStoreGetterï¼Œæä¾›æ“ä½œ Backup å’Œ Restore çš„ä¸Šå±‚æ¥å£<br><em>å³ Provider ç« èŠ‚ä¸­çš„ StorageProvider</em></li><li>æŒ‰éœ€åˆå§‹åŒ– CSI Snapshot Lister å’Œ CSI SnapshotContent Lister</li><li>æ ¹æ®ä»¥ä¸Šå†…å®¹ï¼Œåˆå§‹åŒ– Backup Controllerã€BackupSync Controllerã€Schedule Controllerã€GC Controllerã€BackupDeletion Controllerã€Restore Controller ä»¥åŠ ResticRepo Controllerï¼Œå¹¶å°†è¿™äº›åˆæ­¥è®¾å®šä¸ºé»˜è®¤å¼€å¯çš„ Controller</li><li>æ­¤å¤–ï¼ŒServerStatusRequest Controller å’Œ DownloadRequest Controller ä½œä¸ºæœåŠ¡è¿è¡Œæ—¶çš„çŠ¶æ€ Controllerï¼Œä¹Ÿä¼šä½œä¸ºé»˜è®¤å¼€å¯<br><em>è¯¥ç±»å‹çš„ Controller ä¸æ­¥éª¤ 5 ä¸­çš„ Controller å¤„ç†é€»è¾‘ç›¸åŒï¼Œä½†æ˜¯æ˜¯åˆ†å¼€å¤„ç†å’Œå¯åŠ¨çš„</em></li><li>å¦‚æœ Velero æœåŠ¡ä¸º restoreOnly æ¨¡å¼ï¼Œåˆ™ç¦ç”¨ Backup Controllerã€Schedule Controllerã€GC Controller ä»¥åŠ BackupDeletion Controller</li><li>å°†å¯ç”¨çš„ Controller å’Œç¦ç”¨çš„ Controller å–å·®é›†åï¼Œå³ä¸ºæœ€ç»ˆ Velero æœåŠ¡ä¸­å¯åŠ¨çš„ Controller ä¿¡æ¯</li><li>ç­‰å¾… Velero Client å’Œ CSI Snapshot Client åŒæ­¥ç¼“å­˜ï¼ˆwaitForCacheSyncï¼‰</li><li>å¯åŠ¨ BackupStorageLocation Controllerï¼ˆReconciler æ–¹å¼ï¼‰ï¼ŒæŒ‰éœ€å¯åŠ¨ ServerStatusRequest Controller å’Œ DownloadRequest Controller</li><li>å¯åŠ¨å‰©ä½™çš„ Controllerï¼ˆä¸åŒ…å« Request ç±»å‹çš„ Controllerï¼‰ï¼Œæ‰€æœ‰çš„ Controller é»˜è®¤å‡ä¸º 1 worker</li></ol><h1 id="Restic-Server"><a href="#Restic-Server" class="headerlink" title="Restic Server"></a>Restic Server</h1><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restic&#x2F;server.go</u></em></p><p>æœ¬è´¨ä¸Šæ˜¯ velero restic cli çš„ server å­å‘½ä»¤ï¼Œæ ¹æ®è‡ªå®šä¹‰å‚æ•°ï¼Œå¯åŠ¨ Restic æœåŠ¡ã€‚</p><h2 id="newResticServer"><a href="#newResticServer" class="headerlink" title="newResticServer"></a>newResticServer</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/cmd/cli/restic/server.go#L119">newResticServer æºç </a></p><ol><li>åˆå§‹åŒ– KubeClient å’Œ Velero Client</li><li>åˆå§‹åŒ– PodInformerï¼Œä»…è·å–è°ƒåº¦åœ¨æœ¬èŠ‚ç‚¹ä¸Šçš„ Pod</li><li>æ„å»º controller-runtime çš„ manager å¯¹è±¡</li><li>æ ¹æ®ä»¥ä¸Šå†…å®¹ï¼Œæ„å»º restic server å¯¹è±¡</li><li>åˆ¤æ–­æŒ‚è½½åœ¨ restic æœåŠ¡ä¸­ &#x2F;hosts_pods ç›®å½•ä¸‹æ‰€æœ‰çš„ Pod ä¿¡æ¯å’Œé›†ç¾¤ä¸­çš„æ‰€æœ‰çš„ Pod æ˜¯å¦ä¸€ä¸€å¯¹åº”</li></ol><h2 id="run-1"><a href="#run-1" class="headerlink" title="run"></a>run</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/cmd/cli/restic/server.go#L183">run æºç </a></p><ol><li>å¯åŠ¨ promHttp æœåŠ¡ï¼Œå¯¹æ¥ Prometheus</li><li>åˆå§‹åŒ– CredentialFileStoreï¼Œç”¨äºæ“ä½œè®¤è¯æ–‡ä»¶ä¿¡æ¯</li><li>æ ¹æ®ä»¥ä¸Šå†…å®¹ï¼Œåˆå§‹åŒ– PodVolumeBackup Controller å’Œ PodVolumeRestore Controller</li><li>å¯åŠ¨ PodVolumeBackup Controller å’Œ PodVolumeRestore Controllerï¼Œé»˜è®¤å‡ä¸º 1 worker</li></ol><h1 id="Velero-Restic-Restore-Helper"><a href="#Velero-Restic-Restore-Helper" class="headerlink" title="Velero Restic Restore Helper"></a>Velero Restic Restore Helper</h1><p><em><u>cmd&#x2F;velero-restic-restore-helper&#x2F;main.go</u></em></p><p>æœ¬è´¨æ˜¯ Velero é¡¹ç›®çš„å¦ä¸€ä¸ª binary æ‰§è¡Œæ–‡ä»¶ï¼ˆè¿˜æœ‰ä¸€ä¸ªæ˜¯ velero æœ¬èº«ï¼‰ï¼Œåœ¨æ¢å¤ Pod å·æ•°æ®æ—¶ï¼Œä¼šç»™è¯¥ Pod æ³¨å…¥ä¸€ä¸ª InitContainerï¼Œè¯¥ binary å°±æ˜¯ InitContainer æ‰€ç”¨é•œåƒï¼ˆvelero&#x2F;velero-restic-restore-helper:&lt;velero-version&gt;ï¼‰ä¸­çš„å¯åŠ¨æœåŠ¡ã€‚</p><h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/cmd/velero-restic-restore-helper/main.go#L27">main æºç </a></p><p>æ¯ä¸€ä¸ªå¾…æ¢å¤å·æ•°æ®çš„ Pod çš„ InitContainer ä¸­è¿è¡Œçš„æœåŠ¡</p><ol><li>å‘½ä»¤è¡Œæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå³ Restore çš„ UID</li><li>å¯åŠ¨æ­»å¾ªç¯å®šæ—¶å™¨ï¼Œæ¯ä¸€ç§’é’Ÿæ£€æŸ¥ InitContainer çš„ &#x2F;restores ç›®å½•ä¸‹æ¯ä¸€ä¸ªå­ç›®å½•çš„ .velero ç›®å½•ä¸‹æ˜¯å¦æœ‰æ‰€æä¾›çš„ Restore UID æ–‡ä»¶ï¼Œå¦‚æœæ¯ä¸€ä¸ªå­ç›®å½•éƒ½æœ‰è¯¥ UID æ–‡ä»¶ï¼Œåˆ™è®¤ä¸ºæ¢å¤å®Œæˆï¼Œé€€å‡ºæ­»å¾ªç¯ï¼Œè¯¥ InitContainer ç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œå¦åˆ™ï¼Œç»§ç»­ç­‰å¾…ï¼Œæ— è¶…æ—¶æ—¶é—´<br><em>&#x2F;restores ä¸‹æ¯ä¸€ä¸ªå­ç›®å½•ä»£è¡¨ä¸€ä¸ªå¾…æ¢å¤çš„å·ï¼Œå‘½åä¸º Pod ä½¿ç”¨çš„ PVC volumeMount åç§°</em></li></ol>]]></content>
    
    
    <summary type="html">Velero ä¸­ä¸ VeleroServerã€ResticServer ç­‰ä¸»ä½“æœåŠ¡ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æºç èµ°è¯» â€” Provider</title>
    <link href="http://shenxianghong.github.io/2022/02/20/2022-02-20%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Provider/"/>
    <id>http://shenxianghong.github.io/2022/02/20/2022-02-20%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Provider/</id>
    <published>2022-02-19T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.169Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="Storage-Provider"><a href="#Storage-Provider" class="headerlink" title="Storage Provider"></a>Storage Provider</h1><p><em><u>pkg&#x2F;persistence&#x2F;object_store.go</u></em></p><p>StorageProvider æä¾›äº†ä¸€ç³»åˆ—çš„å°è£…äº† ObjectStore Plugin çš„æ¥å£ï¼Œç”¨äºæ“ä½œä½äº BackupStorageLocation ä¸Šæ•°æ®ã€‚</p><h2 id="IsValid"><a href="#IsValid" class="headerlink" title="IsValid"></a>IsValid</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ListCommonPrefixes(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;, &#x2F;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>é’ˆå¯¹è·å–åˆ°çš„å…¬å…±å‰ç¼€å­ç›®å½•ï¼Œè·å–å…¶å­ç›®å½•å±‚çº§æ˜¯å¦ä¸º backupsã€restoresã€resticã€metadata å’Œ plugins ä¹‹ä¸€ï¼Œå¦‚æœä¸æ˜¯åˆ™è¿”å› errorï¼Œè®¤ä¸º BackupStorageLocation ä¸å¯ç”¨ã€‚</p><p><em>ä¾‹å¦‚ï¼ŒBackupStorageLocation ä¸Šçš„ç›®å½•å±‚çº§ä¸º &lt;bucket&gt;&#x2F;&lt;prefix&gt;&#x2F;backups&#x2F;xxx å’Œ &lt;bucket&gt;&#x2F;&lt;prefix&gt;&#x2F;invalid&#x2F;xxxï¼Œè°ƒç”¨ ListCommonPrefixesï¼Œè·å–åˆ°çš„å…¬å…±å‰ç¼€å­ç›®å½•å±‚çº§æœ‰ prefix&#x2F;backups å’Œ prefix&#x2F;invalidï¼Œè¿›ä¸€æ­¥å¤„ç†åï¼Œè·å–åˆ°çš„å­ç›®å½•å±‚çº§ä¸º backups å’Œ invalidï¼Œå…¶ä¸­ï¼Œinvalid ä¸æ»¡è¶³ 5 ä¸ªå›ºå®šçš„åç§°ä¹‹ä¸€ï¼Œå› æ­¤è®¤ä¸º BackupStorageLocation ä¸å¯ç”¨ã€‚</em></p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>BackupStorageLocation Controller ä¼šé€šè¿‡è¯¥æ¥å£å‘¨æœŸæ€§æ£€æŸ¥ BackupStorageLocation æ˜¯å¦å¯ç”¨</li></ul><h2 id="ListBackups"><a href="#ListBackups" class="headerlink" title="ListBackups"></a>ListBackups</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ListCommonPrefixes(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;, &#x2F;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>é’ˆå¯¹è·å–åˆ°çš„å…¬å…±å‰ç¼€å­ç›®å½•ï¼Œå…¶å­ç›®å½•å±‚çº§ä¸º Backup çš„åç§°ï¼Œèšåˆå¹¶è¿”å›ã€‚</p><p><em>ä¾‹å¦‚ï¼ŒBackupStorageLocation ä¸Šçš„ç›®å½•å±‚çº§ä¸º &lt;bucket&gt;&#x2F;&lt;prefix&gt;&#x2F;backups&#x2F;backupA å’Œ &lt;bucket&gt;&#x2F;&lt;prefix&gt;&#x2F;backups&#x2F;backupBï¼Œè°ƒç”¨ ListCommonPrefixesï¼Œè·å–åˆ°çš„å…¬å…±å‰ç¼€å­ç›®å½•å±‚çº§æœ‰ &lt;prefix&gt;&#x2F;backups&#x2F;BackupA å’Œ &lt;prefix&gt;&#x2F;backups&#x2F;BackupBï¼Œè¿›ä¸€æ­¥å¤„ç†åï¼Œè·å–åˆ°çš„å­ç›®å½•å±‚çº§ä¸º BackupA å’Œ BackupBï¼Œåˆ™è¿”å›åŒ…å«ä¸¤è€…çš„åˆ—è¡¨ã€‚</em></p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>BackupSync Controller åœ¨åŒæ­¥ Backup æ—¶ï¼Œç”¨äºè·å– BackupStorageLocation ä¸­çš„ Backup</li></ul><h2 id="PutBackup"><a href="#PutBackup" class="headerlink" title="PutBackup"></a>PutBackup</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;.logs.gz, &lt;log&gt;)</li><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;velero-backup.json, &lt;metadata&gt;)</li><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;.tar.gz, &lt;content&gt;)</li><li>DeleteObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;velero-backup.json)</li><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-podvolumebackups.json.gz, &lt;podvolumebackups&gt;)</li><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-volumesnapshots.json.gz, &lt;volumesnapshots&gt;)</li><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-resource-list.json.gz, &lt;resource-list&gt;)</li><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-csi-volumesnapshots.json.gz, &lt;csi-volumesnapshots&gt;)</li><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-csi-volumesnapshotcontents.json.gz, &lt;csi-volumesnapshotcontents&gt;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>æŒ‰ç…§ä»¥ä¸‹é¡ºåºä¸Šä¼ æ–‡ä»¶</p><ol><li>Backup Logs<br><em>å¤‡ä»½è¿‡ç¨‹ä¸­ï¼ŒVelero æœåŠ¡äº§ç”Ÿçš„æ—¥å¿—</em></li><li>Backup Metadata<br><em>æè¿° Backup æœ¬èº«çš„ä¿¡æ¯</em></li><li>Backup Content<br><em>è¢«å¤‡ä»½çš„èµ„æºå†…å®¹</em></li><li>PodVolumeBackups<br><em>è¢«å¤‡ä»½çš„ Pod å·ä¿¡æ¯ï¼Œç”± Restic åˆ›å»ºå¹¶ç»´æŠ¤</em></li><li>PodVolumeSnapshots<br><em>è¢«å¤‡ä»½çš„ Pod å·å¿«ç…§ä¿¡æ¯ï¼Œç”± SnapshotProvider åˆ›å»ºå¹¶ç»´æŠ¤</em></li><li>Backup ResourcesList<br><em>è¢«å¤‡ä»½çš„èµ„æºæ¸…å•</em></li><li>CSI VolumeSnapshot<br><em>è¢«å¤‡ä»½çš„ Pod å·å¿«ç…§ä¿¡æ¯ï¼Œç”± CSI åˆ›å»ºå¹¶ç»´æŠ¤</em></li><li>CSI VolumeSnapshotContents<br><em>è¢«å¤‡ä»½çš„ Pod å·å¿«ç…§å†…å®¹ä¿¡æ¯ï¼Œç”± CSI åˆ›å»ºå¹¶ç»´æŠ¤</em></li></ol><p><em>ç¬¬ä¸€æ­¥æ—¥å¿—ä¸Šä¼ å¤±è´¥æ—¶ï¼Œä»…ä¼šæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œè€Œä¸ä¼šä¸­æ–­ä¸Šä¼ æµç¨‹ï¼Œæ˜¯å› ä¸ºè¯¥æ­¥éª¤ä¸å½±å“å¤‡ä»½çš„ä¸»ä½“é€»è¾‘ã€‚æ­¤åå¦‚æœæœ‰æ­¥éª¤å¤±è´¥ï¼Œä¼šå½±å“åˆ° Backup çš„çŠ¶æ€ï¼Œå¹¶ä¼šæ¸…ç©ºä¹‹å‰çš„æ“ä½œï¼Œå³è°ƒç”¨ DeleteObject åˆ é™¤å·²ä¸Šä¼ çš„æ•°æ®ã€‚</em></p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>Backup Controller åœ¨å¤‡ä»½å®Œæˆæ—¶ï¼Œå¤‡ä»½çš„èµ„æºä¿¡æ¯ä¸Šä¼ è‡³ BackupStorageLocation æ—¶</li></ul><h2 id="GetBackupMetadata"><a href="#GetBackupMetadata" class="headerlink" title="GetBackupMetadata"></a>GetBackupMetadata</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>GetObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;velero-backup.json)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>è·å–åˆ° velero-backup.json æ–‡ä»¶ï¼Œè¯»å–å†…å®¹ï¼Œè§£ææˆ Backup å¯¹è±¡æ ¼å¼ã€‚</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>BackupSync Controller åœ¨åŒæ­¥ Backup æ—¶ï¼Œç”¨äºæ„å»ºå¾…åŒæ­¥çš„ Backup å¯¹è±¡</li></ul><h2 id="GetBackupVolumeSnapshots"><a href="#GetBackupVolumeSnapshots" class="headerlink" title="GetBackupVolumeSnapshots"></a>GetBackupVolumeSnapshots</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ObjectExists(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;&lt;backups&gt;&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-volumesnapshots.json.gz)</li><li>GetObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;&lt;backups&gt;&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-volumesnapshots.json.gz)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>åˆ¤æ–­ BackupVolumeSnapshots æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è·å–å¹¶è§£æè¿”å›ã€‚</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>Restore Controller åœ¨æ¢å¤æ—¶ï¼Œä¼šè·å– Backup ç›¸å…³è”çš„ VolumeSnapshot å¹¶æ¢å¤</li><li>BackupDeletion Controller åœ¨åˆ é™¤å¤‡ä»½æ—¶ï¼Œä¼šä¸€å¹¶åˆ é™¤ VolumeSnapshot ä¿¡æ¯</li></ul><h2 id="GetBackupVolumeBackups"><a href="#GetBackupVolumeBackups" class="headerlink" title="GetBackupVolumeBackups"></a>GetBackupVolumeBackups</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ObjectExists(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;&lt;backups&gt;&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-podvolumebackups.json.gz)</li><li>GetObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;&lt;backups&gt;&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-podvolumebackups.json.gz)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>åˆ¤æ–­ PodVolumeBackup æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è·å–å¹¶è§£æè¿”å›ã€‚</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>BackupSync Controller åœ¨å¤„ç†éœ€è¦åŒæ­¥çš„ Backup æ—¶ï¼Œä¹Ÿä¼šåˆ¤æ–­æ˜¯å¦æœ‰ç›¸å…³è”çš„ PodVolumeBackup éœ€è¦è¢«åŒæ­¥</li></ul><h2 id="GetBackupContents"><a href="#GetBackupContents" class="headerlink" title="GetBackupContents"></a>GetBackupContents</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><p>GetObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;.tar.gz)</p><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>è°ƒç”¨æ¥å£ï¼Œåˆ¤æ–­æŒ‡å®šçš„å¤‡ä»½å†…å®¹ã€‚</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>Restore Controller åœ¨æ¢å¤æ—¶ï¼Œä¼šå°†å¤‡ä»½çš„å†…å®¹ä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œæ¢å¤åˆ›å»ºèµ„æº</li><li>BackupDeletion Controller åœ¨åˆ é™¤å¤‡ä»½æ—¶ï¼Œå¦‚æœå®šä¹‰äº† actionï¼Œä¼šå°†å¤‡ä»½çš„å†…å®¹ä¸‹è½½åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œè·å–åˆ° action å®šä¹‰çš„åŠ¨ä½œå¹¶æ‰§è¡Œ</li></ul><h2 id="GetCSIVolumeSnapshots"><a href="#GetCSIVolumeSnapshots" class="headerlink" title="GetCSIVolumeSnapshots"></a>GetCSIVolumeSnapshots</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ObjectExists(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;&lt;backups&gt;&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-csi-volumesnapshots.json.gz)</li><li>GetObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;&lt;backups&gt;&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-csi-volumesnapshots.json.gz)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>è°ƒç”¨ ObjectExists åˆ¤æ–­ VolumeSnapshots æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è·å–å¹¶è§£æè¿”å›</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>æ— </li></ul><h2 id="GetCSIVolumeSnapshotContents"><a href="#GetCSIVolumeSnapshotContents" class="headerlink" title="GetCSIVolumeSnapshotContents"></a>GetCSIVolumeSnapshotContents</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ObjectExists(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;&lt;backups&gt;&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-csi-volumesnapshotscontents.json.gz)</li><li>GetObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;&lt;backups&gt;&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-csi-volumesnapshotscontents.json.gz)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>åˆ¤æ–­ VolumeSnapshotsContents æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™è·å–å¹¶è§£æè¿”å›</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>BackupSync Controller åœ¨è·å–åˆ°éœ€è¦åŒæ­¥ Backup æ—¶ï¼Œå¦‚æœ Velero å¼€å¯äº† CSI ç‰¹æ€§ï¼Œç”¨äºè·å– VolumeSnapshotContents å¯¹è±¡ï¼Œåç»­ä¹Ÿä¼šåŒæ­¥è¯¥å¯¹è±¡</li></ul><h2 id="BackupExists"><a href="#BackupExists" class="headerlink" title="BackupExists"></a>BackupExists</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ObjectExists(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;velero-backup.json)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>è°ƒç”¨æ¥å£ï¼Œåˆ¤æ–­ç»™å®šçš„å¤‡ä»½æ˜¯å¦å­˜åœ¨ã€‚</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>Backup Controller åœ¨å¤‡ä»½æ—¶ï¼Œä¼šåˆ¤æ–­æœ¬æ¬¡åˆ›å»ºçš„å¤‡ä»½åœ¨ BackupStorageLocation ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™å°†å¤‡ä»½çŠ¶æ€è®¾ä¸º Failed</li></ul><h2 id="DeleteBackup"><a href="#DeleteBackup" class="headerlink" title="DeleteBackup"></a>DeleteBackup</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ListObjects(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;backups&#x2F;&lt;backup&gt;&#x2F;)</li><li>DeleteObject(&lt;bucket&gt;, &lt;key&gt;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>è°ƒç”¨ ListObjectsï¼Œè·å–æŒ‡å®šå¤‡ä»½åç§°ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå³ keyï¼Œéå†æ‰€æœ‰æ–‡ä»¶ï¼Œè°ƒç”¨ DeleteObject åˆ é™¤ keyã€‚<br><em>å¯ä»¥çœ‹åˆ°ï¼ŒVelero åœ¨åˆ é™¤å¤‡ä»½æ—¶ä»…ä¼šè°ƒç”¨ DeleteBackup åˆ é™¤æ‰€æœ‰çš„å­æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ keyï¼Œä½†æ˜¯ä¸ä¼šåˆ é™¤è¿™ä¸ªå¤‡ä»½ç›®å½•ï¼Œå› æ­¤å¦‚æœå…ˆè¦å®ç°åˆ é™¤æœ€åçš„ç©ºç›®å½•ï¼Œéœ€è¦åœ¨ StorageProvider çš„ DeleteObject æ¥å£å®ç°ã€‚</em></p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>BackupDeletion Controller åˆ é™¤æŒ‡å®šå¤‡ä»½æ—¶ï¼Œç”¨äºåˆ é™¤ BackupStorageLocation ä¸­çš„ Backup æ•°æ®</li></ul><h2 id="PutRestoreLog"><a href="#PutRestoreLog" class="headerlink" title="PutRestoreLog"></a>PutRestoreLog</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;restores&#x2F;&lt;restore&gt;&#x2F;restore-&lt;restore&gt;-logs.gz, &lt;log&gt;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>è°ƒç”¨æ¥å£ï¼Œä¸Šä¼ æ¢å¤æ—¥å¿—æ–‡ä»¶ã€‚</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>Restore Controller åœ¨æ¢å¤å®Œæˆæ—¶ï¼Œç”¨äºä¸Šä¼ æ¢å¤è¿‡ç¨‹ä¸­ Velero äº§ç”Ÿçš„æ—¥å¿—</li></ul><h2 id="PutRestoreResults"><a href="#PutRestoreResults" class="headerlink" title="PutRestoreResults"></a>PutRestoreResults</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>PutObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;restores&#x2F;&lt;restore&gt;&#x2F;restore-&lt;restore&gt;-logs.gz, &lt;result&gt;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>è°ƒç”¨æ¥å£ï¼Œä¸Šä¼ æ¢å¤ç»“æœä¿¡æ¯ã€‚</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>Restore Controller åœ¨æ¢å¤å®Œæˆæ—¶ï¼Œç”¨äºå°†æœ¬æ¬¡æ¢å¤è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ warning å’Œ error ä¿¡æ¯ä¸Šä¼ </li></ul><h2 id="DeleteRestore"><a href="#DeleteRestore" class="headerlink" title="DeleteRestore"></a>DeleteRestore</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>ListObject(&lt;bucket&gt;, &lt;prefix&gt;&#x2F;restores&#x2F;&lt;restore&gt;&#x2F;)</li><li>DeleteObject(&lt;bucket&gt;, &lt;key&gt;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>è°ƒç”¨ ListObjectsï¼Œè·å–æŒ‡å®šæ¢å¤åç§°ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå³ keyï¼Œéå†æ‰€æœ‰æ–‡ä»¶ï¼Œè°ƒç”¨ DeleteObject åˆ é™¤ keyã€‚<br><em>å¯ä»¥çœ‹åˆ°ï¼ŒVelero åœ¨åˆ é™¤æ¢å¤æ—¶ä»…ä¼šè°ƒç”¨ DeleteBackup åˆ é™¤æ‰€æœ‰çš„å­æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„ keyï¼Œä½†æ˜¯ä¸ä¼šåˆ é™¤è¿™ä¸ªæ¢å¤ç›®å½•ï¼Œå› æ­¤å¦‚æœå…ˆè¦å®ç°åˆ é™¤æœ€åçš„ç©ºç›®å½•ï¼Œéœ€è¦åœ¨ StorageProvider çš„ DeleteObject æ¥å£å®ç°ã€‚</em></p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>BackupDeletion Controller åœ¨åˆ é™¤ Backup æ—¶ï¼Œä¼šåŒæ­¥åˆ é™¤ç›¸å…³è”çš„ Restoreï¼Œå¹¶åˆ é™¤ BackupStorageLocation ä¸­çš„ Restore ä¿¡æ¯<br><em>BackupStorageLocation ä¸­ Restore çš„åˆ é™¤ä»…åœ¨è¯¥åœºæ™¯ä¸‹ï¼Œæ‰‹åŠ¨åˆ é™¤ Restoreï¼Œä¸ä¼šè§¦å‘ DeleteRestore æµç¨‹ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ velero restore delete xxx æ˜¯æ— æ³•åˆ é™¤ BackupStorageLocation ä¸­ Restore æ–‡ä»¶çš„ã€‚</em></li></ul><h2 id="GetDownloadURL"><a href="#GetDownloadURL" class="headerlink" title="GetDownloadURL"></a>GetDownloadURL</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>CreateSignedURL(&lt;bucket&gt;, &lt;target&gt;, 10min)<br><em>target è¡¨ç¤ºè¦æ ¹æ® DownloadRequest å¯¹è±¡è¦è·å–çš„ç›®æ ‡æ–‡ä»¶ï¼Œå…·ä½“å‚è€ƒ DownloadRequest ç« èŠ‚</em></li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><p>æ ¹æ® DownloadRequest çš„å¯¹è±¡ç±»åˆ«ï¼Œå³ targetï¼Œæ„å»ºä¸åŒçš„ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼Œè°ƒç”¨æ¥å£ï¼Œè·å– DownloadURLã€‚</p><p><strong>åº”ç”¨åœºæ™¯</strong></p><ul><li>DownloadRequest Controller åœ¨å¤„ç† DownloadRequest å¯¹è±¡æ—¶ï¼Œä¼šé€šè¿‡è¯¥æ¥å£æ„å»º DownloadURLï¼Œå¹¶å›å†™è‡³ DownloadRequest å¯¹è±¡ä¸­</li></ul><h1 id="Snapshot-Provider"><a href="#Snapshot-Provider" class="headerlink" title="Snapshot Provider"></a>Snapshot Provider</h1><p><em><u>pkg&#x2F;backup&#x2F;item_backupper.go</u></em><br><em><u>pkg&#x2F;restore&#x2F;pv_restorer.go</u></em></p><p>Velero å¹¶æœªåƒ Storage Provider å°è£…ä¸€äº›ä¸Šå±‚æ¥å£ï¼Œè€Œæ˜¯å°†åº•å±‚æ¥å£çš„è°ƒç”¨ç®€å•å°è£…äº†ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ï¼Œç”¨äºå¤‡ä»½å’Œæ¢å¤æ—¶ï¼Œå¯¹äº PV ç±»å‹çš„èµ„æºåšçš„å¿«ç…§å’Œæ¢å¤çš„æ“ä½œã€‚</p><h2 id="takePVSnapshot"><a href="#takePVSnapshot" class="headerlink" title="takePVSnapshot"></a>takePVSnapshot</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>init(snapshotLocation.Spec.Config)</li><li>GetVolumeID(&lt;Unstructured PV&gt;)</li><li>GetVolumeInfo(&lt;volumeID&gt;, &lt;volumeZone&gt;)</li><li>CreateSnapshot(&lt;volumeID&gt;, &lt;volumeZone&gt;, &lt;tags&gt;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><ol><li>åˆ¤æ–­ Backup çš„ SnapshotVolumes æ˜¯å¦å¼€å¯ï¼Œå¦‚æœå¼€å¯åˆ™è¡¨ç¤ºéœ€è¦å¯¹å·åšå¿«ç…§ï¼Œç»§ç»­æ‰§è¡Œä»¥ä¸‹é€»è¾‘</li><li>å¦‚æœ PV å·²ç»è¢«è®¤é¢†ï¼Œåˆ™éœ€è¦åˆ¤æ–­æ˜¯å¦è¢« Restic å·²ç»å¤‡ä»½ï¼ˆæ²¡æœ‰è¢«è®¤é¢†çš„ PV è‚¯å®šä¸ä¼šè¢« Restic å¤‡ä»½ï¼‰ï¼Œå¦‚æœå·²ç»å¤‡ä»½ï¼Œåˆ™ä¸ä¼šå†æ¬¡åˆ›å»ºå·å¿«ç…§</li><li>é€šè¿‡ PV çš„ label è·å– PV çš„ zone ä¿¡æ¯ï¼ˆtopology.kubernetes.io&#x2F;zone æˆ–è€… failure-domain.beta.kubernetes.io&#x2F;zoneï¼‰</li><li>é’ˆå¯¹ backup ä¸­æ¯ä¸€ä¸ª Snapshot Locationï¼Œåˆå§‹åŒ–ä¸€ä¸ª volumeSnapshotterï¼Œè°ƒç”¨ GetVolumeID å°è¯•è·å– VolumeID<br><em>PV å·è‚¯å®šæ˜¯ç”± Snapshot Provider åˆ›å»ºå‡ºæ¥çš„ï¼Œæ‰€ä»¥ GetVolumeID è‚¯å®šä¼šæœ‰è®°å½•ä¿å­˜</em></li><li>æ ¹æ® Backup çš„ label åˆ›å»º Tagï¼Œå¹¶è¿½åŠ  velero.io&#x2F;backup&#x3D;&lt;backupName&gt; å’Œ velero.io&#x2F;pv&#x3D;&lt;pvName&gt;</li><li>è°ƒç”¨ GetVolumeInfo æ¥å£ï¼Œè·å–åˆ°å·ä¿¡æ¯ï¼ŒåŒ…æ‹¬å·ç±»å‹å’Œ IOPS</li><li>æ ¹æ®ä»¥ä¸Šä¿¡æ¯æ„å»º volumeSnapshot å¯¹è±¡ï¼Œè°ƒç”¨ CreateSnapshot æ¥å£ï¼Œåˆ›å»ºå¿«ç…§</li><li>æ›´æ–° volumeSnapshot çŠ¶æ€ç­‰ä¿¡æ¯</li></ol><h2 id="executePVAction"><a href="#executePVAction" class="headerlink" title="executePVAction"></a>executePVAction</h2><p><strong>è°ƒç”¨æ¥å£</strong></p><ul><li>init(snapshotLocation.Spec.Config)</li><li>CreateVolumeFromSnapshot(&lt;snapshotID&gt;, &lt;volumeType&gt;, &lt;volumeZone&gt;,  &lt;volumeIOPS&gt;)</li><li>SetVolumeID(&lt;pv&gt;, &lt;VolumeID&gt;)</li></ul><p><strong>ä¸»ä½“é€»è¾‘</strong></p><ol><li>æ ¡éªŒ PV çš„åˆæ³•æ€§ï¼Œåˆ¤æ–­åç§°æ˜¯å¦å­˜åœ¨</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦é€šè¿‡å¿«ç…§æ¢å¤å·ï¼Œå³ Backup ä¸­æ˜¯å¦æŒ‡å®šäº†å¤‡ä»½å·ï¼ˆbackup.snapshotVolumesï¼‰ä»¥åŠ Restore ä¸­æ˜¯å¦æŒ‡å®šäº†æ¢å¤å·ï¼ˆrestore.restorePVsï¼‰</li><li>æ ¹æ® PV åç§°ä»¥åŠ Restore ç›¸å…³ä¿¡æ¯è·å– snapshot å¯¹è±¡</li><li>å¦‚æœè·å–åˆ° Snapshot å¯¹è±¡ï¼Œåˆ™åˆå§‹åŒ– volumeSnapshotter</li><li>æ ¹æ® snapshot å¯¹è±¡ä¸­çš„å·ä¿¡æ¯ï¼Œå¦‚å·ç±»å‹ï¼Œzoneï¼ŒIOPS ç­‰ä¿¡æ¯ï¼Œè°ƒç”¨ CreateVolumeFromSnapshot åˆ›å»ºå·ï¼Œå¹¶è·å– VolumeID ä¿¡æ¯</li><li>è°ƒç”¨ SetVolumeIDï¼Œç»™ PV è®¾ç½® VolumeIDï¼Œå¹¶è¿”å› PV çš„è§£æ„ç±»å‹</li></ol>]]></content>
    
    
    <summary type="html">Velero ä¸­ä¸ StorageProviderã€SnapshotProvider ç­‰ç»´æŠ¤ç«™ç‚¹èµ„æºç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æºç èµ°è¯» â€” Request</title>
    <link href="http://shenxianghong.github.io/2022/02/05/2022-02-05%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Request/"/>
    <id>http://shenxianghong.github.io/2022/02/05/2022-02-05%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Request/</id>
    <published>2022-02-04T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.168Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="DownloadRequest"><a href="#DownloadRequest" class="headerlink" title="DownloadRequest"></a>DownloadRequest</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/download_request_types.go">API</a></p><h2 id="DownloadTargetKind"><a href="#DownloadTargetKind" class="headerlink" title="DownloadTargetKind"></a>DownloadTargetKind</h2><p>ä»£è¡¨ç€è¦ä» BackupStorageLocation ä¸­ä¸‹è½½çš„æ–‡ä»¶ï¼Œæ˜ å°„å…³ç³»å¦‚ä¸‹</p><table><thead><tr><th>DownloadTargetKind</th><th>BackupStorageLocation ä¸­çš„æ–‡ä»¶</th></tr></thead><tbody><tr><td>BackupLog</td><td>backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-logs.gz</td></tr><tr><td>BackupContents</td><td>backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;.tar.gz</td></tr><tr><td>BackupVolumeSnapshots</td><td>backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-volumesnapshots.json.gz</td></tr><tr><td>BackupResourceList</td><td>backups&#x2F;&lt;backup&gt;&#x2F;&lt;backup&gt;-resource-list.json.gz</td></tr><tr><td>RestoreLog</td><td>restores&#x2F;&lt;restore&gt;&#x2F;&lt;restore&gt;-logs.gz</td></tr><tr><td>RestoreResults</td><td>restores&#x2F;&lt;restore&gt;&#x2F;restore-&lt;restore&gt;-results.gz</td></tr></tbody></table><h1 id="ServerStatusRequest"><a href="#ServerStatusRequest" class="headerlink" title="ServerStatusRequest"></a>ServerStatusRequest</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/server_status_request_types.go">API</a></p><p>ServerStatusRequest ä¸æ”¯æŒé€šè¿‡å‘½ä»¤è¡Œæ‰‹åŠ¨åˆ›å»ºï¼Œè€Œæ˜¯åœ¨è·å– Velero ç»„ä»¶çŠ¶æ€æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆè¯¥å¯¹è±¡ï¼Œç”± ServerStatusRequest Controller ç»´æŠ¤ã€‚</p><h1 id="DownloadRequest-Controller"><a href="#DownloadRequest-Controller" class="headerlink" title="DownloadRequest Controller"></a>DownloadRequest Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;download_request_controller.go</u></em><br><em><u>pkg&#x2F;cmd&#x2F;util&#x2F;downloadrequest&#x2F;downloadrequest.go</u></em></p><h2 id="Reconcile"><a href="#Reconcile" class="headerlink" title="Reconcile"></a>Reconcile</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/download_request_controller.go#L52">Reconcile æºç </a></p><ol><li>å¦‚æœ DownloadRequest çŠ¶æ€ä¸ä¸ºç©ºå¹¶ä¸”æœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œä»£è¡¨è¯¥å¯¹è±¡ä¸æ˜¯å·²ç»å¤„ç†è¿‡ï¼Œåˆ™éœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­å…¶æ˜¯å¦è¾¾åˆ°è¿‡æœŸæ—¶é—´<ul><li>å¦‚æœå·²è¿‡æœŸï¼Œåˆ™ä»é›†ç¾¤ä¸­åˆ é™¤</li><li>å¦‚æœæœªè¿‡æœŸï¼Œå¹¶ä¸”çŠ¶æ€ä¸º Processedï¼Œåˆ™ä¸åšå¤„ç†<br><em>è™½ç„¶å·²ç»å¤„ç†è¿‡äº†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç›´æ¥åˆ é™¤æ˜¯å› ä¸ºæœ‰å¯èƒ½ log æ–‡ä»¶æµè¿˜åœ¨ä½¿ç”¨</em></li></ul></li><li>å¦‚æœ DownloadRequest çŠ¶æ€æ˜¯ç©ºæˆ–è€… New çš„ï¼Œè°ƒç”¨ StorageProvider çš„ GetDownloadURL æ¥å£è·å– DownloadURL ä¿¡æ¯å¹¶è®¾ç½®åˆ° DownloadRequest ä¸­ï¼ŒåŒæ—¶æ›´æ–°å…¶çŠ¶æ€ä¸º Processedï¼Œé‡æ–°è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º 10 åˆ†é’Ÿ<br><em>å¦‚æœè°ƒç”¨ GetDownloadURL æ—¶å‡ºç°å¼‚å¸¸ï¼Œåˆ™éœ€è¦ç»ˆæ­¢æµç¨‹ï¼Œå¹¶ä¸”é‡æ–°å…¥é˜Ÿï¼Œäº¤ç»™ä¸‹æ¬¡æµç¨‹å¤„ç†</em></li><li>æœ€ç»ˆï¼Œä»¥ä¸Šæ­¥éª¤ä¸­å¦‚æœå­˜åœ¨æµç¨‹å¼‚å¸¸æˆ–è€…å¯¹è±¡è¢«åˆç†åˆ é™¤ï¼Œåˆ™ä¸å†é‡æ–°å…¥é˜Ÿï¼Œæ­¤åæµç¨‹ä¸­ï¼Œä¸å†å¤„ç†ï¼›å¦åˆ™ï¼Œ</li></ol><h2 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/cmd/util/downloadrequest/downloadrequest.go#L43">Stream æºç </a></p><p><em>ä¸Šå±‚åº”ç”¨æ–¹å¼ï¼Œå¹¶é DownloadRequest Controller é€»è¾‘</em></p><ol><li>æ ¹æ®å‡½æ•°å…¥å‚ä¿¡æ¯æ„å»º DownloadRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± DownloadRequest Controller è´Ÿè´£ç»´æŠ¤</li><li>æ¯ 25 æ¯«ç§’æ£€æµ‹ä¸€ä¸‹ï¼Œç›´è‡³ DownloadRequest çš„ DownloadURL è¢«è®¾ç½®<br><em>è¯¥åŠ¨ä½œå°±æ˜¯ DownloadRequest Controller æ ¸å¿ƒå·¥ä½œå†…å®¹</em></li><li>æ ¹æ® DownloadURL ä¿¡æ¯ï¼Œæ„å»º HTTP GET è¯·æ±‚ï¼Œè·å–åˆ° StorageProvider ä¸­çš„æ–‡ä»¶æ•°æ®ï¼Œå†™å…¥ç­¾åæä¾›çš„ io.Writer ä¸­</li></ol><p>åº”ç”¨çš„åœºæ™¯åŒ…æ‹¬</p><ul><li>velero backup download</li><li>velero backup&#x2F;restore describe</li><li>velero backup&#x2F;restore logs</li></ul><h1 id="ServerStatusRequest-Controller"><a href="#ServerStatusRequest-Controller" class="headerlink" title="ServerStatusRequest Controller"></a>ServerStatusRequest Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;server_status_request_controller.go</u></em></p><h2 id="Reconcile-1"><a href="#Reconcile-1" class="headerlink" title="Reconcile"></a>Reconcile</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/server_status_request_controller.go#L63">Reconcile æºç </a></p><ol><li>å¦‚æœ ServerStatusRequest çŠ¶æ€æ˜¯ç©ºæˆ–è€… Newï¼Œåˆ™æ›´æ–°å…¶çŠ¶æ€ä¸º Processedï¼Œè®¾ç½®å¤„ç†æ—¶é—´æˆ³ä»¥åŠ Velero æœåŠ¡ä¸­å®‰è£…çš„æ’ä»¶ä¿¡æ¯</li><li>å¦‚æœ ServerStatusRequest çŠ¶æ€æ˜¯ Processedï¼Œåˆ™åˆ¤æ–­å…¶æ˜¯å¦è¾¾åˆ°è¿‡æœŸæ—¶é—´<ul><li>å¦‚æœå·²è¿‡æœŸï¼Œåˆ™ä»é›†ç¾¤ä¸­åˆ é™¤</li><li>å¦‚æœæœªè¿‡æœŸï¼Œåˆ™è®¾ç½®ä¸‹æ¬¡å…¥é˜Ÿæ—¶é—´ä¸º 5 åˆ†é’Ÿä¹‹å</li></ul></li><li>å¦‚æœ ServerStatusRequest çŠ¶æ€ä¸æ»¡è¶³ä¸Šè¿°ï¼Œåˆ™ä¸å†é‡æ–°å…¥é˜Ÿï¼Œæ­¤åæµç¨‹ä¸­ï¼Œä¸å†å¤„ç†</li></ol><h2 id="GetServerStatus"><a href="#GetServerStatus" class="headerlink" title="GetServerStatus"></a>GetServerStatus</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/cmd/cli/serverstatus/server_status.go#L41">GetServerStatus æºç </a></p><p><em>ä¸Šå±‚åº”ç”¨æ–¹å¼ï¼Œé ServerStatusRequest Controller é€»è¾‘</em></p><ol><li>æ ¹æ®å‡½æ•°å…¥å‚ä¿¡æ¯æ„å»º ServerStatusRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± ServerStatusRequest Controller è´Ÿè´£ç»´æŠ¤</li><li>æ¯ 250 æ¯«ç§’æ£€æµ‹ä¸€ä¸‹ï¼Œç›´è‡³ ServerStatusRequest çš„çŠ¶æ€ä¸º Processedï¼Œè¿”å› ServerStatusRequest å¯¹è±¡ä¿¡æ¯<br><em>è¯¥åŠ¨ä½œå°±æ˜¯ ServerStatusRequest Controller æ ¸å¿ƒå·¥ä½œå†…å®¹</em></li></ol><p>åº”ç”¨çš„åœºæ™¯åŒ…æ‹¬</p><ul><li>velero plugin get</li></ul>]]></content>
    
    
    <summary type="html">Velero ä¸­ä¸ DownloadRequestã€ServerStatusRequest ç­‰èµ„æºè¯·æ±‚ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æºç èµ°è¯» â€” Restore</title>
    <link href="http://shenxianghong.github.io/2022/02/04/2022-02-04%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Restore/"/>
    <id>http://shenxianghong.github.io/2022/02/04/2022-02-04%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Restore/</id>
    <published>2022-02-03T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.168Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="Restore"><a href="#Restore" class="headerlink" title="Restore"></a>Restore</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/restore.go">API</a></p><h2 id="restore"><a href="#restore" class="headerlink" title="restore"></a>restore</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restore&#x2F;restore</u></em></p><p>velero restore åŒ…æ‹¬ 5 ä¸ªå­å‘½ä»¤ï¼šcreateã€deleteã€describeã€get å’Œ logsã€‚</p><h2 id="create"><a href="#create" class="headerlink" title="create"></a>create</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restore&#x2F;create.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>â€“from-backup å’Œ â€“from-schedule å‚æ•°æœ‰ä¸”ä»…èƒ½æœ‰ä¸€ä¸ª</li><li>åœ¨æŒ‡å®š â€“from-backup æˆ–è€… â€“from-schedule å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li><li>åœ¨æŒ‡å®š â€“from-schedule å‚æ•°æ—¶ï¼Œåˆ™ç”±è¯¥ Schedule åˆ›å»ºå‡ºçš„ Backup è‡³å°‘æœ‰ä¸€ä¸ª</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>å¦‚æœæŒ‡å®šäº† â€“from-schedule å‚æ•°å¹¶ä¸” â€“allow-partially-failed å‚æ•°ä¸º true æ—¶ï¼Œè·å–é›†ç¾¤ä¸­ç”±è¯¥ Schedule åˆ›å»ºå‡ºçš„çŠ¶æ€ä¸º Completed æˆ–è€… PartiallyFailed çš„æœ€æ–° Backupï¼Œä½œä¸ºæ¢å¤çš„åŸºå‡†ï¼Œå¹¶ä¸”å°† â€“from-schedule ä¿¡æ¯ç½®ç©ºï¼›å¦åˆ™ï¼Œåˆ™ç›´æ¥é€ä¼  â€“from-schedule ä¿¡æ¯ç”¨äºåç»­æ„å»º Restore å¯¹è±¡</li><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º Restore å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± Restore Controller è´Ÿè´£ç»´æŠ¤</li><li>å¦‚æœå¼€å¯äº† â€“waitï¼Œåˆ™å¯åŠ¨ informer ç›‘å¬ Restore å¯¹è±¡çŠ¶æ€ï¼Œé˜»å¡ç›´è‡³çŠ¶æ€ä¸å†æ˜¯ New æˆ–è€… InProgress</li></ol><h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restore&#x2F;delete.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>nameã€â€“all å’Œ â€“selector å‚æ•°æœ‰ä¸”ä»…èƒ½æœ‰ä¸€ä¸ª</li><li>è¦åˆ é™¤çš„ Restore åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œè·å–é›†ç¾¤ä¸­çš„ Restore èµ„æºå¹¶åˆ é™¤</li></ol><h2 id="describe"><a href="#describe" class="headerlink" title="describe"></a>describe</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restore&#x2F;describe.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Restore åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å–åˆ° PodVolumeRestore ä¿¡æ¯</li><li>å°†ä»¥ä¸Šä¿¡æ¯å’Œ Restore çš„å…ƒä¿¡æ¯ã€è§„æ ¼ã€çŠ¶æ€ä»¥åŠ Pod å·æ•°æ®æ¢å¤ç­‰æ±‡æ€»ä½œä¸ºæè¿°ä¿¡æ¯æ ¼å¼åŒ–è¾“å‡º<ul><li>å¦‚æœ Restore ä¸­æœ‰ Error æˆ–è€… Warning çš„æ—¥å¿—æ—¶ï¼Œä¼šæ„å»º DownloadRequest å¯¹è±¡è·å–  RestoreResults çš„ä¿¡æ¯ï¼Œå±•ç¤ºåŸå› </li><li>åœ¨å¼€å¯ â€“details æ—¶ï¼Œä¼šè¾“å‡ºæ¢å¤çš„ Pod å·ä¿¡æ¯</li></ul></li></ol><h2 id="get"><a href="#get" class="headerlink" title="get"></a>get</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restore&#x2F;get.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Restore åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å–åˆ° Restore èµ„æºï¼Œæ ¹æ® â€“output æŒ‡å®šçš„æ ·å¼æ ¼å¼åŒ–è¾“å‡º</li></ol><h2 id="logs"><a href="#logs" class="headerlink" title="logs"></a>logs</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restore&#x2F;logs.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Restore åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li><li>Restore çš„çŠ¶æ€å¿…é¡»ä¸º Completedã€PartiallyFailed æˆ–è€… Failed</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º DownloadRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»º RestoreLogï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± DownloadRequest Controller è´Ÿè´£ç»´æŠ¤ï¼Œè·å– RestoreLog çš„ä¿¡æ¯</li><li>é˜»å¡ç›´è‡³ DownloadRequest çš„ DownloadURL è¢«è®¾ç½®ï¼Œå°†å†…å®¹å†™å…¥ stdout ä¸­</li></ol><h1 id="PodVolumeRestore"><a href="#PodVolumeRestore" class="headerlink" title="PodVolumeRestore"></a>PodVolumeRestore</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/pod_volume_restore.go">API</a> </p><p>å¯¹è±¡ä¸æ”¯æŒæ‰‹åŠ¨åˆ›å»ºï¼Œè€Œæ˜¯åœ¨æ¢å¤æµç¨‹ä¸­ï¼Œç”± Restore Controller è°ƒç”¨ <strong>restoreItem</strong>ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ª Pod å·ï¼Œåˆ›å»ºä¸€ä¸ªè¯¥å¯¹è±¡ã€‚</p><h1 id="Restore-Controller"><a href="#Restore-Controller" class="headerlink" title="Restore Controller"></a>Restore Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;restore_controller.go</u></em><br><em><u>pkg&#x2F;restore&#x2F;restore.go</u></em></p><h2 id="NewRestoreController"><a href="#NewRestoreController" class="headerlink" title="NewRestoreController"></a>NewRestoreController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restore_controller.go#L99">NewRestoreController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li><li>ç›‘å¬ Restore èµ„æºçš„ Add äº‹ä»¶ï¼Œå°†çŠ¶æ€æ˜¯ç©ºæˆ–è€… New çš„ Restore ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li></ol><h2 id="processQueueItem"><a href="#processQueueItem" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restore_controller.go#L178">processQueueItem æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p><ol><li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ Restore keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ Restore å¯¹è±¡</li><li>ä»…å¤„ç†çŠ¶æ€ä¸ºç©ºæˆ–è€… New çš„ Restore å¯¹è±¡ï¼Œè°ƒç”¨ <strong>processRestore</strong>ï¼Œæ‰§è¡Œæ¢å¤</li></ol><h2 id="processRestore"><a href="#processRestore" class="headerlink" title="processRestore"></a>processRestore</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restore_controller.go#L215">processRestore æºç </a></p><p>æ¢å¤çš„æ•´ä½“æµç¨‹</p><ol><li><p>è°ƒç”¨ <strong>validateAndComplete</strong> åšä¸€äº›æ ¡éªŒå‡†å¤‡å·¥ä½œï¼Œå¹¶æ ¹æ®æ ¡éªŒç»“æœè®¾ç½®çŠ¶æ€ä¸º Restore çš„çŠ¶æ€ä¸º FailedValidation æˆ–è€… InProgress</p></li><li><p>è¿‡æ»¤æ‰æ ¡éªŒå¤±è´¥çš„ Restoreï¼Œè°ƒç”¨ <strong>runValidatedRestore</strong>ï¼Œæ‰§è¡Œæ¢å¤å’Œä¸Šä¼ æ¢å¤ä¿¡æ¯çš„æµç¨‹</p></li><li><p>æ ¹æ®æ­¥éª¤ 2 çš„æ¢å¤ç»“æœï¼Œè®¾ç½® Restore çš„çŠ¶æ€</p><ul><li>å¦‚æœæœ‰é”™è¯¯è¿”å›ï¼ˆå‡½æ•°è¿”å› errorï¼‰ï¼Œåˆ™è®¤ä¸ºæ¢å¤å¤±è´¥ï¼Œå°† Restore çŠ¶æ€è®¾ä¸º Failed</li><li>å¦‚æœ Restore çš„ Errors å­˜åœ¨é”™è¯¯ä¿¡æ¯ï¼Œåˆ™ä¸ºéƒ¨åˆ†å¤±è´¥ï¼Œå°† Restore çŠ¶æ€è®¾ä¸º PartiallyFailed</li><li>å¦åˆ™è®¤ä¸º Restore å·²å®Œå…¨æ¢å¤ï¼Œå°† Restore çŠ¶æ€è®¾ä¸º Completed</li></ul><p><em>runValidatedRestore æ‰§è¡Œæ¢å¤è¿‡ç¨‹ä¸­ä¼šè®¾ç½® Restore å¯¹è±¡çš„ status.Errors å’Œ status.Warning ä¿¡æ¯</em></p></li></ol><h2 id="validateAndComplete"><a href="#validateAndComplete" class="headerlink" title="validateAndComplete"></a>validateAndComplete</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restore_controller.go#L288">validateAndComplete æºç </a></p><p>æ ¡éªŒ Restore å¯¹è±¡å¹¶è¿”å› backupInfo ä¿¡æ¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> backupInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">backup      *api.Backup</span><br><span class="line">location    *velerov1api.BackupStorageLocation</span><br><span class="line">backupStore persistence.BackupStore</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>åœ¨ Restore å¯¹è±¡çš„ ExcludedResources ä¸­è¿½åŠ ä»¥ä¸‹èµ„æºï¼ˆä»¥ä¸‹èµ„æºä¼šè¢«å¤‡ä»½ï¼Œä½†æ˜¯ä¸ä¼šè¢«æ¢å¤ï¼‰<ul><li>nodes</li><li>events</li><li>events.events.k8s.io</li><li>backups.velero.io</li><li>restores.velero.io</li><li>resticrepositories.velero.io</li></ul></li><li>æ ¡éªŒ Restore å¯¹è±¡çš„ IncludedResources ä¸­æ˜¯å¦åŒ…å«ä¸Šè¿°èµ„æº</li><li>æ ¡éªŒ included&#x2F;excluded resources&#x2F;namespaces ä¿¡æ¯ä»¥åŠ â€“from-backup å’Œ â€“from-schedule æ˜¯å¦æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª</li><li>å¦‚æœæŒ‡å®šäº† â€“from-scheduleï¼Œåˆ™æ ¡éªŒå¹¶è·å– Schedule ä¸‹æœ€æ–°çš„ä¸€æ¬¡ Backupï¼Œå¹¶è®¾ç½®åœ¨ Restore ä¸­<br><em>å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ â€“from-backup å¿…ç„¶è®¾ç½®äº†ï¼Œå› æ­¤å°±ä¸éœ€è¦è®¾ç½® Restore çš„ Backup ä¿¡æ¯äº†</em></li><li>æ ¹æ® Restore çš„ Backup ä¿¡æ¯ï¼ŒæŸ¥è¯¢å¹¶è¿”å› BackupStorageLocationã€Backup å’Œ StorageProvider ä¿¡æ¯</li></ol><h2 id="runValidatedRestore"><a href="#runValidatedRestore" class="headerlink" title="runValidatedRestore"></a>runValidatedRestore</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restore_controller.go#L430">runValidatedRestore æºç </a></p><p>æ¢å¤çš„æ•´ä½“æµç¨‹</p><ol><li><p>è·å–æ³¨å†Œçš„ RestoreItemActions æ’ä»¶<br><em>åç»­åœ¨è°ƒç”¨ <strong>Restore</strong> å‡½æ•°æ¢å¤æ—¶ä¼šä½¿ç”¨åˆ°</em></p></li><li><p>è°ƒç”¨ StorageProvider çš„ GetBackupContents æ¥å£ï¼Œè·å–åˆ° Backup å†…å®¹æ–‡ä»¶ä¿¡æ¯ï¼Œå†™å…¥ä¸´æ—¶æ–‡ä»¶ä¸­</p></li><li><p>æ ¹æ® Restore ä¸­çš„ Backup åç§°ä¿¡æ¯ï¼Œè·å–åˆ°é›†ç¾¤ä¸­ PodVolumeBackup ä¿¡æ¯</p></li><li><p>è°ƒç”¨ StorageProvider çš„ GetBackupVolumeSnapshots æ¥å£ï¼Œè·å–åˆ° VolumeSnapshot ä¿¡æ¯</p></li><li><p>ç”¨ä»¥ä¸Šä¿¡æ¯æ„å»º Restore Requestï¼ˆåŸç†ç±»ä¼¼ Backup çš„ Requestï¼Œä¸åšèµ˜è¿°ï¼‰ï¼Œå…¶ä¸­ BackupReader ä¸ºæ­¥éª¤ 2 ä¸­çš„ä¸´æ—¶æ–‡ä»¶å¥æŸ„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</span><br><span class="line">*velerov1api.Restore</span><br><span class="line"></span><br><span class="line">Log              logrus.FieldLogger</span><br><span class="line">Backup           *velerov1api.Backup</span><br><span class="line">PodVolumeBackups []*velerov1api.PodVolumeBackup</span><br><span class="line">VolumeSnapshots  []*volume.Snapshot</span><br><span class="line">BackupReader     io.Reader</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ <strong>Restore</strong> è¿›è¡Œæ¢å¤ï¼Œè¿”å›æ¢å¤çš„ç»“æœ</p></li><li><p>é‡æ–°è·å– StorageProviderï¼Œé¿å…é•¿æ—¶é—´æ¢å¤ä¸­è®¤è¯ä¿¡æ¯å˜åŠ¨</p></li><li><p>å…³é—­æ—¥å¿—æ–‡ä»¶ï¼Œæœ¬æ¬¡æ¢å¤ä»»åŠ¡æ—¥å¿—è®°å½•å®Œæ¯•ï¼Œè°ƒç”¨ StorageProvider çš„ PutRestoreLog æ¥å£ï¼Œå°†æ¢å¤ä»»åŠ¡çš„æ—¥å¿—ä¿¡æ¯ä¸Šä¼ è‡³ BackupStorageLocation </p></li><li><p>ç»Ÿè®¡ Warning å’Œ Error çº§åˆ«æ—¥å¿—æ•°é‡ï¼Œæ›´æ–°è‡³ Restore å¯¹è±¡ä¸­ï¼Œå¹¶æ„å»º Result å¯¹è±¡ï¼ˆå³ä»£ç å—ä¸­çš„ m å¯¹è±¡ï¼‰ï¼Œè®°å½•è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ—¥å¿—ä¿¡æ¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">restore.Status.Warnings = <span class="built_in">len</span>(restoreWarnings.Velero) + <span class="built_in">len</span>(restoreWarnings.Cluster)</span><br><span class="line"><span class="keyword">for</span> _, w := <span class="keyword">range</span> restoreWarnings.Namespaces &#123;</span><br><span class="line">restore.Status.Warnings += <span class="built_in">len</span>(w)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">restore.Status.Errors = <span class="built_in">len</span>(restoreErrors.Velero) + <span class="built_in">len</span>(restoreErrors.Cluster)</span><br><span class="line"><span class="keyword">for</span> _, e := <span class="keyword">range</span> restoreErrors.Namespaces &#123;</span><br><span class="line">restore.Status.Errors += <span class="built_in">len</span>(e)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">m := <span class="keyword">map</span>[<span class="type">string</span>]pkgrestore.Result&#123;</span><br><span class="line"><span class="string">&quot;warnings&quot;</span>: restoreWarnings,</span><br><span class="line"><span class="string">&quot;errors&quot;</span>:   restoreErrors,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è°ƒç”¨ StorageProvider çš„ PutRestoreResults æ¥å£ï¼Œå°† Result ä¿¡æ¯ä¸Šä¼ è‡³ BackupStorageLocation ä¸­</p></li></ol><p>è°ƒç”¨ StorageProvider æ¥å£ä¸Šä¼ çš„å…·ä½“æ–‡ä»¶å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><table><thead><tr><th>åç§°</th><th>BackupStorageLocation ä¸­çš„æ–‡ä»¶</th><th>æ•°æ®æº</th></tr></thead><tbody><tr><td>Log</td><td>restore-&lt;restore&gt;-logs.gz</td><td>æ­¥éª¤ 8 ä¸­æœ€ç»ˆç”Ÿæˆçš„ log æ–‡ä»¶</td></tr><tr><td>Results</td><td>restore-&lt;restore&gt;-results.gz</td><td>æ­¥éª¤ 9 ä¸­æœ€ç»ˆç”Ÿæˆçš„ Result å¯¹è±¡</td></tr></tbody></table><h2 id="Restore-1"><a href="#Restore-1" class="headerlink" title="Restore"></a>Restore</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restore/restore.go#L159">Restore æºç </a></p><p>æ¢å¤åŠ¨ä½œæœ¬èº«çš„æµç¨‹</p><ol><li>è·å–åˆ° resource &amp; namespace çš„ included &amp; excludedã€resources hook ä»¥åŠ resolvedActionsï¼ˆRestoreItemActionï¼‰ï¼Œæ„å»º Restore Contextï¼ŒContext æ˜¯ç”¨äºæ‰§è¡Œæ¢å¤æ‰€éœ€è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</li><li>å°† request ä¸­çš„ BackupReader è§£å‹ï¼Œå¹¶å°†å†…å®¹è§£ææˆ Backup çš„èµ„æºä¿¡æ¯</li><li>å¦‚æœ Velero å¼€å¯äº† APIGroupVersions ç‰¹æ€§ï¼Œè°ƒç”¨ <a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restore/prioritize_group_version.go#L46">chooseAPIVersionsToRestore</a> å¯¹å¤š API Group Versions çš„èµ„æºé€‰æ‹©ä¸€ä¸ªè¦æ¢å¤çš„ç‰ˆæœ¬</li><li>ç”Ÿæˆ update é˜Ÿåˆ—ï¼Œç”¨äºè®°å½• Restore çŠ¶æ€ä¿¡æ¯ï¼ŒåŒæ—¶å¯åŠ¨ä¸€ä¸ª Goroutine ç›‘å¬é˜Ÿåˆ—ï¼Œæ¯ç§’é’Ÿè·å–ä¸€æ¬¡ update é˜Ÿåˆ—ä¸­çš„è¿›åº¦å¹¶æ›´æ–°è‡³é›†ç¾¤çš„ Restore ä¸­</li><li>é¦–å…ˆæ¢å¤ CRD èµ„æºï¼Œè°ƒç”¨ <strong>getOrderedResourceCollection</strong> å…ˆè·å–è¦æ¢å¤çš„ CRD èµ„æºé›†åˆï¼Œè°ƒç”¨ <strong>processSelectedResource</strong> å¼€å§‹æ¢å¤</li><li>æ¥ä¸‹æ¥è°ƒç”¨ <strong>getOrderedResourceCollection</strong> è·å–å‰©ä½™å¾…æ¢å¤èµ„æºçš„æœ‰åºé›†åˆï¼Œå¹¶è°ƒç”¨ <strong>processSelectedResource</strong> æ¢å¤<br><em>å†…ç½®çš„æ¢å¤é¡ºåºä¸ºï¼š<br>1. customresourcedefinitions<br />2. namespaces<br />3. storageclasses<br />4. volumesnapshotclass.snapshot.storage.k8s.io<br />5. volumesnapshotcontents.snapshot.storage.k8s.io<br />6. volumesnapshots.snapshot.storage.k8s.io<br />7. persistentvolumes<br />8. persistentvolumeclaims<br />9. secrets<br />10. configmaps<br />11. serviceaccounts<br />12. limitranges<br />13. pods<br />14. replicasets.apps<br />15. clusters.cluster.x-k8s.io<br />16. clusterresourcesets.addons.cluster.x-k8s.io</em></li><li>å…ƒæ•°æ®æ¢å¤å·²ç»å®Œæˆï¼Œæ›´æ–°é›†ç¾¤ä¸­ Restore çš„è¿›åº¦ä¿¡æ¯</li><li>ç­‰å¾… Restic æ¢å¤æ‰€æœ‰çš„ Pod å·æ•°æ®<br><em>PodVolumeRestore çš„åˆ›å»ºä½äºæ­¥éª¤ 6 ä¸­</em></li><li>ç­‰å¾… post restore exec hook æ‰§è¡Œå®Œæ¯•</li></ol><h2 id="getOrderedResourceCollection"><a href="#getOrderedResourceCollection" class="headerlink" title="getOrderedResourceCollection"></a>getOrderedResourceCollection</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restore/restore.go#L1642">getOrderedResourceCollection æºç </a></p><p>æ„å»ºè¦æ¢å¤çš„èµ„æºå¯¹è±¡çš„æœ‰åºé›†åˆ</p><ol><li>æ„å»ºéœ€è¦æ¢å¤çš„èµ„æºåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­å…ƒç´ ä¸ºèµ„æºçš„åç§°ï¼Œæ¯”å¦‚ customresourcedefinitions ç­‰</li><li>é’ˆå¯¹æ¯ä¸€ä¸ªèµ„æºåç§°ï¼Œæ„å»º GroupResourceï¼Œè·³è¿‡å·²ç»å¤„ç†çš„ã€è¢« included å’Œ excluded æ’é™¤åœ¨å¤–çš„ã€ç±»å‹ä¸º namespace çš„ GroupResource</li><li>é’ˆå¯¹è¯¥ GroupResource çš„æ¯ä¸€ç»„èµ„æºå®ä¾‹ï¼ˆè¿™ç»„èµ„æºå®ä¾‹æ˜¯ä»¥ namespace åšçš„åˆ’åˆ†ï¼‰ï¼Œå¦‚æœè¯¥èµ„æºå®ä¾‹çš„å‘½åç©ºé—´è¢«æ’é™¤ï¼Œåˆ™å¿½ç•¥ï¼›å¦åˆ™ï¼Œæ ¹æ®æ¢å¤æ—¶çš„å‘½åç©ºé—´æ˜ å°„å…³ç³»ï¼Œè·å–æœ€ç»ˆè¦åˆ›å»ºæ¢å¤èµ„æºçš„å‘½åç©ºé—´</li><li>å¦‚æœæœ€ç»ˆè¦æ¢å¤åˆ°çš„å‘½åç©ºé—´ä¸ºç©ºï¼Œä»£è¡¨è¯¥èµ„æºæ˜¯é›†ç¾¤çº§åˆ«çš„ï¼Œå¹¶ä¸”åœ¨æœªæŒ‡å®šåŒ…å«å…¨éƒ¨å‘½åç©ºé—´æˆ–è€…æŒ‡å®šäº†ç‰¹å®šæ¢å¤çš„å‘½åç©ºé—´çš„æƒ…å†µï¼Œåˆ™å¿½ç•¥</li><li>é’ˆå¯¹æ¯ä¸€ç»„èµ„æºå®ä¾‹ä¸­çš„å…·ä½“èµ„æºï¼Œæ ¹æ® Backup çš„ Content ç›®å½•è¯»å–è¯¥èµ„æºæ–‡ä»¶ä¿¡æ¯ï¼Œååºåˆ—åŒ–æˆå¯¹è±¡ç»“æ„ï¼Œæœ€ç»ˆé’ˆå¯¹è¯¥èµ„æºç»„å®ä¾‹ï¼Œæ„å»ºå‡ºä¸€ä¸ªå¯æ¢å¤ã€å¾…æ¢å¤çš„èµ„æºé›†åˆ</li></ol><h2 id="processSelectedResource"><a href="#processSelectedResource" class="headerlink" title="processSelectedResource"></a>processSelectedResource</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restore/restore.go#L582">processSelectedResource æºç </a></p><p>å•ä¸ª item èµ„æºçš„æ¢å¤æµç¨‹</p><ol><li>é’ˆå¯¹æ¯ä¸€ä¸ªè¦æ¢å¤çš„ item èµ„æºï¼Œåœ¨è¦æ¢å¤åˆ°çš„å‘½åç©ºé—´ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œæå‰åˆ›å»º</li><li>æ ¹æ® Backup çš„ Content ç›®å½•è¯»å–è¯¥èµ„æºæ–‡ä»¶ä¿¡æ¯ï¼Œååºåˆ—åŒ–æˆå¯¹è±¡ç»“æ„ï¼Œè°ƒç”¨ <strong>restoreItem</strong> è¿›è¡Œæ¢å¤</li><li>æ¯æ¢å¤å®Œä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™æ›´æ–°ä¸€ä¸‹ update é˜Ÿåˆ—ï¼Œä¸ŠæŠ¥æ¢å¤è¿›åº¦</li></ol><h2 id="restoreItem"><a href="#restoreItem" class="headerlink" title="restoreItem"></a>restoreItem</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restore/restore.go#L907">restoreItem æºç </a></p><p>å•ä¸ª item èµ„æºçš„æ¢å¤æµç¨‹</p><ol><li>ä¼ å…¥çš„ item æ˜¯è§£æ„çŠ¶æ€çš„èµ„æºä¿¡æ¯ï¼ˆruntime.Unstructuredï¼‰</li><li>å¦‚æœæœ€ç»ˆè¦æ¢å¤åˆ°çš„å‘½åç©ºé—´ä¸ä¸ºç©ºï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µæå‰åˆ›å»ºï¼›å¦‚æœä¸ºç©ºï¼Œä»£è¡¨è¯¥èµ„æºæ˜¯é›†ç¾¤çº§åˆ«çš„ï¼Œåœ¨ä¸æ¢å¤é›†ç¾¤çº§åˆ«èµ„æºæ—¶ï¼Œä¼šå¿½ç•¥æ‰è¯¥èµ„æº</li><li>ä»¥ä¸‹èµ„æºè§†ä¸ºâ€œå®Œæˆâ€ï¼Œä¸ä¼šè¿›è¡Œæ¢å¤<ul><li>ç›¸ä½ä¸º Succeed æˆ–è€… Failed çš„ Pod</li><li>å·²ç»æœ‰å®Œæˆæ—¶é—´çš„ Job</li><li>å·²ç»æ¢å¤çš„èµ„æº</li><li>mirror Pod</li></ul></li><li>å¦‚æœæ¢å¤çš„èµ„æºæ˜¯ PV ç±»å‹ï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹åœºæ™¯<ul><li>å¦‚æœè¦æ¢å¤çš„ PV ä¸­æœ‰å¿«ç…§ä¿¡æ¯ï¼Œä»£è¡¨ç€å¤‡ä»½æ—¶ SnapshotProvider æ‰§è¡Œè¿‡å¿«ç…§æ“ä½œ<br>å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹å…¶é‡å‘½åï¼Œä»¥ä¸‹æƒ…å†µä¸éœ€è¦é‡å‘½å<ul><li>æ¢å¤æ—¶æœªæŒ‡å®šå‘½åç©ºé—´æ˜ å°„å…³ç³»</li><li>è¦æ¢å¤çš„ PV æœªè¢«è®¤é¢†</li><li>è®¤é¢†è¯¥ PV çš„å‘½åç©ºé—´ä¸éœ€è¦è¢«æ˜ å°„</li><li>å½“å‰é›†ç¾¤ä¸­ä¸å­˜åœ¨é‡å PV<br>å¦‚æœæ¢å¤æ—¶ï¼ŒæŒ‡å®šäº†å‘½åç©ºé—´æ˜ å°„å…³ç³»ï¼Œéœ€è¦æ ¹æ®æ˜ å°„å…³ç³»ï¼Œå°†è®¤é¢† PV çš„å‘½åç©ºé—´ï¼ˆå³ spec.ClaimRef.Namespaceï¼‰è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœåˆ¤æ–­åä¸éœ€è¦å¯¹ PV é‡å‘½åæ—¶ï¼Œåˆ™è¯´æ˜è¯¥ PV åº”è¯¥è¢«æ¢å¤ï¼Œåä¹‹éœ€è¦åˆ¤æ–­è¯¥ PV å¯¹è±¡æ˜¯å¦åº”è¯¥è¢«æ¢å¤ï¼Œå…·ä½“è§„åˆ™å¦‚ä¸‹</li><li>å½“å‰é›†ç¾¤ä¸­ä¸å­˜åœ¨é‡å PVï¼Œåˆ™åº”è¯¥è¢«æ¢å¤</li><li>é‡å PV å¤„äº Release çŠ¶æ€ï¼Œç­‰å¾…ç›´è‡³è¶…æ—¶</li><li>é‡å PV æ²¡æœ‰è¢«è®¤é¢†ï¼Œåˆ™ä¸åº”è¯¥è¢«æ¢å¤</li><li>é‡å PV è¢«è®¤é¢†ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°ç›¸å…³ PVCï¼Œåˆ™ç­‰å¾… PVC åˆ›å»ºç›´è‡³è¶…æ—¶</li><li>è®¤é¢†é‡å PV çš„ PVC å¤„äºåˆ é™¤çŠ¶æ€ï¼Œç­‰å¾…ç›´è‡³è¶…æ—¶</li><li>è®¤é¢†é‡å PV çš„ PVC æ‰€åœ¨å‘½åç©ºé—´ä¸å­˜åœ¨æˆ–è€…å¤„äºåˆ é™¤çŠ¶æ€ï¼Œç­‰å¾…ç›´è‡³è¶…æ—¶</li><li><em>é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º 10 åˆ†é’Ÿï¼Œæœªè¶…æ—¶æœŸé—´å†…ä¼šå‘¨æœŸæ€§åˆ¤æ–­ï¼Œä¸€æ—¦è¶…æ—¶åˆ™è¡¨ç¤ºä¸åº”è¯¥è¢«æ¢å¤</em><br>å¦‚æœ PV åº”è¯¥è¢«æ¢å¤ï¼Œåˆ™é‡ç½®ä¹‹å‰çš„ç»‘å®šä¿¡æ¯ï¼Œè°ƒç”¨ SnapshotProvider çš„ä¸€ç³»åˆ—æ¥å£æ¢å¤å·æ•°æ®ä¿¡æ¯ï¼Œå‚è€ƒ executePVActionï¼Œå¹¶æ ¹æ®éœ€è¦é‡å‘½å PV</li></ul></li><li>å¦‚æœè¦æ¢å¤çš„ PV çš„å·æ•°æ®æ˜¯ç”± Restic è´Ÿè´£å¤‡ä»½çš„ï¼ˆå³ PodVolumeBackup annotation ä¿¡æ¯ä¸­è®°å½•äº† pv.Spec.ClaimRef.Nameï¼‰ï¼Œåˆ™ä¸ä¼šæ¢å¤ï¼Œè€Œæ˜¯äº¤ç»™ StorageClass é‡æ–°åŠ¨æ€ä¾›åº”</li><li>å¦‚æœè¦æ¢å¤çš„ PV çš„å›æ”¶ç­–ç•¥ä¸º Deleteï¼Œåˆ™ä¸ä¼šæ¢å¤ï¼Œè€Œæ˜¯äº¤ç»™ StorageClass é‡æ–°åŠ¨æ€ä¾›åº”</li><li>å¦‚æœå¹¶éä»¥ä¸Šä»»æ„åœºæ™¯ï¼Œåˆ™ä¸éœ€è¦é¢å¤–çš„ç‰¹æ®Šæ“ä½œï¼Œé‡ç½®ç»‘å®šä¿¡æ¯ï¼Œè¿›è¡Œåç»­æµç¨‹ç›´æ¥æ¢å¤å³å¯</li></ul></li><li>åˆ é™¤æ‰ä¸å…³é”®çš„å…ƒä¿¡æ¯ï¼Œä»…ä¿ç•™ nameã€namespaceã€labels å’Œ annotationï¼Œå¹¶åˆ é™¤å¯¹è±¡ status ä¿¡æ¯ï¼Œæ‰§è¡Œ RestoreItemAction çš„åŠ¨ä½œ</li><li>å¦‚æœæ¢å¤çš„èµ„æºæ˜¯ PVC ç±»å‹ï¼Œåˆ™é‡ç½®ä¹‹å‰çš„å’Œ PV çš„ç»‘å®šä¿¡æ¯ä»¥åŠ K8s è®¾ç½®çš„ annotationï¼Œå¦‚æœè®¤é¢†çš„ PV é‡å‘½åäº†ï¼Œåˆ™åŒæ­¥æ›´æ–° PVC ä¿¡æ¯</li><li>æ ¹æ®å‘½åç©ºé—´æ˜ å°„å…³ç³»ï¼Œè®¾ç½® item çš„æ–°å‘½åç©ºé—´ï¼Œå¹¶è®¾ç½® velero.io&#x2F;backup-name å’Œ velero.io&#x2F;restore-name æ ‡ç­¾ä¿¡æ¯</li><li>åœ¨å½“å‰é›†ç¾¤ä¸­åˆ›å»º item èµ„æºï¼Œå¦‚æœ item èµ„æºå·²ç»å­˜åœ¨ï¼ˆä½†æ˜¯å´åˆä¸æ·±åº¦ä¸€è‡´ï¼‰å¹¶ä¸”æ˜¯ ServiceAccount ç±»å‹ï¼Œåˆ™ä¼šä»¥é›†ç¾¤å½“å‰çš„ ServiceAccount èµ„æºä¸ºå‡†åˆå¹¶ item èµ„æºå¹¶æ›´æ–°ï¼Œè€Œå¯¹äºå…¶ä»–ç±»å‹çš„èµ„æºåˆ™è®¤ä¸ºæ¢å¤å¤±è´¥ï¼ŒåŸå› æ˜¯å¤‡ä»½çš„ç‰ˆæœ¬å’Œæ¢å¤çš„ç‰ˆæœ¬ä¸ä¸€è‡´ï¼›è€Œå¦‚æœå·²å­˜åœ¨çš„ item å’Œå¾…æ¢å¤çš„ item æ·±åº¦ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯ä¸¤è€…ç‰ˆæœ¬ä¸€è‡´ï¼Œä¸ä¼šæ¢å¤ï¼Œä¹Ÿä¸ä¼šè§†ä¸ºé”™è¯¯</li><li>å¦‚æœæ¢å¤çš„èµ„æºæ˜¯ Pod ç±»å‹ï¼Œä¼šé’ˆå¯¹æ¯ä¸€ä¸ªè¢« Restic å¤‡ä»½çš„å·ï¼Œåˆ›å»ºä¸€ä¸ª PodVolumeRestore å¯¹è±¡ï¼Œåç»­ç”± PodVolumeRestore Controller è´Ÿè´£ç»´æŠ¤ï¼ŒåŒæ—¶ï¼Œä¸»è¿›ç¨‹ä¼šé˜»å¡ç›´åˆ° PodVolumeRestore æœ‰çŠ¶æ€è¿”å›ï¼Œè¡¨ç¤ºå·æ•°æ®æ¢å¤å®Œæˆ</li><li>å¦‚æœæ¢å¤çš„èµ„æºæ˜¯ Pod ç±»å‹ï¼Œæ‰§è¡Œ post restore hook æ“ä½œ</li><li>å¦‚æœæ¢å¤çš„èµ„æºæ˜¯ CRD ç±»å‹ï¼Œåˆ™ç­‰å¾…ç›´è‡³ CRD èµ„æºå˜å¾—å¯ç”¨æ‰ç»§ç»­æ‰§è¡Œåç»­æ¢å¤æµç¨‹</li></ol><h1 id="PodVolumeRestore-Controller"><a href="#PodVolumeRestore-Controller" class="headerlink" title="PodVolumeRestore Controller"></a>PodVolumeRestore Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;pod_volume_restore_controller.go</u></em><br><em><u>pkg&#x2F;restic&#x2F;exec_commands.go</u></em></p><h2 id="NewPodVolumeRestoreController"><a href="#NewPodVolumeRestoreController" class="headerlink" title="NewPodVolumeRestoreController"></a>NewPodVolumeRestoreController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_restore_controller.go#L72">NewPodVolumeRestoreController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandlerï¼Œå¹¶å°† PodVolumeRestoreã€Pod å’Œ PVC æ·»åŠ åˆ° cacheSyncWaitersï¼Œç­‰å¾…åŒæ­¥å®Œæˆ</li><li>ç›‘å¬ PodVolumeRestore èµ„æºçš„ Add å’Œ Update äº‹ä»¶ï¼Œæ ¹æ®çŠ¶æ€æ˜¯ New çš„ PodVolumeRestore èµ„æºè·å–åˆ°ç›¸å…³è”çš„ Podï¼Œå¦‚æœ Pod è¿è¡Œåœ¨æœ¬èŠ‚ç‚¹ï¼Œå¹¶ä¸” Restic Init Container å¤„äº Runningï¼Œåˆ™å°† PodVolumeRestore ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰ çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­<br><em>restic-wait å¤„äºè¿è¡ŒçŠ¶æ€è¡¨ç¤ºï¼Œè¯¥ Pod æ­£åœ¨ç­‰å¾… Restic ä¸ºå…¶æ¢å¤å·æ•°æ®</em></li><li>ç›‘å¬ Pod èµ„æºçš„ Add å’Œ Update äº‹ä»¶ï¼Œé’ˆå¯¹è¿è¡Œåœ¨æœ¬èŠ‚ç‚¹ï¼Œå¹¶ä¸” Restic Init Container å¤„äº Runningï¼Œè·å–åˆ°ç›¸å…³è”çš„ PodVolumeRestore èµ„æºï¼Œå°†çŠ¶æ€æ˜¯ New çš„ PodVolumeRestore ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰ çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li></ol><h2 id="processQueueItem-1"><a href="#processQueueItem-1" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_restore_controller.go#L240">processQueueItem æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p><ol><li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ PodVolumeRestore keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ PodVolumeRestore å¯¹è±¡</li><li>è°ƒç”¨ <strong>processRestore</strong>ï¼Œæ‰§è¡Œå·æ•°æ®çš„å¤‡ä»½</li></ol><h2 id="processRestore-1"><a href="#processRestore-1" class="headerlink" title="processRestore"></a>processRestore</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_restore_controller.go#L277">processRestore æºç </a></p><p>å·æ•°æ®æ¢å¤çš„æ•´ä½“æµç¨‹</p><ol><li>æ›´æ–° PodVolumeRestore çŠ¶æ€ä¸º InProgress</li><li>è·å–åˆ° PodVolumeRestore ç›¸å…³è”çš„ Podï¼Œè¿›ä¸€æ­¥è·å–åˆ° Pod å†…éƒ¨çš„æŒ‚è½½å·ç›®å½•ä¿¡æ¯</li><li>è°ƒç”¨ <strong>restorePodVolume</strong> æ‰§è¡Œå·æ•°æ®çš„æ¢å¤ï¼Œå¦‚æœè°ƒç”¨ç»“æœæœ‰é”™è¯¯è¿”å›ï¼Œåˆ™è®¾ç½® PodVolumeRestore çŠ¶æ€ä¸º Failed</li><li>æ›´æ–° PodVolumeRestore çŠ¶æ€ä¸º Completed</li></ol><h2 id="restorePodVolume"><a href="#restorePodVolume" class="headerlink" title="restorePodVolume"></a>restorePodVolume</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_restore_controller.go#L326">restorePodVolume æºç </a></p><p>å€ŸåŠ© Restic èƒ½åŠ›æ¢å¤å·æ•°æ®çš„æµç¨‹</p><ol><li>æ ¹æ® Pod å†…éƒ¨çš„æŒ‚è½½å·ä¿¡æ¯å’Œ Restic Pod å†…éƒ¨çš„ &#x2F;host_pods ç›®å½•ï¼Œæ‹¼æ¥å‡ºåˆ° Pod æŒ‚è½½æ•°æ®å·ç›®å½•<br><em>æœ€ç»ˆæ•°æ®ä¼šä» Restic Repo å°†å·æ•°æ®æ¢å¤è‡³è¿™ä¸ªç›®å½•ï¼Œä¾‹å¦‚ &#x2F;host_pods&#x2F;new-pod-uid&#x2F;volumes&#x2F;volume-plugin-name&#x2F;volume-dir</em></li><li>ç”Ÿæˆç”¨äºè¿æ¥ Restic Repo æ‰€éœ€è¦çš„ä¸´æ—¶å¯†ç æ–‡ä»¶ï¼Œæ–‡ä»¶å›ºå®šä¸º &#x2F;tmp&#x2F;credentials&#x2F;velero&#x2F;velero-restic-credentials-repository-passwordï¼Œå†…å®¹ä¸º static-passw0rdï¼Œç”¨äº restic åŸç”Ÿå‘½ä»¤ä¸­çš„ â€“password å‚æ•°<br><em>å¯†ç ä¼šä»¥ Secret çš„å½¢å¼å­˜å‚¨åœ¨é›†ç¾¤ä¸­ï¼Œåä¸º velero-restic-credentialsï¼Œä½äº velero å‘½åç©ºé—´å†…</em></li><li>æ„å»º restic restore å‘½ä»¤</li><li>å¦‚æœ BackupStorageLocation æœ‰ caCert è¯ä¹¦ä¿¡æ¯ï¼Œä¼šå°†å…¶ä¸´æ—¶å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œä¾› Restic è®¤è¯ä½¿ç”¨ï¼Œå¹¶è®¾ç½®åœ¨ restic restore å‘½ä»¤ä¸­</li><li>ç»™ restic restore å‘½ä»¤è®¾ç½® Restic åŸç”Ÿæ‰€éœ€çš„ç¯å¢ƒå˜é‡ä¿¡æ¯</li><li>è°ƒç”¨ <strong>RunRestore</strong>ï¼Œæ‰§è¡Œ Restic åŸç”Ÿçš„å·æ•°æ®æ¢å¤æµç¨‹</li><li>ä¸ºäº†ä¿é™©èµ·è§ï¼Œå…ˆç§»é™¤å·ç›®å½•ä¸‹çš„ .velero ç›®å½•ï¼Œç„¶åé‡æ–°åˆ›å»ºï¼Œå¹¶å†™å…¥ Restore çš„ UIDï¼ŒRestic çš„ Init Container ä¼šä¸€è‡´ç­‰å¾…ç›´åˆ°è¯»å–åˆ°è¿™ä¸ªæ–‡ä»¶çš„ç”Ÿæˆ</li></ol><h2 id="RunRestore"><a href="#RunRestore" class="headerlink" title="RunRestore"></a>RunRestore</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restic/exec_commands.go#L186">RunRestore æºç </a></p><p>è°ƒç”¨ Restic åŸç”Ÿå¤‡ä»½å‘½ä»¤ restic restore</p><ol><li>é€šè¿‡ restic stats å‘½ä»¤è·å–åˆ°æ€»å¿«ç…§çš„å¤§å°ï¼Œå¹¶æ›´æ–°è‡³ PodVolumeRestore ä¸­</li><li>å°†å…¥å‚çš„ Command å¯¹è±¡æ„å»ºæˆå¯æ‰§è¡Œå‘½ä»¤å¹¶æ‰§è¡Œ</li><li>å¯åŠ¨ä¸€ä¸ª Goroutineï¼Œæ¯ 10 ç§’é’Ÿè·å–ä¸€æ¬¡å·²ç»æ¢å¤çš„æ•°æ®ç›®å½•æ€»å¤§å°ï¼Œå¹¶æ›´æ–° PodVolumeRestore æ€»æ¢å¤è¿›åº¦ï¼ˆå¾…æ¢å¤æ€»æ–‡ä»¶å¤§å°å’Œå½“å‰æ¢å¤æ–‡ä»¶å¤§å°ï¼‰</li><li>æ¢å¤å®Œæˆåï¼Œæ›´æ–° PodVolumeRestore è¿›åº¦è‡³ 100%<br><em>æ­¤å¤„æœªåˆ¤æ–­æ¢å¤æˆåŠŸä¸å¦ï¼Œåªæ˜¯å°†è¿›åº¦è®¾ä¸º 100%ï¼Œå¹¶è¿”å› restic restore çš„ stdoutï¼Œstderr å’Œ err ä¿¡æ¯ï¼Œç”±ä¸Šå±‚è°ƒç”¨æ–¹åˆ¤æ–­</em></li></ol>]]></content>
    
    
    <summary type="html">Velero ä¸­ä¸ Restore ç­‰æ¢å¤ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æºç èµ°è¯» â€” Backup</title>
    <link href="http://shenxianghong.github.io/2022/01/27/2022-01-27%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Backup/"/>
    <id>http://shenxianghong.github.io/2022/01/27/2022-01-27%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Backup/</id>
    <published>2022-01-26T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.167Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="Backup"><a href="#Backup" class="headerlink" title="Backup"></a>Backup</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/backup.go">API</a></p><h2 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;backup.go</u></em></p><p>velero backup åŒ…æ‹¬ 6 ä¸ªå­å‘½ä»¤ï¼šcreateã€deleteã€describeã€downloadã€get å’Œ logsã€‚</p><h2 id="create"><a href="#create" class="headerlink" title="create"></a>create</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;create.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>å¿…é¡»æŒ‡å®š Backup åç§°ï¼Œé™¤éæŒ‡å®šäº† â€“from-schedule å‚æ•°</li><li>åœ¨æŒ‡å®š â€“storage-location å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li><li>åœ¨æŒ‡å®š â€“volume-snapshot-locations å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º Backup å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± Backup Controller è´Ÿè´£ç»´æŠ¤</li><li>å¦‚æœå¼€å¯äº† â€“waitï¼Œåˆ™å¯åŠ¨ informer ç›‘å¬ Backup å¯¹è±¡çŠ¶æ€ï¼Œé˜»å¡ç›´è‡³çŠ¶æ€ä¸å†æ˜¯ New æˆ–è€… InProgress</li></ol><p><em>å¦‚æœ Backup æ˜¯åŸºäºå®šæ—¶ä»»åŠ¡ï¼ˆScheduleï¼‰åˆ›å»ºçš„ï¼Œåˆ™å¿½ç•¥å…¶ä»–æ‰€æœ‰çš„ filter ä¿¡æ¯ï¼Œä»¥ Schedule è§„æ ¼ä¸ºå‡†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒBackup çš„åç§°ä¹Ÿå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤æ ¼å¼ä¸º schedule-timestampã€‚</em></p><h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;delete.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>nameã€â€“all å’Œ â€“selector å‚æ•°æœ‰ä¸”ä»…èƒ½æœ‰ä¸€ä¸ª</li><li>è¦åˆ é™¤çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º DeleteBackupRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± BackupDeletion Controller è´Ÿè´£ç»´æŠ¤</li></ol><h2 id="describe"><a href="#describe" class="headerlink" title="describe"></a>describe</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;describe.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å–åˆ° Backup çš„åˆ é™¤äº‹ä»¶</li><li>è·å–åˆ°å·å¤‡ä»½çš„ä¿¡æ¯å’Œ CSI å¿«ç…§ä¿¡æ¯ï¼ˆå¦‚æœ Velero æœåŠ¡å¼€å¯äº† CSI ç‰¹æ€§ï¼‰</li><li>å°†ä»¥ä¸Šä¿¡æ¯å’Œ Backup çš„å…ƒä¿¡æ¯ã€è§„æ ¼ã€çŠ¶æ€ç­‰æ±‡æ€»ä½œä¸ºæè¿°ä¿¡æ¯æ ¼å¼åŒ–è¾“å‡º<br><em>åœ¨å¼€å¯ â€“details æ—¶ï¼Œä¼šæ„å»º DownloadRequest å¯¹è±¡è·å–  BackupResourceList çš„ä¿¡æ¯</em></li></ol><h2 id="download"><a href="#download" class="headerlink" title="download"></a>download</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;download.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º DownloadRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± DownloadRequest Controller è´Ÿè´£ç»´æŠ¤ï¼Œè·å– BackupContents çš„ä¿¡æ¯ </li><li>é˜»å¡ç›´è‡³ DownloadRequest çš„ DownloadURL è¢«è®¾ç½®ï¼Œå°†å†…å®¹å†™å…¥ â€“output æŒ‡å®šçš„ä½ç½®</li></ol><h2 id="get"><a href="#get" class="headerlink" title="get"></a>get</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;get.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å–åˆ° Backup èµ„æºï¼Œæ ¹æ® â€“output æŒ‡å®šçš„æ ·å¼æ ¼å¼åŒ–è¾“å‡º</li></ol><h2 id="logs"><a href="#logs" class="headerlink" title="logs"></a>logs</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;logs.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li><li>Backup çš„çŠ¶æ€å¿…é¡»ä¸º Completedã€PartiallyFailed æˆ–è€… Failed</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º DownloadRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± DownloadRequest Controller è´Ÿè´£ç»´æŠ¤ï¼Œè·å– BackupLog çš„ä¿¡æ¯ </li><li>é˜»å¡ç›´è‡³ DownloadRequest çš„ DownloadURL è¢«è®¾ç½®ï¼Œå°†å†…å®¹å†™å…¥ stdout ä¸­</li></ol><h1 id="PodVolumeBackup"><a href="#PodVolumeBackup" class="headerlink" title="PodVolumeBackup"></a>PodVolumeBackup</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/pod_volume_backup.go">API</a></p><p>å¯¹è±¡ä¸æ”¯æŒæ‰‹åŠ¨åˆ›å»ºï¼Œè€Œæ˜¯åœ¨å¤‡ä»½æµç¨‹ä¸­ï¼Œç”± Backup Controller è°ƒç”¨ <strong>backupPodVolumes</strong>ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ª Pod å·ï¼Œåˆ›å»ºä¸€ä¸ªè¯¥å¯¹è±¡ã€‚</p><h1 id="Schedule"><a href="#Schedule" class="headerlink" title="Schedule"></a>Schedule</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/schedule.go">API</a></p><h2 id="schedule"><a href="#schedule" class="headerlink" title="schedule"></a>schedule</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;schedule.go</u></em></p><p>velero schedule åŒ…æ‹¬ 4 ä¸ªå­å‘½ä»¤ï¼šcreateã€deleteã€describe å’Œ getã€‚</p><h2 id="create-1"><a href="#create-1" class="headerlink" title="create"></a>create</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;create.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>â€“schedule ä¸ºå¿…éœ€å‚æ•°</li><li>åœ¨æŒ‡å®š â€“storage-location å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li><li>åœ¨æŒ‡å®š â€“volume-snapshot-locations å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><em>åˆ›å»ºå®šæ—¶å¤‡ä»½ä»»åŠ¡æ—¶å¹¶ä¸ä¼šæ ¡éªŒ schedule è¡¨è¾¾å¼çš„åˆæ³•æ€§ï¼Œè€Œæ˜¯äº¤ç»™ Schedule Controller ä½œåç»­å¤„ç†ã€‚</em></p><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º Schedule å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± Scheduler Controller è´Ÿè´£ç»´æŠ¤</li></ol><h2 id="delete-1"><a href="#delete-1" class="headerlink" title="delete"></a>delete</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;delete.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>nameã€â€“all å’Œ â€“selector å‚æ•°æœ‰ä¸”ä»…èƒ½æœ‰ä¸€ä¸ª</li><li>è¦åˆ é™¤çš„ Schedule åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œè·å–é›†ç¾¤ä¸­çš„ Schedule èµ„æºå¹¶åˆ é™¤</li></ol><h2 id="describe-1"><a href="#describe-1" class="headerlink" title="describe"></a>describe</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;describe.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Schedule åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å–åˆ° Schedule èµ„æºï¼Œæ ¼å¼åŒ–è¾“å‡º</li></ol><h2 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;get.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>è¦è·å–çš„ Schedule åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å–åˆ° Schedule èµ„æºï¼Œæ ¹æ® â€“output æŒ‡å®šçš„æ ·å¼æ ¼å¼åŒ–è¾“å‡º</li></ol><h1 id="Backup-Controller"><a href="#Backup-Controller" class="headerlink" title="Backup Controller"></a>Backup Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;backup_controller.go</u></em><br><em><u>pkg&#x2F;backup&#x2F;backup.go</u></em></p><h2 id="NewBackupController"><a href="#NewBackupController" class="headerlink" title="NewBackupController"></a>NewBackupController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L89">NewBackupController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li><li>ç›‘å¬ Backup èµ„æºçš„ Add äº‹ä»¶ï¼Œå°†çŠ¶æ€æ˜¯ç©ºæˆ–è€… New çš„ Backup ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li></ol><h2 id="processBackup"><a href="#processBackup" class="headerlink" title="processBackup"></a>processBackup</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L207">processBackup æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p><ol><li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ Backup keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ Backup å¯¹è±¡</li><li>ä»…å¤„ç†çŠ¶æ€æ˜¯ç©ºæˆ–è€… New çš„ Backup å¯¹è±¡</li><li>è°ƒç”¨ <strong>prepareBackupRequest</strong> åšä¸€äº›æ ¡éªŒå‡†å¤‡å·¥ä½œï¼Œå¹¶æ ¹æ®æ ¡éªŒçš„ç»“æœè®¾ç½® Backup çš„çŠ¶æ€ä¸º FailedValidation æˆ–è€… InProgress</li><li>è¿‡æ»¤æ‰æ ¡éªŒå¤±è´¥çš„ Backupï¼Œè°ƒç”¨ <strong>runBackup</strong>ï¼Œæ‰§è¡Œå¤‡ä»½å’Œä¸Šä¼ å¤‡ä»½ä¿¡æ¯çš„æµç¨‹ï¼Œæ‰§è¡Œç»“æœå†³å®šäº†å¤‡ä»½æ˜¯å¦é¡ºåˆ©å®Œæˆï¼Œå¦‚æœæœ‰é”™è¯¯è¿”å›ï¼Œåˆ™è®°å½• Backup çŠ¶æ€ä¸º Failed</li></ol><h2 id="prepareBackupRequest"><a href="#prepareBackupRequest" class="headerlink" title="prepareBackupRequest"></a>prepareBackupRequest</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L328">prepareBackupRequest æºç </a></p><p>åœ¨ä¸ç ´åé›†ç¾¤ä¸­åŸ Backup å¯¹è±¡ï¼ˆä»¥ä¸‹ç§°ä¸º originalï¼‰çš„æƒ…å†µä¸‹ï¼Œæ„å»ºäº†ä¸€ä¸ª BackupRequest å¯¹è±¡ï¼ˆä»¥ä¸‹ç§°ä¸º requestï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«äº† original çš„è¯¦ç»†è§„æ ¼ï¼ˆå³ original çš„æ·±æ‹·è´ï¼‰ï¼Œå¹¶ä¸”åŒ…å«ä¸€äº›ä¸°å¯Œå¤„ç†æµç¨‹çš„ä¸­é—´æ€ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨æ•´ä¸ªå¤‡ä»½æµç¨‹ä¸­çš„æ“ä½œéƒ½æ˜¯åŸºäº requestï¼Œåœ¨å¤‡ä»½å®Œæˆåï¼Œä¼šå°† request ä¿¡æ¯åŒæ­¥æ›´æ–°è‡³é›†ç¾¤ä¸­çš„ Backup å¯¹è±¡ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request is a request for a backup, with all references to other objects</span></span><br><span class="line"><span class="comment">// materialized (e.g. backup/snapshot locations, includes/excludes, etc.)</span></span><br><span class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</span><br><span class="line">*velerov1api.Backup</span><br><span class="line"></span><br><span class="line">StorageLocation           *velerov1api.BackupStorageLocation</span><br><span class="line">SnapshotLocations         []*velerov1api.VolumeSnapshotLocation</span><br><span class="line">NamespaceIncludesExcludes *collections.IncludesExcludes</span><br><span class="line">ResourceIncludesExcludes  *collections.IncludesExcludes</span><br><span class="line">ResourceHooks             []hook.ResourceHook</span><br><span class="line">ResolvedActions           []resolvedAction</span><br><span class="line"></span><br><span class="line">VolumeSnapshots  []*volume.Snapshot</span><br><span class="line">PodVolumeBackups []*velerov1api.PodVolumeBackup</span><br><span class="line">BackedUpItems    <span class="keyword">map</span>[itemKey]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹ request èµ‹å€¼å’Œæ ¡éªŒçš„æ“ä½œ</p><ol><li>å°† original æ·±æ‹·è´è‡³ request ä¸­çš„ Backup ä¸­ï¼Œå¹¶è®¾ç½® request  ç‰ˆæœ¬ã€è¿‡æœŸæ—¶é—´ã€æ˜¯å¦å°†å·æ•°æ®å¤‡ä»½è‡³ Resticã€StorageLocation ç­‰ä¿¡æ¯</li><li>æ ¡éªŒ BackupStorageLocation çš„åˆæ³•æ€§ï¼Œä»¥åŠ access mode æ˜¯å¦ä¸ºé¢„æœŸçš„ ReadWrite</li><li>æ£€éªŒ volume snapshot location çš„åˆæ³•æ€§<br><em>backup.Spec.VolumeSnapshotLocation ä¸º []string ç±»å‹ï¼Œæ”¯æŒå¤šä¸ª locationï¼Œä½†æ˜¯è¦æ±‚ location å’Œ VolumeSnapshotter å¿…é¡»æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¸å…è®¸å¤šä¸ª location å¯¹åº”åŒä¸€ä¸ª VolumeSnapshotterï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œâ€“snapshotvolume ä¸º trueï¼Œæ‰€ä»¥åªè¦å­˜åœ¨ä¸€ä¸ªåˆæ³•çš„ default vslï¼Œåˆ™æœ€ç»ˆçš„ backup.Spec.VolumeSnapshotLocation å‡ä¼šåŒ…å«è¿™ä¸ª default vslï¼Œè¯¦ç»†é€»è¾‘å‚è€ƒ <a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller_test.go#L861">TestValidateAndGetSnapshotLocations</a></em></li><li>è®¾ç½® request çš„æ³¨è§£å’Œ resources &amp; namespaces çš„ included &amp; excluded æ£€éªŒä¿¡æ¯</li></ol><h2 id="runBackup"><a href="#runBackup" class="headerlink" title="runBackup"></a>runBackup</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L533">runBackup æºç </a></p><p>å¤‡ä»½çš„æ•´ä½“æµç¨‹</p><ol><li><p>åŸºäºä¸´æ—¶æ–‡ä»¶å¥æŸ„ç”Ÿæˆ gzip writer ï¼Œå¹¶æŒ‡å®š stdout å’Œ gzip writer ä¸º logger è¾“å‡ºï¼Œåˆå§‹åŒ–ç”¨äºç»Ÿè®¡æ—¥å¿—çº§åˆ«æ•°é‡çš„ counter<br><em>å› æ­¤ï¼Œæ—¥å¿—ä¸ä»…ä¼šè¾“å‡ºåœ¨ Velero Pod ä¸­ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆ BackupLogï¼Œåç»­ä¼šä¸Šä¼ è‡³ BackupStorageLocation ä¸­</em></p></li><li><p>ç”Ÿæˆä¸€ä¸ªç”¨äºå­˜æ”¾ Backup ç‰ˆæœ¬å’Œå†…å®¹çš„ä¸´æ—¶æ–‡ä»¶<br><em>åç»­åœ¨è°ƒç”¨ <strong>Backup</strong> æ—¶ä¼šä¼ å…¥è¯¥ä¸´æ—¶æ–‡ä»¶</em></p></li><li><p>è·å–æ³¨å†Œçš„ BackupItemAction æ’ä»¶<br><em>åç»­åœ¨è°ƒç”¨ <strong>Backup</strong> æ—¶ä¼šä¼ å…¥è¯¥ action ä¿¡æ¯</em></p></li><li><p>é€šè¿‡ StorageProvider çš„ BackupExists æ¥å£åˆ¤æ–­è¿œç«¯å­˜å‚¨ä¸­æ˜¯å¦æœ‰åŒåå¤‡ä»½</p><ul><li>å¦‚æœå­˜åœ¨ï¼Œåˆ™è®¾ç½® Backup çŠ¶æ€ä¸º Failedï¼Œæœ¬æ¬¡å¤‡ä»½å¤±è´¥</li><li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ <strong>Backup</strong> è¿›è¡Œå‡†å¤‡ä¸å¤‡ä»½</li></ul></li><li><p>å¦‚æœ Velero å¼€å¯äº† CSI ç‰¹æ€§ï¼Œåˆ™è·å–é›†ç¾¤ä¸­ä¸è¯¥ Backup ç›¸å…³çš„ VolumeSnapshots å’Œ VolumeSnapshotContents ä¿¡æ¯<br><em>åç»­ä¼šä¸Šä¼ è‡³ BackupStorageLocation ä¸­</em></p></li><li><p>è®¾ç½® request çš„å·å¿«ç…§æ€»é‡ä¸æˆåŠŸé‡ã€å®Œæˆæ—¶é—´æˆ³ã€Warnings å’Œ Errors çš„ä¸ªæ•°ä»¥åŠå¤‡ä»½çš„çŠ¶æ€ç­‰ç­‰ï¼Œå…³é—­æ—¥å¿—æ–‡ä»¶ï¼Œæœ¬æ¬¡å¤‡ä»½ä»»åŠ¡æ—¥å¿—è®°å½•å®Œæ¯•<br><em>å¤‡ä»½çš„çŠ¶æ€ï¼ˆFailedã€PartiallyFailed æˆ–è€… Completedï¼‰æ˜¯æ ¹æ®æ—¥å¿—è¾“å‡ºçº§åˆ«çš„ç»Ÿè®¡å†³å®šçš„ï¼ŒfatalErrs è®°å½•äº†è°ƒç”¨ backupper.Backup äº§ç”Ÿçš„é”™è¯¯æ—¥å¿—ä¿¡æ¯ï¼Œä¸ä»…å¦‚æ­¤ï¼Œåœ¨åç»­ä¸Šä¼ å¤‡ä»½æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¼šè®°å½•ï¼Œæ‰€ä»¥ request çš„çŠ¶æ€æ˜¯å¦ä¸º Failed æ˜¯ fatalErrs å†³å®šçš„ï¼Œè€ŒçŠ¶æ€æ˜¯å¦ä¸º Completed å’Œ PartiallyFailed æ˜¯æ ¹æ®æ—¥å¿—ä¸­ Error çº§åˆ«çš„è¾“å‡ºæ•°é‡å†³å®šçš„ï¼Œ<strong>è¯¥æ—¥å¿—ä¹ŸåŒ…æ‹¬è°ƒç”¨ StorageProvider ä¸­äº§ç”Ÿçš„æ—¥å¿—çº§åˆ«ä¿¡æ¯</strong></em></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">backup.Status.Warnings = logCounter.GetCount(logrus.WarnLevel)</span><br><span class="line">backup.Status.Errors = logCounter.GetCount(logrus.ErrorLevel)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assign finalize phase as close to end as possible so that any errors</span></span><br><span class="line"><span class="comment">// logged to backupLog are captured. This is done before uploading the</span></span><br><span class="line"><span class="comment">// artifacts to object storage so that the JSON representation of the</span></span><br><span class="line"><span class="comment">// backup in object storage has the terminal phase set.</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="built_in">len</span>(fatalErrs) &gt; <span class="number">0</span>:</span><br><span class="line">backup.Status.Phase = velerov1api.BackupPhaseFailed</span><br><span class="line"><span class="keyword">case</span> logCounter.GetCount(logrus.ErrorLevel) &gt; <span class="number">0</span>:</span><br><span class="line">backup.Status.Phase = velerov1api.BackupPhasePartiallyFailed</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">backup.Status.Phase = velerov1api.BackupPhaseCompleted</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é‡æ–°è·å– StorageProviderï¼Œé¿å…é•¿æ—¶é—´å¤‡ä»½ä¸­è®¤è¯ä¿¡æ¯å˜åŠ¨ï¼Œ è°ƒç”¨ StorageProvider çš„ PutBackup æ¥å£å°†å¤‡ä»½ä¿¡æ¯ä¸Šä¼ è‡³ BackupStorageLocation ä¸­ï¼Œå…·ä½“æ–‡ä»¶çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><table><thead><tr><th>åç§°</th><th>BackupStorageLocation ä¸­çš„æ–‡ä»¶</th><th>æ•°æ®æº</th></tr></thead><tbody><tr><td>Metadata</td><td>velero-backup.json</td><td>backup.Backup å¯¹è±¡</td></tr><tr><td>Content</td><td>&lt;backup&gt;.tar.gz</td><td>æ­¥éª¤ 2 ä¸­çš„ä¸´æ—¶æ–‡ä»¶å†…å®¹</td></tr><tr><td>Log</td><td>&lt;backup&gt;-logs.gz</td><td>æ­¥éª¤ 6 ä¸­æœ€ç»ˆç”Ÿæˆçš„ log æ–‡ä»¶</td></tr><tr><td>PodVolumeBackups</td><td>&lt;backup&gt;-podvolumebackups.json</td><td>backup.PodVolumeBackups</td></tr><tr><td>VolumeSnapshots</td><td>&lt;backup&gt;-volumesnapshots.json.gz</td><td>backup.VolumeSnapshots</td></tr><tr><td>BackupResourceList</td><td>&lt;backup&gt;-resource-list.json.gz</td><td>backup.BackedUpItems</td></tr><tr><td>CSIVolumeSnapshots</td><td>&lt;backup&gt;-csi-volumesnapshots.json.gz</td><td>æ­¥éª¤ 5 ä¸­ volume snapshots</td></tr><tr><td>CSIVolumeSnapshotContents</td><td>&lt;backup&gt;-csi-volumesnapshotcontents.json.gz</td><td>æ­¥éª¤ 5 ä¸­ volume snapshot contents</td></tr></tbody></table><p>è¿™é‡Œéœ€è¦åŒºåˆ† PodVolumeBackups å’Œ VolumeSnapshots</p><ul><li>PodVolumeBackups æ˜¯æè¿°äº†å¤‡ä»½çš„ Pod ä¸­çš„å·æ•°æ®ä¿¡æ¯ï¼Œä¸ä¹‹å…³è”çš„æ˜¯ Restic ç›¸å…³æ¦‚å¿µï¼Œæ•°æ®æœ€ç»ˆä¼šå†™å…¥ ResticRepository ä¸­</li><li>VolumeSnapshots æ˜¯ç›¸æ¯”äº CSI è€Œè¨€å±äº Velero åŸç”Ÿçš„å·å¿«ç…§ï¼Œç”¨äºæè¿°ä¸€ä¸ª PV å¿«ç…§çš„ä¿¡æ¯ï¼Œæœ¬èº«ä½œä¸º Backup çš„ä¸€éƒ¨åˆ†ï¼Œæ•°æ®æœ€ç»ˆä¼šç”±å¯¹åº”çš„ SnapshotProvider å¤„ç†</li><li>å³ä½¿ä¸¤è€…æœ€ç»ˆçš„æ•°æ®å‡ä¸ä¼šå­˜æ”¾åœ¨ BackupStorageLocation ä¸­ï¼Œä½†æ˜¯ä»ç„¶ä¼šåœ¨ BackupStorageLocation ä¸­è®°å½•å…¶åŸºç¡€ä¿¡æ¯</li></ul></li></ol><h2 id="Backup-1"><a href="#Backup-1" class="headerlink" title="Backup"></a>Backup</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/backup/backup.go#L205">Backup æºç </a></p><p>å¤‡ä»½åŠ¨ä½œæœ¬èº«çš„æµç¨‹</p><ol><li>åŸºäºä¼ å…¥çš„ä¸´æ—¶æ–‡ä»¶ï¼Œç”Ÿæˆ gzip writerï¼Œæœ€ç»ˆä¼šä»¥ <em>backup</em>.tar.gz æ ¼å¼å­˜æ”¾åœ¨ BackupStorageLocation ä¸­ä½œä¸º Contentï¼Œè¯¥ tar.gz åŒ…æ‹¬ä¸¤ä¸ªä¸»è¦å†…å®¹ï¼šmetadata å’Œ resourcesï¼Œå‰è€…ç”¨äºå­˜æ”¾ç‰ˆæœ¬ï¼Œåè€…ç”¨äºå­˜æ”¾è¢«å¤‡ä»½èµ„æºçš„è¯¦ç»†è§„æ ¼ä¿¡æ¯<br><em>åŒºåˆ«äºè®°å½• Backup æœ¬èº«çš„ Metadataï¼Œæ­¤å¤„çš„ metdata ä»…ä¸ºä¸€ä¸ªç›®å½•å±‚çº§ï¼›åœ¨åç»­ <strong>backupItem</strong> æµç¨‹ä¸­ï¼Œä¼šå°†èµ„æºä¿¡æ¯å†™å…¥ resources æ–‡ä»¶ä¸­</em></li><li>åœ¨ metadata ç›®å½•ä¸‹å†™å…¥ç‰ˆæœ¬ä¿¡æ¯ versionï¼Œå›ºå®šå€¼ä¸º 1.1.0</li><li>è®¾ç½® request çš„ resource &amp; namespace çš„ included &amp; excludedã€resources hook ä»¥åŠ resolve actionï¼ˆBackupItemActionï¼‰<ul><li>namespace å’Œ resource çš„å¤„ç†æ–¹å¼å¹¶ä¸ä¸€æ ·ï¼Œæ˜¯å› ä¸º namespace åªè¦åšåŒ¹é…å³å¯ï¼Œå­˜åœ¨ä¸ä¸å­˜åœ¨å¾ˆå®¹æ˜“å®šæ€§ï¼Œä½†æ˜¯ resource æœ‰å¾ˆå¤šç§è¡¨ç¤ºæ–¹å¼ï¼Œä¾‹å¦‚ pv å’Œ persistentvolumesï¼Œå¯¹äºå¤æ‚çš„èµ„æºæ¥è®²ï¼Œè¿˜æœ‰ ApiGroup çš„æ¦‚å¿µï¼Œå› æ­¤ï¼Œéœ€è¦ RESTmapping çš„ ResourceFor åŒ¹é…å‡ºæœ€åˆé€‚ä¸”è§„èŒƒçš„ä¸€ä¸ª GVRï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨æ—¶å¯ä»¥åœ¨åˆç†èŒƒå›´ä»»æ„æŒ‡å®šèµ„æºåç§°å‡ä¼šåŒ¹é…æ­£ç¡®çš„åŸå› </li><li>BackupItemAction æœ‰ä¸¤ä¸ªæ¥å£ï¼Œä¸€ä¸ªæ˜¯ AppliesToï¼Œä¸€ä¸ªæ˜¯ Executeï¼Œå‰è€…ç”¨äºè¿”å› labelSelectorï¼Œç”¨äºå¤‡ä»½é˜¶æ®µçš„è¿‡æ»¤ç­›é€‰ï¼Œåè€…ç”¨äºæ‰§è¡Œ BackupItemAction ä¸­å®šä¹‰çš„é¢å¤–åŠ¨ä½œ</li></ul></li><li>ç”Ÿæˆä¸´æ—¶ç©ºæ–‡ä»¶ï¼Œä¾›åç»­ itemCollector ä½¿ç”¨ï¼ŒitemCollector æ ¹æ® Backup è§„æ ¼ä¿¡æ¯é€šè¿‡ K8s API æ”¶é›†å¾…å¤‡ä»½çš„èµ„æºè¯¦ç»†ä¿¡æ¯å¹¶å†™å…¥ç©ºæ–‡ä»¶ä¸­<br><em>è¯¥ç©ºæ–‡ä»¶ç”¨äº <strong>getAllItems</strong> æ—¶ï¼Œä½œä¸ºæ¯ä¸€ä¸ª item çš„è§£æ„æ–‡ä»¶çš„æ ¹ç›®å½•</em></li><li><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/backup/item_collector.go#L57">getAllItems</a> é€šè¿‡ discovery è·å–åˆ°æ‰€æœ‰çš„ API groupï¼ˆä¾‹å¦‚ batch&#x2F;v1beta1ï¼Œnetworking.k8s.io&#x2F;v1beta1 ç­‰ç­‰ï¼‰ï¼Œç„¶åæ ¹æ®æ¯ä¸ª group è·å–åˆ° resourceï¼ˆä¾‹å¦‚ cronjobsï¼Œnetworkpolicies ç­‰ç­‰ï¼‰ï¼Œæ ¹æ® namespace å’Œ resource çš„ include å’Œ exclude ä»¥åŠæ ‡ç­¾é€‰æ‹©å™¨è§„åˆ™è¿›è¡Œè¿‡æ»¤èµ„æºï¼Œè¿‡æ»¤åçš„ç»“æœå°±æ˜¯å¾…å¤‡ä»½çš„å¯¹è±¡ï¼ˆitemï¼‰<br><em>item çš„å†…å®¹ï¼ˆunstructured.Unstructured å¯¹è±¡ï¼‰å·²ç»å†™å…¥äº†æ­¥éª¤ 4 çš„ä¸´æ—¶ç›®å½•é‡Œï¼ŒåŒæ—¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„è·¯å¾„ä¼šè®°å½•åœ¨ item çš„ path ä¸­ï¼Œåç»­åœ¨ <strong>backupItem</strong> æ—¶ï¼Œä¼šè§£æä½œä¸ºè§£æ„çŠ¶æ€çš„ item ä¼ å…¥</em></li><li>æ›´æ–° Backup çš„å¾…å¤‡ä»½èµ„æºçš„æ€»é‡ä¿¡æ¯</li><li>ç”Ÿæˆ update é˜Ÿåˆ—ï¼Œç”¨äºè®°å½• Backup çŠ¶æ€ä¿¡æ¯ï¼ŒåŒæ—¶å¯åŠ¨ä¸€ä¸ª Goroutine ç›‘å¬é˜Ÿåˆ—ï¼Œæ¯ç§’é’Ÿè·å–ä¸€æ¬¡ update é˜Ÿåˆ—ä¸­çš„è¿›åº¦å¹¶æ›´æ–°è‡³ Backup ä¸­</li><li>éå†æ¯ä¸€ä¸ªå¾…å¤‡ä»½çš„ itemï¼Œè°ƒç”¨ <strong>backupItem</strong> å‡½æ•°ï¼Œè¿›è¡Œå¤‡ä»½ï¼Œå¹¶å°†è¿›åº¦ä¿¡æ¯å†™å…¥ update é˜Ÿåˆ—ä¸­ï¼Œå®Œæˆè¿›åº¦ä¸ŠæŠ¥</li><li>å¦‚æœå¤‡ä»½è§„æ ¼ä¸­æŒ‡å®šäº†å¤‡ä»½é›†ç¾¤çº§åˆ«èµ„æºï¼ˆIncludeClusterResourcesï¼‰ï¼Œåˆ™é¢å¤–å¤‡ä»½ CRD èµ„æº<br><em>è¿™é‡Œçš„ CRD èµ„æºå…¶å®æ˜¯æœ‰é™åˆ¶æ¡ä»¶çš„ï¼Œå°±æ˜¯ä»…å¤„ç†å·²ç»å¤‡ä»½äº†ä¸ CRD ç›¸å…³çš„ CR èµ„æºæ—¶ï¼Œæ‰ä¼šå¤‡ä»½å¯¹åº”çš„ CRD</em></li><li>æ›´æ–°é›†ç¾¤ä¸­ Backup å¯¹è±¡çš„å¤‡ä»½è¿›åº¦ä¿¡æ¯è‡³ 100%</li></ol><h2 id="backupItem"><a href="#backupItem" class="headerlink" title="backupItem"></a>backupItem</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/backup/backup.go#L424">backupItem æºç </a></p><p>å•ä¸ª item èµ„æºçš„å¤‡ä»½æµç¨‹</p><ol><li>ä¼ å…¥çš„ item æ˜¯è§£æ„çŠ¶æ€çš„èµ„æºä¿¡æ¯ï¼ˆruntime.Unstructuredï¼‰ï¼Œè§£æ„æ•°æ®æ¥æºäº item çš„ path å­—æ®µï¼Œéœ€è¦é‡æ–°æ„å»ºæˆ metav1.Objectï¼Œæå–ä¿¡æ¯</li><li>å¯¹äºä»¥ä¸‹æƒ…å†µè·³è¿‡å¤‡ä»½ï¼Œå¹¶ä¸”è¿”å› false æ ‡è¯†ï¼Œè¡¨ç¤ºèµ„æºæœªå‚ä¸å¤‡ä»½<br><em>æœªå‚ä¸å¤‡ä»½çš„èµ„æºï¼Œå³ä½¿åœ¨æŒ‡å®šäº†å¤‡ä»½é›†ç¾¤çº§åˆ«èµ„æºæ—¶ä¹Ÿä¸ä¼šå¤‡ä»½ç›¸å…³çš„ CRD</em><ul><li>æ ‡ç­¾ä¸­æœ‰ velero.io&#x2F;exclude-from-backup å­—æ®µçš„èµ„æº</li><li>èµ„æºå±äº Backup è§„æ ¼ä¸­æŒ‡å®šçš„ namespace å’Œ groupResource çš„</li><li>é namespace çš„èµ„æºå³æ˜¯é›†ç¾¤çº§åˆ«çš„ï¼Œä½†æ˜¯å¤‡ä»½è§„æ ¼ä¸­çš„ IncludeClusterResources ä¸º false</li><li>èµ„æºå¤„äºåˆ é™¤çŠ¶æ€</li></ul></li><li>å¯¹äºå·²ç»å¤‡ä»½çš„èµ„æºï¼Œè‡ªç„¶ä¹Ÿä¼šè·³è¿‡å¤‡ä»½ï¼Œä½†æ˜¯è¿”å› true æ ‡è¯†ï¼Œè¡¨ç¤ºèµ„æºå·²ç»å¤‡ä»½</li><li>æ‰§è¡Œ pre hook åŠ¨ä½œï¼ˆåªæœ‰ç±»å‹æ˜¯ Pod çš„ èµ„æºæ‰ä¼šçœŸæ­£çš„å¤„ç† pre hookï¼‰ï¼Œhook ä½œç”¨çš„å¯¹è±¡éœ€è¦æ»¡è¶³ BackupItemAction ä¸­å®šä¹‰çš„ applyTo æ¥å£çš„æ ‡ç­¾é€‰æ‹©ï¼Œhook command çš„æ‰§è¡Œï¼ˆå³ execute æ¥å£ï¼‰æ˜¯é€šè¿‡ K8s rest API exec å®ç°</li><li>é’ˆå¯¹ç±»å‹æ˜¯ Pod çš„èµ„æºï¼Œåœ¨ spec.Volumes ä¸­è·å–éœ€è¦å€ŸåŠ© Restic å¤‡ä»½çš„å·<br><em>ç”±äº PV å’Œ PVC æ˜¯ 1 å¯¹ 1ï¼ŒPVC å’Œ Pod æ˜¯ 1 å¯¹ n çš„å…³ç³»ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œé€šè¿‡è·Ÿè¸ª PVC çš„å¤‡ä»½æƒ…å†µå³å¯åˆ¤æ–­å·æ˜¯å¦è¢«å¤‡ä»½è¿‡ï¼Œå¤‡ä»½è¿‡çš„å·ï¼Œä¼šåœ¨ç›¸å…³çš„ tracker ä¸­ä»¥ PVC ä¸º key ä½œè®°å½•</em></li><li>è°ƒç”¨ BackupItemAction çš„ execute æ¥å£ï¼Œè¿›è¡Œé¢å¤–çš„æ“ä½œï¼Œå¦‚æ›´æ–°èµ„æºç­‰ï¼Œæ­¤åçš„æµç¨‹åŸºäºæ¥å£è¿”å›çš„å¯¹è±¡ç»§ç»­æ“ä½œï¼Œæ‰§è¡Œå¤±è´¥æ—¶ï¼Œä¼šæ‰§è¡Œ post hook åŠ¨ä½œ</li><li>é’ˆå¯¹ç±»å‹æ˜¯ PV çš„èµ„æºï¼Œè°ƒç”¨ takePVSnapshotï¼Œå¿½ç•¥å·²ç»è¢« Restic å¤‡ä»½çš„ PVï¼Œåˆå§‹åŒ– SnapshotProviderï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„æ¥å£ï¼Œå®Œæˆå·å¿«ç…§çš„æ“ä½œï¼Œå¹¶å°†å¿«ç…§ä¿¡æ¯è®°å½•åœ¨ request çš„ VolumeSnapshots ä¸­<br><em>åœ¨ Velero å¼€å¯ CSI ç‰¹æ€§æ—¶ï¼Œéœ€è¦é¢å¤–åŠ è½½ä¸€ä¸ª pluginï¼ˆ<a href="https://github.com/vmware-tanzu/velero-plugin-for-csi%EF%BC%89%EF%BC%8C%E8%AF%A5">https://github.com/vmware-tanzu/velero-plugin-for-csiï¼‰ï¼Œè¯¥</a> plugin å°±æ˜¯ SnapshotProvider ç±»å‹ã€‚å› æ­¤åœ¨è¿™æ­¥æ—¶ï¼Œä¾¿ä¼šå¯¹ PV åšå¿«ç…§æ“ä½œ</em></li><li>é’ˆå¯¹ç±»å‹æ˜¯ Pod çš„èµ„æºï¼Œè°ƒç”¨ <strong>BackupPodVolumes</strong>ï¼Œå€ŸåŠ© Restic èƒ½åŠ›å®ç°å¯¹ Pod å·æ•°æ®çš„å¤‡ä»½</li><li>æ‰§è¡Œ post hook åŠ¨ä½œ</li><li>åœ¨ resources ç›®å½•ä¸‹å†™å…¥å¤‡ä»½çš„èµ„æºä¿¡æ¯ï¼Œèµ„æºä¼šæ ¹æ® kindã€ namepace ç­‰ä¿¡æ¯å½’ç±»ï¼Œæ–‡ä»¶å†…å®¹ä¸º item çš„ runtime.Unstructured å½¢å¼ï¼Œä»¥ json æ ¼å¼å­˜å‚¨<br><em>æ–‡ä»¶æ˜¯ä¸Šå±‚è°ƒç”¨ä¼ å…¥çš„ Content æ–‡ä»¶</em></li><li>è‡³æ­¤ï¼Œé’ˆå¯¹å•ä¸€çš„ item å¤‡ä»½æµç¨‹ç»“æŸï¼Œå…¶ä¸­åŒ…å«äº†å­˜å‚¨åœ¨ kube-apiserver ä¸­çš„ç»“æ„åŒ–å…ƒä¿¡æ¯å’Œå·æ•°æ®çš„å¤‡ä»½</li></ol><h2 id="BackupPodVolumes"><a href="#BackupPodVolumes" class="headerlink" title="BackupPodVolumes"></a>BackupPodVolumes</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restic/backupper.go#L99">backupPodVolumes æºç </a></p><p>å€ŸåŠ© Restic èƒ½åŠ›å¤‡ä»½å·æ•°æ®çš„æµç¨‹</p><ol><li>æ¯ä¸€ä¸ª Pod å·æ‰€å±çš„ namespace å¿…é¡»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹åº”çš„ ResticRepository å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªï¼Œç”± ResticRepository Controller ä¼šè´Ÿè´£ç»´æŠ¤çŠ¶æ€ï¼Œè€Œ Backup Controller  ä¼šé˜»å¡ç›´è‡³ ResticRepository è¶…æ—¶æˆ–è€… ready<br><em>åˆ›å»ºå¯¹è±¡æ—¶ä¼šæŒ‡å®šåŸºäºçš„ BackupStorageLocationï¼Œå¹¶å°† BackupStorageLocation è½¬æ¢æˆ RepoIdentifier ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ Restic åŸç”Ÿå‘½ä»¤ä¸­çš„ -r å‚æ•°</em></li><li>è¿‡æ»¤æ‰ hostPath ç±»å‹çš„å·ï¼Œå¯¹å…¶ä½™çš„åˆæ³•å·ä¼šåˆ›å»ºå¯¹åº”çš„ PodVolumeBackup å¯¹è±¡ï¼Œå…¶ä¸­ PodVolumeBackup ä¸­ä¼šè®¾ç½® velero.io&#x2F;backup-name æ ‡ç­¾ä»¥åŠ PVC çš„ UID ä¿¡æ¯<br><em>æ­¤æ—¶ï¼Œè¯¥å¯¹è±¡çš„ spec.RepoIdentifier å·²è¢«è®¾ç½®ï¼Œä¾‹å¦‚ s3:<a href="http://minio.velero.svc:9000/velero/restic/velero%E3%80%82%E6%AD%A4%E5%A4%96%EF%BC%8C%E7%94%B1%E4%BA%8E%E5%9C%A8">http://minio.velero.svc:9000/velero/restic/veleroã€‚æ­¤å¤–ï¼Œç”±äºåœ¨</a> velero 1.6.3 ä¸­ä¸ä¼šåˆ¤æ–­ Pod çš„çŠ¶æ€ï¼Œå› æ­¤ä¾æ—§ä¼šå¯¹ pending çŠ¶æ€çš„ Pod åˆ›å»º PodVolumeBackup å¯¹è±¡ï¼Œä½†æ˜¯æ­¤ PodVolumeBackup å¯¹è±¡æ²¡æœ‰ nodeName å±æ€§ï¼Œå¯¼è‡´ Restic ä¸ä½œå¤„ç†ï¼Œä»è€Œé˜»å¡ Velero ç›´è‡³è¶…æ—¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œrestic çŠ¶æ€å¼‚å¸¸ä¹Ÿä¼šå¯¼è‡´ç±»ä¼¼é—®é¢˜ï¼Œå‚è€ƒï¼š<a href="https://github.com/vmware-tanzu/velero/issues/4874">https://github.com/vmware-tanzu/velero/issues/4874</a></em></li><li>PodVolumeBackup Controller ä¼šè´Ÿè´£å·çš„å¤‡ä»½ï¼Œè€Œ Backup Controller ä¼šé˜»å¡ç›´è‡³å·å¤‡ä»½è¿”å›å®Œæˆæˆ–è€…å¤±è´¥</li></ol><h2 id="resync"><a href="#resync" class="headerlink" title="resync"></a>resync</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L166">resync æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 1 åˆ†é’Ÿ</p><ol><li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ Backup å¯¹è±¡ï¼Œæ›´æ–° backup_total æŒ‡æ ‡ï¼Œvalue ä¸ºé›†ç¾¤ä¸­æ‰€æœ‰ Backup æ€»æ•°</li><li>é’ˆå¯¹æ¯ä¸€ä¸ªçŠ¶æ€å·²ç»å®Œæˆä¸”å½’å±äºæŸä¸€ä¸ª Schedule çš„ Backupï¼Œè®¾ç½® backup_last_successful_timestamp æŒ‡æ ‡ï¼Œkey ä¸º Schedule åç§°ï¼Œvalue ä¸ºæœ€è¿‘çš„ä¸€æ¬¡å¤‡ä»½æ—¶é—´æˆ³</li></ol><h1 id="PodVolumeBackup-Controller"><a href="#PodVolumeBackup-Controller" class="headerlink" title="PodVolumeBackup Controller"></a>PodVolumeBackup Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;pod_volume_backup_controller.go</u></em><br><em><u>pkg&#x2F;restic&#x2F;exec_commands.go</u></em></p><h2 id="NewPodVolumeBackupController"><a href="#NewPodVolumeBackupController" class="headerlink" title="NewPodVolumeBackupController"></a>NewPodVolumeBackupController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_backup_controller.go#L72">NewPodVolumeBackupController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandlerï¼Œå¹¶å°† PodVolumeBackupã€Pod å’Œ PVC æ·»åŠ åˆ° cacheSyncWaitersï¼Œç­‰å¾…åŒæ­¥å®Œæˆ</li><li>ç›‘å¬ PodVolumeBackup èµ„æºçš„ Add å’Œ Update äº‹ä»¶ï¼Œå°†çŠ¶æ€æ˜¯ç©ºæˆ–è€… New å¹¶ä¸”ä½äºå½“å‰èŠ‚ç‚¹çš„ PodVolumeBackup èµ„æºä»¥ key ï¼ˆnamespace&#x2F;nameï¼‰ çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­<br><em>PodVolumeBackup Controller è¿è¡Œåœ¨ DaemonSet å½¢å¼çš„ Restic æœåŠ¡ä¸­ï¼ŒæŒ‚è½½æ‰€åœ¨èŠ‚ç‚¹çš„ Pod å·ï¼Œå› æ­¤ PodVolumeBackup å…·æœ‰èŠ‚ç‚¹å±æ€§ï¼ŒPodVolumeBackup Controller ä»…å¤„ç†å½“å‰èŠ‚ç‚¹çš„ PodVolumeBackup å¯¹è±¡</em></li></ol><h2 id="processQueueItem"><a href="#processQueueItem" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_backup_controller.go#L140">processQueueItem æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p><ol><li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ PodVolumeBackup keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ PodVolumeBackup å¯¹è±¡</li><li>ä»…å¤„ç†çŠ¶æ€ä¸ºç©ºæˆ–è€… New çš„ PodVolumeBackup å¯¹è±¡ï¼Œè°ƒç”¨ <strong>processBackup</strong>ï¼Œæ‰§è¡Œå·æ•°æ®çš„å¤‡ä»½</li></ol><h2 id="ProcessBackup"><a href="#ProcessBackup" class="headerlink" title="ProcessBackup"></a>ProcessBackup</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_backup_controller.go#L188">ProcessBackup æºç </a></p><p>å·æ•°æ®å¤‡ä»½çš„æ•´ä½“æµç¨‹</p><ol><li>æ›´æ–° PodVolumeBackup çŠ¶æ€ä¸º InProgress</li><li>æ ¡éªŒ PodVolumeBackup å¯¹è±¡è§„æ ¼ä¸­å£°æ˜çš„å·æº Pod æ˜¯å¦å­˜åœ¨ï¼Œè·å–åˆ° Pod å·åœ¨ host ä¸Šå­ç›®å½•ä¿¡æ¯<br><em>ä¾‹å¦‚  &#x2F;host_pods&#x2F;e4ccf918-76d7-4972-a54a-39b39f15b53b&#x2F;volumes&#x2F;kubernetes.io~empty-dir&#x2F;pluginsï¼Œ&#x2F;host_pods ä¸º Restic Pod ä¸­çš„ç›®å½•ï¼ŒæŒ‚è½½äº† host çš„ &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;ï¼Œ è¯¦ç»†é€»è¾‘å‚è€ƒ <a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/util/kube/utils_test.go#L159">TestGetVolumeDirectorySuccess</a></em></li><li>ç”Ÿæˆç”¨äºè¿æ¥ Restic Repo æ‰€éœ€è¦çš„ä¸´æ—¶å¯†ç æ–‡ä»¶ï¼Œæ–‡ä»¶å›ºå®šä¸º &#x2F;tmp&#x2F;credentials&#x2F;velero&#x2F;velero-restic-credentials-repository-passwordï¼Œå†…å®¹ä¸º static-passw0rdï¼Œç”¨äº restic åŸç”Ÿå‘½ä»¤ä¸­çš„ â€“password å‚æ•°<br><em>å¯†ç ä¼šä»¥ Secret çš„å½¢å¼å­˜å‚¨åœ¨é›†ç¾¤ä¸­ï¼Œåä¸º velero-restic-credentialsï¼Œä½äº velero å‘½åç©ºé—´å†…</em></li><li>æ„å»º restic backup å‘½ä»¤</li><li>å¦‚æœ BackupStorageLocation æœ‰ caCert è¯ä¹¦ä¿¡æ¯ï¼Œä¼šå°†å…¶ä¸´æ—¶å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œä¾› Restic è®¤è¯ä½¿ç”¨ï¼Œå¹¶è®¾ç½®åœ¨ restic backup å‘½ä»¤ä¸­<br><em>å› ä¸ºæœ¬è´¨ä¸Šï¼ŒRestic çš„ repo å’Œ Velero çš„ BackupStorageLocation ä¸ºåŒä¸€ä¸ª</em></li><li>ç»™ restic backup å‘½ä»¤è®¾ç½® Restic åŸç”Ÿæ‰€éœ€çš„ç¯å¢ƒå˜é‡ä¿¡æ¯</li><li>åœ¨å¤‡ä»½æµç¨‹ä¸­ç”Ÿæˆ PodVolumeBackup å¯¹è±¡æ—¶ï¼Œå¦‚æœ Pod å·æºäº PVCï¼Œåˆ™ä¼šå¯¹ PodVolumeBackup åŠ ä¸€ä¸ª velero.io&#x2F;pvc-uid çš„ labelï¼Œå€¼ä¸º PVC çš„ uidã€‚å› æ­¤ï¼Œåœ¨è¿™é‡Œä¼šé€šè¿‡è¿™ä¸ª label åˆ¤æ–­å·æ˜¯å¦æºäº PVCï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šè·å–é›†ç¾¤ä¸­æ‰€æœ‰å¸¦æœ‰æ­¤ labelã€çŠ¶æ€å·²ç»å®Œæˆå¹¶ä¸” BackupStorageLocation ç›¸åŒçš„ PodVolumeBackup å¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨åˆ™è¡¨ç¤ºè¿™ä¸ªå·å·²ç»å¤‡ä»½è¿‡ï¼Œåç»­çš„å¤‡ä»½ä¼šåŸºäºæœ€è¿‘çš„ä¸€æ¬¡å¤‡ä»½ç‚¹è¿›è¡Œå¢é‡å¤‡ä»½ï¼Œåä¹‹åˆ™å…¨é‡å¤‡ä»½ï¼Œè¿™é‡Œçš„å¢é‡å¤‡ä»½å€ŸåŠ©äº† Restic åŸç”ŸåŠŸèƒ½ï¼ˆâ€“parentï¼‰<br><em>è¯¦ç»†é€»è¾‘å‚è€ƒ <a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_backup_controller.go#L338">getParentSnapshot</a></em></li><li>è°ƒç”¨ <strong>RunBackup</strong>ï¼Œæ‰§è¡Œ Restic åŸç”Ÿçš„å·æ•°æ®å¤‡ä»½æµç¨‹</li><li>æ›´æ–° PodVolumeBackup å¯¹è±¡çš„çŠ¶æ€ã€å®Œæˆæ—¶é—´ã€å¿«ç…§ ID å’Œå·æ•°æ®è·¯å¾„ç­‰ä¿¡æ¯</li></ol><h2 id="RunBackup"><a href="#RunBackup" class="headerlink" title="RunBackup"></a>RunBackup</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restic/exec_commands.go#L73">RunBackup æºç </a></p><p>è°ƒç”¨ Restic åŸç”Ÿå¤‡ä»½å‘½ä»¤ restic backup</p><ol><li>å°†å…¥å‚çš„ Command å¯¹è±¡æ„å»ºæˆå¯æ‰§è¡Œå‘½ä»¤å¹¶æ‰§è¡Œ</li><li>å¯åŠ¨ä¸€ä¸ª Goroutineï¼Œæ¯ 10 ç§’é’Ÿè§£æä¸€æ¬¡ restic backup å‘½ä»¤çš„æ ‡å‡†è¾“å‡ºï¼Œæ›´æ–° PodVolumeBackup çš„å¤‡ä»½è¿›åº¦ä¿¡æ¯ï¼ˆå¾…å¤‡ä»½æ€»æ–‡ä»¶å¤§å°å’Œå½“å‰å¤‡ä»½æ–‡ä»¶å¤§å°ï¼‰</li><li>é€šè¿‡è§£ææ ‡å‡†è¾“å‡ºåˆ¤æ–­å¦‚æœ Restic å¤‡ä»½æˆåŠŸï¼Œåˆ™æ›´æ–° PodVolumeBackup è¿›åº¦è‡³ 100%</li></ol><h1 id="Schedule-Controller"><a href="#Schedule-Controller" class="headerlink" title="Schedule Controller"></a>Schedule Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;schedule_controller.go</u></em></p><h2 id="NewScheduleController"><a href="#NewScheduleController" class="headerlink" title="NewScheduleController"></a>NewScheduleController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/schedule_controller.go#L60">NewScheduleController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li><li>ç›‘å¬ Schedule èµ„æºçš„ Add äº‹ä»¶ï¼Œå°†çŠ¶æ€æ˜¯ç©ºã€New æˆ–è€… Enabled çš„ Schedule ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li></ol><h2 id="processSchedule"><a href="#processSchedule" class="headerlink" title="processSchedule"></a>processSchedule</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/schedule_controller.go#L136">processSchedule æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p><ol><li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ Schedule keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ Schedule å¯¹è±¡</li><li>ä»…å¤„ç†çŠ¶æ€ä¸ºç©ºã€New æˆ–è€… Enabled çš„ Schedule å¯¹è±¡</li><li>æ£€éªŒ cron è¡¨è¾¾å¼çš„åˆæ³•æ€§ï¼Œæ ¹æ®æ ¡éªŒç»“æœæ›´æ–° Schedule çš„çŠ¶æ€ä¸º FailedValidation æˆ–è€… Enabled</li><li>åˆ¤æ–­æ˜¯å¦åˆ°è¾¾å®šæ—¶ä»»åŠ¡çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œå¦‚æœè¾¾åˆ°åˆ™ç«‹å³åˆ›å»ºä¸€ä¸ªå¤‡ä»½ã€‚å¦å¤–ï¼Œå¦‚æœå®šæ—¶ä»»åŠ¡ä»æœªæ‰§è¡Œï¼Œä¹Ÿä¼šç«‹å³åˆ›å»ºä¸€ä¸ªå¤‡ä»½ä»»åŠ¡</li></ol><h2 id="enqueueAllEnabledSchedules"><a href="#enqueueAllEnabledSchedules" class="headerlink" title="enqueueAllEnabledSchedules"></a>enqueueAllEnabledSchedules</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/schedule_controller.go#L115">enqueueAllEnabledSchedules æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 1 åˆ†é’Ÿ</p><ol><li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ Schedule å¯¹è±¡</li><li>å°†çŠ¶æ€æ˜¯ Enabled çš„ Schedule å¯¹è±¡åŠ å…¥åˆ° Generic Controller çš„ queue ä¸­</li></ol><h1 id="BackupDeletion-Controller"><a href="#BackupDeletion-Controller" class="headerlink" title="BackupDeletion Controller"></a>BackupDeletion Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;backup_deletion_controller.go</u></em><br><em><u>internal&#x2F;delete&#x2F;delete_item_action_handler.go</u></em></p><p>åˆ é™¤ Backup æ—¶ï¼Œä¸ Backup ç›¸å…³è”çš„å„ç§èµ„æºåŸºæœ¬ä¸Šéƒ½æ˜¯é€šè¿‡ velero.io&#x2F;backup-name æ ‡ç­¾è·å–åˆ°ã€‚å› æ­¤ï¼Œåœ¨å¤‡ä»½çš„æ—¶å€™ï¼Œåˆ›å»ºçš„ç›¸å…³èµ„æºä¹Ÿéƒ½ä¼šæ‰“ä¸Šè¯¥æ ‡ç­¾ã€‚</p><h2 id="NewBackupDeletionController"><a href="#NewBackupDeletionController" class="headerlink" title="NewBackupDeletionController"></a>NewBackupDeletionController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_deletion_controller.go#L86">NewBackupDeletionController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li><li>ç›‘å¬ DeleteBackupRequest èµ„æºçš„ Add äº‹ä»¶ï¼Œå°† DeleteBackupRequest ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li></ol><h2 id="processQueueItem-1"><a href="#processQueueItem-1" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_deletion_controller.go#L146">processQueueItem æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p><ol><li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ DeleteBackupRequest keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ DeleteBackupRequest å¯¹è±¡</li><li>ä»…å¤„ç†çŠ¶æ€ä¸ä¸º Processed çš„ DeleteBackupRequest å¯¹è±¡ï¼Œè°ƒç”¨ <strong>processRequest</strong>ï¼Œæ‰§è¡Œ Backup çš„åˆ é™¤</li></ol><h2 id="processRequest"><a href="#processRequest" class="headerlink" title="processRequest"></a>processRequest</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_deletion_controller.go#L176">processRequest æºç </a></p><p>å¤‡ä»½åˆ é™¤çš„æ•´ä½“æµç¨‹</p><ol><li>å¦‚æœ DeleteBackupRequest å¯¹è±¡æ‰€å±çš„ Backup ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™è®¤ä¸º DeleteBackupRequest å¤„ç†å®Œæˆï¼Œå³å°†å…¶çŠ¶æ€è®¾ä¸º Processedï¼Œå¹¶è®¾ç½®é”™è¯¯ä¿¡æ¯</li><li>åˆ é™¤é›†ç¾¤ä¸­é’ˆå¯¹è¯¥ Backup çš„å…¶ä½™ DeleteBackupRequest å¯¹è±¡ï¼Œä»…å¤„ç†å½“å‰çš„</li><li>å¦‚æœè¦åˆ é™¤çš„ Backup å¤„äº InProgress çŠ¶æ€æˆ–è€…ä¸å­˜åœ¨ï¼Œåˆ™å°† DeleteBackupRequest çŠ¶æ€è®¾ä¸º Processedï¼Œå¹¶è®¾ç½®é”™è¯¯ä¿¡æ¯</li><li>å¦‚æœ Backup æ‰€å±çš„ BackupStorageLocation ä¸å­˜åœ¨æˆ–è€…æ¨¡å¼ä¸º ReadOnly æ—¶ï¼Œåˆ™å°† DeleteBackupRequest çŠ¶æ€è®¾ä¸º Processedï¼Œå¹¶è®¾ç½®é”™è¯¯ä¿¡æ¯</li><li>è‡³æ­¤ï¼Œæ ¡éªŒå·¥ä½œå·²ç»å®Œæˆï¼Œå°† DeleteBackupRequest çŠ¶æ€è®¾ç½®ä¸º InProgressï¼Œå¹¶è®¾ç½® velero.io&#x2F;backup-name å’Œ velero.io&#x2F;backup-uid æ ‡ç­¾</li><li>è®¾ç½® Backup çš„çŠ¶æ€ä¸º Deleting</li><li>è·å–æ³¨å†Œçš„ DeleteItemAction æ’ä»¶ï¼Œå¦‚æœè·å–åˆ°äº†ï¼Œåˆ™ä¸‹è½½ BackupStorageLocation ä¸­çš„ Content æ–‡ä»¶ï¼Œæ„å»ºè¿è¡Œ DeleteItemAction æ‰€éœ€è¦ç¯å¢ƒå˜é‡ä¿¡æ¯ï¼Œè°ƒç”¨ <strong>InvokeDeleteActions</strong> å¤„ç† DeleteItemAction ä¸­å®šä¹‰çš„é€»è¾‘</li><li>è°ƒç”¨ StorageProvider çš„ GetBackupVolumeSnapshots æ–¹æ³•è·å– BackupVolumeSnapshotsKeyï¼ˆä¹Ÿå°±æ˜¯ backup-volumesnapshots.json.gzï¼‰ çš„å†…å®¹ï¼Œè°ƒç”¨ SnapshotProvider çš„ DeleteSnapshot æ¥å£åˆ é™¤ PV å¿«ç…§ä¿¡æ¯</li><li>è·å–åˆ°ä¸ Backup ç›¸å…³è”çš„ PodVolumeBackup ä¿¡æ¯ï¼Œè¿›è€Œè·å–åˆ° Restic çš„ snapshotsï¼Œæ‰§è¡Œ restic forget åˆ é™¤å¿«ç…§<br><em>åˆ›å»ºå¤‡ä»½çš„æ—¶å€™ï¼Œä¼šæ ¹æ® Pod å·åˆ›å»º PodVolumeBackup å¯¹è±¡ï¼Œå¹¶ä¼šè®¾ç½® velero.io&#x2F;backup-name æ ‡ç­¾</em></li><li>è°ƒç”¨ StorageProvider çš„ DeleteBackup æ¥å£åˆ é™¤ BackupStorageLocation ä¸­ Backup æ‰€åœ¨çš„ç›®å½•</li><li>å¦‚æœ Velero å¼€å¯äº† CSI ç‰¹æ€§ï¼Œé‚£ä¹ˆä¹Ÿä¼šåˆ é™¤ä¸ Backup ç›¸å…³è”çš„ VolumeSnapshot å’Œ VolumeSnapshotContent å¯¹è±¡<br><em>åˆ é™¤ä¹‹å‰ä¼šå°† VolumeSnapshotContent å›æ”¶ç­–ç•¥ç½®ä¸º Delete</em></li><li>è°ƒç”¨ StorageProvider çš„ DeleteRestore æ–¹æ³•ï¼Œåˆ é™¤ BackupStorageLocation ä¸ŠåŸºäºè¯¥ Backup åˆ›å»ºçš„ Restore æ–‡ä»¶ï¼Œåˆ é™¤åŸºäºè¯¥ Backup åˆ›å»ºçš„ Restore å¯¹è±¡</li><li>å¦‚æœä»¥ä¸Šæ­¥éª¤å‡æ— é”™è¯¯è¿”å›ï¼Œåˆ™åˆ é™¤é›†ç¾¤ä¸­ç›¸å…³çš„ Backup å¯¹è±¡</li><li>æ›´æ–° DeleteBackupRequest çŠ¶æ€è®¾ä¸º Processedï¼Œå¹¶è®¾ç½®é”™è¯¯ä¿¡æ¯</li><li>å¦‚æœä»¥ä¸Šæ­¥éª¤å‡æ— æŠ¥é”™è¿”å›ï¼Œåˆ™åˆ é™¤ä¸è¯¥ Backup ç›¸å…³çš„æ‰€æœ‰ DeleteBackupRequest å¯¹è±¡</li></ol><h2 id="InvokeDeleteActions"><a href="#InvokeDeleteActions" class="headerlink" title="InvokeDeleteActions"></a>InvokeDeleteActions</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/internal/delete/delete_item_action_handler.go#L48">InvokeDeleteActions æºç </a></p><p>æ‰§è¡Œ DeleteItemAction ä¸­çš„åŠ¨ä½œ</p><ol><li>å¦‚æœæœªå®šä¹‰ action ä¿¡æ¯ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œç»§ç»­å¤„ç†åˆ é™¤æµç¨‹</li><li>å°†ä¼ å…¥çš„ BackupStorageLocation ä¸­çš„ Content æ–‡ä»¶è§£å‹è‡³ä¸´æ—¶æ–‡ä»¶ä¸‹ï¼Œé€šè¿‡ discovery API å°†æ–‡ä»¶å†…å®¹è½¬æ¢æˆ GroupResource</li><li>éå† GroupResource ä¸­çš„æ‰€æœ‰èµ„æºï¼Œæ‰§è¡Œ DeleteItemAction ä¸­å£°æ˜çš„åŠ¨ä½œ</li></ol><h2 id="deleteExpiredRequests"><a href="#deleteExpiredRequests" class="headerlink" title="deleteExpiredRequests"></a>deleteExpiredRequests</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_deletion_controller.go#L595">deleteExpiredRequests æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 1 å°æ—¶</p><ol><li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ DeleteBackupRequest å¯¹è±¡ï¼Œå°†çŠ¶æ€å·²ç»å¤„äº Processedï¼Œå¹¶ä¸” age è¶…è¿‡ 24 å°æ—¶çš„ DeleteBackupRequest å¯¹è±¡åˆ é™¤<br><em>å› ä¸ºå¹¶éæ‰€æœ‰çš„ DeleteBackupRequest å¯¹è±¡åœ¨èµ°å®Œ syncHandler æµç¨‹åå‡ä¼šè¢«åˆ é™¤</em></li></ol><h1 id="BackupSync-Controller"><a href="#BackupSync-Controller" class="headerlink" title="BackupSync Controller"></a>BackupSync Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;backup_sync_controller.go</u></em></p><h2 id="NewBackupSyncController"><a href="#NewBackupSyncController" class="headerlink" title="NewBackupSyncController"></a>NewBackupSyncController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_sync_controller.go#L60">NewBackupSyncController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ resyncFunc</li></ol><h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_sync_controller.go#L124">run æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 30 ç§’</p><ol><li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ BackupStorageLocation å¯¹è±¡ï¼Œæ„å»ºä¸€ä¸ªé»˜è®¤çš„ BackupStorageLocation ä½äºç¬¬ä¸€ä½çš„åˆ—è¡¨</li><li>éå†æ­¥éª¤ 1 ä¸­çš„ BackupStorageLocation åˆ—è¡¨ï¼Œå¦‚æœåŒæ­¥å‘¨æœŸç­‰äº 0 ä»£è¡¨è¯¥ BackupStorageLocation ä¸ä½œåŒæ­¥æ“ä½œï¼Œç›´æ¥è·³è¿‡å³å¯ï¼Œå¦åˆ™åˆ¤æ–­å…¶æ˜¯å¦åˆ°è¾¾ä¸‹æ¬¡åŒæ­¥æ—¶é—´</li><li>è°ƒç”¨ StorageProvider çš„ ListBackups æ–¹æ³•è·å–æ‰€æœ‰çš„ Backupï¼›åŒæ—¶è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ Backup</li><li>è·å–åœ¨ BackupStorageLocation ä¸­ä½†æ˜¯ä¸åœ¨é›†ç¾¤ä¸­çš„ Backupï¼Œè¿™äº›å°±æ˜¯å¾…åŒæ­¥çš„ Backup</li><li>é’ˆå¯¹æ¯ä¸€ä¸ªå¾…åŒæ­¥çš„ Backupï¼Œè°ƒç”¨ StorageProvider çš„ GetBackupMetadata æ–¹æ³•ï¼Œè·å– Metadata æ–‡ä»¶ï¼ˆå³ velero-backup.jsonï¼‰ï¼Œè§£æå†…å®¹å¾—åˆ° Backup å¯¹è±¡</li><li>è®¾ç½® Backup çš„ namespaceã€resourceVersionã€storageLocation å’Œ label ç­‰ä¿¡æ¯ï¼Œå¹¶åœ¨é›†ç¾¤ä¸­åˆ›å»º<br><em>æ—¢ç„¶å·²ç»å­˜åœ¨äº BackupStorage Locationï¼ŒçŠ¶æ€å¿…ç„¶ä¸ºå®ŒæˆçŠ¶æ€ï¼ˆå³ä¸æ˜¯ç©ºæˆ–è€… Newï¼‰ï¼Œå› æ­¤ä¸ä¼šè¢« Backup Controller é‡å¤å¤„ç†</em></li><li>è°ƒç”¨ StorageProvider çš„ GetPodVolumeBackups æ–¹æ³•è·å–ä¸è¯¥ Backup ç›¸å…³çš„ PodVolumeBackup</li><li>è®¾ç½® PodVolumeBackup çš„ namespaceã€resourceVersionã€ownerReferences å’Œ label ç­‰ä¿¡æ¯ï¼Œå¹¶åœ¨é›†ç¾¤ä¸­åˆ›å»º<br><em>åŒç†ï¼Œä¸ä¼šè¢« PodVolumeBackup Controller é‡å¤å¤„ç†</em></li><li>å¦‚æœ Velero å¼€å¯äº† CSI ç‰¹æ€§ï¼Œé€šè¿‡ StorageProvider çš„ GetCSIVolumeSnapshotContents æ–¹æ³•è·å–ä¸è¯¥ Backup ç›¸å…³çš„ VolumeSnapshotContents</li><li>è®¾ç½® VolumeSnapshotContent çš„ resourceVersion ç­‰ä¿¡æ¯ï¼Œå¹¶åœ¨é›†ç¾¤ä¸­åˆ›å»º</li><li>åˆ é™¤å­¤å„¿ Backupï¼Œä¹Ÿå°±æ˜¯åœ¨é›†ç¾¤ä¸­å­˜åœ¨ï¼ŒçŠ¶æ€ä¸º Completedï¼Œä½†æ˜¯åœ¨ BackupStorageLocation ä¸­ä¸å­˜åœ¨çš„ Backup</li><li>æ›´æ–°é›†ç¾¤ä¸­è¯¥ BackupStorageLocation çš„ä¸Šæ¬¡åŒæ­¥æ—¶é—´<br><em>å®é™…ä¸Šæ­¥éª¤ 4 è·å– BackupStorageLocation çš„ Backup æ—¶å¯ä»¥ä½œä¸ºåŒæ­¥æ“ä½œ</em></li></ol><h1 id="GC-Controller"><a href="#GC-Controller" class="headerlink" title="GC Controller"></a>GC Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;gc_controller.go</u></em></p><h2 id="NewGCController"><a href="#NewGCController" class="headerlink" title="NewGCController"></a>NewGCController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/gc_controller.go#L58">NewGCController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li><li>ç›‘å¬ Backup èµ„æºçš„ Add å’Œ Update äº‹ä»¶ï¼Œå°† Backup ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li></ol><h2 id="processQueueItem-2"><a href="#processQueueItem-2" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/gc_controller.go#L104">processQueueItem æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p><ol><li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ Backup keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ Backup å¯¹è±¡</li><li>ä»…å¤„ç†å·²ç»è¿‡æœŸçš„ Backup å¯¹è±¡</li><li>è·å– Backup æ‰€å±çš„ BackupStorageLocationï¼Œåˆ¤æ–­å…¶æ¨¡å¼æ˜¯å¦ä¸º ReadWrite</li><li>è·å–é›†ç¾¤ä¸­å’Œè¯¥ Backup ç›¸å…³çš„ DeleteBackupRequest å¯¹è±¡ï¼Œå¦‚æœå…¶ä¸­å­˜åœ¨çŠ¶æ€ä¸ºç©ºã€New å’Œ InProgress çš„ï¼Œåˆ™è®¤ä¸ºæ­£åœ¨åˆ é™¤ï¼Œæœ¬æ¬¡ä¸åšå¤„ç†ï¼›å¦åˆ™ï¼Œæ„å»ºä¸€ä¸ª DeleteBackupRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± BackupDeletion Controller è´Ÿè´£ç»´æŠ¤</li></ol><h2 id="enqueueAllBackups"><a href="#enqueueAllBackups" class="headerlink" title="enqueueAllBackups"></a>enqueueAllBackups</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/gc_controller.go#L90">enqueueAllBackups æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 1 å°æ—¶</p><ol><li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ Backup å¯¹è±¡ï¼Œå…¨é‡åŠ å…¥åˆ° Generic Controller çš„ queue ä¸­</li></ol>]]></content>
    
    
    <summary type="html">Velero ä¸­ä¸ Backupã€Schedule ç­‰å¤‡ä»½ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æºç èµ°è¯» â€” Location</title>
    <link href="http://shenxianghong.github.io/2022/01/17/2022-01-17%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Location/"/>
    <id>http://shenxianghong.github.io/2022/01/17/2022-01-17%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Location/</id>
    <published>2022-01-16T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.166Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="BackupStorageLocation"><a href="#BackupStorageLocation" class="headerlink" title="BackupStorageLocation"></a>BackupStorageLocation</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/backupstoragelocation_types.go">API</a></p><h2 id="backup-location"><a href="#backup-location" class="headerlink" title="backup-location"></a>backup-location</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backuplocation&#x2F;backup-location.go</u></em></p><p>velero backup-location åŒ…æ‹¬ 4 ä¸ªå­å‘½ä»¤ï¼šcreateã€deleteã€get å’Œ setã€‚</p><h2 id="create"><a href="#create" class="headerlink" title="create"></a>create</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup-location&#x2F;create.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>â€“provider å’Œ â€“bucket ä¸ºå¿…éœ€å‚æ•°</li><li>åœ¨æŒ‡å®š â€“backup-sync-period å‚æ•°æ—¶ï¼Œå…¶å€¼å¿…é¡»è¦å¤§äºç­‰äº 0 </li><li>åœ¨æŒ‡å®š â€“credential å‚æ•°æ—¶ï¼Œå…¶å€¼ä»…èƒ½åŒ…å«ä¸€å¯¹ key-value</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º BackupStorageLocation å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± BackupStorageLocation Controller è´Ÿè´£ç»´æŠ¤</li><li>å¦‚æœæ–°åˆ›å»ºçš„ BackupStorageLocation ä¸ºé»˜è®¤çš„ï¼Œåˆ™å°†é›†ç¾¤ä¸­å…¶ä½™çš„ BackupStorageLocation è®¾ä¸ºéé»˜è®¤</li></ol><h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup-location&#x2F;delete.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>nameã€â€“all å’Œ â€“selector å‚æ•°æœ‰ä¸”ä»…èƒ½æœ‰ä¸€ä¸ª</li><li>è¦åˆ é™¤çš„ BackupStorageLocation åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œè·å–é›†ç¾¤ä¸­çš„ BackupStorageLocation èµ„æºå¹¶åˆ é™¤</li></ol><h2 id="get"><a href="#get" class="headerlink" title="get"></a>get</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup-location&#x2F;get.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>å¦‚æœæ˜¾å¼æŒ‡å®šè¦è·å–çš„ BackupStorageLocationï¼Œåˆ™å…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>æµç¨‹é€»è¾‘</strong></p><ol><li>è·å–åˆ° BackupStorageLocation èµ„æºï¼Œæ ¹æ® â€“output æŒ‡å®šçš„æ ·å¼æ ¼å¼åŒ–è¾“å‡º</li></ol><h2 id="set"><a href="#set" class="headerlink" title="set"></a>set</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup-location&#x2F;set.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>åœ¨æŒ‡å®š â€“credential å‚æ•°æ—¶ï¼Œå…¶å€¼ä»…èƒ½åŒ…å«ä¸€å¯¹ key-value</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>æ ¹æ®å‘½ä»¤è¡Œæä¾›çš„å‚æ•°ä¿¡æ¯ï¼Œå°†å…¶æ›´æ–°è‡³é›†ç¾¤ä¸­çš„ BackupStorageLocation å¯¹è±¡ä¸­</li><li>å…¶ä¸­ï¼Œå¦‚æœå‚æ•°ä¿¡æ¯æ˜¯å°†å…¶è®¾ç½®ä¸ºé»˜è®¤ï¼ˆâ€“defaultï¼‰ï¼Œåˆ™ä¼šå°†é›†ç¾¤ä¸­å…¶ä½™çš„ BackupStorageLocation è®¾ä¸ºéé»˜è®¤</li></ol><h1 id="ResticRepository"><a href="#ResticRepository" class="headerlink" title="ResticRepository"></a>ResticRepository</h1><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/restic_repository.go">API</a></p><p>ResticRepository ä¸æ”¯æŒé€šè¿‡å‘½ä»¤è¡Œæ‰‹åŠ¨åˆ›å»ºï¼Œè€Œæ˜¯åœ¨å¤‡ä»½æµç¨‹ä¸­ï¼Œç”± Backup Controller è°ƒç”¨ <strong>ensureRepo</strong>ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªå·å‘½åç©ºé—´ï¼Œåˆ›å»ºä¸€ä¸ªè¯¥å¯¹è±¡ã€‚<br><em>æ³¨æ„æ˜¯ Pod æ‰€åœ¨çš„å‘½åç©ºé—´ï¼ˆå³å·å‘½åç©ºé—´ï¼‰ï¼Œè€Œé Velero æˆ–è€… Restic æ‰€åœ¨çš„å‘½åç©ºé—´</em></p><h2 id="repo"><a href="#repo" class="headerlink" title="repo"></a>repo</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restic&#x2F;repo&#x2F;repo.go</u></em></p><h3 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h3><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restic&#x2F;repo&#x2F;get.go</u></em></p><p><strong>æ ¡éªŒè§„åˆ™</strong></p><ul><li>å¦‚æœæ˜¾å¼æŒ‡å®šè¦è·å–çš„ ResticRepositoryï¼Œåˆ™å…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li></ul><p><strong>ä¸»ä½“æµç¨‹</strong></p><ol><li>è·å–åˆ° ResticRepository èµ„æºï¼Œæ ¹æ® â€“output æŒ‡å®šçš„æ ·å¼æ ¼å¼åŒ–è¾“å‡º</li></ol><h2 id="server"><a href="#server" class="headerlink" title="server"></a>server</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;restic&#x2F;server.go</u></em></p><p>server æœ¬èº«æ˜¯ velero restic çš„ hidden ç±»å‹çš„å‘½ä»¤ï¼Œæ˜¯ Restic æœåŠ¡çš„å¯åŠ¨å‘½ä»¤ã€‚</p><ol><li>ç”±äº Pod ä¼šå°†æ‰€åœ¨æ‰€åœ¨èŠ‚ç‚¹çš„ &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods æŒ‚åœ¨åˆ°å®¹å™¨å†… &#x2F;host_pods ç›®å½•ä¸‹ï¼Œå› æ­¤ï¼Œä¼šæ ¡éªŒå½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰ Pod å·æ˜¯å¦å‡å·²æŒ‚è½½åˆ°å®¹å™¨å†…</li><li>å¯åŠ¨ Restic æœåŠ¡ï¼Œå†…éƒ¨ä¼šå¯åŠ¨ 1 ä¸ª PodVolumeBackupController å’Œ 1 ä¸ª PodVolumeRestoreControllerï¼Œç”¨äºå¤„ç†å·å¤‡ä»½ä¸æ¢å¤çš„æµç¨‹</li></ol><h1 id="BackupStorageLocation-Controller"><a href="#BackupStorageLocation-Controller" class="headerlink" title="BackupStorageLocation Controller"></a>BackupStorageLocation Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;backup_storage_location_controller.go</u></em></p><h2 id="Reconcile"><a href="#Reconcile" class="headerlink" title="Reconcile"></a>Reconcile</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_storage_location_controller.go#L55">Reconcile æºç </a></p><ol><li>é’ˆå¯¹é›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ª BackupStorageLocationï¼Œå¦‚æœä¸å­˜åœ¨é»˜è®¤çš„æ—¶ï¼Œä¼šæ ¹æ® Velero æœåŠ¡å¯åŠ¨å‘½ä»¤ä¸­çš„ä¿¡æ¯è®¾ç½®ä¸€ä¸ªé»˜è®¤ <br><em>åœ¨ Velero ä¹‹å‰ç‰ˆæœ¬ä¸­ï¼ŒVelero æœåŠ¡å¯åŠ¨æ—¶å¯ä»¥è®¾ç½®é»˜è®¤çš„ BackupStorageLocationï¼Œåœ¨ 2.0 ä¹‹ååºŸå¼ƒï¼Œæ”¹ç”¨ velero backup-location set â€“default çš„æ–¹å¼ï¼Œè€Œåœ¨ Controller ä¸­ä»ç„¶ä¿ç•™äº†è¿™æ®µé€»è¾‘ï¼Œç”¨äºå‘åå…¼å®¹</em></li><li>è®¡ç®— BackupStorageLocation æ˜¯å¦å·²ç»å‡†å¤‡å¥½è¿›è¡ŒéªŒè¯ï¼ˆå³æ˜¯å¦åˆ°è¾¾ä¸Šæ¬¡éªŒè¯æ—¶é—´ + éªŒè¯é¢‘ç‡ï¼‰ï¼Œè§„åˆ™å¤§è‡´ä¸º<ul><li>é¢‘ç‡ç­‰äº 0 æ—¶ï¼Œä¸ä½œéªŒè¯</li><li>é¢‘ç‡å°äº 0 æ—¶ï¼Œä¸ºä¸åˆæ³•åœºæ™¯ï¼Œå°†é¢‘ç‡é‡ç½®ä¸ºé»˜è®¤çš„ 1 åˆ†é’Ÿ</li><li>å¦‚æœæœªåšè¿‡éªŒè¯ï¼ˆå³ç¬¬ä¸€æ¬¡å°è¯•éªŒè¯æ—¶ï¼‰ï¼Œæ— è§†å…¶è®¾ç½®çš„éªŒè¯é¢‘ç‡ï¼Œç›´æ¥è¿”å› trueï¼Œè¡¨ç¤ºç«‹å³å¼€å§‹éªŒè¯æµç¨‹</li></ul></li><li>æ„å»ºè¯·æ±‚ StorageProvider ä¸­æ‰€éœ€è¦ BackupStorageLocation  å¯¹è±¡ï¼Œå…¶ä¸­å¦‚æœ BackupStorageLocation ä¸­è®¾ç½®äº† Credential ä¿¡æ¯ï¼Œåˆ™ä¼šè·å–ä½äº Velero å‘½åç©ºé—´ä¸‹çš„ Secretï¼Œå°† Secret å†…å®¹ä»¥ &lt;Secret Name&gt; - &lt;Secret Key&gt; çš„å½¢å¼æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œå¹¶å°† BackupStorageLocation çš„ credentialsFile å­—æ®µæŒ‡å‘è¯¥æ–‡ä»¶<br><br><em>é€šå¸¸ä½äº &#x2F;tmp&#x2F;credentials&#x2F;velero ç›®å½•ä¸­</em></li><li>é€šè¿‡ StorageProvider çš„ IsValid æ¥å£åˆ¤æ–­ BackupStorageLocation æ˜¯å¦å¯ç”¨</li><li>æ›´æ–°é›†ç¾¤ä¸­ BackupStorageLocation çŠ¶æ€å’Œä¸Šæ¬¡éªŒè¯æ—¶é—´</li><li>æœ€ç»ˆæ— è®ºç»“æœå¦‚ä½•ï¼Œéƒ½ä¼šé‡æ–°å…¥é˜Ÿ</li></ol><h1 id="ResticRepository-Controller"><a href="#ResticRepository-Controller" class="headerlink" title="ResticRepository Controller"></a>ResticRepository Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;restic_repository_controller.go</u></em></p><h2 id="NewResticRepositoryController"><a href="#NewResticRepositoryController" class="headerlink" title="NewResticRepositoryController"></a>NewResticRepositoryController</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restic_repository_controller.go#L57">NewResticRepositoryController æºç </a></p><p>å·¥å‚å‡½æ•°</p><ol><li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li><li>ç›‘å¬ ResticRepository èµ„æºçš„ Add äº‹ä»¶ï¼Œå°† ResticRepository ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li></ol><h2 id="processQueueItem"><a href="#processQueueItem" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restic_repository_controller.go#L111">processQueueItem æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p><ol><li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ ResticRepository keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ ResticRepository å¯¹è±¡</li><li>å¦‚æœ ResticRepository å¯¹è±¡çŠ¶æ€ä¸ºç©ºæˆ–è€…æ˜¯ Newï¼Œåˆ™è°ƒç”¨ <strong>initializeRepo</strong> åˆå§‹åŒ–ä¸€ä¸ª Restic ä»“åº“</li><li>å¦åˆ™ä¼šè¿›ä¸€æ­¥åˆ¤æ–­ ResticRepository å¯¹è±¡çŠ¶æ€<ul><li>å¦‚æœçŠ¶æ€ä¸º Readyï¼Œåˆ™æ‰§è¡Œ restic prune å‘½ä»¤ï¼Œåˆ¤æ–­æ˜¯å¦å¯ä»¥å»ºç«‹è¿æ¥ï¼Œå¹¶æ›´æ–° ResticRepository ä¸Šæ¬¡ç»´æŠ¤æ—¶é—´ä¿¡æ¯</li><li>å¦‚æœçŠ¶æ€ä¸º NotReadyï¼Œåˆ™è°ƒç”¨ <strong>ensureRepo</strong> å°è¯•æ£€æŸ¥æˆ–åˆå§‹åŒ–ä¸€ä¸ªä»“åº“ï¼Œå¹¶æ ¹æ®è¿”å›ç»“æœæ›´æ–° ResticRepository çš„çŠ¶æ€ä¸º Ready æˆ–è€… NotReady<br><em>restic prune çš„æ‰§è¡Œå¤±è´¥å¹¶ä¸ä¼šå½±å“åˆ°ä¸»æµç¨‹ï¼Œåªæ˜¯ä¼šåœ¨ ResticRepository å¯¹è±¡ä¸­è®°å½•é”™è¯¯ä¿¡æ¯</em></li></ul></li></ol><h2 id="initializeRepo"><a href="#initializeRepo" class="headerlink" title="initializeRepo"></a>initializeRepo</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restic_repository_controller.go#L157">initializeRepo æºç </a></p><p>å°è¯•åˆå§‹åŒ– Restic ä»“åº“çš„ä¸»ä½“æµç¨‹ï¼ˆçœŸæ­£åˆå§‹åŒ–çš„åŠ¨ä½œä½äº <strong>ensureRepo</strong>ï¼‰</p><ol><li>ResticRepository å¯¹è±¡ä¸­æœ‰ BackupStorageLocation çš„ä¿¡æ¯ï¼Œæ ¹æ®è¿™ä¸ªä¿¡æ¯è·å–é›†ç¾¤ä¸­çš„ BackupStorageLocation å¯¹è±¡ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™æ›´æ–° ResticRepository å¯¹è±¡çš„çŠ¶æ€ä¸º NotReady</li><li>è°ƒç”¨ <strong>GetRepoIdentifier</strong> è·å– Restic ä»“åº“ä¿¡æ¯ï¼ˆå³ â€“repo æ‰€éœ€çš„ä¿¡æ¯ï¼‰ï¼Œå¹¶æ›´æ–°è‡³ ResticRepository å¯¹è±¡ä¸­ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™å°† ResticRepository å¯¹è±¡çš„çŠ¶æ€è®¾ç½®ä¸º NotReady</li><li>è°ƒç”¨ <strong>ensureRepo</strong> å°è¯•æ£€æŸ¥æˆ–åˆå§‹åŒ–ä¸€ä¸ªä»“åº“ï¼Œå¹¶æ ¹æ®è¿”å›ç»“æœæ›´æ–° ResticRepository çš„çŠ¶æ€å’Œä¸Šæ¬¡ç»´æŠ¤æ—¶é—´ä¿¡æ¯</li></ol><h2 id="ensureRepo"><a href="#ensureRepo" class="headerlink" title="ensureRepo"></a>ensureRepo</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restic_repository_controller.go#L205">ensureRepo æºç </a></p><p>æ£€æŸ¥ Restic ä»“åº“æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°è¯•åˆå§‹åŒ–ä¸€ä¸ª</p><ol><li>é€šè¿‡æ‰§è¡Œ restic snapshots çš„ç»“æœï¼Œæ¥ç¡®ä¿ Restic ä»“åº“å­˜åœ¨å¹¶ä¸”æƒé™å¯è¾¾</li><li>å¦‚æœå‘½ä»¤æ‰§è¡Œè¿”å›é”™è¯¯ä¿¡æ¯ä¸­åŒ…å« â€œIs there a repository at the following location?â€  å­—ç¬¦ä¸²ï¼Œè¡¨ç¤º Restic ä»“åº“ä¸å­˜åœ¨ï¼Œä¼šé€šè¿‡ restic init å‘½ä»¤åˆå§‹åŒ–ä¸€ä¸ªæ–°ä»“åº“</li></ol><h2 id="GetRepoIdentifier"><a href="#GetRepoIdentifier" class="headerlink" title="GetRepoIdentifier"></a>GetRepoIdentifier</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restic/config.go#L101">GetRepoIdentifier æºç </a></p><p>æ„å»º Restic å‘½ä»¤è¡Œéœ€è¦çš„ â€“repo å‚æ•°å†…å®¹</p><ol><li>æ ¹æ® BackupStorageLocation çš„ Provider ä¿¡æ¯è·å–åˆ°å¯¹åº”åç«¯ç±»å‹ï¼ˆvelero.io&#x2F;providerï¼‰ï¼ŒVelero Restic æ”¯æŒçš„ç±»å‹æœ‰ velero.io&#x2F;awsã€velero.io&#x2F;azure å’Œ velero.io&#x2F;gcpï¼Œæ‹¼æ¥åä½œä¸º RepoPrefix</li><li>RepoPrefix æ‹¼æ¥ä¸Š ResticRepository ä¸­çš„ VolumeNamespace ä¿¡æ¯ä½œä¸º RepoIdentifierï¼Œä¹Ÿå°±æ˜¯ Restic åŸç”Ÿå‘½ä»¤ä¸­çš„ â€“repo å‚æ•°</li></ol><h2 id="enqueueAllRepositories"><a href="#enqueueAllRepositories" class="headerlink" title="enqueueAllRepositories"></a>enqueueAllRepositories</h2><p><a href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/restic_repository_controller.go#L97">enqueueAllRepositories æºç </a></p><p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 5 åˆ†é’Ÿ</p><ol><li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ ResticRepository å¯¹è±¡ï¼Œå…¨é‡åŠ å…¥åˆ° Generic Controller çš„ queue ä¸­<br><em>ä¹‹æ‰€ä»¥æ˜¯å…¨é‡ï¼Œæ˜¯å› ä¸ºç½‘ç»œè¿æ¥çš„ä¸ç¡®å®šæ€§ï¼Œéœ€è¦é‡æ–°åˆ¤æ–­æ‰€æœ‰çš„ ResticRepository å¯è¾¾çŠ¶æ€</em></li></ol>]]></content>
    
    
    <summary type="html">Velero ä¸­ä¸ Locationã€Repository ç­‰å­˜å‚¨ç«™ç‚¹ç›¸å…³çš„æµç¨‹æ¢³ç†</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Rust ã€æ•°æ®ç±»å‹</title>
    <link href="http://shenxianghong.github.io/2022/01/16/2022-01-16%20Rust%20%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"/>
    <id>http://shenxianghong.github.io/2022/01/16/2022-01-16%20Rust%20%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</id>
    <published>2022-01-15T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.161Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="150" style="border: 0px" src="/gallery/rust/logo.png"></div><hr><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>Rust æ˜¯é™æ€ç¼–è¯‘è¯­è¨€ï¼Œåœ¨ç¼–è¯‘æ—¶å¿…é¡»çŸ¥é“æ‰€æœ‰å˜é‡çš„ç±»å‹</p><ul><li>åŸºäºä½¿ç”¨çš„å€¼ï¼Œç¼–è¯‘å™¨é€šå¸¸èƒ½å¤Ÿæ¨æ–­å‡ºå®ƒçš„å…·ä½“ç±»å‹</li><li>ä½†å¦‚æœå¯èƒ½çš„ç±»å‹æ¯”è¾ƒå¤šï¼Œä¾‹å¦‚æŠŠ String è½¬ä¸ºæ•´æ•°çš„ parse æ–¹æ³•ï¼Œå°±å¿…é¡»æ·»åŠ ç±»å‹çš„æ ‡æ³¨ï¼Œå¦åˆ™ç¼–è¯‘ä¼šæŠ¥é”™</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">guess</span>: <span class="type">u32</span> = <span class="string">&quot;42&quot;</span>.<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;Not a number&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, guess);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºé’ˆå¯¹æ•°å­— 42 åœ¨ Rust ä¸­æœ‰å¾ˆå¤šæ•°æ®ç±»å‹å¯ä»¥å°†å…¶åŒ…å«åœ¨å†…ï¼Œå¦‚ <code>i32</code> å’Œ <code>u32</code> ç­‰ç­‰ï¼Œæ‰€ä»¥è¦ç»™å˜é‡å…·ä½“æŒ‡æ˜ç±»å‹ï¼Œå¦‚æœæœªæŒ‡æ˜ï¼Œåˆ™ä¼šç¼–è¯‘æŠ¥é”™ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">error[E0282]: type annotations needed</span><br><span class="line"><span class="meta prompt_"> --&gt; </span><span class="language-bash">src/main.rs:2:9</span></span><br><span class="line">  |</span><br><span class="line">2 |     let guess = &quot;42&quot;.parse().expect(&quot;Not a number&quot;);</span><br><span class="line">  |         ^^^^^ consider giving `guess` a type</span><br></pre></td></tr></table></figure><h1 id="æ ‡é‡ç±»å‹"><a href="#æ ‡é‡ç±»å‹" class="headerlink" title="æ ‡é‡ç±»å‹"></a>æ ‡é‡ç±»å‹</h1><p>ä¸€ä¸ªæ ‡é‡ç±»å‹ä»£è¡¨ä¸€ä¸ªå•ä¸ªçš„å€¼ã€‚</p><p>Rust æœ‰å››ä¸ªä¸»è¦çš„æ ‡é‡ç±»å‹ï¼š</p><ul><li>æ•´æ•°ç±»å‹</li><li>æµ®ç‚¹ç±»å‹</li><li>å¸ƒå°”ç±»å‹</li><li>å­—ç¬¦ç±»å‹</li></ul><h2 id="æ•´æ•°ç±»å‹"><a href="#æ•´æ•°ç±»å‹" class="headerlink" title="æ•´æ•°ç±»å‹"></a>æ•´æ•°ç±»å‹</h2><p>æ•´æ•°ç±»å‹æ²¡æœ‰å°æ•°éƒ¨åˆ†ï¼Œæ— ç¬¦å·æ•´æ•°ç±»å‹ä»¥ <code>u</code>ï¼ˆusizeï¼‰å¼€å¤´ï¼Œæœ‰ç¬¦å·æ•´æ•°ç±»å‹ä»¥ <code>i</code> ï¼ˆintegerï¼‰å¼€å¤´ï¼Œä¾‹å¦‚ u32 å°±æ˜¯ä¸€ä¸ªæ— ç¬¦å·çš„æ•´æ•°ç±»å‹ï¼Œå æ® 32 ä½çš„ç©ºé—´ã€‚</p><h3 id="æ•´æ•°ç±»å‹è¡¨"><a href="#æ•´æ•°ç±»å‹è¡¨" class="headerlink" title="æ•´æ•°ç±»å‹è¡¨"></a>æ•´æ•°ç±»å‹è¡¨</h3><ul><li>æ¯ç§éƒ½åˆ† i å’Œ uï¼Œä»¥åŠå›ºå®šçš„ä½æ•°</li><li>æœ‰ç¬¦å·çš„èŒƒå›´æ˜¯ <code>-(2^n^ - 1) åˆ° 2^n-1^ - 1</code></li><li>æ— ç¬¦å·èŒƒå›´ï¼š<code>0 åˆ° 2^n^ -1</code></li></ul><table><thead><tr><th>Length</th><th>Signed</th><th>Unsigned</th></tr></thead><tbody><tr><td>8-bit</td><td>i8</td><td>u8</td></tr><tr><td>16-bit</td><td>i16</td><td>u16</td></tr><tr><td>32-bit</td><td>i32</td><td>u32</td></tr><tr><td>64-bit</td><td>i64</td><td>u64</td></tr><tr><td>128-bit</td><td>i128</td><td>u128</td></tr><tr><td>arch</td><td>isize</td><td>usize</td></tr></tbody></table><p><code>isize</code> å’Œ <code>usize</code> ç±»å‹çš„ä½æ•°ç”±ç¨‹åºè¿è¡Œçš„è®¡ç®—æœºçš„æ¶æ„æ‰€å†³å®šï¼Œå¦‚æœæ˜¯ 64 ä½è®¡ç®—æœºï¼Œé‚£å°±æ˜¯ 64 ä½çš„ã€‚ä½¿ç”¨åœºæ™¯æ¯”å¦‚ï¼Œå¯¹æŸä¸ªé›†åˆè¿›è¡Œç´¢å¼•æ“ä½œã€‚</p><h3 id="æ•´æ•°å­—é¢å€¼"><a href="#æ•´æ•°å­—é¢å€¼" class="headerlink" title="æ•´æ•°å­—é¢å€¼"></a>æ•´æ•°å­—é¢å€¼</h3><table><thead><tr><th>Number literals</th><th>Example</th></tr></thead><tbody><tr><td>Decimal</td><td>98_222</td></tr><tr><td>Hex</td><td>0xff</td></tr><tr><td>Octal</td><td>0o77</td></tr><tr><td>Binary</td><td>0b1111_0000</td></tr><tr><td>Byte (u8 only)</td><td>bâ€™Aâ€™</td></tr></tbody></table><ul><li><p>é™¤äº† <code>byte</code> ç±»å‹å¤–ï¼Œæ‰€æœ‰çš„æ•°å­—å­—é¢å€¼éƒ½å…è®¸ä½¿ç”¨ç±»å‹åç¼€ï¼Œä¾‹å¦‚ 57u8</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// æ­¤æ—¶ï¼Œfoo çš„ç±»å‹ä¸º u8ï¼Œå€¼ä¸º 57</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">foo</span> = <span class="number">57u8</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, foo)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ•´æ•°çš„é»˜è®¤ç±»å‹å°±æ˜¯ <code>i32</code></p></li></ul><h3 id="æ•´æ•°æº¢å‡º"><a href="#æ•´æ•°æº¢å‡º" class="headerlink" title="æ•´æ•°æº¢å‡º"></a>æ•´æ•°æº¢å‡º</h3><p>ä¾‹å¦‚ï¼Œu8 çš„èŒƒå›´æ˜¯ 0 - 255ï¼Œå¦‚æœæŠŠä¸€ä¸ª u8 ç±»å‹å˜é‡çš„å€¼è®¾ä¸º 256ï¼Œé‚£ä¹ˆï¼š</p><ul><li><strong>è°ƒè¯•æ¨¡å¼ä¸‹ç¼–è¯‘</strong>ï¼š Rust ä¼šæ£€æŸ¥æ•´æ•°æº¢å‡ºï¼Œå¦‚æœå‘ç”Ÿæº¢å‡ºï¼Œç¨‹åºåœ¨è¿è¡Œæ—¶å°±ä¼š panic</li><li><strong>å‘å¸ƒæ¨¡å¼ä¸‹ç¼–è¯‘</strong>ï¼š Rust ä¸ä¼šæ£€æŸ¥å¯èƒ½å¯¼è‡´ panic çš„æ•´æ•°æº¢å‡ºï¼Œå¦‚æœå‘ç”Ÿæº¢å‡ºï¼ŒRust ä¼šæ‰§è¡Œ<strong>ç¯ç»•æ“ä½œ</strong>ï¼Œä¹Ÿå°±æ˜¯ 256 å˜ä¸º 1ï¼Œ257 å˜ä¸º 2ï¼Œä»¥æ­¤ç±»æ¨</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">foo</span>: <span class="type">u8</span> = <span class="number">255</span>;</span><br><span class="line">    foo = foo + <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, foo)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>cargo run</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">thread &#x27;main&#x27; panicked at &#x27;attempt to add with overflow&#x27;, src/main.rs:3:11</span><br><span class="line">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</span><br></pre></td></tr></table></figure><p><em>cargo build â€“release</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./target/release/hello-world</span></span><br><span class="line">1</span><br></pre></td></tr></table></figure><h2 id="æµ®ç‚¹ç±»å‹"><a href="#æµ®ç‚¹ç±»å‹" class="headerlink" title="æµ®ç‚¹ç±»å‹"></a>æµ®ç‚¹ç±»å‹</h2><p>Rust çš„æµ®ç‚¹ç±»å‹ä½¿ç”¨äº† IEEE-754 æ ‡å‡†æ¥è¡¨è¿°ï¼Œæœ‰ä¸¤ç§åŸºç¡€çš„æµ®ç‚¹ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å«æœ‰å°æ•°éƒ¨åˆ†çš„ç±»å‹ï¼š</p><ul><li>f32ï¼Œå•ç²¾åº¦</li><li>f64ï¼ŒåŒç²¾åº¦ï¼ŒRust ä¸­é»˜è®¤çš„æµ®ç‚¹ç±»å‹</li></ul><h2 id="å¸ƒå°”ç±»å‹"><a href="#å¸ƒå°”ç±»å‹" class="headerlink" title="å¸ƒå°”ç±»å‹"></a>å¸ƒå°”ç±»å‹</h2><p>Rust çš„å¸ƒå°”ç±»å‹ï¼ˆtrue &amp; falseï¼‰å ç”¨ 1 å­—èŠ‚å¤§å°ï¼Œç¬¦å·ä¸º boolã€‚</p><h2 id="å­—ç¬¦ç±»å‹"><a href="#å­—ç¬¦ç±»å‹" class="headerlink" title="å­—ç¬¦ç±»å‹"></a>å­—ç¬¦ç±»å‹</h2><p>Rust ä¸­ <code>char</code> ç±»å‹ç”¨æ¥æè¿°è¯­è¨€ä¸­æœ€åŸºç¡€çš„å•ä¸ªå­—ç¬¦ï¼Œå­—ç¬¦ç±»å‹çš„å­—é¢å€¼ä½¿ç”¨å•å¼•å·ï¼Œå ç”¨ 4 å­—èŠ‚çš„å¤§å°ï¼Œæ˜¯ Unicode çš„æ ‡é‡å€¼ï¼Œå¯ä»¥è¡¨ç¤ºæ¯” ASCII å¤šå¾—å¤šçš„å­—ç¬¦å†…å®¹ï¼Œå¦‚æ‹¼éŸ³ï¼Œä¸­æ—¥éŸ©æ–‡ï¼Œé›¶é•¿åº¦ç©ºç™½å­—ç¬¦ï¼Œemoji è¡¨æƒ…ç­‰ã€‚</p><p>èŒƒå›´æ˜¯ <code>U+0000 åˆ° U+D7FF</code> å’Œ <code>U+E000</code> åˆ° <code>U+10FFFF</code>ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="string">&#x27;z&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">y</span>: <span class="type">char</span> = <span class="string">&#x27;å­—&#x27;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">z</span> = &#x27;ğŸ˜„&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å¤åˆç±»å‹"><a href="#å¤åˆç±»å‹" class="headerlink" title="å¤åˆç±»å‹"></a>å¤åˆç±»å‹</h1><p>å¤åˆç±»å‹å¯ä»¥å°†å¤šä¸ªå€¼æ”¾åˆ°ä¸€ä¸ªç±»å‹é‡Œã€‚</p><p>Rust æœ‰ä¸¤ä¸ªä¸»è¦çš„å¤åˆç±»å‹ï¼š</p><ul><li>å…ƒç»„</li><li>æ•°ç»„</li></ul><h2 id="å…ƒç»„ï¼ˆTupleï¼‰"><a href="#å…ƒç»„ï¼ˆTupleï¼‰" class="headerlink" title="å…ƒç»„ï¼ˆTupleï¼‰"></a>å…ƒç»„ï¼ˆTupleï¼‰</h2><p>å…ƒç»„å¯ä»¥å°†å¤šä¸ªç±»å‹çš„å¤šä¸ªå€¼æ”¾åˆ°ä¸€ä¸ªç±»å‹é‡Œï¼Œå¹¶ä¸”é•¿åº¦å›ºå®šï¼Œä¸€æ—¦å£°æ˜ä¸å¯æ”¹å˜ã€‚</p><p>å…ƒç»„çš„ç±»å‹ä¸ºï¼š<code>(ç±»å‹1,ç±»å‹2,...)</code></p><p>è®¿é—®å…ƒç»„ä¸­çš„å…ƒç´ å€¼å¯ä»¥ä½¿ç”¨<strong>æ¨¡å¼åŒ¹é…ï¼ˆdestructureï¼‰å’Œç‚¹æ ‡è®°æ³•</strong>ã€‚</p><p><strong>æ¨¡å¼åŒ¹é…</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tup</span>: (<span class="type">i32</span>, <span class="type">bool</span>, <span class="type">char</span>) = (<span class="number">500</span>, <span class="literal">false</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    <span class="comment">// x, y, z çš„ç±»å‹ä¸å€¼åˆ†åˆ«å¯¹åº” tup ä¸­çš„ä¸‰ä¸ªå…ƒç´ ï¼Œå³ let x: 132 = 500</span></span><br><span class="line">    <span class="keyword">let</span> (x, y, z) = tup;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, x, y, z);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç‚¹æ ‡è®°æ³•</strong></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tup</span>: (<span class="type">i32</span>, <span class="type">bool</span>, <span class="type">char</span>) = (<span class="number">500</span>, <span class="literal">false</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, tup.<span class="number">0</span>, tup.<span class="number">1</span>, tup.<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç‚¹æ ‡è®°æ³•çš„â€œç´¢å¼•â€œä¸å¯ä»¥æ˜¯å˜é‡ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tup</span>: (<span class="type">i32</span>, <span class="type">bool</span>, <span class="type">char</span>) = (<span class="number">500</span>, <span class="literal">false</span>, <span class="string">&#x27;A&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">i</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, tup.i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">error[E0609]: no field `i` on type `(i32, bool, char)`</span><br><span class="line"><span class="meta prompt_"> --&gt; </span><span class="language-bash">src/main.rs:4:24</span></span><br><span class="line">  |</span><br><span class="line">4 |     println!(&quot;&#123;&#125;&quot;, tup.i)</span><br><span class="line">  |                        ^</span><br></pre></td></tr></table></figure><p>å’Œ Python ç­‰å…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œå½“å…ƒç»„ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œç±»å‹å’Œå€¼å‡éœ€è¦åŠ é€—å·ï¼Œå½“æ²¡æœ‰é€—å·æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè®¤ä¸ºå…¶æ˜¯ä¸€ä¸ªæ ‡é‡ç±»å‹ï¼Œæ‹¬å·ä¼šè¢«è§†ä¸ºå¤šä½™ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">tup</span>: (<span class="type">i32</span>,) = (<span class="number">1</span>,);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, tup.<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•°ç»„"><a href="#æ•°ç»„" class="headerlink" title="æ•°ç»„"></a>æ•°ç»„</h2><p>æ•°ç»„å¯ä»¥å°†å¤šä¸ªå€¼æ”¾åˆ°ä¸€ä¸ªç±»å‹ä¸­ï¼Œä½†æ˜¯æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„ç±»å‹å¿…é¡»ç›¸åŒï¼Œå¹¶ä¸”é•¿åº¦å›ºå®šï¼Œä¸€æ—¦å£°æ˜ä¸å¯æ”¹å˜ã€‚</p><p>æ•°ç»„çš„ç±»å‹ä¸ºï¼š<code>[ç±»å‹;é•¿åº¦]</code></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span>: [<span class="type">i32</span>;<span class="number">5</span>] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†ä¸Šè¿°çš„å£°æ˜æ–¹å¼å¤–ï¼Œå¦‚æœæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ å€¼éƒ½ç›¸åŒï¼Œé‚£ä¹ˆå¯ä»¥å¿«é€Ÿå£°æ˜ä¸ºï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">// ç›¸å½“äº let a = [3, 3, 3, 3, 3]</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = [<span class="number">3</span>;<span class="number">5</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼äº Golangï¼Œè®¿é—®æ•°ç»„ä¸­çš„å…ƒç´ å€¼å¯ä»¥ä½¿ç”¨<strong>ç´¢å¼•æ³•</strong>ã€‚</p><p><strong>ç´¢å¼•è¶Šç•Œ</strong></p><p>å¦‚æœè®¿é—®çš„ç´¢å¼•è¶…å‡ºäº†æ•°ç»„çš„èŒƒå›´ï¼Œå¤„ç†æ–¹å¼å’Œ Golang ç±»ä¼¼ï¼Œä¹Ÿå°±æ˜¯ï¼š</p><ul><li>ç¼–è¯‘æ—¶ä¼šé€šè¿‡ï¼Œä½†æ˜¯ä¸æ˜¯ç»å¯¹çš„ï¼ŒRust ç¼–è¯‘å™¨æ— æ³•ç›´æ¥åˆ¤æ–­å‡ºæ˜¯å¦è¶Šç•Œç­‰è¾ƒå¤æ‚çš„æƒ…å†µ</li><li>è¿è¡Œæ—¶ä¼šæŠ¥é”™ï¼ŒåŒºåˆ«äº C å’Œ C++ ç­‰ï¼Œè™½ç„¶æ•°ç»„åœ¨å†…å­˜ä¸­ä¸ºè¿ç»­çš„åœ°å€ï¼Œä½†æ˜¯è¶Šç•Œçš„å†…å­˜ç©ºé—´ä¸å±äºè¯¥æ•°ç»„ï¼Œæ‰€ä»¥æ— æ³•è®¿é—®</li></ul>]]></content>
    
    
    <summary type="html">Rust ä¸­çš„æ ‡é‡ç±»å‹ä¸å¤åˆç±»å‹</summary>
    
    
    
    <category term="Programming" scheme="http://shenxianghong.github.io/categories/Programming/"/>
    
    
    <category term="Rust" scheme="http://shenxianghong.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Rust ã€å˜é‡ä¸å¯å˜æ€§</title>
    <link href="http://shenxianghong.github.io/2022/01/15/2022-01-15%20Rust%20%E5%8F%98%E9%87%8F%E4%B8%8E%E5%8F%AF%E5%8F%98%E6%80%A7/"/>
    <id>http://shenxianghong.github.io/2022/01/15/2022-01-15%20Rust%20%E5%8F%98%E9%87%8F%E4%B8%8E%E5%8F%AF%E5%8F%98%E6%80%A7/</id>
    <published>2022-01-14T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.160Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="150" style="border: 0px" src="/gallery/rust/logo.png"></div><hr><h1 id="å¯å˜æ€§"><a href="#å¯å˜æ€§" class="headerlink" title="å¯å˜æ€§"></a>å¯å˜æ€§</h1><ul><li>å£°æ˜å˜é‡ä½¿ç”¨ <code>let</code> å…³é”®å­—</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œå˜é‡æ˜¯ä¸å¯å˜çš„ï¼ˆImmutableï¼‰</li><li>å£°æ˜å˜é‡æ—¶ï¼Œåœ¨å˜é‡å‰é¢åŠ ä¸Š <code>mut</code>ï¼Œå°±å¯ä»¥ä½¿å˜é‡å¯å˜</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">foo</span> = <span class="number">1</span>;</span><br><span class="line">    foo = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;bar is &#123;&#125;&quot;</span>, foo)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="å˜é‡ä¸å¸¸é‡"><a href="#å˜é‡ä¸å¸¸é‡" class="headerlink" title="å˜é‡ä¸å¸¸é‡"></a>å˜é‡ä¸å¸¸é‡</h1><p>å¸¸é‡ï¼ˆconstantï¼‰åœ¨ç»‘å®šå€¼ä»¥åä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œä½†æ˜¯å®ƒä¸ä¸å¯å˜çš„å˜é‡æœ‰å¾ˆå¤šåŒºåˆ«ï¼š</p><ul><li>ä¸å¯ä»¥ä½¿ç”¨ mutï¼Œå¸¸é‡æ°¸è¿œéƒ½æ˜¯ä¸å¯å˜çš„</li><li>å£°æ˜å¸¸é‡ä½¿ç”¨ <code>const</code> å…³é”®å­—ï¼Œå®ƒçš„ç±»å‹å¿…é¡»è¢«æ ‡æ³¨</li><li>å¸¸é‡å¯ä»¥åœ¨ä»»ä½•ä½œç”¨åŸŸå†…è¿›è¡Œå£°æ˜ï¼ŒåŒ…æ‹¬å…¨å±€ä½œç”¨åŸŸ</li><li>å¸¸é‡åªå¯ä»¥ç»‘å®šåˆ°å¸¸é‡è¡¨è¾¾å¼ï¼Œæ— æ³•ç»‘å®šåˆ°å‡½æ•°çš„è°ƒç”¨ç»“æœæˆ–åªèƒ½åœ¨è¿è¡Œæ—¶æ‰èƒ½è®¡ç®—å‡ºçš„å€¼</li></ul><p>åœ¨ç¨‹åºè¿è¡ŒæœŸé—´ï¼Œå¸¸é‡åœ¨å…¶å£°æ˜çš„ä½œç”¨åŸŸå†…ä¸€ç›´æœ‰æ•ˆ</p><p>å‘½åè§„èŒƒï¼šRust é‡Œå¸¸é‡ä½¿ç”¨å…¨å¤§å†™å­—æ¯ï¼Œæ¯ä¸ªå•è¯ä¹‹é—´ç”¨ä¸‹åˆ’çº¿åˆ†å¼€ï¼Œä¾‹å¦‚ï¼šMAX_POINTS</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rust é‡Œå¯ä»¥é€šè¿‡ä¸‹åˆ’çº¿ï¼Œå¢å¼ºæ•°å­—çš„å¯è¯»æ€§</span></span><br><span class="line"><span class="keyword">const</span> MAX_POINTS: <span class="type">u32</span> = <span class="number">100_1000</span>;</span><br></pre></td></tr></table></figure><h1 id="Shadowï¼ˆéšè—ï¼‰"><a href="#Shadowï¼ˆéšè—ï¼‰" class="headerlink" title="Shadowï¼ˆéšè—ï¼‰"></a>Shadowï¼ˆéšè—ï¼‰</h1><p>Rust ä¸­å…è®¸ä½¿ç”¨åŒåçš„å˜é‡æ¥è¦†ç›–ä¹‹å‰çš„å˜é‡ï¼ŒåŒºåˆ«äº Golangï¼Œä¸ä»…å¯ä»¥ç”¨äºè¦†ç›–å€¼ï¼Œå¯ä»¥ç±»å‹ä¹Ÿå¯ä»¥ä¸ä¸€æ ·ã€‚ä¸€èˆ¬ç”¨äºåœ¨ä¸é¢å¤–å£°æ˜å˜é‡çš„åœºæ™¯ä¸‹ï¼Œè¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">x</span> = x + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x is &#123;&#125;&quot;</span>, x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>ä½¿ç”¨ mut å…³é”®å­—</em></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">x</span> = <span class="number">5</span>;</span><br><span class="line">    x = x + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;x is &#123;&#125;&quot;</span>, x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>shadow å’ŒæŠŠå˜é‡æ ‡è®°ä¸º mut æ˜¯ä¸ä¸€æ ·çš„</p><ul><li>å¦‚æœä¸ä½¿ç”¨ let å…³é”®å­—ï¼Œé‚£ä¹ˆé‡æ–°ç»™é mut çš„å˜é‡èµ‹å€¼ä¼šå¯¼è‡´ç¼–è¯‘æ—¶é”™è¯¯</li><li>ä½¿ç”¨ let å£°æ˜çš„åŒåæ–°å˜é‡ï¼Œä¹Ÿæ˜¯ä¸å¯å˜çš„</li><li>ä½¿ç”¨ let å£°æ˜çš„åŒåæ–°å˜é‡ï¼Œå®ƒçš„ç±»å‹å¯ä»¥ä¸ä¹‹å‰ä¸åŒ</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = <span class="string">&quot;Arthur Morgan&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">name</span> = name.<span class="title function_ invoke__">len</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">13</span><br></pre></td></tr></table></figure><p><em>ä½¿ç”¨ mut å…³é”®å­—</em></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">name</span> = <span class="string">&quot;Arthur Morgan&quot;</span>;</span><br><span class="line">    name = name.<span class="title function_ invoke__">len</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">error[E0308]: mismatched types</span><br><span class="line"><span class="meta prompt_"> --&gt; </span><span class="language-bash">src/main.rs:3:12</span></span><br><span class="line">  |</span><br><span class="line">3 |     name = name.len();</span><br><span class="line">  |            ^^^^^^^^^^ expected `&amp;str`, found `usize`</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Rust çš„å˜é‡ã€å¸¸é‡ä¸ shadow</summary>
    
    
    
    <category term="Programming" scheme="http://shenxianghong.github.io/categories/Programming/"/>
    
    
    <category term="Rust" scheme="http://shenxianghong.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æ“ä½œå·æ•°æ®ï¼ˆCSIï¼‰</title>
    <link href="http://shenxianghong.github.io/2022/01/10/2022-01-10%20Velero%20%E6%93%8D%E4%BD%9C%E5%8D%B7%E6%95%B0%E6%8D%AE%EF%BC%88CSI%EF%BC%89/"/>
    <id>http://shenxianghong.github.io/2022/01/10/2022-01-10%20Velero%20%E6%93%8D%E4%BD%9C%E5%8D%B7%E6%95%B0%E6%8D%AE%EF%BC%88CSI%EF%BC%89/</id>
    <published>2022-01-09T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.153Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><p>å¯ä»¥å°† CSI å¿«ç…§æ”¯æŒé›†æˆåˆ° Velero ä¸­ï¼Œä½¿ Velero èƒ½å¤Ÿä½¿ç”¨ Kubernetes CSI å¿«ç…§ API å¤‡ä»½å’Œæ¢å¤ CSI æ”¯æŒçš„å·ã€‚é€šè¿‡ CSI å¿«ç…§ APIï¼ŒVelero å¯ä»¥æ”¯æŒä»»ä½•å…·æœ‰ CSI å¿«ç…§çš„å·ï¼Œè€Œæ— éœ€ç‰¹å®šçš„ Velero æ’ä»¶ã€‚</p><p><em>åœ¨ Velero v1.6 ä¸­ï¼Œæ­¤ç‰¹æ€§ä¸º beta ç‰ˆæœ¬ï¼Œç›®å‰ 1.9+ ä¸ºç¨³å®šç‰ˆæœ¬</em></p><h1 id="å‰ç½®ä¾èµ–"><a href="#å‰ç½®ä¾èµ–" class="headerlink" title="å‰ç½®ä¾èµ–"></a>å‰ç½®ä¾èµ–</h1><ul><li>Kubernetes ç‰ˆæœ¬è‡³å°‘ä¸º 1.17</li><li>é›†ç¾¤ä¸­çš„ CSI å…·å¤‡å¿«ç…§èƒ½åŠ›ï¼Œå…¼å®¹ v1beta1 ç‰ˆæœ¬ API</li><li>è·¨é›†ç¾¤ CSI å·å¿«ç…§æ¢å¤æ—¶ï¼ŒCSI Driver å¿«ç…§ç±»åéœ€è¦ä¿æŒä¸€è‡´</li></ul><h1 id="éƒ¨ç½²-Veleroï¼Œå¼€å¯-CSI-ç‰¹æ€§"><a href="#éƒ¨ç½²-Veleroï¼Œå¼€å¯-CSI-ç‰¹æ€§" class="headerlink" title="éƒ¨ç½² Veleroï¼Œå¼€å¯ CSI ç‰¹æ€§"></a>éƒ¨ç½² Veleroï¼Œå¼€å¯ CSI ç‰¹æ€§</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero install \</span></span><br><span class="line"><span class="language-bash">     --provider aws \</span></span><br><span class="line"><span class="language-bash">     --features EnableCSI \</span></span><br><span class="line"><span class="language-bash">     --plugins velero/velero-plugin-for-aws:v1.0.0,velero/velero-plugin-for-csi:v0.1.0 \</span></span><br><span class="line"><span class="language-bash">     --bucket velero \</span></span><br><span class="line"><span class="language-bash">     --secret-file ./credentials-velero \</span></span><br><span class="line"><span class="language-bash">     --use-volume-snapshots=<span class="literal">false</span> \</span></span><br><span class="line"><span class="language-bash">     --backup-location-config region=minio,s3ForcePathStyle=<span class="string">&quot;true&quot;</span>,s3Url=http://minio.velero.svc:9000</span></span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜</strong></p><ul><li><code>--features</code> å¼€å¯ feature ç‰¹æ€§</li></ul><h1 id="æµç¨‹éªŒè¯"><a href="#æµç¨‹éªŒè¯" class="headerlink" title="æµç¨‹éªŒè¯"></a>æµç¨‹éªŒè¯</h1><p><strong>StorageClass</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">openebs-lvmsc</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">volgroup:</span> <span class="string">&quot;lvm_im&quot;</span></span><br><span class="line">  <span class="attr">fstype:</span> <span class="string">&quot;ext4&quot;</span></span><br><span class="line">  <span class="attr">maxVolumeSize:</span> <span class="string">&quot;5&quot;</span> </span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">local.csi.openebs.io</span>  </span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br></pre></td></tr></table></figure><p><strong>PersistentVolumeClaim</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">local-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">openebs-lvmsc</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">30Mi</span></span><br></pre></td></tr></table></figure><p><strong>Pod</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-local-im</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">perfrunner</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.27</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true ;do sleep 50; done&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/datadir</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fio-vol</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fio-vol</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">local-pvc</span></span><br></pre></td></tr></table></figure><p><strong>æ“ä½œéªŒè¯</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å†™å…¥æµ‹è¯•æ•°æ®</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it pod-local-im <span class="built_in">ls</span> /datadir</span></span><br><span class="line">data        lost+found</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¤‡ä»½ä»»åŠ¡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup create default --include-namespaces default</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹å¿«ç…§ä¿¡æ¯ï¼Œå‘ç°æ­¤æ—¶ Velero å·²ç»è°ƒç”¨ CSI åˆ›å»ºäº† volumesnapshotï¼Œå¹¶ç”Ÿæˆäº† volumesnapshotcontentï¼Œå¹¶ä¸”æŸ¥çœ‹ volumesnapshot çš„çŠ¶æ€ readyToUse ä¸º True</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get volumesnapshot</span></span><br><span class="line">NAMESPACE   NAME                     READYTOUSE   SOURCEPVC   SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS         SNAPSHOTCONTENT                                    CREATIONTIME   AGE</span><br><span class="line">default     velero-local-pvc-bdbw8   true         local-pvc                           30Mi          csi-local-snapclass   snapcontent-93903201-f07a-405c-92d9-2c0b6bafd6a1   117s           118s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get volumesnapshotcontent</span></span><br><span class="line">NAME                                               READYTOUSE   RESTORESIZE   DELETIONPOLICY   DRIVER                 VOLUMESNAPSHOTCLASS   VOLUMESNAPSHOT           VOLUMESNAPSHOTNAMESPACE   AGE</span><br><span class="line">snapcontent-93903201-f07a-405c-92d9-2c0b6bafd6a1   true         31457280      Delete           local.csi.openebs.io   csi-local-snapclass   velero-local-pvc-bdbw8   default                   2m38s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¨¡æ‹Ÿæ•…éšœ</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete -f pod.yaml &amp;&amp; kubectl delete -f pvc.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæ¢å¤ä»»åŠ¡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore create --from-backup default</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get volumesnapshotcontent</span> </span><br><span class="line">NAME                                               READYTOUSE   RESTORESIZE   DELETIONPOLICY   DRIVER                 VOLUMESNAPSHOTCLASS   VOLUMESNAPSHOT           VOLUMESNAPSHOTNAMESPACE   AGE</span><br><span class="line">snapcontent-93903201-f07a-405c-92d9-2c0b6bafd6a1   true         31457280      Delete           local.csi.openebs.io   csi-local-snapclass   velero-local-pvc-bdbw8   default                   3m31s</span><br><span class="line">velero-velero-local-pvc-bdbw8-z9t2f                true         0             Delete           local.csi.openebs.io                         velero-local-pvc-bdbw8   default                   2m3s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯ä»¥çœ‹åˆ°ï¼ŒVelero è°ƒç”¨ CSI Driver åŸºäºä¹‹å‰çš„ volumesnapshot æ¢å¤å‡ºæ¥äº†ä¸€ä¸ª PVC</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pvc</span></span><br><span class="line">NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    AGE</span><br><span class="line">local-pvc   Bound    pvc-f034e865-340a-40cf-9381-3b95b1bd2f1f   30Mi       RWO            openebs-lvmsc   4m16s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pvc -o yaml</span></span><br><span class="line">&lt;skip&gt;</span><br><span class="line">spec:</span><br><span class="line">    accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">    dataSource:</span><br><span class="line">      apiGroup: snapshot.storage.k8s.io</span><br><span class="line">      kind: VolumeSnapshot</span><br><span class="line">      name: velero-local-pvc-bdbw8</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        storage: 30Mi</span><br><span class="line">    storageClassName: openebs-lvmsc</span><br><span class="line">    volumeMode: Filesystem</span><br><span class="line">    volumeName: pvc-f034e865-340a-40cf-9381-3b95b1bd2f1f</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ•°æ®å·²ç»ä»å¿«ç…§æ¢å¤</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it pod-local-im <span class="built_in">ls</span> /datadir</span></span><br><span class="line">data        lost+found</span><br></pre></td></tr></table></figure><h1 id="æµç¨‹èµ°è¯»"><a href="#æµç¨‹èµ°è¯»" class="headerlink" title="æµç¨‹èµ°è¯»"></a>æµç¨‹èµ°è¯»</h1><p>Velero çš„ CSI æ”¯æŒä¸ä¾èµ– Velero VolumeSnapshotter æ’ä»¶ã€‚ç›¸åï¼ŒVelero é‡‡ç”¨ä¸€ç»„ BackupItemAction æ’ä»¶ç”¨äºåœ¨æ“ä½œ PersistentVolumeClaims ä¹‹å‰è¿›è¡Œä¸€äº›é¢å¤–çš„åŠ¨ä½œã€‚</p><p>å¤‡ä»½æ—¶ï¼Œå½“ BackupItemAction å‘ç°æœ‰ä¸€ä¸ª PersistentVolumeClaims æŒ‡å‘ç”± CSI Driver åˆ›å»ºçš„ PersistentVolume æ—¶ï¼Œå®ƒå°†è·å–å…·æœ‰ç›¸åŒ Driver åç§°çš„ VolumeSnapshotClass æ¥åˆ›å»ºä»¥ PersistentVolumeClaim ä¸ºæºçš„ CSI VolumeSnapshot å¯¹è±¡ï¼ŒVolumeSnapshot å’Œ PersistentVolumeClaim ä½äºåŒä¸€å‘½åç©ºé—´ä¸­ã€‚</p><p>æ¥ç€ï¼ŒCSI external-snapshotter watch åˆ° VolumeSnapshot ä¹‹ååˆ›å»ºä¸€ä¸ª VolumeSnapshotContent å¯¹è±¡ï¼Œå®ƒå°†æŒ‡å‘å­˜å‚¨ç³»ç»Ÿä¸­å®é™…çš„ã€åŸºäºç£ç›˜çš„å¿«ç…§ã€‚ external-snapshotter ä¼šè°ƒç”¨ CSI Driver çš„ snapshot æ–¹æ³•ï¼ŒDriver ä¼šè°ƒç”¨å­˜å‚¨ç³»ç»Ÿçš„ API ç”Ÿæˆå¿«ç…§ã€‚ä¸€æ—¦ç”Ÿæˆ ID å¹¶ä¸”å­˜å‚¨ç³»ç»Ÿå°†å¿«ç…§æ ‡è®°ä¸ºå¯ç”¨äºæ¢å¤ï¼ŒVolumeSnapshotContent å¯¹è±¡å°†ä½¿ç”¨ status.snapshotHandle è¿›è¡Œæ›´æ–°ï¼Œå¹¶ä¸”è®¾ç½®status.readyToUse å­—æ®µä¸º trueã€‚</p><p>Velero å°†åœ¨å¤‡ä»½ tarball ä¸­åŒ…å«ç”Ÿæˆçš„ VolumeSnapshot å’Œ VolumeSnapshotContent å¯¹è±¡ï¼Œå¹¶å°† JSON æ–‡ä»¶ä¸­çš„æ‰€æœ‰ VolumeSnapshots å’Œ VolumeSnapshotContents å¯¹è±¡ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ç³»ç»Ÿã€‚å½“ Velero å°†å¤‡ä»½åŒæ­¥åˆ°æ–°é›†ç¾¤æ—¶ï¼ŒVolumeSnapshotContent å¯¹è±¡ä¹Ÿå°†åŒæ­¥åˆ°é›†ç¾¤ä¸­ï¼Œä»¥ä¾¿ Velero å¯ä»¥é€‚å½“åœ°ç®¡ç†å¤‡ä»½è¿‡æœŸã€‚</p><p>VolumeSnapshotClass çš„ DeletionPolicy è®¾ç½®ä¸º Retain æ—¶ï¼ŒVelero å¤‡ä»½çš„ç”Ÿå‘½å‘¨æœŸå†…ä¿ç•™å­˜å‚¨ç³»ç»Ÿä¸­çš„å·å¿«ç…§ï¼Œå¹¶é˜²æ­¢åœ¨å‘ç”Ÿç¾éš¾æ—¶åˆ é™¤å­˜å‚¨ç³»ç»Ÿä¸­çš„å·å¿«ç…§ï¼Œå…¶ä¸­å‘½åç©ºé—´ä¸VolumeSnapshot å¯¹è±¡å¯èƒ½ä¼šä¸¢å¤±ã€‚</p><p>å½“ Velero å¤‡ä»½åˆ°æœŸæ—¶ï¼ŒVolumeSnapshot å¯¹è±¡å°†è¢«åˆ é™¤ï¼ŒVolumeSnapshotContent å¯¹è±¡çš„ DeletionPolicy å°†æ›´æ–° Deleteï¼Œä»¥é‡Šæ”¾å­˜å‚¨ç³»ç»Ÿä¸Šçš„ç©ºé—´ã€‚</p>]]></content>
    
    
    <summary type="html">å€ŸåŠ© CSI å®ç°å¯¹ Kubernetes é›†ç¾¤ä¸­å®¹å™¨å·æ•°æ®çš„å¤‡ä»½ä¸æ¢å¤</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Rust ã€å¿«é€Ÿå¼€å§‹ â€” Cargo</title>
    <link href="http://shenxianghong.github.io/2022/01/09/2022-01-09%20Rust%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B%20-%20Cargo/"/>
    <id>http://shenxianghong.github.io/2022/01/09/2022-01-09%20Rust%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B%20-%20Cargo/</id>
    <published>2022-01-08T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.128Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="150" style="border: 0px" src="/gallery/rust/logo.png"></div><hr><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Cargo æ˜¯ Rust çš„æ„å»ºç³»ç»Ÿå’ŒåŒ…ç®¡ç†å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æ„å»ºä»£ç ã€ä¸‹è½½ä¾èµ–åº“ã€æ„å»ºä¾èµ–åº“ç­‰ã€‚</p><p>å®‰è£… Rust çš„æ—¶å€™ä¼šé»˜è®¤å®‰è£… Cargoï¼Œå¯ä»¥é€šè¿‡ <code>cargo --version</code> åˆ¤æ–­æ˜¯å¦å®‰è£…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo --version</span></span><br><span class="line">cargo 1.57.0 (b2e52d7ca 2021-10-21)</span><br></pre></td></tr></table></figure><h1 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h1><p>ä½¿ç”¨ <code>cargo new &lt;path&gt;</code> åˆ›å»ºä¸€ä¸ªå·¥ç¨‹é¡¹ç›®ï¼Œå·¥ç¨‹é¡¹ç›®åä¸º <code>&lt;path&gt;</code>ã€‚åŒæ—¶ï¼Œä¹Ÿä¼šåˆ›å»ºä¸€ä¸ª <code>&lt;path&gt;</code> çš„ç›®å½•ï¼Œåœ¨ä¸æ˜¾ç¤ºå£°æ˜ vcs çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä¼šåŒæ—¶åˆ›å»º git ä»“åº“ï¼Œå¯ä»¥é€šè¿‡ <code>cargo new &lt;path&gt; --vcs xxx</code> æŒ‡å®šå…¶ä»– vcsï¼Œæˆ–è€…é€šè¿‡ <code>--vcs none</code> ä¸åˆ›å»º vcsã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo new hello-world</span></span><br><span class="line">     Created binary (application) `hello-world` package</span><br><span class="line">     </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree -a hello-world</span></span><br><span class="line">hello-world</span><br><span class="line">â”œâ”€â”€ .git</span><br><span class="line">â”œâ”€â”€ .gitignore</span><br><span class="line">â”œâ”€â”€ Cargo.toml</span><br><span class="line">â””â”€â”€ src</span><br><span class="line">    â””â”€â”€ main.rs</span><br></pre></td></tr></table></figure><ul><li>src ç›®å½•ç”¨äºå­˜æ”¾æºä»£ç </li><li>Cargo.toml  æ˜¯é¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œç±»ä¼¼äº Golang çš„ go.mod æ–‡ä»¶</li><li>.gitignore ä¸­åŒ…å«å¿½ç•¥ &#x2F;target çš„ä¿¡æ¯</li></ul><h3 id="Cargo-toml"><a href="#Cargo-toml" class="headerlink" title="Cargo.toml"></a>Cargo.toml</h3><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;hello-world&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br></pre></td></tr></table></figure><ul><li>package ç”¨äºæè¿°é¡¹ç›®ä¿¡æ¯çš„<ul><li>name â€” é¡¹ç›®å</li><li>version â€” é¡¹ç›®ç‰ˆæœ¬</li><li>authors â€” å¼€å‘è€…æ˜µç§°å’Œé‚®ç®±ä¿¡æ¯ï¼Œ<em>å¦‚æœç³»ç»Ÿä¸­å­˜åœ¨</em></li><li>edtion â€” ä½¿ç”¨çš„ Rust ç‰ˆæœ¬</li></ul></li><li>dependecies ç”¨äºæè¿°é¡¹ç›®çš„ä¾èµ–é¡¹ï¼Œåœ¨ Rust ä¸­ä»£ç çš„åŒ…ï¼ˆåº“ï¼‰ç§°ä¸º <code>crate</code></li></ul><h3 id="è½¬æ¢ä¸º-Cargo"><a href="#è½¬æ¢ä¸º-Cargo" class="headerlink" title="è½¬æ¢ä¸º Cargo"></a>è½¬æ¢ä¸º Cargo</h3><p>å¦‚æœåˆ›å»ºé¡¹ç›®æ—¶æ²¡æœ‰ä½¿ç”¨ Cargoï¼Œä¹Ÿå¯ä»¥æŠŠé¡¹ç›®è½¬åŒ–ä¸ºä½¿ç”¨ Cargoï¼Œå…·ä½“åšæ³•ä¸ºï¼šæŠŠæºä»£ç ç§»åˆ° src ç›®å½•ä¸‹ï¼Œåˆ›å»º Cargo.toml å¹¶å¡«å†™ç›¸åº”çš„é…ç½®ã€‚</p><h1 id="æ„å»ºé¡¹ç›®"><a href="#æ„å»ºé¡¹ç›®" class="headerlink" title="æ„å»ºé¡¹ç›®"></a>æ„å»ºé¡¹ç›®</h1><p>æ»¡è¶³ Cargo è§„èŒƒçš„é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨ <code>cargo build</code> æ¥æ„å»ºé¡¹ç›®ã€‚</p><h2 id="cargo-build"><a href="#cargo-build" class="headerlink" title="cargo build"></a>cargo build</h2><h3 id="dev"><a href="#dev" class="headerlink" title="dev"></a>dev</h3><p><strong>unoptimized + debuginfo</strong></p><p>åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>cargo build</code> ä¼šå°†å¯æ‰§è¡Œæ–‡ä»¶ç¼–è¯‘åœ¨ <code>target/debug/hello-world</code> ç›®å½•ä¸‹ï¼Œç¬¬ä¸€æ¬¡æ„å»ºæ—¶ï¼Œä¼šåœ¨é¡¶å±‚ç›®å½•ç”Ÿæˆ cargo.lock æ–‡ä»¶ï¼Œè´Ÿè´£è¿½è¸ªé¡¹ç›®ä¾èµ–çš„ç²¾ç¡®ç‰ˆæœ¬ï¼Œç±»ä¼¼äº Golang çš„ go.sum æ–‡ä»¶ã€‚</p><p><em>cargo.lock</em></p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file is automatically @generated by Cargo.</span></span><br><span class="line"><span class="comment"># It is not intended for manual editing.</span></span><br><span class="line"><span class="attr">version</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[package]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;hello-world&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo build</span></span><br><span class="line">   Compiling hello-world v0.1.0 (/Users/shenxianghong/Documents/Project/Rustaceans/hello-world)</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 2.21s</span><br></pre></td></tr></table></figure><h3 id="release"><a href="#release" class="headerlink" title="release"></a>release</h3><p><strong>optimized</strong></p><p>é»˜è®¤æƒ…å†µï¼Œ<code>cargo build</code> é€‚ç”¨äºå¼€å‘é˜¶æ®µçš„å¸¸è§„ç¼–è¯‘ï¼Œåœ¨æœ€ç»ˆå‘å¸ƒæ„å»ºæ—¶ï¼Œå¯ä»¥é€šè¿‡ <code>cargo build --release</code> å‘å¸ƒï¼Œè¿™æ ·åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šè¿›è¡Œä¼˜åŒ–ï¼Œä»£ç è¿è¡Œçš„æ›´å¿«ï¼Œä½†æ˜¯ç¼–è¯‘çš„æ—¶é—´ä¹Ÿæ›´é•¿ï¼ŒåŒæ—¶ï¼Œä¼šåœ¨ <code>target/release</code> è€Œä¸æ˜¯ <code>target/debug</code> ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo build --release</span></span><br><span class="line">   Compiling hello-world v0.1.0 (/Users/shenxianghong/Documents/Project/Rustaceans/hello-world)</span><br><span class="line">    Finished release [optimized] target(s) in 0.38s</span><br></pre></td></tr></table></figure><h2 id="cargo-run"><a href="#cargo-run" class="headerlink" title="cargo run"></a>cargo run</h2><p><code>cargo run</code> æœ¬è´¨ä¸Šå°±æ˜¯ç¼–è¯‘ä»£ç  + æ‰§è¡Œç»“æœï¼Œå¦‚æœä¹‹å‰ç¼–è¯‘æˆåŠŸè¿‡ï¼Œä¸”æºç æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆå°±ä¼šç›´æ¥è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">   Compiling hello-world v0.1.0 (/Users/shenxianghong/Documents/Project/Rustaceans/hello-world)</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.66s</span><br><span class="line">     Running `target/debug/hello-world`</span><br><span class="line">Hello, world!</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.00s</span><br><span class="line">     Running `target/debug/hello-world`</span><br><span class="line">Hello, world!</span><br></pre></td></tr></table></figure><h2 id="cargo-check"><a href="#cargo-check" class="headerlink" title="cargo check"></a>cargo check</h2><p><code>cargo check</code> ç”¨äºæ£€æŸ¥ä»£ç ï¼Œç¡®ä¿èƒ½é€šè¿‡ç¼–è¯‘ï¼Œä½†æ˜¯ä¸ä¼šå®è´¨çš„è¿›è¡Œç¼–è¯‘ï¼Œ<code>cargo check</code> è¿è¡Œé€Ÿåº¦æ¯” <code>cargo build</code> å¿«å¾—å¤šï¼Œå¯ä»¥ç”¨äºå¼€å‘é˜¶æ®µåå¤æ£€æŸ¥ï¼Œæé«˜æ•ˆç‡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo check</span></span><br><span class="line">    Checking hello-world v0.1.0 (/Users/shenxianghong/Documents/Project/Rustaceans/hello-world)</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.06s</span><br></pre></td></tr></table></figure><p>å½“æ£€æŸ¥æœ‰é”™è¯¯æ—¶ï¼Œä¼šæŠ¥é”™æç¤º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo check</span></span><br><span class="line">    Checking hello-world v0.1.0 (/Users/shenxianghong/Documents/Project/Rustaceans/hello-world)</span><br><span class="line">error: expected one of `-&gt;`, `;`, `where`, or `&#123;`, found `err`</span><br><span class="line"><span class="meta prompt_"> --&gt; </span><span class="language-bash">src/main.rs:1:11</span></span><br><span class="line">  |</span><br><span class="line">1 | fn main() err &#123;</span><br><span class="line">  |           ^^^ expected one of `-&gt;`, `;`, `where`, or `&#123;`</span><br><span class="line"></span><br><span class="line">error: could not compile `hello-world` due to previous error</span><br></pre></td></tr></table></figure><h1 id="å›½å†…æºåŠ é€Ÿ"><a href="#å›½å†…æºåŠ é€Ÿ" class="headerlink" title="å›½å†…æºåŠ é€Ÿ"></a>å›½å†…æºåŠ é€Ÿ</h1><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œcargo è·å–åŒ…ä¾èµ–ç­‰é€šè¿‡ crate.ioï¼Œç”±äºç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥å°†å…¶æ›¿æ¢æˆå›½å†…çš„ cargo æºã€‚</p><p><em>~&#x2F;.cargo&#x2F;config</em></p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[source.crates-io]</span></span><br><span class="line"><span class="attr">registry</span> = <span class="string">&quot;https://github.com/rust-lang/crates.io-index&quot;</span></span><br><span class="line"><span class="attr">replace-with</span> = <span class="string">&#x27;sjtu&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¸…åå¤§å­¦</span></span><br><span class="line"><span class="section">[source.tuna]</span></span><br><span class="line"><span class="attr">registry</span> = <span class="string">&quot;https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸­å›½ç§‘å­¦æŠ€æœ¯å¤§å­¦</span></span><br><span class="line"><span class="section">[source.ustc]</span></span><br><span class="line"><span class="attr">registry</span> = <span class="string">&quot;git://mirrors.ustc.edu.cn/crates.io-index&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šæµ·äº¤é€šå¤§å­¦</span></span><br><span class="line"><span class="section">[source.sjtu]</span></span><br><span class="line"><span class="attr">registry</span> = <span class="string">&quot;https://mirrors.sjtug.sjtu.edu.cn/git/crates.io-index&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rustcc ç¤¾åŒº</span></span><br><span class="line"><span class="section">[source.rustcc]</span></span><br><span class="line"><span class="attr">registry</span> = <span class="string">&quot;git://crates.rustcc.cn/crates.io-index&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Rust åŒ…ç®¡ç†å·¥å…· Cargo çš„ä»‹ç»ä¸ä½¿ç”¨</summary>
    
    
    
    <category term="Programming" scheme="http://shenxianghong.github.io/categories/Programming/"/>
    
    
    <category term="Rust" scheme="http://shenxianghong.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Rust ã€æ¦‚å¿µåˆè¯†</title>
    <link href="http://shenxianghong.github.io/2022/01/08/2022-01-08%20Rust%20%E6%A6%82%E5%BF%B5%E5%88%9D%E8%AF%86/"/>
    <id>http://shenxianghong.github.io/2022/01/08/2022-01-08%20Rust%20%E6%A6%82%E5%BF%B5%E5%88%9D%E8%AF%86/</id>
    <published>2022-01-07T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.127Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="150" style="border: 0px" src="/gallery/rust/logo.png"></div><hr><h1 id="å•æ¬¡çŒœæµ‹"><a href="#å•æ¬¡çŒœæµ‹" class="headerlink" title="å•æ¬¡çŒœæµ‹"></a>å•æ¬¡çŒœæµ‹</h1><p><em>è·å–ç”¨æˆ·çš„å‘½ä»¤è¡Œè¾“å…¥</em></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;guess a number&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guess</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> guess).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;error reading line&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;your number is &#123;&#125;&quot;</span>, guess);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åº“çš„å¼•ç”¨"><a href="#åº“çš„å¼•ç”¨" class="headerlink" title="åº“çš„å¼•ç”¨"></a>åº“çš„å¼•ç”¨</h2><p>é»˜è®¤æƒ…å†µä¸‹ Rust ä¼šå°† <code>prelude</code> æ¨¡å—ï¼ˆé¢„å¯¼å…¥æ¨¡å—ï¼‰çš„å†…å®¹å¯¼å…¥åˆ°æ¯ä¸ªç¨‹åºçš„ä½œç”¨åŸŸä¸­ï¼Œå¦‚æœè¦ä½¿ç”¨çš„åº“ä¸ä½äº <code>prelude</code> æ¨¡å—ä¸­ï¼Œåˆ™éœ€è¦é€šè¿‡ <code>use</code> å…³é”®å­—æ˜¾ç¤ºçš„å¯¼å…¥ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œè·å–ç”¨æˆ·å‘½ä»¤è¡Œè¾“å…¥çš„åº“ä¸º io åº“ï¼Œè€Œ io åº“ä½äº Rust æ ‡å‡†åº“ std ä¸­ï¼Œå¯¼å…¥æ–¹æ³•ä¸º <code>use std::io;</code> </p><h2 id="å˜é‡çš„ä¸å¯å˜"><a href="#å˜é‡çš„ä¸å¯å˜" class="headerlink" title="å˜é‡çš„ä¸å¯å˜"></a>å˜é‡çš„ä¸å¯å˜</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒRust çš„å˜é‡å‡ä¸ºä¸å¯å˜çš„ï¼ˆimmutableï¼‰ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">foo</span> = <span class="number">1</span>;</span><br><span class="line">    foo = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;foo is &#123;&#125;&quot;</span>, foo)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">error[E0384]: cannot assign twice to immutable variable `foo`</span><br><span class="line"><span class="meta prompt_"> --&gt; </span><span class="language-bash">src/main.rs:3:5</span></span><br><span class="line">  |</span><br><span class="line">2 |     let foo = 1;</span><br><span class="line">  |         ---</span><br><span class="line">  |         |</span><br><span class="line">  |         first assignment to `foo`</span><br><span class="line">  |         help: consider making this binding mutable: `mut foo`</span><br><span class="line">3 |     foo = 2;</span><br><span class="line">  |     ^^^^^^^ cannot assign twice to immutable variable</span><br></pre></td></tr></table></figure><p>å¦‚æœè¦å£°æ˜ä¸€ä¸ªå¯å˜çš„å˜é‡ï¼Œé‚£ä¹ˆéœ€è¦åœ¨å˜é‡å‰åŠ ä¸Š <code>mut</code> å…³é”®å­—</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">foo</span> = <span class="number">1</span>;</span><br><span class="line">    foo = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;bar is &#123;&#125;&quot;</span>, foo)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">bar is 2</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¼•ç”¨é»˜è®¤ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œè€Œ <code>read_line()</code> æ–¹æ³•ä¼šæ ¹æ®ç”¨æˆ·çš„è¾“å…¥ä¿®æ”¹ä¼ å…¥çš„å˜é‡ï¼Œå› æ­¤ï¼Œä¹Ÿè¦å¯¹å…¥å‚å£°æ˜å¯å˜ã€‚</p><h2 id="å…³è”å‡½æ•°"><a href="#å…³è”å‡½æ•°" class="headerlink" title="å…³è”å‡½æ•°"></a>å…³è”å‡½æ•°</h2><p><code>String::new()</code> ä¼šè¿”å›å­—ç¬¦ä¸²çš„ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå†…éƒ¨æ˜¯ utf-8 ç¼–ç çš„ï¼Œä¸­é—´çš„ä¸¤ä¸ªå†’å·è¡¨ç¤º <code>new()</code> æ˜¯ <code>String</code> è¿™ä¸ªç±»å‹çš„å…³è”å‡½æ•°ï¼Œå…³è”å‡½æ•°è¡¨ç¤ºé’ˆå¯¹è¿™ä¸ªç±»å‹æœ¬èº«æ¥å®ç°çš„ï¼Œä¸æ˜¯é’ˆå¯¹è¿™ä¸ªç±»å‹çš„æŸä¸ªç‰¹å®šç¤ºä¾‹æ¥å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯ <code>new()</code> ä¸ä¼šä½œç”¨äº guess å®ä¾‹ï¼Œç±»ä¼¼äº Golang ä¸­çš„ç»“æ„ä½“æ–¹æ³•ã€‚</p><p>åŒç†ï¼Œ<code>io::stdin()</code> ä¼šè¿”å›ä¸€ä¸ª Stdin ç±»å‹çš„å¥æŸ„ã€‚</p><h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>Rust ä¸­æœ‰å¾ˆå¤šç§ Result ç±»å‹ï¼Œå³æœ‰é€šç”¨æ³›å‹çš„ Resultï¼Œä¹Ÿæœ‰é’ˆå¯¹ç‰¹å®šç±»å‹çš„ Resultï¼Œä¾‹å¦‚ <code>io::Result</code> ï¼ŒResult å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªå€¼ï¼Œä¸€ä¸ªæ˜¯ <code>Ok</code> ä¸€ä¸ªæ˜¯ <code>Err</code> ï¼Œ<code>expect()</code> æ–¹æ³•ç”¨ä½œé”™è¯¯åˆ¤æ–­ï¼Œå¦‚æœè¿”å›çš„å€¼ä¸º Errï¼Œé‚£ä¹ˆä¼šä¸­æ–­ç¨‹åºå¹¶å°†å…¥å‚è¾“å‡ºã€‚</p><h2 id="å ä½ç¬¦"><a href="#å ä½ç¬¦" class="headerlink" title="å ä½ç¬¦"></a>å ä½ç¬¦</h2><p>åŒºåˆ«äº Golangï¼Œ<code>println!()</code> ä¸­å¦‚æœæƒ³è¾“å‡ºå˜é‡ï¼Œé‚£ä¹ˆå¿…é¡»è¦æœ‰å ä½ç¬¦ï¼Œå³ <code>&#123;&#125;</code>ã€‚</p><h1 id="ç¥ç§˜æ•°å­—"><a href="#ç¥ç§˜æ•°å­—" class="headerlink" title="ç¥ç§˜æ•°å­—"></a>ç¥ç§˜æ•°å­—</h1><p><em>å¼•å…¥ç¬¬ä¸‰æ–¹ rand åŒ…ï¼Œå®ç°éšæœºæ•°çš„ç”Ÿæˆ</em></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"><span class="keyword">use</span> rand::Rng;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">secret_number</span> = rand::<span class="title function_ invoke__">thread_rng</span>().<span class="title function_ invoke__">gen_range</span>(<span class="number">1</span>, <span class="number">101</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;secret_number is &#123;&#125;&quot;</span>, secret_number);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;guess a number&quot;</span>)</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guess</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> guess).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;error reading line&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;your number is &#123;&#125;&quot;</span>, guess);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…"><a href="#ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…" class="headerlink" title="ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…"></a>ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…</h2><p>åœ¨ <code>Cargo.toml</code> çš„ <code>dependencies</code> æ–°å¢ <code>package = version</code> ä¿¡æ¯ä¸ºé¡¹ç›®æ–°å¢ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…ã€‚</p><p><code>^</code> è¡¨ç¤ºä»»ä½•ä¸€ä¸ªä¸æŒ‡å®šç‰ˆæœ¬ api å…¼å®¹çš„åº“å‡å¯ä»¥ï¼Œå¹¶ä¸”è¯¥æ ‡è¯†ä¸ºé»˜è®¤ã€‚</p><p><em>Cargo.toml</em></p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;hello-world&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line"><span class="attr">edition</span> = <span class="string">&quot;2021&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">rand</span> = <span class="string">&quot;^0.3.14&quot;</span></span><br></pre></td></tr></table></figure><p>é¦–æ¬¡æ„å»ºæ—¶ï¼Œcargo ä¼šæ›´æ–°æºçš„ indexï¼Œæ ¹æ® <code>Cargo.toml</code> çš„å†…å®¹ä¸‹è½½ä¾èµ–ï¼Œå°†ä¸‹è½½çš„ä¾èµ–ä¿¡æ¯å†™å…¥ <code>Cargo.lock</code> ä¸­ï¼Œå¹¶å®Œæˆæºç å’Œä¾èµ–çš„æ„å»ºï¼Œå½“åç»­æºç æˆ–è€…å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä»…ä¼šé‡æ–°æ„å»ºå˜åŒ–éƒ¨åˆ†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo build</span></span><br><span class="line">  Updating crates.io index</span><br><span class="line">  Downloaded rand v0.3.23</span><br><span class="line">  Downloaded rand v0.4.6</span><br><span class="line">  Downloaded 2 crates (87.7 KB) in 0.77s</span><br><span class="line">   Compiling libc v0.2.112</span><br><span class="line">   Compiling rand v0.4.6</span><br><span class="line">   Compiling rand v0.3.23</span><br><span class="line">   Compiling hello-world v0.1.0 (/Users/shenxianghong/Documents/Project/Rustaceans/hello-world)</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 5.06s</span><br></pre></td></tr></table></figure><p><em>Cargo.lock</em></p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;skip&gt;</span><br><span class="line"><span class="section">[[package]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;libc&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.2.112&quot;</span></span><br><span class="line"><span class="attr">source</span> = <span class="string">&quot;registry+https://github.com/rust-lang/crates.io-index&quot;</span></span><br><span class="line"><span class="attr">checksum</span> = <span class="string">&quot;1b03d17f364a3a042d5e5d46b053bbbf82c92c9430c592dd4c064dc6ee997125&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[package]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;rand&quot;</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">&quot;0.3.23&quot;</span></span><br><span class="line"><span class="attr">source</span> = <span class="string">&quot;registry+https://github.com/rust-lang/crates.io-index&quot;</span></span><br><span class="line"><span class="attr">checksum</span> = <span class="string">&quot;64ac302d8f83c0c1974bf758f6b041c6c8ada916fbb44a609158ca8b064cc76c&quot;</span></span><br><span class="line"><span class="attr">dependencies</span> = [</span><br><span class="line"> <span class="string">&quot;libc&quot;</span>,</span><br><span class="line"> <span class="string">&quot;rand 0.4.6&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>å½“å¯¹ä¾èµ–è·¨å¤§ç‰ˆæœ¬ç‰ˆæœ¬æ›´æ–°æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®æ”¹ <code> Cargo.toml</code> ï¼Œé™¤äº†å¯ä»¥é€šè¿‡é‡æ–°æ„å»ºçš„æ–¹å¼ï¼Œè¿˜å¯ä»¥é€šè¿‡ <code>cargo update</code> é‡æ–°ç»´æŠ¤ä¾èµ–å…³ç³»ã€‚</p><p><em>rand åŒ…å‡çº§è‡³ 0.7</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo update</span></span><br><span class="line">    Updating crates.io index</span><br><span class="line">    Removing cfg-if v1.0.0</span><br><span class="line">      Adding fuchsia-cprng v0.1.1</span><br><span class="line">    Removing getrandom v0.1.16</span><br><span class="line">    Removing ppv-lite86 v0.2.16</span><br><span class="line">    Removing rand v0.7.3</span><br><span class="line">      Adding rand v0.3.23</span><br><span class="line">      Adding rand v0.4.6</span><br><span class="line">    Removing rand_chacha v0.2.2</span><br><span class="line">    Removing rand_core v0.5.1</span><br><span class="line">      Adding rand_core v0.3.1</span><br><span class="line">      Adding rand_core v0.4.2</span><br><span class="line">    Removing rand_hc v0.2.0</span><br><span class="line">      Adding rdrand v0.4.0</span><br><span class="line">    Removing wasi v0.9.0+wasi-snapshot-preview1</span><br><span class="line">      Adding winapi v0.3.9</span><br><span class="line">      Adding winapi-i686-pc-windows-gnu v0.4.0</span><br><span class="line">      Adding winapi-x86_64-pc-windows-gnu v0.4.0</span><br><span class="line">shenxianghong@Corgi hello-world % cargo update</span><br><span class="line">    Updating crates.io index</span><br><span class="line">      Adding cfg-if v1.0.0</span><br><span class="line">    Removing fuchsia-cprng v0.1.1</span><br><span class="line">      Adding getrandom v0.1.16</span><br><span class="line">      Adding ppv-lite86 v0.2.16</span><br><span class="line">    Removing rand v0.3.23</span><br><span class="line">    Removing rand v0.4.6</span><br><span class="line">      Adding rand v0.7.3</span><br><span class="line">      Adding rand_chacha v0.2.2</span><br><span class="line">    Removing rand_core v0.3.1</span><br><span class="line">    Removing rand_core v0.4.2</span><br><span class="line">      Adding rand_core v0.5.1</span><br><span class="line">      Adding rand_hc v0.2.0</span><br><span class="line">    Removing rdrand v0.4.0</span><br><span class="line">      Adding wasi v0.9.0+wasi-snapshot-preview1</span><br><span class="line">    Removing winapi v0.3.9</span><br><span class="line">    Removing winapi-i686-pc-windows-gnu v0.4.0</span><br><span class="line">    Removing winapi-x86_64-pc-windows-gnu v0.4.0</span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>cargo update</code> è¿˜å¯ä»¥ç”¨äºä¾èµ–åŒ…çš„å°ç‰ˆæœ¬å‡çº§ï¼šå½“æ‰§è¡Œå‡çº§æ—¶ï¼ŒCargo ä¼šå¿½ç•¥ Cargo.lockï¼Œæ ¹æ® Cargo.toml çš„åŒ…ç‰ˆæœ¬ä¿¡æ¯ï¼Œå‡çº§åˆ°æœ€æ–°çš„å°ç‰ˆæœ¬ï¼Œè€Œä¸ä¼šçªç ´å¤§ç‰ˆæœ¬ï¼Œå‡çº§ä¹‹å Cargo.lock ä¼šæ›´æ–°ï¼Œè€Œ Cargo.toml ä¿æŒä¸å˜ï¼Œä¹Ÿå°±æ˜¯åŸºäºè¯­ä¹‰åŒ–çš„ç‰ˆæœ¬å‡çº§ã€‚</p><h2 id="Trait"><a href="#Trait" class="headerlink" title="Trait"></a>Trait</h2><p>Trait å¯ä»¥ç†è§£æˆ Golang ä¸­çš„æ¥å£ï¼Œå®šä¹‰äº†è®¸å¤šæ–¹æ³•ã€‚<code>rand::Rng</code> å°±æ˜¯ä¸€ä¸ª Traitï¼Œå®šä¹‰äº†ä¸€ç»„éšæœºæ•°ç”Ÿæˆå™¨æ‰€éœ€è¦çš„æ–¹æ³•ã€‚<code>rand::thread_rng()</code> è¿™ä¸ªå‡½æ•°è¿”å›æ˜¯ä¸€ä¸ª <code>ThreadRng</code> ç±»å‹ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æœ¬åœ°çº¿ç¨‹ç©ºé—´ä¸­ï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿè·å–éšæœºæ•°ç§å­çš„éšæœºæ•°ç”Ÿæˆå™¨ï¼Œè€Œ <code>gen_range()</code> å°±æ˜¯ Trait çš„æ–¹æ³•ä¹‹ä¸€ã€‚</p><p><em>ä¸å¯¼å…¥ traitï¼Œä½†æ˜¯ä½¿ç”¨ trait æ–¹æ³•ï¼Œä¼šå¼•èµ·æŠ¥é”™</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">cargo run</span></span><br><span class="line">error[E0599]: no method named `gen_range` found for struct `ThreadRng` in the current scope</span><br><span class="line"><span class="meta prompt_">   --&gt; </span><span class="language-bash">src/main.rs:6:44</span></span><br><span class="line">    |</span><br><span class="line">6   |     let secret_number = rand::thread_rng().gen_range(1, 101);</span><br><span class="line">    |                                            ^^^^^^^^^ method not found in `ThreadRng`</span><br><span class="line">    |</span><br><span class="line">   ::: /Users/shenxianghong/.cargo/registry/src/github.com-1ecc6299db9ec823/rand-0.4.6/src/lib.rs:524:8</span><br><span class="line">    |</span><br><span class="line">524 |     fn gen_range&lt;T: PartialOrd + SampleRange&gt;(&amp;mut self, low: T, high: T) -&gt; T where Self: Sized &#123;</span><br><span class="line">    |        --------- the method is available for `ThreadRng` here</span><br><span class="line">    |</span><br><span class="line">    = help: items from traits can only be used if the trait is in scope</span><br><span class="line">help: the following trait is implemented but not in scope; perhaps add a `use` for it:</span><br><span class="line">    |</span><br><span class="line">1   | use rand::Rng;</span><br><span class="line">    |</span><br></pre></td></tr></table></figure><h1 id="æ¯”è¾ƒçŒœæµ‹æ•°å­—ä¸ç¥ç§˜æ•°å­—"><a href="#æ¯”è¾ƒçŒœæµ‹æ•°å­—ä¸ç¥ç§˜æ•°å­—" class="headerlink" title="æ¯”è¾ƒçŒœæµ‹æ•°å­—ä¸ç¥ç§˜æ•°å­—"></a>æ¯”è¾ƒçŒœæµ‹æ•°å­—ä¸ç¥ç§˜æ•°å­—</h1><p><em>çŒœæµ‹æ•°å­—ä¸º string ç±»å‹ï¼Œç¥ç§˜æ•°å­—ä¸º int ç±»å‹ï¼Œè½¬æ¢åè¿›è¡Œå¤§å°æ¯”è¾ƒ</em></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"><span class="keyword">use</span> std::cmp::Ordering;</span><br><span class="line"><span class="keyword">use</span> rand::Rng;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">secret_number</span> = rand::<span class="title function_ invoke__">thread_rng</span>().<span class="title function_ invoke__">gen_range</span>(<span class="number">1</span>, <span class="number">101</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;secret_number is &#123;&#125;&quot;</span>, secret_number);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;guess a number&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guess</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> guess).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;error reading line&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">guess</span>: <span class="type">u32</span> = guess.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">parse</span>().<span class="title function_ invoke__">expect</span>(<span class="string">&quot;error parsing guess number&quot;</span>);</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;your number is &#123;&#125;&quot;</span>, guess);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">match</span> guess.<span class="title function_ invoke__">cmp</span>(&amp;secret_number) &#123;</span><br><span class="line">        Ordering::Less =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Too small&quot;</span>),</span><br><span class="line">        Ordering::Greater =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Too big&quot;</span>),</span><br><span class="line">        Ordering::Equal =&gt; <span class="built_in">println!</span>(<span class="string">&quot;You win&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æšä¸¾"><a href="#æšä¸¾" class="headerlink" title="æšä¸¾"></a>æšä¸¾</h2><p><code>std::cmp::Ordering</code> æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼ŒåŒ…å«ä¸‰ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯ <code>Ordering::Less</code>ã€<code>Ordering::Greater</code> å’Œ <code>Ordering::Equal </code> ï¼Œæšä¸¾ç±»å‹çš„ä½¿ç”¨ä¹Ÿéœ€è¦ä½¿ç”¨åŒå†’å·æ ¼å¼ã€‚</p><h2 id="match"><a href="#match" class="headerlink" title="match"></a>match</h2><p><code>cmp</code> æ–¹æ³•è¿”å›çš„æ˜¯ Ordering ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„åˆ†æ”¯ï¼ˆarmï¼‰åˆ¤æ–­åŒ¹é…æ¨¡å¼ï¼Œä»è€Œæ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼Œå³ <code>=&gt;</code> ä¹‹åçš„é€»è¾‘ï¼Œç±»ä¼¼äº Golang ä¸­çš„ switch case ç”¨æ³•ã€‚</p><h2 id="Shadow"><a href="#Shadow" class="headerlink" title="Shadow"></a>Shadow</h2><p>Rust ä¸­å…è®¸ä½¿ç”¨åŒåçš„å˜é‡æ¥è¦†ç›–ä¹‹å‰çš„å˜é‡ï¼ŒåŒºåˆ«äº Golangï¼Œä¸ä»…å¯ä»¥ç”¨äºè¦†ç›–å€¼ï¼Œå¯ä»¥ç±»å‹ä¹Ÿå¯ä»¥ä¸ä¸€æ ·ã€‚ä¸€èˆ¬ç”¨äºåœ¨ä¸é¢å¤–å£°æ˜å˜é‡çš„åœºæ™¯ä¸‹ï¼Œè¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><h2 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h2><p>Rust æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œå¹¶ä¸”å…·å¤‡ç±»å‹æ¨æ–­çš„èƒ½åŠ›ï¼Œ<code>gen_range(1, 101)</code> ä¼šè¿”å› 1 åˆ° 100 ä¹‹é—´çš„éšæœºæ•´æ•°ï¼ŒRust ä¸­æ¶µç›–æ­¤èŒƒå›´çš„ç±»å‹å¾ˆå¤šï¼Œæ¯”å¦‚ i32ã€u32ã€i64 ç­‰ç­‰ï¼Œå¦‚æœæœªåšè¿›ä¸€æ­¥çš„å£°æ˜ï¼ŒRust é»˜è®¤å…¶ä¸º i32ã€‚</p><p>å¯ä»¥æ³¨æ„åˆ°ï¼Œå˜é‡ guess è¢«è½¬æ¢æˆäº† u32 ç±»å‹ï¼Œè€Œæ¥ä¸‹æ¥è¿˜å¯¹å˜é‡ guess å’Œ secret_number è¿›è¡Œäº† match æ¯”è¾ƒï¼Œå› æ­¤ Rust ä¹Ÿä¼šå°†å˜é‡ secret_number è®¾ç½®ä¸º u32 ç±»å‹ç¼–è¯‘ï¼Œå› æ­¤ï¼Œå¦‚æœæ²¡æœ‰ match æ¯”è¾ƒï¼Œåˆ™ Rust ä¼šå°†å…¶é»˜è®¤ä¸º i32ã€‚</p><h1 id="å¤šæ¬¡çŒœæµ‹"><a href="#å¤šæ¬¡çŒœæµ‹" class="headerlink" title="å¤šæ¬¡çŒœæµ‹"></a>å¤šæ¬¡çŒœæµ‹</h1><p><em>å¢åŠ æ­»å¾ªç¯ï¼Œç›´è‡³çŒœå¯¹é€€å‡ºï¼›å¢åŠ é”™è¯¯å¤„ç†ï¼Œå®Œå–„å¥å£®æ€§</em></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"><span class="keyword">use</span> std::cmp::Ordering;</span><br><span class="line"><span class="keyword">use</span> rand::Rng;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">secret_number</span> = rand::<span class="title function_ invoke__">thread_rng</span>().<span class="title function_ invoke__">gen_range</span>(<span class="number">1</span>, <span class="number">101</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">loop</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;guess a number&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">guess</span> = <span class="type">String</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        io::<span class="title function_ invoke__">stdin</span>().<span class="title function_ invoke__">read_line</span>(&amp;<span class="keyword">mut</span> guess).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;error reading line&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">guess</span>: <span class="type">u32</span> = <span class="keyword">match</span> guess.<span class="title function_ invoke__">trim</span>().<span class="title function_ invoke__">parse</span>() &#123;</span><br><span class="line">            <span class="title function_ invoke__">Ok</span>(num) =&gt; num,</span><br><span class="line">            <span class="title function_ invoke__">Err</span>(_) =&gt; <span class="keyword">continue</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;your number is &#123;&#125;&quot;</span>, guess);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">match</span> guess.<span class="title function_ invoke__">cmp</span>(&amp;secret_number) &#123;</span><br><span class="line">            Ordering::Less =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Too small&quot;</span>),</span><br><span class="line">            Ordering::Greater =&gt; <span class="built_in">println!</span>(<span class="string">&quot;Too big&quot;</span>),</span><br><span class="line">            Ordering::Equal =&gt; &#123;</span><br><span class="line">                <span class="built_in">println!</span>(<span class="string">&quot;You win&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ­»å¾ªç¯"><a href="#æ­»å¾ªç¯" class="headerlink" title="æ­»å¾ªç¯"></a>æ­»å¾ªç¯</h2><p>Rust ä¸­çš„æ­»å¾ªç¯ä½¿ç”¨ <code>loop</code> å…³é”®å­—ï¼Œé€€å‡ºä½¿ç”¨ <code>break</code> å…³é”®å­—ï¼Œç»§ç»­ä½¿ç”¨ <code>continue</code> å…³é”®å­—ã€‚</p><h2 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h2><p>Rust ä¸­å¸¸ç”¨çš„é”™è¯¯å¤„ç†æ–¹å¼æ˜¯åŸºäº match æ¨¡å¼ï¼Œä¾‹å¦‚ parse() æ–¹æ³•è¿”å› Result ç±»å‹ï¼Œè¯¥ç±»å‹åŒ…æ‹¬ä¸¤ä¸ªæšä¸¾å€¼ã€‚å…¶ä¸­ <code>Ok(num)</code>  è¡¨ç¤ºçŒœæµ‹æ•°å­—è§£ææˆåŠŸï¼Œnum ä¸ºè§£æä¹‹åçš„æ•°å­—ï¼Œé€šè¿‡ &#x3D;&gt; èµ‹å€¼ç»™ guessã€‚åŒç†ï¼Œ<code>Err(_)</code> è¡¨ç¤ºè§£æå¤±è´¥ï¼Œ<code>_</code> ä¸ºé”™è¯¯ä¿¡æ¯ï¼Œä¸‹åˆ’çº¿è¡¨ç¤ºå¿½ç•¥ã€‚</p>]]></content>
    
    
    <summary type="html">é€šè¿‡ä¸€ä¸ªç®€å•çš„çŒœæ•°æ¸¸æˆï¼Œäº†è§£ Rust ç¨‹åºçš„ä¸€äº›åŸºç¡€æ¦‚å¿µ</summary>
    
    
    
    <category term="Programming" scheme="http://shenxianghong.github.io/categories/Programming/"/>
    
    
    <category term="Rust" scheme="http://shenxianghong.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æ“ä½œå·æ•°æ®ï¼ˆResticï¼‰</title>
    <link href="http://shenxianghong.github.io/2022/01/06/2022-01-06%20Velero%20%E6%93%8D%E4%BD%9C%E5%8D%B7%E6%95%B0%E6%8D%AE%EF%BC%88Restic%EF%BC%89/"/>
    <id>http://shenxianghong.github.io/2022/01/06/2022-01-06%20Velero%20%E6%93%8D%E4%BD%9C%E5%8D%B7%E6%95%B0%E6%8D%AE%EF%BC%88Restic%EF%BC%89/</id>
    <published>2022-01-05T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.116Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="ä¸-Restic-é›†æˆå®‰è£…"><a href="#ä¸-Restic-é›†æˆå®‰è£…" class="headerlink" title="ä¸ Restic é›†æˆå®‰è£…"></a>ä¸ Restic é›†æˆå®‰è£…</h1><h2 id="å‘½ä»¤è¡Œå®‰è£…"><a href="#å‘½ä»¤è¡Œå®‰è£…" class="headerlink" title="å‘½ä»¤è¡Œå®‰è£…"></a>å‘½ä»¤è¡Œå®‰è£…</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">velero install \</span><br><span class="line">    --provider aws \</span><br><span class="line">    --bucket velero \</span><br><span class="line">    --plugins velero/velero-plugin-for-aws:v1.0.0 \</span><br><span class="line">    --secret-file /root/credential \</span><br><span class="line">    --use-restic \</span><br><span class="line">    --default-volumes-to-restic \</span><br><span class="line">    --use-volume-snapshots=false</span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜</strong></p><ul><li><code>use-restic</code> è¡¨ç¤ºæ˜¯å¦å¯ç”¨ Restic ç»„ä»¶æ“ä½œ Pod ä¸­çš„å·æ•°æ®</li><li><code>default-volumes-to-restic</code> è¡¨ç¤ºæ˜¯å¦é»˜è®¤å¤‡ä»½ Pod ä¸­æ‰€æœ‰çš„å·</li></ul><h2 id="éƒ¨ç½²æ–‡ä»¶"><a href="#éƒ¨ç½²æ–‡ä»¶" class="headerlink" title="éƒ¨ç½²æ–‡ä»¶"></a>éƒ¨ç½²æ–‡ä»¶</h2><p>ç›¸æ¯”äºä¹‹å‰çš„éƒ¨ç½²ç»“æœï¼š</p><ul><li>åœ¨æŒ‡å®š <code>--use-restic</code> ä¹‹åï¼Œé¢å¤–éƒ¨ç½²äº† DaemonSet ç±»å‹çš„ Restic æœåŠ¡</li><li>åœ¨æŒ‡å®š <code>--default-volumes-to-restic</code> ä¹‹åï¼ŒVelero çš„å¯åŠ¨å‚æ•°ä¸­ä¼šæ–°å¢ feature ç‰¹æ€§</li></ul><p><strong>default-volumes-to-restic</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">server</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--features=</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--default-volumes-to-restic=true</span></span><br></pre></td></tr></table></figure><p><strong>use-restic</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">velero</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">restic</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">velero</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">restic</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">velero</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">restic</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">restic</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--features=</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/velero</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VELERO_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">VELERO_SCRATCH_DIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/scratch</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GOOGLE_APPLICATION_CREDENTIALS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/credentials/cloud</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AWS_SHARED_CREDENTIALS_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/credentials/cloud</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AZURE_CREDENTIALS_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/credentials/cloud</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ALIBABA_CLOUD_CREDENTIALS_FILE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/credentials/cloud</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">velero:dev</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">restic</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/host_pods</span></span><br><span class="line">          <span class="attr">mountPropagation:</span> <span class="string">HostToContainer</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">host-pods</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/scratch</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">scratch</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/credentials</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cloud-credentials</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">velero</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/kubelet/pods</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">host-pods</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">scratch</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cloud-credentials</span></span><br><span class="line">        <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">cloud-credentials</span></span><br><span class="line">  <span class="attr">updateStrategy:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²ç»“æœ"><a href="#éƒ¨ç½²ç»“æœ" class="headerlink" title="éƒ¨ç½²ç»“æœ"></a>éƒ¨ç½²ç»“æœ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get pod -n velero</span></span><br><span class="line">NAME                      READY   STATUS      RESTARTS   AGE</span><br><span class="line">minio-54b5867494-6plnl    1/1     Running     0          12m</span><br><span class="line">minio-setup-54vx8         0/1     Completed   0          12m</span><br><span class="line">restic-vqdmn              1/1     Running     0          14m</span><br><span class="line">velero-598755d478-7l8gd   1/1     Running     0          14m</span><br></pre></td></tr></table></figure><h1 id="æµç¨‹éªŒè¯"><a href="#æµç¨‹éªŒè¯" class="headerlink" title="æµç¨‹éªŒè¯"></a>æµç¨‹éªŒè¯</h1><p>ä»¥ local PV ä½œä¸º Pod å·æ•°æ®ä¸ºä¾‹</p><p><strong>PV</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">100Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/tmp/example</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">          <span class="attr">values:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">sxh-1</span></span><br></pre></td></tr></table></figure><p><strong>PVC</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">50Mi</span></span><br></pre></td></tr></table></figure><p><strong>Pod</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;sleep 1000000&quot;</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">local-pvc</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">&quot;/mnt&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">local-pvc</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">example-pvc</span></span><br></pre></td></tr></table></figure><p><strong>æ“ä½œéªŒè¯</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å†™å…¥æµ‹è¯•æ•°æ®</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it example-pod <span class="built_in">ls</span> /mnt</span></span><br><span class="line">hello-here</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¤‡ä»½ä»»åŠ¡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup create default</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¨¡æ‹Ÿæ•…éšœ</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf /tmp/example/* &amp;&amp; kubectl delete pod test-pod &amp;&amp; kubectl delete pvc test-claim &amp;&amp; kubectl delete pv test-pv</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡æ–°éƒ¨ç½² pvï¼Œåç»­åœ¨ troubleshooting ä¼šè¯´æ˜åŸå› </span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl apply -f pv.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæ¢å¤ä»»åŠ¡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore create default --from-backup default</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹æµ‹è¯•æ•°æ®</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl <span class="built_in">exec</span> -it example-pod <span class="built_in">ls</span> /mnt</span></span><br><span class="line">hello-here</span><br></pre></td></tr></table></figure><h1 id="æµç¨‹èµ°è¯»"><a href="#æµç¨‹èµ°è¯»" class="headerlink" title="æµç¨‹èµ°è¯»"></a>æµç¨‹èµ°è¯»</h1><p>Velero åœ¨å¯¹ Pod å·æ•°æ®åšå¤‡ä»½æ—¶ï¼Œå¯ä»¥ä¸å¼€æºé¡¹ç›® Restic é›†æˆï¼Œé›†æˆä½¿ç”¨æ—¶ï¼ŒRestic æœ¬èº«çš„ä¼˜åŠ¿ä¹Ÿä¼šå¾—åˆ°æ”¯æŒï¼Œå¦‚<strong>åŠ å¯†ä¼ è¾“</strong>ï¼Œ <strong>å‹ç¼©å¤‡ä»½</strong>ï¼Œ <strong>å¢é‡å¤‡ä»½</strong>ï¼Œ <strong>æ–­ç‚¹ç»­ä¼ </strong>ç­‰ã€‚</p><h2 id="CRD"><a href="#CRD" class="headerlink" title="CRD"></a>CRD</h2><p>æœ‰å…³å·å¤‡ä»½ä¸æ¢å¤çš„ CRD åŒ…å«ï¼š<code>podvolumebackups.velero.io</code>ã€<code>podvolumerestores.velero.io</code> å’Œ <code>resticrepositories.velero.io</code>ã€‚</p><h3 id="ResticRepository"><a href="#ResticRepository" class="headerlink" title="ResticRepository"></a>ResticRepository</h3><p>Restic ä¸­ <code>repository</code> çš„æ¦‚å¿µï¼Œè¡¨ç¤ºå¤‡ä»½ç”¨äºå­˜å‚¨çš„ä½ç½®ã€‚</p><p>åŸç”Ÿ Restic ä¸­é€šè¿‡ <code>restic init --repo &lt;repo&gt;</code> çš„æ–¹å¼åˆå§‹åŒ–ä¸åŒçš„ backendã€‚</p><p><strong>local</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">restic init --repo /srv/restic-repo</span></span><br><span class="line">enter password for new repository:</span><br><span class="line">enter password again:</span><br><span class="line">created restic repository 085b3c76b9 at /srv/restic-repo</span><br><span class="line">Please note that knowledge of your password is required to access the repository.</span><br><span class="line">Losing your password means that your data is irrecoverably lost.</span><br></pre></td></tr></table></figure><p><strong>sftp</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">restic -r sftp:user@host:/srv/restic-repo init</span></span><br><span class="line">enter password for new repository:</span><br><span class="line">enter password again:</span><br><span class="line">created restic repository f1c6108821 at sftp:user@host:/srv/restic-repo</span><br><span class="line">Please note that knowledge of your password is required to access the repository.</span><br><span class="line">Losing your password means that your data is irrecoverably lost.</span><br></pre></td></tr></table></figure><p><strong>Amazon S3</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=&lt;MY_ACCESS_KEY&gt;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY=&lt;MY_SECRET_ACCESS_KEY&gt;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">restic -r s3:s3.amazonaws.com/bucket_name init</span></span><br><span class="line">enter password for new repository:</span><br><span class="line">enter password again:</span><br><span class="line">created restic repository eefee03bbd at s3:s3.amazonaws.com/bucket_name</span><br><span class="line">Please note that knowledge of your password is required to access the repository.</span><br><span class="line">Losing your password means that your data is irrecoverably lost.</span><br></pre></td></tr></table></figure><p><strong>Minio Server</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> AWS_ACCESS_KEY_ID=&lt;YOUR-MINIO-ACCESS-KEY-ID&gt;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> AWS_SECRET_ACCESS_KEY= &lt;YOUR-MINIO-SECRET-ACCESS-KEY&gt;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./restic -r s3:http://localhost:9000/restic init</span></span><br><span class="line">enter password for new repository:</span><br><span class="line">enter password again:</span><br><span class="line">created restic repository 6ad29560f5 at s3:http://localhost:9000/restic1</span><br><span class="line">Please note that knowledge of your password is required to access</span><br><span class="line">the repository. Losing your password means that your data is irrecoverably lost.</span><br></pre></td></tr></table></figure><p>åœ¨ Velero ä¸­å°è£…äº†åˆå§‹åŒ– Restic Repository çš„åŠ¨ä½œï¼ˆå…·ä½“åŒ…å« <code>restic init</code>ã€<code>restic check</code> å’Œ <code>restic prune</code>ï¼‰ï¼Œä½†æ˜¯ä»…æ”¯æŒ <code>velero.io/aws</code>ï¼ˆåŒ…å« aws æˆ–è€…é awsï¼Œä½†æ˜¯å…¼å®¹ s3 çš„å­˜å‚¨ï¼Œå¦‚ minioï¼‰ã€<code>velero.io/aure</code> å’Œ <code>velero.io/gcp</code>ã€‚</p><p><em>pkg&#x2F;restic&#x2F;config.go</em></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// getRepoPrefix returns the prefix of the value of the --repo flag for</span></span><br><span class="line"><span class="comment">// restic commands, i.e. everything except the &quot;/&lt;repo-name&gt;&quot;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getRepoPrefix</span><span class="params">(location *velerov1api.BackupStorageLocation)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> bucket, prefix <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> location.Spec.ObjectStorage != <span class="literal">nil</span> &#123;</span><br><span class="line">layout := persistence.NewObjectStoreLayout(location.Spec.ObjectStorage.Prefix)</span><br><span class="line"></span><br><span class="line">bucket = location.Spec.ObjectStorage.Bucket</span><br><span class="line">prefix = layout.GetResticDir()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">backendType := getBackendType(location.Spec.Provider)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> repoPrefix := location.Spec.Config[<span class="string">&quot;resticRepoPrefix&quot;</span>]; repoPrefix != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> repoPrefix, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> backendType &#123;</span><br><span class="line"><span class="keyword">case</span> AWSBackend:</span><br><span class="line"><span class="keyword">var</span> url <span class="type">string</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="comment">// non-AWS, S3-compatible object store</span></span><br><span class="line"><span class="keyword">case</span> location.Spec.Config[<span class="string">&quot;s3Url&quot;</span>] != <span class="string">&quot;&quot;</span>:</span><br><span class="line">url = location.Spec.Config[<span class="string">&quot;s3Url&quot;</span>]</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">region, err := getAWSBucketRegion(bucket)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">url = <span class="string">&quot;s3.amazonaws.com&quot;</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">url = fmt.Sprintf(<span class="string">&quot;s3-%s.amazonaws.com&quot;</span>, region)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;s3:%s/%s&quot;</span>, strings.TrimSuffix(url, <span class="string">&quot;/&quot;</span>), path.Join(bucket, prefix)), <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> AzureBackend:</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;azure:%s:/%s&quot;</span>, bucket, prefix), <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> GCPBackend:</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;gs:%s:/%s&quot;</span>, bucket, prefix), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;restic repository prefix (resticRepoPrefix) not specified in backup storage location&#x27;s config&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹æ¯ä¸€ä¸ªå¾…å¤‡ä»½å·æ•°æ®çš„ Pod æ‰€åœ¨çš„ namespaceï¼Œvelero ä¼šåˆ›å»ºä¸€ä¸ªå’Œ namespace å¯¹åº”çš„ ResticRepositoryï¼Œå¦‚æœå¯¹åº” namespace çš„ ResticRepository å­˜åœ¨ï¼Œåˆ™ä¸ä¼šé‡å¤åˆ›å»ºï¼Œå‘½åæ–¹å¼ä¸º <code>&lt;namespace&gt;-&lt;backupstoragelocation&gt;-&lt;id&gt;</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restic repo get</span></span><br><span class="line">NAME                    STATUS   LAST MAINTENANCE</span><br><span class="line">default-default-n5mz4   Ready    2022-01-06 16:05:14 +0800 CST</span><br><span class="line">velero-default-8q767    Ready    2022-01-06 15:46:31 +0800 CST</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get resticrepositories -n velero</span></span><br><span class="line">NAME                    AGE</span><br><span class="line">default-default-n5mz4   2m</span><br><span class="line">velero-default-8q767    2m28s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get resticrepositories -n velero default-default-n5mz4 -o yaml</span></span><br><span class="line">&lt;skip&gt;</span><br><span class="line">spec:</span><br><span class="line">  backupStorageLocation: default</span><br><span class="line">  maintenanceFrequency: 168h0m0s</span><br><span class="line">  resticIdentifier: s3:http://minio.velero.svc:9000/velero/restic/default</span><br><span class="line">  volumeNamespace: default</span><br></pre></td></tr></table></figure><p>åœ¨ BackupStorageLocation ä¸­çš„å­˜å‚¨æ–¹å¼å¦‚ä¸‹ï¼š</p><p><strong>velero.io&#x2F;aws</strong></p><div align=center><img width="600" style="border: 0px" src="/gallery/velero/resticrepositories-in-minio.png"></div><h3 id="PodVolumeBackup"><a href="#PodVolumeBackup" class="headerlink" title="PodVolumeBackup"></a>PodVolumeBackup</h3><p>ä»£è¡¨ Pod å·å¤‡ä»½ä»»åŠ¡ï¼Œæ¯æœ‰ä¸€ä¸ªå¾…å¤‡ä»½çš„ Pod å·ï¼ŒVelero ä¼šåˆ›å»ºä¸€ä¸ªå’Œ backup å¯¹åº”çš„ PodVolumeBackupï¼Œç”±äºè¯¥ CR æ˜¯å’Œ backup å¯¹åº”ä¸” backup åç§°å”¯ä¸€ï¼Œæ‰€ä»¥é’ˆå¯¹ç›¸åŒçš„ Pod å·çš„å¤šæ¬¡å¤‡ä»½ï¼Œä¼šåˆ›å»ºå¤šä¸ª PodVolumeBackupï¼Œå‘½åæ–¹å¼ä¸º <code>&lt;backup&gt;-&lt;id&gt;</code>ï¼Œå„èŠ‚ç‚¹ä¸Šçš„ restic daemonset  controller ä¼šæ ¹æ® PodVolumeBackupæŒ‡å®š <code>restic backup</code> å‘½ä»¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get podvolumebackups -n velero</span></span><br><span class="line">NAME            AGE</span><br><span class="line">default-l2dd6   105s</span><br><span class="line">velero-j2xj5    2m5s</span><br><span class="line">velero-llv9m    2m5s</span><br><span class="line">velero-nxlkq    2m13s</span><br><span class="line">velero-x6m72    2m7s</span><br><span class="line">velero-xqdhk    2m7s</span><br><span class="line">velero-z7rhq    2m12s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe podvolumebackups -n velero default-l2dd6</span></span><br><span class="line">&lt;skip&gt;</span><br><span class="line">Spec:</span><br><span class="line">  Backup Storage Location:  default</span><br><span class="line">  Node:                     sxh-1</span><br><span class="line">  Pod:</span><br><span class="line">    Kind:           Pod</span><br><span class="line">    Name:           example-pod</span><br><span class="line">    Namespace:      default</span><br><span class="line">    UID:            bb17e801-b595-4e96-8ced-e27e8686be23</span><br><span class="line">  Repo Identifier:  s3:http://minio.velero.svc:9000/velero/restic/default</span><br><span class="line">  Tags:</span><br><span class="line">    Backup:        default</span><br><span class="line">    Backup - UID:  2fa40af0-2dcc-43dc-9636-79e5f1c95045</span><br><span class="line">    Ns:            default</span><br><span class="line">    Pod:           example-pod</span><br><span class="line">    Pod - UID:     bb17e801-b595-4e96-8ced-e27e8686be23</span><br><span class="line">    Pvc - UID:     f89b5daf-cf5e-49f1-9ba8-26e62f55baf2</span><br><span class="line">    Volume:        local-pvc</span><br><span class="line">  Volume:          local-pvc</span><br></pre></td></tr></table></figure><h3 id="PodVolumeRestore"><a href="#PodVolumeRestore" class="headerlink" title="PodVolumeRestore"></a>PodVolumeRestore</h3><p>ä»£è¡¨ Pod volume çš„æ¢å¤ä»»åŠ¡ï¼Œæ¯æœ‰ä¸€ä¸ªå¾…æ¢å¤çš„ Pod å·ï¼ŒVelero ä¼šåˆ›å»ºä¸€ä¸ªå’Œ restore å¯¹åº”çš„ PodVolumeRestoreï¼Œç”±äºè¯¥ CR æ˜¯å’Œ restore å¯¹åº”ä¸” restore åç§°å”¯ä¸€ï¼Œæ‰€ä»¥é’ˆå¯¹ç›¸åŒçš„ Pod å·å»ºå¤šä¸ª PodVolumeRestoreï¼Œå‘½åæ–¹å¼ä¸º <code>&lt;restore&gt;-&lt;id&gt;</code>ï¼Œå„èŠ‚ç‚¹ä¸Šçš„ restic daemonset  controller ä¼šæ ¹æ® PodVolumeRestoreæ‰§è¡Œ <code>restic restore</code> å‘½ä»¤ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get podvolumerestores -n velero</span></span><br><span class="line">NAME                        AGE</span><br><span class="line">alls-20220106165015-p54kz   6m17s</span><br><span class="line">alls-20220106165349-rl4sh   2m42s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl describe podvolumerestores alls-20220106165349-rl4sh -n velero</span></span><br><span class="line">Spec:</span><br><span class="line">  Backup Storage Location:  default</span><br><span class="line">  Pod:</span><br><span class="line">    Kind:           Pod</span><br><span class="line">    Name:           example-pod</span><br><span class="line">    Namespace:      default</span><br><span class="line">    UID:            d72f5c66-2f93-4e4b-b2f6-0e5ce0aa2042</span><br><span class="line">  Repo Identifier:  s3:http://minio.velero.svc:9000/velero/restic/default</span><br><span class="line">  Snapshot ID:      abdd9af5</span><br><span class="line">  Volume:           local-pvc</span><br></pre></td></tr></table></figure><h2 id="å¤‡ä»½"><a href="#å¤‡ä»½" class="headerlink" title="å¤‡ä»½"></a>å¤‡ä»½</h2><p>Velero åœ¨å¼€å¯ Restic å¯¹ Pod volume å¤‡ä»½æ—¶ï¼Œæ ¹æ®ä»¥ä¸‹ä¸¤ç§æ–¹å¼è·å–å¾…å¤‡ä»½å·çš„ä¿¡æ¯ï¼š</p><p><strong>Velero args</strong></p><p>åœ¨å¼€å¯ <code>default-volumes-to-restic</code> æ—¶ï¼Œé»˜è®¤æ‰€æœ‰å¤‡ä»½å‡ä½¿ç”¨ restic å¤‡ä»½æ‰€æœ‰çš„ Pod å·ã€‚è¯¥å‚æ•°å³å¯ä»¥åœ¨ <code>velero install</code> ä¸­å…¨å±€ç”Ÿæ•ˆï¼Œä¹Ÿå¯ä»¥åœ¨ <code>velero backup create</code> æ—¶é’ˆå¯¹å•æ¬¡å¤‡ä»½ç”Ÿæ•ˆã€‚</p><p><em>pkg&#x2F;cmd&#x2F;cli&#x2F;install&#x2F;install.go</em></p><p><strong>Pod annotation</strong></p><p>åœ¨æœªå¼€å¯ <code>default-volumes-to-restic</code> æ—¶ï¼ŒVelero ä¼šæ ¹æ® Pod annotation çš„ä¸­å£°æ˜ä¿¡æ¯ï¼Œè·å–å¾…å¤‡ä»½çš„ Pod å·ï¼Œä¾‹å¦‚ <code>backup.velero.io/backup-volumes=nginx-logs</code>ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæ’é™¤å¤‡ä»½çš„å·ï¼Œä¾‹å¦‚ <code>backup.velero.io/backup-volumes-excludes=nginx-logs</code>ã€‚</p><p><strong>æ³¨æ„</strong></p><ol><li><p>å¦‚æœä¸¤ç§æ–¹å¼å‡å¼€å¯æ—¶ï¼Œä»… <code>backup-volumes-excludes</code> ç”Ÿæ•ˆ</p></li><li><p>å¹¶éæ‰€æœ‰çš„ in-tree volume å‡ä¼šå¤‡ä»½ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å·ç±»å‹ä¸ä¼šå‚ä¸å¤‡ä»½</p><ul><li><strong>hostpath</strong>ï¼Œç”±äº hostpath ä¸ä¼šæŒ‚è½½åˆ° <code>/var/lib/kubelet/pods</code> ä¸­ï¼Œå› æ­¤æ— æ³•è¢« Restic è·å–</li><li><strong>secret</strong>ï¼Œä¼šä½œä¸º K8s metadata å•ç‹¬å¤‡ä»½</li><li><strong>configMap</strong>ï¼Œä¼šä½œä¸º K8s metadata å•ç‹¬å¤‡ä»½</li><li><strong>projected</strong>ï¼Œä¸ºè¿è¡Œæ—¶çŠ¶æ€æ•°æ®ï¼Œä¸ä¼šå¤‡ä»½</li><li>**â€default-tokenâ€**ï¼Œé»˜è®¤çš„ service account tokenï¼Œä¸éœ€è¦å¤‡ä»½</li></ul></li></ol><p>å¦‚ä¸Šæ‰€è¿°ï¼ŒVelero ä¸º Pod ä¸­è¦å¤‡ä»½çš„æ¯ä¸ªå·åˆ›å»ºä¸€ä¸ª  PodVolumeBackupï¼Œå¹¶ç­‰å¾…å…¶çŠ¶æ€è¿”å› completed æˆ–è€… failedã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ restic controller ä¼šæœ‰ä¸€ä¸ª <code>/var/lib/kubelet/pods</code> çš„ hostPath å·æŒ‚è½½ç”¨æ¥è®¿é—® Pod çš„å·æ•°æ®ï¼Œé€šè¿‡è®¿é—®è¯¥ hostPath å·ï¼Œè·å–åˆ°å¾…å¤‡ä»½çš„ Pod å·æ•°æ®åï¼Œæ‰§è¡Œ <code>restic backup</code>ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µå°† odVolumeBackup çŠ¶æ€è®¾ç½®ä¸º completed æˆ–è€… failedã€‚</p><p>åœ¨æ¯ä¸€ä¸ª PodVolumeBackup å®Œæˆæ—¶ï¼ŒVelero ä¼šå°†ä¿¡æ¯æ·»åŠ åˆ° <code>&lt;backup-name&gt;-podvolumebackups.json.gz</code> æ–‡ä»¶ä¸­ï¼Œå¤‡ä»½å®Œæˆæ—¶ï¼Œæ±‡æ€»å€™ä¸Šä¼ åˆ°åç«¯å­˜å‚¨ä¸­ï¼Œè¯¥æ–‡ä»¶ä¸­åŒ…å«æœ¬æ¬¡å¤‡ä»½æ‰€æœ‰çš„ PodVolumeBackup  ä¿¡æ¯ã€‚</p><h2 id="æ¢å¤"><a href="#æ¢å¤" class="headerlink" title="æ¢å¤"></a>æ¢å¤</h2><p>å½“å¯¹ Pod å·æ•°æ®è¿›è¡Œæ¢å¤æ—¶ï¼ŒVelero ä¼šæ ¹æ® restore çš„ <code>--from-backup</code> çš„å¤‡ä»½è·å–åˆ° PodVolumeBackupã€‚</p><p>å¯¹äºè·å–åˆ° PodVolumeBackupï¼ŒVelero ä¼šç¡®ä¿å¾…æ¢å¤ Pod çš„ namespaceæœ‰ä¸ä¹‹å¯¹åº”çš„  ResticRepositoryï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªï¼Œå¹¶æ‰§è¡Œ <code>restic init</code> å’Œ <code>restic check</code>ã€‚</p><p>Velero å‘æ¯ä¸€ä¸ªå¾…æ¢å¤å·æ•°æ®çš„ Pod æ³¨å…¥ä¸€ä¸ª init å®¹å™¨ï¼Œè¿™ä¸ªç¨‹åºä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°åœ¨æ¯ä¸€ä¸ªæ¢å¤çš„å·ä¸­æ‰¾åˆ°ä¸€ä¸ªä½äº .velero ä¸‹çš„æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶çš„åç§°æ˜¯æ¢å¤ä»»åŠ¡çš„ UIDï¼Œå³ Pod å®Œæˆæ‰€æœ‰å·æ•°æ®çš„æ¢å¤ã€‚</p><p>Velero åˆ›å»ºå‡ºæ¥çš„è¿™ä¸ªå¾…æ¢å¤çš„ Podï¼ŒKubernetes è°ƒåº¦å™¨å°†è¿™ä¸ª Pod è°ƒåº¦åˆ°ä¸€ä¸ªå¯å·¥ä½œçš„èŠ‚ç‚¹ï¼Œç¡®ä¿è¯¥ Pod å¤„äºè¿è¡ŒçŠ¶æ€ã€‚å¦‚æœ Pod ç”±äºæŸç§åŸå› ï¼ˆå³é›†ç¾¤èµ„æºä¸è¶³ï¼‰å¯åŠ¨å¤±è´¥ï¼Œåˆ™ä¸ä¼šè¿›è¡Œ Restic æ¢å¤ã€‚</p><p>Velero ä¸º Pod ä¸­è¦æ¢å¤çš„æ¯ä¸ªå·åˆ›å»ºä¸€ä¸ª PodVolumeRestoreï¼Œå¹¶ç­‰å¾…å…¶çŠ¶æ€è¿”å› completed æˆ–è€… failedã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ restic controller ä¼šæœ‰ä¸€ä¸ª <code>/var/lib/kubelet/pods</code> çš„ hostPath å·æŒ‚è½½ç”¨æ¥è®¿é—® Pod çš„å·æ•°æ®ï¼Œç­‰å¾… Pod è¿è¡Œ init å®¹å™¨ï¼Œé€šè¿‡è®¿é—®è¯¥ hostPath å·ï¼Œè·å–åˆ°å¾…å¤‡ä»½çš„ Pod å·æ•°æ®åï¼Œæ‰§è¡Œ <code>restic restore</code>ï¼ŒæˆåŠŸä¹‹åï¼Œå°†æ–‡ä»¶å†™å…¥ Pod å·ä¸­çš„ .velero å­ç›®å½•ä¸­ï¼Œåç§°æ˜¯æ¢å¤ä»»åŠ¡çš„ UIDï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µå°† PodVolumeRestore çŠ¶æ€è®¾ç½®ä¸º completed æˆ–è€… failedã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /mnt/.velero</span></span><br><span class="line">total 0</span><br><span class="line">-rw-r--r--    1 root     root             0 Jan 17 06:28 b1f704be-7f60-475e-833f-4471544a2f87</span><br></pre></td></tr></table></figure><p>å½“ init å®¹å™¨åœ¨ .velero ä¸‹è·å–åˆ°æ‰€æœ‰çš„å¾…æ¢å¤çš„å·ä¿¡æ¯åï¼Œä¾¿ä¼šæˆåŠŸé€€å‡ºï¼ŒPod ç»§ç»­è¿è¡Œå…¶ä»– init å®¹å™¨&#x2F;ä¸»è¿›ç¨‹ã€‚</p><h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h2><h3 id="é™æ€ä¾›åº”çš„-PV-çš„å¤‡ä»½ä¸æ¢å¤"><a href="#é™æ€ä¾›åº”çš„-PV-çš„å¤‡ä»½ä¸æ¢å¤" class="headerlink" title="é™æ€ä¾›åº”çš„ PV çš„å¤‡ä»½ä¸æ¢å¤"></a>é™æ€ä¾›åº”çš„ PV çš„å¤‡ä»½ä¸æ¢å¤</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒVelero ä¼šå¤‡ä»½é™æ€ PVï¼Œå¦‚ local pvã€nfs pv ç­‰ï¼Œä½†æ˜¯åœ¨æ¢å¤çš„æ—¶å€™ï¼Œå¦‚æœå¾…æ¢å¤çš„å¯¹è±¡ä¸­åŒ…å«ä½¿ç”¨è¯¥ PV çš„ Pod æ—¶ï¼ŒVelero å¹¶ä¸ä¼šæ¢å¤ PVï¼Œè€Œæ˜¯é»˜è®¤ç”± StorageClass åŠ¨æ€ä¾›åº”åˆ›å»º PVã€‚æ­¤æ—¶ï¼Œ PVC ä¼šå¤„äº pending çŠ¶æ€ï¼ˆç”±äºä¸å­˜åœ¨ PVï¼‰ï¼ŒPod ä¹Ÿä¼šå¤„äº pending çŠ¶æ€ï¼ˆç”±äº PVC pendingï¼‰ï¼Œrestore ä»»åŠ¡ä¼šç­‰å¾…ç›´è‡³è¶…æ—¶ã€‚</p><p>ç›®å‰æ¥çœ‹ Velero ç¤¾åŒºå¹¶æ²¡æœ‰å°†æ­¤è§†ä¸º bugï¼Œå»ºè®®åœ¨ä½¿ç”¨å±‚é¢è¿›è¡Œå¤„ç†ï¼Œæ–¹æ¡ˆçš„æ ¸å¿ƒæ€è·¯æ˜¯å¦‚æœæ¢å¤çš„ Pod ä½¿ç”¨é™æ€çš„ PV æ—¶ï¼Œéœ€è¦ç¡®ä¿æ¢å¤æµç¨‹æ‰§è¡Œä¹‹å‰ï¼Œå­˜åœ¨ä¸€ä¸ªå¯ä»¥æ»¡è¶³ PVC çš„ PVï¼Œä¾‹å¦‚ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆï¼š</p><p><strong>æ‰‹åŠ¨åˆ›å»º PV</strong></p><p>ä¹Ÿå°±æ˜¯æµç¨‹éªŒè¯ä¸­çš„æ“ä½œï¼Œé€šè¿‡æ‰‹åŠ¨åˆ›å»º PVï¼Œæ¥ä¸ Velero æ¢å¤çš„ PVC è¿›è¡Œç»‘å®šï¼Œå®Œæˆåç»­æ¢å¤æµç¨‹ã€‚</p><p><strong>å•ç‹¬å¤‡ä»½ PV</strong></p><p>é€šè¿‡ <code>--include-resources pv</code> å•ç‹¬å¤‡ä»½é™æ€ PVï¼Œåœ¨æ¢å¤ä¹‹å‰ï¼Œå•ç‹¬æ¢å¤é™æ€ PVï¼Œå…·ä½“æµç¨‹ä¸ºï¼š</p><ol><li>å¤‡ä»½é™æ€ PV</li><li>åˆ›å»ºå¤‡ä»½ä»»åŠ¡</li><li>æ¢å¤é™æ€ PV</li><li>æ¢å¤å¤‡ä»½ä»»åŠ¡</li></ol><blockquote><p><a href="https://github.com/vmware-tanzu/velero/issues/2520">https://github.com/vmware-tanzu/velero/issues/2520</a></p></blockquote>]]></content>
    
    
    <summary type="html">å€ŸåŠ© Restic å®ç°å¯¹ Kubernetes é›†ç¾¤ä¸­å®¹å™¨å·æ•°æ®çš„å¤‡ä»½ä¸æ¢å¤</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Rust ã€å¿«é€Ÿå¼€å§‹</title>
    <link href="http://shenxianghong.github.io/2022/01/02/2022-01-02%20Rust%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"/>
    <id>http://shenxianghong.github.io/2022/01/02/2022-01-02%20Rust%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/</id>
    <published>2022-01-01T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.103Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="150" style="border: 0px" src="/gallery/rust/logo.png"></div><hr><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>Rust æ˜¯ç”± Mozilla ä¸»å¯¼å¼€å‘çš„é€šç”¨ã€ç¼–è¯‘å‹ç¼–ç¨‹è¯­è¨€ã€‚è®¾è®¡å‡†åˆ™ä¸ºâ€œå®‰å…¨ã€å¹¶å‘ã€å®ç”¨â€ï¼Œæ”¯æŒå‡½æ•°å¼ã€å¹¶å‘å¼ã€è¿‡ç¨‹å¼ä»¥åŠé¢å‘å¯¹è±¡çš„ç¼–ç¨‹é£æ ¼ã€‚<br>Rust è¯­è¨€åŸæœ¬æ˜¯ Mozilla å‘˜å·¥ Graydon Hoare çš„ç§äººè®¡åˆ’ï¼Œè€Œ Mozilla äº 2009 å¹´å¼€å§‹èµåŠ©è¿™ä¸ªè®¡åˆ’ï¼Œå¹¶ä¸”åœ¨ 2010 å¹´é¦–æ¬¡å…¬å¼€ã€‚ä¹Ÿåœ¨åŒä¸€å¹´ï¼Œå…¶ç¼–è¯‘å™¨æºä»£ç å¼€å§‹ç”±åŸæœ¬çš„ OCaml è¯­è¨€è½¬ç§»åˆ°ç”¨ Rust è¯­è¨€ï¼Œè¿›è¡Œ bootstrapping å·¥ä½œï¼Œç§°åš â€œrustcâ€ï¼Œå¹¶äº 2011 å¹´å®é™…å®Œæˆã€‚è¿™ä¸ªå¯è‡ªæˆ‘ç¼–è¯‘çš„ç¼–è¯‘å™¨åœ¨æ¶æ„ä¸Šé‡‡ç”¨äº† LLVM åšä¸ºå®ƒçš„åç«¯ã€‚<br>ç¬¬ä¸€ä¸ªæœ‰ç‰ˆæœ¬å·çš„ Rust ç¼–è¯‘å™¨äº 2012 å¹´ 1 æœˆå‘å¸ƒã€‚Rust 1.0 æ˜¯ç¬¬ä¸€ä¸ªç¨³å®šç‰ˆæœ¬ï¼Œäº 2015 å¹´ 5 æœˆ 15 æ—¥å‘å¸ƒã€‚<br>Rust æ˜¯åœ¨å®Œå…¨å¼€æ”¾çš„æƒ…å†µä¸‹è¿›è¡Œå¼€å‘ï¼Œå¹¶ä¸”ç›¸å½“æ¬¢è¿ç¤¾åŒºçš„åé¦ˆã€‚åœ¨ 1.0 ç¨³å®šç‰ˆä¹‹å‰ï¼Œè¯­è¨€è®¾è®¡ä¹Ÿå› ä¸ºé€è¿‡æ’°å†™ Servo ç½‘é¡µæµè§ˆå™¨æ’ç‰ˆå¼•æ“å’Œ rustc ç¼–è¯‘å™¨æœ¬èº«ï¼Œè€Œæœ‰è¿›ä¸€æ­¥çš„æ”¹å–„ã€‚è™½ç„¶å®ƒç”± Mozilla èµ„åŠ©ï¼Œä½†å®ƒå…¶å®æ˜¯ä¸€ä¸ªå…±æœ‰é¡¹ç›®ï¼Œæœ‰å¾ˆå¤§éƒ¨åˆ†çš„ä»£ç æ˜¯æ¥è‡ªäºç¤¾åŒºçš„è´¡çŒ®è€…ã€‚</p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><h2 id="Rust-å®˜ç½‘"><a href="#Rust-å®˜ç½‘" class="headerlink" title="Rust å®˜ç½‘"></a>Rust å®˜ç½‘</h2><p><a href="https://www.rust-lang.org/">https://www.rust-lang.org</a></p><h2 id="Rustup-å®‰è£…"><a href="#Rustup-å®‰è£…" class="headerlink" title="Rustup å®‰è£…"></a>Rustup å®‰è£…</h2><p>Rustup æ˜¯ä¸€ä¸ªé’ˆå¯¹ Rust è¯­è¨€çš„å·¥å…·é“¾ç®¡ç†å™¨ï¼ˆtoolchain managerï¼‰ï¼Œå…¶ç›®æ ‡æ˜¯è®©äº¤å‰ç¼–è¯‘ Rust ä»£ç æ›´åŠ ç®€å•ã€‚Rustup æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ï¼Œèƒ½å¤Ÿä¸‹è½½å¹¶åœ¨ä¸åŒç‰ˆæœ¬çš„ Rust å·¥å…·é“¾ä¸­è¿›è¡Œåˆ‡æ¢ â€”â€” å¦‚ç¼–è¯‘å™¨ <code>rustc</code>å’Œæ ‡å‡†åº“ï¼Œè¯¥åº”ç”¨æ‰€æ”¯æŒçš„å¹³å°æ•°é‡ä¸å°‘ã€‚äº‹å®ä¸Šï¼Œ<code>rustc</code> æœ¬èº«å°±æ”¯æŒå¤§çº¦ 56 ä¸ªå¹³å°ï¼Œè€Œ <code>rustup</code> å®é™…ä¸Šèƒ½å¤Ÿä¸ºå…¶ä¸­ 14 ä¸ªå¹³å°ç®¡ç†ç¼–è¯‘å™¨ï¼Œä¸º 30 ä¸ªå¹³å°ç®¡ç†æ ‡å‡†åº“ã€‚</p><h3 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h3><h4 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h4><p>Rust å‘å¸ƒåœ¨ä¸‰ä¸ªä¸åŒçš„ channel ä¸Šï¼šstableï¼Œbeta å’Œ nightlyï¼Œå…¶å®å°±æ˜¯ä¸‰ç§ä¸åŒçš„ç‰ˆæœ¬</p><ul><li><strong>stable</strong> â€” Rust çš„ç¨³å®šç‰ˆæœ¬ï¼Œæ¯ 6 å‘¨å‘å¸ƒä¸€æ¬¡ã€‚</li><li><strong>beta</strong> â€” Rust çš„å…¬å¼€æµ‹è¯•ç‰ˆæœ¬ï¼Œå°†æ˜¯ä¸‹ä¸€ä¸ª stable ç‰ˆæœ¬</li><li><strong>nightly</strong> â€” æ¯å¤©æ›´æ–°ï¼ŒåŒ…å«ä¸€äº›å®éªŒæ€§çš„æ–°ç‰¹æ€§</li></ul><h4 id="toolchain"><a href="#toolchain" class="headerlink" title="toolchain"></a>toolchain</h4><p>å·¥å…·é“¾çš„æ ‡å‡†å‘½åæ ¼å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;channel&gt;[-&lt;date&gt;][-&lt;host&gt;]</span><br><span class="line"></span><br><span class="line">&lt;channel&gt;       = stable|beta|nightly|&lt;version&gt;</span><br><span class="line">&lt;date&gt;          = YYYY-MM-DD</span><br><span class="line">&lt;host&gt;          = &lt;target-triple&gt;</span><br></pre></td></tr></table></figure><p>å·¥å…·é“¾é»˜è®¤è¢«å®‰è£…åœ¨ <code>RUSTUP_HOME</code> ï¼ˆUnixç³»ç»Ÿï¼š<code>~/.rustup</code> ï¼ŒWindowsç³»ç»Ÿï¼š<code>%USERPROFILE%/.rustup</code>ï¼‰ç›®å½•ä¸‹ã€‚</p><h4 id="components"><a href="#components" class="headerlink" title="components"></a>components</h4><p>å·¥å…·é“¾ç”±è‹¥å¹²ç»„ä»¶æ„æˆï¼Œé€šè¿‡ <code>rustup component list</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å’Œå·²ç»å®‰è£…çš„ç»„ä»¶ã€‚</p><p>Rustup é»˜è®¤å®‰è£…çš„ç»„ä»¶æœ‰ï¼š</p><ul><li><strong>rustc</strong> â€” Rust ç¼–è¯‘å™¨</li><li><strong>rust-std</strong> â€” Rust æ ‡å‡†åº“</li><li><strong>cargo</strong> â€” åŒ…ç®¡ç†å’Œæ„å»ºå·¥å…·</li><li><strong>rust-docs</strong> â€” Rust æ–‡æ¡£</li><li><strong>rustfmt</strong> â€” ç”¨æ¥æ ¼å¼åŒ– Rust æºä»£ç </li><li><strong>clippy</strong> â€” Rust çš„ä»£ç æ£€æŸ¥å·¥å…·</li></ul><h4 id="profile"><a href="#profile" class="headerlink" title="profile"></a>profile</h4><p>ä¸åŒçš„ profile åŒ…å«ä¸åŒçš„ç»„ä»¶ï¼Œå®‰è£… rustup æ—¶æœ‰ä¸‰ç§ profile å¯é€‰ï¼š</p><ul><li><strong>minimal</strong> â€” åŒ…å« rustcã€rust-stdã€cargo </li><li><strong>default</strong> â€” åŒ…å« rustcã€rust-stdã€cargoã€rust-docsã€rustfmtã€clippy </li><li><strong>complete</strong> â€” åŒ…å«æ‰€æœ‰ç»„ä»¶</li></ul><p>å¯ä»¥ä½¿ç”¨ <code>rustup set profile</code> å‘½ä»¤ä¿®æ”¹ <code>profile</code>ï¼Œæ¯”å¦‚ï¼š<code>rustup set profile minimal</code>ã€‚</p><h3 id="macOS-amp-linux"><a href="#macOS-amp-linux" class="headerlink" title="macOS &amp; linux"></a>macOS &amp; linux</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span></span><br><span class="line">info: downloading installer</span><br><span class="line"></span><br><span class="line">Welcome to Rust!</span><br><span class="line"></span><br><span class="line">This will download and install the official compiler for the Rust</span><br><span class="line">programming language, and its package manager, Cargo.</span><br><span class="line"></span><br><span class="line">Rustup metadata and toolchains will be installed into the Rustup</span><br><span class="line">home directory, located at:</span><br><span class="line"></span><br><span class="line">  /Users/shenxianghong/.rustup</span><br><span class="line"></span><br><span class="line">This can be modified with the RUSTUP_HOME environment variable.</span><br><span class="line"></span><br><span class="line">The Cargo home directory located at:</span><br><span class="line"></span><br><span class="line">  /Users/shenxianghong/.cargo</span><br><span class="line"></span><br><span class="line">This can be modified with the CARGO_HOME environment variable.</span><br><span class="line"></span><br><span class="line">The cargo, rustc, rustup and other commands will be added to</span><br><span class="line">Cargo&#x27;s bin directory, located at:</span><br><span class="line"></span><br><span class="line">  /Users/shenxianghong/.cargo/bin</span><br><span class="line"></span><br><span class="line">This path will then be added to your PATH environment variable by</span><br><span class="line">modifying the profile files located at:</span><br><span class="line"></span><br><span class="line">  /Users/shenxianghong/.profile</span><br><span class="line">  /Users/shenxianghong/.zshenv</span><br><span class="line"></span><br><span class="line">You can uninstall at any time with rustup self uninstall and</span><br><span class="line">these changes will be reverted.</span><br><span class="line"></span><br><span class="line">Current installation options:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   default host triple: aarch64-apple-darwin</span><br><span class="line">     default toolchain: stable (default)</span><br><span class="line">               profile: default</span><br><span class="line">  modify PATH variable: yes</span><br><span class="line"></span><br><span class="line">1) Proceed with installation (default)</span><br><span class="line">2) Customize installation</span><br><span class="line">3) Cancel installation</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">1</span></span><br><span class="line"></span><br><span class="line">info: profile set to &#x27;default&#x27;</span><br><span class="line">info: default host triple is aarch64-apple-darwin</span><br><span class="line">info: syncing channel updates for &#x27;stable-aarch64-apple-darwin&#x27;</span><br><span class="line">686.2 KiB / 686.2 KiB (100 %) 527.5 KiB/s in  1s ETA:  0s</span><br><span class="line">info: latest update on 2021-12-02, rust version 1.57.0 (f1edd0429 2021-11-29)</span><br><span class="line">info: downloading component &#x27;cargo&#x27;</span><br><span class="line">  3.7 MiB /   3.7 MiB (100 %)   1.2 MiB/s in  1s ETA:  0s</span><br><span class="line">info: downloading component &#x27;clippy&#x27;</span><br><span class="line">info: downloading component &#x27;rust-std&#x27;</span><br><span class="line"> 23.1 MiB /  23.1 MiB (100 %)   4.0 MiB/s in  6s ETA:  0s</span><br><span class="line">info: downloading component &#x27;rustc&#x27;</span><br><span class="line"> 59.4 MiB /  59.4 MiB (100 %)   4.5 MiB/s in 15s ETA:  0s</span><br><span class="line">info: downloading component &#x27;rustfmt&#x27;</span><br><span class="line">info: installing component &#x27;cargo&#x27;</span><br><span class="line">info: installing component &#x27;clippy&#x27;</span><br><span class="line">info: installing component &#x27;rust-std&#x27;</span><br><span class="line"> 23.1 MiB /  23.1 MiB (100 %)  19.4 MiB/s in  1s ETA:  0s</span><br><span class="line">info: installing component &#x27;rustc&#x27;</span><br><span class="line"> 59.4 MiB /  59.4 MiB (100 %)  21.9 MiB/s in  2s ETA:  0s</span><br><span class="line">info: installing component &#x27;rustfmt&#x27;</span><br><span class="line">info: default toolchain set to &#x27;stable-aarch64-apple-darwin&#x27;</span><br><span class="line"></span><br><span class="line">  stable-aarch64-apple-darwin installed - rustc 1.57.0 (f1edd0429 2021-11-29)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Rust is installed now. Great!</span><br><span class="line"></span><br><span class="line">To get started you may need to restart your current shell.</span><br><span class="line">This would reload your PATH environment variable to include</span><br><span class="line">Cargo&#x27;s bin directory ($HOME/.cargo/bin).</span><br><span class="line"></span><br><span class="line">To configure your current shell, run:</span><br><span class="line">source $HOME/.cargo/env</span><br></pre></td></tr></table></figure><h2 id="æ›´æ–°-Rust"><a href="#æ›´æ–°-Rust" class="headerlink" title="æ›´æ–° Rust"></a>æ›´æ–° Rust</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustup update</span></span><br><span class="line">info: syncing channel updates for &#x27;stable-aarch64-apple-darwin&#x27;</span><br><span class="line">info: latest update on 2021-12-02, rust version 1.57.0 (f1edd0429 2021-11-29)</span><br><span class="line">info: downloading component &#x27;rust-src&#x27;</span><br><span class="line">info: downloading component &#x27;cargo&#x27;</span><br><span class="line">info: downloading component &#x27;clippy&#x27;</span><br><span class="line">info: downloading component &#x27;rust-std&#x27;</span><br><span class="line"> 23.1 MiB /  23.1 MiB (100 %)  11.6 MiB/s in  2s ETA:  0s</span><br><span class="line">info: downloading component &#x27;rustc&#x27;</span><br><span class="line"> 59.4 MiB /  59.4 MiB (100 %)  12.6 MiB/s in  4s ETA:  0s</span><br><span class="line">info: downloading component &#x27;rustfmt&#x27;</span><br><span class="line">info: removing previous version of component &#x27;rust-src&#x27;</span><br><span class="line">info: removing previous version of component &#x27;cargo&#x27;</span><br><span class="line">info: removing previous version of component &#x27;clippy&#x27;</span><br><span class="line">info: removing previous version of component &#x27;rust-std&#x27;</span><br><span class="line">info: removing previous version of component &#x27;rustc&#x27;</span><br><span class="line">info: removing previous version of component &#x27;rustfmt&#x27;</span><br><span class="line">info: installing component &#x27;rust-src&#x27;</span><br><span class="line">info: installing component &#x27;cargo&#x27;</span><br><span class="line">info: installing component &#x27;clippy&#x27;</span><br><span class="line">info: installing component &#x27;rust-std&#x27;</span><br><span class="line"> 23.1 MiB /  23.1 MiB (100 %)  18.8 MiB/s in  1s ETA:  0s</span><br><span class="line">info: installing component &#x27;rustc&#x27;</span><br><span class="line"> 59.4 MiB /  59.4 MiB (100 %)  21.3 MiB/s in  2s ETA:  0s</span><br><span class="line">info: installing component &#x27;rustfmt&#x27;</span><br><span class="line">info: checking for self-updates</span><br><span class="line"></span><br><span class="line">  stable-aarch64-apple-darwin updated - rustc 1.57.0 (f1edd0429 2021-11-29) (from rustc 1.53.0 (53cb7b09b 2021-06-17))</span><br><span class="line"></span><br><span class="line">info: cleaning up downloads &amp; tmp directories</span><br></pre></td></tr></table></figure><h2 id="å¸è½½-Rust"><a href="#å¸è½½-Rust" class="headerlink" title="å¸è½½ Rust"></a>å¸è½½ Rust</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustup self uninstall</span></span><br><span class="line">Thanks for hacking in Rust!</span><br><span class="line"></span><br><span class="line">This will uninstall all Rust toolchains and data, and remove</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">HOME/.cargo/bin from your PATH environment variable.</span></span><br><span class="line"></span><br><span class="line">Continue? (y/N) y</span><br><span class="line"></span><br><span class="line">info: removing rustup home</span><br><span class="line">info: removing cargo home</span><br><span class="line">info: removing rustup binaries</span><br><span class="line">info: rustup is uninstalled</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…æ ¡éªŒ"><a href="#å®‰è£…æ ¡éªŒ" class="headerlink" title="å®‰è£…æ ¡éªŒ"></a>å®‰è£…æ ¡éªŒ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustc --version</span></span><br><span class="line">rustc 1.57.0 (f1edd0429 2021-11-29)</span><br></pre></td></tr></table></figure><h2 id="ç¦»çº¿æ–‡æ¡£"><a href="#ç¦»çº¿æ–‡æ¡£" class="headerlink" title="ç¦»çº¿æ–‡æ¡£"></a>ç¦»çº¿æ–‡æ¡£</h2><p><em>å³ rust-docs å·¥å…·ã€‚</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustup doc</span></span><br></pre></td></tr></table></figure><p><strong>rustup doc åœ¨ apple m1 æ¶æ„ä¸‹ï¼Œæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰“å¼€ï¼ŒæŠ¥é”™ä¸º</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">error: couldn&#x27;t open browser: command &#x27;open&#x27; did not execute successfully; exit status: 1</span><br><span class="line">command stderr:</span><br><span class="line">The file /Users/shenxianghong/.rustup/toolchains/stable-aarch64-apple-darwin/share/doc/rust/html/index.html does not exist.</span><br></pre></td></tr></table></figure><p><strong>Workaround</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustup toolchain install stable-x86_64-apple-darwin</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustup doc --toolchain=stable-x86_64-apple-darwin</span></span><br></pre></td></tr></table></figure><blockquote><p> <a href="https://github.com/rust-lang/rustup/issues/2692">https://github.com/rust-lang/rustup/issues/2692</a></p></blockquote><h1 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h1><h2 id="æ–‡ä»¶æ ‡å‡†"><a href="#æ–‡ä»¶æ ‡å‡†" class="headerlink" title="æ–‡ä»¶æ ‡å‡†"></a>æ–‡ä»¶æ ‡å‡†</h2><ul><li>ç¨‹åºæ–‡ä»¶åç¼€åï¼šrs</li><li>æ–‡ä»¶å‘½åè§„èŒƒï¼š hello_world.rsï¼ˆsnake caseï¼‰</li></ul><h2 id="ç¼–è¯‘ä¸è¿è¡Œ"><a href="#ç¼–è¯‘ä¸è¿è¡Œ" class="headerlink" title="ç¼–è¯‘ä¸è¿è¡Œ"></a>ç¼–è¯‘ä¸è¿è¡Œ</h2><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><p><strong>rustc é€‚åˆç®€å•çš„ Rust ç¨‹åºç¼–è¯‘</strong>ï¼Œå³ <code>rustc &lt;file&gt;</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustc main.rs</span></span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æˆåŠŸåï¼Œä¼šç”Ÿæˆä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨ Windows ä¸Šè¿˜ä¼šç”Ÿæˆä¸€ä¸ª .pdb æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«è°ƒè¯•ä¿¡æ¯ã€‚</p><p>ç±»ä¼¼äº Golangï¼Œå½“å¾…ç¼–è¯‘çš„ Rust ç¨‹åºæ–‡ä»¶ä¸­æ²¡æœ‰å…¥å£å‡½æ•°æ—¶ï¼Œä¼šç¼–è¯‘æŠ¥é”™</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustc rust.rs</span></span><br><span class="line">error[E0601]: `main` function not found in crate `rust`</span><br><span class="line"><span class="meta prompt_"> --&gt; </span><span class="language-bash">rust.rs:1:1</span></span><br><span class="line">  |</span><br><span class="line">1 | / fn test() &#123;</span><br><span class="line">2 | |     println!(&quot;test&quot;)</span><br><span class="line">3 | | &#125;</span><br><span class="line">  | |_^ consider adding a `main` function to `rust.rs`</span><br><span class="line"></span><br><span class="line">error: aborting due to previous error</span><br><span class="line"></span><br><span class="line">For more information about this error, try `rustc --explain E0601`.</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h3><p>ç±»ä¼¼äº Golangï¼ŒRust æ˜¯ ahead-of-time ç¼–è¯‘çš„è¯­è¨€ï¼Œå¯æ‰§è¡Œæ–‡ä»¶çš„è¿è¡Œä¸ä¾èµ–äº Rust ç¯å¢ƒã€‚</p><p><strong>Windows</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">.\main.exe</span></span><br></pre></td></tr></table></figure><p><strong>Linux &amp; MacOS</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./main</span></span><br></pre></td></tr></table></figure><h2 id="ç®€å•å‰–æ"><a href="#ç®€å•å‰–æ" class="headerlink" title="ç®€å•å‰–æ"></a>ç®€å•å‰–æ</h2><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å®šä¹‰å‡½æ•°ä½¿ç”¨ <code>fn</code> å…³é”®å­—ï¼Œ<code>main</code> å‡½æ•°çš„ä½œç”¨ä¸ºæ¯ä¸ª Rust å¯æ‰§è¡Œç¨‹åºæœ€å…ˆè¿è¡Œçš„ä»£ç </li><li>Rust çš„ç¼©è¿›æ˜¯ 4 ä¸ªç©ºæ ¼ï¼Œè€Œä¸æ˜¯ tab</li><li>println! æ˜¯ä¸€ä¸ª Rust macroï¼ˆå®ï¼‰ï¼Œå¦‚æœæ˜¯å‡½æ•°çš„è¯ï¼Œå°±æ²¡æœ‰ <code>!</code></li><li>ä»£ç è¡Œä»¥ <code>;</code> ç»“å°¾ï¼Œè¡¨ç¤ºè¡¨è¾¾å¼ç»“æŸï¼Œå…³äºè¡¨è¾¾å¼å’Œè¯­å¥çš„åç»­ä¼šæåˆ°</li></ul>]]></content>
    
    
    <summary type="html">Rust ç®€ä»‹ã€å®‰è£…ä¸ Hello World</summary>
    
    
    
    <category term="Programming" scheme="http://shenxianghong.github.io/categories/Programming/"/>
    
    
    <category term="Rust" scheme="http://shenxianghong.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Golang ã€Web Server ä»£ç ç»“æ„</title>
    <link href="http://shenxianghong.github.io/2021/12/01/2021-12-01%20Golang%20Web%20Server%20%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/"/>
    <id>http://shenxianghong.github.io/2021/12/01/2021-12-01%20Golang%20Web%20Server%20%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/</id>
    <published>2021-11-30T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.036Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="100" style="border: 0px" src="/gallery/golang/logo.svg"></div><hr><h1 id="Open-Source"><a href="#Open-Source" class="headerlink" title="Open Source"></a>Open Source</h1><p><a href="https://github.com/slok/kubewebhook%EF%BC%88Go">https://github.com/slok/kubewebhookï¼ˆGo</a> framework to create Kubernetes mutating and validating webhooks.ï¼‰ã€‚æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»º Kubernetes mutating å’Œ validating webhook çš„ Golang æ¡†æ¶ï¼Œå…¶ä¸­æä¾›äº†ç”¨äºç”Ÿäº§ç¯å¢ƒçš„<a href="https://github.com/slok/k8s-webhook-example">ç¤ºä¾‹æ¨¡æ¿</a>ã€‚</p><h1 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h1><p><a href="https://github.com/shenxianghong/shenxianghong.github.io/tree/main/elegant-code/web-structure">https://github.com/shenxianghong/shenxianghong.github.io/tree/main/elegant-code/web-structure</a></p><h1 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h1><h2 id="handlers"><a href="#handlers" class="headerlink" title="handlers"></a>handlers</h2><p>handlers ä¸­èšç„¦å®é™…çš„ä¸šåŠ¡å¤„ç†é€»è¾‘</p><h3 id="welcome-go"><a href="#welcome-go" class="headerlink" title="welcome.go"></a>welcome.go</h3><p>è¯·æ±‚åˆ°æ¥æ—¶ï¼Œç»„è£…è¿”å›çš„æ¶ˆæ¯å†…å®¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handlers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Welcome æŠ½è±¡äº†ä¸€ç³»åˆ—çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="comment">// ä¾‹å¦‚ Hello ç”¨äºç»„è£…è¿”å›çš„æ¶ˆæ¯å†…å®¹</span></span><br><span class="line"><span class="keyword">type</span> Welcome <span class="keyword">interface</span> &#123;</span><br><span class="line">Hello() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥å£å®ç°</span></span><br><span class="line"><span class="keyword">type</span> WelcomeHandler <span class="keyword">struct</span> &#123;</span><br><span class="line">User <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h WelcomeHandler)</span></span> Hello() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;hello %s, welcome.&quot;</span>, h.User)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å·¥å‚å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWelcomeHandler</span><span class="params">()</span></span> Welcome &#123;</span><br><span class="line"><span class="keyword">var</span> handler WelcomeHandler</span><br><span class="line">handler.User = <span class="string">&quot;Arthur&quot;</span></span><br><span class="line"><span class="keyword">return</span> handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="goodbye-go"><a href="#goodbye-go" class="headerlink" title="goodbye.go"></a>goodbye.go</h3><p>åŸç†ç±»ä¼¼ welcome.go</p><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><p>web æ¡†æ¶çš„åŸºç¡€ç»“æ„</p><h3 id="handlers-go"><a href="#handlers-go" class="headerlink" title="handlers.go"></a>handlers.go</h3><p>è°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼Œæ„å»º http.Handler ç±»å‹ï¼Œä½œä¸ºè¯·æ±‚çš„ handler å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> web</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€»è¾‘è·¯ç”±çš„å·¥å‚å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h handler)</span></span> welcomeHandler() http.Handler &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">w.Write([]<span class="type">byte</span>(h.welcome.Hello()))</span><br><span class="line">w.WriteHeader(http.StatusOK)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h handler)</span></span> goodbyeHandler() http.Handler  &#123;</span><br><span class="line"><span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</span><br><span class="line">w.Write([]<span class="type">byte</span>(h.goodbye.Goodbye()))</span><br><span class="line">w.WriteHeader(http.StatusOK)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="router-go"><a href="#router-go" class="headerlink" title="router.go"></a>router.go</h3><p>ç”¨äºæ³¨å†Œä¸šåŠ¡é€»è¾‘éƒ¨åˆ†çš„è·¯ç”±ï¼Œä¹Ÿå°±æ˜¯å­è·¯ç”±</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> web</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h handler)</span></span> router(router *http.ServeMux) &#123;</span><br><span class="line">    <span class="comment">// é€»è¾‘è·¯ç”±çš„å·¥å‚å‡½æ•°è¿”å› http.Handler ç±»å‹,ç”¨äºæ³¨å†Œå­è·¯ç”±</span></span><br><span class="line">router.Handle(<span class="string">&quot;/welcome&quot;</span>, h.welcomeHandler())</span><br><span class="line">router.Handle(<span class="string">&quot;/goodbye&quot;</span>, h.goodbyeHandler())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="web-go"><a href="#web-go" class="headerlink" title="web.go"></a>web.go</h3><p>web æ¡†æ¶çš„ä¸Šå±‚å¯¹è±¡ï¼ŒåŒ…æ‹¬é…ç½®å’Œæ ¹è·¯ç”± handler çš„ç”Ÿæˆç­‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> web</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;elegant-coding/handlers&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;errors&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="comment">// ä¸Šå±‚ä¼šä¼ å…¥ä¸šåŠ¡é€»è¾‘çš„å·¥å‚å‡½æ•°æ¥åˆå§‹åŒ–è¿™ä¸ªç»“æ„ä½“ï¼ŒåŒæ ·çš„ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥æ¯”å¦‚å…¨å±€çš„ logger ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸‹é¢çš„ handler æ—¶ä¼šæ ¹æ®è¿™ä¸ªé…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">WelcomeHandler handlers.Welcome</span><br><span class="line">GoodbyeHandler handlers.Goodbye</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºåšä¸€äº›æ ¡éªŒè®¾ç½®é»˜è®¤ä¿¡æ¯ç­‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Config)</span></span> defaults() <span class="type">error</span> &#123;</span><br><span class="line"><span class="keyword">if</span> c.WelcomeHandler == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;welcome handler is missing&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> c.GoodbyeHandler == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">&quot;goodbye handler is missing&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è£…äº† http.Handlerï¼ŒåŒæ—¶ä¹ŸåŒ…å«äº†ä¸€ç³»åˆ—çš„ä¸šåŠ¡é€»è¾‘çš„æ¥å£å®ç°</span></span><br><span class="line"><span class="keyword">type</span> handler <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡é€»è¾‘çš„ interface</span></span><br><span class="line">welcome handlers.Welcome</span><br><span class="line">goodbye handlers.Goodbye</span><br><span class="line"><span class="comment">// åŸç”Ÿ http handler åŠŸèƒ½</span></span><br><span class="line">handler http.Handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨åŸç”Ÿçš„ http.Handler.ServeHTTPï¼Œå¯åŠ¨æœåŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h handler)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">h.handler.ServeHTTP(w, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä¸Šé¢çš„ handler</span></span><br><span class="line"><span class="comment">// è¿”å›çš„æ˜¯ä¸€ä¸ª http.Handler ç±»å‹ï¼Œæ˜¯ä¸ºäº†åœ¨ä¸»å‡½æ•°çš„æ—¶å€™ä½œä¸ºæ ¹è·¯ç”±çš„ handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(config Config)</span></span> http.Handler &#123;</span><br><span class="line"><span class="keyword">if</span> err := config.defaults(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">&quot;handler configuration is not valid&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mux := http.NewServeMux()</span><br><span class="line">h := handler&#123;</span><br><span class="line">welcome: config.WelcomeHandler,</span><br><span class="line">goodbye: config.GoodbyeHandler,</span><br><span class="line">handler: mux,</span><br><span class="line">&#125;</span><br><span class="line">h.router(mux)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> h</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;elegant-coding/handlers&quot;</span></span><br><span class="line"><span class="string">&quot;elegant-coding/web&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹è·¯ç”±çš„ handler å‡½æ•°</span></span><br><span class="line">handler := web.New(web.Config&#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡å·¥å‚å‡½æ•°ç”Ÿæˆ handler</span></span><br><span class="line">WelcomeHandler: handlers.NewWelcomeHandler(),</span><br><span class="line">GoodbyeHandler: handlers.NewGoodbyeHandler(),</span><br><span class="line">&#125;)</span><br><span class="line">mux := http.NewServeMux()</span><br><span class="line">mux.Handle(<span class="string">&quot;/&quot;</span>, handler)</span><br><span class="line">server := http.Server&#123;</span><br><span class="line">Addr:    <span class="string">&quot;:8081&quot;</span>,</span><br><span class="line">Handler: mux,</span><br><span class="line">&#125;</span><br><span class="line">err := server.ListenAndServe()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Println(err.Error())</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">è®°ä¸€æ¬¡åœ¨ Kubewebhook é¡¹ç›®ä¸­å­¦åˆ°çš„ web ä»£ç ç»“æ„</summary>
    
    
    
    <category term="Programming" scheme="http://shenxianghong.github.io/categories/Programming/"/>
    
    
    <category term="Golang" scheme="http://shenxianghong.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€æ“ä½œå…ƒæ•°æ®</title>
    <link href="http://shenxianghong.github.io/2021/06/28/2021-06-28%20Velero%20%E6%93%8D%E4%BD%9C%E5%85%83%E6%95%B0%E6%8D%AE/"/>
    <id>http://shenxianghong.github.io/2021/06/28/2021-06-28%20Velero%20%E6%93%8D%E4%BD%9C%E5%85%83%E6%95%B0%E6%8D%AE/</id>
    <published>2021-06-27T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.036Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="éƒ¨ç½²-MinIO-æœåŠ¡"><a href="#éƒ¨ç½²-MinIO-æœåŠ¡" class="headerlink" title="éƒ¨ç½² MinIO æœåŠ¡"></a>éƒ¨ç½² MinIO æœåŠ¡</h1><p><em>ä»¥ Velero æä¾›çš„ <a href="https://github.com/vmware-tanzu/velero/blob/v1.6.3/examples/minio/00-minio-deployment.yaml">MinIO æœåŠ¡</a> è¿›è¡Œ DEMO éªŒè¯ï¼Œä¸ºäº†ä¾¿äºæ“ä½œå°† ClusterIP æ”¹ä¸º NodePort</em></p><h2 id="éƒ¨ç½²ç»“æœ"><a href="#éƒ¨ç½²ç»“æœ" class="headerlink" title="éƒ¨ç½²ç»“æœ"></a>éƒ¨ç½²ç»“æœ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl get all -n velero -l component=minio</span></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/minio-54b5867494-28dvt   1/1     Running   0          80s</span><br><span class="line"></span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">service/minio   NodePort   10.96.107.103   &lt;none&gt;        9000:30188/TCP   80s</span><br><span class="line"></span><br><span class="line">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/minio   1/1     1            1           80s</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/minio-54b5867494   1         1         1       80s</span><br><span class="line"></span><br><span class="line">NAME                    COMPLETIONS   DURATION   AGE</span><br><span class="line">job.batch/minio-setup   1/1           6s         80s</span><br></pre></td></tr></table></figure><p>è´¦å·å¯†ç é€šè¿‡ MinIO æœåŠ¡ä¸­ MINIO_ACCESS_KEY å’Œ MINIO_SECRET_KEY ç¯å¢ƒå˜é‡è®¾ç½®ï¼Œç™»é™†åæ•ˆæœå¦‚ä¸‹ï¼š</p><div align=center><img width="500" style="border: 0px" src="/gallery/velero/minio.png"></div><p><em>å…¶ä¸­ï¼Œminio-setup çš„ Job å·²ç»åˆ›å»ºå‡ºäº†ä¸€ä¸ªåä¸º velero çš„ Bucket</em></p><h2 id="å‡†å¤‡è®¤è¯æ–‡ä»¶"><a href="#å‡†å¤‡è®¤è¯æ–‡ä»¶" class="headerlink" title="å‡†å¤‡è®¤è¯æ–‡ä»¶"></a>å‡†å¤‡è®¤è¯æ–‡ä»¶</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; credentials-velero &lt;&lt;<span class="string">EOF</span></span></span><br><span class="line">[default]</span><br><span class="line">aws_access_key_id = minio</span><br><span class="line">aws_secret_access_key = minio123</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="éƒ¨ç½²-Velero-æœåŠ¡"><a href="#éƒ¨ç½²-Velero-æœåŠ¡" class="headerlink" title="éƒ¨ç½² Velero æœåŠ¡"></a>éƒ¨ç½² Velero æœåŠ¡</h1><h2 id="å‘½ä»¤è¡Œå®‰è£…"><a href="#å‘½ä»¤è¡Œå®‰è£…" class="headerlink" title="å‘½ä»¤è¡Œå®‰è£…"></a>å‘½ä»¤è¡Œå®‰è£…</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">velero</span> <span class="string">install</span> <span class="string">\</span></span><br><span class="line">     <span class="string">--provider</span> <span class="string">aws</span> <span class="string">\</span></span><br><span class="line">     <span class="string">--plugins</span> <span class="string">velero/velero-plugin-for-aws:v1.0.0</span> <span class="string">\</span></span><br><span class="line">     <span class="string">--bucket</span> <span class="string">velero</span> <span class="string">\</span></span><br><span class="line">     <span class="string">--secret-file</span> <span class="string">./credentials-velero</span> <span class="string">\</span></span><br><span class="line">     <span class="string">--use-volume-snapshots=false</span> <span class="string">\</span></span><br><span class="line">     <span class="string">--backup-location-config</span> <span class="string">region=minio,s3ForcePathStyle=&quot;true&quot;,s3Url=http://minio.velero.svc:9000</span></span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜</strong></p><ul><li><code>provider</code> æŒ‡å®š plugin çš„ providerï¼Œé»˜è®¤æ ¼å¼ä¸º x&#x2F;yï¼Œå¦‚æœçœç•¥ x éƒ¨åˆ†ï¼Œåˆ™é»˜è®¤ä¸º velero.ioï¼Œéœ€è¦ä¸ plugin æ³¨å†Œçš„ä¿æŒä¸€è‡´</li><li><code>plugins</code> æŒ‡å®š plugin ä½¿ç”¨çš„é•œåƒ</li><li><code>bucket</code> ä¸ºå¯¹è±¡å­˜å‚¨ä¸­çš„å­˜å‚¨æ¡¶æ¦‚å¿µ</li><li><code>secret-file</code> ç”¨äºä¸åç«¯å­˜å‚¨æœåŠ¡è®¤è¯çš„ä¿¡æ¯ï¼Œå¦‚æœå­˜å‚¨æœåŠ¡ä¸éœ€è¦å‡­è¯ï¼Œåˆ™å°† secret-file æ›¿æ¢æˆ no-secret</li><li><code>use-volume-snapshots</code> æ˜¯å¦è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª SnapshotLocationï¼Œå¦‚æœä¸æ‰“ç®—é€šè¿‡åˆ›å»ºå·å¿«ç…§ï¼Œåˆ™è®¾ç½®ä¸º falseï¼Œé»˜è®¤ä¸º true</li><li><code>backup-location-config</code> ä¸ºé»˜è®¤çš„ BackupStorageLocation ä¿¡æ¯ï¼Œå¯ä»¥åœ¨éƒ¨ç½² Velero åå¢é‡é…ç½®</li></ul><h2 id="éƒ¨ç½²ç»“æœ-1"><a href="#éƒ¨ç½²ç»“æœ-1" class="headerlink" title="éƒ¨ç½²ç»“æœ"></a>éƒ¨ç½²ç»“æœ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get all -n velero -l component=velero</span></span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/velero-64b8fddd66-fqdvt   1/1     Running   0          32s</span><br><span class="line"></span><br><span class="line">NAME                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/velero   1/1     1            1           32s</span><br><span class="line"></span><br><span class="line">NAME                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/velero-64b8fddd66   1         1         1       32s</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get crd -l component=velero</span></span><br><span class="line">NAME                                CREATED AT</span><br><span class="line">backups.velero.io                   2022-11-07T08:54:56Z</span><br><span class="line">backupstoragelocations.velero.io    2022-11-07T08:54:56Z</span><br><span class="line">deletebackuprequests.velero.io      2022-11-07T08:54:56Z</span><br><span class="line">downloadrequests.velero.io          2022-11-07T08:54:56Z</span><br><span class="line">podvolumebackups.velero.io          2022-11-07T08:54:56Z</span><br><span class="line">podvolumerestores.velero.io         2022-11-07T08:54:56Z</span><br><span class="line">resticrepositories.velero.io        2022-11-07T08:54:56Z</span><br><span class="line">restores.velero.io                  2022-11-07T08:54:56Z</span><br><span class="line">schedules.velero.io                 2022-11-07T08:54:56Z</span><br><span class="line">serverstatusrequests.velero.io      2022-11-07T08:54:56Z</span><br><span class="line">volumesnapshotlocations.velero.io   2022-11-07T08:54:56Z</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup-location get</span></span><br><span class="line">NAME      PROVIDER   BUCKET/PREFIX   PHASE       LAST VALIDATED                  ACCESS MODE   DEFAULT</span><br><span class="line">default   aws        velero          Available   2022-11-07 16:55:06 +0800 CST   ReadWrite     true</span><br></pre></td></tr></table></figure><h1 id="æµç¨‹éªŒè¯"><a href="#æµç¨‹éªŒè¯" class="headerlink" title="æµç¨‹éªŒè¯"></a>æµç¨‹éªŒè¯</h1><p><em>ä»¥ Velero æä¾›çš„åŸºç¡€ <a href="https://github.com/vmware-tanzu/velero/blob/v1.6.3/examples/nginx-app/base.yaml">nginx æœåŠ¡</a>è¿›è¡Œ DEMO éªŒè¯</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get all -n nginx-example</span></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-deployment-5bcc46cc5-fmnf4   1/1     Running   0          106s</span><br><span class="line">pod/nginx-deployment-5bcc46cc5-njlhk   1/1     Running   0          106s</span><br><span class="line"></span><br><span class="line">NAME               TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/my-nginx   LoadBalancer   10.96.158.105   &lt;pending&gt;     80:30449/TCP   106s</span><br><span class="line"></span><br><span class="line">NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nginx-deployment   2/2     2            2           106s</span><br><span class="line"></span><br><span class="line">NAME                                         DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nginx-deployment-5bcc46cc5   2         2         2       106s</span><br></pre></td></tr></table></figure><p><strong>æ“ä½œéªŒè¯</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºå¤‡ä»½ä»»åŠ¡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup create default</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup get</span></span><br><span class="line">NAME      STATUS      ERRORS   WARNINGS   CREATED                         EXPIRES   STORAGE LOCATION   SELECTOR</span><br><span class="line">default   Completed   0        0          2022-11-07 17:03:46 +0800 CST   29d       default            &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¨¡æ‹Ÿæ•…éšœ</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl delete ns nginx-example</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºæ¢å¤ä»»åŠ¡</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore create default --from-backup default</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore get</span></span><br><span class="line">NAME                     BACKUP    STATUS      STARTED                         COMPLETED                       ERRORS   WARNINGS   CREATED                         SELECTOR</span><br><span class="line">default-20221107170719   default   Completed   2022-11-07 17:07:19 +0800 CST   2022-11-07 17:08:19 +0800 CST   0        119        2022-11-07 17:07:19 +0800 CST   &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ¢å¤ç»“æœæŸ¥çœ‹</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kubectl get all -n nginx-example</span></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/nginx-deployment-5bcc46cc5-fmnf4   1/1     Running   0          90s</span><br><span class="line">pod/nginx-deployment-5bcc46cc5-njlhk   1/1     Running   0          90s</span><br><span class="line"></span><br><span class="line">NAME               TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">service/my-nginx   LoadBalancer   10.96.27.235   &lt;pending&gt;     80:31162/TCP   59s</span><br><span class="line"></span><br><span class="line">NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nginx-deployment   2/2     2            2           73s</span><br><span class="line"></span><br><span class="line">NAME                                         DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nginx-deployment-5bcc46cc5   2         2         2       89s</span><br></pre></td></tr></table></figure><p>å¯ä»¥åˆæ­¥çœ‹åˆ°ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p><ul><li>Deployment å’Œ Pod åœ¨æ¢å¤ä¹‹åï¼ŒUUID å¹¶æœªå˜åŒ–</li><li>Service å’Œ Pod çš„ IP ä¸ç«¯å£åœ¨æ¢å¤ä¹‹åï¼Œè¢«é‡æ–°åˆ†é…</li></ul><p><strong>MinIO ä¸­ç›¸å…³çš„æ•°æ®</strong></p><div align=center><img width="500" style="border: 0px" src="/gallery/velero/minio-data.png"></div><h1 id="å¤‡ä»½ä¸æ¢å¤æ•°æ®ç»“æ„"><a href="#å¤‡ä»½ä¸æ¢å¤æ•°æ®ç»“æ„" class="headerlink" title="å¤‡ä»½ä¸æ¢å¤æ•°æ®ç»“æ„"></a>å¤‡ä»½ä¸æ¢å¤æ•°æ®ç»“æ„</h1><h2 id="Backup-æ•°æ®ç»“æ„"><a href="#Backup-æ•°æ®ç»“æ„" class="headerlink" title="Backup æ•°æ®ç»“æ„"></a>Backup æ•°æ®ç»“æ„</h2><div align=center><img width="400" style="border: 0px" src="/gallery/velero/backup.png"></div><table><thead><tr><th>name</th><th>content</th></tr></thead><tbody><tr><td>velero-backup.json</td><td>Backup å¯¹è±¡çš„ Json æ ¼å¼</td></tr><tr><td>default-volumesnapshots.json.gz</td><td>Velero ä¸­ VolumeSnapshots å¯¹è±¡çš„ Json æ ¼å¼</td></tr><tr><td>default-podvolumebackups.json.gz</td><td>PodvolumeBackups å¯¹è±¡çš„ Json æ ¼å¼</td></tr><tr><td>default-csi-volumesnapshots.json.gz</td><td>CSI ä¸­ VolumeSnapshots å¯¹è±¡çš„ Json æ ¼å¼</td></tr><tr><td>default-csi-volumesnapshotcontents.json.gz</td><td>CSI ä¸­ VolumeSnapshotsContent å¯¹è±¡çš„ Json æ ¼å¼</td></tr><tr><td>default-logs.gz</td><td>å¤‡ä»½ä»»åŠ¡æ—¥å¿—</td></tr><tr><td>default.tar.gz</td><td>å¤‡ä»½çš„å…¨éƒ¨æ•°æ®ï¼ŒåŒ…æ‹¬ä¸¤å­å†…å®¹ï¼šmetadata å’Œ resourcesï¼Œmetadata æ–‡ä»¶å¤¹ä¸­åŒ…å«ä¸€ä¸ª verison æ–‡ä»¶ï¼Œå†…å®¹ä¸º 1.1.0ï¼›resources æ–‡ä»¶å¤¹ä¸­åŒ…å«å„ç±»èµ„æºå…¨åçš„å­æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚ alertmanagers.monitoring.coreos.comï¼Œé‡Œé¢åŒ…å«ä»¥ namespaces æˆ– cluster åŒºåˆ†çš„èµ„æºå¯¹è±¡çš„ Json æ ¼å¼</td></tr><tr><td>default-resource-list.json.gz</td><td>å¤‡ä»½çš„èµ„æºæ¸…å•ï¼Œæ ¼å¼ä¸º {â€œèµ„æºå…¨åâ€: [å„èµ„æºä¿¡æ¯ï¼Œæ ¼å¼ä¸º ns&#x2F;name]}</td></tr></tbody></table><h2 id="Restore-æ•°æ®ç»“æ„"><a href="#Restore-æ•°æ®ç»“æ„" class="headerlink" title="Restore æ•°æ®ç»“æ„"></a>Restore æ•°æ®ç»“æ„</h2><div align=center><img width="400" style="border: 0px" src="/gallery/velero/restore.png"></div><table><thead><tr><th>name</th><th>content</th></tr></thead><tbody><tr><td>restore-default-20221107170719-results.gz</td><td>æ¢å¤çš„è¯¦æƒ…ä¿¡æ¯ï¼Œæ ¼å¼ä¸º {â€œerrorsâ€:{},â€warningsâ€:{â€œclusterâ€: [â€œå„èµ„æºæ¢å¤å¼‚å¸¸åŸå› â€], â€œå„ namespaceâ€: [â€œå„èµ„æºæ¢å¤å¼‚å¸¸åŸå› â€]}}</td></tr><tr><td>restore-default-20221107170719-logs.gz</td><td>æ¢å¤ä»»åŠ¡æ—¥å¿—</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">é€šè¿‡ Velero å®ç°å¯¹ Kubernetes é›†ç¾¤å…ƒæ•°æ®çš„å¤‡ä»½ä¸æ¢å¤</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Velero ã€å¿«é€Ÿå¼€å§‹</title>
    <link href="http://shenxianghong.github.io/2021/06/07/2021-06-07%20Velero%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"/>
    <id>http://shenxianghong.github.io/2021/06/07/2021-06-07%20Velero%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/</id>
    <published>2021-06-06T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.024Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="170" style="border: 0px" src="/gallery/velero/logo.svg"></div><hr><blockquote><p>based on <strong>v1.6.3</strong></p></blockquote><h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>Velero å¯ä»¥æä¾›å¤‡ä»½å’Œè¿˜åŸ Kubernetes é›†ç¾¤èµ„æºå’ŒæŒä¹…å·çš„èƒ½åŠ›ï¼Œå¯ä»¥åœ¨å…¬æœ‰äº‘æˆ–æœ¬åœ°æ­å»ºçš„ç§æœ‰äº‘ç¯å¢ƒå®‰è£… Veleroï¼Œå¯ä»¥æä¾›ä»¥ä¸‹èƒ½åŠ›ï¼š</p><ul><li>å¤‡ä»½é›†ç¾¤æ•°æ®ï¼Œå¹¶åœ¨é›†ç¾¤æ•…éšœçš„æƒ…å†µä¸‹è¿›è¡Œè¿˜åŸ</li><li>å°†é›†ç¾¤èµ„æºè¿ç§»åˆ°å…¶ä»–é›†ç¾¤</li><li>å°†ç”Ÿäº§é›†ç¾¤å¤åˆ¶åˆ°å¼€å‘å’Œæµ‹è¯•é›†ç¾¤</li></ul><p>Velero åŒ…å«ä¸€ä¸ªåœ¨é›†ç¾¤ä¸Šè¿è¡Œçš„æœåŠ¡å™¨ç«¯å’Œåœ¨æœ¬åœ°è¿è¡Œçš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ã€‚</p><p><a href="https://velero.io/">Velero å®˜æ–¹æ–‡æ¡£</a></p><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero install</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“backup-location-config</td><td>æè¿° BackupStorageLocation çš„é…ç½®ä¿¡æ¯</td></tr><tr><td>â€“bucket</td><td>BackupStorageLocation ä¸­ bucket ä¿¡æ¯ï¼Œå‚è€ƒå¯¹è±¡å­˜å‚¨ä¸­çš„æ¦‚å¿µ<br><em>å’Œ no-default-backup-location å¿…é¡»å­˜åœ¨å…¶ä¸€</em></td></tr><tr><td>â€“cacert</td><td>è¿æ¥ BackupStorageLocation æ—¶æ‰€éœ€è¦çš„ TLS è¯ä¹¦</td></tr><tr><td>â€“crds-only</td><td>ä»…ç”Ÿæˆ CRD èµ„æºç±»åˆ«ï¼Œé»˜è®¤ä¸º false<br><em>ä¸»è¦ç”¨äºå·²ç»å®‰è£… Velero çš„é›†ç¾¤å‡çº§ CRD</em></td></tr><tr><td>â€“crds-version</td><td>é»˜è®¤ä¸º v1ï¼ŒæŒ‡å®š CRD çš„ resource version</td></tr><tr><td>â€“default-restic-prune-frequency</td><td>å¯¹ Restic repo æ‰§è¡Œ restic prune çš„é»˜è®¤å‘¨æœŸï¼Œé»˜è®¤ä¸º 1 å‘¨</td></tr><tr><td>â€“default-volumes-to-restic</td><td>å…¨å±€å‚æ•°ï¼Œè¡¨ç¤ºæ˜¯å¦ç”± Restic å¤‡ä»½æ‰€æœ‰çš„ Pod å·ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>â€“dry-run</td><td>ç”Ÿæˆèµ„æºï¼Œä½†æ˜¯ä¸ä¼šå®é™…åˆ›å»º<br><em>é€šå¸¸ä¼šå’Œ -o å‚æ•°ä¸€èµ·ä½¿ç”¨ï¼ŒæŒ‡å®šé»˜è®¤è¾“å‡ºæ ¼å¼</em></td></tr><tr><td>â€“image</td><td>Velero å’Œ Restic Pod çš„é•œåƒï¼Œé»˜è®¤å’Œ Velero binary ç‰ˆæœ¬ä¸€è‡´</td></tr><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ å±•ç¤º</td></tr><tr><td>â€“no-default-backup-location</td><td>è¡¨ç¤ºæ˜¯å¦åˆ›å»ºé»˜è®¤çš„ BackupStorageLocationï¼Œé»˜è®¤ä¸º false<br><em>å’Œ provider &amp; bucket å¿…é¡»å­˜åœ¨å…¶ä¸€</em></td></tr><tr><td>â€“no-secret</td><td>ä¸ä¸º BackupStorageLocation ç”Ÿæˆè®¤è¯ Secret<br><em>å’Œ â€“secret-file å¿…é¡»å­˜åœ¨å…¶ä¸€</em></td></tr><tr><td>â€“output</td><td>dry runï¼ŒæŒ‡å®šç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yaml</td></tr><tr><td>â€“plugins</td><td>Velero plugin çš„é•œåƒ</td></tr><tr><td>â€“pod-annotations</td><td>Velero å’Œ Restic Pod ä¸­è¿½åŠ çš„æ³¨é‡Šä¿¡æ¯</td></tr><tr><td>â€“prefix</td><td>BackupStorageLocation ä¸­ prefix ä¿¡æ¯ï¼Œå‚è€ƒå¯¹è±¡å­˜å‚¨ä¸­çš„æ¦‚å¿µ</td></tr><tr><td>â€“provider</td><td>æŒ‡å®š StorageProviderï¼Œä¾‹å¦‚ aws, gcp ç­‰<br /><em>å’Œ no-default-backup-location å¿…é¡»å­˜åœ¨å…¶ä¸€</em></td></tr><tr><td>â€“restic-pod-cpu-limit&#x2F;â€“restic-pod-cpu-request&#x2F;<br />â€“restic-pod-mem-limit&#x2F;â€“restic-pod-mem-request</td><td>Restic Pod çš„èµ„æºé™åˆ¶ä¿¡æ¯</td></tr><tr><td>â€“restore-only</td><td>æ˜¯å¦ä»¥ Restore-Only å½¢å¼è¿è¡ŒæœåŠ¡ï¼Œå³ Backupã€Schedule å’Œ GC controller éƒ½ä¼šè¢«ç¦ç”¨ï¼Œä»…å¯åŠ¨ Restore Controller<br><em>å‚æ•°å·²ç»åºŸå¼ƒï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å°† BackupStorageLocation è®¾ä¸º ReadOnly</em></td></tr><tr><td>â€“sa-annotations</td><td>Velero çš„ ServiceAccount ä¸­è¿½åŠ çš„æ³¨é‡Šä¿¡æ¯</td></tr><tr><td>â€“secret-file</td><td>BackupStorageLocation æ‰€éœ€è¦çš„è®¤è¯æ–‡ä»¶<br><em>Velero ä¼šå°†è¯¥æ–‡ä»¶ä»¥ Secret å½¢å¼åˆ›å»ºï¼Œå¹¶æŒ‚è½½åœ¨ Velero çš„ &#x2F;cloud&#x2F;credentialsï¼›å’Œ â€“no-secret å¿…é¡»å­˜åœ¨å…¶ä¸€</em></td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“snapshot-location-config</td><td>æè¿° VolumeSnapshotLocation çš„é…ç½®ä¿¡æ¯</td></tr><tr><td>â€“use-restic</td><td>æ˜¯å¦åŒæ—¶åˆ›å»º Restic æœåŠ¡</td></tr><tr><td>â€“use-volume-snapshots</td><td>æ˜¯å¦è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª SnapshotLocationï¼Œé»˜è®¤ä¸º true</td></tr><tr><td>â€“velero-pod-cpu-limit&#x2F;â€“velero-pod-cpu-request&#x2F;<br />â€“velero-pod-mem-limit&#x2F;â€“velero-pod-mem-request</td><td>Velero Pod çš„èµ„æºé™åˆ¶ä¿¡æ¯</td></tr><tr><td>â€“wait</td><td>é˜»å¡ç›´è‡³ Velero deployment æ˜¯ Ready<br><em>æ‰‹åŠ¨é€€å‡ºç­‰å¾…å¯ä»¥ ctrl-cï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å®‰è£…æµç¨‹</em></td></tr></tbody></table><h2 id="uninstall"><a href="#uninstall" class="headerlink" title="uninstall"></a>uninstall</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero uninstall</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“force</td><td>æ˜¯å¦å¼ºåˆ¶å¸è½½ï¼Œå¿½ç•¥ç¡®è®¤ä¿¡æ¯ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>â€“wait</td><td>é˜»å¡ç›´è‡³ Velero è¢«å®Œå…¨å¸è½½<br/><em>æ‰‹åŠ¨é€€å‡ºç­‰å¾…å¯ä»¥ ctrl-cï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å¸è½½æµç¨‹</em></td></tr></tbody></table><h2 id="Customize"><a href="#Customize" class="headerlink" title="Customize"></a>Customize</h2><h3 id="Velero-Server"><a href="#Velero-Server" class="headerlink" title="Velero Server"></a>Velero Server</h3><p>ä»¥ä¸‹å‚æ•°å‡ä¸º Velero æœåŠ¡å¯åŠ¨æ—¶çš„é¢å¤–å‚æ•°</p><p><em>éƒ¨åˆ†å‚æ•°å¯ä»¥é€šè¿‡ install æŒ‡å®šï¼Œè€Œå…¶ä½™å‚æ•°åªèƒ½é€šè¿‡å®šåˆ¶åŒ– Velero Deployment çš„å¯åŠ¨å‚æ•°</em></p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“log-level</td><td>æ—¥å¿—çº§åˆ«ï¼Œå¯é€‰çš„æœ‰ debugã€infoã€warnã€errorã€fatalã€panic å’Œ traceï¼Œé»˜è®¤ä¸º Info<br><em>åœ¨å®‰è£… velero æœåŠ¡æ—¶çš„å…¨å±€å‚æ•° -v ä»£è¡¨æ—¶ velero è°ƒç”¨å…¶ä»–ç¬¬ä¸‰æ–¹åº“æ—¶é€ä¼ ä¸‹å»çš„æ—¥å¿—çº§åˆ«ï¼Œè€Œé velero æœ¬èº«çš„æ—¥å¿—çº§åˆ«ï¼Œç¬¬ä¸‰æ–¹åº“é‡‡ç”¨çš„æ—¥å¿—åº“é€šå¸¸ä¸º klog æˆ–è€… glog ç­‰ï¼Œé€šè¿‡ -v æŒ‡å®šæ—¥å¿—çº§åˆ«ï¼Œé«˜äºè¯¥çº§åˆ«çš„æ—¥å¿—ä¸ä¼šè¾“å‡ºï¼Œå¦‚ -v &#x3D; 5ã€‚ Velero é‡‡ç”¨çš„æ—¥å¿—åº“ä¸º logrusï¼Œæœ‰ debug ã€ info ã€ warn ã€ error ã€ fatal ã€ panic å’Œ traceï¼Œé€šè¿‡è¯¥å‚æ•°æŒ‡å®šï¼Œä½äºè¯¥çº§åˆ«çš„æ—¥å¿—ä¸ä¼šè¾“å‡ºã€‚</em></td></tr><tr><td>â€“log-format</td><td>æ—¥å¿—æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ text å’Œ jsonï¼Œé»˜è®¤ä¸º text</td></tr><tr><td>â€“plugin-dir</td><td>Velero Plugins çš„å­˜æ”¾ä½ç½®ï¼Œé»˜è®¤ä¸º &#x2F;plugins</td></tr><tr><td>â€“metrics-address</td><td>æš´éœ²è‡³ Prometheus çš„ç«¯å£ï¼Œé»˜è®¤ä¸º 8085</td></tr><tr><td>â€“backup-sync-period</td><td>å¤‡ä»½åŒæ­¥çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿï¼Œè®¾ç½®ä¸º 0 æ—¶è¡¨ç¤ºç¦ç”¨åŒæ­¥</td></tr><tr><td>â€“restic-timeout</td><td>Pod å·å¤‡ä»½ä¸æ¢å¤çš„æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 240 åˆ†é’Ÿ</td></tr><tr><td>â€“restore-only</td><td>æ˜¯å¦ä»¥ Restore-Only å½¢å¼è¿è¡ŒæœåŠ¡ï¼Œå³ Backupã€Schedule å’Œ GC controller éƒ½ä¼šè¢«ç¦ç”¨ï¼Œä»…å¯åŠ¨ Restore Controller <br/><em>å‚æ•°å·²ç»åºŸå¼ƒï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å°† BackupStorageLocation è®¾ä¸º ReadOnly</em></td></tr><tr><td>â€“disable-controllers</td><td>ç¦æ­¢å¯åŠ¨çš„ Controllerï¼Œå¯é€‰çš„æœ‰ Backupã€BackupDeletionã€BackupSyncã€DownloadRequestã€GarbageCollectionã€ResticRepoã€Restoreã€Schedule å’Œ ServerStatusRequestï¼Œé»˜è®¤ä¸ç¦æ­¢</td></tr><tr><td>â€“restore-resource-priorities</td><td>æœŸæœ›çš„èµ„æºæ¢å¤é¡ºåºï¼Œä»»ä½•ä¸åœ¨åˆ—è¡¨ä¸­çš„èµ„æºéƒ½å°†åœ¨ä¼˜å…ˆèµ„æºä¹‹åæŒ‰å­—æ¯é¡ºåºæ¢å¤ï¼Œé»˜è®¤æ¢å¤é¡ºåºä¸º<br />1. customresourcedefinitions<br />2. namespaces<br />3. storageclasses<br />4. volumesnapshotclass.snapshot.storage.k8s.io<br />5. volumesnapshotcontents.snapshot.storage.k8s.io<br />6. volumesnapshots.snapshot.storage.k8s.io<br />7. persistentvolumes<br />8. persistentvolumeclaims<br />9. secrets<br />10. configmaps<br />11. serviceaccounts<br />12. limitranges<br />13. pods<br />14. replicasets.apps<br />15. clusters.cluster.x-k8s.io<br />16. clusterresourcesets.addons.cluster.x-k8s.io</td></tr><tr><td>â€“default-backup-storage-location</td><td>é»˜è®¤çš„ BackupStorageLocation åç§°ï¼Œé»˜è®¤ä¸º default<br /><em>å‚æ•°å·²ç»åºŸå¼ƒï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å°† BackupStorageLocation çš„ â€“default è®¾ç½®ä¸º true</em></td></tr><tr><td>â€“store-validation-frequency</td><td>BackupStorageLocation çš„æ£€éªŒæ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿï¼Œè®¾ç½®ä¸º 0 æ—¶è¡¨ç¤ºç¦ç”¨æ ¡éªŒ</td></tr><tr><td>â€“default-volume-snapshot-locations</td><td>SnapshotProvider çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ provider1:location-01,provider2:location-02</td></tr><tr><td>â€“client-qps</td><td>è®¿é—® Kubernetes API çš„æœ€å¤§ QPSï¼Œé»˜è®¤ä¸º 20ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™ç½®ä¸º 5<br /><em>è¯¦æƒ…æŸ¥çœ‹ client-go</em></td></tr><tr><td>â€“client-burst</td><td>è®¿é—® Kubernetes API çš„æœ€å¤§çªå‘è¯·æ±‚é‡ï¼Œé»˜è®¤ä¸º 30ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™ç½®ä¸º 10<br /><em>è¯¦æƒ…æŸ¥çœ‹ client-go</em></td></tr><tr><td>â€“profiler-address</td><td>pprof ä¿¡æ¯çš„åœ°å€ï¼Œé»˜è®¤ä¸º localhost:6060</td></tr><tr><td>â€“terminating-resource-timeout</td><td>æ¢å¤æœŸé—´ç­‰å¾… PV å’Œ namespace åˆ›å»ºå®Œæˆçš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 10 åˆ†é’Ÿ</td></tr><tr><td>â€“default-backup-ttl</td><td>backup çš„è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ä¸º 30 å¤©</td></tr><tr><td>â€“default-restic-prune-frequency</td><td>å¯¹ Restic repo æ‰§è¡Œ restic prune çš„å‘¨æœŸï¼Œé»˜è®¤ä¸º 1 å‘¨</td></tr><tr><td>â€“default-volumes-to-restic</td><td>æ˜¯å¦ç”± Restic å¤‡ä»½æ‰€æœ‰çš„ Pod å·ï¼Œé»˜è®¤ä¸º false</td></tr></tbody></table><h3 id="Restic-Server"><a href="#Restic-Server" class="headerlink" title="Restic Server"></a>Restic Server</h3><p>ä»¥ä¸‹å‚æ•°å‡ä¸º Restic æœåŠ¡å¯åŠ¨æ—¶çš„é¢å¤–å‚æ•°</p><p><em>ç”±äº Restic ä¸å­˜åœ¨å®‰è£…å‘½ä»¤ï¼Œå› æ­¤åªèƒ½é€šè¿‡å®šåˆ¶åŒ– Restic DaemonSet çš„å¯åŠ¨å‚æ•°</em></p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“log-level</td><td>æ—¥å¿—çº§åˆ«ï¼Œå¯é€‰çš„æœ‰ debugã€infoã€warnã€errorã€fatalã€panic å’Œ traceï¼Œé»˜è®¤ä¸º Info<br><em>åœ¨å®‰è£… velero æœåŠ¡æ—¶çš„å…¨å±€å‚æ•° -v ä»£è¡¨æ—¶ velero è°ƒç”¨å…¶ä»–ç¬¬ä¸‰æ–¹åº“æ—¶é€ä¼ ä¸‹å»çš„æ—¥å¿—çº§åˆ«ï¼Œè€Œé velero æœ¬èº«çš„æ—¥å¿—çº§åˆ«ï¼Œç¬¬ä¸‰æ–¹åº“é‡‡ç”¨çš„æ—¥å¿—åº“é€šå¸¸ä¸º klog æˆ–è€… glog ç­‰ï¼Œé€šè¿‡ -v æŒ‡å®šæ—¥å¿—çº§åˆ«ï¼Œé«˜äºè¯¥çº§åˆ«çš„æ—¥å¿—ä¸ä¼šè¾“å‡ºï¼Œå¦‚ -v &#x3D; 5ã€‚ Velero é‡‡ç”¨çš„æ—¥å¿—åº“ä¸º logrusï¼Œæœ‰ debug ã€ info ã€ warn ã€ error ã€ fatal ã€ panic å’Œ traceï¼Œé€šè¿‡è¯¥å‚æ•°æŒ‡å®šï¼Œä½äºè¯¥çº§åˆ«çš„æ—¥å¿—ä¸ä¼šè¾“å‡ºã€‚</em></td></tr><tr><td>â€“log-format</td><td>æ—¥å¿—æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ text å’Œ jsonï¼Œé»˜è®¤ä¸º text</td></tr></tbody></table><h1 id="ä»“åº“"><a href="#ä»“åº“" class="headerlink" title="ä»“åº“"></a>ä»“åº“</h1><h2 id="StorageProvider"><a href="#StorageProvider" class="headerlink" title="StorageProvider"></a>StorageProvider</h2><p>StorageProvider ç”¨äºå­˜æ”¾å¤‡ä»½è¿‡ç¨‹ä¸­äº§ç”Ÿçš„å…ƒæ•°æ®ä¿¡æ¯ã€ç”± Restic å¤‡ä»½çš„å·æ•°æ®ä¿¡æ¯ã€å¤‡ä»½å’Œæ¢å¤çš„ä»»åŠ¡æ—¥å¿—ç­‰ï¼Œå¯¹åº”çš„èµ„æºå¯¹è±¡ä¸º BackupStorageLocationã€‚</p><h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/main/pkg/apis/velero/v1/backupstoragelocation_types.go">BackupStorageLocation API</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup-location create</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“access-mode</td><td>è®¿é—®æƒé™ï¼Œé»˜è®¤ä¸º ReadWriteï¼Œå¯é€‰å€¼æœ‰ ReadWrite å’Œ ReadOnly</td></tr><tr><td>â€“backup-sync-period</td><td>å¤‡ä»½åŒæ­¥çš„æ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿï¼Œè®¾ç½®ä¸º 0 æ—¶è¡¨ç¤ºç¦ç”¨åŒæ­¥</td></tr><tr><td>â€“bucket</td><td>BackupStorageLocation ä¸­ bucket ä¿¡æ¯ï¼Œå‚è€ƒå¯¹è±¡å­˜å‚¨ä¸­çš„æ¦‚å¿µ</td></tr><tr><td>â€“cacert</td><td>è¿æ¥ BackupStorageLocation æ—¶æ‰€éœ€è¦çš„ TLS è¯ä¹¦</td></tr><tr><td>â€“config</td><td>æè¿° BackupStorageLocation é…ç½®ä¿¡æ¯</td></tr><tr><td>â€“credential</td><td>è¿æ¥ BackupStorageLocation æ‰€éœ€è¦çš„è®¤è¯ä¿¡æ¯<br><em>æ ¼å¼ä¸º key-valueï¼Œkey ä¸º K8s secret çš„åç§°ï¼Œvalue ä¸º secret ä¸­çš„ keyï¼Œä»…æ”¯æŒä¸€å¯¹</em></td></tr><tr><td>â€“default</td><td>æ˜¯å¦ä¸ºé»˜è®¤çš„ BackupStorageLocation</td></tr><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ å±•ç¤º</td></tr><tr><td>â€“labels</td><td>è®¾ç½®åˆ›å»ºå‡ºæ¥çš„ BackupStorageLocation å¯¹è±¡çš„æ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“output</td><td>dry runï¼ŒæŒ‡å®šç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yaml</td></tr><tr><td>â€“prefix</td><td>BackupStorageLocation ä¸­ prefix ä¿¡æ¯ï¼Œå‚è€ƒå¯¹è±¡å­˜å‚¨ä¸­çš„æ¦‚å¿µ</td></tr><tr><td>â€“provider</td><td>æŒ‡å®š StorageProviderï¼Œä¾‹å¦‚ aws, gcp ç­‰</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“validation-frequency</td><td>BackupStorageLocation çš„æ£€éªŒæ—¶é—´é—´éš”ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿï¼Œè®¾ç½®ä¸º 0 æ—¶è¡¨ç¤ºç¦ç”¨æ ¡éªŒ</td></tr></tbody></table><h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup-location delete</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“all</td><td>åˆ é™¤æ‰€æœ‰ BackupStorageLocation å¯¹è±¡</td></tr><tr><td>â€“confirm</td><td>ç¡®è®¤åˆ é™¤äº¤äº’</td></tr><tr><td>â€“selector</td><td>åˆ é™¤æ»¡è¶³æ ‡ç­¾é€‰æ‹©çš„æ‰€æœ‰ BackupStorageLocation å¯¹è±¡</td></tr></tbody></table><p><em>nameï¼Œâ€“all å’Œ â€“selector ä»…èƒ½æŒ‡å®šä¸€ä¸ª</em></p><h3 id="get"><a href="#get" class="headerlink" title="get"></a>get</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup-location get</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“default</td><td>ä»…å±•ç¤ºé»˜è®¤çš„ BackupStorageLocation</td></tr><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ å±•ç¤º</td></tr><tr><td>â€“output</td><td>æ ¼å¼åŒ–è¾“å‡ºçš„æ ·å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yamlï¼Œé»˜è®¤ä¸º table</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å±•ç¤ºç¬¦åˆè¦æ±‚çš„ BackupStorageLocation å¯¹è±¡</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr></tbody></table><h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup-location <span class="built_in">set</span></span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“cacert</td><td>è¿æ¥ BackupStorageLocation æ—¶æ‰€éœ€è¦çš„ TLS è¯ä¹¦</td></tr><tr><td>â€“credential</td><td>è¿æ¥ BackupStorageLocation æ‰€éœ€è¦çš„è®¤è¯ä¿¡æ¯<br><em>æ ¼å¼ä¸º key-valueï¼Œkey ä¸º K8s secret çš„åç§°ï¼Œvalue ä¸º secret ä¸­çš„ keyï¼Œä»…æ”¯æŒä¸€å¯¹</em></td></tr><tr><td>â€“default</td><td>è®¾ç½®ä¸ºé»˜è®¤çš„ BackupStorageLocation<br><em>é»˜è®¤çš„ä»…èƒ½æœ‰ä¸€ä¸ªï¼Œå…¶ä½™çš„ä¼šè¢«è®¾ç½®ä¸º false</em></td></tr></tbody></table><h2 id="SnapshotProvider"><a href="#SnapshotProvider" class="headerlink" title="SnapshotProvider"></a>SnapshotProvider</h2><p>SnapshotProvider ç”¨äºå­˜æ”¾å¤‡ä»½è¿‡ç¨‹ä¸­çš„å·å¿«ç…§æ•°æ®ï¼Œæ•°æ®æºè‡ªäº SnapshotProvider Pluginã€‚</p><h3 id="create-1"><a href="#create-1" class="headerlink" title="create"></a>create</h3><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/main/pkg/apis/velero/v1/volume_snapshot_location.go">VolumeSnapshotLocation API</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero snapshot-location create</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“config</td><td>æè¿° VolumeSnapshotLocation çš„é…ç½®ä¿¡æ¯</td></tr><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œç”¨äºè‡ªå®šä¹‰è¡¨æ ¼æ ä¿¡æ¯</td></tr><tr><td>â€“labels</td><td>è®¾ç½®åˆ›å»ºå‡ºæ¥çš„ VolumeSnapshotLocation å¯¹è±¡çš„æ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“output</td><td>æ ¼å¼åŒ–è¾“å‡ºçš„æ ·å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yamlï¼Œé»˜è®¤ä¸º table</td></tr><tr><td>â€“provider</td><td>æŒ‡å®š SnapshotProviderï¼Œä¾‹å¦‚ aws, gcp ç­‰</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr></tbody></table><h3 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero snapshot-location get</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ ä¿¡æ¯å±•ç¤º</td></tr><tr><td>â€“output</td><td>dry runï¼ŒæŒ‡å®šç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yaml</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨è·å–ç¬¦åˆè¦æ±‚çš„ VolumeSnapshotLocation å¯¹è±¡</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr></tbody></table><h2 id="ResticRepository"><a href="#ResticRepository" class="headerlink" title="ResticRepository"></a>ResticRepository</h2><p>ç›®å‰ Velero ä»…æ”¯æŒ Restic AWSã€AZURE å’Œ GCP ä½œä¸ºå·æ•°æ®å­˜å‚¨ï¼Œæ•°æ®çš„é‡‡é›†å’Œä¼ è¾“å‡ç”± Velero Restic æ“ä½œï¼Œç›®æ ‡ä¼šä¸Šä¼ è‡³å·æ•°æ®å­˜å‚¨ï¼Œå¯¹åº”çš„èµ„æºå¯¹è±¡ä¸º ResticRepositoryã€‚</p><h3 id="repo"><a href="#repo" class="headerlink" title="repo"></a>repo</h3><h4 id="get-2"><a href="#get-2" class="headerlink" title="get"></a>get</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restic repo get</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ ä¿¡æ¯å±•ç¤º</td></tr><tr><td>â€“output</td><td>dry runï¼ŒæŒ‡å®šç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yaml</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨è·å–ç¬¦åˆè¦æ±‚çš„ ResticRepository å¯¹è±¡</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr></tbody></table><h1 id="æ’ä»¶"><a href="#æ’ä»¶" class="headerlink" title="æ’ä»¶"></a>æ’ä»¶</h1><h2 id="add"><a href="#add" class="headerlink" title="add"></a>add</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero plugin add</span></span><br></pre></td></tr></table></figure><p><em>name å°±æ˜¯é•œåƒåœ°å€</em></p><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“image-pull-policy</td><td>plugin é•œåƒçš„æ‹‰å–ç­–ç•¥ï¼Œå¯é€‰çš„æœ‰ Alwaysï¼ŒIfNotPresent å’Œ Neverï¼Œé»˜è®¤ä¸º IfNotPresent</td></tr></tbody></table><h2 id="get-3"><a href="#get-3" class="headerlink" title="get"></a>get</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero plugin get</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“output</td><td>æ ¼å¼åŒ–è¾“å‡ºçš„æ ·å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yamlï¼Œé»˜è®¤ä¸º table</td></tr><tr><td>â€“timeout</td><td>å‘½ä»¤è¾“å‡ºçš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 5 ç§’é’Ÿ</td></tr></tbody></table><h2 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero plugin remove</span></span><br></pre></td></tr></table></figure><h1 id="å¤‡ä»½"><a href="#å¤‡ä»½" class="headerlink" title="å¤‡ä»½"></a>å¤‡ä»½</h1><h2 id="å³æ—¶å¤‡ä»½"><a href="#å³æ—¶å¤‡ä»½" class="headerlink" title="å³æ—¶å¤‡ä»½"></a>å³æ—¶å¤‡ä»½</h2><p>å³æ—¶å¤‡ä»½ï¼ˆon-demandï¼‰ä¹Ÿå°±æ˜¯å•æ¬¡çš„å¤‡ä»½ä»»åŠ¡ï¼Œå¯¹åº”çš„èµ„æºå¯¹è±¡ä¸º Backupã€‚</p><h3 id="create-2"><a href="#create-2" class="headerlink" title="create"></a>create</h3><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/backup.go">Backup API</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup create &lt;name&gt;</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“default-volumes-to-restic</td><td>é»˜è®¤ä¸º trueï¼Œå³ç”± restic å¤‡ä»½æ‰€æœ‰çš„ Pod å·<br /><em>å¦‚æœä¸æŒ‡å®šï¼Œåˆ™ä»¥å…¨å±€çš„ä¸ºä¸»</em></td></tr><tr><td>â€“include-namespaces &#x2F; â€“exclude-namespaces</td><td>æ˜¾å¼åŒ…å«&#x2F;æ’é™¤çš„å‘½åç©ºé—´ï¼Œæ”¯æŒé€—å·åˆ†å‰²</td></tr><tr><td>â€“include-resources &#x2F; â€“exclude-resources</td><td>æ˜¾å¼åŒ…å«&#x2F;æ’é™¤çš„èµ„æºï¼Œæ”¯æŒé€—å·åˆ†å‰²</td></tr><tr><td>â€“from-schedule</td><td>åŸºäºæŸä¸€ä¸ªå®šæ—¶å¤‡ä»½åˆ›å»ºä¸€æ¬¡å³æ—¶å¤‡ä»½<br /><em>æŒ‡å®šæ­¤å‚æ•°æ—¶ï¼Œå…¶ä»–çš„ filter flag å‡ä¼šå¤±æ•ˆï¼Œå¹¶ä»¥ Schedule çš„æ¨¡æ¿ä¸ºå‡†ï¼›ä¸æŒ‡å®šå¤‡ä»½åç§°æ—¶ä¼šä»¥ schedule-timestamp ä½œä¸ºå¤‡ä»½ä»»åŠ¡åç§°</em></td></tr><tr><td>â€“include-cluster-resources</td><td>æ˜¯å¦å¤‡ä»½é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œé»˜è®¤ä¸º true<br /><em>å³ä½¿å¼€å¯äº†æ­¤ç‰¹æ€§ï¼Œå¦‚æœå¹¶æœªå¤‡ä»½å…¨é‡ namespaces çš„èµ„æºï¼Œä»ç„¶ä¸ä¼šå¤‡ä»½é›†ç¾¤çº§åˆ«èµ„æº</em></td></tr><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œç”¨äºè‡ªå®šä¹‰è¡¨æ ¼æ ä¿¡æ¯</td></tr><tr><td>â€“labels</td><td>è®¾ç½®åˆ›å»ºå‡ºæ¥çš„ Backup å¯¹è±¡çš„æ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“ordered-resources</td><td>æŒ‡å®šå¤‡ä»½çš„é¡ºåº<br /><em>é›†ç¾¤çº§åˆ«çš„èµ„æºæ ¼å¼ä¸º <code>resource name</code>ï¼Œéé›†ç¾¤çº§åˆ«çš„èµ„æºæ ¼å¼ä¸º <code>namespace/resource name</code>ï¼Œä¾‹å¦‚ pods&#x3D;ns1&#x2F;pod1,ns1&#x2F;pod2;persistentvolumeclaims&#x3D;ns1&#x2F;pvc4,ns1&#x2F;pvc8</em></td></tr><tr><td>â€“output</td><td>dry runï¼ŒæŒ‡å®šç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yaml</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å¤‡ä»½ç¬¦åˆè¦æ±‚çš„èµ„æº</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“snapshot-volumes</td><td>é»˜è®¤ä¸º trueï¼Œå³å¤‡ä»½æ—¶ï¼Œé»˜è®¤ä¼šå¯¹ PV èµ„æºè°ƒç”¨ SnapshotProvider æ‰“å¿«ç…§</td></tr><tr><td>â€“storage-location</td><td>æŒ‡å®š BackupStorageLocationï¼Œä»…æ”¯æŒå•ä¸ª</td></tr><tr><td>â€“ttl</td><td>è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ 720 å°æ—¶</td></tr><tr><td>â€“volume-snapshot-locations</td><td>æŒ‡å®š VolumeSnapshotLocationï¼Œæ”¯æŒå¤šä¸ª</td></tr><tr><td>â€“wait</td><td>é˜»å¡ç›´è‡³å¤‡ä»½çŠ¶æ€ä¸å†æ˜¯ New æˆ–è€… InProgress<br /><em>æ‰‹åŠ¨é€€å‡ºç­‰å¾…å¯ä»¥ ctrl-cï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å¤‡ä»½ä»»åŠ¡</em></td></tr></tbody></table><h3 id="delete-1"><a href="#delete-1" class="headerlink" title="delete"></a>delete</h3><p>velero backup çš„åˆ é™¤æ¶‰åŠåˆ°å­˜å‚¨åœ¨è¿œç«¯æ•°æ®çš„åŒæ­¥åˆ é™¤ï¼Œå› æ­¤å¹¶éå•çº¯åˆ é™¤ Backup å¯¹è±¡ï¼Œè€Œæ˜¯å€ŸåŠ©äº DeleteBackupRequest å¯¹è±¡ã€‚</p><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/delete_backup_request.go">DeleteBackupRequest API</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup delete</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“all</td><td>åˆ é™¤æ‰€æœ‰èµ„æº</td></tr><tr><td>â€“confirm</td><td>ç¡®è®¤åˆ é™¤äº¤äº’</td></tr><tr><td>â€“selector</td><td>åˆ é™¤æ»¡è¶³æ ‡ç­¾é€‰æ‹©çš„æ‰€æœ‰èµ„æº</td></tr></tbody></table><p><em>nameï¼Œâ€“all å’Œ â€“selector ä»…èƒ½æŒ‡å®šä¸€ä¸ª</em></p><h3 id="describe"><a href="#describe" class="headerlink" title="describe"></a>describe</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup describe</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“cacert</td><td>è¿æ¥ BackupStorageLocation æ—¶æ‰€éœ€è¦çš„ TLS è¯ä¹¦</td></tr><tr><td>â€“details</td><td>æ›´è¯¦ç»†çš„ä¿¡æ¯è¾“å‡º</td></tr><tr><td>â€“insecure-skip-tls-verify</td><td>æ˜¯å¦è·³è¿‡ TLS éªŒè¯ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨è·å–ç¬¦åˆè¦æ±‚çš„ Backup å¯¹è±¡</td></tr></tbody></table><h3 id="download"><a href="#download" class="headerlink" title="download"></a>download</h3><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/download_request_types.go">DownloadRequest CR</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup download</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“cacert</td><td>è¿æ¥ BackupStorageLocation æ—¶æ‰€éœ€è¦çš„ TLS è¯ä¹¦</td></tr><tr><td>â€“force</td><td>ä¸‹è½½æ–‡ä»¶å­˜åœ¨åˆ™è¦†ç›–</td></tr><tr><td>â€“insecure-skip-tls-verify</td><td>æ˜¯å¦è·³è¿‡ TLS éªŒè¯ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>â€“output</td><td>æ–‡ä»¶ä¿å­˜çš„è·¯å¾„ï¼Œé»˜è®¤ä¸ºå½“å‰ç›®å½•ï¼Œåç§°ä¸º &lt;backup&gt;-data.tar.gz</td></tr><tr><td>â€“timeout</td><td>ç­‰å¾…ä¸‹è½½çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 1m</td></tr></tbody></table><h3 id="get-4"><a href="#get-4" class="headerlink" title="get"></a>get</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup get</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ å±•ç¤º</td></tr><tr><td>â€“output</td><td>æ ¼å¼åŒ–è¾“å‡ºçš„æ ·å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yamlï¼Œé»˜è®¤ä¸º table</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å±•ç¤ºç¬¦åˆè¦æ±‚çš„ Backup å¯¹è±¡</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr></tbody></table><h3 id="logs"><a href="#logs" class="headerlink" title="logs"></a>logs</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero backup logs</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“cacert</td><td>è¿æ¥ BackupStorageLocation æ—¶æ‰€éœ€è¦çš„ TLS è¯ä¹¦</td></tr><tr><td>â€“insecure-skip-tls-verify</td><td>æ˜¯å¦è·³è¿‡ TLS éªŒè¯ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>â€“timeout</td><td>ç­‰å¾…è·å–æ—¥å¿—çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿ</td></tr></tbody></table><h2 id="å®šæ—¶å¤‡ä»½"><a href="#å®šæ—¶å¤‡ä»½" class="headerlink" title="å®šæ—¶å¤‡ä»½"></a>å®šæ—¶å¤‡ä»½</h2><p>å®šæ—¶å¤‡ä»½ï¼ˆscheduleï¼‰æ˜¯ç¬¦åˆç‰¹å®šæ—¶é—´è§„å¾‹ï¼Œç”± Velero æ§åˆ¶é¢è´Ÿè´£è§¦å‘çš„å¤‡ä»½ä»»åŠ¡ï¼Œå¯¹åº”çš„èµ„æºå¯¹è±¡ä¸º Scheduleã€‚</p><h3 id="create-3"><a href="#create-3" class="headerlink" title="create"></a>create</h3><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/schedule.go">Schedule CR</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero schedule create</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“default-volumes-to-restic</td><td>æ˜¯å¦ç”± Restic å¤‡ä»½æ‰€æœ‰çš„ Pod å·ï¼Œé»˜è®¤ä¸º true<br /><em>ä¼˜å…ˆçº§å°äº velero install ä¸­çš„å¯¹åº”å‚æ•°</em></td></tr><tr><td>â€“include-cluster-resources</td><td>æ˜¯å¦å¤‡ä»½é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œé»˜è®¤ä¸º true<br /><em>å³ä½¿å¼€å¯äº†æ­¤ç‰¹æ€§ï¼Œå¦‚æœå¹¶æœªå¤‡ä»½å…¨é‡ namespaces çš„èµ„æºï¼Œä»ç„¶ä¸ä¼šå¤‡ä»½é›†ç¾¤çº§åˆ«èµ„æº</em></td></tr><tr><td>â€“include-namespaces &#x2F; â€“exclude-namespaces</td><td>æ˜¾å¼åŒ…å«&#x2F;æ’é™¤çš„å‘½åç©ºé—´ï¼Œæ”¯æŒé€—å·åˆ†å‰²</td></tr><tr><td>â€“include-resources &#x2F; â€“exclude-resources</td><td>æ˜¾å¼åŒ…å«&#x2F;æ’é™¤çš„èµ„æºï¼Œæ”¯æŒé€—å·åˆ†å‰²</td></tr><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ å±•ç¤º</td></tr><tr><td>â€“labels</td><td>è®¾ç½®åˆ›å»ºå‡ºæ¥çš„ Backup å¯¹è±¡çš„æ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“ordered-resources</td><td>æŒ‡å®šå¤‡ä»½çš„é¡ºåº<br /><em>é›†ç¾¤çº§åˆ«çš„èµ„æºæ ¼å¼ä¸º resource nameï¼Œéé›†ç¾¤çº§åˆ«çš„èµ„æºæ ¼å¼ä¸º namespace&#x2F;resource nameï¼Œä¾‹å¦‚ pods&#x3D;ns1&#x2F;pod1,ns1&#x2F;pod2;persistentvolumeclaims&#x3D;ns1&#x2F;pvc4,ns1&#x2F;pvc8</em></td></tr><tr><td>â€“output</td><td>dry runï¼ŒæŒ‡å®šç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yaml</td></tr><tr><td>â€“schedule</td><td>å®šæ—¶è§„åˆ™çš„è¡¨è¾¾å¼<br/>ä¸ä»…æ”¯æŒ cron è¡¨è¾¾å¼ï¼Œè¿˜æ”¯æŒæ˜“è¯»çš„å½¢å¼ï¼Œä¾‹å¦‚ â€œ0 *&#x2F;6 * * *â€ å’Œ @every 6h</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å¤‡ä»½ç¬¦åˆè¦æ±‚çš„èµ„æº</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“snapshot-volumes</td><td>å¤‡ä»½æ—¶ï¼Œæ˜¯å¦ä¼šå¯¹ PV èµ„æºè°ƒç”¨ SnapshotProvider æ‰“å¿«ç…§ï¼Œé»˜è®¤ä¸º trueï¼Œ</td></tr><tr><td>â€“storage-location</td><td>æŒ‡å®š BackupStorageLocationï¼Œä»…æ”¯æŒå•ä¸ª</td></tr><tr><td>â€“ttl</td><td>è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ 720 å°æ—¶</td></tr><tr><td>â€“use-owner-references-in-backup</td><td>ç”± Schedule åˆ›å»ºå‡ºæ¥çš„ Backup æ˜¯å¦å¸¦æœ‰ OwnerReferences ä¿¡æ¯ï¼Œé»˜è®¤ä¸º falseï¼Œ</td></tr><tr><td>â€“volume-snapshot-locations</td><td>å·å¿«ç…§çš„å­˜å‚¨åç«¯ï¼Œæ”¯æŒå¤šä¸ª</td></tr></tbody></table><h3 id="delete-2"><a href="#delete-2" class="headerlink" title="delete"></a>delete</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero schedule delete</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“all</td><td>åˆ é™¤æ‰€æœ‰ Schedule å¯¹è±¡</td></tr><tr><td>â€“confirm</td><td>ç¡®è®¤åˆ é™¤äº¤äº’</td></tr><tr><td>â€“selector</td><td>åˆ é™¤æ»¡è¶³æ ‡ç­¾é€‰æ‹©å™¨çš„æ‰€æœ‰ Schedule å¯¹è±¡</td></tr></tbody></table><h3 id="describe-1"><a href="#describe-1" class="headerlink" title="describe"></a>describe</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero schedule describe</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨è·å–ç¬¦åˆè¦æ±‚çš„ Schedule å¯¹è±¡</td></tr></tbody></table><h3 id="get-5"><a href="#get-5" class="headerlink" title="get"></a>get</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero schedule get</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ å±•ç¤º</td></tr><tr><td>â€“output</td><td>æ ¼å¼åŒ–è¾“å‡ºçš„æ ·å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yamlï¼Œé»˜è®¤ä¸º table</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å±•ç¤ºç¬¦åˆè¦æ±‚çš„ Schedule å¯¹è±¡</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr></tbody></table><h1 id="æ¢å¤"><a href="#æ¢å¤" class="headerlink" title="æ¢å¤"></a>æ¢å¤</h1><h2 id="create-4"><a href="#create-4" class="headerlink" title="create"></a>create</h2><p><a href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/restore.go">Restore API</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore create</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“allow-partially-failed</td><td>åœ¨å¼€å¯ â€“from-schedule æ—¶ï¼Œæ˜¯å¦å…è®¸ä»éƒ¨åˆ†å¤±è´¥çš„ Backup ä¸­æ¢å¤</td></tr><tr><td>â€“include-namespaces &#x2F; â€“exclude-namespaces</td><td>æ˜¾å¼åŒ…å«&#x2F;æ’é™¤çš„å‘½åç©ºé—´ï¼Œæ”¯æŒé€—å·åˆ†å‰²</td></tr><tr><td>â€“include-resources &#x2F; â€“exclude-resources</td><td>æ˜¾å¼åŒ…å«&#x2F;æ’é™¤çš„èµ„æºï¼Œæ”¯æŒé€—å·åˆ†å‰²</td></tr><tr><td>â€“from-backup</td><td>æŒ‡å®šä»å“ªä¸€ä¸ª Backup ä¸­æ¢å¤</td></tr><tr><td>â€“from-schedule</td><td>æŒ‡å®šä»å“ªä¸€ä¸ª Schedule ä¸­æ¢å¤<br><em>ä» Schedule æœ€æ–°åˆ›å»ºçš„ Backup æ¢å¤</em></td></tr><tr><td>â€“include-cluster-resources</td><td>é»˜è®¤ä¸º trueï¼Œå³æ¢å¤é›†ç¾¤çº§åˆ«çš„èµ„æº<br><em>å³ä½¿å¼€å¯äº†æ­¤ç‰¹æ€§ï¼Œå¦‚æœå¹¶æœªæ¢å¤å…¨é‡ namespaces çš„èµ„æºï¼Œä»ç„¶ä¸ä¼šæ¢å¤é›†ç¾¤çº§åˆ«èµ„æº</em></td></tr><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ å±•ç¤º</td></tr><tr><td>â€“labels</td><td>è®¾ç½®åˆ›å»ºå‡ºæ¥çš„ Restore å¯¹è±¡çš„æ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“namespace-mappings</td><td>æ¢å¤æ—¶ï¼Œå‘½åç©ºé—´çš„æ˜ å°„å…³ç³»<br><em>ä¾‹å¦‚ï¼Œsrc1:dst1,src2:dst2</em></td></tr><tr><td>â€“output</td><td>dry runï¼ŒæŒ‡å®šç”Ÿæˆé…ç½®æ–‡ä»¶çš„æ ¼å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yaml</td></tr><tr><td>â€“preserve-nodeports</td><td>æ¢å¤æ—¶ï¼Œæ˜¯å¦ä¿ç•™ Service èµ„æºçš„ NodePort ä¿¡æ¯ï¼Œé»˜è®¤ä¸º trueï¼Œ</td></tr><tr><td>â€“restore-volumes</td><td>æ¢å¤æ—¶ï¼Œæ˜¯å¦ä»å¿«ç…§ä¸­æ¢å¤å·æ•°æ®ï¼Œé»˜è®¤ä¸º true</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æ¢å¤ç¬¦åˆè¦æ±‚çš„èµ„æº</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr><tr><td>â€“wait</td><td>é˜»å¡ç›´è‡³æ¢å¤çŠ¶æ€ä¸å†æ˜¯ New æˆ–è€… InProgress<br><em>æ‰‹åŠ¨é€€å‡ºç­‰å¾…å¯ä»¥ ctrl-cï¼Œå¹¶ä¸ä¼šå½±å“åˆ°æ¢å¤ä»»åŠ¡</em></td></tr></tbody></table><h2 id="delete-3"><a href="#delete-3" class="headerlink" title="delete"></a>delete</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore delete</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“all</td><td>åˆ é™¤æ‰€æœ‰ Restore å¯¹è±¡</td></tr><tr><td>â€“confirm</td><td>ç¡®è®¤åˆ é™¤äº¤äº’</td></tr><tr><td>â€“selector</td><td>åˆ é™¤æ»¡è¶³æ ‡ç­¾é€‰æ‹©å™¨çš„æ‰€æœ‰ Restore å¯¹è±¡</td></tr></tbody></table><h2 id="describe-2"><a href="#describe-2" class="headerlink" title="describe"></a>describe</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore describe</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“cacert</td><td>è¿æ¥ BackupStorageLocation æ—¶æ‰€éœ€è¦çš„ TLS è¯ä¹¦</td></tr><tr><td>â€“details</td><td>æ›´è¯¦ç»†çš„ä¿¡æ¯è¾“å‡º</td></tr><tr><td>â€“insecure-skip-tls-verify</td><td>æ˜¯å¦è·³è¿‡ TLS éªŒè¯ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨è·å–ç¬¦åˆè¦æ±‚çš„ Restore å¯¹è±¡</td></tr></tbody></table><h2 id="get-6"><a href="#get-6" class="headerlink" title="get"></a>get</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore get</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“label-columns</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œè‡ªå®šä¹‰è¡¨æ ¼æ å±•ç¤º</td></tr><tr><td>â€“output</td><td>æ ¼å¼åŒ–è¾“å‡ºçš„æ ·å¼ï¼Œå¯é€‰çš„æœ‰ tableï¼Œjson å’Œ yamlï¼Œé»˜è®¤ä¸º table</td></tr><tr><td>â€“selector</td><td>å¯ä»¥é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å±•ç¤ºç¬¦åˆè¦æ±‚çš„ Restore å¯¹è±¡</td></tr><tr><td>â€“show-labels</td><td>åœ¨ table æ ·å¼ä¸‹ï¼Œæœ€åä¸€æ å±•ç¤ºæ ‡ç­¾ä¿¡æ¯</td></tr></tbody></table><h2 id="logs-1"><a href="#logs-1" class="headerlink" title="logs"></a>logs</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">velero restore logs</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“cacert</td><td>è¿æ¥ BackupStorageLocation æ—¶æ‰€éœ€è¦çš„ TLS è¯ä¹¦</td></tr><tr><td>â€“insecure-skip-tls-verify</td><td>æ˜¯å¦è·³è¿‡ TLS éªŒè¯ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>â€“timeout</td><td>ç­‰å¾…è·å–æ—¥å¿—çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿ</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">é€šè¿‡ Velero å‘½ä»¤è¡Œå·¥å…·å¿«é€Ÿä¸Šæ‰‹ä½¿ç”¨</summary>
    
    
    
    <category term="Disaster Recovery" scheme="http://shenxianghong.github.io/categories/Disaster-Recovery/"/>
    
    
    <category term="Velero" scheme="http://shenxianghong.github.io/tags/Velero/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æºç ç¼–è¯‘</title>
    <link href="http://shenxianghong.github.io/2021/04/22/2021-04-22%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/"/>
    <id>http://shenxianghong.github.io/2021/04/22/2021-04-22%20Kata%20Containers%20%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/</id>
    <published>2021-04-21T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.017Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>2.4.3</strong></p></blockquote><h1 id="Requirement"><a href="#Requirement" class="headerlink" title="Requirement"></a>Requirement</h1><p>è¿™é‡Œé‡‡ç”¨ ubuntu:18.04 å®¹å™¨åŒ–ç¼–è¯‘ï¼Œå„ä¾èµ–ç‰ˆæœ¬å‚è€ƒ<a href="https://github.com/kata-containers/kata-containers/blob/2.4.3/versions.yaml">ç‰ˆæœ¬è¯´æ˜</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker run --privileged -dit -v /sys/fs/cgroup:/sys/fs/cgroup:ro -v /dev:/dev --name kata-build ubuntu:18.04</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">docker <span class="built_in">exec</span> -it kata-build bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯é€‰çš„ TARGET_ARCH æœ‰ amd64 å’Œ arm64</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> TARGET_ARCH=amd64</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> GOPATH=/root/go</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> GOPROXY=https://proxy.golang.com.cn,direct</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> https_proxy=http://10.52.17.42:7890</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p <span class="variable">$GOPATH</span>/bin</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> -p /etc/docker</span></span><br></pre></td></tr></table></figure><h2 id="Dependence"><a href="#Dependence" class="headerlink" title="Dependence"></a>Dependence</h2><ul><li><p>è½¯ä»¶åŒ…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">apt-get update &amp;&amp; apt-get -y install git wget make curl gcc xz-utils sudo flex bison bc python3 ninja-build pkg-config libglib2.0-dev librbd-dev libseccomp-dev libpixman-1-dev apt-utils libcap-ng-dev cpio libpmem-dev libelf-dev</span></span><br></pre></td></tr></table></figure></li><li><p>Golang 1.16.10 - 1.17.3</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://go.dev/dl/go1.16.10.linux-<span class="variable">$TARGET_ARCH</span>.tar.gz &amp;&amp; tar -C /usr/local -zxvf go1.16.10.linux-<span class="variable">$TARGET_ARCH</span>.tar.gz &amp;&amp; <span class="built_in">cp</span> /usr/local/go/bin/go /usr/bin/go</span></span><br></pre></td></tr></table></figure></li><li><p>Rust ï¼ˆ1.58.1ï¼Œä»…åœ¨æ‰‹åŠ¨ç¼–è¯‘ kata-agent ç»„ä»¶æ—¶éœ€è¦ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl https://sh.rustup.rs -sSf | sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">source</span> <span class="variable">$HOME</span>/.cargo/env</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustup override <span class="built_in">set</span> 1.58.1</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> ARCH=$(<span class="built_in">uname</span> -m)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> = <span class="string">&quot;ppc64le&quot;</span> -o <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> = <span class="string">&quot;s390x&quot;</span> ]; <span class="keyword">then</span> <span class="built_in">export</span> LIBC=gnu; <span class="keyword">else</span> <span class="built_in">export</span> LIBC=musl; <span class="keyword">fi</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">[ <span class="variable">$&#123;ARCH&#125;</span> == <span class="string">&quot;ppc64le&quot;</span> ] &amp;&amp; <span class="built_in">export</span> ARCH=powerpc64le</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">rustup target add <span class="variable">$&#123;ARCH&#125;</span>-unknown-linux-<span class="variable">$&#123;LIBC&#125;</span></span></span><br></pre></td></tr></table></figure></li><li><p>yq 3.4.1</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/mikefarah/yq/releases/download/3.4.1/yq_linux_<span class="variable">$TARGET_ARCH</span> &amp;&amp; <span class="built_in">chmod</span> +x yq_linux_<span class="variable">$TARGET_ARCH</span> &amp;&amp; <span class="built_in">mv</span> yq_linux_<span class="variable">$TARGET_ARCH</span> <span class="variable">$GOPATH</span>/bin/yq &amp;&amp; <span class="built_in">cp</span> <span class="variable">$GOPATH</span>/bin/yq /usr/bin/</span></span><br></pre></td></tr></table></figure></li><li><p>docker</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl -sSL https://get.docker.com/ | sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cat</span> &gt; /etc/docker/daemon.json &lt;&lt; <span class="string">EOF</span></span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;storage-driver&quot;: &quot;vfs&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="string">service docker start</span></span></span><br></pre></td></tr></table></figure></li></ul><h2 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h2><ul><li><p>kata-containers 2.4.3</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">GO111MODULE=off go get -d -u github.com/kata-containers/kata-containers</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout 2.4.3</span></span><br></pre></td></tr></table></figure></li><li><p>tests 2.4.3ï¼ˆä»…åœ¨ç¼–è¯‘ UEFI ROM æ—¶éœ€è¦ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">GO111MODULE=off go get -d github.com/kata-containers/tests</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/tests</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout 2.4.3</span></span><br></pre></td></tr></table></figure></li><li><p>qemuï¼ˆx86 ä¸‹ä¸º v6.2.0ï¼Œarm64 ä¸‹ä¸º v6.1.0ï¼Œä»…åœ¨ç¼–è¯‘ QEMU æ—¶éœ€è¦ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">GO111MODULE=off go get -d github.com/qemu/qemu</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$&#123;GOPATH&#125;</span>/src/github.com/qemu/qemu</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout v6.2.0</span></span><br></pre></td></tr></table></figure></li></ul><h1 id="Kata-Containers"><a href="#Kata-Containers" class="headerlink" title="Kata Containers"></a>Kata Containers</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/src/runtime</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make &amp;&amp; sudo -E PATH=<span class="variable">$PATH</span> make install</span></span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ç»“æœ</strong></p><ul><li>&#x2F;usr&#x2F;local&#x2F;bin&#x2F;containerd-shim-kata-v2</li><li>&#x2F;usr&#x2F;local&#x2F;bin&#x2F;kata-collect-data.sh</li><li>&#x2F;usr&#x2F;local&#x2F;bin&#x2F;kata-monitor</li><li>&#x2F;usr&#x2F;local&#x2F;bin&#x2F;kata-runtime</li><li>&#x2F;usr&#x2F;share&#x2F;defaults&#x2F;kata-containers&#x2F;configuration.toml</li></ul><h1 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/tools/osbuilder</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¹æ®ç¤¾åŒº release ä¸­æ‰€æ¨èå¯¹åº”æ¶æ„æ‰€ä½¿ç”¨çš„ image å‘è¡Œç‰ˆï¼Œåˆ†åˆ«è®¾ç½® rootfs å’Œ initrd é•œåƒï¼Œè¿™é‡Œä»¥ x86 æ¶æ„ä¸ºä¾‹</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./rootfs-builder/rootfs.sh -l</span></span><br><span class="line">alpine</span><br><span class="line">centos</span><br><span class="line">clearlinux</span><br><span class="line">debian</span><br><span class="line">ubuntu</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">x86 ä¸‹æ¨è clearlinuxï¼Œarm64 ä¸‹æ¨è ubuntu</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> rootfsdistro=clearlinux</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">x86 å’Œ arm64 ä¸‹å‡æ¨è alpine</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> initrddistro=alpine</span></span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ Kata agentï¼ˆå¯é€‰ï¼‰</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/src/agent &amp;&amp; make</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é»˜è®¤æƒ…å†µä¸‹ï¼ŒKata agent æ˜¯ä½¿ç”¨ seccomp åŠŸèƒ½æ„å»ºçš„ã€‚å¦‚æœè¦æ„å»ºæ²¡æœ‰ seccomp åŠŸèƒ½çš„ Kata agentï¼Œåˆ™éœ€è¦ä½¿ç”¨ SECCOMP=no è¿è¡Œ make</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make -C <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/src/agent SECCOMP=no</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨äº† seccomp ä½†æ„å»ºäº†æ²¡æœ‰ seccomp åŠŸèƒ½çš„ Kata Agentï¼Œåˆ™ runtime ä¼šä¿å®ˆåœ°é€€å‡ºå¹¶æ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯</span></span><br></pre></td></tr></table></figure><h2 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h2><p><strong>åˆ›å»ºé•œåƒæ–‡ä»¶ç³»ç»Ÿ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> ROOTFS_DIR=<span class="variable">$&#123;GOPATH&#125;</span>/src/github.com/kata-containers/kata-containers/tools/osbuilder/rootfs-builder/rootfs</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">rm</span> -rf <span class="variable">$&#123;ROOTFS_DIR&#125;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/tools/osbuilder/rootfs-builder</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">script -fec <span class="string">&#x27;sudo -E GOPATH=$GOPATH USE_DOCKER=true ./rootfs.sh $&#123;rootfsdistro&#125;&#x27;</span></span></span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ  Kata agent</strong></p><p><em>ä»…åœ¨ Kata agent å®šåˆ¶åŒ–åæ·»åŠ </em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo install -o root -g root -m 0550 -t <span class="variable">$&#123;ROOTFS_DIR&#125;</span>/usr/bin ../../../src/agent/target/x86_64-unknown-linux-musl/release/kata-agent</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo install -o root -g root -m 0440 ../../../src/agent/kata-agent.service <span class="variable">$&#123;ROOTFS_DIR&#125;</span>/usr/lib/systemd/system/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo install -o root -g root -m 0440 ../../../src/agent/kata-containers.target <span class="variable">$&#123;ROOTFS_DIR&#125;</span>/usr/lib/systemd/system/</span></span><br></pre></td></tr></table></figure><p><strong>æ„å»ºé•œåƒ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/tools/osbuilder/image-builder</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">script -fec <span class="string">&#x27;sudo -E USE_DOCKER=true ./image_builder.sh $&#123;ROOTFS_DIR&#125;&#x27;</span></span></span><br></pre></td></tr></table></figure><p><strong>å®‰è£…é•œåƒ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">commit=$(git <span class="built_in">log</span> --format=%h -1 HEAD)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">date</span>=$(<span class="built_in">date</span> +%Y-%m-%d-%T.%N%z)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">image=<span class="string">&quot;kata-containers-<span class="variable">$&#123;date&#125;</span>-<span class="variable">$&#123;commit&#125;</span>&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo install -o root -g root -m 0640 -D kata-containers.img <span class="string">&quot;/usr/share/kata-containers/<span class="variable">$&#123;image&#125;</span>&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">(<span class="built_in">cd</span> /usr/share/kata-containers &amp;&amp; sudo <span class="built_in">ln</span> -sf <span class="string">&quot;<span class="variable">$image</span>&quot;</span> kata-containers.img)</span></span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ç»“æœ</strong></p><ul><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;kata-containers-&lt;date&gt;</li><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;kata-containers.img</li></ul><h2 id="initrd"><a href="#initrd" class="headerlink" title="initrd"></a>initrd</h2><p><strong>åˆ›å»ºé•œåƒæ–‡ä»¶ç³»ç»Ÿ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">export</span> ROOTFS_DIR=<span class="string">&quot;<span class="variable">$&#123;GOPATH&#125;</span>/src/github.com/kata-containers/kata-containers/tools/osbuilder/rootfs-builder/rootfs&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">rm</span> -rf <span class="variable">$&#123;ROOTFS_DIR&#125;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/tools/osbuilder/rootfs-builder</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">script -fec <span class="string">&#x27;sudo -E GOPATH=$GOPATH AGENT_INIT=yes USE_DOCKER=true ./rootfs.sh $&#123;initrddistro&#125;&#x27;</span></span></span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ  Kata agent</strong></p><p><em>ä»…åœ¨ Kata agent å®šåˆ¶åŒ–åæ·»åŠ </em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo install -o root -g root -m 0550 -T ../../../src/agent/target/<span class="variable">$&#123;ARCH&#125;</span>-unknown-linux-<span class="variable">$&#123;LIBC&#125;</span>/release/kata-agent <span class="variable">$&#123;ROOTFS_DIR&#125;</span>/sbin/init</span></span><br></pre></td></tr></table></figure><p><strong>æ„å»ºé•œåƒ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/tools/osbuilder/initrd-builder</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">script -fec <span class="string">&#x27;sudo -E AGENT_INIT=yes USE_DOCKER=true ./initrd_builder.sh $&#123;ROOTFS_DIR&#125;&#x27;</span></span></span><br></pre></td></tr></table></figure><p><strong>å®‰è£…é•œåƒ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">commit=$(git <span class="built_in">log</span> --format=%h -1 HEAD)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">date</span>=$(<span class="built_in">date</span> +%Y-%m-%d-%T.%N%z)</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">image=<span class="string">&quot;kata-containers-initrd-<span class="variable">$&#123;date&#125;</span>-<span class="variable">$&#123;commit&#125;</span>&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo install -o root -g root -m 0640 -D kata-containers-initrd.img <span class="string">&quot;/usr/share/kata-containers/<span class="variable">$&#123;image&#125;</span>&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">(<span class="built_in">cd</span> /usr/share/kata-containers &amp;&amp; sudo <span class="built_in">ln</span> -sf <span class="string">&quot;<span class="variable">$image</span>&quot;</span> kata-containers-initrd.img)</span></span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ç»“æœ</strong></p><ul><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;kata-containers-initrd-&lt;date&gt;</li><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;kata-containers-initrd.img</li></ul><h1 id="Hypervisor"><a href="#Hypervisor" class="headerlink" title="Hypervisor"></a>Hypervisor</h1><h2 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">qemu_directory=<span class="variable">$&#123;GOPATH&#125;</span>/src/github.com/qemu/qemu</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">packaging_dir=<span class="string">&quot;<span class="variable">$&#123;GOPATH&#125;</span>/src/github.com/kata-containers/kata-containers/tools/packaging&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$qemu_directory</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ ¹æ®æ¶æ„çš„ QEMUï¼Œåº”ç”¨å¯¹åº”ç‰ˆæœ¬çš„ patch</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="variable">$packaging_dir</span>/scripts/apply_patches.sh <span class="variable">$packaging_dir</span>/qemu/patches/6.2.x/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æœ¬åœ° commit å»é™¤ dirty</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global user.email kata@kata.com</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global user.name kata</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -am <span class="string">&quot;update&quot;</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="variable">$packaging_dir</span>/scripts/configure-hypervisor.sh kata-qemu &gt; kata.cfg</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">eval</span> ./configure <span class="string">&quot;<span class="subst">$(cat kata.cfg)</span>&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">make -j $(<span class="built_in">nproc</span>)</span> </span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo -E make install</span></span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ç»“æœ</strong></p><ul><li>&#x2F;usr&#x2F;bin&#x2F;qemu-system-&lt;arch&gt;</li><li>&#x2F;usr&#x2F;libexec&#x2F;kata-qemu&#x2F;virtiofsd</li><li>&#x2F;usr&#x2F;share&#x2F;kata-qemu&#x2F;qemu&#x2F;*</li></ul><h1 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/kata-containers/tools/packaging/kernel</span></span><br></pre></td></tr></table></figure><p><strong>x86 æ“ä½œ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">x86 ç¯å¢ƒä¸‹åˆ é™¤ arm-experimental ä¸­çš„ patch æ–‡ä»¶ï¼Œé¿å…è¯¯ patch</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf patches/5.15.x/arm-experimental/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build-kernel.sh setup</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build-kernel.sh build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build-kernel.sh install</span></span><br></pre></td></tr></table></figure><p><strong>arm64 æ“ä½œ</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é‡å¤ patch å¯¼è‡´æµç¨‹å¼‚å¸¸ï¼Œæ³¨é‡Šå³å¯</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sed -i <span class="string">&quot;377s/^/#/&quot;</span> build-kernel.sh</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build-kernel.sh -a aarch64 -E -d setup</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build-kernel.sh -a aarch64 -E -d build</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build-kernel.sh -a aarch64 -E -d install</span></span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ç»“æœ</strong></p><ul><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;config-5.15.26</li><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;vmlinux.container</li><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;vmlinux-5.15.26-90</li><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;vmlinuz.container</li><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;vmlinuz-5.15.26-90</li></ul><h1 id="UEFI-ROM"><a href="#UEFI-ROM" class="headerlink" title="UEFI ROM"></a>UEFI ROM</h1><p><em>UEFI ROM ä»…åœ¨ arm64 ç¯å¢ƒä¸‹éœ€è¦ï¼Œç”¨äºè®¾å¤‡çƒ­æ’æ‹”</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/kata-containers/tests</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">.ci/aarch64/install_rom_aarch64.sh</span></span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘ç»“æœ</strong></p><ul><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;kata-flash0.img</li><li>&#x2F;usr&#x2F;share&#x2F;kata-containers&#x2F;kata-flash1.img</li></ul>]]></content>
    
    
    <summary type="html">åŸºäºæºç åœ¨ x86 å’Œ arm64 æ¶æ„ä¸‹å®¹å™¨åŒ–ç¼–è¯‘ Kata Containers çš„å‚è€ƒæµç¨‹</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€å¿«é€Ÿå¼€å§‹</title>
    <link href="http://shenxianghong.github.io/2021/04/15/2021-04-15%20Kata%20Containers%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/"/>
    <id>http://shenxianghong.github.io/2021/04/15/2021-04-15%20Kata%20Containers%20%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B/</id>
    <published>2021-04-14T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:07.016Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>3.0.0</strong></p></blockquote><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>Kata Containers ç¤¾åŒºæä¾›äº† x86 æ¶æ„åˆ¶å“ï¼Œarm64 æ¶æ„åˆ¶å“éœ€è¦æ‰‹åŠ¨ç¼–è¯‘ã€‚è¿™é‡Œä»¥ x86 æ¶æ„çš„ç¤¾åŒºåˆ¶å“å®‰è£…ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">wget https://github.com/kata-containers/kata-containers/releases/download/3.0.0/kata-static-3.0.0-x86_64.tar.xz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar -xvf kata-static-3.0.0-x86_64.tar.xz</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree opt/kata/</span></span><br><span class="line">opt/kata/</span><br><span class="line">â”œâ”€â”€ bin # å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸è„šæœ¬</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ cloud-hypervisor</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd-shim-kata-v2</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ firecracker</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ jailer</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-collect-data.sh</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-monitor</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-runtime</span><br><span class="line">â”‚Â Â  â””â”€â”€ qemu-system-x86_64</span><br><span class="line">â”œâ”€â”€ libexec # å¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶</span><br><span class="line">â”‚Â Â  â””â”€â”€ virtiofsd</span><br><span class="line">â”œâ”€â”€ runtime-rs # Rust å®ç°ä¸‹çš„ shimv2</span><br><span class="line">â”‚Â Â  â””â”€â”€ bin</span><br><span class="line">â”‚Â Â      â””â”€â”€ containerd-shim-kata-v2</span><br><span class="line">â””â”€â”€ share</span><br><span class="line">    â”œâ”€â”€ bash-completion # å‘½ä»¤è¡Œè¡¥å…¨è„šæœ¬</span><br><span class="line">    â”‚Â Â  â””â”€â”€ completions</span><br><span class="line">    â”‚Â Â      â””â”€â”€ kata-runtime</span><br><span class="line">    â”œâ”€â”€ defaults # ä¸åŒ hypervisor å®ç°ä¸‹çš„é™æ€é…ç½®æ–‡ä»¶</span><br><span class="line">    â”‚Â Â  â””â”€â”€ kata-containers</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ configuration-acrn.toml</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ configuration-clh.toml</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ configuration-dragonball.toml</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ configuration-fc.toml</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ configuration-qemu.toml</span><br><span class="line">    â”‚Â Â      â””â”€â”€ configuration.toml -&gt; configuration-qemu.toml</span><br><span class="line">    â”œâ”€â”€ kata-containers # å†…æ ¸ä¸ guest é•œåƒ</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ config-5.19.2</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ kata-alpine-3.15.initrd</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ kata-clearlinux-latest.image</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ kata-containers.img -&gt; kata-clearlinux-latest.image</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ kata-containers-initrd.img -&gt; kata-alpine-3.15.initrd</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ vmlinux-5.19.2-96</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ vmlinux.container -&gt; vmlinux-5.19.2-96</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ vmlinuz-5.19.2-96</span><br><span class="line">    â”‚Â Â  â””â”€â”€ vmlinuz.container -&gt; vmlinuz-5.19.2-96</span><br><span class="line">    â””â”€â”€ kata-qemu # QEMU ä¾èµ–</span><br><span class="line">        â””â”€â”€ qemu</span><br><span class="line">            â”œâ”€â”€ bios-256k.bin</span><br><span class="line">            â”œâ”€â”€ bios.bin</span><br><span class="line">            â”œâ”€â”€ bios-microvm.bin</span><br><span class="line">            â”œâ”€â”€ edk2-aarch64-code.fd</span><br><span class="line">            â”œâ”€â”€ edk2-arm-code.fd</span><br><span class="line">            â”œâ”€â”€ edk2-arm-vars.fd</span><br><span class="line">            â”œâ”€â”€ edk2-i386-code.fd</span><br><span class="line">            â”œâ”€â”€ edk2-i386-secure-code.fd</span><br><span class="line">            â”œâ”€â”€ edk2-i386-vars.fd</span><br><span class="line">            â”œâ”€â”€ edk2-licenses.txt</span><br><span class="line">            â”œâ”€â”€ edk2-x86_64-code.fd</span><br><span class="line">            â”œâ”€â”€ edk2-x86_64-secure-code.fd</span><br><span class="line">            â”œâ”€â”€ efi-virtio.rom</span><br><span class="line">            â”œâ”€â”€ firmware</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 50-edk2-i386-secure.json</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 50-edk2-x86_64-secure.json</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 60-edk2-aarch64.json</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 60-edk2-arm.json</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 60-edk2-i386.json</span><br><span class="line">            â”‚Â Â  â””â”€â”€ 60-edk2-x86_64.json</span><br><span class="line">            â”œâ”€â”€ hppa-firmware.img</span><br><span class="line">            â”œâ”€â”€ kvmvapic.bin</span><br><span class="line">            â”œâ”€â”€ linuxboot.bin</span><br><span class="line">            â”œâ”€â”€ linuxboot_dma.bin</span><br><span class="line">            â”œâ”€â”€ multiboot_dma.bin</span><br><span class="line">            â”œâ”€â”€ pvh.bin</span><br><span class="line">            â”œâ”€â”€ qboot.rom</span><br><span class="line">            â”œâ”€â”€ qemu-nsis.bmp</span><br><span class="line">            â”œâ”€â”€ s390-ccw.img</span><br><span class="line">            â””â”€â”€ s390-netboot.img</span><br></pre></td></tr></table></figure><h1 id="é…ç½®å‚æ•°"><a href="#é…ç½®å‚æ•°" class="headerlink" title="é…ç½®å‚æ•°"></a>é…ç½®å‚æ•°</h1><p>Kata Containers ä¸­é…ç½®çš„ä¼˜å…ˆçº§ä¸ºï¼šåŠ¨æ€é…ç½®é¡¹ &gt; é™æ€é…ç½®é¡¹ &gt; é»˜è®¤å€¼</p><ul><li>åŠ¨æ€é…ç½®é¡¹æ˜¯é€šè¿‡ OCI spec ä¸­çš„ annotations ä¼ é€’ï¼Œä¸»æµçš„ Container Engine å‡å®ç°æ”¯æŒå°†å®¹å™¨ annotations é€ä¼ è‡³ Kata è¿è¡Œæ—¶</li><li>å„ä¸ªåŠ¨æ€ä¸é™æ€é…ç½®é¡¹æ”¯æŒä¸å¦è§† hypervisor å…·ä½“å®ç°çš„èƒ½åŠ›æœ‰æ‰€åŒºåˆ«</li></ul><h2 id="hypervisor"><a href="#hypervisor" class="headerlink" title="hypervisor"></a>hypervisor</h2><p>åŠ¨æ€é…ç½®é¡¹çš„å‰ç¼€ä¸º io.katacontainers.hypervisor.&lt;é™æ€é…ç½®é¡¹&gt;</p><h3 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h3><table><thead><tr><th>é™æ€é…ç½®é¡¹</th><th>åŠ¨æ€é…ç½®</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>path</td><td>Y</td><td>hypervisor å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„</td></tr><tr><td>kernel</td><td>Y</td><td>VM å†…æ ¸è·¯å¾„</td></tr><tr><td>image</td><td>Y</td><td>VM rootfs é•œåƒè·¯å¾„ï¼Œä¸ initrd æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª</td></tr><tr><td>initrd</td><td>Y</td><td>VM rootfs é•œåƒè·¯å¾„ï¼Œä¸ image æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª</td></tr><tr><td>machine_type</td><td>Y</td><td>QEMU æœºå™¨ç±»å‹ï¼Œä¾‹å¦‚ amd64 æ¶æ„ä¸‹ä¸º q35ã€arm64 æ¶æ„ä¸‹ä¸º virt</td></tr><tr><td>confidential_guest</td><td>N</td><td>æ˜¯å¦å¯ç”¨æœºå¯†å®¹å™¨ç‰¹æ€§ã€‚æœºå¯†å®¹å™¨éœ€è¦ host æ”¯æŒ tdxProtectionï¼ˆ<a href="https://software.intel.com/content/www/us/en/develop/articles/intel-trust-domain-extensions.html">Intel Trust Domain Extensions</a>ï¼‰ã€sevProtectionï¼ˆ<a href="https://developer.amd.com/sev/">AMD Secure Encrypted Virtualization</a>ï¼‰ã€pefProtectionï¼ˆ<a href="https://www.kernel.org/doc/html/latest/powerpc/ultravisor.html">IBM POWER 9 Protected Execution Facility</a>ï¼‰ä»¥åŠ seProtectionï¼ˆ<a href="https://www.kernel.org/doc/html/latest/virt/kvm/s390-pv.html">IBM Secure Execution (IBM Z &amp; LinuxONE)</a>ï¼‰ã€‚ä¸æ”¯æŒ CPU å’Œå†…å­˜çš„çƒ­æ’æ‹”ä»¥åŠ NVDIMM è®¾å¤‡ï¼Œä¸æ”¯æŒ arm64 æ¶æ„</td></tr><tr><td>rootless</td><td>Y</td><td>æ˜¯å¦ä»¥é root æƒé™çš„éšæœºç”¨æˆ·å¯åŠ¨ QEMU VMMï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>enable_annotations</td><td>N</td><td>å…è®¸ hypervisor åŠ¨æ€é…ç½®çš„é…ç½®é¡¹</td></tr><tr><td>valid_hypervisor_paths</td><td>N</td><td>ä»¥ glob(3) è§„åˆ™æ ¡éªŒ path å‚æ•°æ˜¯å¦ä¸ºåˆæ³•çš„è·¯å¾„é›†åˆ</td></tr><tr><td>kernel_params</td><td>Y</td><td>VM kernel çš„é¢å¤–é™„åŠ å‚æ•°ï¼Œé»˜è®¤ä¸ºç©º</td></tr><tr><td>firmware</td><td>Y</td><td>å›ºä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸ºç©º</td></tr><tr><td>firmware_volume</td><td>Y</td><td>å›ºä»¶å·è·¯å¾„ï¼Œé»˜è®¤ä¸ºç©º</td></tr><tr><td>machine_accelerators</td><td>Y</td><td>æœºå™¨åŠ é€Ÿå™¨å‚æ•°ï¼Œé»˜è®¤ä¸ºç©º</td></tr><tr><td>seccompsandbox</td><td>N</td><td>seccomp å‚æ•°ã€‚QEMU seccomp sandbox æ˜¯ QEMU VM ä¸­çš„ä¸€ç§å®‰å…¨ç‰¹æ€§ï¼Œé€šè¿‡é™åˆ¶ QEMU è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥æé«˜ VM çš„å®‰å…¨æ€§ã€‚å®ƒä½¿ç”¨äº† Linux å†…æ ¸æä¾›çš„ seccomp æœºåˆ¶ï¼Œå°† QEMU è¿›ç¨‹é™åˆ¶åœ¨ä¸€ç»„å®‰å…¨çš„ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œä»è€Œé™ä½ VM é­å—æ”»å‡»çš„é£é™©ã€‚æ¨èè®¾ç½® &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;bpf_jit_enable æ–‡ä»¶å†…å®¹ä¸º 1ï¼Œä»¥é™ä½è¯¥ç‰¹æ€§å¸¦æ¥çš„æ€§èƒ½ä¸‹é™</td></tr><tr><td>cpu_features</td><td>Y</td><td>CPU ç‰¹æ€§å‚æ•°ï¼Œé»˜è®¤ä¸ºç©º</td></tr><tr><td>default_vcpus</td><td>Y</td><td>VM é»˜è®¤çš„ CPU æ•°é‡ï¼Œé»˜è®¤ä¸º 1ï¼Œæœ€å¤§ä¸º host CPU æ•°é‡</td></tr><tr><td>default_maxvcpus</td><td>Y</td><td>VM æœ€å¤§çš„ CPU æ•°é‡ï¼Œé»˜è®¤ä¸º host CPU æ•°é‡ï¼Œå…·ä½“èƒ½å¦ä½¿ç”¨åˆ° host CPU æ•°é‡ï¼Œè¿˜éœ€è¦è§† hypervisor é™åˆ¶è€Œå®šã€‚è¿‡å¤§çš„ CPU æ•°é‡ä¼šå½±å“åˆ° VM çš„æ€§èƒ½ä»¥åŠå†…å­˜å æ¯”</td></tr><tr><td>default_bridges</td><td>N</td><td>VM é»˜è®¤çš„ PCI æ¡¥æ•°é‡ï¼Œé»˜è®¤ä¸º 1ï¼Œæœ€å¤§ä¸º 5ã€‚ç›®å‰ï¼Œä»…æ”¯æŒ PCI bridgeï¼Œæ¯ä¸ª PCI bridge æœ€å¤šæ”¯æŒ 30 ä¸ªè®¾å¤‡çš„çƒ­æ’æ‹”ï¼Œæ¯ä¸ª VM æœ€å¤šæ”¯æŒ 5 ä¸ª PCI bridgeï¼ˆè¿™å¯èƒ½æ˜¯ QEMU æˆ–å†…æ ¸ä¸­çš„ä¸€ä¸ª bugï¼‰</td></tr><tr><td>default_memory</td><td>Y</td><td>VM é»˜è®¤çš„å†…å­˜æ€»é‡ï¼Œé»˜è®¤ä¸º 1ï¼Œæœ€å¤§ä¸º host å†…å­˜æ€»é‡</td></tr><tr><td>memory_slots</td><td>Y</td><td>VM é»˜è®¤çš„å†…å­˜æ’æ§½æ•°é‡ï¼Œé»˜è®¤ä¸º 10ï¼Œå³å†…å­˜çƒ­æ·»åŠ æ¬¡æ•°ä¸Šé™ä¸º 10</td></tr><tr><td>default_maxmemory</td><td>Y</td><td>VM æœ€å¤§çš„å†…å­˜æ€»é‡ï¼Œé»˜è®¤ä¸º  host å†…å­˜æ€»é‡</td></tr><tr><td>memory_offset</td><td>Y</td><td>VM å†…å­˜åç§»é‡ï¼Œç”¨äºæè¿° NVDIMM è®¾å¤‡çš„å†…å­˜ç©ºé—´ï¼Œå½“ block_device_driver ä¸º nvdimm æ—¶ï¼Œéœ€è¦è®¾ç½®æ­¤å‚æ•°ï¼Œæœ€ç»ˆä¼šè¿½åŠ åˆ° default_maxmemory ä¸­</td></tr><tr><td>enable_virtio_mem</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ virtio-mem è®¾å¤‡ï¼Œé»˜è®¤ä¸º falseã€‚virtio-mem è®¾å¤‡å¯ä»¥æé«˜ VM çš„å†…å­˜æ€§èƒ½ã€‚å®ƒé€šè¿‡åœ¨ host å’Œ VM ä¹‹é—´å…±äº«å†…å­˜ï¼Œä½¿ VM å¯ä»¥ç›´æ¥è®¿é—® host å†…å­˜ï¼Œè€Œæ— éœ€é€šè¿‡å¤åˆ¶æˆ–ä¼ è¾“æ•°æ®ã€‚è¿™ç§ç›´æ¥è®¿é—®å¯æ˜¾è‘—é™ä½å†…å­˜è®¿é—®å»¶è¿Ÿå’Œ CPU ä½¿ç”¨ç‡ï¼Œå¹¶æé«˜ VM çš„æ€§èƒ½å’Œååé‡ã€‚æ¨èè®¾ç½® &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;overcommit_memory æ–‡ä»¶å†…å®¹ä¸º 1</td></tr><tr><td>disable_block_device_use</td><td>Y</td><td>ç¦æ­¢å—è®¾å¤‡ç”¨äºå®¹å™¨çš„ rootfsã€‚ä¾‹å¦‚ devicemapper ä¹‹ç±»çš„å­˜å‚¨é©±åŠ¨ç¨‹åºä¸­ï¼Œå®¹å™¨çš„ rootfs ç”±å—è®¾å¤‡æ”¯æŒï¼Œå‡ºäºæ€§èƒ½åŸå› ï¼Œå—è®¾å¤‡é»˜è®¤ç›´æ¥ä¼ é€’ç»™ hypervisorã€‚ ç¦ç”¨ä¼ é€’æ—¶ï¼Œä¼šç”¨ virtio-fs ä¼ é€’ rootfs</td></tr><tr><td>shared_fs</td><td>Y</td><td>host å’Œ VM ä¹‹é—´å…±äº«æ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œé»˜è®¤ä¸º virtio-fsï¼Œæ­¤å¤–æ”¯æŒ virtio-9p å’Œ virtio-fs-nydus</td></tr><tr><td>virtio_fs_daemon</td><td>Y</td><td>vhost-user-fs å¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„</td></tr><tr><td>valid_virtio_fs_daemon_paths</td><td>N</td><td>ä»¥ glob(3) è§„åˆ™æ ¡éªŒ virtio_fs_daemon å‚æ•°æ˜¯å¦ä¸ºåˆæ³•çš„è·¯å¾„é›†åˆ</td></tr><tr><td>virtio_fs_cache_size</td><td>Y</td><td>DAX ç¼“å­˜å¤§å°ï¼Œé»˜è®¤ä¸º 0 MiBã€‚virtio_fs æ”¯æŒ DAXï¼ˆDirect Accessï¼‰æ¨¡å¼ï¼Œè¿™æ„å‘³ç€ VM å¯ä»¥ç›´æ¥è®¿é—® host çš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œä»è€Œæé«˜äº†è¯»å–å’Œå†™å…¥æ•°æ®çš„é€Ÿåº¦</td></tr><tr><td>virtio_fs_extra_args</td><td>Y</td><td>vhost-user-fs çš„é¢å¤–é™„åŠ å‚æ•°</td></tr><tr><td>virtio_fs_cache</td><td>Y</td><td>virtio-fs æ–‡ä»¶ç³»ç»Ÿåœ¨ VM å’Œ host ä¹‹é—´å…±äº«æ–‡ä»¶æ—¶çš„ç¼“å­˜æ¨¡å¼ï¼Œé»˜è®¤æ˜¯ autoï¼Œæ­¤å¤–æ”¯æŒ none å’Œ alwaysã€‚none è¡¨ç¤º VM ä¸­ä¸ç¼“å­˜æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ã€æ•°æ®å’Œè·¯å¾„åæŸ¥æ‰¾ï¼Œæ‰€æœ‰è¿™äº›ä¿¡æ¯éƒ½éœ€è¦ä» host ä¸­è·å–ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œä»»ä½•å¯¹æ–‡ä»¶çš„ä¿®æ”¹éƒ½ä¼šç«‹å³è¢«æ¨é€åˆ° hostï¼›alway åˆ™æˆªç„¶ç›¸åï¼Œè¡¨ç¤º VM ä¸­çš„æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ã€æ•°æ®å’Œè·¯å¾„åæŸ¥æ‰¾éƒ½ä¼šè¢«ç¼“å­˜ï¼Œå¹¶ä¸”æ°¸ä¸è¿‡æœŸï¼›è€Œ auto è¡¨ç¤º VM ä¸­çš„å…ƒæ•°æ®å’Œè·¯å¾„åæŸ¥æ‰¾ç¼“å­˜ä¼šåœ¨ä¸€å®šæ—¶é—´åè¿‡æœŸï¼ˆé»˜è®¤ä¸º 1 ç§’ï¼‰ï¼Œè€Œæ•°æ®åˆ™ä¼šåœ¨æ–‡ä»¶æ‰“å¼€æ—¶ç¼“å­˜ï¼ˆå³ close-to-open ä¸€è‡´æ€§ï¼‰ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼ŒVM ä¼šæ ¹æ®éœ€è¦ä» host ä¸­è·å–æ–‡ä»¶ä¿¡æ¯ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½ä» host è·å–</td></tr><tr><td>block_device_driver</td><td>Y</td><td>hypervisor ç”¨äºç®¡ç†å®¹å™¨ rootfs çš„å—å­˜å‚¨é©±åŠ¨ç¨‹åºï¼Œé»˜è®¤ä¸º virtio-scsiï¼Œæ­¤å¤–æ”¯æŒ virtio-blk å’Œ nvdimmã€‚virtio-scsi æ˜¯ä¸€ç§åŸºäºSCSI åè®®çš„å­˜å‚¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼›virtio-blk åˆ™æ˜¯ä¸€ç§ç”¨äºå—è®¾å¤‡çš„å­˜å‚¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œåœ¨ä½¿ç”¨ virtio-scsi å’Œ virtio-blk æ—¶ï¼Œhost ä¸Šçš„å—è®¾å¤‡å¯ä»¥è¢« VM è§†ä¸ºæœ¬åœ°çš„å—è®¾å¤‡ï¼Œä»è€Œå¯ä»¥åœ¨ VM ä¸­è¿›è¡Œè¯»å†™æ“ä½œï¼›nvdimm æ˜¯ä¸€ç§ç”¨äºéæ˜“å¤±æ€§å†…å­˜ï¼ˆNVMï¼‰çš„å­˜å‚¨æŠ€æœ¯ã€‚å®ƒå…è®¸å°†å†…å­˜ä½œä¸ºå—è®¾å¤‡ä½¿ç”¨ï¼Œå¹¶æä¾›äº†ä¸ä¼ ç»Ÿå—è®¾å¤‡ç›¸ä¼¼çš„å¯é æ€§å’Œæ•°æ®å®Œæ•´æ€§ä¿æŠ¤</td></tr><tr><td>block_device_aio</td><td>Y</td><td>QEMU ä½¿ç”¨çš„å—è®¾å¤‡å¼‚æ­¥ I&#x2F;O æœºåˆ¶ï¼Œé»˜è®¤ä¸º io_uringï¼Œæ­¤å¤–æ”¯æŒ threads å’Œ nativeã€‚threads è¡¨ç¤º QEMU ä½¿ç”¨åŸºäº pthread çš„ç£ç›˜ I&#x2F;O æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶æ˜¯åœ¨ç”¨æˆ·ç©ºé—´å®ç°çš„ï¼Œå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº« CPU æ—¶é—´ï¼Œä½†æ˜¯æ€§èƒ½æ¯”è¾ƒä¸€èˆ¬ï¼›native è¡¨ç¤º QEMU ä½¿ç”¨æœ¬åœ°çš„ Linux I&#x2F;O æœºåˆ¶ã€‚è¿™ç§æœºåˆ¶æ˜¯åœ¨å†…æ ¸ç©ºé—´å®ç°çš„ï¼Œå¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯éœ€è¦ç‰¹æƒï¼›io_uring è¡¨ç¤º QEMU ä½¿ç”¨ Linux io_uring API æ¥å®ç°å¼‚æ­¥ I&#x2F;Oï¼Œè¿™ç§æœºåˆ¶æä¾›äº† Linux ä¸­æœ€å¿«çš„ I&#x2F;O æ“ä½œï¼Œå¯ä»¥åœ¨ QEMU 5.0 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ä½¿ç”¨ï¼Œä½†éœ€è¦ Linux å†…æ ¸ç‰ˆæœ¬å¤§äº 5.1ï¼Œio_uring æœºåˆ¶å¯ä»¥å‡å°‘ CPU çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ï¼Œæé«˜ I&#x2F;O æ“ä½œçš„æ•ˆç‡</td></tr><tr><td>block_device_cache_set</td><td>Y</td><td>æ˜¯å¦å°†ç¼“å­˜ç›¸å…³é€‰é¡¹è®¾ç½®ç»™å—è®¾å¤‡ï¼Œé»˜è®¤ä¸º falseã€‚è¯¥å‚æ•°å½±å“åˆ° block_device_cache_direct å’Œ block_device_cache_noflush æ˜¯å¦ç”Ÿæ•ˆ</td></tr><tr><td>block_device_cache_direct</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ O_DIRECT é€‰é¡¹ï¼Œé»˜è®¤ä¸º falseã€‚O_DIRECT æ˜¯ä¸€ç§ Linux ç³»ç»Ÿæä¾›çš„é€‰é¡¹ï¼Œå¯ä»¥ç»•è¿‡ host é¡µç¼“å­˜ï¼Œç›´æ¥è®¿é—®å—è®¾å¤‡ï¼Œä»è€Œæé«˜å­˜å‚¨ I&#x2F;O çš„æ€§èƒ½ã€‚å— block_device_cache_set å‚æ•°è®¾ç½®å½±å“</td></tr><tr><td>block_device_cache_noflush</td><td>Y</td><td>æ˜¯å¦å¿½ç•¥å—è®¾å¤‡çš„ç¼“å­˜åˆ·ç›˜è¯·æ±‚ï¼Œé»˜è®¤ä¸º falseã€‚å— block_device_cache_set å‚æ•°è®¾ç½®å½±å“</td></tr><tr><td>enable_iothreads</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ç‹¬ç«‹çš„ I&#x2F;O çº¿ç¨‹ï¼Œé»˜è®¤ä¸º falseã€‚å¯ç”¨æ—¶ï¼Œå—è®¾å¤‡çš„ I&#x2F;O æ“ä½œå°†åœ¨ä¸€ä¸ªå•ç‹¬çš„ I&#x2F;O çº¿ç¨‹ä¸­å¤„ç†ï¼Œè€Œé QEMU çš„ä¸»çº¿ç¨‹ä¸­è¿›è¡Œå¤„ç†ï¼Œå¯ä»¥å‡å°‘äº†ä¸»çº¿ç¨‹çš„é˜»å¡æ—¶é—´ï¼Œæé«˜ VM çš„ I&#x2F;O æ€§èƒ½</td></tr><tr><td>enable_mem_prealloc</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ VM å†…å­˜é¢„åˆ†é…ï¼Œé»˜è®¤ä¸º falseã€‚å¯ç”¨ VM å†…å­˜çš„é¢„åˆ†é…å¯ä»¥ä½¿å†…å­˜åˆ†é…æ›´åŠ ç¨³å®šå’Œå¯é¢„æµ‹ï¼Œä»è€Œæé«˜ VM çš„æ€§èƒ½ã€‚ä½†æ˜¯ï¼Œé¢„åˆ†é…å†…å­˜ä¹Ÿä¼šå ç”¨æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œé™ä½å®¹å™¨å¯†åº¦</td></tr><tr><td>enable_hugepages</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ VM å¤§é¡µå†…å­˜ï¼Œé»˜è®¤ä¸º falseã€‚Huge Pages çš„ç‰¹ç‚¹æ˜¯å°†å†…å­˜åˆ†é…æˆå›ºå®šå¤§å°çš„é¡µï¼ˆé€šå¸¸ä¸º 2MB æˆ– 1GBï¼‰ï¼Œä»è€Œé™ä½äº†é¡µè¡¨çš„å¤§å°å’Œæ“ä½œç³»ç»Ÿå†…æ ¸çš„å¼€é”€ï¼Œä½¿ç”¨ Huge Pages åˆ†é… VM å†…å­˜å¯ä»¥æå‡æ€§èƒ½ã€‚åœ¨å¯ç”¨å¤§é¡µå†…å­˜æ—¶ï¼Œå†…å­˜é¢„åˆ†é…ï¼ˆenable_mem_preallocï¼‰ä¼šè¢«å¼ºåˆ¶è®¾ç½®å¯ç”¨</td></tr><tr><td>enable_vhost_user_store</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ vhost-user å­˜å‚¨è®¾å¤‡ï¼Œé»˜è®¤ä¸º falseã€‚å¯ç”¨ vhost-user å­˜å‚¨è®¾å¤‡å¯ä»¥å°† host ä¸Šçš„å—è®¾å¤‡è™šæ‹ŸåŒ–ä¸ºä¸€ç§å¯ä»¥åœ¨ VM ä¸­ä½¿ç”¨çš„è®¾å¤‡ï¼Œé€šè¿‡ vhost-user åè®®åœ¨ host å’Œ VM ä¹‹é—´ä¼ è¾“æ•°æ®ï¼Œä»è€Œæé«˜ VM çš„å­˜å‚¨æ€§èƒ½ã€‚åœ¨å¯ç”¨ vhost-user å­˜å‚¨è®¾å¤‡æ—¶ï¼ŒLinux ä¸­çš„ä¸€äº›ä¿ç•™å—ç±»å‹ï¼ˆMajor Range 240-254ï¼‰å°†è¢«é€‰æ‹©ç”¨äºè¡¨ç¤º vhost-user è®¾å¤‡</td></tr><tr><td>vhost_user_store_path</td><td>Y</td><td>vhost-user è®¾å¤‡çš„ç›®å½•ï¼Œé»˜è®¤ä¸º &#x2F;var&#x2F;run&#x2F;kata-containers&#x2F;vhost-userã€‚åœ¨è¯¥ç›®å½•ä¸‹ï¼Œâ€blockâ€ å­ç›®å½•ç”¨äºå­˜å‚¨å—è®¾å¤‡ï¼Œâ€block&#x2F;socketsâ€ å­ç›®å½•ç”¨äºå­˜å‚¨ vhost-user socketsï¼Œâ€block&#x2F;devicesâ€ å­ç›®å½•ç”¨äºå­˜å‚¨æ¨¡æ‹Ÿçš„å—è®¾å¤‡èŠ‚ç‚¹</td></tr><tr><td>enable_iommu</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ vIOMMU è®¾å¤‡ï¼Œé»˜è®¤ä¸º falseã€‚vIOMMU ç”¨äºå°† VM çš„ I&#x2F;O æ“ä½œéš”ç¦»åœ¨ä¸€ä¸ªç‹¬ç«‹çš„å†…å­˜åœ°å€ç©ºé—´ä¸­ï¼Œä»¥æé«˜ VM çš„å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚æ­¤å¤–ï¼ŒvIOMMU è¿˜å¯ä»¥æä¾›æ›´å¥½çš„ I&#x2F;O æ€§èƒ½ï¼Œå› ä¸ºå®ƒå¯ä»¥å‡å°‘ VM å’Œ host ä¹‹é—´çš„æ•°æ®ä¼ è¾“æ¬¡æ•°</td></tr><tr><td>enable_iommu_platform</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ IOMMU_PLATFORM è®¾å¤‡ï¼Œé»˜è®¤ä¸º falseã€‚IOMMU_PLATFORM ç”¨äºè®¾å¤‡ DMAï¼ˆDirect Memory Accessï¼‰æ“ä½œéš”ç¦»åœ¨ä¸€ä¸ªç‹¬ç«‹çš„å†…å­˜åœ°å€ç©ºé—´ä¸­ï¼Œä»¥æé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚æ­¤å¤–ï¼ŒIOMMU_PLATFORM è¿˜å¯ä»¥æä¾›æ›´å¥½çš„ DMA æ€§èƒ½ï¼Œå› ä¸ºå®ƒå¯ä»¥å‡å°‘ç³»ç»Ÿå’Œè®¾å¤‡ä¹‹é—´çš„æ•°æ®ä¼ è¾“æ¬¡æ•°ã€‚</td></tr><tr><td>valid_vhost_user_store_paths</td><td>N</td><td>ä»¥ glob(3) è§„åˆ™æ ¡éªŒ vhost_user_store_path å‚æ•°æ˜¯å¦ä¸ºåˆæ³•çš„è·¯å¾„é›†åˆ</td></tr><tr><td>file_mem_backend</td><td>Y</td><td>åŸºäºæ–‡ä»¶çš„å†…å­˜æ”¯æŒçš„è·¯å¾„ï¼Œé»˜è®¤ä¸ºç©ºã€‚åŸºäºæ–‡ä»¶çš„ VM å†…å­˜æ”¯æŒæ˜¯ä¸€ç§å°† VM å†…å­˜ä¿å­˜åœ¨æ–‡ä»¶ä¸­çš„æŠ€æœ¯ï¼Œè€Œä¸æ˜¯ä¿å­˜åœ¨ host çš„ç‰©ç†å†…å­˜ä¸­ã€‚æ­¤å¤–ï¼Œä½¿ç”¨åŸºäºæ–‡ä»¶çš„ VM å†…å­˜è¿˜å¯ä»¥å‡å°‘ VM å’Œ host ä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œä»è€Œæé«˜ VM çš„æ€§èƒ½ã€‚åœ¨ä½¿ç”¨ virtio-fs æ—¶ï¼Œè¯¥é€‰é¡¹ä¼šè‡ªåŠ¨å¯ç”¨ï¼Œå¹¶ä½¿ç”¨ â€œ&#x2F;dev&#x2F;shmâ€ ä½œä¸ºåç«¯æ–‡ä»¶</td></tr><tr><td>valid_file_mem_backends</td><td>N</td><td>ä»¥ glob(3) è§„åˆ™æ ¡éªŒ file_mem_backend å‚æ•°æ˜¯å¦ä¸ºåˆæ³•çš„è·¯å¾„é›†åˆ</td></tr><tr><td>pflashes</td><td>N</td><td>å‘ VM ä¸­æ·»åŠ çš„é•œåƒæ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸ºç©ºã€‚é•œåƒæ–‡ä»¶é€šå¸¸ç”¨äºæ¨¡æ‹Ÿç³»ç»Ÿä¸­çš„ BIOS æˆ– UEFI  å›ºä»¶ç­‰ã€‚ä¾‹å¦‚ï¼Œarm64 æ¶æ„ä¸‹çš„å†…å­˜çƒ­æ’æ‹”åˆ™éœ€è¦æä¾›ä¸€å¯¹ pflash</td></tr><tr><td>enable_debug</td><td>N</td><td>æ˜¯å¦å¯ç”¨ hypervisor å’Œå†…æ ¸çš„ debug å‚æ•°ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>disable_nesting_checks</td><td>N</td><td>æ˜¯å¦ç¦æ­¢åµŒå¥—è™šæ‹ŸåŒ–ç¯å¢ƒæ£€æŸ¥ï¼Œé»˜è®¤ä¸º falseã€‚ç¦ç”¨åµŒå¥—æ£€æŸ¥å¯ä»¥ä»è¿è¡Œæ—¶çš„è¡Œä¸ºä¸åœ¨è£¸æœºä¸Šç›¸åŒ</td></tr><tr><td>msize_9p</td><td>Y</td><td>virtio-9p å…±äº«æ–‡ä»¶ç³»ç»Ÿä¸­æè¿° 9p æ•°æ®åŒ…æœ‰æ•ˆè½½è·çš„å­—èŠ‚æ•°é‡ï¼Œé»˜è®¤ä¸º 8192</td></tr><tr><td>disable_image_nvdimm</td><td>Y</td><td>æ˜¯å¦ç¦æ­¢ä½¿ç”¨ NVDIMM è®¾å¤‡æŒ‚è½½ VM é•œåƒï¼Œé»˜è®¤ä¸º falseã€‚åœ¨æœªç¦ç”¨ä¸”æ”¯æŒ NVDIMM è®¾å¤‡æ—¶ï¼ŒVM é•œåƒä¼šå€ŸåŠ© NVDIMM è®¾å¤‡çƒ­æ·»åŠ ï¼Œå¦åˆ™ï¼Œä½¿ç”¨ virtio-block è®¾å¤‡</td></tr><tr><td>hotplug_vfio_on_root_bus</td><td>Y</td><td>æ˜¯å¦å…è®¸ VFIO è®¾å¤‡åœ¨ root æ€»çº¿ä¸Šçƒ­æ’æ‹”ï¼Œé»˜è®¤ä¸º trueã€‚VFIO æ˜¯ä¸€ç§ç”¨äºè™šæ‹ŸåŒ–ç¯å¢ƒä¸­çš„è®¾å¤‡ç›´é€šæŠ€æœ¯ï¼Œå®ƒå…è®¸å°†ç‰©ç†è®¾å¤‡ç›´æ¥åˆ†é…ç»™ VMï¼Œä»è€Œæé«˜ VM çš„æ€§èƒ½å’Œå¯é æ€§ã€‚ç„¶è€Œï¼Œåœ¨æ¡¥æ¥è®¾å¤‡ä¸Šè¿›è¡Œ VFIO è®¾å¤‡çš„çƒ­æ’æ‹”å­˜åœ¨ä¸€äº›é™åˆ¶ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå…·æœ‰å¤§å‹ PCI æ¡çš„è®¾å¤‡ã€‚å› æ­¤ï¼Œé€šè¿‡å°†è¯¥é€‰é¡¹è®¾ç½®ä¸º trueï¼Œå¯ä»¥åœ¨ root æ€»çº¿ä¸Šå¯ç”¨ VFIO è®¾å¤‡çš„çƒ­æ’æ‹”ï¼Œä»è€Œè§£å†³è¿™äº›é™åˆ¶é—®é¢˜</td></tr><tr><td>pcie_root_port</td><td>Y</td><td>pcie_root_port è®¾å¤‡æ•°é‡ï¼Œé»˜è®¤ä¸º 0ã€‚åœ¨çƒ­æ’æ‹” PCIe è®¾å¤‡ä¹‹å‰éœ€è¦æ·»åŠ  pcie_root_port è®¾å¤‡ï¼Œä¸»è¦é’ˆå¯¹ä½¿ç”¨ä¸€äº›å¤§å‹ PCI æ¡è®¾å¤‡ï¼ˆå¦‚ Nvidia GPUï¼‰çš„æƒ…å†µã€‚ä»…åœ¨å¯ç”¨ hotplug_vfio_on_root_bus ä¸” machine_type ä¸º q35 æ—¶ç”Ÿæ•ˆ</td></tr><tr><td>disable_vhost_net</td><td>Y</td><td>æ˜¯å¦ç¦ç”¨ vhost-net ä½œä¸º virtio-net çš„åç«¯ï¼Œé»˜è®¤ä¸º falseã€‚ä½¿ç”¨ vhost-net æ—¶æ„å‘³ç€åœ¨æé«˜ç½‘ç»œ I&#x2F;O æ€§èƒ½çš„åŒæ—¶ï¼Œä¼šç‰ºç‰²ä¸€å®šçš„å®‰å…¨æ€§ï¼ˆå› ä¸º vhost-net è¿è¡Œåœ¨ ring0 æ¨¡å¼ä¸‹ï¼Œå…·æœ‰æœ€é«˜çš„æƒé™å’Œç‰¹æƒï¼‰</td></tr><tr><td>entropy_source</td><td>Y</td><td>ç†µæºè·¯å¾„ï¼Œé»˜è®¤ä¸º &#x2F;dev&#x2F;urandomï¼Œç”¨äºç”Ÿæˆéšæœºæ•°çš„æ¥æºã€‚&#x2F;dev&#x2F;random æ˜¯ä¸€ä¸ªé˜»å¡çš„ç†µæºï¼Œå¦‚æœ host çš„ç†µæ± ç”¨å°½ï¼ŒVM çš„å¯åŠ¨æ—¶é—´ä¼šå¢åŠ ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¯åŠ¨è¶…æ—¶ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ&#x2F;dev&#x2F;urandom æ˜¯ä¸€ä¸ªéé˜»å¡çš„ç†µæºï¼Œå¯ä»¥é€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯</td></tr><tr><td>valid_entropy_sources</td><td>N</td><td>ä»¥ glob(3) è§„åˆ™æ ¡éªŒ entropy_source å‚æ•°æ˜¯å¦ä¸ºåˆæ³•çš„è·¯å¾„é›†åˆ</td></tr><tr><td>guest_hook_path</td><td>Y</td><td>VM ä¸­ hook è„šæœ¬è·¯å¾„ï¼Œé»˜è®¤ä¸ºç©ºã€‚hook å¿…é¡»æŒ‰ç…§å…¶ hook ç±»å‹å­˜å‚¨åœ¨ guest_hook_path çš„å­ç›®å½•ä¸­ï¼Œä¾‹å¦‚ â€œguest_hook_path&#x2F;{prestart,poststart,poststop}â€ã€‚Kata agent å°†æ‰«æè¿™äº›ç›®å½•æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒæŒ‰å­—æ¯é¡ºåºå°†å…¶æ·»åŠ åˆ°å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå¹¶åœ¨ VM è¿è¡Œæ—¶å‘½åç©ºé—´ä¸­æ‰§è¡Œ</td></tr><tr><td>rx_rate_limiter_max_rate</td><td>Y</td><td>ç½‘ç»œ I&#x2F;O inbound å¸¦å®½é™åˆ¶ï¼Œé»˜è®¤ä¸º 0ï¼Œå³ä¸ä½œé™åˆ¶ã€‚åœ¨ QEMU ä¸­ï¼Œå€ŸåŠ© HTB(Hierarchy Token Bucket) é™åˆ¶ç®¡ç†</td></tr><tr><td>tx_rate_limiter_max_rate</td><td>Y</td><td>ç½‘ç»œ I&#x2F;O outbound å¸¦å®½é™åˆ¶ï¼Œé»˜è®¤ä¸º 0ï¼Œå³ä¸ä½œé™åˆ¶ã€‚åœ¨ QEMU ä¸­ï¼Œå€ŸåŠ© HTB(Hierarchy Token Bucket) é™åˆ¶ç®¡ç†</td></tr><tr><td>guest_memory_dump_path</td><td>N</td><td>VM å†…å­˜è½¬å‚¨æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸ºç©ºã€‚åœ¨å‡ºç° GUEST_PANICKED äº‹ä»¶æ—¶ï¼ŒVM çš„å†…å­˜å°†è¢«è½¬å‚¨åˆ° host æ–‡ä»¶ç³»ç»Ÿä¸‹çš„æŒ‡å®šç›®å½•ä¸­ï¼ˆå¦‚æœè¯¥ç›®å½•ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ã€‚è¢«è½¬å‚¨çš„æ–‡ä»¶ï¼ˆä¹Ÿç§°ä¸º vmcore æ–‡ä»¶ï¼‰å¯ä»¥ä½¿ç”¨ crash æˆ– gdb ç­‰å·¥å…·è¿›è¡Œå¤„ç†ã€‚æ³¨æ„ï¼Œè½¬å‚¨ VM å†…å­˜å¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œå…·ä½“å–å†³äº VM å†…å­˜çš„å¤§å°ï¼Œå¹¶ä¸”ä¼šå ç”¨å¤§é‡ç£ç›˜ç©ºé—´</td></tr><tr><td>guest_memory_dump_paging</td><td>N</td><td>æ˜¯å¦å¯ç”¨ VM å†…å­˜åˆ†é¡µï¼Œé»˜è®¤ä¸º falseã€‚åœ¨ VM å†…å­˜è½¬å‚¨æ—¶ï¼Œå°†ä½¿ç”¨åˆ†é¡µæœºåˆ¶æ¥å¤„ç†è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚å¦‚æœç¦ç”¨è¯¥é€‰é¡¹ï¼Œåˆ™å°†ä½¿ç”¨ç‰©ç†åœ°å€è€Œä¸æ˜¯è™šæ‹Ÿåœ°å€æ¥è¿›è¡Œè½¬å‚¨ã€‚æ¯”å¦‚ï¼Œå¦‚æœå¸Œæœ›ä½¿ç”¨ gdb å·¥å…·è€Œä¸æ˜¯ crash å·¥å…·ï¼Œæˆ–è€…éœ€è¦åœ¨ ELF vmcore ä¸­ä½¿ç”¨VM çš„è™šæ‹Ÿåœ°å€ï¼Œé‚£ä¹ˆåˆ™éœ€è¦å¯ç”¨å†…å­˜åˆ†é¡µåŠŸèƒ½</td></tr><tr><td>enable_guest_swap</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ VM ä¸­çš„äº¤æ¢ç©ºé—´ï¼Œé»˜è®¤ä¸º falseã€‚å¯ç”¨æ—¶ï¼Œä¼šå°†ä¸€ä¸ª raw æ ¼å¼çš„è®¾å¤‡æ·»åŠ åˆ° VM ä¸­ä½œä¸º SWAP è®¾å¤‡ã€‚å¦‚æœ annotations[â€œio.katacontainers.container.resource.swappinessâ€] å¤§äº 0ï¼Œåˆ™æ ¹æ® annotations[â€œio.katacontainers.container.resource.swap_in_bytesâ€] è®¡ç®— SWAP è®¾å¤‡å¤§å°ï¼šé»˜è®¤ä¸º swap_in_bytes - memory_limit_in_bytesï¼›å¦‚æœ swap_in_bytes æœªè®¾ç½®ï¼Œåˆ™ä¸º memory_limit_in_bytesï¼Œå¦‚æœå‡æœªè®¾ç½®ï¼Œåˆ™ä¸º default_memory</td></tr><tr><td>use_legacy_serial</td><td>Y</td><td>æ˜¯å¦ä½¿ç”¨ä¼ ç»Ÿçš„ä¸²è¡Œæ¥å£ä½œä¸º VM æ§åˆ¶å°è®¾å¤‡ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>disable_selinux</td><td>N</td><td>æ˜¯å¦ç¦ç”¨åœ¨ hypervisor ä¸Šåº”ç”¨ SELinuxï¼Œé»˜è®¤ä¸º false</td></tr></tbody></table><h2 id="factory"><a href="#factory" class="headerlink" title="factory"></a>factory</h2><p>ä¸æ”¯æŒåŠ¨æ€é…ç½®é¡¹</p><table><thead><tr><th>é™æ€é…ç½®é¡¹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>enable_template</td><td>æ˜¯å¦å¯ç”¨ VM æ¨¡æ¿ï¼Œé»˜è®¤ä¸º falseã€‚ å¯ç”¨åï¼Œä»æ¨¡æ¿å…‹éš†åˆ›å»ºæ–°çš„ VMã€‚ å®ƒä»¬å°†é€šè¿‡åªè¯»æ˜ å°„å…±äº«ç›¸åŒçš„å†…æ ¸ã€initramfs å’Œ Kata agent å†…å­˜ã€‚ å¦‚æœåœ¨åŒä¸€ host ä¸Šè¿è¡Œè®¸å¤š Kata å®¹å™¨ï¼ŒVM æ¨¡æ¿æœ‰åŠ©äºåŠ å¿«å®¹å™¨çš„åˆ›å»ºå¹¶èŠ‚çœå¤§é‡å†…å­˜ã€‚ä»…æ”¯æŒé•œåƒç±»å‹ä¸º initrd</td></tr><tr><td>template_path</td><td>VM æ¨¡æ¿ä¿å­˜çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º &#x2F;run&#x2F;vc&#x2F;vm&#x2F;template</td></tr><tr><td>vm_cache_number</td><td>VMCache çš„æ•°é‡ï¼Œé»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºç¦ç”¨ VMCacheã€‚VMCache æ˜¯ä¸€ç§åœ¨ä½¿ç”¨ä¹‹å‰å°† VM åˆ›å»ºä¸ºç¼“å­˜çš„åŠŸèƒ½ï¼Œæœ‰åŠ©äºåŠ å¿«å®¹å™¨çš„åˆ›å»ºã€‚ è¯¥åŠŸèƒ½ç”±æœåŠ¡å™¨å’Œé€šè¿‡ Unix socket è¿›è¡Œé€šä¿¡çš„å®¢æˆ·ç«¯ç»„æˆï¼ŒæœåŠ¡å™¨å°†åˆ›å»ºä¸€äº› VM å¹¶ç¼“å­˜èµ·æ¥ã€‚å¦‚æœå¯ç”¨äº† VMCache åŠŸèƒ½ï¼Œkata-runtime åœ¨åˆ›å»ºæ–°çš„ sandbox æ—¶ä¼šå‘ VMCache æœåŠ¡å™¨è¯·æ±‚ VM</td></tr><tr><td>vm_cache_endpoint</td><td>VMCache æœåŠ¡å™¨çš„ socket åœ°å€ï¼Œé»˜è®¤ä¸º &#x2F;var&#x2F;run&#x2F;kata-containers&#x2F;cache.sock</td></tr></tbody></table><h2 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h2><p>åŠ¨æ€é…ç½®é¡¹çš„å‰ç¼€ä¸º io.katacontainers.config.runtime.&lt;é™æ€é…ç½®é¡¹&gt;</p><table><thead><tr><th>é™æ€é…ç½®é¡¹</th><th>åŠ¨æ€é…ç½®</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>enable_debug</td><td>N</td><td>æ˜¯å¦å¯ç”¨ containerd-shim-kata-v2 çš„ debug å‚æ•°ï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>internetworking_model</td><td>Y</td><td>VM ä¸å®¹å™¨ç½‘ç»œçš„è¿é€šæ–¹å¼ï¼Œé»˜è®¤ä¸º tcfilterï¼Œæ­¤å¤–æ”¯æŒ tcfilterã€macvtap å’Œ noneã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œtap è®¾å¤‡éƒ½æ˜¯åˆ›å»ºçš„ï¼ŒåŒºåˆ«åœ¨äº tap è®¾å¤‡å’Œå®¹å™¨ç½‘ç»œæ˜¯å¦‚ä½•æ‰“é€šçš„</td></tr><tr><td>disable_guest_seccomp</td><td>Y</td><td>æ˜¯å¦åœ¨ VM ä¸­å¯ç”¨ seccomp ç‰¹æ€§ï¼Œé»˜è®¤ä¸º falseã€‚å¯ç”¨æ—¶ï¼Œseccomp é…ç½®æ–‡ä»¶ä¼šç”± Kata agent ä¼ é€’åˆ° VM ä¸­å¹¶åº”ç”¨ï¼Œç”¨äºæä¾›é¢å¤–çš„å®‰å…¨å±‚</td></tr><tr><td>enable_tracing</td><td>N</td><td>æ˜¯å¦å¯ç”¨ opentracing çš„ traces å’Œ spansï¼Œé»˜è®¤ä¸º false</td></tr><tr><td>jaeger_endpoint</td><td>N</td><td>Jaeger æœåŠ¡åœ°å€ï¼Œé»˜è®¤ä¸º <code>http://localhost:14268/api/traces</code></td></tr><tr><td>jaeger_user</td><td>N</td><td>Jaeger æœåŠ¡è´¦å·ï¼Œé»˜è®¤ä¸ºç©º</td></tr><tr><td>jaeger_password</td><td>N</td><td>Jaeger æœåŠ¡å¯†ç ï¼Œé»˜è®¤ä¸ºç©º</td></tr><tr><td>disable_new_netns</td><td>Y</td><td>æ˜¯å¦ç¦æ­¢ä¸º shim å’Œ hypervisor è¿›ç¨‹åˆ›å»ºç½‘ç»œå‘½åç©ºé—´ï¼Œé»˜è®¤ä¸º falseã€‚é€‚ç”¨äº internetworking_model ä¸º noneï¼Œæ­¤æ—¶ tap è®¾å¤‡å°†ä½äº host ç½‘ç»œå‘½åç©ºé—´ä¸­ï¼Œå¹¶å¯ä»¥ç›´æ¥è¿æ¥åˆ° bridgeï¼ˆå¦‚ OVSï¼‰</td></tr><tr><td>sandbox_cgroup_only</td><td>Y</td><td>æ˜¯å¦ä»…å¯ç”¨ sandboxCgroupï¼Œé»˜è®¤ä¸º falseã€‚å¯ç”¨æ—¶ï¼Œcgroups ä»…æœ‰ä¸€ä¸ª sandboxCgroupï¼Œç”¨äºé™åˆ¶æ‰€æœ‰çš„ Kata è¿›ç¨‹ï¼›ç¦ç”¨æ—¶ï¼Œcgroups åˆ†ä¸º sandboxCgroup å’Œ overheadCgroupï¼Œé™¤ vCPU çº¿ç¨‹å¤–çš„å…¶ä»– Kata è¿›ç¨‹å’Œçº¿ç¨‹éƒ½å°†åœ¨ overheadCgroup ä¸‹è¿è¡Œ</td></tr><tr><td>static_sandbox_resource_mgmt</td><td>N</td><td>æ˜¯å¦å¯ç”¨é™æ€èµ„æºç®¡ç†ï¼Œé»˜è®¤ä¸º falseã€‚å¯ç”¨æ—¶ï¼ŒKata Containers å°†åœ¨ VM å¯åŠ¨ä¹‹å‰å°è¯•ç¡®å®šé€‚å½“çš„èµ„æºå¤§å°ï¼Œè€ŒéåŠ¨æ€æ›´æ–° VM ä¸­çš„å†…å­˜å’Œ CPU æ•°é‡ï¼Œç”¨ä½œä¸æ”¯æŒ CPU å’Œå†…å­˜çƒ­æ’æ‹”çš„ç¡¬ä»¶æ¶æ„æˆ– hypervisor è§£å†³æ–¹æ¡ˆ</td></tr><tr><td>sandbox_bind_mounts</td><td>N</td><td>VM ä¸­å¾…æŒ‚è½½ host çš„æ–‡ä»¶è·¯å¾„ï¼Œé»˜è®¤ä¸ºç©ºã€‚å¯ç”¨æ—¶ï¼Œhost çš„è¯¥è·¯å¾„æ–‡ä»¶ä¼šè¢«ä»¥åªè¯»çš„å½¢å¼æŒ‚è½½åˆ° VM çš„ &#x2F;run&#x2F;kata-containers&#x2F;shared&#x2F;containers&#x2F;sandbox-mounts è·¯å¾„ä¸­ï¼Œä¸ä¼šæš´éœ²ç»™å®¹å™¨å·¥ä½œè´Ÿè½½ï¼Œä»…ä¸ºæ½œåœ¨çš„ VM æœåŠ¡æä¾›</td></tr><tr><td>vfio_mode</td><td>Y</td><td>VFIO çš„æ¨¡å¼ï¼Œé»˜è®¤ä¸º guest-kernelï¼Œå¯é€‰çš„æœ‰ vfio å’Œ guest-kernelã€‚vfio ä¸ runC çš„è¡Œä¸ºç›¸è¿‘ï¼Œåœ¨å®¹å™¨ä¸­ï¼ŒVFIO è®¾å¤‡å°†æ˜¾ç¤ºä¸º VFIO å­—ç¬¦è®¾å¤‡ï¼Œä½äº &#x2F;dev&#x2F;vfio ä¸‹ï¼Œç¡®åˆ‡çš„åç§°å¯èƒ½ä¸ host ä¸åŒï¼ˆéœ€è¦åŒ¹é… VM çš„ IOMMU ç»„å·ï¼Œè€Œä¸æ˜¯ host çš„ï¼‰ï¼›guest-kernel æ˜¯ Kata ç‰¹æœ‰çš„è¡Œä¸ºï¼ŒVFIO è®¾å¤‡ç”± VM å†…æ ¸ä¸­çš„é©±åŠ¨ç¨‹åºç®¡ç†ï¼Œæ„å‘³ç€å®ƒå°†æ˜¾ç¤ºä¸ºä¸€ä¸ªæˆ–å¤šä¸ªè®¾å¤‡èŠ‚ç‚¹æˆ–ç½‘ç»œæ¥å£ï¼Œå…·ä½“å–å†³äºè®¾å¤‡çš„ç‰¹æ€§ã€‚è¿™ç§æ¨¡å¼è¦æ±‚å®¹å™¨å†…çš„å·¥ä½œè´Ÿè½½å…·æœ‰æ˜¾å¼æ”¯æŒ VM å†…è®¾å¤‡çš„ä»£ç æˆ–é€»è¾‘</td></tr><tr><td>disable_guest_empty_dir</td><td>N</td><td>æ˜¯å¦ç¦ç”¨åœ¨ VM æ–‡ä»¶ç³»ç»Ÿåˆ›å»º emptyDir æŒ‚è½½ç‚¹ï¼Œé»˜è®¤ä¸º falseã€‚ç¦ç”¨æ—¶ï¼ŒKata Containers å°†ä¸ä¼šåœ¨ VM æ–‡ä»¶ç³»ç»Ÿä¸Šåˆ›å»º Kubernetes emptyDir æŒ‚è½½ç‚¹ï¼Œè€Œæ˜¯åœ¨ host ä¸Šåˆ›å»º emptyDir æŒ‚è½½ç‚¹ï¼Œå¹¶é€šè¿‡ virtio-fs å…±äº«ï¼Œè™½ç„¶æ›´æ…¢ä¸€äº›ï¼Œä½†å…è®¸ä» host å…±äº«æ–‡ä»¶åˆ° VM ä¸­</td></tr><tr><td>experimental</td><td>Y</td><td>ä½“éªŒç‰¹æ€§ï¼Œé»˜è®¤ä¸ºç©ºã€‚<em>æš‚æœªæœ‰æ”¯æŒçš„ä½“éªŒç‰¹æ€§</em></td></tr><tr><td>enable_pprof</td><td>Y</td><td>æ˜¯å¦å¯ç”¨ pprofï¼Œé»˜è®¤ä¸º falseã€‚å¯ç”¨åï¼Œå¯ä»¥é€šè¿‡ kata-monitor è¿è¡Œ pprof å·¥å…·æ¥åˆ†æ shim è¿›ç¨‹</td></tr></tbody></table><h2 id="annotation-å‚æ•°æ‰©å±•"><a href="#annotation-å‚æ•°æ‰©å±•" class="headerlink" title="annotation å‚æ•°æ‰©å±•"></a>annotation å‚æ•°æ‰©å±•</h2><p>Kata Containers å¯ä»¥é€šè¿‡ annotation çš„æ–¹å¼å®šåˆ¶åŒ–æ¯ä¸€ä¸ª Kata å®¹å™¨çš„åº•å±‚è¿è¡Œæ—¶å‚æ•°ï¼š</p><ul><li>ä¸Šå±‚å®¹å™¨è¿è¡Œæ—¶å°† annotation é€ä¼ è‡³åº•å±‚è¿è¡Œæ—¶ï¼ˆä¾‹å¦‚ Containerd 1.4.x ä»¥ä¸Šçš„ç‰ˆæœ¬æ”¯æŒ annotation é€ä¼ ï¼›CRI-O é»˜è®¤é€ä¼ æ‰€æœ‰ annotationï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚<em>å…·ä½“å‚è€ƒ Container Manager é›†æˆ</em>ï¼‰</li><li>Kata Containers é…ç½®ä¸­å¼€å¯è¯†åˆ«ç‰¹å®šçš„ annotationï¼ˆ[hypervisor].enable_annotationsï¼‰</li></ul><p>æ­¤å¤–ï¼ŒKata Containers æ”¯æŒ OCI å’Œå®¹å™¨çº§åˆ«çš„é…ç½®ï¼Œä¾‹å¦‚ï¼š</p><p><strong>OCI é…ç½®</strong></p><table><thead><tr><th>é…ç½®é¡¹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>io.katacontainers.config_path</td><td>Kata Containers é…ç½®æ–‡ä»¶è·¯å¾„</td></tr><tr><td>io.katacontainers.pkg.oci.bundle_path</td><td>OCI bundle è·¯å¾„</td></tr><tr><td>io.katacontainers.pkg.oci.container_type</td><td>OCI å®¹å™¨ç±»å‹ï¼Œå¯é€‰çš„æœ‰ pod_container å’Œ pod_sandbox</td></tr></tbody></table><p><strong>å®¹å™¨é…ç½®</strong></p><table><thead><tr><th>é…ç½®é¡¹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>io.katacontainers.container.resource.swappiness</td><td>å³ Resources.Memory.Swappinessï¼Œç”¨äºé…ç½®å®¹å™¨å†…å­˜ç®¡ç†å™¨åœ¨ä½•æ—¶å°†å†…å­˜é¡µé¢å†™å…¥ SWAP ç©ºé—´çš„ä¸€ä¸ªç›¸å¯¹åº¦é‡ã€‚è¯¥å‚æ•°çš„å€¼ä»‹äº 0 å’Œ 100 ä¹‹é—´ï¼Œè¡¨ç¤ºå†…å­˜é¡µé¢çš„ä½¿ç”¨é¢‘ç‡</td></tr><tr><td>io.katacontainers.container.resource.swap_in_bytes</td><td>å³ Resources.Memory.Swapï¼Œç”¨äºé…ç½®å®¹å™¨å¯ä»¥ä½¿ç”¨çš„ SWAP ç©ºé—´çš„å¤§å°</td></tr></tbody></table><p>ä¾‹å¦‚ï¼Œé€šè¿‡ annotation å¯åŠ¨ä¸€ä¸ªå¿½ç•¥åº•å±‚é»˜è®¤å¤§å°ï¼Œå…·æœ‰ 5 CPUs çš„ VMï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kata</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">io.katacontainers.config.hypervisor.default_vcpus:</span> <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">runtimeClassName:</span> <span class="string">kata</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kata</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;tail -f /dev/null&quot;</span>]</span><br></pre></td></tr></table></figure><h1 id="ä¸-Container-Manager-é›†æˆ"><a href="#ä¸-Container-Manager-é›†æˆ" class="headerlink" title="ä¸ Container Manager é›†æˆ"></a>ä¸ Container Manager é›†æˆ</h1><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p><em>TODOï¼šDocker 23.0.0 ç‰ˆæœ¬ï¼Œæ–°å¢äº†è¿è¡Œæ—¶ shim çš„æ”¯æŒï¼Œä¹Ÿå°±æ”¯æŒäº† Kata Containers</em></p><h2 id="Containerd"><a href="#Containerd" class="headerlink" title="Containerd"></a>Containerd</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆ Containerd é»˜è®¤çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo <span class="built_in">mkdir</span> -p /etc/containerd</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">containerd config default | sudo <span class="built_in">tee</span> /etc/containerd/config.toml</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒContainerd çš„é»˜è®¤åº•å±‚è¿è¡Œæ—¶ä¸º runCï¼Œæ–°å¢ä»¥ä¸‹å†…å®¹æ”¯æŒ Kata Containersï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span></span><br><span class="line">   <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.kata]</span></span><br><span class="line">       <span class="attr">runtime_type</span> = <span class="string">&quot;io.containerd.kata.v2&quot;</span></span><br><span class="line">       <span class="attr">privileged_without_host_devices</span> = <span class="literal">true</span></span><br><span class="line">       <span class="attr">pod_annotations</span> = [<span class="string">&quot;io.katacontainers.*&quot;</span>]</span><br><span class="line">       <span class="attr">container_annotations</span> = [<span class="string">&quot;io.katacontainers.*&quot;</span>]</span><br><span class="line">       <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.kata.options]</span></span><br><span class="line">          <span class="attr">ConfigPath</span> = <span class="string">&quot;/opt/kata/share/defaults/kata-containers/configuration.toml&quot;</span></span><br></pre></td></tr></table></figure><h2 id="CRI-O"><a href="#CRI-O" class="headerlink" title="CRI-O"></a>CRI-O</h2><p><em>TODO</em></p><p>è‡³æ­¤ï¼Œå¯ä»¥å•ç‹¬é€šè¿‡ Container Manager å„è‡ªçš„å‘½ä»¤è¡Œè¿è¡Œ Kata Containersï¼Œä»¥ Containerd ä¸ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo ctr image pull docker.io/library/ubuntu:latest</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo ctr run --runtime io.containerd.run.kata.v2 -t --<span class="built_in">rm</span> docker.io/library/ubuntu:latest hello sh -c <span class="string">&quot;free -h&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sudo ctr run --runtime io.containerd.run.kata.v2 -t --memory-limit 536870912 --<span class="built_in">rm</span> docker.io/library/ubuntu:latest hello sh -c <span class="string">&quot;free -h&quot;</span></span></span><br></pre></td></tr></table></figure><h1 id="ä¸-Kubernetes-é›†æˆ"><a href="#ä¸-Kubernetes-é›†æˆ" class="headerlink" title="ä¸ Kubernetes é›†æˆ"></a>ä¸ Kubernetes é›†æˆ</h1><p>Kubernetes ä¸­å¯¹äºè¿è¡Œæ—¶çš„é›†æˆæ˜¯é€šè¿‡ <a href="https://kubernetes.io/docs/concepts/containers/runtime-class/">RuntimeClass</a> èµ„æºå¯¹è±¡ï¼Œä¾‹å¦‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kata-containers</span></span><br><span class="line"><span class="attr">handler:</span> <span class="string">kata</span></span><br><span class="line"><span class="attr">overhead:</span></span><br><span class="line">  <span class="attr">podFixed:</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">&quot;140Mi&quot;</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line"><span class="attr">scheduling:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">kata</span></span><br></pre></td></tr></table></figure><h2 id="handler"><a href="#handler" class="headerlink" title="handler"></a>handler</h2><p>éœ€è¦å’Œ CRI ä¸­æ³¨å†Œçš„ handlerï¼ˆHANDLER_NAMEï¼‰ ä¿æŒä¸€è‡´ã€‚</p><p><strong>Containerd</strong></p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.$&#123;HANDLER_NAME&#125;]</span></span><br></pre></td></tr></table></figure><p><strong>CRI-O</strong></p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[crio.runtime.runtimes.$&#123;HANDLER_NAME&#125;]</span></span><br></pre></td></tr></table></figure><h2 id="scheduling"><a href="#scheduling" class="headerlink" title="scheduling"></a>scheduling</h2><p>é€šè¿‡ä¸º RuntimeClass æŒ‡å®š scheduling å­—æ®µï¼Œ å¯ä»¥é€šè¿‡è®¾ç½®çº¦æŸï¼Œç¡®ä¿è¿è¡Œè¯¥ RuntimeClass çš„ Pod è¢«è°ƒåº¦åˆ°æ”¯æŒè¯¥ RuntimeClass çš„èŠ‚ç‚¹ä¸Šã€‚ å¦‚æœæœªè®¾ç½® schedulingï¼Œåˆ™å‡å®šæ‰€æœ‰èŠ‚ç‚¹å‡æ”¯æŒæ­¤ RuntimeClass ã€‚</p><p>ä¸ºäº†ç¡®ä¿ Pod ä¼šè¢«è°ƒåº¦åˆ°æ”¯æŒæŒ‡å®šè¿è¡Œæ—¶çš„èŠ‚ç‚¹ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹éœ€è¦è®¾ç½®ä¸€ä¸ªé€šç”¨çš„ label ç”¨äºè¢« runtimeclass.scheduling.nodeSelector æŒ‘é€‰ã€‚åœ¨ admission é˜¶æ®µï¼ŒRuntimeClass çš„ nodeSelector å°†ä¼šä¸ Pod çš„ nodeSelector åˆå¹¶ï¼Œå–äºŒè€…çš„äº¤é›†ã€‚å¦‚æœæœ‰å†²çªï¼ŒPod å°†ä¼šè¢«æ‹’ç»ã€‚</p><p>å¦‚æœèŠ‚ç‚¹éœ€è¦é˜»æ­¢æŸäº›éœ€è¦ç‰¹å®š RuntimeClass çš„ Podï¼Œå¯ä»¥åœ¨ tolerations ä¸­æŒ‡å®šã€‚ ä¸ nodeSelector ä¸€æ ·ï¼Œtolerations ä¹Ÿåœ¨ admission é˜¶æ®µä¸ Pod çš„ tolerations åˆå¹¶ï¼Œå–äºŒè€…çš„å¹¶é›†ã€‚</p><h2 id="overhead"><a href="#overhead" class="headerlink" title="overhead"></a>overhead</h2><p>åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œ Pod æ—¶ï¼ŒPod æœ¬èº«å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºã€‚è¿™äº›èµ„æºæ˜¯è¿è¡Œ Pod å†…å®¹å™¨æ‰€éœ€èµ„æºçš„é™„åŠ èµ„æºã€‚Overhead æ˜¯ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºè®¡ç®— Pod åŸºç¡€è®¾æ–½åœ¨å®¹å™¨è¯·æ±‚å’Œé™åˆ¶ä¹‹ä¸Šæ¶ˆè€—çš„èµ„æºã€‚</p><p>åœ¨ Kubernetes ä¸­ï¼ŒPod çš„å¼€é”€æ˜¯æ ¹æ®ä¸ Pod çš„ RuntimeClass ç›¸å…³è”çš„å¼€é”€åœ¨å‡†å…¥æ§åˆ¶æ—¶è®¾ç½®çš„ã€‚</p><p>å¦‚æœå¯ç”¨äº† Pod Overheadï¼Œåœ¨è°ƒåº¦ Pod æ—¶ï¼Œé™¤äº†è€ƒè™‘å®¹å™¨èµ„æºè¯·æ±‚çš„æ€»å’Œå¤–ï¼Œè¿˜è¦è€ƒè™‘ Pod å¼€é”€ã€‚ ç±»ä¼¼åœ°ï¼ŒKubelet å°†åœ¨ç¡®å®š Pod cgroups çš„å¤§å°å’Œæ‰§è¡Œ Pod é©±é€æ’åºæ—¶ä¹Ÿä¼šè€ƒè™‘ Pod å¼€é”€ã€‚</p><h1 id="VM-factory"><a href="#VM-factory" class="headerlink" title="VM factory"></a>VM factory</h1><h2 id="VMCache"><a href="#VMCache" class="headerlink" title="VMCache"></a>VMCache</h2><p>VMCache æ˜¯ä¸€é¡¹æ–°åŠŸèƒ½ï¼Œå¯åœ¨ä½¿ç”¨å‰å°† VM åˆ›å»ºä¸ºç¼“å­˜ã€‚å®ƒæœ‰åŠ©äºåŠ å¿«æ–°å®¹å™¨çš„åˆ›å»ºã€‚</p><p>è¯¥åŠŸèƒ½ç”±å€ŸåŠ© Unix socket é€šä¿¡çš„ä¸€ä¸ª gRPC Server å’Œä¸€äº› Client ç»„æˆã€‚</p><p>VMCache server å°†äº‹å…ˆåˆ›å»ºå¹¶ç¼“å­˜ä¸€äº› VMï¼Œå®ƒå°† VM è½¬æ¢ä¸º gRPC æ ¼å¼å¹¶åœ¨æ”¶åˆ° client è¯·æ±‚æ—¶è¿”å›ï¼›grpccache factory æ˜¯ VMCache å®¢æˆ·ç«¯ï¼Œå®ƒå°†è¯·æ±‚åˆ°çš„ gRPC æ ¼å¼çš„ VM å¹¶å°†å…¶è½¬æ¢å› VMã€‚å¦‚æœå¯ç”¨äº† VMCache åŠŸèƒ½ï¼ŒKata è¿è¡Œæ—¶åœ¨åˆ›å»ºæ–°çš„ sandbox æ—¶ä¼šå‘ grpccache è¯·æ±‚è·å– VMã€‚</p><p><strong>ä¸ VM tmplating çš„åŒºåˆ«</strong></p><p>VM tmplating å’Œ VMCache éƒ½æœ‰åŠ©äºåŠ å¿«æ–°å®¹å™¨çš„åˆ›å»ºã€‚</p><p>å½“å¯ç”¨ VM tmplating æ—¶ï¼Œé€šè¿‡ä»é¢„å…ˆåˆ›å»ºçš„æ¨¡æ¿ VM å…‹éš†æ¥åˆ›å»ºæ–°çš„ VMï¼Œå®ƒä»¬å°†ä»¥åªè¯»æ¨¡å¼å…±äº«ç›¸åŒçš„ initramfsã€å†…æ ¸å’Œ agent å†…å­˜ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨åŒä¸€ä¸»æœºä¸Šè¿è¡Œè®¸å¤š Kata å®¹å™¨ï¼Œå®ƒä¼šèŠ‚çœå¤§é‡å†…å­˜ã€‚</p><p>è€Œ VMCache ä¸å®¹æ˜“å—åˆ°å…±äº«å†…å­˜ CVE çš„å½±å“ï¼Œå› ä¸ºæ¯ä¸ª VM ä¸å…±äº«å†…å­˜ã€‚</p><p><strong>å¦‚ä½•å¯ç”¨ VM Cache</strong></p><p>é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ä»¥ä¸‹é…ç½®é¡¹ï¼š</p><ul><li>[factory].vm_cache_number æŒ‡å®š VM ç¼“å­˜çš„ä¸ªæ•°</li><li>[factory].vm_cache_endpoint æŒ‡å®š socket åœ°å€ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰ï¼Œé»˜è®¤ä¸º &#x2F;var&#x2F;run&#x2F;kata-containers&#x2F;cache.sock</li></ul><p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª VM æ¨¡æ¿ä¾›ä»¥åä½¿ç”¨ï¼Œé€šè¿‡ CTRL+C é€€å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime factory init</span></span><br></pre></td></tr></table></figure><p>åŒºåˆ«äº VM templatingï¼ŒVMCache åˆ›å»ºçš„ VM æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œè€Œéä¿å­˜åœ¨ [factory].template_path ç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime factory status</span></span><br><span class="line">VM cache server pid = 38308</span><br><span class="line">VM pid = 38334 Cpu = 1 Memory = 2048MiB</span><br><span class="line">VM pid = 38331 Cpu = 1 Memory = 2048MiB</span><br><span class="line">VM pid = 38332 Cpu = 1 Memory = 2048MiB</span><br><span class="line">vm factory not enabled</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -la /run/vc/vm</span></span><br><span class="line">a78a9744-5984-4e54-bda9-9b6280bf9a3f</span><br><span class="line">41648333-a4a3-48ee-b80b-f7c19e3081b1</span><br><span class="line">57d2dd69-0e73-4779-b23f-68ee8e4f66de</span><br><span class="line">template</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime factory destroy</span></span><br><span class="line">vm factory destroyed</span><br></pre></td></tr></table></figure><p><strong>å·²çŸ¥é™åˆ¶</strong></p><ul><li>æ— æ³•ä¸ VM templating å…±å­˜</li><li>ä»…æ”¯æŒ QEMU ä½œä¸º hypervisor</li><li>[hypervisor].shared_fs ä¸º virtio-9pï¼ˆç¤¾åŒºæœ‰æ”¯æŒ virtio-fs çš„ææ¡ˆ <a href="https://github.com/kata-containers/kata-containers/pull/4522%EF%BC%8C%E4%BD%86%E6%88%AA%E8%87%B3">https://github.com/kata-containers/kata-containers/pull/4522ï¼Œä½†æˆªè‡³</a> Kata 3.0.0 æš‚æœªåˆå…¥ï¼‰</li></ul><p><em>ç»éªŒè¯ï¼Œæˆªè‡³ Kata 3.0.0ï¼ŒVMCache å¹¶ä¸èƒ½å¼€ç®±å³ç”¨ï¼Œåœ¨ VMCache æµç¨‹ä¸­éƒ¨åˆ†å˜é‡ç¼ºå°‘èµ‹å€¼ï¼Œå¯¼è‡´ä»£ç æŠ¥é”™</em></p><h2 id="VM-templating"><a href="#VM-templating" class="headerlink" title="VM templating"></a>VM templating</h2><p>VM templating æ˜¯ Kata Containers çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå¯ä»¥å€ŸåŠ©å…‹éš†æŠ€æœ¯åˆ›å»ºæ–°çš„ VMã€‚å¯ç”¨åï¼Œæ–°çš„ VM å°†é€šè¿‡ä»é¢„å…ˆåˆ›å»ºçš„æ¨¡æ¿è¿›è¡Œå…‹éš†æ¥åˆ›å»ºï¼Œå®ƒä»¬å°†ä»¥åªè¯»æ¨¡å¼å…±äº«ç›¸åŒçš„ initramfsã€å†…æ ¸å’Œ agent å†…å­˜ã€‚ç±»ä¼¼äºå†…æ ¸çš„ fork è¿›ç¨‹æ“ä½œï¼Œè¿™é‡Œ fork çš„æ˜¯ VMã€‚</p><p><strong>ä¸ VMCache çš„åŒºåˆ«</strong></p><p>VMCache å’Œ VM templating éƒ½æœ‰åŠ©äºåŠ å¿«æ–°å®¹å™¨çš„åˆ›å»ºã€‚</p><p>å¯ç”¨ VMCache åï¼ŒVMCache æœåŠ¡å™¨ä¼šåˆ›å»ºæ–°çš„ VMã€‚æ‰€ä»¥å®ƒä¸å®¹æ˜“å—åˆ°å…±äº«å†…å­˜ CVE çš„æ”»å‡»ï¼Œå› ä¸ºæ¯ä¸ª VM éƒ½ä¸å…±äº«å†…å­˜ã€‚</p><p>å¦‚æœåœ¨åŒä¸€ä¸»æœºä¸Šè¿è¡Œè®¸å¤š Kata å®¹å™¨ï¼ŒVM templating å¯ä»¥èŠ‚çœå¤§é‡å†…å­˜ã€‚</p><p><strong>ä¼˜åŠ¿</strong></p><p>å¦‚æœåœ¨åŒä¸€ä¸»æœºä¸Šè¿è¡Œè®¸å¤š Kata å®¹å™¨ï¼ŒVM templating æœ‰åŠ©äºåŠ å¿«æ–°å®¹å™¨çš„åˆ›å»ºå¹¶èŠ‚çœå¤§é‡å†…å­˜ã€‚å¦‚æœæ­£åœ¨è¿è¡Œé«˜å¯†åº¦å·¥ä½œè´Ÿè½½ï¼Œæˆ–è€…éå¸¸å…³å¿ƒå®¹å™¨å¯åŠ¨é€Ÿåº¦ï¼ŒVM templating å¯èƒ½éå¸¸æœ‰ç”¨ã€‚</p><p>åœ¨ä¸€ä¸ª<a href="https://github.com/kata-containers/runtime/pull/303#issuecomment-395846767">ç¤ºä¾‹</a>ä¸­ï¼Œåˆ›å»ºäº† 100 ä¸ª Kata å®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æ‹¥æœ‰ 128MB çš„ VM å†…å­˜ï¼Œå¹¶ä¸”åœ¨å¯ç”¨ VM templating ç‰¹æ€§æ—¶æœ€ç»ˆæ€»å…±èŠ‚çœäº† 9GB çš„å†…å­˜ï¼Œè¿™å¤§çº¦æ˜¯ VM å†…å­˜æ€»é‡çš„ 72%ã€‚</p><p>åœ¨å¦ä¸€ä¸ª<a href="https://gist.github.com/bergwolf/06974a3c5981494a40e2c408681c085d">ç¤ºä¾‹</a>ä¸­ï¼Œåˆ›å»ºäº† 10 ä¸ª Kata å®¹å™¨ï¼Œå¹¶è®¡ç®—äº†æ¯ä¸ªå®¹å™¨çš„å¹³å‡å¯åŠ¨é€Ÿåº¦ã€‚ç»“æœè¡¨æ˜ï¼ŒVM templating å°† Kata å®¹å™¨çš„åˆ›å»ºé€Ÿåº¦æé«˜äº† 38.68%ã€‚</p><p><strong>ä¸è¶³</strong></p><p>VM templating çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯å®ƒæ— æ³•é¿å…è·¨ VM ä¾§é€šé“æ”»å‡»ï¼Œä¾‹å¦‚æœ€åˆé’ˆå¯¹ Linux KSM åŠŸèƒ½çš„ CVE-2015-2877ã€‚å¾—å‡ºçš„ç»“è®ºæ˜¯ï¼Œâ€œç›¸äº’ä¸ä¿¡ä»»çš„ç§Ÿæˆ·ä¹‹é—´ç”¨äºå†…å­˜ä¿æŠ¤çš„å…±äº«ç›´åˆ°å†™å…¥çš„æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯å¯æ£€æµ‹çš„ä¿¡æ¯æ³„éœ²ï¼Œå¹¶ä¸”å¯ä»¥å½’ç±»ä¸ºæ½œåœ¨çš„è¢«è¯¯è§£çš„è¡Œä¸ºè€Œä¸æ˜¯æ¼æ´ã€‚â€å¦‚æœå¯¹æ­¤æ•æ„Ÿï¼Œä¸è¦ä½¿ç”¨ VM templating æˆ– KSMã€‚</p><p><strong>å¦‚ä½•å¯ç”¨ VM templating</strong></p><p>é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ä»¥ä¸‹é…ç½®é¡¹ï¼š</p><ul><li>hypervisor ä¸º qemuï¼Œä¸”ç‰ˆæœ¬ä¸º v4.1.0 ä»¥ä¸Š</li><li>[factory].enable_template è®¾ä¸º true</li><li>VM é•œåƒä¸º initrd ç±»å‹ï¼Œå³ä¸º [hypervisor].initrd</li><li>[hypervisor].shared_fs ä¸º virtio-9p</li></ul><p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª VM æ¨¡æ¿ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime factory init</span></span><br><span class="line">vm factory initialized</span><br></pre></td></tr></table></figure><p>åˆ›å»ºçš„æ¨¡æ¿é»˜è®¤ä¿å­˜åœ¨ &#x2F;run&#x2F;vc&#x2F;vm&#x2F;templateï¼Œå¯ä»¥é€šè¿‡ [factory].template_path æŒ‡å®šï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> /run/vc/vm/template</span></span><br><span class="line">memory  state</span><br></pre></td></tr></table></figure><p>æ¨¡æ¿é€šè¿‡ä»¥ä¸‹å‘½ä»¤é”€æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime factory destroy</span></span><br><span class="line">vm factory destroyed</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æƒ³æ‰‹åŠ¨è°ƒç”¨ kata-runtime factory initï¼Œåœ¨å¯ç”¨ VM templating åï¼Œé»˜è®¤åˆ›å»ºçš„ç¬¬ä¸€ä¸ª Kata å®¹å™¨å°†è‡ªåŠ¨åˆ›å»ºä¸€ä¸ª VM æ¨¡æ¿ã€‚</p><h1 id="kata-runtime"><a href="#kata-runtime" class="headerlink" title="kata-runtime"></a>kata-runtime</h1><p>kata-runtime æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</p><h2 id="check-kata-check"><a href="#check-kata-check" class="headerlink" title="check (kata-check)"></a>check (kata-check)</h2><p>æ£€æµ‹å½“å‰ç¯å¢ƒæ˜¯å¦å¯ä»¥è¿è¡Œ Kata Containers ä»¥åŠç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime check --verbose</span></span><br><span class="line">INFO[0000] IOMMUPlatform is disabled by default.        </span><br><span class="line">WARN[0000] Not running network checks as super user      arch=amd64 name=kata-runtime pid=29825 source=runtime</span><br><span class="line">INFO[0000] CPU property found                            arch=amd64 description=&quot;Intel Architecture CPU&quot; name=GenuineIntel pid=29825 source=runtime type=attribute</span><br><span class="line">INFO[0000] CPU property found                            arch=amd64 description=&quot;Virtualization support&quot; name=vmx pid=29825 source=runtime type=flag</span><br><span class="line">INFO[0000] CPU property found                            arch=amd64 description=&quot;64Bit CPU&quot; name=lm pid=29825 source=runtime type=flag</span><br><span class="line">INFO[0000] CPU property found                            arch=amd64 description=SSE4.1 name=sse4_1 pid=29825 source=runtime type=flag</span><br><span class="line">INFO[0000] kernel property found                         arch=amd64 description=&quot;Intel KVM&quot; name=kvm_intel pid=29825 source=runtime type=module</span><br><span class="line">INFO[0000] kernel property found                         arch=amd64 description=&quot;Kernel-based Virtual Machine&quot; name=kvm pid=29825 source=runtime type=module</span><br><span class="line">INFO[0000] kernel property found                         arch=amd64 description=&quot;Host kernel accelerator for virtio&quot; name=vhost pid=29825 source=runtime type=module</span><br><span class="line">INFO[0000] kernel property found                         arch=amd64 description=&quot;Host kernel accelerator for virtio network&quot; name=vhost_net pid=29825 source=runtime type=module</span><br><span class="line">INFO[0000] kernel property found                         arch=amd64 description=&quot;Host Support for Linux VM Sockets&quot; name=vhost_vsock pid=29825 source=runtime type=module</span><br><span class="line">System is capable of running Kata Containers</span><br><span class="line">INFO[0000] device available                              arch=amd64 check-type=full device=/dev/kvm name=kata-runtime pid=29825 source=runtime</span><br><span class="line">INFO[0000] feature available                             arch=amd64 check-type=full feature=create-vm name=kata-runtime pid=29825 source=runtime</span><br><span class="line">System can currently create Kata Containers</span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬ï¼š</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“check-version-only</td><td>ä»…å¯¹æ¯”å‰ä½¿ç”¨ç‰ˆæœ¬å’Œæœ€æ–°å¯ç”¨ç‰ˆæœ¬ï¼ˆéœ€è¦ç½‘ç»œæ”¯æŒï¼Œä¸”é root ç”¨æˆ·ï¼‰</td></tr><tr><td>â€“include-all-releases</td><td>åŒ…å«è¿‡æ»¤é¢„å‘å¸ƒçš„ç‰ˆæœ¬</td></tr><tr><td>â€“no-network-checks, -n</td><td>ä¸å€ŸåŠ©ç½‘ç»œæ‰§è¡Œæ£€æµ‹ï¼Œè¯¥å‚æ•°ç­‰ä»·äºè®¾ç½® KATA_CHECK_NO_NETWORK ç¯å¢ƒå˜é‡</td></tr><tr><td>â€“only-list-releases</td><td>ä»…åˆ—å‡ºè¾ƒæ–°çš„å¯ç”¨ç‰ˆæœ¬ï¼ˆéœ€è¦ç½‘ç»œæ”¯æŒï¼Œä¸”é root ç”¨æˆ·ï¼‰</td></tr><tr><td>â€“strict, -s</td><td>è¿›è¡Œä¸¥æ ¼æ£€æŸ¥</td></tr><tr><td>â€“verbose, -v</td><td>å±•ç¤ºè¯¦ç»†çš„æ£€æŸ¥é¡¹</td></tr></tbody></table><h2 id="env-kata-env"><a href="#env-kata-env" class="headerlink" title="env (kata-env)"></a>env (kata-env)</h2><p>Kata Containers é…ç½®å±•ç¤ºï¼Œé»˜è®¤è¾“å‡ºæ ¼å¼ä¸º TOMLã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime <span class="built_in">env</span></span> </span><br><span class="line">[Kernel]</span><br><span class="line">  Path = &quot;/opt/kata/share/kata-containers/vmlinux-5.19.2-96&quot;</span><br><span class="line">  Parameters = &quot;systemd.unit=kata-containers.target systemd.mask=systemd-networkd.service systemd.mask=systemd-networkd.socket scsi_mod.scan=none agent.log=debug agent.debug_console agent.debug_console_vport=1026&quot;</span><br><span class="line"></span><br><span class="line">[Meta]</span><br><span class="line">  Version = &quot;1.0.26&quot;</span><br><span class="line"></span><br><span class="line">[Image]</span><br><span class="line">  Path = &quot;/opt/kata/share/kata-containers/kata-clearlinux-latest.image&quot;</span><br><span class="line"></span><br><span class="line">[Initrd]</span><br><span class="line">  Path = &quot;&quot;</span><br><span class="line"></span><br><span class="line">[Hypervisor]</span><br><span class="line">  MachineType = &quot;q35&quot;</span><br><span class="line">  Version = &quot;QEMU emulator version 6.2.0 (kata-static)\nCopyright (c) 2003-2021 Fabrice Bellard and the QEMU Project developers&quot;</span><br><span class="line">  Path = &quot;/opt/kata/bin/qemu-system-x86_64&quot;</span><br><span class="line">  BlockDeviceDriver = &quot;virtio-scsi&quot;</span><br><span class="line">  EntropySource = &quot;/dev/urandom&quot;</span><br><span class="line">  SharedFS = &quot;virtio-fs&quot;</span><br><span class="line">  VirtioFSDaemon = &quot;/opt/kata/libexec/virtiofsd&quot;</span><br><span class="line">  SocketPath = &quot;&quot;</span><br><span class="line">  Msize9p = 8192</span><br><span class="line">  MemorySlots = 10</span><br><span class="line">  PCIeRootPort = 2</span><br><span class="line">  HotplugVFIOOnRootBus = true</span><br><span class="line">  Debug = true</span><br><span class="line"></span><br><span class="line">[Runtime]</span><br><span class="line">  Path = &quot;/usr/local/bin/kata-runtime&quot;</span><br><span class="line">  Debug = true</span><br><span class="line">  Trace = false</span><br><span class="line">  DisableGuestSeccomp = true</span><br><span class="line">  DisableNewNetNs = false</span><br><span class="line">  SandboxCgroupOnly = false</span><br><span class="line">  [Runtime.Config]</span><br><span class="line">    Path = &quot;/etc/kata-containers/configuration.toml&quot;</span><br><span class="line">  [Runtime.Version]</span><br><span class="line">    OCI = &quot;1.0.2-dev&quot;</span><br><span class="line">    [Runtime.Version.Version]</span><br><span class="line">      Semver = &quot;3.0.0&quot;</span><br><span class="line">      Commit = &quot;e2a8815ba46360acb8bf89a2894b0d437dc8548a-dirty&quot;</span><br><span class="line">      Major = 3</span><br><span class="line">      Minor = 0</span><br><span class="line">      Patch = 0</span><br><span class="line"></span><br><span class="line">[Host]</span><br><span class="line">  Kernel = &quot;4.18.0-305.43.25.ar.el7.x86_64&quot;</span><br><span class="line">  Architecture = &quot;amd64&quot;</span><br><span class="line">  VMContainerCapable = true</span><br><span class="line">  SupportVSocks = true</span><br><span class="line">  [Host.Distro]</span><br><span class="line">    Name = &quot;CentOS Linux&quot;</span><br><span class="line">    Version = &quot;7&quot;</span><br><span class="line">  [Host.CPU]</span><br><span class="line">    Vendor = &quot;GenuineIntel&quot;</span><br><span class="line">    Model = &quot;QEMU Virtual CPU version (cpu64-rhel6)&quot;</span><br><span class="line">    CPUs = 8</span><br><span class="line">  [Host.Memory]</span><br><span class="line">    Total = 12057632</span><br><span class="line">    Free = 3352124</span><br><span class="line">    Available = 8508112</span><br><span class="line"></span><br><span class="line">[Agent]</span><br><span class="line">  Debug = true</span><br><span class="line">  Trace = false</span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“json</td><td>ä»¥ JSON æ ¼å¼å±•ç¤º</td></tr></tbody></table><h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><p>å€ŸåŠ© debug consoleï¼Œè¿›å…¥ VM æ§åˆ¶å°ï¼Œéœ€è¦ [agent].debug_console_enabled è®¾ç½®ä¸º trueã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯¹äº Pod è€Œè¨€æ˜¯å…¶ SandboxID</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime <span class="built_in">exec</span> 27ab74433f11c0b64e404a841d5e2f8296a723ebfa4e598b4d9d32871173b82c</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“kata-debug-port</td><td>debug console ç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤ä¸º 1026 æˆ–è€… 0</td></tr></tbody></table><h2 id="metrics"><a href="#metrics" class="headerlink" title="metrics"></a>metrics</h2><p>æ”¶é›†ä¸ç”¨äºè¿è¡Œ sandbox çš„åŸºç¡€è®¾æ–½ç›¸å…³çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚ runtimeã€agentã€hypervisor ç­‰ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¯¹äº Pod è€Œè¨€æ˜¯å…¶ SandboxID</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime metrics 27ab74433f11c0b64e404a841d5e2f8296a723ebfa4e598b4d9d32871173b82c</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HELP kata_hypervisor_fds Open FDs <span class="keyword">for</span> hypervisor.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TYPE kata_hypervisor_fds gauge</span></span><br><span class="line">kata_hypervisor_fds 122</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HELP kata_hypervisor_io_stat Process IO statistics.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">TYPE kata_hypervisor_io_stat gauge</span></span><br><span class="line">kata_hypervisor_io_stat&#123;item=&quot;cancelledwritebytes&quot;&#125; 0</span><br><span class="line">kata_hypervisor_io_stat&#123;item=&quot;rchar&quot;&#125; 5.915546e+06</span><br><span class="line">kata_hypervisor_io_stat&#123;item=&quot;readbytes&quot;&#125; 1.1665408e+07</span><br><span class="line">kata_hypervisor_io_stat&#123;item=&quot;syscr&quot;&#125; 95522</span><br><span class="line">kata_hypervisor_io_stat&#123;item=&quot;syscw&quot;&#125; 202276</span><br><span class="line">kata_hypervisor_io_stat&#123;item=&quot;wchar&quot;&#125; 3.715404e+06</span><br><span class="line">kata_hypervisor_io_stat&#123;item=&quot;writebytes&quot;&#125; 2.097152e+06</span><br></pre></td></tr></table></figure><h2 id="direct-volume"><a href="#direct-volume" class="headerlink" title="direct-volume"></a>direct-volume</h2><p>ç®¡ç† Kata Containers çš„ç›´é€šå·ã€‚*å…·ä½“ä½¿ç”¨æ–¹å¼å‚è€ƒ <strong>Kata Containers Block Volume ç›´é€š</strong>è¯´æ˜ã€‚*</p><p><strong>add</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime direct-volume add --volume-path /var/lib/kubelet/pods/8c3d29ad-84b8-45f0-9fcc-8e16778cb3cb/volumes/kubernetes.io~csi/pvc-a950ed68-622c-4ec4-81fa-506f16de2196/mount --mount-info \&#123;\&quot;volume-type\&quot;:\&quot;block\&quot;,\&quot;device\&quot;:\&quot;/dev/sdm\&quot;,\&quot;fstype\&quot;:\&quot;xfs\&quot;\&#125;</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“volume-path</td><td>å¾…æ“ä½œçš„ç›®æ ‡å·è·¯å¾„</td></tr><tr><td>â€“mount-info</td><td>ç®¡ç†å·æŒ‚è½½çš„è¯¦æƒ…ä¿¡æ¯</td></tr></tbody></table><p><strong>remove</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime direct-volume delete --volume-path /var/lib/kubelet/pods/8c3d29ad-84b8-45f0-9fcc-8e16778cb3cb/volumes/kubernetes.io~csi/pvc-a950ed68-622c-4ec4-81fa-506f16de2196/mount</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“volume-path</td><td>å¾…æ“ä½œçš„ç›®æ ‡å·è·¯å¾„</td></tr></tbody></table><p><strong>stats</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime direct-volume stats --volume-path /var/lib/kubelet/pods/8c3d29ad-84b8-45f0-9fcc-8e16778cb3cb/volumes/kubernetes.io~csi/pvc-a950ed68-622c-4ec4-81fa-506f16de2196/mount</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“volume-path</td><td>å¾…æ“ä½œçš„ç›®æ ‡å·è·¯å¾„</td></tr></tbody></table><p><strong>resize</strong></p><p><em>æˆªè‡³ Kata Containers 3.0.0ï¼Œç¤¾åŒºä»æœªå®ç° VM ä¸­ Kata agent çš„é€»è¾‘</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime direct-volume resize --volume-path /var/lib/kubelet/pods/8c3d29ad-84b8-45f0-9fcc-8e16778cb3cb/volumes/kubernetes.io~csi/pvc-a950ed68-622c-4ec4-81fa-506f16de2196/mount --size 1756519562</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“volume-path</td><td>å¾…æ“ä½œçš„ç›®æ ‡å·è·¯å¾„</td></tr><tr><td>â€“size</td><td>è°ƒæ•´åçš„é¢„æœŸå·å¤§å°ï¼ˆå•ä½ä¸ºï¼šByteï¼‰</td></tr></tbody></table><h2 id="factory-1"><a href="#factory-1" class="headerlink" title="factory"></a>factory</h2><p>ç®¡ç† Kata Containers çš„ VM factoryã€‚<em>å…·ä½“ä½¿ç”¨æ–¹å¼å‚è€ƒ <strong>VM factory</strong> è¯´æ˜ã€‚</em></p><p><strong>init</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime factory init</span></span><br><span class="line">vm factory initialized</span><br></pre></td></tr></table></figure><p><strong>status</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime factory status</span></span><br><span class="line">vm factory is on</span><br></pre></td></tr></table></figure><p><strong>destroy</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime factory destroy</span></span><br><span class="line">vm factory destroyed</span><br></pre></td></tr></table></figure><h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><p>ç®¡ç† VM ä¸­çš„ iptables ä¿¡æ¯ã€‚</p><p><strong>get</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime iptables get --sandbox-id xxx --v6</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“sandbox-id</td><td>å¾…æ“ä½œçš„ Sandbox ID</td></tr><tr><td>â€“v6</td><td>è·å– IPV6 çš„ iptables</td></tr></tbody></table><p><strong>set</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-runtime iptables <span class="built_in">set</span> --sandbox-id xxx --v6 ./iptables</span></span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“sandbox-id</td><td>å¾…æ“ä½œçš„ Sandbox ID</td></tr><tr><td>â€“v6</td><td>è®¾ç½® IPV6 çš„ iptables</td></tr></tbody></table><h1 id="kata-monitor"><a href="#kata-monitor" class="headerlink" title="kata-monitor"></a>kata-monitor</h1><p>Kata monitor æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œèƒ½å¤Ÿæ”¶é›†å’Œæš´éœ²åœ¨åŒä¸€ host ä¸Šè¿è¡Œçš„æ‰€æœ‰ Kata å®¹å™¨å·¥ä½œè´Ÿè½½ç›¸å…³çš„æŒ‡æ ‡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">kata-monitor</span></span><br><span class="line">INFO[0000] announce                                      app=kata-monitor arch=amd64 git-commit=fcad969e5200607df3b0b31983cc64488e156e99 go-version=go1.16.10 listen-address=&quot;127.0.0.1:8090&quot; log-level=info os=linux runtime-endpoint=/run/containerd/containerd.sock version=0.3.0</span><br></pre></td></tr></table></figure><p>å¯é€‰çš„ flags åŒ…æ‹¬</p><table><thead><tr><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“listen-address</td><td>ç›‘å¬ HTTP è¯·æ±‚çš„åœ°å€ï¼Œé»˜è®¤ä¸º 127.0.0.1:8090</td></tr><tr><td>â€“log-level</td><td>æœåŠ¡æ—¥å¿—çº§åˆ«ï¼Œå¯é€‰æœ‰ trace&#x2F;debug&#x2F;info&#x2F;warn&#x2F;error&#x2F;fatal&#x2F;panicï¼Œé»˜è®¤ä¸º info</td></tr><tr><td>â€“runtime-endpoint</td><td>CRI å®¹å™¨è¿è¡Œæ—¶æœåŠ¡çš„ socket åœ°å€ï¼Œé»˜è®¤ä¸º &#x2F;run&#x2F;containerd&#x2F;containerd.sock</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">Kata Containers åœ¨ Kubernetes é›†ç¾¤åœºæ™¯ä¸­çš„é…ç½®ä¸åŸºç¡€ä½¿ç”¨ç¤ºä¾‹</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
  <entry>
    <title>ã€Œ Kata Containers ã€æ¶æ„ä¸ç»„ä»¶æ¦‚è¿°</title>
    <link href="http://shenxianghong.github.io/2021/04/06/2021-04-06%20Kata%20Containers%20%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0/"/>
    <id>http://shenxianghong.github.io/2021/04/06/2021-04-06%20Kata%20Containers%20%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%BB%84%E4%BB%B6%E6%A6%82%E8%BF%B0/</id>
    <published>2021-04-05T16:00:00.000Z</published>
    <updated>2023-06-19T01:18:06.996Z</updated>
    
    <content type="html"><![CDATA[<div align=center><img width="200" style="border: 0px" src="/gallery/kata-containers/logo.svg"></div><hr><blockquote><p>based on <strong>2.1.1</strong></p></blockquote><h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>Kata Containers æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒé‡‡ç”¨è½»é‡åŒ–è™šæ‹Ÿæœºä½œä¸ºå®¹å™¨çš„éš”ç¦»æ¥æ„å»ºä¸€ä¸ªå®‰å…¨å®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œå…¶è™šæ‹ŸåŒ–æŠ€æœ¯ä½œä¸ºå®¹å™¨çš„äºŒå±‚ä¿æŠ¤ä¸ºè´Ÿè½½æä¾›äº†æ›´å¥½çš„éš”ç¦»æ€§ï¼Œè¿™ä½¿å¾— Kata Containers å…¼å…·ä¼ ç»Ÿå®¹å™¨çš„å½¢æ€å’Œè™šæ‹Ÿæœºçš„å®‰å…¨æ€§ã€‚ æ—©åœ¨ 2015 å¹´ï¼Œæ¥è‡ªè‹±ç‰¹å°”å¼€æºæŠ€æœ¯ä¸­å¿ƒçš„å·¥ç¨‹å¸ˆå°±å¼€å§‹æ¢ç´¢é‡‡ç”¨ è‹±ç‰¹å°”Â® è™šæ‹ŸæŠ€æœ¯ï¼ˆè‹±ç‰¹å°”Â® Virtualization Technologyï¼Œè‹±ç‰¹å°”Â® VTï¼‰æ¥æé«˜å®¹å™¨çš„å®‰å…¨éš”ç¦»æ€§ï¼Œå¹¶ä»¥æ­¤å‘èµ·äº†è‹±ç‰¹å°”Â® Clear Containers å¼€æºé¡¹ç›®ï¼Œä¸æ­¤åŒæ—¶ï¼Œæ¥è‡ª Hyper.shï¼ˆä¸€å®¶ä¸­å›½çš„é«˜ç§‘æŠ€åˆåˆ›å…¬å¸ï¼‰çš„å·¥ç¨‹å¸ˆä¹Ÿå‘èµ·äº† runV10 å¼€æºé¡¹ç›®ï¼Œè¿™ä¸¤ä¸ªé¡¹ç›®é‡‡ç”¨çš„æŠ€æœ¯å’Œç›®çš„éƒ½éå¸¸ç›¸ä¼¼ï¼Œéƒ½æ˜¯ä¸ºäº†å°†å®¹å™¨ç½®äºä¸€ä¸ªå®‰å…¨â€œæ²™ç®±â€œï¼Œä»¥ä¾¿è¿›ä¸€æ­¥ä¿ƒè¿›è¯¥æŠ€æœ¯å‘å±•å’Œæˆç†Ÿã€‚éšååœ¨ 2017 å¹´ï¼Œè‹±ç‰¹å°”å’Œ Hyper.sh å›¢é˜Ÿå°†è¿™ä¸¤ä¸ªå¼€æºé¡¹ç›®åœ¨ç¤¾åŒºåˆå¹¶æˆäº†ä¸€ä¸ªæ–°çš„é¡¹ç›® Kata Containersã€‚ ä¼ ç»Ÿè™šæ‹Ÿæœºï¼ˆVMsï¼‰å¯æä¾›ç¡¬ä»¶éš”ç¦»ï¼Œè€Œå®¹å™¨å¯å¿«é€Ÿå“åº”ï¼Œä¸”å ç”¨ç©ºé—´ç›¸å¯¹è¾ƒå°ï¼ŒKata Containers å°†è¿™ä¸¤è€…çš„ä¼˜åŠ¿å®Œç¾ç»“åˆäº†èµ·æ¥ã€‚ æ¯ä¸ªå®¹å™¨æˆ– Pod éƒ½åœ¨è‡ªå·±å•ç‹¬çš„è™šæ‹Ÿæœºä¸­å¯åŠ¨ï¼Œ å¹¶ä¸å†èƒ½å¤Ÿè®¿é—®ä¸»æœºå†…æ ¸ï¼Œæœç»äº†æ¶æ„ä»£ç ä¾µå…¥å…¶å®ƒç›¸ä¸´å®¹å™¨çš„å¯èƒ½ã€‚ç”±äº Kata Containers åŒæ—¶å…·å¤‡ç¡¬ä»¶éš”ç¦»ï¼Œä¹Ÿä½¿å¾—äº’ä¸ä¿¡ä»»çš„ç§Ÿæˆ·ï¼Œç”šè‡³äºç”Ÿäº§åº”ç”¨æˆ–å‰ç”Ÿäº§åº”ç”¨éƒ½èƒ½å¤Ÿåœ¨åŒä¸€é›†ç¾¤å†…å®‰å…¨è¿è¡Œï¼Œä»è€Œä½¿å¾—åœ¨è£¸æœºä¸Šè¿è¡Œå®¹å™¨å³æœåŠ¡ï¼ˆContainers as a Service, CaaSï¼‰æˆä¸ºå¯èƒ½ã€‚</p><h1 id="Assets"><a href="#Assets" class="headerlink" title="Assets"></a>Assets</h1><p>Kata Containers åˆ›å»ºä¸€ä¸ª VMï¼Œåœ¨å…¶ä¸­è¿è¡Œä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚éœ€è¦é€šè¿‡å¯åŠ¨ hypervisor åˆ›å»ºè™šæ‹Ÿæœºæ¥å®ç°è¿™ä¸€ç‚¹ã€‚hypervisor éœ€è¦ä¸¤ä¸ª assets æ¥å®Œæˆè¿™é¡¹ä»»åŠ¡ï¼šä¸€ä¸ª Linux å†…æ ¸å’Œä¸€ä¸ªç”¨äºå¼•å¯¼ VM çš„å°å‹æ ¹æ–‡ä»¶ç³»ç»Ÿé•œåƒã€‚</p><h2 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h2><p>guest å†…æ ¸ä¼ é€’åˆ° hypervisor ç”¨äºå¼•å¯¼è™šæ‹Ÿæœºã€‚ Kata Containers ä¸­æä¾›äº†ä¸€ä¸ªå¯¹è™šæœºå¯åŠ¨æ—¶é—´å’Œå†…å­˜å ç”¨åšäº†é«˜åº¦ä¼˜åŒ–çš„é»˜è®¤å†…æ ¸ï¼Œä»…æä¾›äº†å®¹å™¨å·¥ä½œè´Ÿè½½æ‰€éœ€çš„å¿…è¦æœåŠ¡ã€‚è¯¥å†…æ ¸æ˜¯åŸºäºæœ€æ–°çš„ä¸Šæ¸¸ Linux å†…æ ¸åšçš„å®šåˆ¶åŒ–ã€‚</p><h2 id="image"><a href="#image" class="headerlink" title="image"></a>image</h2><p>hypervisor ä½¿ç”¨ä¸€ä¸ªé•œåƒæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æä¾›äº†ä¸€ä¸ªæœ€å°çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä¾› guest å†…æ ¸ç”¨æ¥å¯åŠ¨ VM å’Œæ‰˜ç®¡ Kata å®¹å™¨ã€‚ Kata Containers æ”¯æŒåŸºäº initrd å’Œ rootfs çš„æœ€å° guest é•œåƒï¼ˆä½†æ˜¯ï¼Œå¹¶éæ‰€æœ‰çš„ hypervisor å‡æ”¯æŒï¼‰ã€‚é»˜è®¤åŒ…åŒæ—¶æä¾› image å’Œ initrdï¼Œä¸¤è€…éƒ½æ˜¯ä½¿ç”¨ osbuilder å·¥å…·åˆ›å»ºçš„ã€‚</p><h3 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h3><p>é»˜è®¤æ‰“åŒ…çš„ rootfs æ˜ åƒï¼Œä¹Ÿç§° mini O&#x2F;Sï¼Œæ˜¯ä¸€ä¸ªé«˜åº¦ä¼˜åŒ–çš„å®¹å™¨å¼•å¯¼ç³»ç»Ÿã€‚</p><p>ä½¿ç”¨æ­¤é•œåƒå¯åŠ¨ Kata å®¹å™¨çš„èƒŒåæµç¨‹ä¸ºï¼š</p><ol><li>è¿è¡Œæ—¶å°†å¯åŠ¨ hypervisor</li><li>hypervisor å°†ä½¿ç”¨ guest å†…æ ¸å¯åŠ¨ rootfs é•œåƒ</li><li>å†…æ ¸å°†åœ¨ VM æ ¹ç¯å¢ƒä¸­ä»¥ PID 1ï¼ˆsystemdï¼‰å¯åŠ¨ init å®ˆæŠ¤è¿›ç¨‹</li><li>åœ¨ rootfs ä¸Šä¸‹æ–‡ä¸­è¿è¡Œçš„ systemd å°†åœ¨ VM çš„æ ¹ä¸Šä¸‹æ–‡ä¸­å¯åŠ¨ kata-agent</li><li>kata-agent å°†åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ç¯å¢ƒï¼Œå°†å…¶æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾ç½®ä¸ºç”¨æˆ·è¯·æ±‚çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚ Ubuntuã€busybox ç­‰ï¼‰</li><li>kata-agent å°†åœ¨æ–°å®¹å™¨å†…æ‰§è¡Œå®¹å™¨å¯åŠ¨å‘½ä»¤</li></ol><p>ä¸‹è¡¨æ€»ç»“äº†é»˜è®¤çš„ rootfsï¼Œæ˜¾ç¤ºäº†åˆ›å»ºçš„ç¯å¢ƒã€åœ¨è¿™äº›ç¯å¢ƒä¸­è¿è¡Œçš„æœåŠ¡ï¼ˆé€‚ç”¨äºæ‰€æœ‰å¹³å°ï¼‰ä»¥åŠæ¯ä¸ªæœåŠ¡ä½¿ç”¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼š</p><table><thead><tr><th>Process</th><th>Environment</th><th>systemd service?</th><th>rootfs</th><th>User accessible</th><th>Notes</th></tr></thead><tbody><tr><td>systemd</td><td>VM root</td><td>n&#x2F;a</td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/guest-assets.md#guest-image">VM guest image</a></td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/Developer-Guide.md#connect-to-debug-console">debug console</a></td><td>The init daemon, running as PID 1</td></tr><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/README.md#agent">Agent</a></td><td>VM root</td><td>yes</td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/guest-assets.md#guest-image">VM guest image</a></td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/Developer-Guide.md#connect-to-debug-console">debug console</a></td><td>Runs as a systemd service</td></tr><tr><td><code>chronyd</code></td><td>VM root</td><td>yes</td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/guest-assets.md#guest-image">VM guest image</a></td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/Developer-Guide.md#connect-to-debug-console">debug console</a></td><td>Used to synchronise the time with the host</td></tr><tr><td>container workload (<code>sh(1)</code> in <a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/example-command.md">the example</a>)</td><td>VM container</td><td>no</td><td>User specified (Ubuntu in <a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/example-command.md">the example</a>)</td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/README.md#exec-command">exec command</a></td><td>Managed by the agent</td></tr></tbody></table><div align=center><img width="600" style="border: 0px" src="/gallery/kata-containers/rootfs.png"></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -ef</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span></span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">root         1     0  0 11:53 ?        00:00:00 /sbin/init</span><br><span class="line">root         2     0  0 11:53 ?        00:00:00 [kthreadd]</span><br><span class="line">&lt;skip...&gt;</span><br><span class="line">root        61     1  0 11:53 ?        00:00:00 /usr/bin/kata-agent</span><br><span class="line">root        71    61  0 11:53 ?        00:00:00 /pause</span><br><span class="line">root        73    61  0 11:53 ?        00:00:00 tail -f /dev/null</span><br><span class="line">root        75    61  0 11:55 pts/0    00:00:00 [bash]</span><br><span class="line">root        77    75  0 11:55 pts/0    00:00:00 ps -ef</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./usr/bin/kata-agent</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span></span><br><span class="line">&#123;&quot;msg&quot;:&quot;announce&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;ts&quot;:&quot;2021-07-14T14:56:42.558066805+08:00&quot;,&quot;source&quot;:&quot;agent&quot;,&quot;pid&quot;:&quot;88325&quot;,&quot;subsystem&quot;:&quot;root&quot;,&quot;name&quot;:&quot;kata-agent&quot;,&quot;version&quot;:&quot;0.1.0&quot;,&quot;api-version&quot;:&quot;0.0.1&quot;,&quot;agent-version&quot;:&quot;2.1.0&quot;,&quot;config&quot;:&quot;AgentConfig &#123; debug_console: false, dev_mode: false, log_level: Info, hotplug_timeout: 3s, debug_console_vport: 0, log_vport: 0, container_pipe_size: 0, server_addr: \&quot;vsock://-1:1024\&quot;, unified_cgroup_hierarchy: false &#125;&quot;,&quot;agent-type&quot;:&quot;rust&quot;,&quot;agent-commit&quot;:&quot;2.1.0-645e950b8e0e238886adbff695a793126afb584f&quot;&#125;</span><br><span class="line">&#123;&quot;msg&quot;:&quot;starting uevents handler&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;ts&quot;:&quot;2021-07-14T14:56:42.558356885+08:00&quot;,&quot;name&quot;:&quot;kata-agent&quot;,&quot;source&quot;:&quot;agent&quot;,&quot;subsystem&quot;:&quot;uevent&quot;,&quot;pid&quot;:&quot;88325&quot;,&quot;version&quot;:&quot;0.1.0&quot;&#125;</span><br><span class="line">&#123;&quot;msg&quot;:&quot;ttRPC server started&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;ts&quot;:&quot;2021-07-14T14:56:42.558522099+08:00&quot;,&quot;name&quot;:&quot;kata-agent&quot;,&quot;source&quot;:&quot;agent&quot;,&quot;version&quot;:&quot;0.1.0&quot;,&quot;subsystem&quot;:&quot;rpc&quot;,&quot;pid&quot;:&quot;88325&quot;,&quot;address&quot;:&quot;vsock://-1:1024&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="initrd"><a href="#initrd" class="headerlink" title="initrd"></a>initrd</h3><p>initrd é•œåƒæ˜¯ä¸€ä¸ªå‹ç¼©çš„ cpio(1) å½’æ¡£æ–‡ä»¶ï¼Œå®ƒæ˜¯ä»åŠ è½½åˆ°å†…å­˜ä¸­çš„ rootfs åˆ›å»ºçš„ï¼Œå¹¶ç”¨ä½œ Linux å¯åŠ¨è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå†…æ ¸å°†å…¶è§£å‹åˆ°ä¸€ä¸ªç‰¹æ®Šçš„ tmpfs æŒ‚è½½å®ä¾‹ä¸­ï¼Œè¯¥å®ä¾‹æˆä¸ºåˆå§‹æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>ä½¿ç”¨æ­¤é•œåƒå¯åŠ¨ Kata å®¹å™¨çš„èƒŒåæµç¨‹ä¸ºï¼š</p><ol><li>è¿è¡Œæ—¶å°†å¯åŠ¨ hypervisor</li><li>hypervisor å°†ä½¿ç”¨ guest å†…æ ¸å¯åŠ¨ initrd é•œåƒ</li><li>å†…æ ¸å°†åœ¨ VM æ ¹ç¯å¢ƒä¸­ä»¥ PID 1ï¼ˆkata-agentï¼‰å¯åŠ¨ init å®ˆæŠ¤è¿›ç¨‹</li><li>kata-agent å°†åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ç¯å¢ƒï¼Œå°†å…¶æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾ç½®ä¸ºç”¨æˆ·è¯·æ±‚çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚ Ubuntuã€busybox ç­‰ï¼‰</li><li>kata-agent å°†åœ¨æ–°å®¹å™¨å†…æ‰§è¡Œå®¹å™¨å¯åŠ¨å‘½ä»¤</li></ol><p>ä¸‹è¡¨æ€»ç»“äº†é»˜è®¤çš„ initrdï¼Œæ˜¾ç¤ºäº†åˆ›å»ºçš„ç¯å¢ƒã€åœ¨è¿™äº›ç¯å¢ƒä¸­è¿è¡Œçš„æœåŠ¡ï¼ˆé€‚ç”¨äºæ‰€æœ‰å¹³å°ï¼‰ä»¥åŠæ¯ä¸ªæœåŠ¡ä½¿ç”¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼š</p><table><thead><tr><th>Process</th><th>Environment</th><th>rootfs</th><th>User accessible</th><th>Notes</th></tr></thead><tbody><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/README.md#agent">Agent</a></td><td>VM root</td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/guest-assets.md#guest-image">VM guest image</a></td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/Developer-Guide.md#connect-to-debug-console">debug console</a></td><td>Runs as the init daemon (PID 1)</td></tr><tr><td>container workload</td><td>VM container</td><td>User specified (Ubuntu in this example)</td><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/README.md#exec-command">exec command</a></td><td>Managed by the agent</td></tr></tbody></table><div align=center><img width="600" style="border: 0px" src="/gallery/kata-containers/initrd.png"></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -ef</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span></span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">root         1     0  0 06:23 hvc0     00:00:02 /init</span><br><span class="line">root         2     0  0 06:23 ?        00:00:00 [kthreadd]</span><br><span class="line">&lt;skip...&gt;</span><br><span class="line">root        41     1  0 06:23 hvc0     00:00:00 /pause</span><br><span class="line">root        43     1  0 06:23 hvc0     00:00:00 tail -f /dev/null</span><br><span class="line">root        45     1  0 06:24 pts/0    00:00:00 [bash]</span><br><span class="line">root        58    45  0 06:27 pts/0    00:00:00 ps -ef</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./sbin/init</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span></span><br><span class="line">&#123;&quot;msg&quot;:&quot;announce&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;ts&quot;:&quot;2021-07-14T14:58:37.454291069+08:00&quot;,&quot;source&quot;:&quot;agent&quot;,&quot;pid&quot;:&quot;66236&quot;,&quot;name&quot;:&quot;kata-agent&quot;,&quot;subsystem&quot;:&quot;root&quot;,&quot;version&quot;:&quot;0.1.0&quot;,&quot;api-version&quot;:&quot;0.0.1&quot;,&quot;agent-type&quot;:&quot;rust&quot;,&quot;agent-commit&quot;:&quot;2.1.0-645e950b8e0e238886adbff695a793126afb584f&quot;,&quot;agent-version&quot;:&quot;2.1.0&quot;,&quot;config&quot;:&quot;AgentConfig &#123; debug_console: false, dev_mode: false, log_level: Info, hotplug_timeout: 3s, debug_console_vport: 0, log_vport: 0, container_pipe_size: 0, server_addr: \&quot;vsock://-1:1024\&quot;, unified_cgroup_hierarchy: false &#125;&quot;&#125;</span><br><span class="line">&#123;&quot;msg&quot;:&quot;starting uevents handler&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;ts&quot;:&quot;2021-07-14T14:58:37.455243334+08:00&quot;,&quot;version&quot;:&quot;0.1.0&quot;,&quot;subsystem&quot;:&quot;uevent&quot;,&quot;name&quot;:&quot;kata-agent&quot;,&quot;pid&quot;:&quot;66236&quot;,&quot;source&quot;:&quot;agent&quot;&#125;</span><br><span class="line">&#123;&quot;msg&quot;:&quot;ttRPC server started&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;ts&quot;:&quot;2021-07-14T14:58:37.455325746+08:00&quot;,&quot;version&quot;:&quot;0.1.0&quot;,&quot;pid&quot;:&quot;66236&quot;,&quot;subsystem&quot;:&quot;rpc&quot;,&quot;source&quot;:&quot;agent&quot;,&quot;name&quot;:&quot;kata-agent&quot;,&quot;address&quot;:&quot;vsock://-1:1024&quot;&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€»ç»“</strong></p><table><thead><tr><th>Image type</th><th>Default distro</th><th>Init daemon</th><th>Reason</th><th>Notes</th></tr></thead><tbody><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/background.md#root-filesystem-image">image</a></td><td><a href="https://clearlinux.org/">Clear Linux</a> (for x86_64 systems)</td><td>systemd</td><td>Minimal and highly optimized</td><td>systemd offers flexibility</td></tr><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/guest-assets.md#initrd-image">initrd</a></td><td><a href="https://alpinelinux.org/">Alpine Linux</a></td><td>Kata <a href="https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/README.md#agent">agent</a> (as no systemd support)</td><td>Security hardened and tiny C library</td><td></td></tr></tbody></table><h2 id="osbuilder"><a href="#osbuilder" class="headerlink" title="osbuilder"></a>osbuilder</h2><p>osbuilder æœ¬èº«æ˜¯ Kata Containers é¡¹ç›®ä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œä¸»è¦è´Ÿè´£æ„å»º guest OS çš„å¼•å¯¼é•œåƒã€‚</p><p>Kata Containers æ”¯æŒä¸¤ç§å¼•å¯¼é•œåƒï¼šrootfs å’Œ initrdã€‚æ— è®ºå“ªç§æ–¹å¼ï¼Œé»˜è®¤éƒ½ä¼šå°† kata-agent ç¼–è¯‘åˆ°é•œåƒä¸­ï¼Œåœ¨å¯¹ kata-agent æœ‰å®šåˆ¶åŒ–éœ€æ±‚çš„åœºæ™¯ä¸‹ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¯‘åæ·»åŠ åˆ°é•œåƒä¸­ã€‚</p><h1 id="Virtualization"><a href="#Virtualization" class="headerlink" title="Virtualization"></a>Virtualization</h1><p>Kata å®¹å™¨æ˜¯åœ¨ä¼ ç»Ÿ namespace éš”ç¦»ä¹‹ä¸Šåˆ›å»ºçš„ä»¥ç¡¬ä»¶è™šæ‹ŸåŒ–ä¸ºåŸºç¡€çš„ç¬¬äºŒå±‚éš”ç¦»ã€‚ Kata å¯åŠ¨ä¸€ä¸ªè½»é‡çº§è™šæ‹Ÿæœºï¼Œå¹¶ä½¿ç”¨ guest ä¸­ç‰¹ä¾›çš„å†…æ ¸æ¥æ‰¿è½½å®¹å™¨å·¥ä½œè´Ÿè½½ã€‚</p><h2 id="æ¥å£æ˜ å°„"><a href="#æ¥å£æ˜ å°„" class="headerlink" title="æ¥å£æ˜ å°„"></a>æ¥å£æ˜ å°„</h2><p>Kata å®¹å™¨çš„å…¸å‹éƒ¨ç½²åœºæ™¯æ˜¯å€ŸåŠ© CRI å®ç°åœ¨ Kubernetes ä¸­è¿›è¡Œã€‚åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒKubelet å°†ä¸ CRI å®ç°è€…ï¼ˆå¦‚ Containerd æˆ– CRI-O ç­‰ï¼‰äº¤äº’ï¼ŒCRI å®ç°è€…å°†ä¸ Kata Containersï¼ˆåŸºäº OCI è§„èŒƒçš„åº•å±‚è¿è¡Œæ—¶ï¼‰äº¤äº’ã€‚</p><div align=center><img width="700" style="border: 0px" src="/gallery/kata-containers/virtual-map.png"></div><h2 id="hypervisorï¼ˆVMMï¼‰"><a href="#hypervisorï¼ˆVMMï¼‰" class="headerlink" title="hypervisorï¼ˆVMMï¼‰"></a>hypervisorï¼ˆVMMï¼‰</h2><p>Kata Containers æœ¬èº«æ”¯æŒå¤šç§ hypervisor å·¥å…·ï¼Œå¦‚ QEMUã€cloud-hypervisorã€firecrackerã€ACRN å’Œ Dragonballï¼ˆKata 3.0 å¼•å…¥ï¼‰ã€‚</p><table><thead><tr><th>Hypervisor</th><th>Written in</th><th>Architectures</th><th>Type</th><th>Configuration file</th></tr></thead><tbody><tr><td><a href="https://projectacrn.org/">ACRN</a></td><td>C</td><td>x86_64</td><td>Type 1 (bare metal)</td><td>configuration-acrn.toml</td></tr><tr><td><a href="https://github.com/cloud-hypervisor/cloud-hypervisor">Cloud Hypervisor</a></td><td>rust</td><td>aarch64, x86_64</td><td>Type 2 (<a href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">KVM</a>)</td><td>configuration-clh.toml</td></tr><tr><td><a href="https://github.com/firecracker-microvm/firecracker">Firecracker</a></td><td>rust</td><td>aarch64, x86_64</td><td>Type 2 (<a href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">KVM</a>)</td><td>configuration-fc.toml</td></tr><tr><td><a href="http://www.qemu-project.org/">QEMU</a></td><td>C</td><td>all</td><td>Type 2 (<a href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">KVM</a>)</td><td>configuration-qemu.toml</td></tr><tr><td><a href="https://github.com/openanolis/dragonball-sandbox">Dragonball</a></td><td>rust</td><td>aarch64, x86_64</td><td>Type 2 (<a href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">KVM</a>)</td><td>configuration-dragonball.toml</td></tr></tbody></table><p><strong>å¼‚åŒç‚¹å‚è€ƒ</strong></p><table><thead><tr><th>Hypervisor</th><th>Summary</th><th>Features</th><th>Limitations</th><th>Container Creation speed</th><th>Memory density</th><th>Use cases</th><th>Comment</th></tr></thead><tbody><tr><td><a href="https://projectacrn.org/">ACRN</a></td><td>Safety critical and real-time workloads</td><td></td><td></td><td>excellent</td><td>excellent</td><td>Embedded and IOT systems</td><td>For advanced users</td></tr><tr><td><a href="https://github.com/cloud-hypervisor/cloud-hypervisor">Cloud Hypervisor</a></td><td>Low latency, small memory footprint, small attack surface</td><td>Minimal</td><td></td><td>excellent</td><td>excellent</td><td>High performance modern cloud workloads</td><td></td></tr><tr><td><a href="https://github.com/firecracker-microvm/firecracker">Firecracker</a></td><td>Very slimline</td><td>Extremely minimal</td><td>Doesnâ€™t support all device types</td><td>excellent</td><td>excellent</td><td>Serverless &#x2F; FaaS</td><td></td></tr><tr><td><a href="http://www.qemu-project.org/">QEMU</a></td><td>Lots of features</td><td>Lots</td><td></td><td>good</td><td>good</td><td>Good option for most users</td><td></td></tr><tr><td><a href="https://github.com/openanolis/dragonball-sandbox">Dragonball</a></td><td>Built-in VMM, low CPU and memory overhead</td><td>Minimal</td><td></td><td>excellent</td><td>excellent</td><td>Optimized for most container workloads</td><td>out-of-the-box Kata Containers experience</td></tr></tbody></table><h3 id="QEMU-x2F-KVM"><a href="#QEMU-x2F-KVM" class="headerlink" title="QEMU&#x2F;KVM"></a>QEMU&#x2F;KVM</h3><p>Kata Containers with QEMU ä¸ Kubernetes å®Œå…¨å…¼å®¹ï¼ˆæ­¤å¤–ï¼ŒKata ç¤¾åŒºå¯¹ QEMU ä½œäº†<a href="https://github.com/kata-containers/kata-containers/tree/main/tools/packaging/qemu/patches">å®šåˆ¶åŒ–çš„ patch è¡¥ä¸</a>ï¼‰</p><p>å–å†³äºä¸åŒçš„ host æ¶æ„ï¼ŒKata Containers æ”¯æŒå„ç§æœºå™¨ç±»å‹ï¼ˆmachineï¼‰ï¼Œä¾‹å¦‚ x86 ç³»ç»Ÿä¸Šçš„ q35ã€ARM ç³»ç»Ÿä¸Šçš„ virt å’Œ IBM Power ç³»ç»Ÿä¸Šçš„ pseriesã€‚</p><p>ä½¿ç”¨åˆ°çš„è®¾å¤‡å’Œç‰¹æ€§æœ‰ï¼š</p><ul><li>virtio VSOCK or virtio serial</li><li>virtio block or virtio SCSI</li><li><a href="https://www.redhat.com/en/virtio-networking-series">virtio net</a></li><li>virtio fs or virtio 9p (recommend: virtio fs)</li><li>VFIO</li><li>hotplug</li><li>machine accelerators</li></ul><p>Kata å®¹å™¨ä¸­ä½¿ç”¨åŠ é€Ÿå™¨ï¼ˆacceleratorsï¼‰å’Œçƒ­æ’æ‹”æ¥ç®¡ç†èµ„æºé™åˆ¶ã€ç¼©çŸ­å¯åŠ¨æ—¶é—´å¹¶å‡å°‘å†…å­˜å ç”¨ã€‚</p><p><strong>åŠ é€Ÿå™¨</strong></p><p>åŠ é€Ÿå™¨æ˜¯ç‰¹å®šäºä½“ç³»ç»“æ„çš„ï¼Œå¯ç”¨äºæé«˜æ€§èƒ½å¹¶å¯ç”¨æœºå™¨ç±»å‹çš„ç‰¹å®šåŠŸèƒ½ã€‚ Kata å®¹å™¨ä¸­æ”¯æŒä»¥ä¸‹æœºå™¨åŠ é€Ÿå™¨ï¼š</p><ul><li><p>NVDIMM</p><p>æ­¤æœºå™¨åŠ é€Ÿå™¨ç‰¹å®šäº x86ï¼Œå¹¶ä¸”ä»…æ”¯æŒ q35 æœºå™¨ç±»å‹ã€‚ nvdimm ç”¨äºå°†æ ¹æ–‡ä»¶ç³»ç»Ÿä½œä¸ºæŒä¹…å†…å­˜è®¾å¤‡æä¾›ç»™ VM</p></li></ul><p><strong>è®¾å¤‡çƒ­æ’æ‹”</strong></p><p>Kata Containers VM ä¸ºäº†æ›´å¿«çš„å¯åŠ¨æ—¶é—´å’Œå‡å°‘å†…å­˜å ç”¨ï¼Œå¾€å¾€æ˜¯ä»¥æœ€å°‘çš„èµ„æºå¯åŠ¨ã€‚åœ¨å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œè®¾å¤‡ä¼šçƒ­æ’æ‹”åˆ° VM ä¸­ã€‚ä¾‹å¦‚ï¼Œå½“æŒ‡å®šäº†é¢å¤– CPU æ—¶ï¼Œä¾¿æ˜¯é€šè¿‡çƒ­æ·»åŠ çš„æ–¹å¼è¿½åŠ èµ„æºã€‚ </p><p>Kata Containers æ”¯æŒçƒ­æ·»åŠ ä»¥ä¸‹è®¾å¤‡ï¼š</p><ul><li>Virtio block</li><li>Virtio SCSI</li><li>VFIO</li><li>CPU</li></ul><h3 id="Firecracker-x2F-KVM"><a href="#Firecracker-x2F-KVM" class="headerlink" title="Firecracker&#x2F;KVM"></a>Firecracker&#x2F;KVM</h3><p>Firecracker æ˜¯åŸºäº <a href="https://github.com/rust-vmm">rust-VMM</a> çš„è¡ç”Ÿé¡¹ç›®ï¼Œæ”¯æŒçš„è®¾å¤‡ç±»å‹æœ‰é™ï¼Œä½†èƒ½æä¾›æ›´è½»çš„ä½“é‡å’Œæ”»å‡»é¢ï¼Œä¸“æ³¨äº FaaS åœºæ™¯ã€‚å› æ­¤ï¼Œå¸¦æœ‰ Firecracker VMM çš„ Kata å®¹å™¨æ”¯æŒ CRI API çš„ä¸€ä¸ªå­é›†ã€‚ Firecracker ä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿå…±äº«ï¼Œä»…æ”¯æŒåŸºäºå—å­˜å‚¨é©±åŠ¨ç¨‹åºã€‚ Firecracker ä¸æ”¯æŒè®¾å¤‡çƒ­æ’æ‹”ï¼Œä¹Ÿä¸æ”¯æŒ VFIOã€‚å› æ­¤ï¼Œå¸¦æœ‰ Firecracker VMM çš„ Kata Containers ä¸æ”¯æŒåœ¨å¯åŠ¨åæ›´æ–°å®¹å™¨èµ„æºï¼Œä¹Ÿä¸æ”¯æŒè®¾å¤‡é€ä¼ ã€‚</p><p>æ”¯æŒçš„è®¾å¤‡ç±»å‹ï¼š</p><ul><li>virtio VSOCK</li><li>virtio block</li><li>virtio net</li></ul><h3 id="Cloud-Hypervisor-x2F-KVM"><a href="#Cloud-Hypervisor-x2F-KVM" class="headerlink" title="Cloud Hypervisor&#x2F;KVM"></a>Cloud Hypervisor&#x2F;KVM</h3><p>Cloud Hypervisor åŒæ ·æ˜¯åŸºäº <a href="https://github.com/rust-vmm">rust-VMM</a> çš„è¡ç”Ÿé¡¹ç›®ï¼Œæ—¨åœ¨ä¸ºè¿è¡Œç°ä»£äº‘å·¥ä½œè´Ÿè½½æä¾›æ›´å°çš„å ç”¨ç©ºé—´å’Œæ›´å°çš„æ”»å‡»é¢ã€‚å…·æœ‰ Cloud Hypervisor çš„ Kata Containers æä¾›ä¸ Kubernetes çš„å‡ ä¹å®Œå…¨å…¼å®¹æ€§ï¼Œä¸ QEMU èƒ½åŠ›ç›¸å½“ã€‚ä» Kata Containers 1.12 å’Œ 2.0.0 ç‰ˆæœ¬å¼€å§‹ï¼ŒCloud Hypervisor é…ç½®æ”¯æŒ CPU å’Œå†…å­˜å¤§å°è°ƒæ•´ã€è®¾å¤‡çƒ­æ’æ‹”ï¼ˆç£ç›˜å’Œ VFIOï¼‰ã€é€šè¿‡ virtio-fs å…±äº«æ–‡ä»¶ç³»ç»Ÿã€åŸºäºå—çš„å·ã€ä» VM é•œåƒå¯åŠ¨ç”± pmem è®¾å¤‡æ”¯æŒï¼Œå¹¶ä¸ºæ¯ä¸ª VMM çº¿ç¨‹ï¼ˆä¾‹å¦‚æ‰€æœ‰ virtio è®¾å¤‡å·¥ä½œçº¿ç¨‹ï¼‰æä¾›ç»†ç²’åº¦çš„ seccomp è¿‡æ»¤å™¨ã€‚</p><p>æ”¯æŒçš„è®¾å¤‡ç±»å‹ä¸ç‰¹æ€§ï¼š</p><ul><li>virtio VSOCK or virtio serial</li><li>virtio block</li><li>virtio net</li><li>virtio fs</li><li>virtio pmem</li><li>VFIO</li><li>hotplug</li><li>seccomp filters</li><li><a href="https://github.com/cloud-hypervisor/cloud-hypervisor/blob/main/vmm/src/api/openapi/cloud-hypervisor.yaml">HTTP OpenAPI</a></li></ul><p><strong>æ€»ç»“</strong></p><table><thead><tr><th>Solution</th><th>release introduced</th><th>brief summary</th></tr></thead><tbody><tr><td>Cloud Hypervisor</td><td>1.10</td><td>upstream Cloud Hypervisor with rich feature support, e.g. hotplug, VFIO and FS sharing</td></tr><tr><td>Firecracker</td><td>1.5</td><td>upstream Firecracker, rust-VMM based, no VFIO, no FS sharing, no memory&#x2F;CPU hotplug</td></tr><tr><td>QEMU</td><td>1.0</td><td>upstream QEMU, with support for hotplug and filesystem sharing</td></tr></tbody></table><h1 id="Storage"><a href="#Storage" class="headerlink" title="Storage"></a>Storage</h1><p>Kata Containers ä¸ç°æœ‰æ ‡å‡†è¿è¡Œæ—¶å…¼å®¹ã€‚ä»å­˜å‚¨çš„è§’åº¦æ¥çœ‹ï¼Œè¿™æ„å‘³ç€å®¹å™¨å·¥ä½œè´Ÿè½½å¯èƒ½ä½¿ç”¨çš„å­˜å‚¨é‡æ²¡æœ‰é™åˆ¶ã€‚ç”±äº cgroups æ— æ³•è®¾ç½®å­˜å‚¨åˆ†é…é™åˆ¶ï¼Œå¦‚æœå¸Œæœ›é™åˆ¶å®¹å™¨ä½¿ç”¨çš„å­˜å‚¨é‡ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ç°æœ‰è®¾æ–½ï¼Œä¾‹å¦‚ quota(1) é™åˆ¶æˆ– device mapper é™åˆ¶ã€‚</p><h2 id="virtio-SCSI"><a href="#virtio-SCSI" class="headerlink" title="virtio SCSI"></a>virtio SCSI</h2><p>virtio-scsi ç”¨äºå°†å·¥ä½œè´Ÿè½½é•œåƒï¼ˆä¾‹å¦‚ busybox:latestï¼‰å…±äº«åˆ° VM å†…çš„å®¹å™¨ç¯å¢ƒä¸­ã€‚ç°é˜¶æ®µï¼ŒKata Containers æ”¯æŒ virtio SCSI å’Œ virtio BLKï¼Œåè€…ç”±äºè¾ƒå¤šé™åˆ¶å·²ä¸åšæ¨èã€‚</p><h2 id="virtio-FS"><a href="#virtio-FS" class="headerlink" title="virtio FS"></a>virtio FS</h2><p>virtio-fsï¼ˆVIRTIOï¼‰è¦†ç›–æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹æ¥å…±äº«å·¥ä½œè´Ÿè½½é•œåƒã€‚kata-agent ä½¿ç”¨æ­¤æŒ‚è½½ç‚¹ä½œä¸ºå®¹å™¨è¿›ç¨‹çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p><p>å¯¹äº virtio-fsï¼Œè¿è¡Œæ—¶ä¸ºæ¯ä¸ªåˆ›å»ºçš„ VM å¯åŠ¨ä¸€ä¸ª virtiofsd å®ˆæŠ¤è¿›ç¨‹ï¼ˆåœ¨ä¸»æœºä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼‰ã€‚</p><p>Kata Containers ä½¿ç”¨è½»é‡çº§è™šæ‹Ÿæœºå’Œç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯æ¥æä¾›æ›´å¼ºéš”ç¦»ï¼Œä»¥æ„å»ºå®‰å…¨çš„å®¹å™¨è¿è¡Œæ—¶ã€‚ä½†ä¹Ÿæ­£æ˜¯å› ä¸ºä½¿ç”¨äº†è™šæ‹Ÿæœºï¼Œå®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿæ— æ³•åƒ runC é‚£æ ·ç›´æ¥ä½¿ç”¨ä¸»æœºä¸Šæ„å»ºå¥½çš„ç›®å½•ï¼Œè€Œéœ€è¦æœ‰ä¸€ç§æ–¹æ³•æŠŠ host ä¸Šçš„ç›®å½•å…±äº«ç»™ guestã€‚</p><p>åœ¨æ­¤ä¹‹å‰ï¼Œæœ‰ä¸¤ç§æ–¹æ³•èƒ½å¤Ÿé€ä¼  host ç›®å½•æˆ–è€…æ•°æ®ç»™ guestï¼Œä¸€ç§æ˜¯åŸºäº file çš„æ–¹æ¡ˆï¼Œä¸€ä¸ªæ˜¯åŸºäº block çš„æ–¹æ¡ˆã€‚è€Œè¿™ä¸¤ç§æ–¹æ¡ˆå„æœ‰åˆ©å¼Šï¼Œè¿™é‡Œåˆ†åˆ«ä»¥ 9pfs å’Œ devicemapper ä¸ºä¾‹æ¥è¯´æ˜ï¼š</p><table><thead><tr><th></th><th>9pfs</th><th>devicemapper</th></tr></thead><tbody><tr><td>ä¼˜åŠ¿</td><td>ä½¿ç”¨ host çš„ overlayfsï¼Œå……åˆ†åˆ©ç”¨ host page cache</td><td>æ€§èƒ½è¾ƒå¥½ï¼ŒPOSIX è¯­ä¹‰å…¼å®¹æ€§è¾ƒå¥½</td></tr><tr><td>ç—›ç‚¹</td><td>åŸºäºç½‘ç»œåè®®ï¼Œæœªå¯¹è™šæ‹ŸåŒ–åœºæ™¯åšä¼˜åŒ–ï¼Œæ€§èƒ½è¾ƒå·®ï¼›POSIX è¯­ä¹‰å…¼å®¹æ€§ä¸å¥½</td><td>æ— æ³•åˆ©ç”¨ host page cacheï¼Œéœ€è¦ç»´æŠ¤ lvm volume</td></tr></tbody></table><p>é’ˆå¯¹ä»¥ä¸Šä¸¤ä¸ªæ–¹æ¡ˆçš„ç—›ç‚¹å’Œä¼˜åŠ¿ï¼Œvirtio-fs åœ¨æŸç§ç¨‹åº¦ä¸Šåšäº†å¾ˆå¥½çš„äº’è¡¥ï¼Œåœ¨ Kata Containers ä¸­ï¼Œæ”¯æŒä¸¤ç§æ–‡ä»¶å…±äº«æ–¹å¼ï¼švirtio-fs å’Œ virtio-9pï¼Œåœ¨ Kata Containers 2.x ä¹‹åï¼Œvirtio-fs ä½œä¸ºé»˜è®¤ä¸”æ¨èçš„æ–¹æ¡ˆé€‰æ‹©ã€‚</p><p>virtio-fs æœ¬èº«é‡‡ç”¨ç±»ä¼¼äº CS çš„æ¶æ„ï¼Œé€‰æ‹© FUSE ä½œä¸ºæ–‡ä»¶ç³»ç»Ÿï¼Œè€Œéç½‘ç»œæ–‡ä»¶ç³»ç»Ÿåè®®ã€‚server ç«¯æ˜¯ä½äº host ä¸Šçš„ virtiofsdï¼Œç”¨äºå‘ guest æä¾› fuse æœåŠ¡ï¼›client ç«¯æ˜¯æŠŠ guest kernel æŠ½è±¡æˆä¸€ä¸ª fuse clientï¼Œç”¨äºæŒ‚è½½ host ä¸Šå¯¼å‡ºçš„ç›®å½•ã€‚ä¸¤è€…ä¹‹é—´é€šè¿‡ vhost_user å»ºç«‹è¿æ¥ã€‚</p><p>æœ€å¤§çš„ç‰¹ç‚¹æ˜¯åˆ©ç”¨äº† VM å’Œ VMM åŒæ—¶éƒ¨ç½²åœ¨ä¸€ä¸ª host ä¸Šçš„ï¼Œæ•°æ®çš„å…±äº«è®¿é—®éƒ½æ˜¯é€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼ï¼Œé¿å…äº† VM å’Œ VMM ä¹‹é—´çš„ç½‘ç»œé€šè®¯ï¼Œå…±äº«å†…å­˜è®¿é—®æ¯”åŸºäºç½‘ç»œæ–‡ä»¶ç³»ç»Ÿåè®®è®¿é—®è¦æ›´è½»é‡çº§ä¹Ÿæœ‰æ›´å¥½çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè¯­ä¹‰å’Œä¸€è‡´æ€§ã€‚åœ¨é¢å¯¹å¤š guest è¦ mmap åŒä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œvirtio-fs ä¼šå°†è¯¥æ–‡ä»¶ mmap åˆ° QEMU çš„è¿›ç¨‹ç©ºé—´é‡Œï¼Œå…¶ä½™çš„ guest é€šè¿‡ DAX ç›´æ¥è®¿é—®ã€‚</p><div align=center><img width="400" style="border: 0px" src="/gallery/kata-containers/virtiofs.png"></div><div align=center><img width="700" style="border: 0px" src="/gallery/kata-containers/virtiofs-detail.png"></div><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">qemu è¿›ç¨‹å‚æ•°èŠ‚é€‰</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ps -ef | grep qemu</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span></span><br><span class="line">/usr/bin/qemu-system-x86_64</span><br><span class="line">-name sandbox-f13846d4f1d58e82b2d3f461c3f2296c57992d415e32d7b41f689cf1126ee8d9</span><br><span class="line">-uuid 50041ac8-a9ed-4a60-9db1-44a55b2343d8</span><br><span class="line">-machine pc,accel=kvm,kernel_irqchip</span><br><span class="line">-cpu host,pmu=off</span><br><span class="line"> </span><br><span class="line">-device vhost-vsock-pci,disable-modern=false,vhostfd=3,id=vsock-117410659,guest-cid=117410659 -chardev socket,id=char-25f51af992a053e1,path=/run/vc/vm/f13846d4f1d58e82b2d3f461c3f2296c57992d415e32d7b41f689cf1126ee8d9/vhost-fs.sock -device vhost-user-fs-pci,chardev=char-25f51af992a053e1,tag=kataShared</span><br><span class="line"> </span><br><span class="line">-kernel /usr/share/kata-containers/vmlinux-5.10.25-85</span><br><span class="line">-initrd /usr/share/kata-containers/kata-containers-initrd-2021-07-14-11:02:27.932339999+0800-645e950</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å®¿ä¸»æœºå…±äº«ç›®å½•</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ll /run/kata-containers/shared/sandboxes/f13846d4f1d58e82b2d3f461c3f2296c57992d415e32d7b41f689cf1126ee8d9/shared</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span></span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 3 root root  60 Jul 19 14:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e</span><br><span class="line">            drwxr-xr-x 1 root root 40 Jul 19 14:57 rootfs</span><br><span class="line">-rw-rw-rw- 1 root root   0 Jul 19 14:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-1b95530f54b2fab0-termination-log</span><br><span class="line">drwxrwxrwt 3 root root 140 Jul 19 14:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-395f94e69275ce07-serviceaccount</span><br><span class="line">            lrwxrwxrwx 1 root root 13 Jul 19 14:57 ca.crt -&gt; ..data/ca.crt</span><br><span class="line">            lrwxrwxrwx 1 root root 16 Jul 19 14:57 namespace -&gt; ..data/namespace</span><br><span class="line">            lrwxrwxrwx 1 root root 12 Jul 19 14:57 token -&gt; ..data/token</span><br><span class="line">-rw-r--r-- 1 root root 212 Jul 19 14:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-45f076005d889842-hosts</span><br><span class="line">-rw-r--r-- 1 root root 103 Jul 19 14:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-70624933bdd41bd7-resolv.conf</span><br><span class="line">-rw-r--r-- 1 root root  15 Jul 19 14:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-c4568deafa816abf-hostname</span><br><span class="line">drwxr-xr-x 3 root root  60 Jul 19 14:57 f13846d4f1d58e82b2d3f461c3f2296c57992d415e32d7b41f689cf1126ee8d9</span><br><span class="line">            drwxr-xr-x 1 root root 40 Jul 19 14:57 rootfs</span><br><span class="line">-rw-r--r-- 1 root root 103 Jul 19 14:57 f13846d4f1d58e82b2d3f461c3f2296c57992d415e32d7b41f689cf1126ee8d9-172f4c5d001a82b4-resolv.conf</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è™šæ‹Ÿæœº mount ç‚¹</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mount | grep kataShared</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span></span><br><span class="line">kataShared on /run/kata-containers/shared/containers type virtiofs (rw,relatime)</span><br><span class="line">kataShared on /run/kata-containers/f13846d4f1d58e82b2d3f461c3f2296c57992d415e32d7b41f689cf1126ee8d9/rootfs type virtiofs (rw,relatime)</span><br><span class="line">kataShared on /run/kata-containers/6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e/rootfs type virtiofs (rw,relatime)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è™šæ‹Ÿæœºå…±äº«ç›®å½•</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">ls</span> -l /run/kata-containers/shared/containers</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt;</span></span><br><span class="line">total 16</span><br><span class="line">drwxr-xr-x 3 root root  60 Jul 19 06:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e</span><br><span class="line">-rw-rw-rw- 1 root root   0 Jul 19 06:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-1b95530f54b2fab0-termination-log</span><br><span class="line">drwxrwxrwt 3 root root 140 Jul 19 06:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-395f94e69275ce07-serviceaccount</span><br><span class="line">-rw-r--r-- 1 root root 212 Jul 19 06:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-45f076005d889842-hosts</span><br><span class="line">-rw-r--r-- 1 root root 103 Jul 19 06:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-70624933bdd41bd7-resolv.conf</span><br><span class="line">-rw-r--r-- 1 root root  15 Jul 19 06:57 6cc73ba11330cfbdb54bf40c77613d5f832aad01413d566ff8dabbf4e29d748e-c4568deafa816abf-hostname</span><br><span class="line">drwxr-xr-x 3 root root  60 Jul 19 06:57 f13846d4f1d58e82b2d3f461c3f2296c57992d415e32d7b41f689cf1126ee8d9</span><br><span class="line">-rw-r--r-- 1 root root 103 Jul 19 06:57 f13846d4f1d58e82b2d3f461c3f2296c57992d415e32d7b41f689cf1126ee8d9-172f4c5d001a82b4-resolv.conf</span><br></pre></td></tr></table></figure><div align=center><img width="600" style="border: 0px" src="/gallery/kata-containers/storage-compare.png"></div><h2 id="Devicemapper"><a href="#Devicemapper" class="headerlink" title="Devicemapper"></a>Devicemapper</h2><p>devicemapper snapshotter æ˜¯ä¸€ä¸ªç‰¹ä¾‹ã€‚snapshotter ä½¿ç”¨ä¸“ç”¨çš„å—è®¾å¤‡è€Œä¸æ˜¯æ ¼å¼åŒ–çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”åœ¨å—çº§åˆ«è€Œä¸æ˜¯æ–‡ä»¶çº§åˆ«è¿è¡Œã€‚ç”¨äºå®¹å™¨æ ¹æ–‡ä»¶ç³»ç»Ÿç›´æ¥ä½¿ç”¨åº•å±‚å—è®¾å¤‡è€Œä¸æ˜¯è¦†ç›–æ–‡ä»¶ç³»ç»Ÿã€‚å—è®¾å¤‡æ˜ å°„åˆ°è¦†ç›–å±‚çš„é¡¶éƒ¨è¯»å†™å±‚ã€‚ä¸ä½¿ç”¨ virtio-fs å…±äº«å®¹å™¨æ–‡ä»¶ç³»ç»Ÿç›¸æ¯”ï¼Œè¿™ç§æ–¹æ³•æä¾›äº†æ›´å¥½çš„ I&#x2F;O æ€§èƒ½ã€‚</p><p>Kata Containers å…·æœ‰çƒ­æ’æ‹”æ·»åŠ å’Œçƒ­æ’æ‹”ç§»é™¤å—è®¾å¤‡çš„èƒ½åŠ›ã€‚è¿™ä½¿å¾—åœ¨ VM å¯åŠ¨åå¯åŠ¨çš„å®¹å™¨å¯ä»¥ä½¿ç”¨å—è®¾å¤‡ã€‚</p><p>ç”¨æˆ·å¯ä»¥é€šè¿‡åœ¨å®¹å™¨å†…è°ƒç”¨ mount(8) æ¥æ£€æŸ¥å®¹å™¨æ˜¯å¦ä½¿ç”¨ devicemapper å—è®¾å¤‡ä½œä¸ºå…¶ rootfsã€‚å¦‚æœä½¿ç”¨ devicemapper å—è®¾å¤‡ï¼Œæ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆ&#x2F;ï¼‰å°†ä» &#x2F;dev&#x2F;vda æŒ‚è½½ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡è¿è¡Œæ—¶é…ç½®ç¦æ­¢ç›´æ¥æŒ‚è½½åº•å±‚å—è®¾å¤‡ã€‚</p><h1 id="VSOCKs"><a href="#VSOCKs" class="headerlink" title="VSOCKs"></a>VSOCKs</h1><p>è™šæ‹Ÿæœºä¸­çš„è¿›ç¨‹å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¸ä¸»æœºä¸­çš„è¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼š</p><ul><li>ä½¿ç”¨ä¸²å£ï¼Œè™šæ‹Ÿæœºä¸­çš„è¿›ç¨‹å¯ä»¥åœ¨ä¸²å£è®¾å¤‡è¯»&#x2F;å†™æ•°æ®ï¼Œä¸»æœºä¸­çš„è¿›ç¨‹å¯ä»¥ä»åœ¨ Unix socket è¯»&#x2F;å†™æ•°æ®ã€‚ä½†æ˜¯ï¼Œä¸²è¡Œé“¾æ¥ä¸€æ¬¡é™åˆ¶å¯¹ä¸€ä¸ªè¿›ç¨‹çš„è¯»&#x2F;å†™è®¿é—®</li><li>æ›´æ–°ã€æ›´ç®€å•çš„æ–¹æ³•æ˜¯ VSOCKï¼Œå®ƒå¯ä»¥æ¥å—æ¥è‡ªå¤šä¸ªå®¢æˆ·ç«¯çš„è¿æ¥</li></ul><p>åœ¨ Kata Containers 2.x ä¸­å®ç°é»˜è®¤é‡‡ç”¨ VSOCK çš„æ–¹å¼ï¼ˆä¾èµ– 4.8 ä»¥ä¸Šç‰ˆæœ¬å†…æ ¸å’Œ vhost_vsock å†…æ ¸æ¨¡å—ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.----------------------.</span><br><span class="line">| .------------------. |</span><br><span class="line">| | .-----.  .-----. | |</span><br><span class="line">| | |cont1|  |cont2| | |</span><br><span class="line">| | `-----&#x27;  `-----&#x27; | |</span><br><span class="line">| |       |   |      | |</span><br><span class="line">| |    .---------.   | |</span><br><span class="line">| |    |  agent  |   | |</span><br><span class="line">| |    `---------&#x27;   | |</span><br><span class="line">| |       |   |      | |</span><br><span class="line">| | POD .-------.    | |</span><br><span class="line">| `-----| vsock |----&#x27; |</span><br><span class="line">|       `-------&#x27;      |</span><br><span class="line">|         |   |        |</span><br><span class="line">|  .------.   .------. |</span><br><span class="line">|  | shim |   | shim | |</span><br><span class="line">|  `------&#x27;   `------&#x27; |</span><br><span class="line">| Host                 |</span><br><span class="line">`----------------------&#x27;</span><br></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong></p><ul><li><p>é«˜å¯†åº¦ Pod</p><p>åœ¨ shimv1 ä½¿ç”¨ kata-proxy å»ºç«‹ VM å’Œä¸»æœºä¹‹é—´çš„è¿æ¥ï¼Œæ¯ä¸€ä¸ª Pod çš„å†…å­˜å¤§å°å¤§æ¦‚æ˜¯ 4.5 MB å·¦å³ï¼Œåœ¨é«˜å¯†åº¦ Pod çš„é›†ç¾¤ä¸­ï¼Œå†…å­˜çš„æ¶ˆè€—è¿‡å¤§ã€‚</p></li><li><p>å¯é æ€§</p><p>kata-proxy è´Ÿè´£è™šæ‹Ÿæœºå’Œä¸»æœºè¿›ç¨‹ä¹‹é—´çš„è¿æ¥ï¼Œå¦‚æœ kata-proxy å¼‚å¸¸ï¼Œæ‰€æœ‰è¿æ¥éƒ½ä¼šä¸­æ–­ï¼Œå°½ç®¡å®¹å™¨ä»åœ¨è¿è¡Œã€‚ç”±äºé€šè¿‡ VSOCK çš„é€šä¿¡æ˜¯ç›´æ¥çš„ï¼Œä¸å®¹å™¨å¤±å»é€šä¿¡çš„å”¯ä¸€åœºæ™¯æ˜¯ VM æœ¬èº«æˆ– containerd-shim-kata-v2 å¼‚å¸¸åœæ­¢ï¼Œä½†æ˜¯åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¹å™¨ä¹Ÿä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚</p></li></ul><h1 id="Networking"><a href="#Networking" class="headerlink" title="Networking"></a>Networking</h1><p>Kata Containers å—é™äº hypervisor çš„åŠŸèƒ½ï¼Œæ²¡æœ‰ç›´æ¥é‡‡ç”¨ Docker é»˜è®¤çš„ Bridge ç½‘ç»œæ–¹æ¡ˆï¼Œè€Œæ˜¯é‡‡ç”¨çš„ macvtap æˆ–è€… tcfilterï¼ˆä½¿ç”¨ tc rules å°† veth çš„ ingress å’Œ egress é˜Ÿåˆ—åˆ†åˆ«å¯¹æ¥ tap çš„ egress å’Œ ingress é˜Ÿåˆ—å®ç° veth å’Œ tap çš„ç›´è¿ï¼‰æ–¹æ¡ˆã€‚Kata Containers æœ¬èº«æ˜¯æ”¯æŒ CNI ç®¡ç†ç½‘ç»œçš„ï¼Œç½‘ç»œæ–¹é¢ç›¸æ¯”å®¹å™¨ï¼Œè™½æœ‰é¢å¤–å¼€é”€ä½†å…¼å®¹æ€§ä¸å·®ã€‚</p><p>Docker é»˜è®¤é‡‡ç”¨çš„å®¹å™¨ç½‘ç»œæ–¹æ¡ˆæ˜¯åŸºäº network namespace + bridge + veth pairs çš„ï¼Œå³åœ¨ host ä¸Šåˆ›å»ºä¸€ä¸ª network namespaceï¼Œåœ¨ docker0 ç½‘æ¡¥ä¸Šè¿æ¥ veth pairs çš„ä¸€ç«¯ï¼Œå†å» network namespace ä¸­è¿ä¸Šå¦ä¸€ç«¯ï¼Œæ‰“é€šå®¹å™¨å’Œ host ä¹‹é—´çš„ç½‘ç»œã€‚<br>è¿™ç§æ–¹æ¡ˆå¾—ç›Šäº namespace æŠ€æœ¯ï¼Œè€Œè®¸å¤š hypervisor æ¯”å¦‚ QEMU ä¸èƒ½å¤„ç† veth interfacesã€‚æ‰€ä»¥ Kata Containers ä¸º VM åˆ›å»ºäº† TAP interfaces æ¥æ‰“é€š VM å’Œ host ä¹‹é—´çš„ç½‘ç»œã€‚ä¼ ç»Ÿçš„ Container Engine æ¯”å¦‚ Dockerï¼Œä¼šä¸ºå®¹å™¨åˆ›å»º network namespace å’Œ veth pairï¼Œç„¶å Kata ä¼šå°† veth pair çš„ä¸€ç«¯è¿ä¸Š TAPï¼Œå³ macvtap æ–¹æ¡ˆã€‚</p><div align=center><img width="700" style="border: 0px" src="/gallery/kata-containers/networking.png"></div><p>Kata Containers ç½‘ç»œç”± network namespacesã€tap å’Œ tc æ‰“é€šï¼Œåˆ›å»º sandbox ä¹‹å‰é¦–å…ˆåˆ›å»ºç½‘ç»œå‘½åç©ºé—´ï¼Œé‡Œé¢æœ‰ veth-pair å’Œ tap ä¸¤ç§ç½‘ç»œæ¥å£ï¼Œeth0 å±äº veth-pair ç±»å‹æ¥å£ï¼Œä¸€ç«¯æ¥å…¥ CNI åˆ›å»ºçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œä¸€ç«¯æ¥å…¥å®¿ä¸»æœºï¼›tap0_kata å±äº tap ç±»å‹æ¥å£ï¼Œä¸€ç«¯æ¥å…¥ cni åˆ›å»ºçš„ç½‘ç»œå‘½åç©ºé—´ï¼Œä¸€ç«¯æ¥å…¥ QEMU åˆ›å»ºçš„ hypervisorï¼Œå¹¶ä¸”åœ¨ CNI åˆ›å»ºçš„ç½‘ç»œå‘½åç©ºé—´ä½¿ç”¨ tc ç­–ç•¥æ‰“é€š eth0 ç½‘ç»œæ¥å£å’Œ tap0_kata ç½‘ç»œæ¥å£ï¼Œç›¸å½“äºæŠŠ eth0 å’Œ tap0_kata ä¸¤ä¸ªç½‘ç»œæ¥å£è¿æˆä¸€æ¡çº¿ã€‚</p><p>sandbox ç¯å¢ƒä¸­åªæœ‰ eth0 ç½‘ç»œæ¥å£ï¼Œè¿™ä¸ªæ¥å£æ˜¯ QEMU å’Œ tap æ¨¡æ‹Ÿå‡ºçš„æ¥å£ï¼Œmacã€ipã€æ©ç éƒ½å’Œå®¿ä¸»æœºä¸­ CNI åˆ›å»ºçš„ç½‘ç»œå‘½åç©ºé—´ä¸­ eth0 çš„é…ç½®ä¸€æ ·ã€‚</p><p>å®¹å™¨è¿è¡Œåœ¨ sandbox ç¯å¢ƒä¸­ï¼Œå®¹å™¨é‡‡ç”¨å…±äº«å®¿ä¸»æœºç½‘ç»œå‘½åç©ºé—´æ–¹å¼åˆ›å»ºå®¹å™¨ï¼Œæ‰€ä»¥åœ¨å®¹å™¨ä¸­çœ‹åˆ°çš„ç½‘ç»œé…ç½®å’Œ sandbox ä¸€æ ·ã€‚</p><p><strong>ç½‘ç»œæµé‡èµ°å‘ï¼š</strong><br>æµé‡è¿›å…¥å®¿ä¸»æœºåé¦–å…ˆç”±ç‰©ç†ç½‘ç»œé€šè¿‡ç½‘æ¡¥æˆ–è€…è·¯ç”±æ¥å…¥åˆ°ç½‘ç»œå‘½åç©ºé—´ï¼Œç½‘ç»œå‘½åç©ºé—´ä¸­åœ¨ä½¿ç”¨ tc ç­–ç•¥ç‰µå¼•æµé‡åˆ° tap ç½‘ç»œæ¥å£ï¼Œç„¶åå†é€šè¿‡ tap ç½‘ç»œæ¥å£æŠŠæµé‡é€å…¥è™šæ‹ŸåŒ–ç¯å¢ƒä¸­ï¼Œæœ€åè™šæ‹ŸåŒ–ç¯å¢ƒä¸­çš„å®¹å™¨å…±äº«å®¿ä¸»æœºç½‘ç»œå‘½åç©ºé—´åå°±å¯ä»¥åœ¨å®¹å™¨ä¸­æ‹¿åˆ°ç½‘ç»œæµé‡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 kata]# ip netns exec cni-d27eff58-b9c9-a258-3a1e-a34528d9796f ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">4: eth0@if29: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1430 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    link/ether fe:68:1c:e3:47:da brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 10.244.166.150/32 brd 10.244.166.150 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::fc68:1cff:fee3:47da/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: tap0_kata: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1430 qdisc mq state UNKNOWN group default qlen 1000</span><br><span class="line">    link/ether 76:c7:1b:ab:30:64 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet6 fe80::74c7:1bff:feab:3064/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 kata]# ip netns exec cni-d27eff58-b9c9-a258-3a1e-a34528d9796f tc -s qdisc show dev eth0</span><br><span class="line">qdisc noqueue 0: root refcnt 2</span><br><span class="line"> Sent 0 bytes 0 pkt (dropped 0, overlimits 0 requeues 0)</span><br><span class="line"> backlog 0b 0p requeues 0</span><br><span class="line">qdisc ingress ffff: parent ffff:fff1 ----------------</span><br><span class="line"> Sent 480 bytes 5 pkt (dropped 0, overlimits 0 requeues 0)</span><br><span class="line"> backlog 0b 0p requeues 0</span><br><span class="line"> </span><br><span class="line">[root@node1 kata]# ip netns exec cni-d27eff58-b9c9-a258-3a1e-a34528d9796f tc -s filter show dev eth0 ingress</span><br><span class="line">filter protocol all pref 49152 u32</span><br><span class="line">filter protocol all pref 49152 u32 fh 800: ht divisor 1</span><br><span class="line">filter protocol all pref 49152 u32 fh 800::800 order 2048 key ht 800 bkt 0 terminal flowid ??? not_in_hw  (rule hit 5 success 5)</span><br><span class="line">  match 00000000/00000000 at 0 (success 5 )</span><br><span class="line">        action order 1: mirred (Egress Redirect to device tap0_kata) stolen</span><br><span class="line">        index 1 ref 1 bind 1 installed 439 sec used 437 sec</span><br><span class="line">        Action statistics:</span><br><span class="line">        Sent 480 bytes 5 pkt (dropped 0, overlimits 0 requeues 0)</span><br><span class="line">        backlog 0b 0p requeues 0</span><br><span class="line"> </span><br><span class="line">[root@node1 kata]# ip netns exec cni-d27eff58-b9c9-a258-3a1e-a34528d9796f tc -s filter show dev tap0_kata ingress</span><br><span class="line">filter protocol all pref 49152 u32</span><br><span class="line">filter protocol all pref 49152 u32 fh 800: ht divisor 1</span><br><span class="line">filter protocol all pref 49152 u32 fh 800::800 order 2048 key ht 800 bkt 0 terminal flowid ??? not_in_hw  (rule hit 12 success 12)</span><br><span class="line">  match 00000000/00000000 at 0 (success 12 )</span><br><span class="line">        action order 1: mirred (Egress Redirect to device eth0) stolen</span><br><span class="line">        index 2 ref 1 bind 1 installed 451 sec used 165 sec</span><br><span class="line">        Action statistics:</span><br><span class="line">        Sent 768 bytes 12 pkt (dropped 0, overlimits 0 requeues 0)</span><br><span class="line">        backlog 0b 0p requeues 0</span><br></pre></td></tr></table></figure><div align=center><img width="600" style="border: 0px" src="/gallery/kata-containers/networking2.png"></div><h1 id="Kata-Containers"><a href="#Kata-Containers" class="headerlink" title="Kata Containers"></a>Kata Containers</h1><h2 id="kata-runtime-v1"><a href="#kata-runtime-v1" class="headerlink" title="kata-runtime (v1)"></a>kata-runtime (v1)</h2><p>kata-runtime å®ç° OCI è¿è¡Œæ—¶æ ‡å‡†ï¼Œè´Ÿè´£å¤„ç† OCI æ ‡å‡†å‘½ä»¤ï¼Œå¹¶å¯åŠ¨ kata-shim å®ä¾‹ã€‚</p><h2 id="kata-agent-v1-amp-v2"><a href="#kata-agent-v1-amp-v2" class="headerlink" title="kata-agent (v1 &amp; v2)"></a>kata-agent (v1 &amp; v2)</h2><p>kata-agent æ˜¯è¿è¡Œåœ¨ Kata åˆ›å»ºçš„ VM ä¸­çš„ç®¡ç†ç¨‹åºï¼Œä½¿ç”¨ libcontainer ç®¡ç†å®¹å™¨å’Œå®¹å™¨ä¸­çš„è¿›ç¨‹æœåŠ¡ã€‚å…·ä½“æ¥è¯´ï¼Œkata-agent å€ŸåŠ© QEMUã€VIRTIO serial æˆ– VSOCK interface çš„å½¢å¼åœ¨ host ä¸Šæš´éœ²ä¸€ä¸ª socket æ–‡ä»¶ï¼Œå¹¶åœ¨ VM å†…è¿è¡Œä¸€ä¸ª gRPC server å’Œ Kata å…¶ä»–ç»„ä»¶äº¤äº’ï¼Œruntimeï¼ˆkata-runtime &amp; containerd-shim-kata-v2ï¼‰ä¼šé€šè¿‡ gRPC æ¥ä¸ kata-agent é€šä¿¡ï¼Œæ¥ç®¡ç† VM ä¸­çš„å®¹å™¨ã€‚</p><h2 id="kata-proxy-v1"><a href="#kata-proxy-v1" class="headerlink" title="kata-proxy (v1)"></a>kata-proxy (v1)</h2><p>å¯é€‰è¿›ç¨‹ï¼Œåœ¨æ”¯æŒ VSOCK çš„ç¯å¢ƒå¯ä»¥ä¸éœ€è¦ã€‚kata-proxy ç»™å¤šä¸ª kata-shim å’Œ kata-runtime æä¾›å¯¹ kata-agent è®¿é—®å…¥å£ï¼Œè´Ÿè´£è·¯ç”± I&#x2F;O æµå’Œä¿¡å·ã€‚kata-proxy è¿æ¥åˆ° kata-agent çš„ socket ä¸Šã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œkata-runtime ä¼šé€šè¿‡ kata-proxy æ¥ä¸ VM å†…çš„ kata-agent é€šä¿¡ï¼Œç®¡ç† VM å†…å®¹å™¨è¿›ç¨‹ã€‚</p><h2 id="kata-shim-v1"><a href="#kata-shim-v1" class="headerlink" title="kata-shim (v1)"></a>kata-shim (v1)</h2><p>kata-shim çš„å‡ºç°ä¸»è¦æ˜¯è€ƒè™‘äº† VM å†…æœ‰å¤šä¸ªå®¹å™¨çš„æƒ…å†µã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæ¯ä¸ªå®¹å™¨è¿›ç¨‹çš„å›æ”¶ç”±å¤–å±‚çš„ä¸€ä¸ª Reaper è´Ÿè´£ã€‚è€Œ Kata Containers æ–¹æ¡ˆä¸­ï¼Œå®¹å™¨è¿è¡Œåœ¨ä¸€ä¸ª VM å†…ï¼Œruntime æ˜¯æ— æ³•ç›‘æ§ã€æ§åˆ¶å’Œå›æ”¶è¿™äº› VM å†…çš„å®¹å™¨ï¼Œæœ€å¤šå°±æ˜¯çœ‹åˆ° QEMU ç­‰è¿›ç¨‹ï¼Œæ‰€ä»¥å°±è®¾è®¡äº† kata-shimï¼Œç”¨æ¥ç›‘æ§å®¹å™¨è¿›ç¨‹ï¼Œå¤„ç†å®¹å™¨çš„æ‰€æœ‰ I&#x2F;O æµï¼Œä»¥åŠè½¬å‘æ‰€æœ‰çš„è¦å‘é€å‡ºå»çš„ä¿¡å·ã€‚kata-runtime ä¼šä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ kata-shimï¼Œæ¯ä¸ª Pod sandboxï¼ˆinfraï¼‰ä¹Ÿä¼šæœ‰ä¸€ä¸ª kata-shimã€‚</p><h2 id="containerd-shim-kata-v2-v1-amp-v2"><a href="#containerd-shim-kata-v2-v1-amp-v2" class="headerlink" title="containerd-shim-kata-v2 (v1 &amp; v2)"></a>containerd-shim-kata-v2 (v1 &amp; v2)</h2><p>åœ¨ Kata Containers v1.5 ç‰ˆæœ¬ä¹‹åï¼Œæ•´åˆäº†åŸæœ¬çš„ kata-runtimeã€kata-shimã€kata-proxy ä»¥åŠ reaper çš„åŠŸèƒ½ã€‚</p><p>åœ¨åŸæ–¹æ¡ˆï¼ˆv1ï¼‰ä¸­ï¼Œæ¯ä¸ª Pod éœ€è¦ 2N + 1 ä¸ª shimï¼ˆN ä»£è¡¨å®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨éœ€è¦ä¸€ä¸ª containerd-shim å’Œ kata-shimï¼Œè€Œæ¯ä¸€ä¸ª Pod sandbox ä¹Ÿéœ€è¦ä¸€ä¸ª kata-shimï¼‰ã€‚è€Œ containerd-shim-kata-v2 å®ç°äº† <a href="https://github.com/containerd/containerd/tree/master/runtime/v2">Containerd Runtime V2 (Shim APIï¼Œ ç”¨äº runtime å’Œ Containerd é›†æˆ)</a>ï¼ŒK8s åªéœ€è¦ä¸ºæ¯ä¸ª Podã€åŒ…æ‹¬å…¶å†…éƒ¨çš„å¤šä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ª shimv2 å°±å¤Ÿäº†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ— è®º kata-agent çš„ gRPC server æ˜¯å¦ä½¿ç”¨ VSOCK æš´éœ²åˆ° host ä¸Šï¼Œéƒ½ä¸å†éœ€è¦å•ç‹¬çš„ kata-proxyã€‚</p><h2 id="æ•´ä½“æ¶æ„"><a href="#æ•´ä½“æ¶æ„" class="headerlink" title="æ•´ä½“æ¶æ„"></a>æ•´ä½“æ¶æ„</h2><div align=center><img width="800" style="border: 0px" src="/gallery/kata-containers/shimv2.svg"></div><ul><li>è“è‰²åŒºåŸŸä»£è¡¨çš„æ˜¯ Kubernetes CRI çš„ç»„ä»¶ï¼›çº¢è‰²åŒºåŸŸä»£è¡¨çš„æ˜¯ Kata Containers çš„ç»„ä»¶ï¼›é»„è‰²åŒºåŸŸä»£è¡¨çš„æ˜¯ Kata Containers çš„ VM</li><li>shimV1 ä¸­ CRI çš„æµç¨‹åªä¼šé€šè¿‡ kata-proxy ï¼ˆé Vsock ç¯å¢ƒï¼‰å’Œ VM é€šä¿¡ç®¡ç†å®¹å™¨è¿›ç¨‹ç­‰</li><li>runc cmdline å°±æ˜¯å®ç°äº† OCI æ ‡å‡†çš„å‘½ä»¤è¡Œå·¥å…·</li><li>åœ¨ Kata 1.5 ä¹‹åç‰ˆæœ¬ä¸­ kata-runtime å¾—ä»¥ä¿ç•™ï¼Œä½†æ˜¯ä»…ç”¨ä½œå‘½ä»¤è¡Œå·¥å…·åˆ¤æ–­ Kata Containers çš„è¿è¡Œç¯å¢ƒç­‰ï¼ŒçœŸæ­£çš„ runtime ä¸º containerd-shim-kata-v2</li></ul><p><strong>Kata Containers 1.x</strong></p><table><thead><tr><th>Component</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://github.com/kata-containers/agent">agent</a></td><td>core</td><td>Management process running inside the virtual machine &#x2F; POD that sets up the container environment.</td></tr><tr><td><a href="https://github.com/kata-containers/documentation">documentation</a></td><td>documentation</td><td>Documentation common to all components (such as design and install documentation).</td></tr><tr><td><a href="https://github.com/kata-containers/ksm-throttler">KSM throttler</a></td><td>optional core</td><td>Daemon that monitors containers and deduplicates memory to maximize container density on the host.</td></tr><tr><td><a href="https://github.com/kata-containers/osbuilder">osbuilder</a></td><td>infrastructure</td><td>Tool to create â€œmini O&#x2F;Sâ€ rootfs and initrd images for the hypervisor.</td></tr><tr><td><a href="https://github.com/kata-containers/packaging">packaging</a></td><td>infrastructure</td><td>Scripts and metadata for producing packaged binaries (components, hypervisors, kernel and rootfs).</td></tr><tr><td><a href="https://github.com/kata-containers/proxy">proxy</a></td><td>core</td><td>Multiplexes communications between the shims, agent and runtime.</td></tr><tr><td><a href="https://github.com/kata-containers/runtime">runtime</a></td><td>core</td><td>Main component run by a container manager and providing a containerd shimv2 runtime implementation.</td></tr><tr><td><a href="https://github.com/kata-containers/shim">shim</a></td><td>core</td><td>Handles standard I&#x2F;O and signals on behalf of the container process.</td></tr></tbody></table><p><strong>Kata Containers 2.x</strong></p><table><thead><tr><th>Component</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/tools/agent-ctl">agent-ctl</a></td><td>utility</td><td>Tool that provides low-level access for testing the agent.</td></tr><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/src/agent">agent</a></td><td>core</td><td>Management process running inside the virtual machine &#x2F; POD that sets up the container environment.</td></tr><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/docs">documentation</a></td><td>documentation</td><td>Documentation common to all components (such as design and install documentation).</td></tr><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/tools/osbuilder">osbuilder</a></td><td>infrastructure</td><td>Tool to create â€œmini O&#x2F;Sâ€ rootfs and initrd images for the hypervisor.</td></tr><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/tools/packaging">packaging</a></td><td>infrastructure</td><td>Scripts and metadata for producing packaged binaries (components, hypervisors, kernel and rootfs).</td></tr><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/src/runtime">runtime</a></td><td>core</td><td>Main component run by a container manager and providing a containerd shimv2 runtime implementation.</td></tr><tr><td><a href="https://github.com/kata-containers/kata-containers/blob/main/src/trace-forwarder">trace-forwarder</a></td><td>utility</td><td>Agent tracing helper.</td></tr></tbody></table><p><strong>ä¸ Kubernetes é›†æˆæ¶æ„</strong></p><div align=center><img width="800" style="border: 0px" src="/gallery/kata-containers/with-kubernetes.png"></div><h1 id="æµç¨‹ç¤ºä¾‹"><a href="#æµç¨‹ç¤ºä¾‹" class="headerlink" title="æµç¨‹ç¤ºä¾‹"></a>æµç¨‹ç¤ºä¾‹</h1><p>ä»¥å®¹å™¨åˆ›å»ºæµç¨‹ä¸ºä¾‹ï¼Œåˆæ­¥ç†è§£ä¸‹ Kata Containers æ˜¯å¦‚ä½•è¿ä½œ</p><ol><li>ç”¨æˆ·é€šè¿‡ç±»ä¼¼äº <code>sudo ctr run --runtime &quot;io.containerd.kata.v2&quot; --rm -t &quot;quay.io/libpod/ubuntu:latest&quot; foo sh</code> å‘½ä»¤è¯·æ±‚ Container Manager åˆ›å»ºå®¹å™¨</li><li>Container Manager å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨ Kata è¿è¡Œæ—¶çš„å•ä¸ªå®ä¾‹ï¼Œå³ containerd-shim-kata-v2</li><li>Kata è¿è¡Œæ—¶åŠ è½½é…ç½®æ–‡ä»¶</li><li>Container Manager è°ƒç”¨ä¸€ç»„ shimv2 çš„ API</li><li>Kata è¿è¡Œæ—¶å¯åŠ¨é…ç½®å¥½çš„ hypervisor</li><li>hypervisor ä½¿ç”¨ guest èµ„æºé…ç½®åˆ›å»ºå¹¶å¯åŠ¨ï¼ˆå¼•å¯¼ï¼‰VM<ol><li>hypervisor DAX å°† guest é•œåƒå…±äº«åˆ° VM ä¸­æˆä¸º VM rootfsï¼ˆå®‰è£…åœ¨ &#x2F;dev&#x2F;pmem* è®¾å¤‡ä¸Šï¼‰ï¼Œå³ VM æ ¹ç¯å¢ƒ</li><li>hypervisor ä½¿ç”¨ virtio FS å°† OCI bundle å®‰è£…åˆ° VM çš„ rootfs å†…çš„å®¹å™¨ç‰¹å®šç›®å½•ä¸­ï¼ˆè¿™ä¸ªå®¹å™¨ç‰¹å®šç›®å½•å°†æˆä¸ºå®¹å™¨ rootfsï¼Œç§°ä¸ºå®¹å™¨ç¯å¢ƒï¼‰</li></ol></li><li>Kata agent ä½œä¸º VM å¯åŠ¨çš„ä¸€éƒ¨åˆ†</li><li>è¿è¡Œæ—¶è°ƒç”¨ Kata agent çš„ CreateSandbox API æ¥è¯·æ±‚ agent åˆ›å»ºå®¹å™¨<ol><li>Kata agent åœ¨åŒ…å«å®¹å™¨ rootfs çš„ç‰¹å®šç›®å½•ä¸­åˆ›å»ºå®¹å™¨ç¯å¢ƒï¼ˆå®¹å™¨ç¯å¢ƒåœ¨å®¹å™¨ rootfs ç›®å½•ä¸­æ‰˜ç®¡å·¥ä½œè´Ÿè½½ï¼‰ï¼ˆagent åˆ›å»ºçš„å®¹å™¨ç¯å¢ƒç›¸å½“äº runc OCI è¿è¡Œæ—¶åˆ›å»ºçš„å®¹å™¨ç¯å¢ƒï¼›Linux cgroups å’Œå‘½åç©ºé—´ç”± guest å†…æ ¸åœ¨ VM å†…åˆ›å»ºï¼Œç”¨äºå°†å·¥ä½œè´Ÿè½½ä¸åˆ›å»ºå®¹å™¨çš„ VM ç¯å¢ƒéš”ç¦»å¼€æ¥ï¼‰</li><li>Kata agent åœ¨å®¹å™¨ç¯å¢ƒä¸­ç”Ÿæˆå·¥ä½œè´Ÿè½½</li></ol></li><li>Container Manager å°†å®¹å™¨çš„æ§åˆ¶æƒè¿”å›ç»™è¿è¡Œ ctr å‘½ä»¤çš„ç”¨æˆ·</li></ol>]]></content>
    
    
    <summary type="html">Kata Containers 2.x ä¸ 1.x ç‰ˆæœ¬æ¶æ„å·®å¼‚å¯¹æ¯”ä¸ç»„ä»¶åŠŸèƒ½æ¦‚è¿°</summary>
    
    
    
    <category term="Container Runtime" scheme="http://shenxianghong.github.io/categories/Container-Runtime/"/>
    
    
    <category term="Kata Containers" scheme="http://shenxianghong.github.io/tags/Kata-Containers/"/>
    
  </entry>
  
</feed>
