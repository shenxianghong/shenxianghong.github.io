<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>「 Kubernetes」源码走读 - CPU Manager - 🐾Corgi</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="🐾Corgi"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="🐾Corgi"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Kubelet CM 模块中与 CPU Manager 相关的源码走读"><meta property="og:type" content="blog"><meta property="og:title" content="「 Kubernetes」源码走读 - CPU Manager"><meta property="og:url" content="http://shenxianghong.github.io/2022/07/11/2022-07-11%20Kubernetes%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20CPU%20Manager/"><meta property="og:site_name" content="🐾Corgi"><meta property="og:description" content="Kubelet CM 模块中与 CPU Manager 相关的源码走读"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://picsum.photos/0?sig=20220711"><meta property="article:published_time" content="2022-07-10T16:00:00.000Z"><meta property="article:modified_time" content="2023-05-04T00:54:28.332Z"><meta property="article:author" content="Shen Xianghong"><meta property="article:tag" content="Kubernetes"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://picsum.photos/0?sig=20220711"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://shenxianghong.github.io/2022/07/11/2022-07-11%20Kubernetes%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20CPU%20Manager/"},"headline":"「 Kubernetes」源码走读 - CPU Manager","image":[],"datePublished":"2022-07-10T16:00:00.000Z","dateModified":"2023-05-04T00:54:28.332Z","author":{"@type":"Person","name":"Shen Xianghong"},"publisher":{"@type":"Organization","name":"🐾Corgi","logo":{"@type":"ImageObject","url":"http://shenxianghong.github.io/img/logo.svg"}},"description":"Kubelet CM 模块中与 CPU Manager 相关的源码走读"}</script><link rel="canonical" href="http://shenxianghong.github.io/2022/07/11/2022-07-11%20Kubernetes%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20CPU%20Manager/"><link rel="alternate" href="/atom.xml" title="🐾Corgi" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="🐾Corgi" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://picsum.photos/0?sig=20220711" alt="「 Kubernetes」源码走读 - CPU Manager"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="fa fa-calendar"></i> <time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2022-07-11</time></span><span class="level-item is-hidden-mobile"><i class="fa fa-calendar-check"></i> <time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2023-05-04</time></span><span class="level-item"><i class="far fa-folder-open"></i> <a class="link-muted" href="/categories/Code-Walkthrough/">Code Walkthrough</a></span><span class="level-item"><i class="far fa-clock"></i> 16 minutes read (About 2436 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">「 Kubernetes」源码走读 - CPU Manager</h1><div class="content"><div align=center><img width="200" style="border: 0px" src="https://kubernetes.io/images/kubernetes-horizontal-color.png"></div>

<hr>
<blockquote>
<p>Base on <strong>v1.20.12</strong></p>
</blockquote>
<h1 id="state"><a href="#state" class="headerlink" title="state"></a>state</h1><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;state&#x2F;state_checkpoint.go</u></em></p>
<p>基于内存，用于记录 CPU Manager 的状态，后续 Policy 获取 CPU 以及分配情况等均从 state 对象中获得</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// map[pod]map[container]CPU Set</span></span><br><span class="line"><span class="keyword">type</span> ContainerCPUAssignments <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">map</span>[<span class="type">string</span>]cpuset.CPUSet</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> stateMemory <span class="keyword">struct</span> &#123;</span><br><span class="line">	sync.RWMutex</span><br><span class="line">	<span class="comment">// 记录 CPU 分配情况</span></span><br><span class="line">	assignments   ContainerCPUAssignments</span><br><span class="line">	<span class="comment">// 记录 CPU 信息</span></span><br><span class="line">	defaultCPUSet cpuset.CPUSet</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="storeState"><a href="#storeState" class="headerlink" title="storeState"></a>storeState</h2><p>当有 CPU 分配或者回收时，会调用该函数，将 state 对象持久化为 checkpoint 文件</p>
<h2 id="restoreState"><a href="#restoreState" class="headerlink" title="restoreState"></a>restoreState</h2><p>当 CPU Manager 启动时，会调用该函数，将节点上的 checkpoint 文件恢复为 state 对象</p>
<h1 id="checkpoint"><a href="#checkpoint" class="headerlink" title="checkpoint"></a>checkpoint</h1><p>基于文件（位于 host 上的 &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;cpu_manager_state），用于记录 CPU Manager 的状态，为了避免 state 对象在 Kubelet 重启后内存丢失的问题</p>
<h1 id="Policy"><a href="#Policy" class="headerlink" title="Policy"></a>Policy</h1><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy.go</u></em></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Policy <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 返回策略名称</span></span><br><span class="line">	Name() <span class="type">string</span></span><br><span class="line">	<span class="comment">// 针对 State 的校验流程</span></span><br><span class="line">	Start(s state.State) <span class="type">error</span></span><br><span class="line">	<span class="comment">// 容器 CPU 的分配流程</span></span><br><span class="line">	Allocate(s state.State, pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line">	<span class="comment">// 容器移除后的回收流程</span></span><br><span class="line">	RemoveContainer(s state.State, podUID <span class="type">string</span>, containerName <span class="type">string</span>) <span class="type">error</span></span><br><span class="line">	<span class="comment">// 调用 Policy 中的 topologymanager.HintProvider 的实现</span></span><br><span class="line">	GetTopologyHints(s state.State, pod *v1.Pod, container *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">	<span class="comment">// 调用 Policy 中的 topologymanager.HintProvider 的实现</span></span><br><span class="line">	GetPodTopologyHints(s state.State, pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="none"><a href="#none" class="headerlink" title="none"></a>none</h2><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy_none.go</u></em></p>
<p>默认策略。</p>
<p>CPU Manager 的 none 策略并未做任何实际的逻辑处理，不提供任何系统调度器默认行为之外的亲和性策略。通过 CFS 配额来实现 Guaranteed Pods 和 Burstable Pods 的 CPU 使用限制。因此，共享池的 CPU 也会包含 Kubelet 预留的部分。</p>
<h2 id="static"><a href="#static" class="headerlink" title="static"></a>static</h2><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;policy_static.go</u></em></p>
<p>仅针对 QoS 为 Guaranteed 且 CPU 申请量为正整数的 Pod 赋予增强的 CPU 亲和性和独占性。</p>
<h3 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h3><ol>
<li>初始化可分配的 CPU 信息，即获取所有可分配的 CPU（如果开启了 strictReserved，则取全量 CPU 和预留 CPU 的差集）</li>
<li>如果开启了 strictReserved，则校验全量 CPU 和预留 CPU 是否没有重叠；如果未开启，则校验预留 CPU 是否全在全量 CPU 中</li>
<li>校验已分配的 CPU 和可分配的 CPU 是否不重叠</li>
<li>校验可分配的 CPU + 已分配的 CPU 是否等于所有的 CPU - 预留的 CPU（如果开启了 strictReserved，否则忽视预留的 CPU）</li>
</ol>
<h3 id="Allocate"><a href="#Allocate" class="headerlink" title="Allocate"></a>Allocate</h3><ol>
<li>判断 Pod QoS 是否是 Guaranteed 级别，并且 Container 的 CPU request 为整数，如果不满足条件，直接返回，不做处理</li>
<li>从已分配的 CPU 信息中判断该 Pod 是否已经分配过，如果分配过，则本地更新</li>
<li>调用 Topology Manager 获取所有的 hint providers 返回的 hint</li>
<li>获取可申领的 CPU（即可分配 CPU + 步骤二中可复用的 CPU）</li>
<li>如果开启了 NUMA 亲和特性，则获取到涉及到的  NUMA 中的所有 CPU，取 NUMA CPU 之和和申请 CPU 中的最小值作为待对齐分配的 CPU 数量，校验申请的 CPU 数量是否大于 1 且小于所有可用的 CPU，</li>
<li>执行拓扑感知 best-fit 算法，优先对齐能满足 NUMA 的部分<br><em>参考 pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;cpu_assignment_test.go 单元测试示例</em><ol>
<li>如果请求的 CPU 数量不小于单块 CPU Socket 中 Thread 数量，那么会优先将整块 CPU Socket 中的Thread 分配<br><em>acc.freeSockets()，返回单 Socket 中所有 Thread 均可用的 Socket 列表</em></li>
<li>如果剩余请求的 CPU 数量不小于单块物理 CPU Core 提供的 Thread 数量，那么会优先将整块物理 CPU Core 上的 Thread 分配<br><em>acc.freeCores()，返回单 Core 中所有 Thread 均可用的 Core 列表，按照 SocketID 做升序排列</em></li>
<li>剩余请求的 CPU 数量则从按照如下规则排好序的 Thread 列表中选择<br><em>acc.freeCPUs()，返回所有可用的 Thread 列表，按照 SocketID 和 CoreID 做升序排列</em><ol>
<li>相同 Socket 上可用的 Thread</li>
<li>相同 Core 上可用的 Thread</li>
<li>CPU ID 升序排列</li>
</ol>
</li>
</ol>
</li>
<li>对于剩余的 CPU，进行如上拓扑感知 best-fit 算法，合并以上两部分，作为最终的 CPU 绑定结果</li>
<li>从共享池 CPU 中去除待分配的 CPU</li>
</ol>
<h3 id="RemoveContainer"><a href="#RemoveContainer" class="headerlink" title="RemoveContainer"></a>RemoveContainer</h3><ol>
<li>获取到容器的 CPU 分配信息，删除掉分配的记录信息，共享池 CPU 中添加 CPU</li>
</ol>
<h3 id="GetTopologyHints"><a href="#GetTopologyHints" class="headerlink" title="GetTopologyHints"></a>GetTopologyHints</h3><ol>
<li>获取容器申请的 CPU 数量</li>
<li>如果容器已经分配了申请 CPU，那么判断申请的和已分配的是否相等，不相等则不给出 hint，直接返回；相等则用已分配的生成 hint</li>
<li>获取可用的 CPU 和可复用的 CPU 信息，两者的合集作为可复用的 CPU，生成 hint</li>
</ol>
<h3 id="GetPodTopologyHints"><a href="#GetPodTopologyHints" class="headerlink" title="GetPodTopologyHints"></a>GetPodTopologyHints</h3><ol>
<li>获取 Pod 申请的 CPU 数量（获取 Init Container 最大值和 Container 之和，取两者最大为 CPU 数量）</li>
<li>遍历 Pod 的每个容器，如果容器已经分配了申请 CPU，那么判断申请的和已分配的是否相等，不相等则不给出 hint，直接返回；如果所有容器的已分配的 CPU 之和等于 Pod 的申请 CPU 数量，则用已分配的生成 hint</li>
<li>获取可用的 CPU 和可复用的 CPU 信息，两者的合集作为可复用的 CPU，生成 hint</li>
</ol>
<h3 id="generateCPUTopologyHints"><a href="#generateCPUTopologyHints" class="headerlink" title="generateCPUTopologyHints"></a>generateCPUTopologyHints</h3><p>生成 CPU TopologyHint 信息，假设有两个 NUMA 节点（编号为 0 和 1），NUMA0 上有 CPU1 和 CPU2，NUMA1上有 CPU3 和 CPU4，某个 Pod 请求两个 CPU。那么 CPU Manager 这个 HintProvider 会调用 generateCPUTopologyHints 产生如下的 TopologyHint：</p>
<ul>
<li>{01: True} 代表从 NUMA0 取 2 个 CPU，并且是“优先考虑的”</li>
<li>{10: True} 代表从 NUMA1 取 2 个 CPU，并且是“优先考虑的”</li>
<li>{11: False} 代表从 NUMA0 和 NUMA1 各取一个 CPU，不是“优先考虑的”</li>
</ul>
<ol>
<li>获取集群中的所有 NUMA 节点</li>
<li>获取 NUMA 节点组合中涉及到的 CPU</li>
<li>如果 NUMA 节点组合中所涉及到的 CPU 个数比请求的 CPU 数大，并且这个组合所涉及的 NUMA 节点个数是目前为止所有组合中最小的，那么就更新步骤 1 的获取结果</li>
<li>循环统计当前节点可用的 CPU 中，有哪些是属于当前正在处理的 NUMA 节点组合</li>
<li>如果当前 NUMA 组合中可用的 CPU 数比请求的 CPU 小，那么就直接返回，否则就创建一个 TopologyHint，并把它加入到 hints 中</li>
<li>遍历每一个 hint，涉及到的 NUMA 节点个数最少（即步骤 3 中获取的结果）的组合，会标注 preferred 为 true</li>
</ol>
<h1 id="CPU-Manager"><a href="#CPU-Manager" class="headerlink" title="CPU Manager"></a>CPU Manager</h1><p><em><u>pkg&#x2F;kubelet&#x2F;cm&#x2F;cpumanager&#x2F;cpu_manager.go</u></em></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Manager <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Kubelet 初始化时调用，启动 CPU Manager</span></span><br><span class="line">	Start(activePods ActivePodsFunc, sourcesReady config.SourcesReady, podStatusProvider status.PodStatusProvider, containerRuntime runtimeService, initialContainers containermap.ContainerMap) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将 CPU 分配给容器，必须在 AddContainer() 之前的某个时间点调用，例如在 Pod Admission 时</span></span><br><span class="line">	Allocate(pod *v1.Pod, container *v1.Container) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在容器创建和容器启动之间调用，以便可以将初始 CPU 亲和性设置写入第一个进程开始执行之前的容器运行时中</span></span><br><span class="line">	AddContainer(p *v1.Pod, c *v1.Container, containerID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在 Kubelet 决定杀死或删除一个对象后调用，在此调用之后，CPU Manager 停止尝试协调该容器并且释放绑定于该容器的任何 CPU</span></span><br><span class="line">	<span class="comment">// 目前未发现调用处</span></span><br><span class="line">	RemoveContainer(containerID <span class="type">string</span>) <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 返回内部 CPU Manager 的状态</span></span><br><span class="line">	State() state.Reader</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用 topologymanager.HintProvider 的实现，处理 NUMA 资源对齐等逻辑</span></span><br><span class="line">	GetTopologyHints(*v1.Pod, *v1.Container) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取分配给 Pod 容器的 CPU 信息</span></span><br><span class="line">	GetCPUs(podUID, containerName <span class="type">string</span>) []<span class="type">int64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用 topologymanager.HintProvider 的实现，处理 NUMA 资源对齐等逻辑</span></span><br><span class="line">	GetPodTopologyHints(pod *v1.Pod) <span class="keyword">map</span>[<span class="type">string</span>][]topologymanager.TopologyHint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Start-1"><a href="#Start-1" class="headerlink" title="Start"></a>Start</h2><ol>
<li>初始化 checkpoint 文件，并基于该文件初始化 state 对象</li>
<li>调用 Policy 的 Start 接口，传入 state</li>
<li>如果策略是 none，则直接返回，否则启动 goroutine 定时调和 state</li>
</ol>
<h2 id="Allocate-1"><a href="#Allocate-1" class="headerlink" title="Allocate"></a>Allocate</h2><ol>
<li>清理搁浅的资源，也就是获取 state 中记录的 CPU 信息，但是实际上使用的容器已经不是 active 状态</li>
<li>调用 Policy 的 Allocate 接口</li>
</ol>
<h2 id="AddContainer"><a href="#AddContainer" class="headerlink" title="AddContainer"></a>AddContainer</h2><ol>
<li>从 state 中获取 Pod 容器的 CPU 信息，如果为空直接返回</li>
<li>调用 CRI 的 UpdateContainerResources 接口，更新容器的 CPU Set 信息，如果更新失败调用 Policy 的 RemoveContainer 接口回滚状态，从 containerMap 中移除容器信息</li>
</ol>
<h2 id="RemoveContainer-1"><a href="#RemoveContainer-1" class="headerlink" title="RemoveContainer"></a>RemoveContainer</h2><ol>
<li>调用 Policy 的 RemoveContainer 接口</li>
<li>从 containerMap 中移除 Container 信息</li>
</ol>
<h2 id="State"><a href="#State" class="headerlink" title="State"></a>State</h2><ol>
<li>返回 state 对象</li>
</ol>
<h2 id="GetTopologyHints-1"><a href="#GetTopologyHints-1" class="headerlink" title="GetTopologyHints"></a>GetTopologyHints</h2><ol>
<li>清理搁浅的资源，也就是获取 state 中记录的 CPU 信息，但是实际上使用的容器已经不是 active 状态</li>
<li>调用 Policy 的 GetTopologyHints 接口</li>
</ol>
<h2 id="GetCPUs"><a href="#GetCPUs" class="headerlink" title="GetCPUs"></a>GetCPUs</h2><ol>
<li>获取 state 中记录有给定 Pod 和容器的 CPU 分配情况，并返回</li>
</ol>
<h2 id="GetPodTopologyHints-1"><a href="#GetPodTopologyHints-1" class="headerlink" title="GetPodTopologyHints"></a>GetPodTopologyHints</h2><ol>
<li>清理搁浅的资源，也就是获取 state 中记录的 CPU 信息，但是实际上使用的容器已经不是 active 状态</li>
<li>调用 Policy 的 GetPodTopologyHints 接口</li>
</ol>
<h2 id="reconcileState"><a href="#reconcileState" class="headerlink" title="reconcileState"></a>reconcileState</h2><p>针对非 none 类型的 Policy 周期性调和</p>
<ol>
<li>清理搁浅的资源，也就是获取 state 中记录的 CPU 信息，但是实际上使用的容器已经不是 active 状态</li>
<li>遍历所有的 active 状态的 Pod 的容器</li>
<li>检查该 ContainerID 是否在 CPU Manager 维护的 state 中，然后检查对应的 Pod.Status.Phase 是否为 Running 且 DeletionTimestamp 为 nil，如果是，则调用 CPU Manager 的 AddContainer 对该 Container&#x2F;Pod 进行 QoS 和 CPU request 检查，如果满足 static Policy 的条件，则调用 takeByTopology 为该 Container 分配最佳的 CPU Set，并写入到 state 和 checkpoint 文件中</li>
<li>然后从 State 中获取该 ContainerID 对应的 CPU Set，调用 CRI UpdateContainerResources 接口更新容器的 CPU Set 信息</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>「 Kubernetes」源码走读 - CPU Manager</p><p><a href="http://shenxianghong.github.io/2022/07/11/2022-07-11 Kubernetes 源码走读 - CPU Manager/">http://shenxianghong.github.io/2022/07/11/2022-07-11 Kubernetes 源码走读 - CPU Manager/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Shen Xianghong</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-07-11</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-05-04</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/Kubernetes/">Kubernetes </a></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/08/01/2022-08-01%20Kata%20Containers%20Block%20Volume%20%E7%9B%B4%E9%80%9A/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">「 Kata Containers 」Block Volume 直通</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/07/10/2022-07-10%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Gateway/"><span class="level-item">「 Istio 」流量管理 — Gateway</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/35031258?v=4" alt="🐾Corgi"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">🐾Corgi</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">50</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/shenxianghong" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Youtube" href="https://youtube.com"><i class="fab fa-youtube"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Bilibili" href="https://bilibili.com"><i class="fab fa-bilibili"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Reddit" href="https://reddit.com"><i class="fab fa-reddit"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://google.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">google.com</span></span></a></li><li><a class="level is-mobile" href="https://freegpt.one" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ChatGPT</span></span><span class="level-right"><span class="level-item tag">freegpt.one</span></span></a></li></ul></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#state"><span class="level-left"><span class="level-item">1</span><span class="level-item">state</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#storeState"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">storeState</span></span></a></li><li><a class="level is-mobile" href="#restoreState"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">restoreState</span></span></a></li></ul></li><li><a class="level is-mobile" href="#checkpoint"><span class="level-left"><span class="level-item">2</span><span class="level-item">checkpoint</span></span></a></li><li><a class="level is-mobile" href="#Policy"><span class="level-left"><span class="level-item">3</span><span class="level-item">Policy</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#none"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">none</span></span></a></li><li><a class="level is-mobile" href="#static"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">static</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Start"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">Start</span></span></a></li><li><a class="level is-mobile" href="#Allocate"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">Allocate</span></span></a></li><li><a class="level is-mobile" href="#RemoveContainer"><span class="level-left"><span class="level-item">3.2.3</span><span class="level-item">RemoveContainer</span></span></a></li><li><a class="level is-mobile" href="#GetTopologyHints"><span class="level-left"><span class="level-item">3.2.4</span><span class="level-item">GetTopologyHints</span></span></a></li><li><a class="level is-mobile" href="#GetPodTopologyHints"><span class="level-left"><span class="level-item">3.2.5</span><span class="level-item">GetPodTopologyHints</span></span></a></li><li><a class="level is-mobile" href="#generateCPUTopologyHints"><span class="level-left"><span class="level-item">3.2.6</span><span class="level-item">generateCPUTopologyHints</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#CPU-Manager"><span class="level-left"><span class="level-item">4</span><span class="level-item">CPU Manager</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Start-1"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">Start</span></span></a></li><li><a class="level is-mobile" href="#Allocate-1"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">Allocate</span></span></a></li><li><a class="level is-mobile" href="#AddContainer"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">AddContainer</span></span></a></li><li><a class="level is-mobile" href="#RemoveContainer-1"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">RemoveContainer</span></span></a></li><li><a class="level is-mobile" href="#State"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">State</span></span></a></li><li><a class="level is-mobile" href="#GetTopologyHints-1"><span class="level-left"><span class="level-item">4.6</span><span class="level-item">GetTopologyHints</span></span></a></li><li><a class="level is-mobile" href="#GetCPUs"><span class="level-left"><span class="level-item">4.7</span><span class="level-item">GetCPUs</span></span></a></li><li><a class="level is-mobile" href="#GetPodTopologyHints-1"><span class="level-left"><span class="level-item">4.8</span><span class="level-item">GetPodTopologyHints</span></span></a></li><li><a class="level is-mobile" href="#reconcileState"><span class="level-left"><span class="level-item">4.9</span><span class="level-item">reconcileState</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Code-Walkthrough/"><span class="level-start"><span class="level-item">Code Walkthrough</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/categories/Getting-Started/"><span class="level-start"><span class="level-item">Getting Started</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Meetup/"><span class="level-start"><span class="level-item">Meetup</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Overview/"><span class="level-start"><span class="level-item">Overview</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">7</span></span></a><ul><li><a class="level is-mobile" href="/categories/Programming/Elegant-Coding/"><span class="level-start"><span class="level-item">Elegant Coding</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Quick-Start/"><span class="level-start"><span class="level-item">Quick Start</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="🐾Corgi" height="28"></a><p class="is-size-7"><span>&copy; 2023 Shen Xianghong</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p><p class="is-size-7"><br/>And did you get what you wanted from this life, even so?</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>