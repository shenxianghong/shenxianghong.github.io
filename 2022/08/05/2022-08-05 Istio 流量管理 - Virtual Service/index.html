<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>ã€Œ Istio ã€æµé‡ç®¡ç† â€” VirtualService - ğŸ¾Corgi</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="ğŸ¾Corgi"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="ğŸ¾Corgi"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Istio ä¸­æµé‡ç®¡ç†ç»„ä»¶ VirtualService å¯¹è±¡ä»‹ç»"><meta property="og:type" content="blog"><meta property="og:title" content="ã€Œ Istio ã€æµé‡ç®¡ç† â€” VirtualService"><meta property="og:url" content="http://shenxianghong.github.io/2022/08/05/2022-08-05%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Virtual%20Service/"><meta property="og:site_name" content="ğŸ¾Corgi"><meta property="og:description" content="Istio ä¸­æµé‡ç®¡ç†ç»„ä»¶ VirtualService å¯¹è±¡ä»‹ç»"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://picsum.photos/0?sig=20220805"><meta property="article:published_time" content="2022-08-04T16:00:00.000Z"><meta property="article:modified_time" content="2023-05-06T08:43:30.745Z"><meta property="article:author" content="Shen Xianghong"><meta property="article:tag" content="Istio"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://picsum.photos/0?sig=20220805"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://shenxianghong.github.io/2022/08/05/2022-08-05%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Virtual%20Service/"},"headline":"ã€Œ Istio ã€æµé‡ç®¡ç† â€” VirtualService","image":[],"datePublished":"2022-08-04T16:00:00.000Z","dateModified":"2023-05-06T08:43:30.745Z","author":{"@type":"Person","name":"Shen Xianghong"},"publisher":{"@type":"Organization","name":"ğŸ¾Corgi","logo":{"@type":"ImageObject","url":"http://shenxianghong.github.io/img/logo.svg"}},"description":"Istio ä¸­æµé‡ç®¡ç†ç»„ä»¶ VirtualService å¯¹è±¡ä»‹ç»"}</script><link rel="canonical" href="http://shenxianghong.github.io/2022/08/05/2022-08-05%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Virtual%20Service/"><link rel="alternate" href="/atom.xml" title="ğŸ¾Corgi" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="ğŸ¾Corgi" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://picsum.photos/0?sig=20220805" alt="ã€Œ Istio ã€æµé‡ç®¡ç† â€” VirtualService"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="fa fa-calendar"></i>Â <time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2022-08-05</time></span><span class="level-item"><i class="fa fa-calendar-check"></i>Â <time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2023-05-06</time></span><span class="level-item"><i class="far fa-folder-open"></i>Â <a class="link-muted" href="/categories/Overview/">Overview</a></span><span class="level-item"><i class="far fa-clock"></i>Â an hour read (About 7338 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">ã€Œ Istio ã€æµé‡ç®¡ç† â€” VirtualService</h1><div class="content"><div align=center><img width="120" style="border: 0px" src="https://landscape.cncf.io/logos/istio.svg"></div>

<hr>
<blockquote>
<p>Based on <strong>v1.15.0</strong></p>
</blockquote>
<p>VirtualService å®šä¹‰äº†ä¸€ç»„æµé‡è·¯ç”±è§„åˆ™ï¼Œä»¥åœ¨ host è¢«å¯»å€æ—¶åº”ç”¨ã€‚æ¯ä¸ªè·¯ç”±è§„åˆ™éƒ½ä¸ºç‰¹å®šåè®®çš„æµé‡å®šä¹‰äº†åŒ¹é…æ ‡å‡†ã€‚å¦‚æœæµé‡åŒ¹é…ï¼Œåˆ™å°†å…¶å‘é€åˆ°æ³¨å†Œè¡¨ä¸­å®šä¹‰çš„å‘½åç›®æ ‡æœåŠ¡ï¼ˆæˆ–å…¶å­é›†&#x2F;ç‰ˆæœ¬ï¼‰</p>
<p>æµé‡æ¥æºä¹Ÿå¯ä»¥åœ¨è·¯ç”±è§„åˆ™ä¸­åŒ¹é…ã€‚è¿™å…è®¸ä¸ºç‰¹å®šçš„å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡å®šåˆ¶è·¯ç”±ã€‚</p>
<p><strong>Service</strong></p>
<p>ç»‘å®šåˆ° service registry ä¸­å”¯ä¸€åç§°çš„åº”ç”¨ç¨‹åºè¡Œä¸ºå•å…ƒã€‚Service ç”±å¤šä¸ª endpoints ç»„æˆï¼Œè¿™äº› endpoints ä¹Ÿå°±æ˜¯è¿è¡Œåœ¨ Podã€å®¹å™¨ã€VM ç­‰ä¸Šçš„å·¥ä½œè´Ÿè½½å®ä¾‹ã€‚</p>
<p><strong>Service versionsï¼ˆsubsetsï¼‰</strong></p>
<p>åœ¨æŒç»­éƒ¨ç½²åœºæ™¯ä¸­ï¼Œä¸€ä¸ªæœåŠ¡å¯ä»¥æœ‰ä¸åŒçš„å®ä¾‹å­é›†çš„ä¸åŒå˜ä½“ï¼Œè¿™äº›å˜ä½“ä¸ä¸€å®šæ˜¯ä¸åŒçš„ API ç‰ˆæœ¬ï¼Œå®ƒä»¬å¯èƒ½æ˜¯å¯¹åŒä¸€æœåŠ¡çš„è¿­ä»£æ›´æ”¹ï¼Œéƒ¨ç½²åœ¨ä¸åŒçš„ç¯å¢ƒï¼ˆprod, staging, dev ç­‰ï¼‰ä¸­ã€‚å¸¸è§åœºæ™¯åŒ…æ‹¬ A&#x2F;B æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒç­‰ã€‚ä¸åŒç‰ˆæœ¬çš„é€‰æ‹©å¯ä»¥æ ¹æ®å„ç§æ ‡å‡†ï¼ˆheaders, url ç­‰ï¼‰çš„æƒé‡æ¥å†³å®šã€‚æ¯ä¸ªæœåŠ¡éƒ½æœ‰ä¸€ä¸ªç”±å…¶æ‰€æœ‰å®ä¾‹ç»„æˆçš„é»˜è®¤ç‰ˆæœ¬ã€‚</p>
<p><strong>Source</strong></p>
<p>è°ƒç”¨æœåŠ¡çš„ä¸‹æ¸¸å®¢æˆ·ç«¯ã€‚</p>
<p><strong>Host</strong></p>
<p>å®¢æˆ·ç«¯å°è¯•è¿æ¥åˆ°æœåŠ¡æ—¶ä½¿ç”¨çš„åœ°å€ã€‚</p>
<p><strong>Access model</strong></p>
<p>åº”ç”¨ç¨‹åºä»…å¤„ç†ç›®æ ‡æœåŠ¡ï¼ˆHostï¼‰ï¼Œè€Œä¸çŸ¥é“å„ä¸ªæœåŠ¡ç‰ˆæœ¬ï¼ˆsubsetsï¼‰ã€‚ç‰ˆæœ¬çš„å®é™…é€‰æ‹©ç”±ä»£ç†æˆ–è€… sidecar å†³å®šï¼Œè¿™æ ·åº”ç”¨ç¨‹åºä»£ç èƒ½å¤Ÿå°†è‡ªèº«ä¸ä¾èµ–æœåŠ¡çš„è§£è€¦ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ç¤ºä¾‹é»˜è®¤å°†æ‰€æœ‰ HTTP æµé‡è·¯ç”±åˆ°æ ‡ç­¾ä¸º reviewï¼šv1 çš„ review æœåŠ¡çš„ Podã€‚æ­¤å¤–ï¼Œè·¯å¾„ä»¥ &#x2F;wpcatalog&#x2F; æˆ– &#x2F;consumercatalog&#x2F; å¼€å¤´çš„ HTTP è¯·æ±‚å°†è¢«é‡å†™ä¸º &#x2F;newcatalog å¹¶å‘é€åˆ°æ ‡ç­¾ä¸º version: v2 çš„ Podã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;reviews-v2-routes&quot;</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/wpcatalog&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/consumercatalog&quot;</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">&quot;/newcatalog&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;reviews-v1-route&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>

<p>è·¯ç”±ç›®çš„åœ°çš„å­é›†æˆ–è€…ç‰ˆæœ¬é€šè¿‡å¯¹å¿…é¡»åœ¨ç›¸åº” DestinationRule ä¸­å£°æ˜çš„å‘½åæœåŠ¡å­é›†çš„å¼•ç”¨æ¥æ ‡è¯†ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-destination</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br></pre></td></tr></table></figure>

<h1 id="VirtualService"><a href="#VirtualService" class="headerlink" title="VirtualService"></a>VirtualService</h1><table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>hosts</td>
<td>å‘å…¶å‘é€æµé‡çš„ç›®æ ‡ä¸»æœºï¼ˆåªæœ‰è®¿é—®å®¢æˆ·ç«¯çš„ Host å­—æ®µä¸º hosts é…ç½®çš„åœ°å€æ‰èƒ½è·¯ç”±åˆ°åç«¯æœåŠ¡ï¼‰ã€‚å¯ä»¥æ˜¯å¸¦æœ‰é€šé…ç¬¦å‰ç¼€çš„ DNS åç§°æˆ– IP åœ°å€ã€‚æ ¹æ®å¹³å°çš„ä¸åŒï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨çŸ­åç§°ä»£æ›¿ FQDNï¼ˆå³åç§°ä¸­æ²¡æœ‰ç‚¹ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸»æœºçš„ FQDN å°†åŸºäºåº•å±‚å¹³å°æ´¾ç”Ÿ<br />å•ä¸ª VirtualService å¯ç”¨äºæè¿°ç›¸åº” host çš„æ‰€æœ‰æµé‡å±æ€§ï¼ŒåŒ…æ‹¬å¤šä¸ª HTTP å’Œ TCP ç«¯å£çš„æµé‡å±æ€§ã€‚æˆ–è€…ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ª VirtualService å®šä¹‰ host çš„æµé‡å±æ€§ï¼Œä½†æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œå‚é˜…<a target="_blank" rel="noopener" href="https://istio.io/latest/docs/ops/best-practices/traffic-management/#split-virtual-services">æ“ä½œæŒ‡å—</a><br />Kubernetes ç”¨æˆ·æ³¨æ„äº‹é¡¹ï¼šå½“ä½¿ç”¨çŸ­åç§°æ—¶ï¼ˆä¾‹å¦‚ reviews è€Œä¸æ˜¯ reviews.default.svc.cluster.localï¼‰ï¼ŒIstio å°†æ ¹æ®è§„åˆ™çš„å‘½åç©ºé—´è€Œä¸æ˜¯æœåŠ¡æ¥è§£æçŸ­åç§°ã€‚åä¸º reviews çš„ host åœ¨ default å‘½åç©ºé—´ä¸­çš„è§„åˆ™å°†è¢«è§£æä¸º reviews.default.svc.cluster.localï¼Œè€Œä¸ reviews æœåŠ¡å…³è”çš„å®é™…å‘½åç©ºé—´æ— å…³ã€‚ä¸ºé¿å…æ½œåœ¨çš„é”™è¯¯é…ç½®ï¼Œå»ºè®®å§‹ç»ˆä½¿ç”¨å®Œå…¨é™å®šåŸŸåè€Œä¸æ˜¯çŸ­åç§°<br />hosts å­—æ®µé€‚ç”¨äº HTTP å’Œ TCP æœåŠ¡ã€‚ç½‘æ ¼å†…çš„æœåŠ¡ï¼Œå³æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ï¼Œå¿…é¡»å§‹ç»ˆä½¿ç”¨å®ƒä»¬çš„å­—æ¯æ•°å­—åç§°æ¥å¼•ç”¨ã€‚ IP åœ°å€ä»…å…è®¸ç”¨äºé€šè¿‡ Gateway å®šä¹‰çš„æœåŠ¡<br />æ³¨æ„ï¼šå¯¹äº delegate VirtualService è€Œè¨€ï¼Œå¿…é¡»ä¸ºç©ºã€‚</td>
</tr>
<tr>
<td>gateways</td>
<td>åº”ç”¨è¿™äº›è·¯ç”±è§„åˆ™çš„ Gateway å’Œ sidecar çš„åç§°ã€‚ å…¶ä»–å‘½åç©ºé—´ä¸­çš„ Gateway çš„å¼•ç”¨æ–¹å¼ä¸º&lt;gateway namespace&gt;&#x2F;&lt;gateway name&gt;ï¼›æŒ‡å®šæ²¡æœ‰æ˜¾å¼çš„æŒ‡å®šå‘½åç©ºé—´åˆ™ä¸ VirtualService çš„å‘½åç©ºé—´ç›¸åŒã€‚å•ä¸ª VirtualService ç”¨äºç½‘æ ¼å†…çš„ sidecar ä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ª Gatewayã€‚å¯ä»¥ä½¿ç”¨åè®®ç‰¹å®šè·¯ç”±çš„åŒ¹é…æ¡ä»¶ä¸­çš„æºå­—æ®µè¦†ç›–è¯¥å­—æ®µå¼ºåŠ çš„é€‰æ‹©æ¡ä»¶ã€‚ä¿ç•™å­— mesh ç”¨äºè¡¨è¿°ç½‘æ ¼ä¸­çš„æ‰€æœ‰ sidecarã€‚å½“çœç•¥è¯¥å­—æ®µæ—¶ï¼Œå°†ä½¿ç”¨é»˜è®¤ Gateway å³ meshï¼Œè¿™ä¼šå°†è§„åˆ™åº”ç”¨äºç½‘æ ¼ä¸­çš„æ‰€æœ‰ sidecarã€‚å¦‚æœæä¾›äº† Gateway åç§°åˆ—è¡¨ï¼Œåˆ™è§„åˆ™å°†ä»…é€‚ç”¨è¯¥ç›¸å…³çš„ Gatewayã€‚è¦å°†è§„åˆ™åº”ç”¨äº Gateway å’Œ sidecarï¼Œè¯·å°† mesh æŒ‡å®šä¸º gateways ä¹‹ä¸€</td>
</tr>
<tr>
<td><a href="#HTTPRoute">http</a></td>
<td>HTTP æµé‡çš„è·¯ç”±è§„åˆ™çš„æœ‰åºåˆ—è¡¨ã€‚ ä½¿ç”¨åŒ¹é…ä¼ å…¥è¯·æ±‚çš„ç¬¬ä¸€ä¸ªè§„åˆ™</td>
</tr>
<tr>
<td><a href="#TLSRoute">tls</a></td>
<td>An ordered list of route rule for non-terminated TLS &amp; HTTPS traffic. Routing is typically performed using the SNI value presented by the ClientHello message. TLS routes will be applied to platform service ports named â€˜https-*â€™, â€˜tls-*â€™, unterminated gateway ports using HTTPS&#x2F;TLS protocols (i.e. with â€œpassthroughâ€ TLS mode) and service entry ports using HTTPS&#x2F;TLS protocols. The first rule matching an incoming request is used. NOTE: Traffic â€˜https-*â€™ or â€˜tls-*â€™ ports without associated virtual service will be treated as opaque TCP traffic.</td>
</tr>
<tr>
<td><a href="#TCPRoute">tcp</a></td>
<td>ä¸é€æ˜ TCP æµé‡çš„è·¯ç”±è§„åˆ™çš„æœ‰åºåˆ—è¡¨ã€‚ TCP è·¯ç”±å°†åº”ç”¨äºä¸æ˜¯ HTTP æˆ– TLS ç«¯å£çš„ä»»ä½•ç«¯å£ã€‚ä½¿ç”¨åŒ¹é…ä¼ å…¥è¯·æ±‚çš„ç¬¬ä¸€ä¸ªè§„åˆ™</td>
</tr>
<tr>
<td>exportTo</td>
<td>æ­¤ VirtualService æš´éœ²åˆ°çš„å‘½åç©ºé—´åˆ—è¡¨ã€‚æš´éœ² VirtualService å…è®¸å®ƒè¢«å…¶ä»–å‘½åç©ºé—´ä¸­å®šä¹‰çš„ sidecar å’Œ Gateway ä½¿ç”¨ã€‚æ­¤åŠŸèƒ½ä¸ºæœåŠ¡æ‰€æœ‰è€…å’Œç½‘æ ¼ç®¡ç†å‘˜æä¾›äº†ä¸€ç§æœºåˆ¶æ¥æ§åˆ¶è·¨å‘½åç©ºé—´è¾¹ç•Œçš„ VirtualService çš„å¯è§æ€§<br />å¦‚æœæœªæŒ‡å®šå‘½åç©ºé—´ï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹å°† VirtualService æš´éœ²åˆ°æ‰€æœ‰å‘½åç©ºé—´<br /> . ä¸ºä¿ç•™æ ‡è¯†ä»£è¡¨æš´éœ²åˆ° VirtualService çš„åŒä¸€å‘½åç©ºé—´ä¸­ã€‚ç±»ä¼¼åœ°ï¼Œ* ä»£è¡¨æš´éœ²åˆ°æ‰€æœ‰å‘½åç©ºé—´</td>
</tr>
</tbody></table>
<h1 id="Destination"><a href="#Destination" class="headerlink" title="Destination"></a>Destination</h1><p>Destination è¡¨ç¤ºåœ¨å¤„ç†è·¯ç”±è§„åˆ™åå°†è¯·æ±‚ï¼ˆè¿æ¥ï¼‰å‘é€åˆ°çš„ç½‘ç»œå¯å¯»å€æœåŠ¡ã€‚ destination.host åº”è¯¥æ˜ç¡®å¼•ç”¨æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ã€‚ Istio çš„æœåŠ¡æ³¨å†Œè¡¨ç”±å¹³å°æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æ‰€æœ‰æœåŠ¡ï¼ˆä¾‹å¦‚ Kubernetes æœåŠ¡ã€Consul æœåŠ¡ï¼‰ä»¥åŠé€šè¿‡ ServiceEntry èµ„æºå£°æ˜çš„æœåŠ¡ç»„æˆã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹ä¸­é»˜è®¤å°†æ‰€æœ‰æµé‡è·¯ç”±åˆ°å¸¦æœ‰æ ‡ç­¾ versionï¼šv1ï¼ˆå³ subset v1ï¼‰çš„ review æœåŠ¡çš„ Podï¼Œå¹¶å°†ç¬¦åˆæ¡ä»¶çš„è·¯ç”±åˆ° subset v2ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">foo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span> <span class="comment"># interpreted as reviews.foo.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/wpcatalog&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/consumercatalog&quot;</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">&quot;/newcatalog&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span> <span class="comment"># interpreted as reviews.foo.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span> <span class="comment"># interpreted as reviews.foo.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹ VirtualService ä¸º productpage.prod.svc.cluster.local æœåŠ¡çš„è®¾ç½®äº† 5s çš„è¶…æ—¶æ—¶é—´ã€‚æ­¤è§„åˆ™ä¸­æ²¡æœ‰å®šä¹‰å­é›†ï¼ŒIstio å°†ä»æœåŠ¡æ³¨å†Œè¡¨ä¸­è·å– productpage.prod.svc.cluster.local æœåŠ¡çš„æ‰€æœ‰å®ä¾‹ï¼Œå¹¶å¡«å…… sidecar çš„è´Ÿè½½å‡è¡¡æ± ã€‚å¦å¤–ï¼Œæ­¤è§„åˆ™è®¾ç½®åœ¨ istio-system å‘½åç©ºé—´ä¸­ï¼Œä½†ä½¿ç”¨çš„æ˜¯ productpage æœåŠ¡çš„å®Œå…¨é™å®šåŸŸå productpage.prod.svc.cluster.localã€‚å› æ­¤ï¼Œè§„åˆ™çš„å‘½åç©ºé—´å¯¹è§£æ productpage æœåŠ¡çš„åç§°æ²¡æœ‰å½±å“ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-productpage-rule</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">productpage.prod.svc.cluster.local</span> <span class="comment"># ignores rule namespace</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">productpage.prod.svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†è·¯ç”±åˆ°ç½‘æ ¼å¤–æœåŠ¡çš„æµé‡ï¼Œå¿…é¡»é¦–å…ˆä½¿ç”¨ ServiceEntry èµ„æºå°†å¤–éƒ¨æœåŠ¡æ·»åŠ åˆ° Istio çš„å†…éƒ¨æœåŠ¡æ³¨å†Œè¡¨ä¸­ã€‚ç„¶åå¯ä»¥å®šä¹‰ VirtualServices æ¥æ§åˆ¶ç»‘å®šåˆ°è¿™äº›å¤–éƒ¨æœåŠ¡çš„æµé‡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™ä¸º wikipedia.org å®šä¹‰äº†ä¸€ä¸ª Serviceï¼Œå¹¶ä¸º HTTP è¯·æ±‚è®¾ç½®äº† 5s çš„è¶…æ—¶æ—¶é—´ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">external-svc-wikipedia</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wikipedia.org</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">example-http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-wiki-rule</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wikipedia.org</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">wikipedia.org</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>host</td>
<td>æœåŠ¡æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡åç§°ã€‚æœåŠ¡åç§°ä»å¹³å°çš„æœåŠ¡æ³¨å†Œè¡¨ï¼ˆä¾‹å¦‚ï¼ŒKubernetes æœåŠ¡ã€Consul æœåŠ¡ç­‰ï¼‰å’Œ ServiceEntry å£°æ˜çš„ host ä¸­æŸ¥æ‰¾ã€‚ä¸¤è€…éƒ½æ‰¾ä¸åˆ°çš„æµé‡å°†è¢«ä¸¢å¼ƒã€‚<br /><em>åŒæ ·çš„ï¼Œæ¨èä½¿ç”¨å®Œå…¨é™å®šåŸŸå</em></td>
</tr>
<tr>
<td>subset</td>
<td>æœåŠ¡ä¸­å­é›†çš„åç§°ã€‚ä»…é€‚ç”¨äºç½‘æ ¼å†…çš„æœåŠ¡ã€‚å­é›†å¿…é¡»åœ¨ç›¸åº”çš„ DestinationRule ä¸­å®šä¹‰</td>
</tr>
<tr>
<td><a href="#PortSelector">port</a></td>
<td>æŒ‡å®šå¯»å€ç›®æ ‡ä¸»æœºä¸Šçš„ç«¯å£ã€‚å¦‚æœæœåŠ¡åªå…¬å¼€ä¸€ä¸ªç«¯å£ï¼Œåˆ™ä¸éœ€è¦æ˜¾å¼é€‰æ‹©ç«¯å£</td>
</tr>
</tbody></table>
<h1 id="HTTPRoute"><a href="#HTTPRoute" class="headerlink" title="HTTPRoute"></a><a name="HTTPRoute">HTTPRoute</a></h1><p>æè¿°è·¯ç”± HTTP&#x2F;1.1ã€HTTP2 å’Œ gRPC æµé‡çš„åŒ¹é…æ¡ä»¶å’Œè¡Œä¸ºã€‚æœ‰å…³ä½¿ç”¨ç¤ºä¾‹ï¼Œè¯·å‚é˜… VirtualServiceã€‚</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>åˆ†é…ç»™è·¯ç”±çš„åç§°ï¼Œç”¨ä½œè°ƒè¯•ã€‚è¯¥åç§°å°†ä¸åŒ¹é…çš„è·¯ç”±ç»“æœä¸€èµ·è®°å½•åœ¨è®¿é—®æ—¥å¿—</td>
</tr>
<tr>
<td><a href="#HTTPMatchRequest">match</a></td>
<td>åº”ç”¨è§„åˆ™éœ€è¦æ»¡è¶³çš„åŒ¹é…æ¡ä»¶ã€‚å•ä¸ªåŒ¹é…å—å†…çš„æ‰€æœ‰æ¡ä»¶éƒ½å…·æœ‰ AND è¯­ä¹‰ï¼Œè€ŒåŒ¹é…å—åˆ—è¡¨å…·æœ‰ OR è¯­ä¹‰ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªåŒ¹é…å—åŒ¹é…æˆåŠŸï¼Œåˆ™åº”ç”¨è¯¥è§„åˆ™</td>
</tr>
<tr>
<td><a href="#HTTPRouteDestination">route</a></td>
<td>HTTP è§„åˆ™å¯ä»¥é‡å®šå‘æˆ–è½¬å‘ï¼ˆé»˜è®¤ï¼‰æµé‡ã€‚è½¬å‘ç›®æ ‡å¯ä»¥æ˜¯æœåŠ¡çš„å¤šä¸ªç‰ˆæœ¬ä¹‹ä¸€ï¼ˆsubsetï¼‰ã€‚ä¸æœåŠ¡ç‰ˆæœ¬ç›¸å…³çš„æƒé‡å†³å®šäº†å®ƒæ¥æ”¶çš„æµé‡æ¯”ä¾‹</td>
</tr>
<tr>
<td><a href="#HTTPRedirect">redirect</a></td>
<td>HTTP è§„åˆ™å¯ä»¥é‡å®šå‘æˆ–è½¬å‘ï¼ˆé»˜è®¤ï¼‰æµé‡ã€‚å¦‚æœåœ¨è§„åˆ™ä¸­æŒ‡å®šäº†æµé‡ç›´é€šé€‰é¡¹ï¼Œåˆ™é‡å®šå‘å°†è¢«å¿½ç•¥ã€‚é‡å®šå‘å¯ç”¨äºå°† HTTP 301 é‡å®šå‘å‘é€åˆ°ä¸åŒçš„ URI</td>
</tr>
<tr>
<td><a href="#Delegate">delegate</a></td>
<td>å§”æ‰˜æ˜¯æŒ‡å®šå¯ç”¨äºå®šä¹‰å§”æ‰˜ HTTPRoute çš„ç‰¹å®š VirtualServiceã€‚åªæœ‰Routeå’ŒRedirectéƒ½ä¸ºç©ºæ—¶æ‰å¯ä»¥è®¾ç½®ï¼Œå¹¶ä¸”delegate VirtualServiceçš„è·¯ç”±è§„åˆ™ä¼šä¸å½“å‰çš„è·¯ç”±è§„åˆ™åˆå¹¶ã€‚<br /><em>æ³¨æ„ï¼šä»…æ”¯æŒä¸€çº§å§”æ´¾ï¼Œdelegate çš„ HTTPMatchRequest å¿…é¡»æ˜¯ root çš„ä¸¥æ ¼å­é›†ï¼Œå¦åˆ™ä¼šå‘ç”Ÿå†²çªï¼ŒHTTPRoute ä¸ä¼šç”Ÿæ•ˆ</em></td>
</tr>
<tr>
<td><a href="#HTTPRewrite">rewrite</a></td>
<td>é‡å†™ HTTP URI å’Œ Authority headerã€‚ Rewrite ä¸èƒ½ä¸ Redirect åŸè¯­ä¸€èµ·ä½¿ç”¨ã€‚è½¬å‘å‰ä¼šè¿›è¡Œé‡å†™</td>
</tr>
<tr>
<td>timeout</td>
<td>HTTP è¯·æ±‚è¶…æ—¶ï¼Œé»˜è®¤ç¦ç”¨</td>
</tr>
<tr>
<td><a href="#HTTPRetry">retries</a></td>
<td>HTTP è¯·æ±‚çš„é‡è¯•ç­–ç•¥</td>
</tr>
<tr>
<td><a href="#HTTPFaultInjection">fault</a></td>
<td>æ•…éšœæ³¨å…¥ç­–ç•¥åº”ç”¨äºå®¢æˆ·ç«¯çš„ HTTP æµé‡ã€‚<br /><em>æ³¨æ„ï¼Œåœ¨å®¢æˆ·ç«¯å¯ç”¨æ•…éšœæ—¶ï¼Œå°†ä¸ä¼šå¯ç”¨è¶…æ—¶æˆ–é‡è¯•</em></td>
</tr>
<tr>
<td><a href="#Destination">mirror</a></td>
<td>é™¤äº†å°†è¯·æ±‚è½¬å‘åˆ°é¢„æœŸç›®æ ‡ä¹‹å¤–ï¼Œè¿˜å°† HTTP æµé‡é•œåƒåˆ°å¦ä¸€ä¸ªç›®æ ‡ã€‚é•œåƒæµé‡æ˜¯åœ¨å°½åŠ›è€Œä¸ºçš„åŸºç¡€ä¸Šï¼Œsidercar &#x2F; gateway åœ¨ä»åŸå§‹ç›®çš„åœ°è¿”å›å“åº”ä¹‹å‰ä¸ä¼šç­‰å¾…é•œåƒé›†ç¾¤å“åº”ã€‚ä¼šä¸ºé•œåƒç›®çš„åœ°ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td><a href="#Percent">mirrorPercentage</a></td>
<td>è¦é•œåƒçš„æµé‡ç™¾åˆ†æ¯”ã€‚é»˜è®¤ä¸ºæ‰€æœ‰çš„æµé‡ï¼ˆ100%ï¼‰éƒ½ä¼šè¢«é•œåƒã€‚æœ€å¤§å€¼ä¸º 100%ã€‚</td>
</tr>
<tr>
<td><a href="#CorsPolicy">corsPolicy</a></td>
<td>è·¨åŸŸèµ„æºå…±äº«ç­–ç•¥ (CORS)ã€‚æœ‰å…³è·¨æºèµ„æºå…±äº«çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a></td>
</tr>
<tr>
<td><a href="#Headers">headers</a></td>
<td>Header æ“ä½œè§„åˆ™</td>
</tr>
</tbody></table>
<h1 id="Delegate"><a href="#Delegate" class="headerlink" title="Delegate"></a><a name="Delegate">Delegate</a></h1><p>åœ¨ Istio 1.5 ä¸­ï¼ŒVirtualService èµ„æºä¹‹é—´æ˜¯æ— æ³•è¿›è¡Œè½¬å‘çš„ï¼Œåœ¨ Istio 1.6 ç‰ˆæœ¬ä¸­è§„åˆ’äº† VirtualService Chain æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ delegate é…ç½®é¡¹å°†ä¸€ä¸ª VirtualService ä»£ç†åˆ°å¦å¤–ä¸€ä¸ª VirtualService ä¸­è¿›è¡Œè§„åˆ™åŒ¹é…ã€‚</p>
<p>ä¾‹å¦‚ï¼Œè·¯ç”±è§„åˆ™é€šè¿‡åä¸º productpage çš„å§”æ‰˜ VirtualService å°†æµé‡è½¬å‘åˆ° &#x2F;productpageï¼Œé€šè¿‡åä¸º reviews çš„å§”æ‰˜ VirtualService å°†æµé‡è½¬å‘åˆ° &#x2F;reviewsã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;bookinfo.com&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygateway</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/productpage&quot;</span></span><br><span class="line">    <span class="attr">delegate:</span></span><br><span class="line">       <span class="attr">name:</span> <span class="string">productpage</span></span><br><span class="line">       <span class="attr">namespace:</span> <span class="string">nsA</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/reviews&quot;</span></span><br><span class="line">    <span class="attr">delegate:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">nsB</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">productpage</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nsA</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/productpage/v1/&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">productpage-v1.nsA.svc.cluster.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">productpage.nsA.svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nsB</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.nsB.svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>å§”æ‰˜ VirtualService çš„åç§°</td>
</tr>
<tr>
<td>namespace</td>
<td>å§”æ‰˜ VirtualService æ‰€åœ¨çš„å‘½åç©ºé—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¸æ ¹çš„ç›¸åŒ</td>
</tr>
</tbody></table>
<h1 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a><a name="Headers">Headers</a></h1><p>å½“ Envoy å°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡æœåŠ¡æˆ–ä»ç›®æ ‡æœåŠ¡è½¬å‘å“åº”æ—¶ï¼Œå¯ä»¥æ“ä½œ header ä¿¡æ¯ã€‚å¯ä»¥ä¸ºç‰¹å®šè·¯ç”±ç›®çš„åœ°æˆ–æ‰€æœ‰ç›®çš„åœ°æŒ‡å®š header æ“ä½œè§„åˆ™ã€‚ä»¥ä¸‹ VirtualService å°†å€¼ä¸º test: true çš„è¯·æ±‚å¤´æ·»åŠ åˆ°è·¯ç”±åˆ°ä»»ä½• reviews æœåŠ¡ç›®æ ‡çš„è¯·æ±‚ä¸­ã€‚åŒæ—¶ï¼Œåˆ é™¤äº†ä»…æ¥è‡ª reviews æœåŠ¡çš„ v1 ç‰ˆæœ¬çš„å“åº”å¤´ä¸­çš„ fooã€‚ </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">      <span class="attr">request:</span></span><br><span class="line">        <span class="attr">set:</span></span><br><span class="line">          <span class="attr">test:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">25</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">response:</span></span><br><span class="line">          <span class="attr">remove:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">75</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="#HeaderOperations">request</a></td>
<td>åœ¨å°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡æœåŠ¡ä¹‹å‰åº”ç”¨çš„æ ‡å¤´æ“ä½œè§„åˆ™</td>
</tr>
<tr>
<td><a href="#HeaderOperations">response</a></td>
<td>åœ¨å‘è°ƒç”¨è€…è¿”å›å“åº”ä¹‹å‰åº”ç”¨çš„æ ‡å¤´æ“ä½œè§„åˆ™</td>
</tr>
</tbody></table>
<h1 id="TLSRoute"><a href="#TLSRoute" class="headerlink" title="TLSRoute"></a><a name="TLSRoute">TLSRoute</a></h1><p>æè¿°è·¯ç”±æœªç»ˆæ­¢çš„ TLS æµé‡ (TLS&#x2F;HTTPS) çš„åŒ¹é…æ¡ä»¶å’Œæ“ä½œã€‚</p>
<p>ä»¥ä¸‹è·¯ç”±è§„åˆ™æ ¹æ® SNI å€¼å°†åˆ°è¾¾åä¸º mygateway çš„ Gateway çš„ç«¯å£ 443 çš„æœªç»ˆæ­¢ TLS æµé‡è½¬å‘åˆ°ç½‘æ ¼ä¸­çš„å†…éƒ¨æœåŠ¡ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-sni</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;*.bookinfo.com&quot;</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mygateway</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">sniHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">login.bookinfo.com</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">login.prod.svc.cluster.local</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">sniHosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">reviews.bookinfo.com</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="#TLSMatchAttributes%5B%5D">match</a></td>
<td>åº”ç”¨è§„åˆ™éœ€è¦æ»¡è¶³çš„åŒ¹é…æ¡ä»¶ã€‚å•ä¸ªåŒ¹é…å—å†…çš„æ‰€æœ‰æ¡ä»¶éƒ½å…·æœ‰ AND è¯­ä¹‰ï¼Œè€ŒåŒ¹é…å—åˆ—è¡¨å…·æœ‰ OR è¯­ä¹‰ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªåŒ¹é…å—åŒ¹é…æˆåŠŸï¼Œåˆ™åº”ç”¨è¯¥è§„åˆ™</td>
</tr>
<tr>
<td><a href="#RouteDestination">route</a></td>
<td>è¿æ¥åº”è½¬å‘åˆ°çš„ç›®çš„åœ°</td>
</tr>
</tbody></table>
<h1 id="TCPRoute"><a href="#TCPRoute" class="headerlink" title="TCPRoute"></a><a name="TCPRoute">TCPRoute</a></h1><p>æè¿°è·¯ç”± TCP æµé‡çš„åŒ¹é…æ¡ä»¶å’Œæ“ä½œã€‚</p>
<p>ä»¥ä¸‹è·¯ç”±è§„åˆ™å°†åˆ°è¾¾ç«¯å£ 27017 çš„ mongo.prod.svc.cluster.local çš„æµé‡è½¬å‘åˆ°ç«¯å£ 5555 ä¸Šçš„å¦ä¸€ä¸ª Mongo æœåŠ¡å™¨ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bookinfo-mongo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mongo.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">tcp:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">mongo.backup.svc.cluster.local</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">5555</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="#L4MatchAttributes%5B%5D">match</a></td>
<td>åº”ç”¨è§„åˆ™éœ€è¦æ»¡è¶³çš„åŒ¹é…æ¡ä»¶ã€‚å•ä¸ªåŒ¹é…å—å†…çš„æ‰€æœ‰æ¡ä»¶éƒ½å…·æœ‰ AND è¯­ä¹‰ï¼Œè€ŒåŒ¹é…å—åˆ—è¡¨å…·æœ‰ OR è¯­ä¹‰ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªåŒ¹é…å—åŒ¹é…æˆåŠŸï¼Œåˆ™åº”ç”¨è¯¥è§„åˆ™</td>
</tr>
<tr>
<td><a href="#RouteDestination%5B%5D">route</a></td>
<td>è¿æ¥åº”è½¬å‘åˆ°çš„ç›®çš„åœ°</td>
</tr>
</tbody></table>
<h1 id="HTTPMatchRequest"><a href="#HTTPMatchRequest" class="headerlink" title="HTTPMatchRequest"></a><a name="HTTPMatchRequest">HTTPMatchRequest</a></h1><p>HttpMatchRequest æŒ‡å®šè¦æ»¡è¶³çš„ä¸€ç»„æ ‡å‡†ï¼Œä»¥ä¾¿å°†è§„åˆ™åº”ç”¨äº HTTP è¯·æ±‚ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹å†…å®¹å°†è§„åˆ™é™åˆ¶ä¸ºä»…åŒ¹é… URL è·¯å¾„ä»¥ &#x2F;ratings&#x2F;v2&#x2F; å¼€å¤´çš„è¯·æ±‚ï¼Œå¹¶ä¸”è¯·æ±‚åŒ…å«å…·æœ‰å€¼ jason çš„è‡ªå®šä¹‰æœ€ç»ˆç”¨æˆ·æ ‡å¤´ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">end-user:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">jason</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/ratings/v2/&quot;</span></span><br><span class="line">      <span class="attr">ignoreUriCase:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br></pre></td></tr></table></figure>

<p>HTTPMatchRequest ä¸èƒ½ä¸ºç©ºã€‚æ³¨æ„ï¼šæŒ‡å®šå§”æ‰˜ VirtualService æ—¶ï¼Œä¸èƒ½è®¾ç½®æ­£åˆ™è¡¨è¾¾å¼å­—ç¬¦ä¸²åŒ¹é…ã€‚</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>åˆ†é…ç»™åŒ¹é…é¡¹çš„åç§°ã€‚åŒ¹é…çš„åç§°å°†ä¸çˆ¶è·¯ç”±çš„åç§°ä¸€åŒè®°å½•åœ¨ä¸è¯¥è·¯ç”±åŒ¹é…çš„è¯·æ±‚çš„è®¿é—®æ—¥å¿—ä¸­</td>
</tr>
<tr>
<td><a href="#StringMatch">uri</a></td>
<td>åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰<br /><em>æ³¨æ„ï¼šå¯ä»¥é€šè¿‡ ignore_uri_case æ ‡å¿—å¯ç”¨ä¸åŒºåˆ†å¤§å°å†™çš„åŒ¹é…</em></td>
</tr>
<tr>
<td><a href="#StringMatch">scheme</a></td>
<td>åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰</td>
</tr>
<tr>
<td><a href="#StringMatch">method</a></td>
<td>åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰</td>
</tr>
<tr>
<td><a href="#StringMatch">authority</a></td>
<td>åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰</td>
</tr>
<tr>
<td><a href="#StringMatch">headers</a></td>
<td>header çš„ key å¿…é¡»ä¸ºå°å†™å¹¶ä½¿ç”¨è¿å­—ç¬¦ä½œä¸ºåˆ†éš”ç¬¦ï¼Œä¾‹å¦‚ x-request-idã€‚åŒºåˆ†å¤§å°å†™ï¼Œæ ¼å¼åŒ…æ‹¬ exactï¼ˆç²¾å‡†åŒ¹é…ï¼‰ã€prefixï¼ˆå‰ç¼€åŒ¹é…ï¼‰å’Œ regexï¼ˆæ­£åˆ™ï¼‰ã€‚å¦‚æœè¯¥å€¼ä¸ºç©ºå¹¶ä¸”ä»…æŒ‡å®šäº† header çš„åç§°ï¼Œåˆ™æ£€æŸ¥æ ‡å¤´çš„å­˜åœ¨<br /><em>æ³¨æ„ï¼šé”® uriã€schemeã€method å’Œ authority å°†è¢«å¿½ç•¥</em></td>
</tr>
<tr>
<td>port</td>
<td>æŒ‡å®šæ­£åœ¨å¯»å€çš„ host ä¸Šçš„ç«¯å£ã€‚è®¸å¤šæœåŠ¡åªå…¬å¼€å•ä¸ªç«¯å£æˆ–ä½¿ç”¨å®ƒä»¬æ”¯æŒçš„åè®®æ ‡è®°ç«¯å£ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ˜¾å¼é€‰æ‹©ç«¯å£</td>
</tr>
<tr>
<td>sourceLabels</td>
<td>ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œç”¨äºé™åˆ¶è§„åˆ™å¯¹å…·æœ‰ç»™å®šæ ‡ç­¾çš„æºï¼ˆå®¢æˆ·ç«¯ï¼‰å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td>
</tr>
<tr>
<td>gateways</td>
<td>å¾…åº”ç”¨è§„åˆ™çš„ç½‘å…³çš„åç§°ã€‚ VirtualService çš„é¡¶çº§ gateways å­—æ®µä¸­çš„ç½‘å…³åç§°ï¼ˆå¦‚æœæœ‰ï¼‰è¢«è¦†ç›–ã€‚Gateway åŒ¹é…ç‹¬ç«‹äº sourceLabels</td>
</tr>
<tr>
<td><a href="#StringMatch">queryParams</a></td>
<td>ç”¨äºåŒ¹é…çš„æŸ¥è¯¢å‚æ•°ï¼Œä¾‹å¦‚ exact: â€œtrueâ€ï¼Œextact: â€œâ€ å’Œ regex: â€œ\d+$â€<br /><em>æ³¨æ„ï¼šç›®å‰ä¸æ”¯æŒå‰ç¼€åŒ¹é…</em></td>
</tr>
<tr>
<td>ignoreUriCase</td>
<td>ç”¨äºæŒ‡å®š URI åŒ¹é…æ˜¯å¦ä¸åŒºåˆ†å¤§å°å†™çš„æ ‡å¿—ã€‚<br /><em>æ³¨æ„ï¼šåªæœ‰åœ¨å®Œå…¨å’Œå‰ç¼€ URI åŒ¹é…çš„æƒ…å†µä¸‹æ‰ä¼šå¿½ç•¥å¤§å°å†™</em></td>
</tr>
<tr>
<td><a href="#StringMatch">withoutHeaders</a></td>
<td>withoutHeaders ä¸ header çš„è¯­æ³•ç›¸åŒï¼Œä½†å«ä¹‰ç›¸åã€‚å¦‚æœ header ä¸ withoutHeaders ä¸­çš„åŒ¹é…è§„åˆ™åŒ¹é…ï¼Œåˆ™æµé‡å˜ä¸ºä¸åŒ¹é…</td>
</tr>
<tr>
<td>sourceNamespace</td>
<td>æºå‘½åç©ºé—´é™åˆ¶è§„åˆ™å¯¹è¯¥å‘½åç©ºé—´ä¸­å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td>
</tr>
</tbody></table>
<h1 id="HTTPRouteDestination"><a href="#HTTPRouteDestination" class="headerlink" title="HTTPRouteDestination"></a><a name="HTTPRouteDestination">HTTPRouteDestination</a></h1><p>æ¯ä¸ªè·¯ç”±è§„åˆ™éƒ½ä¸ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡ç‰ˆæœ¬ç›¸å…³è”ã€‚ä¸ç‰ˆæœ¬ç›¸å…³çš„æƒé‡å†³å®šäº†å®ƒæ¥æ”¶çš„æµé‡æ¯”ä¾‹ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™ä¼šå°† reviews æœåŠ¡çš„ 25% æµé‡è·¯ç”±åˆ° v2 ç‰ˆæœ¬çš„å®ä¾‹ä¸­ï¼Œè€Œå‰©ä½™æµé‡ï¼ˆå³ 75%ï¼‰å°†è·¯ç”±åˆ° v1 ç‰ˆæœ¬ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">25</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">75</span></span><br></pre></td></tr></table></figure>

<p>æµé‡ä¹Ÿå¯ä»¥åˆ†æˆä¸¤ä¸ªå®Œå…¨ä¸åŒçš„æœåŠ¡ï¼Œè€Œæ— éœ€å®šä¹‰æ–°çš„å­é›†ï¼ˆä¹Ÿå°±æ˜¯å†…éƒ¨åˆ†æµï¼‰ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å°† 25% çš„æµé‡ä» reviews.com è½¬å‘åˆ° dev.reviews.comã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route-two-domains</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.com</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">dev.reviews.com</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">25</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.com</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">75</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="#Destination">destination</a></td>
<td>è¯·æ±‚&#x2F;è¿æ¥åº”è½¬å‘åˆ°çš„æœåŠ¡å®ä¾‹</td>
</tr>
<tr>
<td>weight</td>
<td>è¦è½¬å‘åˆ°ç›®çš„åœ°çš„æµé‡çš„ç›¸å¯¹æ¯”ä¾‹ï¼ˆå³æƒé‡&#x2F;æ‰€æœ‰æƒé‡çš„æ€»å’Œï¼‰ã€‚å¦‚æœè§„åˆ™ä¸­åªæœ‰ä¸€ä¸ªç›®çš„åœ°ï¼Œå®ƒå°†æ¥æ”¶æ‰€æœ‰æµé‡ã€‚å¦‚æœæƒé‡ä¸º 0ï¼Œåˆ™ç›®çš„åœ°å°†ä¸ä¼šæ”¶åˆ°ä»»ä½•æµé‡</td>
</tr>
<tr>
<td><a href="#Headers">headers</a></td>
<td>header æ“ä½œè§„åˆ™</td>
</tr>
</tbody></table>
<h1 id="RouteDestination"><a href="#RouteDestination" class="headerlink" title="RouteDestination"></a><a name="RouteDestination">RouteDestination</a></h1><table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="#Destination">destination</a></td>
<td>è¯·æ±‚&#x2F;è¿æ¥åº”è½¬å‘åˆ°çš„æœåŠ¡å®ä¾‹</td>
</tr>
<tr>
<td>weight</td>
<td>è¦è½¬å‘åˆ°ç›®çš„åœ°çš„æµé‡çš„ç›¸å¯¹æ¯”ä¾‹ï¼ˆå³æƒé‡&#x2F;æ‰€æœ‰æƒé‡çš„æ€»å’Œï¼‰ã€‚å¦‚æœè§„åˆ™ä¸­åªæœ‰ä¸€ä¸ªç›®çš„åœ°ï¼Œå®ƒå°†æ¥æ”¶æ‰€æœ‰æµé‡ã€‚å¦‚æœæƒé‡ä¸º 0ï¼Œåˆ™ç›®çš„åœ°å°†ä¸ä¼šæ”¶åˆ°ä»»ä½•æµé‡</td>
</tr>
</tbody></table>
<h1 id="L4MatchAttributes"><a href="#L4MatchAttributes" class="headerlink" title="L4MatchAttributes"></a><a name="L4MatchAttributes">L4MatchAttributes</a></h1><table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>destinationSubnets</td>
<td>å¸¦æœ‰å¯é€‰å­ç½‘çš„ç›®æ ‡ IPv4 æˆ– IPv6 IP åœ°å€ã€‚ä¾‹å¦‚ï¼Œa.b.c.d&#x2F;xx  æˆ–åªæ˜¯ a.b.c.d</td>
</tr>
<tr>
<td>port</td>
<td>æŒ‡å®šæ­£åœ¨å¯»å€çš„ host ä¸Šçš„ç«¯å£ã€‚è®¸å¤šæœåŠ¡åªå…¬å¼€å•ä¸ªç«¯å£æˆ–ä½¿ç”¨å®ƒä»¬æ”¯æŒçš„åè®®æ ‡è®°ç«¯å£ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ˜¾å¼é€‰æ‹©ç«¯å£</td>
</tr>
<tr>
<td>sourceLabels</td>
<td>ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œç”¨äºé™åˆ¶è§„åˆ™å¯¹å…·æœ‰ç»™å®šæ ‡ç­¾çš„æºï¼ˆå®¢æˆ·ç«¯ï¼‰å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td>
</tr>
<tr>
<td>gateways</td>
<td>å¾…åº”ç”¨è§„åˆ™çš„ç½‘å…³çš„åç§°ã€‚ VirtualService çš„é¡¶çº§ gateways å­—æ®µä¸­çš„ç½‘å…³åç§°ï¼ˆå¦‚æœæœ‰ï¼‰è¢«è¦†ç›–ã€‚Gateway åŒ¹é…ç‹¬ç«‹äº sourceLabels</td>
</tr>
<tr>
<td>sourceNamespace</td>
<td>æºå‘½åç©ºé—´é™åˆ¶è§„åˆ™å¯¹è¯¥å‘½åç©ºé—´ä¸­å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td>
</tr>
</tbody></table>
<h1 id="TLSMatchAttributes"><a href="#TLSMatchAttributes" class="headerlink" title="TLSMatchAttributes"></a><a name="TLSMatchAttributes">TLSMatchAttributes</a></h1><table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>sniHosts</td>
<td>è¦åŒ¹é…çš„ SNIï¼ˆserver name indicatorï¼‰ã€‚é€šé…ç¬¦å‰ç¼€å¯ç”¨äº SNI å€¼ï¼Œä¾‹å¦‚ï¼Œ*.com å°†åŒ¹é… foo.example.com ä»¥åŠ example.comã€‚ SNI å€¼å¿…é¡»æ˜¯ç›¸åº”è™šæ‹ŸæœåŠ¡ä¸»æœºçš„å­é›†ï¼ˆå³å±äºåŸŸå†…ï¼‰</td>
</tr>
<tr>
<td>destinationSubnets</td>
<td>å¸¦æœ‰å¯é€‰å­ç½‘çš„ç›®æ ‡ IPv4 æˆ– IPv6 IP åœ°å€ã€‚ä¾‹å¦‚ï¼Œa.b.c.d&#x2F;xx  æˆ–åªæ˜¯ a.b.c.d</td>
</tr>
<tr>
<td>port</td>
<td>æŒ‡å®šæ­£åœ¨å¯»å€çš„ host ä¸Šçš„ç«¯å£ã€‚è®¸å¤šæœåŠ¡åªå…¬å¼€å•ä¸ªç«¯å£æˆ–ä½¿ç”¨å®ƒä»¬æ”¯æŒçš„åè®®æ ‡è®°ç«¯å£ï¼Œåœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ˜¾å¼é€‰æ‹©ç«¯å£</td>
</tr>
<tr>
<td>sourceLabels</td>
<td>ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡ç­¾ï¼Œç”¨äºé™åˆ¶è§„åˆ™å¯¹å…·æœ‰ç»™å®šæ ‡ç­¾çš„æºï¼ˆå®¢æˆ·ç«¯ï¼‰å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td>
</tr>
<tr>
<td>gateways</td>
<td>å¾…åº”ç”¨è§„åˆ™çš„ç½‘å…³çš„åç§°ã€‚ VirtualService çš„é¡¶çº§ gateways å­—æ®µä¸­çš„ç½‘å…³åç§°ï¼ˆå¦‚æœæœ‰ï¼‰è¢«è¦†ç›–ã€‚Gateway åŒ¹é…ç‹¬ç«‹äº sourceLabels</td>
</tr>
<tr>
<td>sourceNamespace</td>
<td>æºå‘½åç©ºé—´é™åˆ¶è§„åˆ™å¯¹è¯¥å‘½åç©ºé—´ä¸­å·¥ä½œè´Ÿè½½çš„é€‚ç”¨æ€§ã€‚å¦‚æœ VirtualService åœ¨é¡¶çº§ gateways å­—æ®µä¸­æŒ‡å®šäº†ç½‘å…³åˆ—è¡¨ï¼Œä»…å½“åˆ—è¡¨ä¸­åŒ…å«ä¿ç•™çš„ gateway â€” mesh æ—¶ï¼Œè¯¥å­—æ®µæ‰ç”Ÿæ•ˆ</td>
</tr>
</tbody></table>
<h1 id="HTTPRedirect"><a href="#HTTPRedirect" class="headerlink" title="HTTPRedirect"></a><a name="HTTPRedirect">HTTPRedirect</a></h1><p>HTTPRedirect å¯ç”¨äºå‘è°ƒç”¨è€…å‘é€ 301 é‡å®šå‘å“åº”ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å°† review æœåŠ¡ä¸Šçš„ &#x2F;v1&#x2F;getProductRatings API è¯·æ±‚é‡å®šå‘åˆ° bookratings æœåŠ¡æä¾›çš„ &#x2F;v1&#x2F;bookRatingsã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/v1/getProductRatings</span></span><br><span class="line">    <span class="attr">redirect:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">/v1/bookRatings</span></span><br><span class="line">      <span class="attr">authority:</span> <span class="string">newratings.default.svc.cluster.local</span></span><br><span class="line">  <span class="string">...</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>uri</td>
<td>åœ¨é‡å®šå‘æ—¶ï¼Œä½¿ç”¨æ­¤å€¼è¦†ç›– URL çš„ path éƒ¨åˆ†ã€‚<br /><em>æ— è®ºè¯·æ±‚ URI æ˜¯å¦åŒ¹é…ä¸ºç¡®åˆ‡è·¯å¾„æˆ–å‰ç¼€ï¼Œéƒ½å°†æ›¿æ¢æ•´ä¸ªè·¯å¾„</em></td>
</tr>
<tr>
<td>authority</td>
<td>åœ¨é‡å®šå‘æ—¶ï¼Œä½¿ç”¨æ­¤å€¼è¦†ç›– URL çš„ Authority&#x2F;Host éƒ¨åˆ†</td>
</tr>
<tr>
<td>port</td>
<td>åœ¨é‡å®šå‘æ—¶ï¼Œä½¿ç”¨æ­¤å€¼è¦†ç›– URL çš„ Port éƒ¨åˆ†</td>
</tr>
<tr>
<td><a href="#HTTPRedirect.RedirectPortSelection">derivePort</a></td>
<td>åœ¨é‡å®šå‘æ—¶ï¼ŒåŠ¨æ€è®¾ç½®ç«¯å£</td>
</tr>
<tr>
<td>scheme</td>
<td>åœ¨é‡å®šå‘æ—¶ï¼Œä½¿ç”¨æ­¤å€¼è¦†ç›– URL çš„ Scheme éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œhttp æˆ– httpsã€‚å¦‚æœæœªè®¾ç½®ï¼Œå°†ä½¿ç”¨åŸ Schemeã€‚å¦‚æœ derivePort è®¾ç½®ä¸º FROM_PROTOCOL_DEFAULTï¼Œè¿™ä¹Ÿä¼šå½±å“è¯¥ç«¯å£</td>
</tr>
<tr>
<td>redirectCode</td>
<td>åœ¨é‡å®šå‘æ—¶ï¼ŒæŒ‡å®šè¦åœ¨é‡å®šå‘å“åº”ä¸­ä½¿ç”¨çš„ HTTP çŠ¶æ€ä»£ç ã€‚é»˜è®¤å“åº”ä»£ç ä¸º MOVED_PERMANENTLY (301)</td>
</tr>
</tbody></table>
<h1 id="HTTPRewrite"><a href="#HTTPRewrite" class="headerlink" title="HTTPRewrite"></a><a name="HTTPRewrite">HTTPRewrite</a></h1><p>HTTPRewrite å¯ç”¨äºåœ¨å°†è¯·æ±‚è½¬å‘åˆ°ç›®æ ‡ä¹‹å‰é‡å†™ HTTP è¯·æ±‚çš„ç‰¹å®šéƒ¨åˆ†ã€‚HTTPRewrite åªèƒ½ä¸ HTTPRouteDestination ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•åœ¨å®é™…è°ƒç”¨ä¹‹å‰å°† &#x2F;ratings å‰ç¼€é‡å†™ä¸º rating æœåŠ¡ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/ratings</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">/v1/bookRatings</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>uri</td>
<td>ç”¨è¿™ä¸ªå€¼é‡å†™ URI çš„ Path æˆ– Prefix éƒ¨åˆ†ã€‚å¦‚æœåŸå§‹ URI æ˜¯æ ¹æ®å‰ç¼€åŒ¹é…çš„ï¼Œåˆ™æ­¤å­—æ®µä¸­æä¾›çš„å€¼å°†æ›¿æ¢ç›¸åº”åŒ¹é…çš„å‰ç¼€</td>
</tr>
<tr>
<td>authority</td>
<td>ç”¨è¿™ä¸ªå€¼é‡å†™  Authority&#x2F;Host header</td>
</tr>
</tbody></table>
<h1 id="StringMatch"><a href="#StringMatch" class="headerlink" title="StringMatch"></a><a name="StringMatch">StringMatch</a></h1><p>åŒ¹é… HTTP header ä¸­çš„ç‰¹å®šå­—ç¬¦ä¸²çš„ç­–ç•¥ã€‚åŒ¹é…åŒºåˆ†å¤§å°å†™ã€‚</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>exact</td>
<td>ç²¾å‡†åŒ¹é…</td>
</tr>
<tr>
<td>prefix</td>
<td>å‰ç¼€åŒ¹é…</td>
</tr>
<tr>
<td>regex</td>
<td>æ­£åˆ™åŒ¹é… ï¼ˆå‚é˜…ï¼š<a target="_blank" rel="noopener" href="https://github.com/google/re2/wiki/Syntax%EF%BC%89">https://github.com/google/re2/wiki/Syntaxï¼‰</a></td>
</tr>
</tbody></table>
<h1 id="HTTPRetry"><a href="#HTTPRetry" class="headerlink" title="HTTPRetry"></a><a name="HTTPRetry">HTTPRetry</a></h1><p>HTTP è¯·æ±‚å¤±è´¥æ—¶çš„é‡è¯•ç­–ç•¥ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™å°†è°ƒç”¨ rating æœåŠ¡ v1 ç‰ˆæœ¬æ—¶çš„æœ€å¤§é‡è¯•æ¬¡æ•°è®¾ç½®ä¸º 3ï¼Œæ¯æ¬¡é‡è¯•è¶…æ—¶ä¸º 2 ç§’ã€‚å¦‚æœå‡ºç° gateway-errorï¼Œconnect-failure å’Œ refused-stream çš„é”™è¯¯å°†é‡è¯•ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">retries:</span></span><br><span class="line">      <span class="attr">attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">perTryTimeout:</span> <span class="string">2s</span></span><br><span class="line">      <span class="attr">retryOn:</span> <span class="string">gateway-error,connect-failure,refused-stream</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>attempts</td>
<td>è¯·æ±‚å…è®¸çš„é‡è¯•æ¬¡æ•°ã€‚é‡è¯•é—´éš”å°†è‡ªåŠ¨ç¡®å®šï¼ˆ25ms+ï¼‰ã€‚å½“é…ç½®äº† HTTP è·¯ç”±çš„è¯·æ±‚è¶…æ—¶æˆ– perTryTimeout æ—¶ï¼Œå®é™…å°è¯•çš„é‡è¯•æ¬¡æ•°è¿˜å–å†³äºæŒ‡å®šçš„è¯·æ±‚è¶…æ—¶å’Œ perTryTimeout å€¼</td>
</tr>
<tr>
<td>perTryTimeout</td>
<td>ç»™å®šè¯·æ±‚çš„æ¯æ¬¡å°è¯•è¶…æ—¶ï¼ŒåŒ…æ‹¬åˆå§‹è°ƒç”¨å’Œä»»ä½•é‡è¯•ã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D;1 msã€‚é»˜è®¤å€¼ä¸ HTTP è·¯ç”±çš„è¯·æ±‚è¶…æ—¶ç›¸åŒï¼Œå³æ²¡æœ‰è¶…æ—¶</td>
</tr>
<tr>
<td>retryOn</td>
<td>æŒ‡å®šé‡è¯•å‘ç”Ÿçš„æ¡ä»¶ã€‚å¯ä»¥ä½¿ç”¨ , åˆ†éš”åˆ—è¡¨æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªç­–ç•¥ã€‚å¦‚æœ retryOn æŒ‡å®šäº†ä¸€ä¸ªæœ‰æ•ˆçš„ HTTP çŠ¶æ€ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ° retriable_status_codes é‡è¯•ç­–ç•¥ä¸­ã€‚<br /><em>æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜…<a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#x-envoy-retry-on">é‡è¯•ç­–ç•¥</a>å’Œ <a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#x-envoy-retry-grpc-on">gRPC é‡è¯•ç­–ç•¥</a></em></td>
</tr>
<tr>
<td>retryRemoteLocalities</td>
<td>æ˜¯å¦åº”é‡è¯•åˆ°å…¶ä»–ä½ç½®ã€‚<br /><em>æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜…<a target="_blank" rel="noopener" href="https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_connection_management#retry-plugin-configuration">é‡è¯•æ’ä»¶é…ç½®</a></em></td>
</tr>
</tbody></table>
<h1 id="CorsPolicy"><a href="#CorsPolicy" class="headerlink" title="CorsPolicy"></a><a name="CorsPolicy">CorsPolicy</a></h1><p>æè¿°ç»™å®šæœåŠ¡çš„è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰ç­–ç•¥ã€‚æœ‰å…³è·¨æºèµ„æºå…±äº«çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå‚é˜… <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">CORS</a>ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è§„åˆ™ä½¿ç”¨ HTTP POST&#x2F;GET å°†è·¨æºè¯·æ±‚é™åˆ¶ä¸ºæ¥è‡ª example.com åŸŸçš„è¯·æ±‚ï¼Œå¹¶å°† Access-Control-Allow-Credentials header è®¾ç½®ä¸º falseã€‚æ­¤å¤–ï¼Œå®ƒåªæš´éœ² X-Foo-bar header å¹¶è®¾ç½® 1 å¤©çš„æœ‰æ•ˆæœŸã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">corsPolicy:</span></span><br><span class="line">      <span class="attr">allowOrigins:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">exact:</span> <span class="string">https://example.com</span></span><br><span class="line">      <span class="attr">allowMethods:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">allowCredentials:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">allowHeaders:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">X-Foo-Bar</span></span><br><span class="line">      <span class="attr">maxAge:</span> <span class="string">&quot;24h&quot;</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="#StringMatch">allowOrigins</a></td>
<td>åŒ¹é…å…è®¸çš„æ¥æºçš„å­—ç¬¦ä¸²æ¨¡å¼ã€‚å¦‚æœä»»ä½•å­—ç¬¦ä¸²åŒ¹é…å™¨åŒ¹é…ï¼Œåˆ™å…è®¸æ¥æºã€‚å¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œåˆ™ä¼ å‡ºçš„ Access-Control-Allow-Origin å°†è®¾ç½®ä¸ºå®¢æˆ·ç«¯æä¾›çš„æº</td>
</tr>
<tr>
<td>allowMethods</td>
<td>å…è®¸è®¿é—®èµ„æºçš„ HTTP æ–¹æ³•åˆ—è¡¨ã€‚å†…å®¹å°†è¢«åºåˆ—åŒ–åˆ° Access-Control-Allow-Methods header ä¸­</td>
</tr>
<tr>
<td>allowHeaders</td>
<td>è¯·æ±‚èµ„æºæ—¶å¯ä»¥ä½¿ç”¨çš„ HTTP header åˆ—è¡¨ã€‚åºåˆ—åŒ–ä¸º Access-Control-Allow-Headers header</td>
</tr>
<tr>
<td>exposeHeaders</td>
<td>å…è®¸æµè§ˆå™¨è®¿é—®çš„ HTTP header åˆ—è¡¨ã€‚åºåˆ—åŒ–ä¸º Access-Control-Expose-Headers header</td>
</tr>
<tr>
<td>maxAge</td>
<td>æŒ‡å®šé¢„æ£€è¯·æ±‚çš„ç»“æœå¯ä»¥ç¼“å­˜å¤šé•¿æ—¶é—´ã€‚è½¬æ¢ä¸º Access-Control-Max-Age header</td>
</tr>
<tr>
<td>allowCredentials</td>
<td>æ˜¯å¦å…è®¸è°ƒç”¨è€…ä½¿ç”¨å‡­æ®å‘é€å®é™…è¯·æ±‚ï¼ˆè€Œä¸æ˜¯é¢„æ£€ï¼‰ã€‚è½¬æ¢ä¸º Access-Control-Allow-Credentials header</td>
</tr>
</tbody></table>
<h1 id="HTTPFaultInjection"><a href="#HTTPFaultInjection" class="headerlink" title="HTTPFaultInjection"></a><a name="HTTPFaultInjection">HTTPFaultInjection</a></h1><p>HTTPFaultInjection å¯ç”¨äºåœ¨å°† HTTP è¯·æ±‚è½¬å‘åˆ°è·¯ç”±ä¸­æ³¨å…¥æ•…éšœã€‚æ•…éšœè§„èŒƒæ˜¯ VirtualService è§„åˆ™çš„ä¸€éƒ¨åˆ†ã€‚é”™è¯¯åŒ…æ‹¬ä»ä¸‹æ¸¸æœåŠ¡ä¸­æ­¢ HTTP è¯·æ±‚ã€å»¶è¿Ÿè¯·æ±‚ä»£ç†ç­‰ã€‚æ•…éšœè§„åˆ™ä¸­è‡³å°‘æœ‰ delay æˆ–è€… abortã€‚<br /><em>æ³¨æ„ï¼šdelay å’Œ abort æ•…éšœç›¸äº’ç‹¬ç«‹ï¼Œå³ä½¿ä¸¤è€…åŒæ—¶æŒ‡å®šã€‚</em></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="#HTTPFaultInjection.Delay">delay</a></td>
<td>åœ¨è½¬å‘ä¹‹å‰å»¶è¿Ÿè¯·æ±‚ï¼Œæ¨¡æ‹Ÿç½‘ç»œé—®é¢˜ã€ä¸Šæ¸¸æœåŠ¡è¿‡è½½ç­‰å„ç§æ•…éšœ</td>
</tr>
<tr>
<td><a href="#HTTPFaultInjection.Abort">abort</a></td>
<td>ä¸­æ­¢ HTTP è¯·æ±‚å°è¯•å¹¶å°†é”™è¯¯ä»£ç è¿”å›ç»™ä¸‹æ¸¸æœåŠ¡ï¼Œæ¨¡æ‹Ÿä¸Šæ¸¸æœåŠ¡æ•…éšœ</td>
</tr>
</tbody></table>
<h1 id="PortSelector"><a href="#PortSelector" class="headerlink" title="PortSelector"></a><a name="PortSelector">PortSelector</a></h1><p>PortSelector æŒ‡å®šç”¨äºåŒ¹é…æˆ–é€‰æ‹©æœ€ç»ˆè·¯ç”±çš„ç«¯å£å·ã€‚</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>number</td>
<td>æœ‰æ•ˆçš„ç«¯å£å·</td>
</tr>
</tbody></table>
<h1 id="Percent"><a href="#Percent" class="headerlink" title="Percent"></a><a name="Percent">Percent</a></h1><p>ç™¾åˆ†æ¯”èŒƒå›´ 0 ~ 100ã€‚</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>value</td>
<td>ç™¾åˆ†æ¯”èŒƒå›´</td>
</tr>
</tbody></table>
<h1 id="Headers-HeaderOperations"><a href="#Headers-HeaderOperations" class="headerlink" title="Headers.HeaderOperations"></a><a name="Headers.HeaderOperations">Headers.HeaderOperations</a></h1><p>header æ“ä½œæ–¹å¼ã€‚</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>set</td>
<td>ç”¨ç»™å®šçš„å€¼è¦†ç›–åŸ header ä¸­çš„ Key</td>
</tr>
<tr>
<td>add</td>
<td>è®²ç»™å®šçš„å€¼è¿½åŠ åˆ° header ä¸­çš„ Key ä¸­</td>
</tr>
<tr>
<td>remove</td>
<td>ç§»é™¤æŒ‡å®šçš„ header</td>
</tr>
</tbody></table>
<h1 id="HTTPFaultInjection-Delay"><a href="#HTTPFaultInjection-Delay" class="headerlink" title="HTTPFaultInjection.Delay"></a><a name="HTTPFaultInjection.Delay">HTTPFaultInjection.Delay</a></h1><p>å»¶è¿Ÿç±»æ•…éšœæ³¨å…¥ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨æ‰€æœ‰æ ‡ç­¾ä¸º env: prod çš„ Pod ä¸­å¯¹ reviews æœåŠ¡çš„ v1 ç‰ˆæœ¬çš„å‘èµ·çš„æ¯ 1000 ä¸ªè¯·æ±‚ä¸­å¼•å…¥ 1 ä¸ªå»¶è¿Ÿ 5 ç§’çš„æ•…éšœã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">sourceLabels:</span></span><br><span class="line">        <span class="attr">env:</span> <span class="string">prod</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">delay:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">0.1</span></span><br><span class="line">        <span class="attr">fixedDelay:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>

<p>fixedDelay å­—æ®µç”¨äºæŒ‡ç¤ºå»¶è¿Ÿé‡ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚å¯é€‰çš„ç™¾åˆ†æ¯”å­—æ®µå¯ç”¨äºä»…å»¶è¿Ÿä¸€å®šç™¾åˆ†æ¯”çš„è¯·æ±‚ã€‚å¦‚æœæœªæŒ‡å®šï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å°†è¢«å»¶è¿Ÿã€‚</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>fixedDelay</td>
<td>åœ¨è½¬å‘è¯·æ±‚ä¹‹å‰æ·»åŠ ä¸€ä¸ªå›ºå®šçš„å»¶è¿Ÿã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D; 1 ms</td>
</tr>
<tr>
<td>percentage</td>
<td>æ³¨å…¥å»¶è¿Ÿçš„è¯·æ±‚çš„ç™¾åˆ†æ¯”</td>
</tr>
<tr>
<td>percent</td>
<td>æ³¨å…¥å»¶è¿Ÿçš„è¯·æ±‚çš„ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰ã€‚ä¸æ¨èä½¿ç”¨æ•´æ•°ç™¾åˆ†æ¯”å€¼ã€‚è¯·æ”¹ç”¨ percentage å­—æ®µ</td>
</tr>
</tbody></table>
<h1 id="HTTPFaultInjection-Abort"><a href="#HTTPFaultInjection-Abort" class="headerlink" title="HTTPFaultInjection.Abort"></a><a name="HTTPFaultInjection.Abort">HTTPFaultInjection.Abort</a></h1><p>ä¸­æ­¢ç±»æ•…éšœæ³¨å…¥ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸º ratings æœåŠ¡ v1 ç‰ˆæœ¬çš„æ¯ 1000 ä¸ªè¯·æ±‚ä¸­çš„ 1 ä¸ªè¿”å› HTTP 400 é”™è¯¯ä»£ç ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ratings-route</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">ratings.prod.svc.cluster.local</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">abort:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">0.1</span></span><br><span class="line">        <span class="attr">httpStatus:</span> <span class="number">400</span></span><br></pre></td></tr></table></figure>

<p>httpStatus å­—æ®µè¡¨ç¤ºè¿”å›ç»™è°ƒç”¨è€…çš„ HTTP çŠ¶æ€ç ã€‚å¯é€‰çš„ç™¾åˆ†æ¯”å­—æ®µåªèƒ½ç”¨äºä¸­æ­¢ä¸€å®šç™¾åˆ†æ¯”çš„è¯·æ±‚ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä¸­æ­¢æ‰€æœ‰è¯·æ±‚ã€‚</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>httpStatus</td>
<td>ç”¨äºä¸­æ­¢ HTTP è¯·æ±‚çš„ HTTP çŠ¶æ€ç </td>
</tr>
<tr>
<td><a href="#Percent">percentage</a></td>
<td>ä¸­æ­¢è¯·æ±‚çš„ç™¾åˆ†æ¯”</td>
</tr>
</tbody></table>
<h1 id="HTTPRedirect-RedirectPortSelection"><a href="#HTTPRedirect-RedirectPortSelection" class="headerlink" title="HTTPRedirect.RedirectPortSelection"></a><a name="HTTPRedirect.RedirectPortSelection">HTTPRedirect.RedirectPortSelection</a></h1><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>FROM_PROTOCOL_DEFAULT</td>
<td>å¯¹äº HTTP è‡ªåŠ¨è®¾ç½®ä¸º 80ï¼Œå¯¹äº HTTPS è‡ªåŠ¨è®¾ç½®ä¸º 443</td>
</tr>
<tr>
<td>FROM_REQUEST_PORT</td>
<td>è‡ªåŠ¨ä½¿ç”¨è¯·æ±‚çš„ç«¯å£</td>
</tr>
</tbody></table>
</div><div class="article-licensing box"><div class="licensing-title"><p>ã€Œ Istio ã€æµé‡ç®¡ç† â€” VirtualService</p><p><a href="http://shenxianghong.github.io/2022/08/05/2022-08-05 Istio æµé‡ç®¡ç† - Virtual Service/">http://shenxianghong.github.io/2022/08/05/2022-08-05 Istio æµé‡ç®¡ç† - Virtual Service/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Shen Xianghong</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-08-05</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-05-06</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i>Â <a class="link-muted" rel="tag" href="/tags/Istio/">Istio </a></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/08/09/2022-08-09%20Istio%20%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%20-%20Destination%20Rule/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ã€Œ Istio ã€æµé‡ç®¡ç† â€” DestinationRule</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/08/01/2022-08-01%20Kata%20Containers%20Block%20Volume%20%E7%9B%B4%E9%80%9A/"><span class="level-item">ã€Œ Kata Containers ã€Block Volume ç›´é€š</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/35031258?v=4" alt="ğŸ¾Corgi"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">ğŸ¾Corgi</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">50</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/shenxianghong" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Youtube" href="https://youtube.com"><i class="fab fa-youtube"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Bilibili" href="https://bilibili.com"><i class="fab fa-bilibili"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Reddit" href="https://reddit.com"><i class="fab fa-reddit"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://google.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">google.com</span></span></a></li><li><a class="level is-mobile" href="https://freegpt.one" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ChatGPT</span></span><span class="level-right"><span class="level-item tag">freegpt.one</span></span></a></li></ul></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#VirtualService"><span class="level-left"><span class="level-item">1</span><span class="level-item">VirtualService</span></span></a></li><li><a class="level is-mobile" href="#Destination"><span class="level-left"><span class="level-item">2</span><span class="level-item">Destination</span></span></a></li><li><a class="level is-mobile" href="#HTTPRoute"><span class="level-left"><span class="level-item">3</span><span class="level-item">HTTPRoute</span></span></a></li><li><a class="level is-mobile" href="#Delegate"><span class="level-left"><span class="level-item">4</span><span class="level-item">Delegate</span></span></a></li><li><a class="level is-mobile" href="#Headers"><span class="level-left"><span class="level-item">5</span><span class="level-item">Headers</span></span></a></li><li><a class="level is-mobile" href="#TLSRoute"><span class="level-left"><span class="level-item">6</span><span class="level-item">TLSRoute</span></span></a></li><li><a class="level is-mobile" href="#TCPRoute"><span class="level-left"><span class="level-item">7</span><span class="level-item">TCPRoute</span></span></a></li><li><a class="level is-mobile" href="#HTTPMatchRequest"><span class="level-left"><span class="level-item">8</span><span class="level-item">HTTPMatchRequest</span></span></a></li><li><a class="level is-mobile" href="#HTTPRouteDestination"><span class="level-left"><span class="level-item">9</span><span class="level-item">HTTPRouteDestination</span></span></a></li><li><a class="level is-mobile" href="#RouteDestination"><span class="level-left"><span class="level-item">10</span><span class="level-item">RouteDestination</span></span></a></li><li><a class="level is-mobile" href="#L4MatchAttributes"><span class="level-left"><span class="level-item">11</span><span class="level-item">L4MatchAttributes</span></span></a></li><li><a class="level is-mobile" href="#TLSMatchAttributes"><span class="level-left"><span class="level-item">12</span><span class="level-item">TLSMatchAttributes</span></span></a></li><li><a class="level is-mobile" href="#HTTPRedirect"><span class="level-left"><span class="level-item">13</span><span class="level-item">HTTPRedirect</span></span></a></li><li><a class="level is-mobile" href="#HTTPRewrite"><span class="level-left"><span class="level-item">14</span><span class="level-item">HTTPRewrite</span></span></a></li><li><a class="level is-mobile" href="#StringMatch"><span class="level-left"><span class="level-item">15</span><span class="level-item">StringMatch</span></span></a></li><li><a class="level is-mobile" href="#HTTPRetry"><span class="level-left"><span class="level-item">16</span><span class="level-item">HTTPRetry</span></span></a></li><li><a class="level is-mobile" href="#CorsPolicy"><span class="level-left"><span class="level-item">17</span><span class="level-item">CorsPolicy</span></span></a></li><li><a class="level is-mobile" href="#HTTPFaultInjection"><span class="level-left"><span class="level-item">18</span><span class="level-item">HTTPFaultInjection</span></span></a></li><li><a class="level is-mobile" href="#PortSelector"><span class="level-left"><span class="level-item">19</span><span class="level-item">PortSelector</span></span></a></li><li><a class="level is-mobile" href="#Percent"><span class="level-left"><span class="level-item">20</span><span class="level-item">Percent</span></span></a></li><li><a class="level is-mobile" href="#Headers-HeaderOperations"><span class="level-left"><span class="level-item">21</span><span class="level-item">Headers.HeaderOperations</span></span></a></li><li><a class="level is-mobile" href="#HTTPFaultInjection-Delay"><span class="level-left"><span class="level-item">22</span><span class="level-item">HTTPFaultInjection.Delay</span></span></a></li><li><a class="level is-mobile" href="#HTTPFaultInjection-Abort"><span class="level-left"><span class="level-item">23</span><span class="level-item">HTTPFaultInjection.Abort</span></span></a></li><li><a class="level is-mobile" href="#HTTPRedirect-RedirectPortSelection"><span class="level-left"><span class="level-item">24</span><span class="level-item">HTTPRedirect.RedirectPortSelection</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Code-Walkthrough/"><span class="level-start"><span class="level-item">Code Walkthrough</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/categories/Getting-Started/"><span class="level-start"><span class="level-item">Getting Started</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Meetup/"><span class="level-start"><span class="level-item">Meetup</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Overview/"><span class="level-start"><span class="level-item">Overview</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">7</span></span></a><ul><li><a class="level is-mobile" href="/categories/Programming/Elegant-Coding/"><span class="level-start"><span class="level-item">Elegant Coding</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Quick-Start/"><span class="level-start"><span class="level-item">Quick Start</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="ğŸ¾Corgi" height="28"></a><p class="is-size-7"><span>&copy; 2023 Shen Xianghong</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p><p class="is-size-7"><br/>And did you get what you wanted from this life, even so?</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>