<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>ã€Œ Velero ã€æºç èµ°è¯» â€” Backup - ğŸ¾Corgi</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="ğŸ¾Corgi"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="ğŸ¾Corgi"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Velero ä¸­ä¸ Backup ç›¸å…³çš„æºç èµ°è¯»"><meta property="og:type" content="blog"><meta property="og:title" content="ã€Œ Velero ã€æºç èµ°è¯» â€” Backup"><meta property="og:url" content="http://shenxianghong.github.io/2022/01/27/2022-01-27%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Backup/"><meta property="og:site_name" content="ğŸ¾Corgi"><meta property="og:description" content="Velero ä¸­ä¸ Backup ç›¸å…³çš„æºç èµ°è¯»"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://picsum.photos/0?sig=20220127"><meta property="article:published_time" content="2022-01-26T16:00:00.000Z"><meta property="article:modified_time" content="2023-05-08T09:58:51.954Z"><meta property="article:author" content="Shen Xianghong"><meta property="article:tag" content="Velero"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://picsum.photos/0?sig=20220127"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://shenxianghong.github.io/2022/01/27/2022-01-27%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Backup/"},"headline":"ã€Œ Velero ã€æºç èµ°è¯» â€” Backup","image":[],"datePublished":"2022-01-26T16:00:00.000Z","dateModified":"2023-05-08T09:58:51.954Z","author":{"@type":"Person","name":"Shen Xianghong"},"publisher":{"@type":"Organization","name":"ğŸ¾Corgi","logo":{"@type":"ImageObject","url":"http://shenxianghong.github.io/img/logo.svg"}},"description":"Velero ä¸­ä¸ Backup ç›¸å…³çš„æºç èµ°è¯»"}</script><link rel="canonical" href="http://shenxianghong.github.io/2022/01/27/2022-01-27%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Backup/"><link rel="alternate" href="/atom.xml" title="ğŸ¾Corgi" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/xcode.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="ğŸ¾Corgi" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://picsum.photos/0?sig=20220127" alt="ã€Œ Velero ã€æºç èµ°è¯» â€” Backup"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="fa fa-calendar"></i>Â <time dateTime="${date_xml(page.date)}" title="${date_xml(page.date)}">2022-01-27</time></span><span class="level-item"><i class="fa fa-calendar-check"></i>Â <time dateTime="${date_xml(page.updated)}" title="${date_xml(page.updated)}">2023-05-08</time></span><span class="level-item"><i class="far fa-folder-open"></i>Â <a class="link-muted" href="/categories/Disaster-Recovery/">Disaster Recovery</a></span><span class="level-item"><i class="far fa-clock"></i>Â an hour read (About 7611 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">ã€Œ Velero ã€æºç èµ°è¯» â€” Backup</h1><div class="content"><div align=center><img width="170" style="border: 0px" src="https://velero.io/img/Velero.svg"></div>

<hr>
<blockquote>
<p>based on <strong>v1.6.3</strong></p>
</blockquote>
<h1 id="Backup"><a href="#Backup" class="headerlink" title="Backup"></a>Backup</h1><p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/backup.go">API</a></p>
<h2 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;backup.go</u></em></p>
<p>velero backup åŒ…æ‹¬ 6 ä¸ªå­å‘½ä»¤ï¼šcreateã€deleteã€describeã€downloadã€get å’Œ logsã€‚</p>
<h2 id="create"><a href="#create" class="headerlink" title="create"></a>create</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;create.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>å¿…é¡»æŒ‡å®š Backup åç§°ï¼Œé™¤éæŒ‡å®šäº† â€“from-schedule å‚æ•°</li>
<li>åœ¨æŒ‡å®š â€“storage-location å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
<li>åœ¨æŒ‡å®š â€“volume-snapshot-locations å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º Backup å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± Backup Controller è´Ÿè´£ç»´æŠ¤</li>
<li>å¦‚æœå¼€å¯äº† â€“waitï¼Œåˆ™å¯åŠ¨ informer ç›‘å¬ Backup å¯¹è±¡çŠ¶æ€ï¼Œé˜»å¡ç›´è‡³çŠ¶æ€ä¸å†æ˜¯ New æˆ–è€… InProgress</li>
</ol>
<p><em>å¦‚æœ Backup æ˜¯åŸºäºå®šæ—¶ä»»åŠ¡ï¼ˆScheduleï¼‰åˆ›å»ºçš„ï¼Œåˆ™å¿½ç•¥å…¶ä»–æ‰€æœ‰çš„ filter ä¿¡æ¯ï¼Œä»¥ Schedule è§„æ ¼ä¸ºå‡†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒBackup çš„åç§°ä¹Ÿå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤æ ¼å¼ä¸º schedule-timestampã€‚</em></p>
<h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;delete.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>nameã€â€“all å’Œ â€“selector å‚æ•°æœ‰ä¸”ä»…èƒ½æœ‰ä¸€ä¸ª</li>
<li>è¦åˆ é™¤çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º DeleteBackupRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± BackupDeletion Controller è´Ÿè´£ç»´æŠ¤</li>
</ol>
<h2 id="describe"><a href="#describe" class="headerlink" title="describe"></a>describe</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;describe.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>è¦è·å–çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>è·å–åˆ° Backup çš„åˆ é™¤äº‹ä»¶</li>
<li>è·å–åˆ°å·å¤‡ä»½çš„ä¿¡æ¯å’Œ CSI å¿«ç…§ä¿¡æ¯ï¼ˆå¦‚æœ Velero æœåŠ¡å¼€å¯äº† CSI ç‰¹æ€§ï¼‰</li>
<li>å°†ä»¥ä¸Šä¿¡æ¯å’Œ Backup çš„å…ƒä¿¡æ¯ã€è§„æ ¼ã€çŠ¶æ€ç­‰æ±‡æ€»ä½œä¸ºæè¿°ä¿¡æ¯æ ¼å¼åŒ–è¾“å‡º<br><em>åœ¨å¼€å¯ â€“details æ—¶ï¼Œä¼šæ„å»º DownloadRequest å¯¹è±¡è·å–  BackupResourceList çš„ä¿¡æ¯</em></li>
</ol>
<h2 id="download"><a href="#download" class="headerlink" title="download"></a>download</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;download.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>è¦è·å–çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º DownloadRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± DownloadRequest Controller è´Ÿè´£ç»´æŠ¤ï¼Œè·å– BackupContents çš„ä¿¡æ¯ </li>
<li>é˜»å¡ç›´è‡³ DownloadRequest çš„ DownloadURL è¢«è®¾ç½®ï¼Œå°†å†…å®¹å†™å…¥ â€“output æŒ‡å®šçš„ä½ç½®</li>
</ol>
<h2 id="get"><a href="#get" class="headerlink" title="get"></a>get</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;get.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>è¦è·å–çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>è·å–åˆ° Backup èµ„æºï¼Œæ ¹æ® â€“output æŒ‡å®šçš„æ ·å¼æ ¼å¼åŒ–è¾“å‡º</li>
</ol>
<h2 id="logs"><a href="#logs" class="headerlink" title="logs"></a>logs</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;backup&#x2F;logs.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>è¦è·å–çš„ Backup åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
<li>Backup çš„çŠ¶æ€å¿…é¡»ä¸º Completedã€PartiallyFailed æˆ–è€… Failed</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º DownloadRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± DownloadRequest Controller è´Ÿè´£ç»´æŠ¤ï¼Œè·å– BackupLog çš„ä¿¡æ¯ </li>
<li>é˜»å¡ç›´è‡³ DownloadRequest çš„ DownloadURL è¢«è®¾ç½®ï¼Œå°†å†…å®¹å†™å…¥ stdout ä¸­</li>
</ol>
<h1 id="PodVolumeBackup"><a href="#PodVolumeBackup" class="headerlink" title="PodVolumeBackup"></a>PodVolumeBackup</h1><p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/pod_volume_backup.go">API</a></p>
<p>å¯¹è±¡ä¸æ”¯æŒæ‰‹åŠ¨åˆ›å»ºï¼Œè€Œæ˜¯åœ¨å¤‡ä»½æµç¨‹ä¸­ï¼Œç”± Backup Controller è°ƒç”¨ <strong>backupPodVolumes</strong>ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ª Pod å·ï¼Œåˆ›å»ºä¸€ä¸ªè¯¥å¯¹è±¡ã€‚</p>
<h1 id="Schedule"><a href="#Schedule" class="headerlink" title="Schedule"></a>Schedule</h1><p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/vmware-tanzu/velero/release-1.6/pkg/apis/velero/v1/schedule.go">API</a></p>
<h2 id="schedule"><a href="#schedule" class="headerlink" title="schedule"></a>schedule</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;schedule.go</u></em></p>
<p>velero schedule åŒ…æ‹¬ 4 ä¸ªå­å‘½ä»¤ï¼šcreateã€deleteã€describe å’Œ getã€‚</p>
<h2 id="create-1"><a href="#create-1" class="headerlink" title="create"></a>create</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;create.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>â€“schedule ä¸ºå¿…éœ€å‚æ•°</li>
<li>åœ¨æŒ‡å®š â€“storage-location å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
<li>åœ¨æŒ‡å®š â€“volume-snapshot-locations å‚æ•°æ—¶ï¼Œå…¶åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><em>åˆ›å»ºå®šæ—¶å¤‡ä»½ä»»åŠ¡æ—¶å¹¶ä¸ä¼šæ ¡éªŒ schedule è¡¨è¾¾å¼çš„åˆæ³•æ€§ï¼Œè€Œæ˜¯äº¤ç»™ Schedule Controller ä½œåç»­å¤„ç†ã€‚</em></p>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œæ„å»º Schedule å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± Scheduler Controller è´Ÿè´£ç»´æŠ¤</li>
</ol>
<h2 id="delete-1"><a href="#delete-1" class="headerlink" title="delete"></a>delete</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;delete.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>nameã€â€“all å’Œ â€“selector å‚æ•°æœ‰ä¸”ä»…èƒ½æœ‰ä¸€ä¸ª</li>
<li>è¦åˆ é™¤çš„ Schedule åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>æ ¹æ®å‘½ä»¤è¡Œå‚æ•°ï¼Œè·å–é›†ç¾¤ä¸­çš„ Schedule èµ„æºå¹¶åˆ é™¤</li>
</ol>
<h2 id="describe-1"><a href="#describe-1" class="headerlink" title="describe"></a>describe</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;describe.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>è¦è·å–çš„ Schedule åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>è·å–åˆ° Schedule èµ„æºï¼Œæ ¼å¼åŒ–è¾“å‡º</li>
</ol>
<h2 id="get-1"><a href="#get-1" class="headerlink" title="get"></a>get</h2><p><em><u>pkg&#x2F;cmd&#x2F;cli&#x2F;schedule&#x2F;get.go</u></em></p>
<p><strong>æ ¡éªŒè§„åˆ™</strong></p>
<ul>
<li>è¦è·å–çš„ Schedule åœ¨é›†ç¾¤ä¸­å¿…é¡»å­˜åœ¨</li>
</ul>
<p><strong>ä¸»ä½“æµç¨‹</strong></p>
<ol>
<li>è·å–åˆ° Schedule èµ„æºï¼Œæ ¹æ® â€“output æŒ‡å®šçš„æ ·å¼æ ¼å¼åŒ–è¾“å‡º</li>
</ol>
<h1 id="Backup-Controller"><a href="#Backup-Controller" class="headerlink" title="Backup Controller"></a>Backup Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;backup_controller.go</u></em><br><em><u>pkg&#x2F;backup&#x2F;backup.go</u></em></p>
<h2 id="NewBackupController"><a href="#NewBackupController" class="headerlink" title="NewBackupController"></a>NewBackupController</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L89">NewBackupController æºç </a></p>
<p>å·¥å‚å‡½æ•°</p>
<ol>
<li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li>
<li>ç›‘å¬ Backup èµ„æºçš„ Add äº‹ä»¶ï¼Œå°†çŠ¶æ€æ˜¯ç©ºæˆ–è€… New çš„ Backup ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li>
</ol>
<h2 id="processBackup"><a href="#processBackup" class="headerlink" title="processBackup"></a>processBackup</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L207">processBackup æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p>
<ol>
<li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ Backup keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ Backup å¯¹è±¡</li>
<li>ä»…å¤„ç†çŠ¶æ€æ˜¯ç©ºæˆ–è€… New çš„ Backup å¯¹è±¡</li>
<li>è°ƒç”¨ <strong>prepareBackupRequest</strong> åšä¸€äº›æ ¡éªŒå‡†å¤‡å·¥ä½œï¼Œå¹¶æ ¹æ®æ ¡éªŒçš„ç»“æœè®¾ç½® Backup çš„çŠ¶æ€ä¸º FailedValidation æˆ–è€… InProgress</li>
<li>è¿‡æ»¤æ‰æ ¡éªŒå¤±è´¥çš„ Backupï¼Œè°ƒç”¨ <strong>runBackup</strong>ï¼Œæ‰§è¡Œå¤‡ä»½å’Œä¸Šä¼ å¤‡ä»½ä¿¡æ¯çš„æµç¨‹ï¼Œæ‰§è¡Œç»“æœå†³å®šäº†å¤‡ä»½æ˜¯å¦é¡ºåˆ©å®Œæˆï¼Œå¦‚æœæœ‰é”™è¯¯è¿”å›ï¼Œåˆ™è®°å½• Backup çŠ¶æ€ä¸º Failed</li>
</ol>
<h2 id="prepareBackupRequest"><a href="#prepareBackupRequest" class="headerlink" title="prepareBackupRequest"></a>prepareBackupRequest</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L328">prepareBackupRequest æºç </a></p>
<p>åœ¨ä¸ç ´åé›†ç¾¤ä¸­åŸ Backup å¯¹è±¡ï¼ˆä»¥ä¸‹ç§°ä¸º originalï¼‰çš„æƒ…å†µä¸‹ï¼Œæ„å»ºäº†ä¸€ä¸ª BackupRequest å¯¹è±¡ï¼ˆä»¥ä¸‹ç§°ä¸º requestï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«äº† original çš„è¯¦ç»†è§„æ ¼ï¼ˆå³ original çš„æ·±æ‹·è´ï¼‰ï¼Œå¹¶ä¸”åŒ…å«ä¸€äº›ä¸°å¯Œå¤„ç†æµç¨‹çš„ä¸­é—´æ€ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨æ•´ä¸ªå¤‡ä»½æµç¨‹ä¸­çš„æ“ä½œéƒ½æ˜¯åŸºäº requestï¼Œåœ¨å¤‡ä»½å®Œæˆåï¼Œä¼šå°† request ä¿¡æ¯åŒæ­¥æ›´æ–°è‡³é›†ç¾¤ä¸­çš„ Backup å¯¹è±¡ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Request is a request for a backup, with all references to other objects</span></span><br><span class="line"><span class="comment">// materialized (e.g. backup/snapshot locations, includes/excludes, etc.)</span></span><br><span class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</span><br><span class="line">	*velerov1api.Backup</span><br><span class="line"></span><br><span class="line">	StorageLocation           *velerov1api.BackupStorageLocation</span><br><span class="line">	SnapshotLocations         []*velerov1api.VolumeSnapshotLocation</span><br><span class="line">	NamespaceIncludesExcludes *collections.IncludesExcludes</span><br><span class="line">	ResourceIncludesExcludes  *collections.IncludesExcludes</span><br><span class="line">	ResourceHooks             []hook.ResourceHook</span><br><span class="line">	ResolvedActions           []resolvedAction</span><br><span class="line"></span><br><span class="line">	VolumeSnapshots  []*volume.Snapshot</span><br><span class="line">	PodVolumeBackups []*velerov1api.PodVolumeBackup</span><br><span class="line">	BackedUpItems    <span class="keyword">map</span>[itemKey]<span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹ request èµ‹å€¼å’Œæ ¡éªŒçš„æ“ä½œ</p>
<ol>
<li>å°† original æ·±æ‹·è´è‡³ request ä¸­çš„ Backup ä¸­ï¼Œå¹¶è®¾ç½® request  ç‰ˆæœ¬ã€è¿‡æœŸæ—¶é—´ã€æ˜¯å¦å°†å·æ•°æ®å¤‡ä»½è‡³ Resticã€StorageLocation ç­‰ä¿¡æ¯</li>
<li>æ ¡éªŒ BackupStorageLocation çš„åˆæ³•æ€§ï¼Œä»¥åŠ access mode æ˜¯å¦ä¸ºé¢„æœŸçš„ ReadWrite</li>
<li>æ£€éªŒ volume snapshot location çš„åˆæ³•æ€§<br><em>backup.Spec.VolumeSnapshotLocation ä¸º []string ç±»å‹ï¼Œæ”¯æŒå¤šä¸ª locationï¼Œä½†æ˜¯è¦æ±‚ location å’Œ VolumeSnapshotter å¿…é¡»æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¸å…è®¸å¤šä¸ª location å¯¹åº”åŒä¸€ä¸ª VolumeSnapshotterï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œâ€“snapshotvolume ä¸º trueï¼Œæ‰€ä»¥åªè¦å­˜åœ¨ä¸€ä¸ªåˆæ³•çš„ default vslï¼Œåˆ™æœ€ç»ˆçš„ backup.Spec.VolumeSnapshotLocation å‡ä¼šåŒ…å«è¿™ä¸ª default vslï¼Œè¯¦ç»†é€»è¾‘å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller_test.go#L861">TestValidateAndGetSnapshotLocations</a></em></li>
<li>è®¾ç½® request çš„æ³¨è§£å’Œ resources &amp; namespaces çš„ included &amp; excluded æ£€éªŒä¿¡æ¯</li>
</ol>
<h2 id="runBackup"><a href="#runBackup" class="headerlink" title="runBackup"></a>runBackup</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L533">runBackup æºç </a></p>
<p>å¤‡ä»½çš„æ•´ä½“æµç¨‹</p>
<ol>
<li><p>åŸºäºä¸´æ—¶æ–‡ä»¶å¥æŸ„ç”Ÿæˆ gzip writer ï¼Œå¹¶æŒ‡å®š stdout å’Œ gzip writer ä¸º logger è¾“å‡ºï¼Œåˆå§‹åŒ–ç”¨äºç»Ÿè®¡æ—¥å¿—çº§åˆ«æ•°é‡çš„ counter<br><em>å› æ­¤ï¼Œæ—¥å¿—ä¸ä»…ä¼šè¾“å‡ºåœ¨ Velero Pod ä¸­ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆ BackupLogï¼Œåç»­ä¼šä¸Šä¼ è‡³ BackupStorageLocation ä¸­</em></p>
</li>
<li><p>ç”Ÿæˆä¸€ä¸ªç”¨äºå­˜æ”¾ Backup ç‰ˆæœ¬å’Œå†…å®¹çš„ä¸´æ—¶æ–‡ä»¶<br><em>åç»­åœ¨è°ƒç”¨ <strong>Backup</strong> æ—¶ä¼šä¼ å…¥è¯¥ä¸´æ—¶æ–‡ä»¶</em></p>
</li>
<li><p>è·å–æ³¨å†Œçš„ BackupItemAction æ’ä»¶<br><em>åç»­åœ¨è°ƒç”¨ <strong>Backup</strong> æ—¶ä¼šä¼ å…¥è¯¥ action ä¿¡æ¯</em></p>
</li>
<li><p>é€šè¿‡ StorageProvider çš„ BackupExists æ¥å£åˆ¤æ–­è¿œç«¯å­˜å‚¨ä¸­æ˜¯å¦æœ‰åŒåå¤‡ä»½</p>
<ul>
<li>å¦‚æœå­˜åœ¨ï¼Œåˆ™è®¾ç½® Backup çŠ¶æ€ä¸º Failedï¼Œæœ¬æ¬¡å¤‡ä»½å¤±è´¥</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨ <strong>Backup</strong> è¿›è¡Œå‡†å¤‡ä¸å¤‡ä»½</li>
</ul>
</li>
<li><p>å¦‚æœ Velero å¼€å¯äº† CSI ç‰¹æ€§ï¼Œåˆ™è·å–é›†ç¾¤ä¸­ä¸è¯¥ Backup ç›¸å…³çš„ VolumeSnapshots å’Œ VolumeSnapshotContents ä¿¡æ¯<br><em>åç»­ä¼šä¸Šä¼ è‡³ BackupStorageLocation ä¸­</em></p>
</li>
<li><p>è®¾ç½® request çš„å·å¿«ç…§æ€»é‡ä¸æˆåŠŸé‡ã€å®Œæˆæ—¶é—´æˆ³ã€Warnings å’Œ Errors çš„ä¸ªæ•°ä»¥åŠå¤‡ä»½çš„çŠ¶æ€ç­‰ç­‰ï¼Œå…³é—­æ—¥å¿—æ–‡ä»¶ï¼Œæœ¬æ¬¡å¤‡ä»½ä»»åŠ¡æ—¥å¿—è®°å½•å®Œæ¯•<br><em>å¤‡ä»½çš„çŠ¶æ€ï¼ˆFailedã€PartiallyFailed æˆ–è€… Completedï¼‰æ˜¯æ ¹æ®æ—¥å¿—è¾“å‡ºçº§åˆ«çš„ç»Ÿè®¡å†³å®šçš„ï¼ŒfatalErrs è®°å½•äº†è°ƒç”¨ backupper.Backup äº§ç”Ÿçš„é”™è¯¯æ—¥å¿—ä¿¡æ¯ï¼Œä¸ä»…å¦‚æ­¤ï¼Œåœ¨åç»­ä¸Šä¼ å¤‡ä»½æ–‡ä»¶çš„æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¼šè®°å½•ï¼Œæ‰€ä»¥ request çš„çŠ¶æ€æ˜¯å¦ä¸º Failed æ˜¯ fatalErrs å†³å®šçš„ï¼Œè€ŒçŠ¶æ€æ˜¯å¦ä¸º Completed å’Œ PartiallyFailed æ˜¯æ ¹æ®æ—¥å¿—ä¸­ Error çº§åˆ«çš„è¾“å‡ºæ•°é‡å†³å®šçš„ï¼Œ<strong>è¯¥æ—¥å¿—ä¹ŸåŒ…æ‹¬è°ƒç”¨ StorageProvider ä¸­äº§ç”Ÿçš„æ—¥å¿—çº§åˆ«ä¿¡æ¯</strong></em></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">backup.Status.Warnings = logCounter.GetCount(logrus.WarnLevel)</span><br><span class="line">backup.Status.Errors = logCounter.GetCount(logrus.ErrorLevel)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assign finalize phase as close to end as possible so that any errors</span></span><br><span class="line"><span class="comment">// logged to backupLog are captured. This is done before uploading the</span></span><br><span class="line"><span class="comment">// artifacts to object storage so that the JSON representation of the</span></span><br><span class="line"><span class="comment">// backup in object storage has the terminal phase set.</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="built_in">len</span>(fatalErrs) &gt; <span class="number">0</span>:</span><br><span class="line">	backup.Status.Phase = velerov1api.BackupPhaseFailed</span><br><span class="line"><span class="keyword">case</span> logCounter.GetCount(logrus.ErrorLevel) &gt; <span class="number">0</span>:</span><br><span class="line">	backup.Status.Phase = velerov1api.BackupPhasePartiallyFailed</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">	backup.Status.Phase = velerov1api.BackupPhaseCompleted</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é‡æ–°è·å– StorageProviderï¼Œé¿å…é•¿æ—¶é—´å¤‡ä»½ä¸­è®¤è¯ä¿¡æ¯å˜åŠ¨ï¼Œ è°ƒç”¨ StorageProvider çš„ PutBackup æ¥å£å°†å¤‡ä»½ä¿¡æ¯ä¸Šä¼ è‡³ BackupStorageLocation ä¸­ï¼Œå…·ä½“æ–‡ä»¶çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>BackupStorageLocation ä¸­çš„æ–‡ä»¶</th>
<th>æ•°æ®æº</th>
</tr>
</thead>
<tbody><tr>
<td>Metadata</td>
<td>velero-backup.json</td>
<td>backup.Backup å¯¹è±¡</td>
</tr>
<tr>
<td>Content</td>
<td>&lt;backup&gt;.tar.gz</td>
<td>æ­¥éª¤ 2 ä¸­çš„ä¸´æ—¶æ–‡ä»¶å†…å®¹</td>
</tr>
<tr>
<td>Log</td>
<td>&lt;backup&gt;-logs.gz</td>
<td>æ­¥éª¤ 6 ä¸­æœ€ç»ˆç”Ÿæˆçš„ log æ–‡ä»¶</td>
</tr>
<tr>
<td>PodVolumeBackups</td>
<td>&lt;backup&gt;-podvolumebackups.json</td>
<td>backup.PodVolumeBackups</td>
</tr>
<tr>
<td>VolumeSnapshots</td>
<td>&lt;backup&gt;-volumesnapshots.json.gz</td>
<td>backup.VolumeSnapshots</td>
</tr>
<tr>
<td>BackupResourceList</td>
<td>&lt;backup&gt;-resource-list.json.gz</td>
<td>backup.BackedUpItems</td>
</tr>
<tr>
<td>CSIVolumeSnapshots</td>
<td>&lt;backup&gt;-csi-volumesnapshots.json.gz</td>
<td>æ­¥éª¤ 5 ä¸­ volume snapshots</td>
</tr>
<tr>
<td>CSIVolumeSnapshotContents</td>
<td>&lt;backup&gt;-csi-volumesnapshotcontents.json.gz</td>
<td>æ­¥éª¤ 5 ä¸­ volume snapshot contents</td>
</tr>
</tbody></table>
<p>è¿™é‡Œéœ€è¦åŒºåˆ† PodVolumeBackups å’Œ VolumeSnapshots</p>
<ul>
<li>PodVolumeBackups æ˜¯æè¿°äº†å¤‡ä»½çš„ Pod ä¸­çš„å·æ•°æ®ä¿¡æ¯ï¼Œä¸ä¹‹å…³è”çš„æ˜¯ Restic ç›¸å…³æ¦‚å¿µï¼Œæ•°æ®æœ€ç»ˆä¼šå†™å…¥ ResticRepository ä¸­</li>
<li>VolumeSnapshots æ˜¯ç›¸æ¯”äº CSI è€Œè¨€å±äº Velero åŸç”Ÿçš„å·å¿«ç…§ï¼Œç”¨äºæè¿°ä¸€ä¸ª PV å¿«ç…§çš„ä¿¡æ¯ï¼Œæœ¬èº«ä½œä¸º Backup çš„ä¸€éƒ¨åˆ†ï¼Œæ•°æ®æœ€ç»ˆä¼šç”±å¯¹åº”çš„ SnapshotProvider å¤„ç†</li>
<li>å³ä½¿ä¸¤è€…æœ€ç»ˆçš„æ•°æ®å‡ä¸ä¼šå­˜æ”¾åœ¨ BackupStorageLocation ä¸­ï¼Œä½†æ˜¯ä»ç„¶ä¼šåœ¨ BackupStorageLocation ä¸­è®°å½•å…¶åŸºç¡€ä¿¡æ¯</li>
</ul>
</li>
</ol>
<h2 id="Backup-1"><a href="#Backup-1" class="headerlink" title="Backup"></a>Backup</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/backup/backup.go#L205">Backup æºç </a></p>
<p>å¤‡ä»½åŠ¨ä½œæœ¬èº«çš„æµç¨‹</p>
<ol>
<li>åŸºäºä¼ å…¥çš„ä¸´æ—¶æ–‡ä»¶ï¼Œç”Ÿæˆ gzip writerï¼Œæœ€ç»ˆä¼šä»¥ <em>backup</em>.tar.gz æ ¼å¼å­˜æ”¾åœ¨ BackupStorageLocation ä¸­ä½œä¸º Contentï¼Œè¯¥ tar.gz åŒ…æ‹¬ä¸¤ä¸ªä¸»è¦å†…å®¹ï¼šmetadata å’Œ resourcesï¼Œå‰è€…ç”¨äºå­˜æ”¾ç‰ˆæœ¬ï¼Œåè€…ç”¨äºå­˜æ”¾è¢«å¤‡ä»½èµ„æºçš„è¯¦ç»†è§„æ ¼ä¿¡æ¯<br><em>åŒºåˆ«äºè®°å½• Backup æœ¬èº«çš„ Metadataï¼Œæ­¤å¤„çš„ metdata ä»…ä¸ºä¸€ä¸ªç›®å½•å±‚çº§ï¼›åœ¨åç»­ <strong>backupItem</strong> æµç¨‹ä¸­ï¼Œä¼šå°†èµ„æºä¿¡æ¯å†™å…¥ resources æ–‡ä»¶ä¸­</em></li>
<li>åœ¨ metadata ç›®å½•ä¸‹å†™å…¥ç‰ˆæœ¬ä¿¡æ¯ versionï¼Œå›ºå®šå€¼ä¸º 1.1.0</li>
<li>è®¾ç½® request çš„ resource &amp; namespace çš„ included &amp; excludedã€resources hook ä»¥åŠ resolve actionï¼ˆBackupItemActionï¼‰<ul>
<li>namespace å’Œ resource çš„å¤„ç†æ–¹å¼å¹¶ä¸ä¸€æ ·ï¼Œæ˜¯å› ä¸º namespace åªè¦åšåŒ¹é…å³å¯ï¼Œå­˜åœ¨ä¸ä¸å­˜åœ¨å¾ˆå®¹æ˜“å®šæ€§ï¼Œä½†æ˜¯ resource æœ‰å¾ˆå¤šç§è¡¨ç¤ºæ–¹å¼ï¼Œä¾‹å¦‚ pv å’Œ persistentvolumesï¼Œå¯¹äºå¤æ‚çš„èµ„æºæ¥è®²ï¼Œè¿˜æœ‰ ApiGroup çš„æ¦‚å¿µï¼Œå› æ­¤ï¼Œéœ€è¦ RESTmapping çš„ ResourceFor åŒ¹é…å‡ºæœ€åˆé€‚ä¸”è§„èŒƒçš„ä¸€ä¸ª GVRï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨æ—¶å¯ä»¥åœ¨åˆç†èŒƒå›´ä»»æ„æŒ‡å®šèµ„æºåç§°å‡ä¼šåŒ¹é…æ­£ç¡®çš„åŸå› </li>
<li>BackupItemAction æœ‰ä¸¤ä¸ªæ¥å£ï¼Œä¸€ä¸ªæ˜¯ AppliesToï¼Œä¸€ä¸ªæ˜¯ Executeï¼Œå‰è€…ç”¨äºè¿”å› labelSelectorï¼Œç”¨äºå¤‡ä»½é˜¶æ®µçš„è¿‡æ»¤ç­›é€‰ï¼Œåè€…ç”¨äºæ‰§è¡Œ BackupItemAction ä¸­å®šä¹‰çš„é¢å¤–åŠ¨ä½œ</li>
</ul>
</li>
<li>ç”Ÿæˆä¸´æ—¶ç©ºæ–‡ä»¶ï¼Œä¾›åç»­ itemCollector ä½¿ç”¨ï¼ŒitemCollector æ ¹æ® Backup è§„æ ¼ä¿¡æ¯é€šè¿‡ K8s API æ”¶é›†å¾…å¤‡ä»½çš„èµ„æºè¯¦ç»†ä¿¡æ¯å¹¶å†™å…¥ç©ºæ–‡ä»¶ä¸­<br><em>è¯¥ç©ºæ–‡ä»¶ç”¨äº <strong>getAllItems</strong> æ—¶ï¼Œä½œä¸ºæ¯ä¸€ä¸ª item çš„è§£æ„æ–‡ä»¶çš„æ ¹ç›®å½•</em></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/backup/item_collector.go#L57">getAllItems</a> é€šè¿‡ discovery è·å–åˆ°æ‰€æœ‰çš„ API groupï¼ˆä¾‹å¦‚ batch&#x2F;v1beta1ï¼Œnetworking.k8s.io&#x2F;v1beta1 ç­‰ç­‰ï¼‰ï¼Œç„¶åæ ¹æ®æ¯ä¸ª group è·å–åˆ° resourceï¼ˆä¾‹å¦‚ cronjobsï¼Œnetworkpolicies ç­‰ç­‰ï¼‰ï¼Œæ ¹æ® namespace å’Œ resource çš„ include å’Œ exclude ä»¥åŠæ ‡ç­¾é€‰æ‹©å™¨è§„åˆ™è¿›è¡Œè¿‡æ»¤èµ„æºï¼Œè¿‡æ»¤åçš„ç»“æœå°±æ˜¯å¾…å¤‡ä»½çš„å¯¹è±¡ï¼ˆitemï¼‰<br><em>item çš„å†…å®¹ï¼ˆunstructured.Unstructured å¯¹è±¡ï¼‰å·²ç»å†™å…¥äº†æ­¥éª¤ 4 çš„ä¸´æ—¶ç›®å½•é‡Œï¼ŒåŒæ—¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„è·¯å¾„ä¼šè®°å½•åœ¨ item çš„ path ä¸­ï¼Œåç»­åœ¨ <strong>backupItem</strong> æ—¶ï¼Œä¼šè§£æä½œä¸ºè§£æ„çŠ¶æ€çš„ item ä¼ å…¥</em></li>
<li>æ›´æ–° Backup çš„å¾…å¤‡ä»½èµ„æºçš„æ€»é‡ä¿¡æ¯</li>
<li>ç”Ÿæˆ update é˜Ÿåˆ—ï¼Œç”¨äºè®°å½• Backup çŠ¶æ€ä¿¡æ¯ï¼ŒåŒæ—¶å¯åŠ¨ä¸€ä¸ª Goroutine ç›‘å¬é˜Ÿåˆ—ï¼Œæ¯ç§’é’Ÿè·å–ä¸€æ¬¡ update é˜Ÿåˆ—ä¸­çš„è¿›åº¦å¹¶æ›´æ–°è‡³ Backup ä¸­</li>
<li>éå†æ¯ä¸€ä¸ªå¾…å¤‡ä»½çš„ itemï¼Œè°ƒç”¨ <strong>backupItem</strong> å‡½æ•°ï¼Œè¿›è¡Œå¤‡ä»½ï¼Œå¹¶å°†è¿›åº¦ä¿¡æ¯å†™å…¥ update é˜Ÿåˆ—ä¸­ï¼Œå®Œæˆè¿›åº¦ä¸ŠæŠ¥</li>
<li>å¦‚æœå¤‡ä»½è§„æ ¼ä¸­æŒ‡å®šäº†å¤‡ä»½é›†ç¾¤çº§åˆ«èµ„æºï¼ˆIncludeClusterResourcesï¼‰ï¼Œåˆ™é¢å¤–å¤‡ä»½ CRD èµ„æº<br><em>è¿™é‡Œçš„ CRD èµ„æºå…¶å®æ˜¯æœ‰é™åˆ¶æ¡ä»¶çš„ï¼Œå°±æ˜¯ä»…å¤„ç†å·²ç»å¤‡ä»½äº†ä¸ CRD ç›¸å…³çš„ CR èµ„æºæ—¶ï¼Œæ‰ä¼šå¤‡ä»½å¯¹åº”çš„ CRD</em></li>
<li>æ›´æ–°é›†ç¾¤ä¸­ Backup å¯¹è±¡çš„å¤‡ä»½è¿›åº¦ä¿¡æ¯è‡³ 100%</li>
</ol>
<h2 id="backupItem"><a href="#backupItem" class="headerlink" title="backupItem"></a>backupItem</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/backup/backup.go#L424">backupItem æºç </a></p>
<p>å•ä¸ª item èµ„æºçš„å¤‡ä»½æµç¨‹</p>
<ol>
<li>ä¼ å…¥çš„ item æ˜¯è§£æ„çŠ¶æ€çš„èµ„æºä¿¡æ¯ï¼ˆruntime.Unstructuredï¼‰ï¼Œè§£æ„æ•°æ®æ¥æºäº item çš„ path å­—æ®µï¼Œéœ€è¦é‡æ–°æ„å»ºæˆ metav1.Objectï¼Œæå–ä¿¡æ¯</li>
<li>å¯¹äºä»¥ä¸‹æƒ…å†µè·³è¿‡å¤‡ä»½ï¼Œå¹¶ä¸”è¿”å› false æ ‡è¯†ï¼Œè¡¨ç¤ºèµ„æºæœªå‚ä¸å¤‡ä»½<br><em>æœªå‚ä¸å¤‡ä»½çš„èµ„æºï¼Œå³ä½¿åœ¨æŒ‡å®šäº†å¤‡ä»½é›†ç¾¤çº§åˆ«èµ„æºæ—¶ä¹Ÿä¸ä¼šå¤‡ä»½ç›¸å…³çš„ CRD</em><ul>
<li>æ ‡ç­¾ä¸­æœ‰ velero.io&#x2F;exclude-from-backup å­—æ®µçš„èµ„æº</li>
<li>èµ„æºå±äº Backup è§„æ ¼ä¸­æŒ‡å®šçš„ namespace å’Œ groupResource çš„</li>
<li>é namespace çš„èµ„æºå³æ˜¯é›†ç¾¤çº§åˆ«çš„ï¼Œä½†æ˜¯å¤‡ä»½è§„æ ¼ä¸­çš„ IncludeClusterResources ä¸º false</li>
<li>èµ„æºå¤„äºåˆ é™¤çŠ¶æ€</li>
</ul>
</li>
<li>å¯¹äºå·²ç»å¤‡ä»½çš„èµ„æºï¼Œè‡ªç„¶ä¹Ÿä¼šè·³è¿‡å¤‡ä»½ï¼Œä½†æ˜¯è¿”å› true æ ‡è¯†ï¼Œè¡¨ç¤ºèµ„æºå·²ç»å¤‡ä»½</li>
<li>æ‰§è¡Œ pre hook åŠ¨ä½œï¼ˆåªæœ‰ç±»å‹æ˜¯ Pod çš„ èµ„æºæ‰ä¼šçœŸæ­£çš„å¤„ç† pre hookï¼‰ï¼Œhook ä½œç”¨çš„å¯¹è±¡éœ€è¦æ»¡è¶³ BackupItemAction ä¸­å®šä¹‰çš„ applyTo æ¥å£çš„æ ‡ç­¾é€‰æ‹©ï¼Œhook command çš„æ‰§è¡Œï¼ˆå³ execute æ¥å£ï¼‰æ˜¯é€šè¿‡ K8s rest API exec å®ç°</li>
<li>é’ˆå¯¹ç±»å‹æ˜¯ Pod çš„èµ„æºï¼Œåœ¨ spec.Volumes ä¸­è·å–éœ€è¦å€ŸåŠ© Restic å¤‡ä»½çš„å·<br><em>ç”±äº PV å’Œ PVC æ˜¯ 1 å¯¹ 1ï¼ŒPVC å’Œ Pod æ˜¯ 1 å¯¹ n çš„å…³ç³»ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œé€šè¿‡è·Ÿè¸ª PVC çš„å¤‡ä»½æƒ…å†µå³å¯åˆ¤æ–­å·æ˜¯å¦è¢«å¤‡ä»½è¿‡ï¼Œå¤‡ä»½è¿‡çš„å·ï¼Œä¼šåœ¨ç›¸å…³çš„ tracker ä¸­ä»¥ PVC ä¸º key ä½œè®°å½•</em></li>
<li>è°ƒç”¨ BackupItemAction çš„ execute æ¥å£ï¼Œè¿›è¡Œé¢å¤–çš„æ“ä½œï¼Œå¦‚æ›´æ–°èµ„æºç­‰ï¼Œæ­¤åçš„æµç¨‹åŸºäºæ¥å£è¿”å›çš„å¯¹è±¡ç»§ç»­æ“ä½œï¼Œæ‰§è¡Œå¤±è´¥æ—¶ï¼Œä¼šæ‰§è¡Œ post hook åŠ¨ä½œ</li>
<li>é’ˆå¯¹ç±»å‹æ˜¯ PV çš„èµ„æºï¼Œè°ƒç”¨ takePVSnapshotï¼Œå¿½ç•¥å·²ç»è¢« Restic å¤‡ä»½çš„ PVï¼Œåˆå§‹åŒ– SnapshotProviderï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„æ¥å£ï¼Œå®Œæˆå·å¿«ç…§çš„æ“ä½œï¼Œå¹¶å°†å¿«ç…§ä¿¡æ¯è®°å½•åœ¨ request çš„ VolumeSnapshots ä¸­<br><em>åœ¨ Velero å¼€å¯ CSI ç‰¹æ€§æ—¶ï¼Œéœ€è¦é¢å¤–åŠ è½½ä¸€ä¸ª pluginï¼ˆ<a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero-plugin-for-csi%EF%BC%89%EF%BC%8C%E8%AF%A5">https://github.com/vmware-tanzu/velero-plugin-for-csiï¼‰ï¼Œè¯¥</a> plugin å°±æ˜¯ SnapshotProvider ç±»å‹ã€‚å› æ­¤åœ¨è¿™æ­¥æ—¶ï¼Œä¾¿ä¼šå¯¹ PV åšå¿«ç…§æ“ä½œ</em></li>
<li>é’ˆå¯¹ç±»å‹æ˜¯ Pod çš„èµ„æºï¼Œè°ƒç”¨ <strong>BackupPodVolumes</strong>ï¼Œå€ŸåŠ© Restic èƒ½åŠ›å®ç°å¯¹ Pod å·æ•°æ®çš„å¤‡ä»½</li>
<li>æ‰§è¡Œ post hook åŠ¨ä½œ</li>
<li>åœ¨ resources ç›®å½•ä¸‹å†™å…¥å¤‡ä»½çš„èµ„æºä¿¡æ¯ï¼Œèµ„æºä¼šæ ¹æ® kindã€ namepace ç­‰ä¿¡æ¯å½’ç±»ï¼Œæ–‡ä»¶å†…å®¹ä¸º item çš„ runtime.Unstructured å½¢å¼ï¼Œä»¥ json æ ¼å¼å­˜å‚¨<br><em>æ–‡ä»¶æ˜¯ä¸Šå±‚è°ƒç”¨ä¼ å…¥çš„ Content æ–‡ä»¶</em></li>
<li>è‡³æ­¤ï¼Œé’ˆå¯¹å•ä¸€çš„ item å¤‡ä»½æµç¨‹ç»“æŸï¼Œå…¶ä¸­åŒ…å«äº†å­˜å‚¨åœ¨ kube-apiserver ä¸­çš„ç»“æ„åŒ–å…ƒä¿¡æ¯å’Œå·æ•°æ®çš„å¤‡ä»½</li>
</ol>
<h2 id="BackupPodVolumes"><a href="#BackupPodVolumes" class="headerlink" title="BackupPodVolumes"></a>BackupPodVolumes</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restic/backupper.go#L99">backupPodVolumes æºç </a></p>
<p>å€ŸåŠ© Restic èƒ½åŠ›å¤‡ä»½å·æ•°æ®çš„æµç¨‹</p>
<ol>
<li>æ¯ä¸€ä¸ª Pod å·æ‰€å±çš„ namespace å¿…é¡»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹åº”çš„ ResticRepository å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªï¼Œç”± ResticRepository Controller ä¼šè´Ÿè´£ç»´æŠ¤çŠ¶æ€ï¼Œè€Œ Backup Controller  ä¼šé˜»å¡ç›´è‡³ ResticRepository è¶…æ—¶æˆ–è€… ready<br><em>åˆ›å»ºå¯¹è±¡æ—¶ä¼šæŒ‡å®šåŸºäºçš„ BackupStorageLocationï¼Œå¹¶å°† BackupStorageLocation è½¬æ¢æˆ RepoIdentifier ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ Restic åŸç”Ÿå‘½ä»¤ä¸­çš„ -r å‚æ•°</em></li>
<li>è¿‡æ»¤æ‰ hostPath ç±»å‹çš„å·ï¼Œå¯¹å…¶ä½™çš„åˆæ³•å·ä¼šåˆ›å»ºå¯¹åº”çš„ PodVolumeBackup å¯¹è±¡ï¼Œå…¶ä¸­ PodVolumeBackup ä¸­ä¼šè®¾ç½® velero.io&#x2F;backup-name æ ‡ç­¾ä»¥åŠ PVC çš„ UID ä¿¡æ¯<br><em>æ­¤æ—¶ï¼Œè¯¥å¯¹è±¡çš„ spec.RepoIdentifier å·²è¢«è®¾ç½®ï¼Œä¾‹å¦‚ s3:<a target="_blank" rel="noopener" href="http://minio.velero.svc:9000/velero/restic/velero%E3%80%82%E6%AD%A4%E5%A4%96%EF%BC%8C%E7%94%B1%E4%BA%8E%E5%9C%A8">http://minio.velero.svc:9000/velero/restic/veleroã€‚æ­¤å¤–ï¼Œç”±äºåœ¨</a> velero 1.6.3 ä¸­ä¸ä¼šåˆ¤æ–­ Pod çš„çŠ¶æ€ï¼Œå› æ­¤ä¾æ—§ä¼šå¯¹ pending çŠ¶æ€çš„ Pod åˆ›å»º PodVolumeBackup å¯¹è±¡ï¼Œä½†æ˜¯æ­¤ PodVolumeBackup å¯¹è±¡æ²¡æœ‰ nodeName å±æ€§ï¼Œå¯¼è‡´ Restic ä¸ä½œå¤„ç†ï¼Œä»è€Œé˜»å¡ Velero ç›´è‡³è¶…æ—¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œrestic çŠ¶æ€å¼‚å¸¸ä¹Ÿä¼šå¯¼è‡´ç±»ä¼¼é—®é¢˜ï¼Œå‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/issues/4874">https://github.com/vmware-tanzu/velero/issues/4874</a></em></li>
<li>PodVolumeBackup Controller ä¼šè´Ÿè´£å·çš„å¤‡ä»½ï¼Œè€Œ Backup Controller ä¼šé˜»å¡ç›´è‡³å·å¤‡ä»½è¿”å›å®Œæˆæˆ–è€…å¤±è´¥</li>
</ol>
<h2 id="resync"><a href="#resync" class="headerlink" title="resync"></a>resync</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_controller.go#L166">resync æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 1 åˆ†é’Ÿ</p>
<ol>
<li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ Backup å¯¹è±¡ï¼Œæ›´æ–° backup_total æŒ‡æ ‡ï¼Œvalue ä¸ºé›†ç¾¤ä¸­æ‰€æœ‰ Backup æ€»æ•°</li>
<li>é’ˆå¯¹æ¯ä¸€ä¸ªçŠ¶æ€å·²ç»å®Œæˆä¸”å½’å±äºæŸä¸€ä¸ª Schedule çš„ Backupï¼Œè®¾ç½® backup_last_successful_timestamp æŒ‡æ ‡ï¼Œkey ä¸º Schedule åç§°ï¼Œvalue ä¸ºæœ€è¿‘çš„ä¸€æ¬¡å¤‡ä»½æ—¶é—´æˆ³</li>
</ol>
<h1 id="PodVolumeBackup-Controller"><a href="#PodVolumeBackup-Controller" class="headerlink" title="PodVolumeBackup Controller"></a>PodVolumeBackup Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;pod_volume_backup_controller.go</u></em><br><em><u>pkg&#x2F;restic&#x2F;exec_commands.go</u></em></p>
<h2 id="NewPodVolumeBackupController"><a href="#NewPodVolumeBackupController" class="headerlink" title="NewPodVolumeBackupController"></a>NewPodVolumeBackupController</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_backup_controller.go#L72">NewPodVolumeBackupController æºç </a></p>
<p>å·¥å‚å‡½æ•°</p>
<ol>
<li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandlerï¼Œå¹¶å°† PodVolumeBackupã€Pod å’Œ PVC æ·»åŠ åˆ° cacheSyncWaitersï¼Œç­‰å¾…åŒæ­¥å®Œæˆ</li>
<li>ç›‘å¬ PodVolumeBackup èµ„æºçš„ Add å’Œ Update äº‹ä»¶ï¼Œå°†çŠ¶æ€æ˜¯ç©ºæˆ–è€… New å¹¶ä¸”ä½äºå½“å‰èŠ‚ç‚¹çš„ PodVolumeBackup èµ„æºä»¥ key ï¼ˆnamespace&#x2F;nameï¼‰ çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­<br><em>PodVolumeBackup Controller è¿è¡Œåœ¨ DaemonSet å½¢å¼çš„ Restic æœåŠ¡ä¸­ï¼ŒæŒ‚è½½æ‰€åœ¨èŠ‚ç‚¹çš„ Pod å·ï¼Œå› æ­¤ PodVolumeBackup å…·æœ‰èŠ‚ç‚¹å±æ€§ï¼ŒPodVolumeBackup Controller ä»…å¤„ç†å½“å‰èŠ‚ç‚¹çš„ PodVolumeBackup å¯¹è±¡</em></li>
</ol>
<h2 id="processQueueItem"><a href="#processQueueItem" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_backup_controller.go#L140">processQueueItem æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p>
<ol>
<li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ PodVolumeBackup keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ PodVolumeBackup å¯¹è±¡</li>
<li>ä»…å¤„ç†çŠ¶æ€ä¸ºç©ºæˆ–è€… New çš„ PodVolumeBackup å¯¹è±¡ï¼Œè°ƒç”¨ <strong>processBackup</strong>ï¼Œæ‰§è¡Œå·æ•°æ®çš„å¤‡ä»½</li>
</ol>
<h2 id="ProcessBackup"><a href="#ProcessBackup" class="headerlink" title="ProcessBackup"></a>ProcessBackup</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_backup_controller.go#L188">ProcessBackup æºç </a></p>
<p>å·æ•°æ®å¤‡ä»½çš„æ•´ä½“æµç¨‹</p>
<ol>
<li>æ›´æ–° PodVolumeBackup çŠ¶æ€ä¸º InProgress</li>
<li>æ ¡éªŒ PodVolumeBackup å¯¹è±¡è§„æ ¼ä¸­å£°æ˜çš„å·æº Pod æ˜¯å¦å­˜åœ¨ï¼Œè·å–åˆ° Pod å·åœ¨ host ä¸Šå­ç›®å½•ä¿¡æ¯<br><em>ä¾‹å¦‚  &#x2F;host_pods&#x2F;e4ccf918-76d7-4972-a54a-39b39f15b53b&#x2F;volumes&#x2F;kubernetes.io~empty-dir&#x2F;pluginsï¼Œ&#x2F;host_pods ä¸º Restic Pod ä¸­çš„ç›®å½•ï¼ŒæŒ‚è½½äº† host çš„ &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;ï¼Œ è¯¦ç»†é€»è¾‘å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/util/kube/utils_test.go#L159">TestGetVolumeDirectorySuccess</a></em></li>
<li>ç”Ÿæˆç”¨äºè¿æ¥ Restic Repo æ‰€éœ€è¦çš„ä¸´æ—¶å¯†ç æ–‡ä»¶ï¼Œæ–‡ä»¶å›ºå®šä¸º &#x2F;tmp&#x2F;credentials&#x2F;velero&#x2F;velero-restic-credentials-repository-passwordï¼Œå†…å®¹ä¸º static-passw0rdï¼Œç”¨äº restic åŸç”Ÿå‘½ä»¤ä¸­çš„ â€“password å‚æ•°<br><em>å¯†ç ä¼šä»¥ Secret çš„å½¢å¼å­˜å‚¨åœ¨é›†ç¾¤ä¸­ï¼Œåä¸º velero-restic-credentialsï¼Œä½äº velero å‘½åç©ºé—´å†…</em></li>
<li>æ„å»º restic backup å‘½ä»¤</li>
<li>å¦‚æœ BackupStorageLocation æœ‰ caCert è¯ä¹¦ä¿¡æ¯ï¼Œä¼šå°†å…¶ä¸´æ—¶å†™å…¥åˆ°ç£ç›˜ä¸­ï¼Œä¾› Restic è®¤è¯ä½¿ç”¨ï¼Œå¹¶è®¾ç½®åœ¨ restic backup å‘½ä»¤ä¸­<br><em>å› ä¸ºæœ¬è´¨ä¸Šï¼ŒRestic çš„ repo å’Œ Velero çš„ BackupStorageLocation ä¸ºåŒä¸€ä¸ª</em></li>
<li>ç»™ restic backup å‘½ä»¤è®¾ç½® Restic åŸç”Ÿæ‰€éœ€çš„ç¯å¢ƒå˜é‡ä¿¡æ¯</li>
<li>åœ¨å¤‡ä»½æµç¨‹ä¸­ç”Ÿæˆ PodVolumeBackup å¯¹è±¡æ—¶ï¼Œå¦‚æœ Pod å·æºäº PVCï¼Œåˆ™ä¼šå¯¹ PodVolumeBackup åŠ ä¸€ä¸ª velero.io&#x2F;pvc-uid çš„ labelï¼Œå€¼ä¸º PVC çš„ uidã€‚å› æ­¤ï¼Œåœ¨è¿™é‡Œä¼šé€šè¿‡è¿™ä¸ª label åˆ¤æ–­å·æ˜¯å¦æºäº PVCï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šè·å–é›†ç¾¤ä¸­æ‰€æœ‰å¸¦æœ‰æ­¤ labelã€çŠ¶æ€å·²ç»å®Œæˆå¹¶ä¸” BackupStorageLocation ç›¸åŒçš„ PodVolumeBackup å¯¹è±¡ï¼Œå¦‚æœå­˜åœ¨åˆ™è¡¨ç¤ºè¿™ä¸ªå·å·²ç»å¤‡ä»½è¿‡ï¼Œåç»­çš„å¤‡ä»½ä¼šåŸºäºæœ€è¿‘çš„ä¸€æ¬¡å¤‡ä»½ç‚¹è¿›è¡Œå¢é‡å¤‡ä»½ï¼Œåä¹‹åˆ™å…¨é‡å¤‡ä»½ï¼Œè¿™é‡Œçš„å¢é‡å¤‡ä»½å€ŸåŠ©äº† Restic åŸç”ŸåŠŸèƒ½ï¼ˆâ€“parentï¼‰<br><em>è¯¦ç»†é€»è¾‘å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/pod_volume_backup_controller.go#L338">getParentSnapshot</a></em></li>
<li>è°ƒç”¨ <strong>RunBackup</strong>ï¼Œæ‰§è¡Œ Restic åŸç”Ÿçš„å·æ•°æ®å¤‡ä»½æµç¨‹</li>
<li>æ›´æ–° PodVolumeBackup å¯¹è±¡çš„çŠ¶æ€ã€å®Œæˆæ—¶é—´ã€å¿«ç…§ ID å’Œå·æ•°æ®è·¯å¾„ç­‰ä¿¡æ¯</li>
</ol>
<h2 id="RunBackup"><a href="#RunBackup" class="headerlink" title="RunBackup"></a>RunBackup</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/restic/exec_commands.go#L73">RunBackup æºç </a></p>
<p>è°ƒç”¨ Restic åŸç”Ÿå¤‡ä»½å‘½ä»¤ restic backup</p>
<ol>
<li>å°†å…¥å‚çš„ Command å¯¹è±¡æ„å»ºæˆå¯æ‰§è¡Œå‘½ä»¤å¹¶æ‰§è¡Œ</li>
<li>å¯åŠ¨ä¸€ä¸ª Goroutineï¼Œæ¯ 10 ç§’é’Ÿè§£æä¸€æ¬¡ restic backup å‘½ä»¤çš„æ ‡å‡†è¾“å‡ºï¼Œæ›´æ–° PodVolumeBackup çš„å¤‡ä»½è¿›åº¦ä¿¡æ¯ï¼ˆå¾…å¤‡ä»½æ€»æ–‡ä»¶å¤§å°å’Œå½“å‰å¤‡ä»½æ–‡ä»¶å¤§å°ï¼‰</li>
<li>é€šè¿‡è§£ææ ‡å‡†è¾“å‡ºåˆ¤æ–­å¦‚æœ Restic å¤‡ä»½æˆåŠŸï¼Œåˆ™æ›´æ–° PodVolumeBackup è¿›åº¦è‡³ 100%</li>
</ol>
<h1 id="Schedule-Controller"><a href="#Schedule-Controller" class="headerlink" title="Schedule Controller"></a>Schedule Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;schedule_controller.go</u></em></p>
<h2 id="NewScheduleController"><a href="#NewScheduleController" class="headerlink" title="NewScheduleController"></a>NewScheduleController</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/schedule_controller.go#L60">NewScheduleController æºç </a></p>
<p>å·¥å‚å‡½æ•°</p>
<ol>
<li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li>
<li>ç›‘å¬ Schedule èµ„æºçš„ Add äº‹ä»¶ï¼Œå°†çŠ¶æ€æ˜¯ç©ºã€New æˆ–è€… Enabled çš„ Schedule ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li>
</ol>
<h2 id="processSchedule"><a href="#processSchedule" class="headerlink" title="processSchedule"></a>processSchedule</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/schedule_controller.go#L136">processSchedule æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p>
<ol>
<li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ Schedule keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ Schedule å¯¹è±¡</li>
<li>ä»…å¤„ç†çŠ¶æ€ä¸ºç©ºã€New æˆ–è€… Enabled çš„ Schedule å¯¹è±¡</li>
<li>æ£€éªŒ cron è¡¨è¾¾å¼çš„åˆæ³•æ€§ï¼Œæ ¹æ®æ ¡éªŒç»“æœæ›´æ–° Schedule çš„çŠ¶æ€ä¸º FailedValidation æˆ–è€… Enabled</li>
<li>åˆ¤æ–­æ˜¯å¦åˆ°è¾¾å®šæ—¶ä»»åŠ¡çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œå¦‚æœè¾¾åˆ°åˆ™ç«‹å³åˆ›å»ºä¸€ä¸ªå¤‡ä»½ã€‚å¦å¤–ï¼Œå¦‚æœå®šæ—¶ä»»åŠ¡ä»æœªæ‰§è¡Œï¼Œä¹Ÿä¼šç«‹å³åˆ›å»ºä¸€ä¸ªå¤‡ä»½ä»»åŠ¡</li>
</ol>
<h2 id="enqueueAllEnabledSchedules"><a href="#enqueueAllEnabledSchedules" class="headerlink" title="enqueueAllEnabledSchedules"></a>enqueueAllEnabledSchedules</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/schedule_controller.go#L115">enqueueAllEnabledSchedules æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 1 åˆ†é’Ÿ</p>
<ol>
<li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ Schedule å¯¹è±¡</li>
<li>å°†çŠ¶æ€æ˜¯ Enabled çš„ Schedule å¯¹è±¡åŠ å…¥åˆ° Generic Controller çš„ queue ä¸­</li>
</ol>
<h1 id="BackupDeletion-Controller"><a href="#BackupDeletion-Controller" class="headerlink" title="BackupDeletion Controller"></a>BackupDeletion Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;backup_deletion_controller.go</u></em><br><em><u>internal&#x2F;delete&#x2F;delete_item_action_handler.go</u></em></p>
<p>åˆ é™¤ Backup æ—¶ï¼Œä¸ Backup ç›¸å…³è”çš„å„ç§èµ„æºåŸºæœ¬ä¸Šéƒ½æ˜¯é€šè¿‡ velero.io&#x2F;backup-name æ ‡ç­¾è·å–åˆ°ã€‚å› æ­¤ï¼Œåœ¨å¤‡ä»½çš„æ—¶å€™ï¼Œåˆ›å»ºçš„ç›¸å…³èµ„æºä¹Ÿéƒ½ä¼šæ‰“ä¸Šè¯¥æ ‡ç­¾ã€‚</p>
<h2 id="NewBackupDeletionController"><a href="#NewBackupDeletionController" class="headerlink" title="NewBackupDeletionController"></a>NewBackupDeletionController</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_deletion_controller.go#L86">NewBackupDeletionController æºç </a></p>
<p>å·¥å‚å‡½æ•°</p>
<ol>
<li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li>
<li>ç›‘å¬ DeleteBackupRequest èµ„æºçš„ Add äº‹ä»¶ï¼Œå°† DeleteBackupRequest ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li>
</ol>
<h2 id="processQueueItem-1"><a href="#processQueueItem-1" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_deletion_controller.go#L146">processQueueItem æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p>
<ol>
<li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ DeleteBackupRequest keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ DeleteBackupRequest å¯¹è±¡</li>
<li>ä»…å¤„ç†çŠ¶æ€ä¸ä¸º Processed çš„ DeleteBackupRequest å¯¹è±¡ï¼Œè°ƒç”¨ <strong>processRequest</strong>ï¼Œæ‰§è¡Œ Backup çš„åˆ é™¤</li>
</ol>
<h2 id="processRequest"><a href="#processRequest" class="headerlink" title="processRequest"></a>processRequest</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_deletion_controller.go#L176">processRequest æºç </a></p>
<p>å¤‡ä»½åˆ é™¤çš„æ•´ä½“æµç¨‹</p>
<ol>
<li>å¦‚æœ DeleteBackupRequest å¯¹è±¡æ‰€å±çš„ Backup ä¿¡æ¯ä¸å­˜åœ¨ï¼Œåˆ™è®¤ä¸º DeleteBackupRequest å¤„ç†å®Œæˆï¼Œå³å°†å…¶çŠ¶æ€è®¾ä¸º Processedï¼Œå¹¶è®¾ç½®é”™è¯¯ä¿¡æ¯</li>
<li>åˆ é™¤é›†ç¾¤ä¸­é’ˆå¯¹è¯¥ Backup çš„å…¶ä½™ DeleteBackupRequest å¯¹è±¡ï¼Œä»…å¤„ç†å½“å‰çš„</li>
<li>å¦‚æœè¦åˆ é™¤çš„ Backup å¤„äº InProgress çŠ¶æ€æˆ–è€…ä¸å­˜åœ¨ï¼Œåˆ™å°† DeleteBackupRequest çŠ¶æ€è®¾ä¸º Processedï¼Œå¹¶è®¾ç½®é”™è¯¯ä¿¡æ¯</li>
<li>å¦‚æœ Backup æ‰€å±çš„ BackupStorageLocation ä¸å­˜åœ¨æˆ–è€…æ¨¡å¼ä¸º ReadOnly æ—¶ï¼Œåˆ™å°† DeleteBackupRequest çŠ¶æ€è®¾ä¸º Processedï¼Œå¹¶è®¾ç½®é”™è¯¯ä¿¡æ¯</li>
<li>è‡³æ­¤ï¼Œæ ¡éªŒå·¥ä½œå·²ç»å®Œæˆï¼Œå°† DeleteBackupRequest çŠ¶æ€è®¾ç½®ä¸º InProgressï¼Œå¹¶è®¾ç½® velero.io&#x2F;backup-name å’Œ velero.io&#x2F;backup-uid æ ‡ç­¾</li>
<li>è®¾ç½® Backup çš„çŠ¶æ€ä¸º Deleting</li>
<li>è·å–æ³¨å†Œçš„ DeleteItemAction æ’ä»¶ï¼Œå¦‚æœè·å–åˆ°äº†ï¼Œåˆ™ä¸‹è½½ BackupStorageLocation ä¸­çš„ Content æ–‡ä»¶ï¼Œæ„å»ºè¿è¡Œ DeleteItemAction æ‰€éœ€è¦ç¯å¢ƒå˜é‡ä¿¡æ¯ï¼Œè°ƒç”¨ <strong>InvokeDeleteActions</strong> å¤„ç† DeleteItemAction ä¸­å®šä¹‰çš„é€»è¾‘</li>
<li>è°ƒç”¨ StorageProvider çš„ GetBackupVolumeSnapshots æ–¹æ³•è·å– BackupVolumeSnapshotsKeyï¼ˆä¹Ÿå°±æ˜¯ backup-volumesnapshots.json.gzï¼‰ çš„å†…å®¹ï¼Œè°ƒç”¨ SnapshotProvider çš„ DeleteSnapshot æ¥å£åˆ é™¤ PV å¿«ç…§ä¿¡æ¯</li>
<li>è·å–åˆ°ä¸ Backup ç›¸å…³è”çš„ PodVolumeBackup ä¿¡æ¯ï¼Œè¿›è€Œè·å–åˆ° Restic çš„ snapshotsï¼Œæ‰§è¡Œ restic forget åˆ é™¤å¿«ç…§<br><em>åˆ›å»ºå¤‡ä»½çš„æ—¶å€™ï¼Œä¼šæ ¹æ® Pod å·åˆ›å»º PodVolumeBackup å¯¹è±¡ï¼Œå¹¶ä¼šè®¾ç½® velero.io&#x2F;backup-name æ ‡ç­¾</em></li>
<li>è°ƒç”¨ StorageProvider çš„ DeleteBackup æ¥å£åˆ é™¤ BackupStorageLocation ä¸­ Backup æ‰€åœ¨çš„ç›®å½•</li>
<li>å¦‚æœ Velero å¼€å¯äº† CSI ç‰¹æ€§ï¼Œé‚£ä¹ˆä¹Ÿä¼šåˆ é™¤ä¸ Backup ç›¸å…³è”çš„ VolumeSnapshot å’Œ VolumeSnapshotContent å¯¹è±¡<br><em>åˆ é™¤ä¹‹å‰ä¼šå°† VolumeSnapshotContent å›æ”¶ç­–ç•¥ç½®ä¸º Delete</em></li>
<li>è°ƒç”¨ StorageProvider çš„ DeleteRestore æ–¹æ³•ï¼Œåˆ é™¤ BackupStorageLocation ä¸ŠåŸºäºè¯¥ Backup åˆ›å»ºçš„ Restore æ–‡ä»¶ï¼Œåˆ é™¤åŸºäºè¯¥ Backup åˆ›å»ºçš„ Restore å¯¹è±¡</li>
<li>å¦‚æœä»¥ä¸Šæ­¥éª¤å‡æ— é”™è¯¯è¿”å›ï¼Œåˆ™åˆ é™¤é›†ç¾¤ä¸­ç›¸å…³çš„ Backup å¯¹è±¡</li>
<li>æ›´æ–° DeleteBackupRequest çŠ¶æ€è®¾ä¸º Processedï¼Œå¹¶è®¾ç½®é”™è¯¯ä¿¡æ¯</li>
<li>å¦‚æœä»¥ä¸Šæ­¥éª¤å‡æ— æŠ¥é”™è¿”å›ï¼Œåˆ™åˆ é™¤ä¸è¯¥ Backup ç›¸å…³çš„æ‰€æœ‰ DeleteBackupRequest å¯¹è±¡</li>
</ol>
<h2 id="InvokeDeleteActions"><a href="#InvokeDeleteActions" class="headerlink" title="InvokeDeleteActions"></a>InvokeDeleteActions</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/internal/delete/delete_item_action_handler.go#L48">InvokeDeleteActions æºç </a></p>
<p>æ‰§è¡Œ DeleteItemAction ä¸­çš„åŠ¨ä½œ</p>
<ol>
<li>å¦‚æœæœªå®šä¹‰ action ä¿¡æ¯ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œç»§ç»­å¤„ç†åˆ é™¤æµç¨‹</li>
<li>å°†ä¼ å…¥çš„ BackupStorageLocation ä¸­çš„ Content æ–‡ä»¶è§£å‹è‡³ä¸´æ—¶æ–‡ä»¶ä¸‹ï¼Œé€šè¿‡ discovery API å°†æ–‡ä»¶å†…å®¹è½¬æ¢æˆ GroupResource</li>
<li>éå† GroupResource ä¸­çš„æ‰€æœ‰èµ„æºï¼Œæ‰§è¡Œ DeleteItemAction ä¸­å£°æ˜çš„åŠ¨ä½œ</li>
</ol>
<h2 id="deleteExpiredRequests"><a href="#deleteExpiredRequests" class="headerlink" title="deleteExpiredRequests"></a>deleteExpiredRequests</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_deletion_controller.go#L595">deleteExpiredRequests æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 1 å°æ—¶</p>
<ol>
<li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ DeleteBackupRequest å¯¹è±¡ï¼Œå°†çŠ¶æ€å·²ç»å¤„äº Processedï¼Œå¹¶ä¸” age è¶…è¿‡ 24 å°æ—¶çš„ DeleteBackupRequest å¯¹è±¡åˆ é™¤<br><em>å› ä¸ºå¹¶éæ‰€æœ‰çš„ DeleteBackupRequest å¯¹è±¡åœ¨èµ°å®Œ syncHandler æµç¨‹åå‡ä¼šè¢«åˆ é™¤</em></li>
</ol>
<h1 id="BackupSync-Controller"><a href="#BackupSync-Controller" class="headerlink" title="BackupSync Controller"></a>BackupSync Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;backup_sync_controller.go</u></em></p>
<h2 id="NewBackupSyncController"><a href="#NewBackupSyncController" class="headerlink" title="NewBackupSyncController"></a>NewBackupSyncController</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_sync_controller.go#L60">NewBackupSyncController æºç </a></p>
<p>å·¥å‚å‡½æ•°</p>
<ol>
<li>æ³¨å†Œ Generic Controller ä¸­çš„ resyncFunc</li>
</ol>
<h2 id="run"><a href="#run" class="headerlink" title="run"></a>run</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/backup_sync_controller.go#L124">run æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 30 ç§’</p>
<ol>
<li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ BackupStorageLocation å¯¹è±¡ï¼Œæ„å»ºä¸€ä¸ªé»˜è®¤çš„ BackupStorageLocation ä½äºç¬¬ä¸€ä½çš„åˆ—è¡¨</li>
<li>éå†æ­¥éª¤ 1 ä¸­çš„ BackupStorageLocation åˆ—è¡¨ï¼Œå¦‚æœåŒæ­¥å‘¨æœŸç­‰äº 0 ä»£è¡¨è¯¥ BackupStorageLocation ä¸ä½œåŒæ­¥æ“ä½œï¼Œç›´æ¥è·³è¿‡å³å¯ï¼Œå¦åˆ™åˆ¤æ–­å…¶æ˜¯å¦åˆ°è¾¾ä¸‹æ¬¡åŒæ­¥æ—¶é—´</li>
<li>è°ƒç”¨ StorageProvider çš„ ListBackups æ–¹æ³•è·å–æ‰€æœ‰çš„ Backupï¼›åŒæ—¶è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ Backup</li>
<li>è·å–åœ¨ BackupStorageLocation ä¸­ä½†æ˜¯ä¸åœ¨é›†ç¾¤ä¸­çš„ Backupï¼Œè¿™äº›å°±æ˜¯å¾…åŒæ­¥çš„ Backup</li>
<li>é’ˆå¯¹æ¯ä¸€ä¸ªå¾…åŒæ­¥çš„ Backupï¼Œè°ƒç”¨ StorageProvider çš„ GetBackupMetadata æ–¹æ³•ï¼Œè·å– Metadata æ–‡ä»¶ï¼ˆå³ velero-backup.jsonï¼‰ï¼Œè§£æå†…å®¹å¾—åˆ° Backup å¯¹è±¡</li>
<li>è®¾ç½® Backup çš„ namespaceã€resourceVersionã€storageLocation å’Œ label ç­‰ä¿¡æ¯ï¼Œå¹¶åœ¨é›†ç¾¤ä¸­åˆ›å»º<br><em>æ—¢ç„¶å·²ç»å­˜åœ¨äº BackupStorage Locationï¼ŒçŠ¶æ€å¿…ç„¶ä¸ºå®ŒæˆçŠ¶æ€ï¼ˆå³ä¸æ˜¯ç©ºæˆ–è€… Newï¼‰ï¼Œå› æ­¤ä¸ä¼šè¢« Backup Controller é‡å¤å¤„ç†</em></li>
<li>è°ƒç”¨ StorageProvider çš„ GetPodVolumeBackups æ–¹æ³•è·å–ä¸è¯¥ Backup ç›¸å…³çš„ PodVolumeBackup</li>
<li>è®¾ç½® PodVolumeBackup çš„ namespaceã€resourceVersionã€ownerReferences å’Œ label ç­‰ä¿¡æ¯ï¼Œå¹¶åœ¨é›†ç¾¤ä¸­åˆ›å»º<br><em>åŒç†ï¼Œä¸ä¼šè¢« PodVolumeBackup Controller é‡å¤å¤„ç†</em></li>
<li>å¦‚æœ Velero å¼€å¯äº† CSI ç‰¹æ€§ï¼Œé€šè¿‡ StorageProvider çš„ GetCSIVolumeSnapshotContents æ–¹æ³•è·å–ä¸è¯¥ Backup ç›¸å…³çš„ VolumeSnapshotContents</li>
<li>è®¾ç½® VolumeSnapshotContent çš„ resourceVersion ç­‰ä¿¡æ¯ï¼Œå¹¶åœ¨é›†ç¾¤ä¸­åˆ›å»º</li>
<li>åˆ é™¤å­¤å„¿ Backupï¼Œä¹Ÿå°±æ˜¯åœ¨é›†ç¾¤ä¸­å­˜åœ¨ï¼ŒçŠ¶æ€ä¸º Completedï¼Œä½†æ˜¯åœ¨ BackupStorageLocation ä¸­ä¸å­˜åœ¨çš„ Backup</li>
<li>æ›´æ–°é›†ç¾¤ä¸­è¯¥ BackupStorageLocation çš„ä¸Šæ¬¡åŒæ­¥æ—¶é—´<br><em>å®é™…ä¸Šæ­¥éª¤ 4 è·å– BackupStorageLocation çš„ Backup æ—¶å¯ä»¥ä½œä¸ºåŒæ­¥æ“ä½œ</em></li>
</ol>
<h1 id="GC-Controller"><a href="#GC-Controller" class="headerlink" title="GC Controller"></a>GC Controller</h1><p><em><u>pkg&#x2F;controller&#x2F;gc_controller.go</u></em></p>
<h2 id="NewGCController"><a href="#NewGCController" class="headerlink" title="NewGCController"></a>NewGCController</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/gc_controller.go#L58">NewGCController æºç </a></p>
<p>å·¥å‚å‡½æ•°</p>
<ol>
<li>æ³¨å†Œ Generic Controller ä¸­çš„ syncHandler å’Œ resyncFunc</li>
<li>ç›‘å¬ Backup èµ„æºçš„ Add å’Œ Update äº‹ä»¶ï¼Œå°† Backup ä»¥ keyï¼ˆnamespace&#x2F;nameï¼‰çš„å½¢å¼åŠ å…¥ Generic Controller çš„ queue ä¸­</li>
</ol>
<h2 id="processQueueItem-2"><a href="#processQueueItem-2" class="headerlink" title="processQueueItem"></a>processQueueItem</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/gc_controller.go#L104">processQueueItem æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ syncHandler çš„å®ç°</p>
<ol>
<li>å‡½æ•°å…¥å‚å°±æ˜¯ Generic Controller çš„ queue ä¸­å¾…å¤„ç†çš„ Backup keyï¼Œé€šè¿‡è§£æè·å–çš„ namespace å’Œ name æŸ¥è¯¢åˆ°é›†ç¾¤ä¸­çš„ Backup å¯¹è±¡</li>
<li>ä»…å¤„ç†å·²ç»è¿‡æœŸçš„ Backup å¯¹è±¡</li>
<li>è·å– Backup æ‰€å±çš„ BackupStorageLocationï¼Œåˆ¤æ–­å…¶æ¨¡å¼æ˜¯å¦ä¸º ReadWrite</li>
<li>è·å–é›†ç¾¤ä¸­å’Œè¯¥ Backup ç›¸å…³çš„ DeleteBackupRequest å¯¹è±¡ï¼Œå¦‚æœå…¶ä¸­å­˜åœ¨çŠ¶æ€ä¸ºç©ºã€New å’Œ InProgress çš„ï¼Œåˆ™è®¤ä¸ºæ­£åœ¨åˆ é™¤ï¼Œæœ¬æ¬¡ä¸åšå¤„ç†ï¼›å¦åˆ™ï¼Œæ„å»ºä¸€ä¸ª DeleteBackupRequest å¯¹è±¡ï¼Œä¸‹å‘è‡³é›†ç¾¤ä¸­åˆ›å»ºï¼Œåç»­ç”± BackupDeletion Controller è´Ÿè´£ç»´æŠ¤</li>
</ol>
<h2 id="enqueueAllBackups"><a href="#enqueueAllBackups" class="headerlink" title="enqueueAllBackups"></a>enqueueAllBackups</h2><p><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/velero/blob/5fe3a50bfddc2becb4c0bd5e2d3d4053a23e95d2/pkg/controller/gc_controller.go#L90">enqueueAllBackups æºç </a></p>
<p>æ³¨å†Œåœ¨ Generic Controller ä¸­ resyncFunc çš„å®ç°ï¼Œå‘¨æœŸä¸º 1 å°æ—¶</p>
<ol>
<li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰çš„ Backup å¯¹è±¡ï¼Œå…¨é‡åŠ å…¥åˆ° Generic Controller çš„ queue ä¸­</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>ã€Œ Velero ã€æºç èµ°è¯» â€” Backup</p><p><a href="http://shenxianghong.github.io/2022/01/27/2022-01-27 Velero æºç èµ°è¯» - Backup/">http://shenxianghong.github.io/2022/01/27/2022-01-27 Velero æºç èµ°è¯» - Backup/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Shen Xianghong</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2022-01-27</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2023-05-08</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i>Â <a class="link-muted" rel="tag" href="/tags/Velero/">Velero </a></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/02/04/2022-02-04%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Restore/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ã€Œ Velero ã€æºç èµ°è¯» â€” Restore</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/01/17/2022-01-17%20Velero%20%E6%BA%90%E7%A0%81%E8%B5%B0%E8%AF%BB%20-%20Location/"><span class="level-item">ã€Œ Velero ã€æºç èµ°è¯» â€” Location</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/35031258?v=4" alt="ğŸ¾Corgi"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">ğŸ¾Corgi</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">51</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/shenxianghong" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Youtube" href="https://youtube.com"><i class="fab fa-youtube"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Bilibili" href="https://bilibili.com"><i class="fab fa-bilibili"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Reddit" href="https://reddit.com"><i class="fab fa-reddit"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://google.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Google</span></span><span class="level-right"><span class="level-item tag">google.com</span></span></a></li><li><a class="level is-mobile" href="https://freegpt.one" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ChatGPT</span></span><span class="level-right"><span class="level-item tag">freegpt.one</span></span></a></li></ul></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Backup"><span class="level-left"><span class="level-item">1</span><span class="level-item">Backup</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#backup"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">backup</span></span></a></li><li><a class="level is-mobile" href="#create"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">create</span></span></a></li><li><a class="level is-mobile" href="#delete"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">delete</span></span></a></li><li><a class="level is-mobile" href="#describe"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">describe</span></span></a></li><li><a class="level is-mobile" href="#download"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">download</span></span></a></li><li><a class="level is-mobile" href="#get"><span class="level-left"><span class="level-item">1.6</span><span class="level-item">get</span></span></a></li><li><a class="level is-mobile" href="#logs"><span class="level-left"><span class="level-item">1.7</span><span class="level-item">logs</span></span></a></li></ul></li><li><a class="level is-mobile" href="#PodVolumeBackup"><span class="level-left"><span class="level-item">2</span><span class="level-item">PodVolumeBackup</span></span></a></li><li><a class="level is-mobile" href="#Schedule"><span class="level-left"><span class="level-item">3</span><span class="level-item">Schedule</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#schedule"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">schedule</span></span></a></li><li><a class="level is-mobile" href="#create-1"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">create</span></span></a></li><li><a class="level is-mobile" href="#delete-1"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">delete</span></span></a></li><li><a class="level is-mobile" href="#describe-1"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">describe</span></span></a></li><li><a class="level is-mobile" href="#get-1"><span class="level-left"><span class="level-item">3.5</span><span class="level-item">get</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Backup-Controller"><span class="level-left"><span class="level-item">4</span><span class="level-item">Backup Controller</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#NewBackupController"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">NewBackupController</span></span></a></li><li><a class="level is-mobile" href="#processBackup"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">processBackup</span></span></a></li><li><a class="level is-mobile" href="#prepareBackupRequest"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">prepareBackupRequest</span></span></a></li><li><a class="level is-mobile" href="#runBackup"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">runBackup</span></span></a></li><li><a class="level is-mobile" href="#Backup-1"><span class="level-left"><span class="level-item">4.5</span><span class="level-item">Backup</span></span></a></li><li><a class="level is-mobile" href="#backupItem"><span class="level-left"><span class="level-item">4.6</span><span class="level-item">backupItem</span></span></a></li><li><a class="level is-mobile" href="#BackupPodVolumes"><span class="level-left"><span class="level-item">4.7</span><span class="level-item">BackupPodVolumes</span></span></a></li><li><a class="level is-mobile" href="#resync"><span class="level-left"><span class="level-item">4.8</span><span class="level-item">resync</span></span></a></li></ul></li><li><a class="level is-mobile" href="#PodVolumeBackup-Controller"><span class="level-left"><span class="level-item">5</span><span class="level-item">PodVolumeBackup Controller</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#NewPodVolumeBackupController"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">NewPodVolumeBackupController</span></span></a></li><li><a class="level is-mobile" href="#processQueueItem"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">processQueueItem</span></span></a></li><li><a class="level is-mobile" href="#ProcessBackup"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">ProcessBackup</span></span></a></li><li><a class="level is-mobile" href="#RunBackup"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">RunBackup</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Schedule-Controller"><span class="level-left"><span class="level-item">6</span><span class="level-item">Schedule Controller</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#NewScheduleController"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">NewScheduleController</span></span></a></li><li><a class="level is-mobile" href="#processSchedule"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">processSchedule</span></span></a></li><li><a class="level is-mobile" href="#enqueueAllEnabledSchedules"><span class="level-left"><span class="level-item">6.3</span><span class="level-item">enqueueAllEnabledSchedules</span></span></a></li></ul></li><li><a class="level is-mobile" href="#BackupDeletion-Controller"><span class="level-left"><span class="level-item">7</span><span class="level-item">BackupDeletion Controller</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#NewBackupDeletionController"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">NewBackupDeletionController</span></span></a></li><li><a class="level is-mobile" href="#processQueueItem-1"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">processQueueItem</span></span></a></li><li><a class="level is-mobile" href="#processRequest"><span class="level-left"><span class="level-item">7.3</span><span class="level-item">processRequest</span></span></a></li><li><a class="level is-mobile" href="#InvokeDeleteActions"><span class="level-left"><span class="level-item">7.4</span><span class="level-item">InvokeDeleteActions</span></span></a></li><li><a class="level is-mobile" href="#deleteExpiredRequests"><span class="level-left"><span class="level-item">7.5</span><span class="level-item">deleteExpiredRequests</span></span></a></li></ul></li><li><a class="level is-mobile" href="#BackupSync-Controller"><span class="level-left"><span class="level-item">8</span><span class="level-item">BackupSync Controller</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#NewBackupSyncController"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">NewBackupSyncController</span></span></a></li><li><a class="level is-mobile" href="#run"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">run</span></span></a></li></ul></li><li><a class="level is-mobile" href="#GC-Controller"><span class="level-left"><span class="level-item">9</span><span class="level-item">GC Controller</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#NewGCController"><span class="level-left"><span class="level-item">9.1</span><span class="level-item">NewGCController</span></span></a></li><li><a class="level is-mobile" href="#processQueueItem-2"><span class="level-left"><span class="level-item">9.2</span><span class="level-item">processQueueItem</span></span></a></li><li><a class="level is-mobile" href="#enqueueAllBackups"><span class="level-left"><span class="level-item">9.3</span><span class="level-item">enqueueAllBackups</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Container-Runtime/"><span class="level-start"><span class="level-item">Container Runtime</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/categories/Disaster-Recovery/"><span class="level-start"><span class="level-item">Disaster Recovery</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/Kubernetes/"><span class="level-start"><span class="level-item">Kubernetes</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">7</span></span></a><ul><li><a class="level is-mobile" href="/categories/Programming/Elegant-Coding/"><span class="level-start"><span class="level-item">Elegant Coding</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Quick-Start/"><span class="level-start"><span class="level-item">Quick Start</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Serverless/"><span class="level-start"><span class="level-item">Serverless</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Service-Mesh/"><span class="level-start"><span class="level-item">Service Mesh</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="ğŸ¾Corgi" height="28"></a><p class="is-size-7"><span>&copy; 2023 Shen Xianghong</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p><p class="is-size-7"><br/>And did you get what you wanted from this life, even so?</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><script src="/js/night.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>